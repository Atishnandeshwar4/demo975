IF EXISTS (SELECT TOP 1 1 FROM Sys.Tables WHERE Name = 'ZnodeMultifront')
BEGIN 
IF EXISTS (SELECT TOP 1 1 FROM ZnodeMultifront where BuildVersion =   974 and VersionName = 'Znode_Multifront_9_7_4_GA' )
BEGIN 
PRINT 'Script is already executed....'
 SET NOEXEC ON 
END 
END
ELSE 
BEGIN 
  SET NOEXEC ON
END 
INSERT INTO [dbo].[ZnodeMultifront] ( [VersionName], [Descriptions], [MajorVersion], [MinorVersion], [LowerVersion], [BuildVersion], [PatchIndex], [CreatedBy], 
[CreatedDate], [ModifiedBy], [ModifiedDate]) 
VALUES ( N'Znode_Multifront_9_7_4_GA', N'Upgrade GA Release by 974',9,7,4,974,0,2, GETDATE(),2, GETDATE())
GO 
SET ANSI_NULLS ON

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '117', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%' OR ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %'

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributes')
	DROP PROC Znode_ImportAttributes
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributes](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '10', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   SELECT AttributeCode FROM @AttributeCode  where AttributeCode is not null 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   select AttributeCode  FROM @InsertPimAtrribute  Group BY AttributeCode  having count(*) > 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'AttributeType', AttributeType, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeType NOT in 
			   (
				   SELECT AttributeTypeName  FROM ZnodeAttributeType  where IsPimAttributeType = 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '%[^0-9A-Za-z]%' OR ltrim(rtrim(isnull(ii.AttributeCode,''))) NOT LIKE '[^0-9]%'
			   OR ltrim(rtrim(isnull(ii.AttributeCode,''))) like '% %'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE Isnumeric(ltrim(rtrim(isnull(ii.AttributeCode,'')))) =1


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Attribute - ' + ISNULL(AttributeCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End


		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
			,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
			CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		
		OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds  
		
		SELECT ZAT.AttributeTypeId,AttributeCode, 0 IsRequired , 1 IsLocalizable,1 IsFilterable, 0 IsSystemDefined, 0 IsConfigurable,
		0 IsPersonalizable,  0 IsShowOnGrid , Case when Isnull(DisplayOrder,0) = 0 then  999 else DisplayOrder end  , '' HelpDescription ,0  IsCategory , 0 IsHidden , 0 IsSwatch,
		@UserId , @GetDate ,@UserId , @GetDate from @InsertPimAtrribute IPA INNER JOIN ZnodeAttributeType ZAT 
		ON IPA.AttributeType = ZAT.AttributeTypeName  
		
		
		INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeId, IPA.AttributeName, '', @UserId , @GetDate ,@UserId , @GetDate   
		 FROM @InsertedPimAttributeIds IPAS INNER JOIN @InsertPimAtrribute IPA ON IPAS.AttributeCode= IPA.AttributeCode 
		
		INSERT INTO ZnodePimAttributeValidation
		(PimAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPA.PimAttributeId,ZAIV.InputValidationId,NULL,null , @UserId , @GetDate ,@UserId , @GetDate  
		FROM @InsertedPimAttributeIds IPA INNER JOIN ZnodeAttributeInputValidation ZAIV ON IPA.AttributeTypeId = ZAIV.AttributeTypeId


		insert into ZnodePimFrontendProperties (PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select PimAttributeId, 0 IsComparable, 0 IsUseInSearch,0 IsHtmlTags,0 IsFacets, @UserId CreatedBy,@GetDate CreatedDate, @UserId ModifiedBy, @GetDate ModifiedDate
		from  @InsertedPimAttributeIds
		--      SET @Status = 1;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributes',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

INSERT INTO ZnodeImportAttributeValidation (AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,
	ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Categorycode',
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'CategoryAssociation'),0,'Number','MaxCharacters',
	NULL,'100','',NULL,2,GETDATE(),2,GETDATE(),3
WHERE NOT EXISTS(SELECT * FROM ZnodeImportAttributeValidation 
				WHERE AttributeTypeName ='Text' AND AttributeCode = 'Categorycode'
					AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'CategoryAssociation')
					AND ControlName = 'Number' AND ValidationName = 'MaxCharacters'
				)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	--SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	--FROM @InsertSearchSynonyms AS ii
	--WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.SynonymCode,'') LIKE '%[^a-zA-Z0-9]%')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.RenameSynonymCode,'') LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND  NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms i WHERE i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND  NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms i WHERE i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND  NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms i WHERE i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.SynonymCode IN
			   (
				   select SynonymCode from @InsertSearchSynonyms
					group by SynonymCode
					having count(1)>1
			   );

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.RenameSynonymCode IN
			   (
				   select RenameSynonymCode from @InsertSearchSynonyms
					group by RenameSynonymCode
					having count(1)>1
			   ) AND ISNULL(ii.RenameSynonymCode,'') <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;

	--Update existing search synonym 
	UPDATE ZSS 
	SET ZSS.SynonymCode = CASE WHEN ISNULL(IPS.RenameSynonymCode,'') <> '' THEN IPS.RenameSynonymCode ELSE ZSS.SynonymCode END , ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' ELSE IPS.IsBidirectional END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' ELSE A.IsBidirectional END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode OR (A.RenameSynonymCode = ZSS.SynonymCode))
		
	
	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId
		
		
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit NVARCHAR(100),	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;

	    --If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''

		if @CsvColumnString not like '%AccountCode%'
		begin
			--If Acount Code Exists then it will update as it is and if not exists then it will show error.
			update IC set AccountCode = ZA.AccountCode
			FROM ZnodeUser a
			inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
			INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
			WHERE isnull(IC.AccountCode,'') = '' --and isnull(IC.RoleName,'') <> ''
		end
		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		--If @IsAllowGlobalLevelUserCreation = 'false'  
		--BEGIN
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		--SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		--FROM #InsertCustomer AS ii  
		--WHERE ltrim(rtrim(ii.UserName)) in   
		--(  
		--SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId  
		--);  
		--END
		--Else   
		IF @IsAllowGlobalLevelUserCreation = 'true'
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertCustomer AS ii  
			WHERE ltrim(rtrim(ii.UserName)) in   
			(  
			SELECT UserName FROM AspNetZnodeUser     
			);  
		END


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);


		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT  '2', 'PerOrderLimit', PerOrderLimit, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii
		WHERE ii.PerOrderLimit NOT LIKE '%[0-9]%'

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, 
					ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= (CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				ZU.IsActive		= (CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5,
				ZU.SMSOptIn	= (CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN '' THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
			
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,
				(CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
				(CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
				IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
					(CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				--Updating RoleName if customer has changed the account and RoleName left blank then by default User role assigned to the customer
				UPDATE u set u.RoleId = @RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.AccountCode,'') <> '' AND isnull(IC.RoleName,'') = ''
				AND EXISTS(SELECT * FROM ZnodeAccount ZA WHERE ISNULL(a.AccountId,0) = ZA.AccountId AND ZA.AccountCode <> IC.AccountCode)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> '' 
				--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )

				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''


				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> '' 


				--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
				--after the update process is complete.
				DELETE UR FROM AspNetUserRoles UR 
				INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))


				UPDATE ZnodeUser SET AccountId = NULL 
				WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		

		
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, case when ZD.Id is null then @RoleId else ZD.Id end  as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND ISNULL(IC.AccountCode,'') <> ''
			
				--If no value was available previously then no value should be saved after the update process is complete.
				--If a value was available previously, then it should be removed after the update process is complete.
				DELETE DU FROM ZnodeDepartmentUser DU
				INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
				INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
				WHERE EXISTS (SELECT * FROM #INSERTCUSTOMER IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

DELETE 
FROM ZnodeImportTemplateMapping
WHERE NOT EXISTS (SELECT * FROM ZnodePimAttribute WHERE AttributeCode=ZnodeImportTemplateMapping.TargetColumnName AND IsCategory = 0)
		AND ImportTemplateId IN (SELECT ImportTemplateId FROM ZnodeImportTemplate 
								WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name='Product'))

GO
UPDATE ZnodeApplicationSetting
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>GiftCardId</name><headertext>Gift Card No</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>Name</name><headertext>Voucher Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>CardNumber</name><headertext>Voucher Number</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ExpirationDate</name><headertext>Expiration Date</headertext><width>0</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Amount</name><headertext>Amount</headertext><width>0</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeCustomerPaymentList'

GO

UPDATE ZnodeApplicationSetting
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Template Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/EditTemplate</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>omsTemplateId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Quantity</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Orders|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/EditTemplate|/User/AddTemplateToCart|/User/DeleteTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeOmsTemplate'

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Order','GetAuthorizeNetToken',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Order' and ActionName = 'GetAuthorizeNetToken')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order'),
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetAuthorizeNetToken') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order') and ActionId =
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetAuthorizeNetToken'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetAuthorizeNetToken')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order') and ActionId =
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetAuthorizeNetToken'))

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Order','GetPaymentGatewayToken',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Order' and ActionName = 'GetPaymentGatewayToken')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetPaymentGatewayToken') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order') and ActionId =
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetPaymentGatewayToken'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetPaymentGatewayToken')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Orders' AND ControllerName = 'Order') and ActionId =
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Order' and ActionName= 'GetPaymentGatewayToken'))

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductFeedDetailsList')
	DROP PROC Znode_GetProductFeedDetailsList
GO

CREATE PROCEDURE [dbo].[Znode_GetProductFeedDetailsList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetProductFeedDetailsList '',100,1,'',0

*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_ProductFeed TABLE (ProductFeedId int, ProductFeedTypeName VARCHAR(300),FileName VARCHAR(300),RowId INT, CountId INT, CreatedDate DATETIME, ModifiedDate DATETIME, StoreName NVARCHAR(100),LocaleName Varchar(100))
	 
		 SET @SQL = '
		;With Cte_ProductFeed AS (
		SELECT ZPCL.ProductFeedId, 
		ZPFT.ProductFeedTypeName ProductFeedTypeName, ZPCL.FileName FileName,
		ZPCL.CreatedDate,ZPCL.ModifiedDate,ZP.StoreName,
		ZL.Name AS LocaleName
		FROM
		ZnodeProductFeed ZPCL
		INNER JOIN ZnodeProductFeedType ZPFT ON ZPFT.ProductFeedTypeId = ZPCL.ProductFeedTypeId
		Inner join ZnodePortal ZP on ZP.PortalId = ZPCL.PortalId
		LEFT JOIN ZnodeLocale ZL on ZL.LocaleId = ZPCL.LocaleId
		)
	 
	     ,Cte_PublishFeedStatus 
		 AS (
		 SELECT ProductFeedId,ProductFeedTypeName,FileName,CreatedDate,ModifiedDate,StoreName,LocaleName,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'ProductFeedId DESC')+' , Count(*)Over() CountId FROM Cte_ProductFeed
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT ProductFeedId,ProductFeedTypeName,FileName,RowId,CountId,CreatedDate,ModifiedDate,StoreName,LocaleName
		 FROM Cte_PublishFeedStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	
		 INSERT INTO @TBL_ProductFeed 
		 EXEC (@SQL)


		 SELECT  ProductFeedId,ProductFeedTypeName, FileName,CreatedDate,ModifiedDate,StoreName,LocaleName
		 FROM @TBL_ProductFeed

		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_ProductFeed),0)
	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductFeedDetailsList @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetProductFeedDetailsList',
					@ErrorInProcedure = @Error_procedure,
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

UPDATE ZnodeApplicationSetting
SET Setting = '<?xml version="1.0" encoding="UTF-8" ?><columns><column><id>1</id><name>ProductFeedId</name><headertext>Checkbox</headertext><width>40</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>StoreName</name><headertext>Store Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ProductFeedTypeName</name><headertext>Type Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>500</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>FileName</name><headertext>File Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>500</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>LocaleName</name><headertext>Locale Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>100</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Download|Edit|Trigger|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Generate Feed|Edit|Create Scheduler|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/ProductFeed/GenerateProductFeedLink|/ProductFeed/Edit|/ProductFeed/CreateScheduler|/ProductFeed/Delete</manageactionurl><manageparamfield>ProductFeedId|ProductFeedId|ConnectorTouchPoints,SchedulerCallFor|ProductFeedId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeProductFeed'

GO

UPDATE ZnodeApplicationSetting
 SET Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PimProductId</name><headertext>Checkbox</headertext><width>20</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>PimProductId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>RelatedProductId</name><headertext>RelatedProductId</headertext><width>20</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>PimProductId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>PimProductId</name><headertext>ID</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Image</name><headertext>Image</headertext><width>20</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield>ProductImage,ProductName</imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>imageicon</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ProductName</name><headertext>Product Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ProductType</name><headertext>Product Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Assortment</name><headertext>Assortment</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>SKU</name><headertext>SKU</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>SKU</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>AvailableInventory</name><headertext>Available Inventory</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/PIM/Products/UpdateAssociatedProducts|/PIM/Products/UnassociateProducts</manageactionurl><manageparamfield>PimProductId,PimProductId,RelatedProductId|PimProductId,PimProductId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
 where ItemName = 'View_ManageProductTypeListForToBeAssociated'

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetBrandDetailsLocale')
	DROP PROC Znode_GetBrandDetailsLocale
GO

CREATE PROCEDURE [dbo].[Znode_GetBrandDetailsLocale]  
( 
	@WhereClause  NVARCHAR(MAX),  
	@Rows    INT           = 10,  
	@PageNo   INT           = 1,  
	@Order_BY   VARCHAR(1000) = '',  
	@RowsCount  INT           = 0 OUT,  
	@LocaleId   INT           = 1,    
	@IsAssociated  BIT           = 0,  
	@PromotionId      INT     = 0   
)  
AS  
  /*  
     Summary :- This Procedure is used to get brand localies   
     Unit Testing   
  begin tran  
     EXEC Znode_GetBrandDetailsLocale ''isactive = 'true''',@RowsCount= 1,@LocaleId = 1   
  rollback tran    
 */  
BEGIN  
BEGIN TRY  
	SET NOCOUNT ON;  
	DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();  
	DECLARE @SeoId VARCHAR(MAX)= '', @SQL NVARCHAR(MAX); --, @SeoCode NVARCHAR(MAX) ;
	DECLARE @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId')

	DECLARE @TBL_BrandDetails TABLE  
	(
		Description         NVARCHAR(MAX),  
		BrandId             INT,  
		BrandCode           VARCHAR(600),  
		DisplayOrder        INT,  
		IsActive            BIT,  
		WebsiteLink         NVARCHAR(1000),  
		BrandDetailLocaleId INT,  
		SEOFriendlyPageName NVARCHAR(600),  
		MediaPath           NVARCHAR(MAX),  
		MediaId             INT,  
		ImageName           VARCHAR(300),
		BrandName VARCHAR(100),	
		Custom1 NVARCHAR(MAX),	
		Custom2 NVARCHAR(MAX),
		Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),
		Custom5 NVARCHAR(MAX)  
	);  
  
	DECLARE @AttributeId INT= [dbo].[Fn_GetProductBrandAttributeId]();  
	DECLARE @TBL_AttributeDefault TABLE  
	(
		PimAttributeId            INT,  
		AttributeDefaultValueCode VARCHAR(600),  
		IsEditable                BIT,  
		AttributeDefaultValue     NVARCHAR(MAX)  
		,DisplayOrder INT   
	); 
	
	DECLARE @TBL_SeoDetails TABLE  
	(
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT ,
		PublishStatus        NVARCHAR(20),
		SEOCode				NVARCHAR(4000),
		CanonicalURL  VARCHAR(200),
		RobotTag      VARCHAR(50)
			   
	);  
	DECLARE @TBL_BrandDetail TABLE  
	(
		Description          NVARCHAR(MAX),  
		BrandId              INT,  
		BrandCode            VARCHAR(600),  
		DisplayOrder         INT,  
		IsActive             BIT,  
		WebsiteLink          NVARCHAR(1000),  
		BrandDetailLocaleId  INT,  
		MediaPath            NVARCHAR(MAX),  
		MediaId              INT,  
		ImageName      VARCHAr(300) ,  
		CMSSEODetailId       INT,  
		SEOTitle             NVARCHAR(MAX),  
		SEOKeywords          NVARCHAR(MAX),  
		SEOURL               NVARCHAR(MAX),  
		ModifiedDate         DATETIME,  
		SEODescription       NVARCHAR(MAX),  
		MetaInformation      NVARCHAR(MAX),  
		IsRedirect           BIT,  
		CMSSEODetailLocaleId INT,  
		--SEOId                INT,  
		BrandName            NVARCHAR(MAX),  
		RowId                INT,  
		CountId              INT ,
		SEOCode              NVARCHAR(4000), 
		Custom1              NVARCHAR(MAX),
		Custom2              NVARCHAR(MAX),
		Custom3              NVARCHAR(MAX),
		Custom4              NVARCHAR(MAX),
		Custom5              NVARCHAR(MAX)
	);  
	IF @PromotionId > 0  
	BEGIN   
      
	SET @SeoId = ISNULL(SUBSTRING((SELECT ','+CAST(BrandId AS VARCHAR(50))  
	FROM ZnodePromotionBrand   
	WHERE PromotionId= @PromotionId  FOR XML PATH ('') ),2,4000),'0')  
  
	SET @WhereClause = CASE WHEN @IsAssociated = 1 THEN ' BrandId IN (' ELSE ' BrandId NOT IN (' END  +@SeoId+') AND '+CASE WHEN @WhereClause = '' THEN '1=1' ELSE @WhereClause END   
	SET @SeoId = ''  
	END    
 
	;WITH Cte_GetBrandBothLocale AS 
	(
		SELECT ZBDL.Description,ZBD.BrandId,LocaleId,ZBD.BrandCode,ZBD.DisplayOrder,ZBD.IsActive,ZBD.WebsiteLink,ZBDl.BrandDetailLocaleId,  
		SEOFriendlyPageName,[dbo].[Fn_GetMediaThumbnailMediaPath](Zm.path) MediaPath,ZBD.MediaId,Zm.path ImageName, ZBDL.BrandName, ZBD.Custom1, ZBD.Custom2, ZBD.Custom3, ZBD.Custom4, ZBD.Custom5 
		FROM ZnodeBrandDetails ZBD  
		LEFT JOIN ZnodeBrandDetailLocale ZBDL ON(ZBD.BrandId = ZBDL.BrandId)  
		LEFT JOIN ZnodeMedia ZM ON(ZM.MediaId = ZBD.MediaId)  
		WHERE LocaleId IN(@LocaleId, @DefaultLocaleId)  
              
	),  
	Cte_BrandFirstLocale AS 
	(
		SELECT Description,BrandId,LocaleId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5  
		FROM Cte_GetBrandBothLocale CTGBBL  
		WHERE LocaleId = @LocaleId
	),  
	Cte_BrandDefaultLocale AS 
	(
		SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5  
		FROM Cte_BrandFirstLocale  
		UNION ALL  
		SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,SEOFriendlyPageName,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5 
		FROM Cte_GetBrandBothLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandFirstLocale CTBFL  
			WHERE CTBBL.BrandId = CTBFL.BrandId  
		)
	)  
  
	INSERT INTO @TBL_BrandDetails (Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName, BrandName, Custom1, Custom2, Custom3, Custom4, Custom5)  
	SELECT Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName , BrandName, Custom1, Custom2, Custom3, Custom4, Custom5 
	FROM Cte_BrandDefaultLocale CTEBD;  
            
	-----UPDATE BrandName FROM attributedefault value
	;WITH Cte_GetBrandNameLocale AS 
	(
		SELECT d.brandcode, a.AttributeDefaultValueCode, b.AttributeDefaultValue, b.LocaleId 
		FROM ZnodePimAttributeDefaultValue a
		INNER JOIN ZnodePimAttributeDefaultValueLocale b on a.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId 
		INNER JOIN ZnodePimAttribute c on a.PimAttributeId = c.PimAttributeId
		INNER JOIN @TBL_BrandDetails d on a.AttributeDefaultValueCode = d.brandcode
		where c.attributecode = 'brand' and b.LocaleId IN(@LocaleId, @DefaultLocaleId)
              
	)
	,Cte_BrandNameFirstLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_GetBrandNameLocale CTGBBL  
		WHERE LocaleId = @LocaleId
	)
	,Cte_BrandDefaultLocale AS 
	(
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_BrandNameFirstLocale  
		UNION ALL  
		SELECT brandcode, AttributeDefaultValueCode, AttributeDefaultValue, LocaleId  
		FROM Cte_GetBrandNameLocale CTBBL  
		WHERE LocaleId = @DefaultLocaleId  
		AND NOT EXISTS  
		(  
			SELECT TOP 1 1  
			FROM Cte_BrandNameFirstLocale CTBFL  
			WHERE CTBBL.brandcode = CTBFL.brandcode  
		)
	)  
	UPDATE b1 set b1.brandname = a1.AttributeDefaultValue
	FROM Cte_BrandDefaultLocale a1
	INNER JOIN @TBL_BrandDetails b1 on a1.brandcode = b1.brandcode

	DECLARE @SeoCode SelectColumnList
	INSERT INTO @SeoCode
	SELECT BrandCode FROM @TBL_BrandDetails

			
	INSERT INTO @TBL_SeoDetails (CMSSEODetailId,SEOTitle,SEOKeywords,SEOURL,ModifiedDate,SEODescription,MetaInformation,IsRedirect,CMSSEODetailLocaleId,PublishStatus,SEOCode
	,CanonicalURL,RobotTag)  
	EXEC Znode_GetSeoDetails @SeoCode,'Brand', @LocaleId;  
                  
	SELECT DISTINCT TBBD.*,TBSD.SEOTitle,TBSD.SEOKeywords,TBSD.SEOURL,TBSD.SEODescription,TBSD.MetaInformation,TBSD.IsRedirect,
		TBSD.PublishStatus,TBSD.SEOCode,TBSD.CanonicalURL,TBSD.RobotTag,TBSD.CMSSEODetailId
	INTO #TM_BrandLocale  
	FROM @TBL_BrandDetails TBBD  
	LEFT JOIN @TBL_SeoDetails TBSD ON(TBSD.SEOCode = TBBD.BrandCode)  

	SET @SQL = '   
	;With Cte_BrandDetails AS   
	(  
		SELECT * ,'+[dbo].[Fn_GetPagingRowId](@Order_BY, 'BrandId DESC')+',Count(*)Over() CountId  
		FROM #TM_BrandLocale TMADV  
		WHERE 1=1  
		'+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+'  
  
	)  
	SELECT Description  , BrandId , BrandCode , DisplayOrder  ,IsActive  ,WebsiteLink ,BrandDetailLocaleId   
		, MediaPath ,MediaId,ImageName ,SEOTitle ,SEOKeywords , SEOURL   
		, SEODescription   ,MetaInformation   ,IsRedirect   
		,BrandName ,RowId  ,CountId ,SEOCode,  Custom1, Custom2, Custom3, Custom4, Custom5,CMSSEODetailId  
	INTO #BrandDetailsPagination
	FROM Cte_BrandDetails  
	'+[dbo].[Fn_GetOrderByClause](@Order_BY, 'BrandId DESC')+' 
	
	SELECT Description  , BrandId , BrandCode , DisplayOrder  ,IsActive  ,WebsiteLink ,BrandDetailLocaleId   
		, MediaPath ,MediaId,ImageName ,SEOTitle ,SEOKeywords , SEOURL   
		, SEODescription   ,MetaInformation   ,IsRedirect   
		,BrandName ,RowId  ,CountId ,SEOCode,  Custom1, Custom2, Custom3, Custom4, Custom5,CMSSEODetailId
	FROM #BrandDetailsPagination'+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'BrandId DESC');  
  
	INSERT INTO @TBL_BrandDetail  
	(  
		Description,BrandId,BrandCode,DisplayOrder,IsActive,WebsiteLink,  
		BrandDetailLocaleId,MediaPath,MediaId,ImageName,SEOTitle,  
		SEOKeywords,SEOURL,SEODescription,MetaInformation,IsRedirect,  
		BrandName,RowId,CountId ,SEOCode , Custom1, Custom2, Custom3, Custom4, Custom5,CMSSEODetailId
	)  
	EXEC (@SQL);  
	
	SET @RowsCount = ISNULL(  
		(  
			SELECT TOP 1 CountId  
			FROM @TBL_BrandDetail  
		), 0);  


	SELECT BrandId,Description,BrandCode,DisplayOrder,IsActive,WebsiteLink,BrandDetailLocaleId,MediaPath,MediaId,ImageName,CMSSEODetailId,SEOTitle,SEOKeywords,SEOURL SEOFriendlyPageName,SEODescription,MetaInformation,IsRedirect,BrandName,@PromotionId PromotionId   
		,SEOCode,Custom1, Custom2, Custom3, Custom4, Custom5
	FROM @TBL_BrandDetail;
	
END TRY  
BEGIN CATCH  
DECLARE @Status BIT ;  
	SET @Status = 0;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),   
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetBrandDetailsLocale @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))
	+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@PromotionId='+CAST(@PromotionId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_GetBrandDetailsLocale',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH;  
END;

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishPortalEntity')
	DROP PROC Znode_PublishPortalEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishPortalEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@UserId int = 0
  ,@Status Bit =0 OUTPUT 
  ,@IsContentType Bit= 1
  ,@NewGUID nvarchar(500)  
)
AS
/*
  To publish all Content pages and their mapping into their respective entities 
	ZnodePublishContentPageConfigEntity
	ZnodePublishSEOEntity
	ZnodePublishWidgetProductEntity
	ZnodePublishMediaWidgetEntity
	ZnodePublishSearchWidgetEntity
	ZnodePublishTextWidgetEntity
	ZnodePublishWidgetSliderBannerEntity
	ZnodePublishWidgetTitleEntity

	Unit Testing : 
	Declare @Status bit 
	

	Declare @Status bit 
	Exec [dbo].[Znode_PublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 


*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @PortalCode Varchar(100)
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@UserName Varchar(50);
	SET @Status = 1 
	Declare @IsPreviewEnable int,@PreviewVersionId INT = 0  ,@ProductionVersionId INT = 0
	
	Select TOP 1  @UserName = aspNetZnodeUser.UserName from ZnodeUser Inner Join aspNetUsers ON ZnodeUser.aspNetUserId = aspNetUsers.Id 
	Inner Join aspNetZnodeUser on aspNetUsers.UserName = aspNetZnodeUser.AspNetZnodeUserId
	where ZnodeUser.UserId = @userId
            


 		If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
		Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
			SET @IsPreviewEnable = 1 
		else 
			SET @IsPreviewEnable = 0 

		--Generate preview entry 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		
		DECLARE @TBL_StoreEntity TABLE 
		(
			 PortalThemeId	int,PortalId	int,ThemeId	int,ThemeName	varchar(200),CSSId	int,CSSName	nvarchar(2000),
			 WebsiteLogo	varchar(300),WebsiteTitle	nvarchar(400),FaviconImage	varchar(300),WebsiteDescription	nvarchar(MAX),
			 PublishState	varchar(100),LocaleId	int	
		)
		
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		Create Table #Tbl_VersionEntity(PortalId int , VersionId int , LocaleId int , PublishType varchar(50) )

		IF object_id('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntity
		Create Table #Tbl_OldVersionEntity(PortalId int , NewVersionId int ,OldVersionId int , LocaleId int , PublishType varchar(50) )

	
		DECLARE @WebStoreEntityId int 
		
		select @PortalCode  = StoreName  from ZnodePortal where PortalId = @PortalId 
		
		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
		
		---managed brand seo data
		--delete ZCSDL from ZnodeCMSSEODetailLocale ZCSDL
		--where exists(select *  from ZnodeCMSSEODetail ZCSD1
		--where not exists(select * from ZnodeBrandDetails ZBD
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		--and ZBD.BrandCode = ZCSD1.SEOCode) and ZCSDL.CMSSEODetailId = ZCSD1.CMSSEODetailId
		--and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'))


		--delete ZCSD1 from ZnodeCMSSEODetail ZCSD1
		--where not exists(select * from ZnodeBrandDetails ZBD
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		--and ZBD.BrandCode = ZCSD1.SEOCode)
		--and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')

		--insert into ZnodeCMSSEODetail(CMSSEOTypeId,SEOId,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		--,IsPublish,SEOCode,PublishStateId)
		--select distinct (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'),null,null,null,ZPB.PortalId,isnull(ZBDL.SEOFriendlyPageName,ZBD.BrandCode),@userId,
		--getdate(),@userId,getdate(),null,ZBD.BrandCode,3
		--from ZnodeBrandDetails ZBD
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		--inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		--where not exists(select * from ZnodeCMSSEODetail ZCSD1 where ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		--and ZCSD1.PortalId = ZPB.PortalId
		--and ZBD.BrandCode = ZCSD1.SEOCode) and ZPB.PortalId = @PortalId

		--insert into ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)
		--select distinct ZCSD.CMSSEODetailId,L.LocaleId,ZBDL.BrandName,ZBDL.BrandName,ZBDL.BrandName,@userId,getdate(),@userId,getdate(),null,null
		--from ZnodeCMSSEODetail ZCSD
		--inner join ZnodeBrandDetails ZBD on ZCSD.SEOCode = ZBD.BrandCode
		--inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		--cross apply @TBL_Locale L
		--where CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		--and not exists(select * from ZnodeCMSSEODetailLocale ZCSDL where ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId)
		-- ---managed brand seo data
		
		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			if (@IsPreviewEnable = 1 AND ( @RevisionState like '%Preview%'  OR @RevisionState like '%Production%' ) ) 
			Begin
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
				
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PREVIEW'
				
			End
			If (@RevisionState like '%Production%' OR @RevisionState = 'None')
			Begin
				--Genrate production entry 
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
			
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PRODUCTION'
			End 
	   	SET @IncrementalId = @IncrementalId +1 
		END 

	Truncate table ZnodePublishPortalErrorLogEntity

	Declare @IsFirstTimeContentPublish bit 
	If Exists (Select TOP 1 1  from ZnodePublishWebStoreEntity where PortalId = @PortalId)
		SET @IsFirstTimeContentPublish =1 
	else 
		SET @IsFirstTimeContentPublish =0
    
	Declare @Tbl_PreviewVersionId  TABLE (VersionId int , PortalId int , LocaleId int )
	Declare @Tbl_ProductionVersionId  TABLE (VersionId int , PortalId int , LocaleId int )

	If @IsContentType = 0 AND @IsFirstTimeContentPublish =1 
	Begin 
		Insert into #Tbl_OldVersionEntity (PortalId,NewVersionId,OldVersionId, LocaleId, PublishType)
		Select A.PortalId , A.VersionId, B.VersionId, a.LocaleId,a.PublishType from #Tbl_VersionEntity A Inner join ZnodePublishWebStoreEntity B on 
		A.PortalId = B.PortalId and A.LocaleId = B.LocaleId AND A.PublishType= B.PublishState  
	End
	Delete from ZnodePublishProgressNotifierEntity where JobName  = @PortalCode 
	
	INSERT INTO ZnodePublishProgressNotifierEntity
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	Values(0,@NewGUID , Isnull(@PortalCode,'') + ' Store' , 0 , 0 , 0 , '' , @UserId, @UserName)

	if @Type = 'ZnodePublishWebStoreEntity' OR @Type = ''
	Begin
		 Declare  @PreviewVersionIdString varchar(1000)= ''  ,@ProductionVersionIdString varchar(1000) = '' 
		 SELECT   @PreviewVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PREVIEW'  FOR XML PATH ('')), 1, 1, '') 
		 SELECT   @ProductionVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PRODUCTION'  FOR XML PATH ('')), 1, 1, '') 
		 
		 EXEC [dbo].[Znode_SetPublishWebStoreEntity]
			 @PortalId  = @PortalId 
			,@LocaleId   = @LocaleId 
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = @PreviewVersionIdString 
			,@ProductionVersionId = @ProductionVersionIdString 
			,@RevisionState = @RevisionState 
			,@UserId = @UserId	
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWebStoreEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =5 , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End
	
	if (@Type = 'ZnodePublishPortalBrandEntity' OR @Type = '' ) AND @Status = 1 
	Begin
			Exec [Znode_SetPublishPortalBrandEntity]
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@UserId = @UserId  
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark = CASE When (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) THEN 10 Else 100 End , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End 

	if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1 and (@IsContentType = 0 or @PortalId > 0)
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '4'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

			End 
	If (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) AND @Status = 1  
	Begin
			if @Type = 'ZnodePublishBlogNewsEntity' OR @Type = '' 
			Begin
				 EXEC [dbo].[Znode_SetPublishBlogNewsEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishBlogNewsEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 15 , 
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			End
			if (@Type = 'ZnodePublishPortalCustomCssEntity' OR @Type = '' ) AND @Status = 1  
			Begin
				 EXEC [dbo].[Znode_SetPublishPortalCustomCssEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalCustomCssEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 20  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID


			End
			if (@Type = 'ZnodePublishWidgetCategoryEntity' OR @Type = '' ) AND @Status = 1 
			Begin
				 EXEC [dbo].[Znode_SetPublishWidgetCategoryEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 25  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			End
	
			if (@Type = 'ZnodePublishWidgetProductEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetProductEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 30  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			END 

			if (@Type = 'ZnodePublishWidgetTitleEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetTitleEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetTitleEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 35  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			END 
			if (@Type = 'ZnodePublishWidgetSliderBannerEntity' OR @Type = '')AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetSliderBannerEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@CMSSliderId = 0 
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetSliderBannerEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 40  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishTextWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishTextWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishTextWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 45  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 
			if (@Type = 'ZnodeSetPublishMediaWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishMediaWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMediaWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
										
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 50  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishSearchWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishSearchWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSearchWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 55  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 

			if (@Type = 'ZnodePublishContentPageConfigEntity' OR @Type = '') AND @Status = 1
			Begin
				 EXEC [dbo].[Znode_SetPublishContentPageConfigEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContentPageConfigEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			End

			if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '3,5'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
			if (@Type = 'ZnodePublishMessageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishMessageEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMessageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 65,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

		   if (@Type = 'ZnodePublishPortalGlobalAttributeEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishPortalGlobalAttributeEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalGlobalAttributeEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 67,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
 
		   if (@Type = 'ZnodePublishProductPageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishProductPageEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishProductPageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 73,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			


			End 
			
			if (@Type = 'ZnodePublishWidgetBrandEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishWidgetBrandEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 80,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

			if (@Type = 'ZnodePublishContainerWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishContainerWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContainerWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 90  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 

	End
		IF Exists (select TOP 1 1  from ZnodePublishPortalErrorLogEntity where  ProcessStatus = 'Fail') 
		Begin
			SET @Status  =0 
			SELECT 1 AS ID,@Status AS Status;
			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Delete  From ZnodePublishWebStoreEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
			Delete  From ZnodePublishBlogNewsEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetTitleEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishTextWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishMediaWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSearchWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishContentPageConfigEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSEOEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId and CMSSEOTypeId in (3,5)
			Delete  From ZnodePublishMessageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalBrandEntity Where  VersionId  in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishProductPageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetBrandEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
		
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),ModifiedDate=GETDATE()  where  PublishPortalLogId in  (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),ModifiedDate=GETDATE()  where  PublishPortalLogId in (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )

		End
	Else 
		Begin
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPreview(),ModifiedDate=GETDATE()  where  PublishPortalLogId in 
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublish(),ModifiedDate=GETDATE()  where  PublishPortalLogId in
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )
			 
			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PortalId,'portal','portal has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from ZnodePublishWebStoreEntity where LocaleId = A.LocaleId AND PublishState = A.PublishType
				 and PortalId = @PortalId),A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId

			If @RevisionState = 'PREVIEW'
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End 
			Else 
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End
			
			if (@IsContentType =1  OR (@IsContentType = 0 AND @IsFirstTimeContentPublish =0))
			Begin
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				End
			End
			Else 
			Begin
				
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId =6)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5) 

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				End 
			End

			--update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
			--update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
			--SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
		 SET @Status = 1
		End
	SELECT 1 AS ID,@Status AS Status;   

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   

	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishPortalEntity 
		@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
			
	INSERT INTO ZnodePublishPortalErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'ZnodePublishPortalEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishPortalEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF OBJECT_ID('tempdb..#ZnodeCMSSeoDetail') IS NOT NULL
    DROP TABLE #ZnodeCMSSeoDetail

SELECT A.CMSSEODetailId
INTO #ZnodeCMSSeoDetail
FROM 
(
    SELECT CMSSEODetailId,ROW_NUMBER() OVER (PARTITION BY SEOCode ORDER BY CreatedDate DESC) As Rn 
	FROM ZnodeCMSSeoDetail
	WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Brand')
) A WHERE A.Rn>1
IF EXISTS (SELECT TOP 1 1 FROM #ZnodeCMSSeoDetail)
BEGIN
	DELETE FROM ZnodeCMSSeoDetailLocale 
	WHERE CMSSEODetailId IN (SELECT CMSSEODetailId FROM #ZnodeCMSSeoDetail)

	DELETE 
	FROM ZnodeCMSSeoDetail 
	WHERE CMSSEODetailId IN (SELECT CMSSEODetailId FROM #ZnodeCMSSeoDetail)

	UPDATE ZnodeCMSSeoDetail
	SET PortalId=NULL
	WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Brand')
END

GO

INSERT INTO [dbo].[ZnodeActions]
    ([AreaName],[ControllerName],[ActionName],[IsGlobalAccess],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
SELECT NULL,'GiftCard','ActiveDeactiveSingleVoucher',1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeActions WHERE ControllerName='GiftCard' AND ActionName='ActiveDeactiveSingleVoucher')

GO

UPDATE ZnodeApplicationSetting
SET Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>UserId</name><headertext>Checkbox</headertext><width>40</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>UserId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>FullName</name><headertext>Full Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Full Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>Username</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>User Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Email</name><headertext>Email ID</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Email Id</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>RoleName</name><headertext>Role Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Phone Number</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>DepartmentName</name><headertext>Department</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Phone Number</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Pending Order History</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/AccountQuoteList</manageactionurl><manageparamfield>UserId,AccountId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Order History</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/AccountUserOrderList</manageactionurl><manageparamfield>UserId,AccountId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Manage|Disable</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Manage|Disable</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Customer/CustomerEdit|/Account/CustomerEnableDisableAccount</manageactionurl><manageparamfield>UserId|AccountId,UserId,IsLock|UserId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>LastName</name><headertext>Last Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Last Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>IsLock</name><headertext>Is Lock</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Is Lock</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>AccountId</name><headertext>User ID</headertext><width>40</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Is Lock</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeAccountsCustomer'

GO

update ZnodeApplicationSetting 
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ImportProcessLogId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>ImportProcessLogId</islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ImportProcessLogId</name><headertext>ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ImportName</name><headertext>Import Type</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>ImportTemplateId</name><headertext>Template ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>TemplateName</name><headertext>Template Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Status</name><headertext>Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ProcessStartedDate</name><headertext>Start Date</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>ProcessCompletedDate</name><headertext>End Date</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View|Delete</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Import/ShowLogDetails|/Import/Deletelogs</manageactionurl><manageparamfield>ImportProcessLogId|ImportProcessLogId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeImportProcessLog'

GO

IF EXISTS (SELECT * FROM sysobjects WHERE xtype IN (N'FN', N'IF', N'TF') AND id = object_id(N'Fn_ValidateData'))
    DROP FUNCTION Fn_ValidateData
GO

CREATE FUNCTION Fn_ValidateData 
( 
	@AttributeType VARCHAR(200)
	,@Data VARCHAR(Max)
	,@validationRule VARCHAR(300) = ''
	,@validationValue VARCHAR(400) = ''
)

RETURNS BIT

AS
BEGIN
	DECLARE @ATTRIBUTEVALIDATION AS BIT
	-- FOR NUMBER VALIDATION
	IF @AttributeType ='Number'
	BEGIN
		IF ISNUMERIC(@Data) =1
		BEGIN
			SET @ATTRIBUTEVALIDATION = CASE 
				WHEN @validationRule= 'AllowNegative' AND @validationValue = 'FALSE' AND CAST(@Data AS INT) >= 0 THEN 1
				WHEN @validationRule= 'AllowDecimals' AND @validationValue = 'TRUE' AND @Data NOT Like '%_._%' THEN 1
				WHEN @validationRule= 'MinNumber' AND CAST(IIF(@validationValue='',@Data,@validationValue) AS INT) <=CAST(@Data AS INT) THEN 1
				WHEN @validationRule= 'MaxNumber' AND CAST(IIF(@validationValue='',@Data,@validationValue) AS INT) >=CAST(@Data AS INT) THEN 1 ELSE 0 END				
		END
		ELSE 
		BEGIN 
			SET @ATTRIBUTEVALIDATION=0					
		END
	END

	--FOR TEXT VALIDATION
	ELSE IF @AttributeType ='Text'
	BEGIN
		IF @Data='' 
		BEGIN					
			SET @ATTRIBUTEVALIDATION=0				
		END
		ELSE 
		BEGIN
			SET @ATTRIBUTEVALIDATION = CASE
				WHEN @validationRule= 'RegularExpression' AND @Data LIKE '%'+@validationValue+'%' THEN 1 
				WHEN @validationRule= 'MaxCharacters' AND IIF(@validationValue='',LEN(@Data),@validationValue) >= LEN(@Data) THEN 1 ELSE 0 END			
		END
	END

	--FOR DATE VALIDATION
	ELSE IF @AttributeType ='Date'
	BEGIN
		IF ISDATE(@Data)=1
		BEGIN
			SET @ATTRIBUTEVALIDATION = CASE 
				WHEN @validationRule= 'MinDate' AND CAST(IIF(@validationValue='',@Data,@validationValue) AS DATE) >=CAST(@Data AS DATE) THEN 1
				WHEN @validationRule= 'MaxDate' AND CAST(IIF(@validationValue='',@Data,@validationValue) AS DATE) <=CAST(@Data AS DATE) THEN 1 ELSE 0 END 					
		END
		ELSE 
		BEGIN 
			SET @ATTRIBUTEVALIDATION=0				
		END
	END
	
	--FOR YES/NO VALIDATION
	ELSE IF @AttributeType ='Yes/No'
	BEGIN
		IF @Data IN ('1','0','YES','NO','TRUE','FALSE')
		BEGIN
			SET @ATTRIBUTEVALIDATION=1				
		END ELSE 
		BEGIN 
			SET @ATTRIBUTEVALIDATION=0				
		END
	END

	RETURN @ATTRIBUTEVALIDATION
END

GO

IF EXISTS (SELECT * FROM sysobjects WHERE xtype IN (N'FN', N'IF', N'TF') AND id = object_id(N'Fn_ValidateDataErrorCode'))
    DROP FUNCTION Fn_ValidateDataErrorCode
GO

CREATE FUNCTION Fn_ValidateDataErrorCode 
( 
	@AttributeType VARCHAR(200)
	,@validationRule VARCHAR(200)
)

RETURNS INT

AS
BEGIN
	DECLARE @ATTRIBUTEVALIDATION INT

	--FOR NUMBER VALIDATION
	IF @AttributeType ='Number'
	BEGIN
		SET @ATTRIBUTEVALIDATION = CASE 
				                        WHEN @validationRule= 'AllowNegative' THEN 4  
										WHEN @validationRule= 'AllowDecimals' THEN 26  
										WHEN @validationRule= 'MinNumber' THEN 3   
										WHEN @validationRule= 'MaxNumber' THEN 3 ELSE 2 END
	END
	ELSE IF @AttributeType ='Date' 
	BEGIN 
		SET @ATTRIBUTEVALIDATION = CASE 
						            WHEN @validationRule= 'MinDate' THEN 6 
						            WHEN @validationRule= 'MaxDate' THEN 7 ELSE 4 END

	END
	ELSE IF @AttributeType ='Text' 
	BEGIN
		SET @ATTRIBUTEVALIDATION = CASE 
                                    WHEN @validationRule= 'RegularExpression' THEN 79
                                    WHEN @validationRule= 'MaxCharacters' THEN 78
                                    WHEN @validationRule= 'UniqueValue' THEN 30 ELSE 50 END
	END 
				
	RETURN @ATTRIBUTEVALIDATION
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY

	    DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
			@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
			,@ProfileId INT, @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT @RoleId = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId

		DECLARE @AttributeCode Nvarchar(max) = ''
		SELECT @AttributeCode=STRING_AGG(c.AttributeCode , ',')   
		FROM ZnodeGlobalFamilyGroupMapper a
		INNER JOIN ZnodeGlobalAttributeGroupMapper f ON (f.GlobalAttributeGroupId = a.GlobalAttributeGroupId)
		INNER JOIN ZnodeGlobalAttribute c ON (c.GlobalAttributeId = f.GlobalAttributeId)
		WHERE GlobalAttributeFamilyId = (SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily where FamilyCode='User')
			AND NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='ZnodeUser' AND COLUMN_NAME=c.AttributeCode)
			AND EXISTS (SELECT TOP 1 1 FROM tempdb.sys.columns WHERE Object_id = Object_id(@TableName) AND name = c.AttributeCode )
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = ' ALTER TABLE #InsertCustomer ADD '+REPLACE(TRIM(LTRIM(@AttributeCode)), ',',' NVARCHAR(max),' ) + CASE WHEN @AttributeCode = '' THEN '' ELSE ' NVARCHAR(max)' END 
		EXEC (@SSQL)

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
						SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;

		EXEC sys.sp_sqlexec @SSQL;

		--If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''

		IF @CsvColumnString NOT LIKE '%AccountCode%'
		BEGIN
			--If Acount Code Exists then it will update as it is and if not exists then it will show error.
			UPDATE IC set AccountCode = ZA.AccountCode
			FROM ZnodeUser a
			INNER JOIN ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
			INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
			WHERE ISNULL(IC.AccountCode,'') = '' 
		END
		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		
		IF (ISNULL(@ProfileId ,0) = 0 ) 
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
			WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
			SELECT @SuccessRecordCount = 0

			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
			WHERE ImportProcessLogId = @ImportProcessLogId;

			DELETE FROM #InsertCustomer 
			SET @Status = 0;

			COMMIT TRAN A;
			RETURN 0 
		END
		
		IF @IsAllowGlobalLevelUserCreation = 'true'
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertCustomer AS ii  
			WHERE ltrim(rtrim(ii.UserName)) IN (SELECT UserName FROM AspNetZnodeUser);  
		END

        INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
			AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
				WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
			AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' AND ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') NOT IN 
			(
				SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
			);

        INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' AND ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') AND  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
			AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
				WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = LTRIM(RTRIM(za.AccountCode))
				AND ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = LTRIM(RTRIM(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');
	
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		IF OBJECT_ID('tempdb..#GlobalAttributeData1') IS NOT NULL 
		DROP TABLE #GlobalAttributeData1

		CREATE TABLE #GlobalAttributeData1 (RowNumber INT,Username NVARCHAR(500),FirstName NVARCHAR(100),LastName NVARCHAR(100),AttributeCode Nvarchar(300),AttributeValue Nvarchar(Max),Userid Int)

		SET @SSQL =' Select RowNumber,Username,FirstName,LastName,AttributeCode,AttributeValue
                    FROM #InsertCustomer 
					UNPIVOT
					( AttributeValue For AttributeCode IN ('+@AttributeCode+')
					) UNPIVOT8'
                
		INSERT INTO #GlobalAttributeData1(RowNumber,Username,FirstName,LastName,AttributeCode,AttributeValue)   
        EXEC sys.sp_sqlexec @SSQL;  

		ALTER TABLE #GlobalAttributeData1 ADD AttributetypeName VARCHAR(200) , ValidationName VARCHAR(600) , ValidationValue VARCHAR(600)
		
		UPDATE A
		SET A.AttributetypeName=C.AttributeTypeName, ValidationName = d.name  , ValidationValue =  e.Name
		FROM #GlobalAttributeData1 A
		INNER JOIN ZnodeGlobalAttribute B ON (B.AttributeCode=A.AttributeCode)
		INNER JOIN ZnodeAttributeType C ON (C.AttributeTypeId=B.AttributeTypeId)
		INNER JOIN ZnodeAttributeInputValidation d ON (d.AttributeTypeId = c.AttributeTypeId )
		INNER JOIN ZnodeGlobalAttributeValidation e ON (e.InputValidationId = d.InputValidationId AND b.GlobalAttributeId = e.GlobalAttributeId)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT dbo.Fn_ValidateDataErrorCode(ii.AttributetypeName,ii.ValidationName ), ii.AttributeCode, ii.AttributeValue , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #GlobalAttributeData1 AS ii  
		WHERE  dbo.Fn_ValidateData (ii.AttributetypeName,ii.AttributeValue,ii.ValidationName, ii.ValidationValue)=0
		
		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
			--AND GUID = @NewGUID
		);

		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
		DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
		DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
		DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

		UPDATE ANU 
		SET ANU.PhoneNumber	= IC.PhoneNumber, 
			ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
		FROM AspNetZnodeUser ANZU 
		INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
		WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
		----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

		UPDATE ZU SET 
		ZU.FirstName	= IC.FirstName,
		ZU.LastName		= IC.LastName,
		--ZU.MiddleName	= IC.MiddleName,
		ZU.BudgetAmount = IC.BudgetAmount,
		ZU.Email		= IC.Email,
		ZU.PhoneNumber	= IC.PhoneNumber,
		ZU.EmailOptIn	= (CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
		ZU.IsActive		= (CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
		ZU.Custom1 = IC.Custom1,
		ZU.Custom2 = IC.Custom2,
		ZU.Custom3 = IC.Custom3,
		ZU.Custom4 = IC.Custom4,
		ZU.Custom5 = IC.Custom5,
		ZU.SMSOptIn	= (CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN '' THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
		--ZU.ExternalId = ExternalId
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
		WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
		--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

		INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
		OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
		SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
			WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
				AND ANZ.UserName = IC.UserName)

		INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
		LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
		OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
		SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
			0,@GetDate,AspNetZnodeUserId 
		FROM #InsertCustomer A 
		INNER JOIN @InsertedAspNetZnodeUser B ON A.UserName = B.UserName
			
		INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
			IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
		OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
		SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email,IC.PhoneNumber,
			(CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
			(CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
			IC.ExternalId, @UserId,
			CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
			@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
				(CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
		FROM #InsertCustomer IC 
		INNER JOIN @InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName
		INNER JOIN @InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
		INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
		INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
		SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
		FROM @InsertZnodeUser IZU

		INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
		FROM @InsertZnodeUser IZU
		
		UPDATE a 
		SET a.Userid = b.UserId
		FROM #GlobalAttributeData1 a 
		INNER JOIN ZnodeUser b ON (b.username = a.Username)  
				
		UPDATE D
		SET D.AttributeValue=A.AttributeValue
		FROM #GlobalAttributeData1 A 
		INNER JOIN ZnodeGlobalAttribute C ON A.AttributeCode=C.AttributeCode
		INNER JOIN ZnodeUser ZU ON LTRIM(RTRIM(a.Username))=LTRIM(RTRIM(ZU.UserName)) 
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=ZU.UserId and ZUP.PortalId=@PortalId
		INNER JOIN ZnodeUserGlobalAttributeValue b ON c.GlobalAttributeId=b.GlobalAttributeId AND ZU.UserId=b.UserId
		INNER JOIN ZnodeUserGlobalAttributeValueLocale d on b.UserGlobalAttributeValueId=d.UserGlobalAttributeValueId

		INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,ModifiedBy,	ModifiedDate)
		SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
		FROM #GlobalAttributeData1 g 
		INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.AttributeCode
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=g.UserId and ZUP.PortalId=@PortalId
		WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

		INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
		SELECT UserGlobalAttributeValueId, @LocaleId,g.AttributeValue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
		FROM ZnodeUserGlobalAttributeValue ZUGAV 
		INNER JOIN #GlobalAttributeData1 g on ZUGAV.userid =g.userid
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=g.UserId and ZUP.PortalId=@PortalId
		INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.AttributeCode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
		WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

		---------------------------------------------------------------------------------

		DECLARE @Profile table (ProfileId INT)

		INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
		OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
		SELECT Distinct ProfileName, 0, null,0, REPLACE(LTRIM(RTRIM(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
		FROM #InsertCustomer IC
		WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
			AND ISNULL(ic.ProfileName,'') <> ''

		INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
		SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
		FROM @Profile

		UPDATE ZnodeUserProfile 
		SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
		LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
		--WHERE IC.ProfileName <> ''
				
		INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
			AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

		--Updating RoleName if customer has changed the account and RoleName left blank then by default User role assigned to the customer
		UPDATE u 
		set u.RoleId = @RoleId
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		WHERE ISNULL(IC.AccountCode,'') <> '' AND ISNULL(IC.RoleName,'') = ''
			AND EXISTS(SELECT * FROM ZnodeAccount ZA WHERE ISNULL(a.AccountId,0) = ZA.AccountId AND ZA.AccountCode <> IC.AccountCode)

		---to update accountid agaist user
		UPDATE ZU 
		SET ZU.AccountId = ZA.AccountId 
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
		INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
		--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
		WHERE ISNULL(ANZU.PortalId,0) = ISNULL(@PortalId ,0) AND ISNULL(IC.AccountCode,'') <> '' 
		--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )
				
		UPDATE ZDU 
		set ZDU.DepartmentId = ZD.DepartmentId, 
			ModifiedBy = @UserId, 
			ModifiedDate = @Getdate
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
		INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
		WHERE ISNULL(IC.DepartmentName,'') <> ''

		INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
			AND ISNULL(IC.DepartmentName,'') <> ''
		
		UPDATE u 
		SET u.RoleId = ZD.Id
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		WHERE isnull(IC.RoleName,'') <> '' 
		
		--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
		--after the update process is complete.
		DELETE UR 
		FROM AspNetUserRoles UR 
		INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))

		UPDATE ZnodeUser SET AccountId = NULL 
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		
		
		INSERT INTO AspNetUserRoles(UserId,RoleId)
		SELECT b.Id as ASPNetUserId, CASE WHEN ZD.Id IS NULL THEN @RoleId ELSE ZD.Id END as RoleId
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
			AND ISNULL(IC.AccountCode,'') <> ''
			
		--If no value was available previously then no value should be saved after the update process is complete.
		--If a value was available previously, then it should be removed after the update process is complete.
		DELETE DU 
		FROM ZnodeDepartmentUser DU
		INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
		INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN A;
		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount WITH (NOLOCK) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
			TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount WITH (NOLOCK) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportCustomer',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventory')
	DROP PROC Znode_UpdateInventory
GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventory]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
			   SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
			   , Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
			   FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
			   WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
			   AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0
			   ;
		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 
   
		Update X SET x.OrderLineItemRelationshipTypeId = b.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems a
		inner join ZnodeOmsOrderLineItems b on a.OmsOrderLineItemsId = b.ParentOmsOrderLineItemsId 
		inner join @TBL_XmlReturnToTable X on x.OrderLineItemId = a.OmsOrderLineItemsId
		where a.ParentOmsOrderLineItemsId is null
		and b.ParentOmsOrderLineItemsId is not null


		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
	
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
			SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
			FROM dbo.ZnodeInventory AS zi
			LEFT JOIN [ZnodePortalWarehouse] AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
			WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
			AND ZPW.WarehouseId IS NOT NULL
			ORDER BY ZPW.Precedence DESC
			
			INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
			SELECT zpaw.WarehouseId, @PortalId, zpaw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER (ORDER BY zpaw.WarehouseId),
			CASE WHEN EXISTS ( SELECT TOP 1 1 FROM @TBL_AllwareHouseToportal WE WHERE WE.SKU = ZI.SKU  ) THEN 2 ELSE 1 END
			FROM dbo.ZnodeInventory AS zi 
			INNER JOIN [dbo].[ZnodePortalAlternateWarehouse] AS zpaw ON zpaw.WarehouseId = ZI.WareHouseId
			WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId) AND 
			EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) ORDER BY ZPAW.Precedence DESC;

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and group
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		where exists(select * from ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			and ZOOLI.ParentOmsOrderLineItemsId is not null) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) <> (Select top 1 OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		---Getting data for bundle products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		where exists(select * from ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId = (Select top 1 OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Bundles','Configurable','Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			select WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			from @TBL_CalculateQuntity A
			group by WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		update b set  b.OrderQuantity = a.OrderQuantity
		from cte a
		inner join @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 
			--AND a.WarehouseSequenceId = @Initializationofloop - 1

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 
			--AND WarehouseSequenceId = @Initializationofloop - 1


			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		   IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		   BEGIN 
		    UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
		    AND ISNULL(UpdatedQuantity,0) < 0
		   END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	    
		SET @Status = 0;

		SELECT SKU, Quantity, InventoryTracking,AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;		
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'Znode_UpdateInventory @SkuXml = '+CAST(@SkuXml AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@Status='+CAST(@Status AS VARCHAR(10))+',@IsDebug ='+CAST(@IsDebug AS VARCHAR(10));
         
        EXEC Znode_InsertProcedureErrorLog

			@ProcedureName = 'Znode_UpdateInventory',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;

	END CATCH;  
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT)
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @GroupOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Group')
    DECLARE @versionId INT = (
    SELECT TOP 1 a.VersionId FROM  ZnodePublishVersionEntity a with(nolock) 
    INNER JOIN ZnodePortalCatalog b with(nolock) ON (b.PublishCatalogId = a.ZnodeCatalogId)
    INNER JOIN ZnodeOmsOrderDetails c with(nolock) ON (c.PortalId = b.PortalId)
    INNER JOIN ZnodeOmsOrder d ON (d.OmsOrderId = c.OmsOrderId) 
    WHERE c.OmsOrderId = @OmsOrderId AND a.LocaleId = dbo.Fn_GetDefaultLocaleId()  AND a.RevisionType = (SELECT TOP 1 PublishStateCode FROM ZnodePublishState t WHERE t.PublishStateId = d.PublishStateId ) ) 
 
   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 AND Exists(Select TOP 1 1 From ZnodePublishProductEntity ZPP With(NOLOCK) Where ZPP.SKU= ZOOLI.Sku AND ZPP.IsActive=1 AND ZPP.VersionId = @versionId)
  

		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence = RowId

		DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
		DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
		INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


		DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

		DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
		AND TR.ParentOmsOrderLineItemsId IS NULL 

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON A.OmsOrderLineItemsId = B.ParentOmsOrderLineItemsId
		WHERE A.ParentOmsOrderLineItemsId IS NULL

		UPDATE B
		SET B.ParentRowID = A.ParentRowID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OrderLineItemRelationshipTypeID=B.OrderLineItemRelationshipTypeID)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OmsOrderLineItemsId=B.ParentOmsOrderLineItemsId AND B.OrderLineItemRelationshipTypeID IS NOT NULL)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL AND B.OrderLineItemRelationshipTypeID=@AddOnOrderLineItemRelationshipTypeId

	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence INTO @TBL_ZnodeOmsSavedCartLineItem 
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

		UPDATE ab 
		SET ab.ParentOmsSavedCartLineItemId = 
			(SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowID)
		FROM ZnodeOmsSavedCartLineItem ab 
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId) 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId) 

		INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		FROM ZnodeOmsPersonalizeItem  a 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId)

		UPDATE ZOSCLI1 set Quantity = null
		from ZnodeOmsSavedCartLineItem ZOSCLI1
		where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		and Quantity is not null
		and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId IN (@BundleOrderLineItemRelationshipTypeId,@GroupOrderLineItemRelationshipTypeId ) and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		--Update Qty for Parentlineitem except simple product
		UPDATE ZOSCLI
		SET Quantity = ZOSCLI.Quantity+Old.Quantity
		FROM ZnodeOmsSavedCartLineItem ZOSCLI
		INNER JOIN #ZnodeOmsSavedCartLineItemNew New ON (ZOSCLI.OmsSavedCartLineItemId = New.OmsSavedCartLineItemId)
		INNER JOIN #ZnodeOmsSavedCartLineItemOld Old ON (New.SKU = Old.SKU)
		WHERE ZOSCLI.ParentOmsSavedCartLineItemId IS NULL AND OmsSavedCartId = @OmsSavedCartId AND ZOSCLI.Quantity IS NOT NULL
	    --AND EXISTS(SELECT * FROM ZnodeOmsSavedCartLineItem ZOSCLI WHERE OrderLineItemRelationshipTypeId=@BundleOrderLineItemRelationshipTypeId)

		UPDATE ZnodeOmsSavedCart
		SET ModifiedDate = GETDATE()
		WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
	SET @status = 1 
   
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION ReorderSaveCart
		SELECT ERROR_MESSAGE()
		SET @status = 0 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

UPDATE ZnodeApplicationSetting 
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsQuoteId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OmsQuoteId</name><headertext>Pending Order ID</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Account/UpdatePendingPaymentQuote</islinkactionurl><islinkparamfield>omsQuoteId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>Customer Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>StoreName</name><headertext>Store Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>OrderStatus</name><headertext>Pending Order Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>QuoteOrderTotal</name><headertext>Pending Order Amount</headertext><width>0</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>CreatedByName</name><headertext>Created By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>View|orders</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Convert to Order</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/UpdatePendingPaymentQuote</manageactionurl><manageparamfield>omsQuoteId,orderStatus</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>AccountId</name><headertext>Account Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName='ZnodeOmsPendingPayment'

UPDATE ZnodeApplicationSetting 
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsQuoteId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OmsQuoteId</name><headertext>Pending Order ID</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Account/UpdateAccountQuote</islinkactionurl><islinkparamfield>omsQuoteId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>Customer Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>AccountName</name><headertext>Account Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>StoreName</name><headertext>Store Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderStatus</name><headertext>Pending Order Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>QuoteOrderTotal</name><headertext>Pending Order Amount</headertext><width>0</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>CreatedByName</name><headertext>Created By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>PublishState</name><headertext>Publish Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>View|orders</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Convert to Order</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/UpdateAccountQuote|/Quote/ConvertToOrder</manageactionurl><manageparamfield>omsQuoteId,orderStatus|omsQuoteId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>AccountId</name><headertext>Account Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>14</id><name>IsConvertedToOrder</name><headertext></headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>d-none</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Is Converted To Order</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>IsConvertedToOrder</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
WHERE ItemName = 'ZnodeOmsQuote'

GO

UPDATE ZnodeSearchProfileAttributeMapping
SET IsNgramEnabled='true', ModifiedDate=GETDATE()
WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
	AND AttributeCode IN ('ProductName','Brand','SKU')

DECLARE @SearchProfileId INT= (SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile');
IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSearchProfileEntity WHERE SearchProfileId = @SearchProfileId)
BEGIN
	EXEC Znode_PublishSearchProfileEntity @SearchProfileId=@SearchProfileId, @UserId=2;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT)
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @GroupOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Group')
    DECLARE @versionId INT = (
    SELECT TOP 1 a.VersionId FROM  ZnodePublishVersionEntity a with(nolock) 
    INNER JOIN ZnodePortalCatalog b with(nolock) ON (b.PublishCatalogId = a.ZnodeCatalogId)
    INNER JOIN ZnodeOmsOrderDetails c with(nolock) ON (c.PortalId = b.PortalId)
    INNER JOIN ZnodeOmsOrder d ON (d.OmsOrderId = c.OmsOrderId) 
    WHERE c.OmsOrderId = @OmsOrderId AND a.LocaleId = dbo.Fn_GetDefaultLocaleId()  AND a.RevisionType = (SELECT TOP 1 PublishStateCode FROM ZnodePublishState t WHERE t.PublishStateId = d.PublishStateId ) ) 
 
   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 AND Exists(Select TOP 1 1 From ZnodePublishProductEntity ZPP With(NOLOCK) Where ZPP.SKU= ZOOLI.Sku AND ZPP.IsActive=1 AND ZPP.VersionId = @versionId)
  

		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND Exists(Select TOP 1 1 From ZnodePublishProductEntity ZPP With(NOLOCK) Where ZPP.SKU= ZOO.Sku AND ZPP.IsActive=1 AND ZPP.VersionId = @versionId)
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence = RowId

		DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
		DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
		INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


		DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

		DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
		AND TR.ParentOmsOrderLineItemsId IS NULL 

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON A.OmsOrderLineItemsId = B.ParentOmsOrderLineItemsId
		WHERE A.ParentOmsOrderLineItemsId IS NULL

		UPDATE B
		SET B.ParentRowID = A.ParentRowID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OrderLineItemRelationshipTypeID=B.OrderLineItemRelationshipTypeID)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OmsOrderLineItemsId=B.ParentOmsOrderLineItemsId AND B.OrderLineItemRelationshipTypeID IS NOT NULL)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL AND B.OrderLineItemRelationshipTypeID=@AddOnOrderLineItemRelationshipTypeId

	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence INTO @TBL_ZnodeOmsSavedCartLineItem 
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

		UPDATE ab 
		SET ab.ParentOmsSavedCartLineItemId = 
			(SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowID)
		FROM ZnodeOmsSavedCartLineItem ab 
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId) 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId) 

		INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		FROM ZnodeOmsPersonalizeItem  a 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId)

		UPDATE ZOSCLI1 set Quantity = null
		from ZnodeOmsSavedCartLineItem ZOSCLI1
		where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		and Quantity is not null
		and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId IN (@BundleOrderLineItemRelationshipTypeId,@GroupOrderLineItemRelationshipTypeId ) and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		--Update Qty for Parentlineitem except simple product
		UPDATE ZOSCLI
		SET Quantity = ZOSCLI.Quantity+Old.Quantity
		FROM ZnodeOmsSavedCartLineItem ZOSCLI
		INNER JOIN #ZnodeOmsSavedCartLineItemNew New ON (ZOSCLI.OmsSavedCartLineItemId = New.OmsSavedCartLineItemId)
		INNER JOIN #ZnodeOmsSavedCartLineItemOld Old ON (New.SKU = Old.SKU)
		WHERE ZOSCLI.ParentOmsSavedCartLineItemId IS NULL AND OmsSavedCartId = @OmsSavedCartId AND ZOSCLI.Quantity IS NOT NULL
	    --AND EXISTS(SELECT * FROM ZnodeOmsSavedCartLineItem ZOSCLI WHERE OrderLineItemRelationshipTypeId=@BundleOrderLineItemRelationshipTypeId)

		UPDATE ZnodeOmsSavedCart
		SET ModifiedDate = GETDATE()
		WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
	SET @status = 1 
   
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION ReorderSaveCart
		SELECT ERROR_MESSAGE()
		SET @status = 0 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeOmsOrderDiscount' AND COLUMN_NAME = 'DiscountCode')
BEGIN
    ALTER TABLE ZnodeOmsOrderDiscount ALTER COLUMN DiscountCode VARCHAR (MAX) NULL;
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeOmsQuoteOrderDiscount' AND COLUMN_NAME = 'DiscountCode')
BEGIN
    ALTER TABLE ZnodeOmsQuoteOrderDiscount ALTER COLUMN DiscountCode VARCHAR (MAX) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int, RemainingOrderAmount NUMERIC(28,6),AvataxIsSellerImporterOfRecord bit,
		AccountId INT
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(MAX),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId,RemainingOrderAmount,AvataxIsSellerImporterOfRecord
		,AccountId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		CASE WHEN Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) END AS RemainingOrderAmount,
		CASE WHEN Tbl.Col.value( 'AvataxIsSellerImporterOfRecord[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'AvataxIsSellerImporterOfRecord[1]', 'NVARCHAR(Max)' ) END AS AvataxIsSellerImporterOfRecord,
		Tbl.Col.value( 'AccountId[1]', 'NVARCHAR(Max)' ) AS AccountId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, CAST(0 AS BIT)
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount,AccountId
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,OD.RemainingOrderAmount,OD.AccountId
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty,OD.RemainingOrderAmount --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	
		UPDATE ZnodeOmsOrder set IsOldOrder = 0
		where OmsOrderId = @OmsOrderID
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId))
	BEGIN
		DECLARE @TaxRate Numeric(28,6), @TaxRuleId INT, @AvataxIsSellerImporterOfRecord bit
		SET @TaxRate = (SELECT TOP 1 TaxRate FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)
		SET @AvataxIsSellerImporterOfRecord = (SELECT TOP 1 AvataxIsSellerImporterOfRecord FROM #TempOrderData)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxRate, @AvataxIsSellerImporterOfRecord = @AvataxIsSellerImporterOfRecord, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT)
  DECLARE @GetDate DATETIME = dbo.FN_getDate() , @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId ()
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @GroupOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Group')
    DECLARE @versionId INT = (
    SELECT TOP 1 a.VersionId FROM  ZnodePublishVersionEntity a with(nolock) 
    INNER JOIN ZnodePortalCatalog b with(nolock) ON (b.PublishCatalogId = a.ZnodeCatalogId)
    INNER JOIN ZnodeOmsOrderDetails c with(nolock) ON (c.PortalId = b.PortalId)
    INNER JOIN ZnodeOmsOrder d with(nolock) ON (d.OmsOrderId = c.OmsOrderId AND (c.OmsOrderId = @OmsOrderId OR @OmsOrderId = 0  ) ) 
	INNER JOIN ZnodeOmsOrderLineItems f with(nolock) ON (f.OmsOrderDetailsId = c.OmsOrderDetailsId AND (f.OmsOrderLineItemsId = @OmsOrderLineItemsId OR @OmsOrderLineItemsId = 0 ) )
    WHERE a.LocaleId =@DefaultLocaleId
	AND a.RevisionType = (SELECT TOP 1 PublishStateCode FROM ZnodePublishState t WHERE t.PublishStateId = d.PublishStateId ) ) 

   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 AND Exists(Select TOP 1 1 From ZnodePublishProductEntity ZPP With(NOLOCK) Where ZPP.SKU= ZOOLI.Sku AND ZPP.IsActive=1 AND ZPP.VersionId = @versionId)
  

		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND Exists(Select TOP 1 1 From ZnodePublishProductEntity ZPP With(NOLOCK) Where ZPP.SKU= ZOO.Sku AND ZPP.IsActive=1 AND ZPP.VersionId = @versionId)
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence = RowId

		DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
		DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
		INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


		DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

		DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
		AND TR.ParentOmsOrderLineItemsId IS NULL 

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON A.OmsOrderLineItemsId = B.ParentOmsOrderLineItemsId
		WHERE A.ParentOmsOrderLineItemsId IS NULL

		UPDATE B
		SET B.ParentRowID = A.ParentRowID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OrderLineItemRelationshipTypeID=B.OrderLineItemRelationshipTypeID)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OmsOrderLineItemsId=B.ParentOmsOrderLineItemsId AND B.OrderLineItemRelationshipTypeID IS NOT NULL)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL AND B.OrderLineItemRelationshipTypeID=@AddOnOrderLineItemRelationshipTypeId

	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence INTO @TBL_ZnodeOmsSavedCartLineItem 
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

		UPDATE ab 
		SET ab.ParentOmsSavedCartLineItemId = 
			(SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowID)
		FROM ZnodeOmsSavedCartLineItem ab 
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId) 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId) 

		INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		FROM ZnodeOmsPersonalizeItem  a 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId)

		UPDATE ZOSCLI1 set Quantity = null
		from ZnodeOmsSavedCartLineItem ZOSCLI1
		where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		and Quantity is not null
		and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId IN (@BundleOrderLineItemRelationshipTypeId,@GroupOrderLineItemRelationshipTypeId ) and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		--Update Qty for Parentlineitem except simple product
		UPDATE ZOSCLI
		SET Quantity = ZOSCLI.Quantity+Old.Quantity
		FROM ZnodeOmsSavedCartLineItem ZOSCLI
		INNER JOIN #ZnodeOmsSavedCartLineItemNew New ON (ZOSCLI.OmsSavedCartLineItemId = New.OmsSavedCartLineItemId)
		INNER JOIN #ZnodeOmsSavedCartLineItemOld Old ON (New.SKU = Old.SKU)
		WHERE ZOSCLI.ParentOmsSavedCartLineItemId IS NULL AND OmsSavedCartId = @OmsSavedCartId AND ZOSCLI.Quantity IS NOT NULL
	    --AND EXISTS(SELECT * FROM ZnodeOmsSavedCartLineItem ZOSCLI WHERE OrderLineItemRelationshipTypeId=@BundleOrderLineItemRelationshipTypeId)

		UPDATE ZnodeOmsSavedCart
		SET ModifiedDate = GETDATE()
		WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
	SET @status = 1 
   
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION ReorderSaveCart
		SELECT ERROR_MESSAGE()
		SET @status = 0 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

UPDATE ZnodeSearchProfileAttributeMapping
SET IsNgramEnabled='true', ModifiedDate=GETDATE()
WHERE SearchProfileId=(SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile')
	AND AttributeCode IN ('ProductName','Brand','SKU')

DECLARE @SearchProfileId INT= (SELECT TOP 1 SearchProfileId FROM ZnodeSearchProfile WHERE ProfileName='ZnodeSearchProfile');

IF EXISTS (	SELECT * FROM ZnodePublishSearchProfileEntity 
			WHERE SearchProfileId = @SearchProfileId AND SearchProfileAttributeMappingJson NOT LIKE '%IsNgramEnabled%')
BEGIN
	DELETE FROM ZnodePublishSearchProfileEntity
	WHERE SearchProfileId = @SearchProfileId AND SearchProfileAttributeMappingJson NOT LIKE '%IsNgramEnabled%'
END

IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSearchProfileEntity WHERE SearchProfileId = @SearchProfileId)
BEGIN
	EXEC Znode_PublishSearchProfileEntity @SearchProfileId=@SearchProfileId, @UserId=2;
END

GO

update ZnodeEmailTemplateLocale set Content ='<!DOCTYPE html><html><body><div style="width: 100%; max-width: 650px; font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"><div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;">#StoreLogo# #SiteName# Customer Receipt</div><div style="padding: 10px;"><div style="font-family: Verdana; color: #333333; font-size: 11px; word-break: break-all;">#ReceiptText#</div><table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"><tbody><tr><td colspan="5"><hr></td></tr><tr><td colspan="2" align="left" nowrap="nowrap" width="25%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td><td colspan="2" align="left" nowrap="nowrap"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr><td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td align="left" width="30%">#OrderId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left">#CustomerServiceEmail#</td></tr><tr><td align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td align="left" nowrap="nowrap">#OrderDate#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr><td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td><td align="left">#PromotionCode#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td><td align="left" nowrap="nowrap">#PaymentName#</td><td></td><td></td></tr><tr><td align="left"><strong>#CardTransactionLabel#</strong></td><td align="left">#CardTransactionID#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap" style="padding-right: 10px;"><strong>#PurchaseNumberLabel#</strong></td><td align="left" nowrap="nowrap">#PONumber#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>AccountNumber:</strong></td><td align="left" nowrap="nowrap">#AccountNumber#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>ShippingMethod:</strong></td><td align="left" nowrap="nowrap">#ShippingName#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>Job / Project Name:</strong></td><td align="left" nowrap="nowrap">#JobName#</td><td></td><td></td></tr><tr><td colspan="4"><hr></td></tr><tr><td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div></td><td colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div></td></tr><tr><td colspan="2" align="Left">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr><td align="Left" nowrap="nowrap" colspan="2"></td><td valign="top" colspan="3"><hr><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#: </span>#InHandDate#<br><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingConstraintsCode#: </span>#ShippingConstraintCode#<br><br></td></tr><tr><td colspan="7"></td></tr></tbody></table><div data-info="#AddressItems#"><table width="100%" cellspacing="0" cellpadding="3"><tbody><tr><td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td></tr><tr><td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td></tr><tr style="background-color: #eff3fb;"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Total</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#<p>#ShortDescription#</p>#UOMDescription# <br><br>#Column1#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#ExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td></tr><tr data-info="#GrandAmountLineItems#"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td></tr><tr data-info="#TaxSummaryHead#"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right"><strong>#TaxName#</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%"><strong>#Rates#</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right"><strong>#Amount#</strong></td></tr><tr data-info="#TaxSummary#"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right">#TaxName#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%">#Rates#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right">#Amount#</td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2"><strong>#TotalCost#</strong></td></tr></tbody></table></div><table style="width: 100%; max-width: 650px; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3"><tbody><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div></td></tr><tr><td style="text-align: left; border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;">#AdditionalInstructions#</td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;"><div style="margin-bottom: 5px;"></div></td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; text-align: left;">#FeedBack#</td></tr></tbody></table></div></div></body></html>'
where EmailTemplateId = (select top 1 EmailTemplateId from ZnodeEmailTemplate where TemplateName='OrderReceipt')
and LocaleId=1

update ZnodeEmailTemplateLocale set Content='<!DOCTYPE html><html><body><div style="width: 100%; max-width: 650px; font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"><div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3; font-family: Verdana;">Return Order Acknowledgement</div><div style="padding: 10px;"><div style="font-family: Verdana; color: #333333; font-size: 11px;"><div>Dear #Username# #CustomerName#,</div><br style="color: #292a2a; font-family: Arial, Helvetica; font-size: 10px;"><div>We have received your&nbsp; <strong>Return Order #ReturnNumber#.</strong></div></div><table border="0" width="100%" cellspacing="3" cellpadding="0" style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;"><tbody><tr style="height: 13px;"><td colspan="5" style="height: 13px; width: 105%;"><hr></td></tr><tr style="height: 18px;"><td colspan="2" align="left" nowrap="nowrap" style="height: 18px; width: 44%;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Return&nbsp;Information</div></td><td colspan="2" align="left" nowrap="nowrap" style="height: 18px; width: 51%;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Order Number:</strong></td><td align="left" style="height: 13px; width: 29%;">#OrderNumber#</td><td align="left" nowrap="nowrap" style="height: 13px; width: 9%;"><strong style="font-family: Verdana, Helvetica, sans-serif; font-size: 10px;">Customer Name:</strong></td><td align="left" style="height: 13px; width: 42%;">#CustomerName#</td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Return Number:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#ReturnNumber#</td><td align="left" nowrap="nowrap" style="height: 13px; width: 9%;"><strong>E-Mail:</strong></td><td align="left" style="height: 13px; width: 42%;">#CustomerServiceEmail#</td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="vertical-align: top; height: 13px; width: 15%;"><strong>Return Status:</strong></td><td align="left" nowrap="nowrap" stylae="height: 13px; width: 29%;">#ReturnStatus#</td><td style="height: 13px; width: 9%;"><strong>Phone</strong>:</td><td style="height: 13px; width: 42%;">#CustomerServicePhoneNumber#</td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Return Date:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#ReturnDate#</td><td style="height: 13.5px; width: 9%;"><strong>Barcode:</strong></td><td><img style="height: 13.5px; width: 9%;" src="#ReturnBarcode#"></td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Total Expected Qty:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#ReturnTotalExpectedQty#</td><td style="height: 13px; width: 9%;"></td><td style="height: 13px; width: 42%;"></td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Return Total:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#TotalCost#</td><td style="height: 13px; width: 9%;"></td><td style="height: 13px; width: 42%;"></td></tr><tr style="height: 13px;"><td colspan="4" style="height: 13px; width: 95%;"><hr></td></tr><tr style="height: 18px;"><td colspan="2" align="left" nowrap="nowrap" style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 18px; width: 44%;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping To</div></td><td colspan="2" align="left" style="height: 18px;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping&nbsp;From</div></td></tr><tr style="height: 13px;"><td colspan="2" align="Left" style="height: 13px; word-break: break-word;">#ShippingTo#</td><td colspan="3" valign="top" style="height: 13px; word-break: break-word;">#ShippingFrom#</td></tr><tr style="height: 13px;"><td colspan="7" style="height: 13px; width: 125%;"></td></tr></tbody></table><div data-info="#AddressItems#"><table id="RturnedItemTable" width="100%" cellspacing="0" cellpadding="3"><tbody><tr><td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px; font-family: Verdana;" colspan="6">Returned Item</td></tr><tr><td style="color: black; font-size: 10px;" colspan="6">&nbsp;</td></tr><tr style="background-color: #eff3fb;"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Total</strong></td></tr><tr data-info="#ReturnLineItems#"><td style="word-break: break-all; border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#ReturnedSKU# &nbsp;</td><td style="word-break: break-all; border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedName#</td><td style="word-break: break-all; border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedDescription# &nbsp;<p>#ReturnedShortDescription#</p>#ReturnedUOMDescription#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#ReturnedQuantity#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#ReturnedPrice#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#ReturnedTitle#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedAmount#</td></tr><tr data-info="#ReturnedGrandAmountLineItems#"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#ReturnedTitle#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedAmount#</td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#TotalCost#</strong></td></tr></tbody></table></div><table cellspacing="0" cellpadding="3" style="width: 100%; padding: 10px; display: inline-block;"><tbody><tr style="height: 101.5px;"><td align="left" nowrap="nowrap" style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 101.5px; word-break: break-word;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"><span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;">Your request is in review. We will process your return/cancellation as soon as possible. <br><br>Please contact the customer service for any help required!&nbsp; </span> <br style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"><br style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"><span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;">Thanks and Regards,</span> <br style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"><span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"> <span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;">#StoreName# Support <br></span> </span><p data-renderer-start-pos="1373" style="margin: 1.143rem 0px 0px; padding: 0px; font-size: 14px; line-height: 1.714; letter-spacing: -0.005em; color: #172b4d; font-family: -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif; white-space: pre-wrap; background-color: #ebecf0;"></p></div></td></tr><tr style="height: 12px;"><td align="left" style="word-break: break-word; border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 12px;">#FeedBack#</td></tr></tbody></table></div></div></body></html>'
where EmailTemplateId = (select top 1 EmailTemplateId from ZnodeEmailTemplate where TemplateName = 'ReturnRequestNotificationForCustomer') 
and localeid = 1

GO

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html><body><div><div style="width:100%;max-width:650px; font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"><div style="background-color: #212529; color: #ffffff; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;"><div style="display: inline-block; vertical-align: middle;">#StoreLogo#&nbsp;</div><div style="display: inline-block; vertical-align: middle;">#SiteName# Cancelled Order&nbsp; Notification</div></div><div style="padding: 1em;"><div>Dear #BillingFirstName# #BillingLastName#,</div><br><div>We would like to inform you that your order has&nbsp;cancelled.</div></div><div style="padding: 10px;"><table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"><tbody><tr><td colspan="5"><hr></td></tr><tr><td colspan="2" align="left" nowrap="nowrap" width="25%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td><td colspan="2" align="left" nowrap="nowrap"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr><td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td align="left" width="30%">#OrderId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left" style="word-break:break-all;">#CustomerServiceEmail#</td></tr><tr><td align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td align="left" nowrap="nowrap">#OrderDate#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr><td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td><td align="left">#PromotionCode#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td><td align="left" nowrap="nowrap">#PaymentName#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td align="left" nowrap="nowrap"><strong>#PurchaseNumberLabel#</strong></td><td align="left" nowrap="nowrap">#PONumber#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td><td align="left" nowrap="nowrap">#CardTransactionID#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td colspan="4"><hr></td></tr><tr><td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div></td><td colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div></td></tr><tr><td colspan="2" align="Left" style="word-break:break-word;">#BillingAddress#</td><td colspan="3" valign="top" style="word-break:break-word;">#ShippingAddress#</td></tr><tr><td colspan="7">&nbsp;</td></tr></tbody></table><div data-info="#AddressItems#"><table width="100%" cellspacing="0" cellpadding="3"><tbody><tr style="background-color: #eff3fb;"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px; word-break:break-all" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px; word-break:break-all" align="left" width="10%">#SKU#&nbsp;</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td></tr></tbody></table></div></div><div style="background-color: #eff3fb; color: #292a2a; font-weight: bold; padding: .5em; border: solid 1px #c3c3c3; text-align: center; border-top: 0;"><div style="display: inline-block; vertical-align: middle; font-size: 15px; color: #292a2a;">Thank you</div></div></div></div></body></html>'
WHERE EmailTemplateId=(SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='CancelledOrderReceipt') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html><body><div style="width:100%;max-width:650px; border:1px solid #c3c3c3"><div style="background-color: #005286; font-size: 1.5em; font-weight: bold; padding-top: .5em; padding-bottom: .5em; padding-left: 1em; border-bottom: solid 1px #edffff; color: white;">#StoreLogo# Notification</div><div style="padding: 1em;"><div>&nbsp;</div><div>Team,</div><div>&nbsp;</div><div>A Concurrent order has resulted in negative inventory for some products.</div><div>&nbsp;</div><div>The details of the order and the negative inventory products are given below:</div></div><div><div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; margin-top: 10px;"><div style="padding: 10px;"><table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"><tbody><tr style="height: 12.3125px;"><td style="height: 12.3125px;" colspan="5"><hr></td></tr><tr style="height: 18px;"><td style="height: 18px;" colspan="2" align="left" nowrap="nowrap" width="25%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td></tr><tr style="height: 13px;"><td style="height: 13px;" align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td style="height: 13px; word-break:break-all;" align="left" width="30%">#OrderId#</td></tr><tr style="height: 13px;"><td style="height: 13px;" align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td style="height: 13px;" align="left" nowrap="nowrap">#OrderDate#</td></tr></tbody></table><div data-info="#AddressItems#"><table width="100%" cellspacing="0" cellpadding="3"><tbody><tr style="background-color: #eff3fb; height: 16px;"><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 16px; width: 10.0314%;"><strong>SKU</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 16px; width: 10%;" align="center"><strong>Qty</strong></td></tr><tr style="height: 81.3264px;" data-info="#LineItems#OmsOrderShipmentID##"><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 81.3264px; width: 10.0314%;" align="left">#SKU#&nbsp;</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 81.3264px; width: 10%;" align="center">#Quantity#</td></tr></tbody></table></div></div></div><p>&nbsp;</p><p>Please take a look at the details.</p><p>&nbsp;</p><p>Thank You,</p><p>Admin</p></div></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='LowInventoryOrderNotification') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html><body><div style="width:100%;max-width:650px; font-family: Arial,Helvetica; text-align: left; color: #000; border: solid 1px #000;"><div style="background-color: #005286; font-size: 1.5em; font-weight: bold; padding-top: .5em; padding-bottom: .5em; padding-left: 1em; border-bottom: solid 1px #edffff; color: #fff;">#StoreLogo# New Quote Request</div><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;">Dear Admin,</p><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;">A new Quote Request #QuoteId# is received.</p><div style="padding: 1rem;"><table style="font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"><tbody><tr><td colspan="5"><hr></td></tr><tr><td colspan="2" align="left" nowrap="nowrap" width="25%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Quote Information</div></td><td colspan="2" align="left" nowrap="nowrap"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr><td align="left" nowrap="nowrap" width="10%"><strong>Quote Number:</strong></td><td align="left" width="30%">#QuoteId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left" style="word-break: break-word;">#CustomerServiceEmail#</td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Status:</strong></td><td align="left">#QuoteStatus#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Date:</strong></td><td align="left" nowrap="nowrap">#QuoteDate#</td></tr><tr><td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Quote Expiration Date:</strong></td><td align="left" nowrap="nowrap">#ExpirationDate#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Total:</strong></td><td align="left" nowrap="nowrap">#TotalCost#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Created By:</strong></td><td align="left">#QuoteName#</td><td></td><td></td></tr><tr><td colspan="4"><hr></td></tr><tr><td style="font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div></td><td colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div></td></tr><tr><td colspan="2" align="Left" style="word-break:break-word;">#BillingAddress#</td><td colspan="3" valign="top" style="word-break:break-word;">#ShippingAddress#</td></tr><tr><td align="Left" nowrap="nowrap" colspan="2">&nbsp;</td><td valign="top" colspan="3" style="word-break:break-word;"><hr><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#:</span>#InHandDate#<br><span style="width: 130px; display: inline-block; font-weight: bold; word-break: break-word;">#LabelShippingConstraintsCode#:</span>#ShippingConstraintCode#<br><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingType#:</span>#ShippingName#</td></tr><tr><td colspan="7"></td></tr></tbody></table><br><div data-info="#AddressItems#"><table width="100%" cellspacing="0" cellpadding="3"><tbody><tr style="background-color: #eff3fb;"><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Total</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="word-break: break-word; border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#<p>#ShortDescription#</p>#UOMDescription#<br><br>#Column1#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="20%"><s>#InitialPrice#</s>#Price#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"><td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr data-info="#GrandAmountLineItems#"><td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr><td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Order Total</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#TotalCost#</strong></td></tr></tbody></table></div></div><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;"><span style="color: #333;">Please review the request for further processing.</span></p><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;">Thanks and Regards,<br>#StoreName# Support</p><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em;">&nbsp;</p></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='NewQuoteRequestNotificationForAdmin') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html><body><div style="width:100%;max-width:650px; border:1px solid #c3c3c3;"><div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3; font-family: Verdana;">New Return Order</div><div style="padding: 10px;"><div style="font-family: Verdana; color: #333333; font-size: 11px;"><div>Dear Admin,</div><br style="color: #292a2a; font-family: Arial, Helvetica; font-size: 10px;"><div>A new&nbsp; <strong>Return Order #ReturnNumber#</strong> is received.</div></div><table border="0" width="100%" cellspacing="3" cellpadding="0" style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;"><tbody><tr style="height: 13px;"><td colspan="5" style="height: 13px; width: 105%;"><hr></td></tr><tr style="height: 18px;"><td colspan="2" align="left" nowrap="nowrap" style="height: 18px; width: 44%;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Return&nbsp;Information</div></td><td colspan="2" align="left" nowrap="nowrap" style="height: 18px; width: 51%;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Order Number:</strong></td><td align="left" style="height: 13px; width: 29%;">#OrderNumber#</td><td align="left" nowrap="nowrap" style="height: 13px; width: 9%;"><strong style="font-family: Verdana, Helvetica, sans-serif; font-size: 10px;">Customer Name:</strong></td><td align="left" style="height: 13px; width: 42%;">#CustomerName#</td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Return Number:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#ReturnNumber#</td><td align="left" nowrap="nowrap" style="height: 13px; width: 9%;"><strong>E-Mail:</strong></td><td align="left" style="height: 13px; width: 42%;">#CustomerServiceEmail#</td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="vertical-align: top; height: 13px; width: 15%;"><strong>Return Status:</strong></td><td align="left" nowrap="nowrap" stylae="height: 13px; width: 29%;">#ReturnStatus#</td><td style="height: 13px; width: 9%;"><strong>Phone</strong>:</td><td style="height: 13px; width: 42%;">#CustomerServicePhoneNumber#</td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Return Date:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#ReturnDate#</td><td style="height: 13.5px; width: 9%;"><strong>Barcode:</strong></td><td style="height: 13.5px; width: 42%;"><img src="#ReturnBarcode#"></td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Total Expected Qty:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#ReturnTotalExpectedQty#</td><td style="height: 13px; width: 9%;"></td><td style="height: 13px; width: 42%;"></td></tr><tr style="height: 13px;"><td align="left" nowrap="nowrap" style="height: 13px; width: 15%;"><strong>Return Total:</strong></td><td align="left" nowrap="nowrap" style="height: 13px; width: 29%;">#TotalCost#</td><td style="height: 13px; width: 9%;"></td><td style="height: 13px; width: 42%;"></td></tr><tr style="height: 13px;"><td colspan="4" style="height: 13px; width: 95%;"><hr></td></tr><tr style="height: 18px;"><td colspan="2" align="left" nowrap="nowrap" style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 18px; width: 44%;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping To</div></td><td colspan="2" align="left" style="height: 18px; width: 51%;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping&nbsp;From</div></td></tr><tr style="height: 13px;"><td colspan="2" align="Left" nowrap="nowrap" style="height: 13px; width: 44%;">#ShippingTo#</td><td colspan="3" valign="top" style="height: 13px; width: 61%;">#ShippingFrom#</td></tr><tr style="height: 13px;"><td colspan="7" style="height: 13px; width: 125%;"></td></tr></tbody></table><div data-info="#AddressItems#"><table id="RturnedItemTable" width="100%" cellspacing="0" cellpadding="3"><tbody><tr><td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px; font-family: Verdana;" colspan="6">Returned Item</td></tr><tr><td style="color: black; font-size: 10px;" colspan="6">&nbsp;</td></tr><tr style="background-color: #eff3fb;"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Total</strong></td></tr><tr data-info="#ReturnLineItems#" style="word-break: break-word;"><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#ReturnedSKU#&nbsp;</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedName#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedDescription#&nbsp;<p>#ReturnedShortDescription#</p>#ReturnedUOMDescription#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#ReturnedQuantity#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#ReturnedPrice#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedExtendedPrice#</td></tr><tr data-info="#ReturnedGrandAmountLineItems#"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#ReturnedTitle#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedAmount#</td></tr><tr><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Return Total</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#TotalCost#</strong></td></tr></tbody></table></div><table cellspacing="0" cellpadding="3" style="width: 100%; padding: 10px; display: inline-block;"><tbody><tr style="height: 101.5px;"><td colspan="2" align="left" nowrap="nowrap" style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; width: 20%; height: 101.5px;"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"><span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;">Please review the request for further processing. </span> <br style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"><br style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"><span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;">Thanks and Regards,</span> <br style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"><span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;"> <span style="color: #333333; font-family: Verdana; font-weight: 400; white-space: normal;">#StoreName# Support <br></span> </span><p data-renderer-start-pos="1373" style="margin: 1.143rem 0px 0px; padding: 0px; font-size: 14px; line-height: 1.714; letter-spacing: -0.005em; color: #172b4d; font-family: -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif; white-space: pre-wrap; background-color: #ebecf0;"></p></div></td></tr><tr style="height: 12px;"><td colspan="2" align="left" nowrap="nowrap" style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; width: 20%; height: 12px;">#FeedBack#</td></tr></tbody></table></div></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='NewReturnOrderNotificationForAdmin') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html><body><p>&nbsp;</p><div style="width:100%;max-width:650px; font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"><div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;">#StoreLogo# #SiteName#&nbsp;Customer Receipt</div><div style="padding: 10px;"><div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div><table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"><tbody style="word-break: break-all;"><tr><td colspan="5"><hr></td></tr><tr><td colspan="2" align="left" nowrap="nowrap" width="25%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td><td colspan="2" align="left" nowrap="nowrap"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr><td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td align="left" width="30%">#OrderId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left">#CustomerServiceEmail#</td></tr><tr><td align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td align="left" nowrap="nowrap">#OrderDate#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr><td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td><td align="left">#PromotionCode#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td><td align="left" nowrap="nowrap">#PaymentName#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td><td align="left" nowrap="nowrap">#CardTransactionID#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td align="left" nowrap="nowrap"><strong>#PurchaseNumberLabel#</strong></td><td align="left" nowrap="nowrap">#PONumber#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td colspan="4"><hr></td></tr><tr><td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div></td><td colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div></td></tr><tr><td colspan="2" align="Left">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr><td colspan="7">&nbsp;</td></tr></tbody></table><div data-info="#AddressItems#"><table width="100%" cellspacing="0" cellpadding="3"><tbody style="word-break: break-all;"><tr style="height: 13px;"><td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px; height: 13px; width: 105%;" colspan="6">#ShipmentNo#</td></tr><tr style="height: 12px;"><td style="color: black; font-size: 10px; height: 12px; width: 105%;" colspan="6">#ShipTo#</td></tr><tr style="background-color: #eff3fb; height: 18px;"><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 18px; width: 10%;"><strong>SKU</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 18px; width: 25%;"><strong>Item</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 18px; width: 25%;"><strong>Description</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 18px; width: 5%;" align="center"><strong>Qty</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 18px; width: 20%;"><strong>Price</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 18px; width: 20%;"><strong>Total</strong></td></tr><tr style="height: 80px;" data-info="#LineItems#OmsOrderShipmentID##"><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 80px; width: 10%;" align="left">#SKU#&nbsp;</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 80px; width: 25%;" align="left">#Name#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 80px; width: 25%;" align="left">#Description#&nbsp;<p>#ShortDescription#</p>#UOMDescription#<br><br>#Column1#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 80px; width: 5%;" align="center">#Quantity#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 80px; width: 20%;" align="left">#Price#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0px 5px; height: 80px; width: 20%;" align="right">#ExtendedPrice#</td></tr><tr style="height: 12px;" data-info="#AmountLineItems#OmsOrderShipmentID##"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 12px; width: 85%;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0px 5px; height: 12px; width: 20%;" align="right">#Amount#</td></tr><tr style="height: 12px;" data-info="#GrandAmountLineItems#"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0px 5px; height: 12px; width: 85%;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0px 5px; height: 12px; width: 20%;" align="right">#Amount#</td></tr><tr style="height: 16px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0px 5px 5px; height: 16px; width: 85%;" colspan="5" align="right"><strong>Total</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0px 5px; height: 16px; width: 20%;" align="right"><strong>#TotalCost#</strong></td></tr></tbody></table></div><table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3"><tbody style="word-break: break-all;"><tr style="height: 18px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 18px;" colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div></td></tr><tr style="height: 12px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 12px;" colspan="2"><div align="justify">#AdditionalInstructions#</div></td></tr><tr style="height: 17px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 17px;" colspan="2"><div style="margin-bottom: 5px;">&nbsp;</div></td></tr><tr style="height: 12px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 12px;" colspan="2" align="left">#FeedBack#</td></tr></tbody></table></div></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='OrderPlacedNotification') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html><body><div style="width:100%;max-width:650px; font-family: Arial,Helvetica; text-align: left; color: #000; border: solid 1px #000;"><div style="background-color: #005286; font-size: 1.3em; font-weight: bold; padding-top: .5em; padding-bottom: .5em; padding-left: 1em; border-bottom: solid 1px #edffff; color: #fff;">#StoreLogo# Quote Converted To Order Acknowledgement</div><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;" segoe="" ui="" roboto="" oxygen="" ubuntu="" fira="" sans="" droid="" helvetica="" neue="" sans-serif="" white-space:="" pre-wrap="">Dear #UserName#,</p><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;" segoe="" ui="" roboto="" oxygen="" ubuntu="" fira="" sans="" droid="" helvetica="" neue="" sans-serif="" white-space:="" pre-wrap="">Your Quote Request #QuoteId# is Approved. An Order #OrderNo# is placed successfully for your request with Order No. #OrderNo#. Here are the Quote details:</p><div style="padding: 1rem;"><table style="font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"><tbody style="word-break: break-word"><tr><td colspan="5"><hr></td></tr><tr><td colspan="2" align="left" nowrap="nowrap" width="25%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Quote Information</div></td><td colspan="2" align="left" nowrap="nowrap"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr><td align="left" nowrap="nowrap" width="10%"><strong>Quote Number:</strong></td><td align="left" width="30%">#QuoteId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left">#CustomerServiceEmail#</td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Status:</strong></td><td align="left" nowrap="nowrap">#QuoteStatus#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr><td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Quote Date:</strong></td><td align="left" nowrap="nowrap">#QuoteDate#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Expiration Date:</strong></td><td align="left" nowrap="nowrap">#ExpirationDate#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Total:</strong></td><td align="left" nowrap="nowrap">#TotalCost#</td><td></td><td></td></tr><tr><td align="left" nowrap="nowrap"><strong>Quote Created By:</strong></td><td align="left" nowrap="nowrap">#QuoteName#</td><td></td><td></td></tr><tr><td colspan="4"><hr></td></tr><tr><td style="font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div></td><td colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div></td></tr><tr><td colspan="2" align="Left">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr><td align="Left" nowrap="nowrap" colspan="2">&nbsp;</td><td valign="top" colspan="3"><hr><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#:</span>#InHandDate#<br><span style="width: 130px; display: inline-block; font-weight: bold; word-break: break-word;">#LabelShippingConstraintsCode#:</span>#ShippingConstraintCode#<br><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingType#:</span>#ShippingName#<br><br></td></tr><tr><td colspan="7"></td></tr></tbody></table><br><div data-info="#AddressItems#"><table width="100%" cellspacing="0" cellpadding="3"><tbody style="word-break: break-word;"><tr style="background-color: #eff3fb;"><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"><strong>Total</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#<p>#ShortDescription#</p>#UOMDescription#<br><br>#Column1#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="20%"><s>#InitialPrice#</s>#Price#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"><td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr data-info="#GrandAmountLineItems#"><td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr><td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Order Total</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#TotalCost#</strong></td></tr></tbody></table></div></div><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;" segoe="" ui="" roboto="" oxygen="" ubuntu="" fira="" sans="" droid="" helvetica="" neue="" sans-serif="" white-space:="" pre-wrap=""><span style="color: #333;" helvetica="" neue="" arial="" sans-serif="" letter-spacing:="" normal="" white-space:="">Please login to your account for more information.</span></p><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;" segoe="" ui="" roboto="" oxygen="" ubuntu="" fira="" sans="" droid="" helvetica="" neue="" sans-serif="" white-space:="" pre-wrap=""><span style="color: #333;" helvetica="" neue="" arial="" sans-serif="" letter-spacing:="" normal="" white-space:="">Please contact the customer service for any help required!</span></p><p style="padding: 0 1rem; margin: 10px 0 10px; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;" segoe="" ui="" roboto="" oxygen="" ubuntu="" fira="" sans="" droid="" helvetica="" neue="" sans-serif="" white-space:="" pre-wrap="">Thanks and Regards,<br>#StoreName# Support</p></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='QuoteConvertedToOrderNotificationForCustomer') 
AND localeid=1

GO

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html lang="en"><body><div style="width:100%;max-width:650px; font-family: Arial,Helvetica; text-align: left; color: #000; border: solid 1px #000;"> <div style="background-color: #005286; font-size: 1.5em; font-weight: bold; padding-top: .5em; padding-bottom: .5em; padding-left: 1em; border-bottom: solid 1px #edffff; color: #fff;"> #StoreLogo# Quote Request Acknowledgement</div><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;"> Dear #UserName#,</p><p style="padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em;">We have received your Quote Request #QuoteId#.&nbsp;</p><div style="padding: 1rem;"> <table style="font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"> <tbody style="word-break: break-word"> <tr> <td colspan="5"> <hr> </td></tr><tr> <td colspan="2" align="left" nowrap="nowrap" width="25%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Quote Information</div></td><td colspan="2" align="left" nowrap="nowrap"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div></td></tr><tr> <td align="left" nowrap="nowrap" width="10%"><strong>Quote Number:</strong></td><td align="left" width="30%">#QuoteId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left">#CustomerServiceEmail#</td></tr><tr> <td align="left" nowrap="nowrap"><strong>Quote Status:</strong></td><td align="left" nowrap="nowrap">#QuoteStatus#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr> <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Quote Date:</strong></td><td align="left" nowrap="nowrap">#QuoteDate#</td><td></td><td></td></tr><tr> <td align="left" nowrap="nowrap"><strong>Quote Expiration Date:</strong></td><td align="left" nowrap="nowrap">#ExpirationDate#</td><td></td><td></td></tr><tr> <td align="left" nowrap="nowrap"><strong>Quote Total:</strong></td><td align="left" nowrap="nowrap">#TotalCost#</td><td></td><td></td></tr><tr> <td align="left" nowrap="nowrap"><strong>Quote Created By:</strong></td><td align="left" nowrap="nowrap">#QuoteName#</td><td></td><td></td></tr><tr> <td colspan="4"> <hr> </td></tr><tr> <td style="font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div></td><td colspan="2" align="left"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div></td></tr><tr> <td colspan="2" align="Left">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr> <td align="Left" nowrap="nowrap" colspan="2">&nbsp;</td><td valign="top" colspan="3"> <hr><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#:</span>#InHandDate#<br><span style="width: 130px; display: inline-block; font-weight: bold; word-break: break-word;">#LabelShippingConstraintsCode#:</span>#ShippingConstraintCode#<br><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingType#:</span>#ShippingName#<br><br></td></tr><tr> <td colspan="7"></td></tr></tbody> </table> <br><div data-info="#AddressItems#"> <table width="100%" cellspacing="0" cellpadding="3"> <tbody> <tr style="background-color: #eff3fb;"> <td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"> <strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"> <strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"> <strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"> <strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;"> <strong>Total</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"> <td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description# <p>#ShortDescription#</p>#UOMDescription#<br><br>#Column1# </td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" align="left" width="20%"><s>#InitialPrice#</s>#Price#</td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"> <td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr data-info="#GrandAmountLineItems#"> <td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#Amount#</td></tr><tr> <td style="border: none; font-family: Verdana,Helvetica,sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Order Total</strong></td><td style="border: silver 1px solid; font-family: Verdana,Helvetica,sans-serif; color: #333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#TotalCost#</strong></td></tr></tbody> </table> </div></div><p style="text-align:left; padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em;">Your request is in review. We will share a Quotation with you shortly.</p><p style="text-align:left; padding: 0 1rem; margin: 10px 0 0; font-size: 14px; line-height: 1.714; letter-spacing: -.005em;">Please contact the customer service for any help required!</p><p>&nbsp;</p><p style="padding: 0 1rem; margin: 10px 0 10px; font-size: 14px; line-height: 1.714; letter-spacing: -.005em; color: #172b4d; font-family: -apple-system,BlinkMacSystemFont,;"> Thanks and Regards,<br>#StoreName# Support</p></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='QuoteRequestAcknowledgementNotificationForCustomer') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html lang="en"><body> <div style="width:100%;max-width:650px; font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"> <div>#StoreLogo# #SiteName#&nbsp;Customer Receipt</div><div style="padding: 10px;"> <div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div><table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"> <tbody> <tr> <td colspan="5"> <hr> </td></tr><tr> <td colspan="2" align="left" nowrap="nowrap" width="25%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td><td colspan="2" align="left" nowrap="nowrap"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Customer Service</div></td></tr><tr> <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td align="left" width="30%">#OrderId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left">#CustomerServiceEmail#</td></tr><tr> <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td align="left" nowrap="nowrap">#OrderDate#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr> <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong> </td><td align="left" nowrap="nowrap">#PromotionCode#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td><td align="left" nowrap="nowrap">#PaymentName#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td><td align="left" nowrap="nowrap">#CardTransactionID#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td align="left"><strong>#PurchaseNumberLabel#</strong></td><td align="left">#PONumber#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td colspan="4"> <hr> </td></tr><tr> <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Billing Address</div></td><td colspan="2" align="left"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Shipping Address</div></td></tr><tr> <td colspan="2" align="Left">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr> <td colspan="7">&nbsp;</td></tr></tbody> </table> <div data-info="#AddressItems#"> <table width="100%" cellspacing="0" cellpadding="3"> <tbody style="word-break: break-word"> <tr> <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">Order Receipt</td></tr><tr> <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td></tr><tr> <td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td></tr><tr style="background-color: #eff3fb;"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Total</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#&nbsp;</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#&nbsp; <p>#ShortDescription#</p>#UOMDescription#<br><br>#Column1# </td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#ExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" colspan="2" align="right" width="20%">#Amount#</td></tr><tr data-info="#GrandAmountLineItems#"> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" colspan="2" width="20%">#Amount#</td></tr><tr data-info="#TaxSummaryHead#"> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right"><strong>#TaxName#</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%"><strong>#Rates#</strong></td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right"><strong>#Amount#</strong></td></tr><tr data-info="#TaxSummary#"> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right">#TaxName#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%">#Rates#</td><td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right">#Amount#</td></tr><tr> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2"><strong>#TotalCost#</strong></td></tr></tbody> </table> <table id="RturnedItemTable" width="100%" cellspacing="0" cellpadding="3"> <tbody style="word-break: break-word"> <tr> <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">Returned Item</td></tr><tr> <td style="color: black; font-size: 10px;" colspan="6">&nbsp;</td></tr><tr style="background-color: #eff3fb;"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Total</strong></td></tr><tr data-info="#ReturnLineItems#"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#ReturnedSKU#&nbsp;</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedName#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#ReturnedDescription#&nbsp; <p>#ReturnedShortDescription#</p>#ReturnedUOMDescription# </td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#ReturnedQuantity#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#ReturnedPrice#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedExtendedPrice#</td></tr><tr data-info="#AmountLineItems#OmsOrderShipmentID##"> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#ReturnedTitle#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedAmount#</td></tr><tr data-info="#ReturnedGrandAmountLineItems#"> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#ReturnedTitle#</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ReturnedAmount#</td></tr><tr> <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%"><strong>#ReturnedTotalCost#</strong></td></tr></tbody> </table> </div><table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3"><tbody style="word-break: break-all;"><tr style="height: 18px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 18px;" colspan="2" align="left"><div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div></td></tr><tr style="height: 12px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 12px;" colspan="2"><div align="justify">#AdditionalInstructions#</div></td></tr><tr style="height: 17px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 17px;" colspan="2"><div style="margin-bottom: 5px;">&nbsp;</div></td></tr><tr style="height: 12px;"><td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; height: 12px;" colspan="2" align="left">#FeedBack#</td></tr></tbody></table> </div></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='ResendOrderReceipt') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html lang="en"><body> <div> <div style="width:100%;max-width:650px; font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"> <div style="background-color: #212529; color: #ffffff; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;"> <div style="display: inline-block; vertical-align: middle;">#StoreLogo#&nbsp;</div><div style="display: inline-block; vertical-align: middle;">#SiteName#&nbsp;Shipping Notification</div></div><div style="padding: 1em;"> <div>Dear #BillingFirstName# #BillingLastName#,</div><br><div>#Message#</div><br><div>#TrackingMessage##Custom1#</div></div><div style="padding: 10px;"> <table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"> <tbody> <tr> <td colspan="5"> <hr> </td></tr><tr> <td colspan="2" align="left" nowrap="nowrap" width="25%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td><td colspan="2" align="left" nowrap="nowrap"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Customer Service</div></td></tr><tr> <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td align="left" width="30%">#OrderId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left">#CustomerServiceEmail#</td></tr><tr> <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td align="left" nowrap="nowrap">#OrderDate#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr> <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong> </td><td align="left" nowrap="nowrap">#PromotionCode#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td><td align="left" nowrap="nowrap">#PaymentName#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td align="left" nowrap="nowrap"><strong>#PurchaseNumberLabel#</strong></td><td align="left" nowrap="nowrap">#PONumber#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td><td align="left" nowrap="nowrap">#CardTransactionID#</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr> <td colspan="4"> <hr> </td></tr><tr> <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Billing Address</div></td><td colspan="2" align="left"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Shipping Address</div></td></tr><tr> <td colspan="2" align="Left">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr> <td colspan="7">&nbsp;</td></tr></tbody> </table> <div data-info="#AddressItems#"> <table width="100%" cellspacing="0" cellpadding="3"> <tbody> <tr style="background-color: #eff3fb;"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#&nbsp;</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td></tr><tr style="background-color: #eff3fb;"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Shipped By</strong></td><td style="text-align: center; border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Tracking Number</strong></td></tr><tr> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px; word-break: break-word" align="left" width="25%" >#ShippingName#</td><td style="word-break: break-word; text-align: center; border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2" align="left" width="10%">#TrackingNumber#</td></tr></tbody> </table> </div></div><div style="background-color: #212529; color: #ffffff; font-weight: bold; padding: .5em; border: solid 1px #c3c3c3; text-align: center; border-top: 0;"> <div style="display: inline-block; vertical-align: middle; font-size: 15px;">Thank you</div></div></div></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='ShippingReceipt') 
AND localeid=1

UPDATE ZnodeEmailTemplateLocale SET Content='<!DOCTYPE html><html lang="en"><body> <div style="width:100%;max-width:650px; font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;"> <div style="background-color: #212529; color: #ffffff; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;"> #StoreLogo# Vendor Purchased Product Receipt</div><div style="padding: 10px;"> <div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div><table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0"> <tbody> <tr> <td colspan="5"> <hr> </td></tr><tr> <td colspan="2" align="left" nowrap="nowrap" width="25%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div></td><td colspan="2" align="left" nowrap="nowrap"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Customer Service</div></td></tr><tr> <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td><td align="left" width="30%">#OrderId#</td><td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td><td align="left">#CustomerServiceEmail#</td></tr><tr> <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td><td align="left" nowrap="nowrap">#OrderDate#</td><td align="left" nowrap="nowrap"><strong>Phone:</strong></td><td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td></tr><tr> <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td><td align="left" nowrap="nowrap">#PaymentName#</td><td align="left" nowrap="nowrap">&nbsp;</td><td align="left" nowrap="nowrap">&nbsp;</td></tr><tr> <td colspan="4"> <hr> </td></tr><tr> <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Billing Address</div></td><td colspan="2" align="left"> <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;"> Shipping Address</div></td></tr><tr> <td colspan="2" align="Left">#BillingAddress#</td><td colspan="3" valign="top">#ShippingAddress#</td></tr><tr> <td colspan="7">&nbsp;</td></tr></tbody> </table> <div style="padding-right: 5px;" data-info="#AddressItems#"> <div> <table width="100%" cellspacing="0" cellpadding="3"> <tbody style="word-break: break-word;"> <tr> <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px; word-break: break-word;" colspan="6">#ShipmentNo#</td></tr><tr> <td style="word-break: break-word; color: black; font-size: 10px;" colspan="6">#ShipTo#</td></tr><tr style="background-color: #eff3fb;"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>SKU</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Item</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Description</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Price</strong></td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"> <strong>Total</strong></td></tr><tr data-info="#LineItems#OmsOrderShipmentID##"> <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#&nbsp;</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#&nbsp; <p>#ShortDescription#</p>#UOMDescription# </td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td><td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%">#ExtendedPrice#</td></tr></tbody> </table> </div></div></div></div></body></html>'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='VendorReceipt') 
AND localeid=1

GO

UPDATE ZnodeApplicationSetting 
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsTemplateId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>TemplateName</name><headertext>Template Name</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/EditTemplate</islinkactionurl><islinkparamfield>omsTemplateId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>omsTemplateId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Items</name><headertext>Quantity</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>CreatedDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ModifiedDate</name><headertext>Modified Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Orders|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Move to Cart|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/EditTemplate|/User/AddTemplateToCart|/User/DeleteTemplate</manageactionurl><manageparamfield>omsTemplateId|omsTemplateId|omsTemplateId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeOmsTemplate'

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePublishCatalogEntity')
	DROP PROC Znode_DeletePublishCatalogEntity
GO

CREATE PROCEDURE [dbo].[Znode_DeletePublishCatalogEntity]
(
    @PublishCatalogId  INT = 0 
   ,@UserId int = 0
   ,@IsRevertPublish bit = 0 
   ,@NewGUID nvarchar(500) 

)
AS
/*
	To Remove all publish catalog details from related entities
	Unit Testing : 
	Declare @Status bit 
	Exec [dbo].[ZnodePublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 
*/
BEGIN
SET NOCOUNT ON
BEGIN TRY 
Begin Transaction 
--SET NOCOUNT ON
		Declare @Status Bit =0, @IsPreviewEnable  int,  @Batch INT;
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		
		Create Table #Tbl_VersionEntity(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntity (PublishCatalogId , VersionId , LocaleId , PublishType )
			select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
			

		IF object_id('tempdb..[#Tbl_VersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntityforCatalog
		
		Create Table #Tbl_VersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50))
		Insert into #Tbl_VersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType )
		select ZnodeCatalogId , VersionId , LocaleId , RevisionType  from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		

		IF object_id('tempdb..[#Tbl_OldVersionEntityforCatalog]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntityforCatalog
		
		Create Table #Tbl_OldVersionEntityforCatalog(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforCatalog(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		 

		IF object_id('tempdb..[#Tbl_OldVersionEntityforDeletion]') IS NOT NULL
		drop table tempdb..#Tbl_OldVersionEntityforDeletion

		Create Table #Tbl_OldVersionEntityforDeletion(PublishCatalogId int , VersionId int , LocaleId int , PublishType varchar(50),IsPublishSuccess bit )
		Insert into #Tbl_OldVersionEntityforDeletion(PublishCatalogId , VersionId , LocaleId , PublishType ,IsPublishSuccess)
		select ZnodeCatalogId , VersionId , LocaleId, RevisionType  ,IsPublishSuccess from ZnodePublishVersionEntity   where ZnodeCatalogId = @PublishCatalogId 
		 and RevisionType  in 
		(Select distinct PublishType from #Tbl_VersionEntity where ZnodeCatalogId = #Tbl_VersionEntity.PublishCatalogId  )

		If @IsRevertPublish = 0 AND @PublishCatalogId > 0 AND Exists (Select Top 1 1 from #Tbl_VersionEntity ) 
		Begin 
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =90, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			Delete  From ZnodePublishCatalogEntity Where  VersionId NOT IN  (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId  
				AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where ElasticSearchEvent = 2
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END

			Delete  From ZnodePublishAddOnEntity Where  ElasticSearchEvent = 2 

			
			Delete  From ZnodePublishCategoryEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishBundleProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishGroupProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishConfigurableProductEntity Where ElasticSearchEvent = 2

			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) 
			and ElasticSearchEvent = 2

			--Delete  From ZnodePublishVersionEntity Where  VersionId NOT IN (Select VersionId from #Tbl_VersionEntity) AND ZnodeCatalogId = @PublishCatalogId 
			--AND VersionId IN  (SELECT VersionId from #Tbl_OldVersionEntityforDeletion) 

			Update ZnodePublishVersionEntity  SET IsPublishSuccess= 1 where 
			 ZnodeCatalogId  = @PublishCatalogId   

						
			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPublish(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select max(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())

			Update a SET IsCatalogPublished =1,  PublishStateId = DBO.Fn_GetPublishStateIdForPreview(), ModifiedDate = Getdate()  
			from ZnodePublishCatalogLog a
			where  PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
			and PublishCatalogLogId = (select min(PublishCatalogLogId) from ZnodePublishCatalogLog b where a.PimCatalogId = b.PimCatalogId and a.LocaleId = b.LocaleId and b.PublishStateId = DBO.Fn_GetPublishStateIdForProcessing())


			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PublishCatalogId,'catalog','catalog has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from #Tbl_OldVersionEntityforCatalog where LocaleId = A.LocaleId AND PublishType = A.PublishType
				AND  PublishCatalogId = A.PublishCatalogId  ),
				A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =0
			where  JobId = @NewGUID

			--UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()  
			--WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId AND ZPP.PublishCatalogId = @PublishCatalogId)

			--UPDATE ZnodePublishCatalogLog 
			--SET IsProductPublished = 1 
			--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL) 
			--WHERE EXISTS (SELECT TOP 1 1 FROM #Tbl_VersionEntity TY  WHERE  TY.VersionId =ZnodePublishCatalogLog.PublishCatalogLogId )  

		End
		Else If @IsRevertPublish = 1 AND @PublishCatalogId > 0 
		Begin 
			
			Delete  From ZnodePublishCatalogEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			SET @Batch= 1;
			WHILE @Batch > 0
			BEGIN 
				Delete  TOP (10000) From ZnodePublishProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
				SET @Batch= @@ROWCOUNT;
				-- CHECKPOINT;    -- if simple
				-- BACKUP LOG ... -- if full
			END
			Delete  From ZnodePublishAddOnEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishBundleProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishGroupProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishConfigurableProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 
			Delete  From ZnodePublishSEOEntity Where CMSSEOTypeId in (1,2,4) and  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) 
			--AND PortalId in 
			--	(Select ZPC.PortalId  from ZnodePublishVersionEntity  ZPVE inner join ZnodePortalCatalog  
			--		ZPC ON ZPVE.ZnodeCatalogId = ZPC.PublishCatalogId where  (ZPC.PublishCatalogId = @PublishCatalogId ))

			Delete  From ZnodePublishVersionEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntityforCatalog) AND ZnodeCatalogId = @PublishCatalogId 

			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Elastic-index genration get failed : ', '' , 'Fail' , Getdate(), 
			@UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished = 0  , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =100, 
			IsCompleted  = 1,
			IsFailed =1
			where  JobId = @NewGUID

		END 
		Else If @IsRevertPublish = 1 AND Isnull(@PublishCatalogId,0) = 0 
		Begin 
			INSERT INTO ZnodePublishCatalogErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'Publish failed, Check connection failure ', '' , 'Fail' , Getdate(), @UserId , '' 
			
			Update ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,
			IsCatalogPublished =0, IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()
			where PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
						
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =80, 
			IsCompleted  = 0,
			IsFailed =1
			where  JobId = @NewGUID

		end

		-- Added to call nested sp if PublishCatalogId found.
		IF EXISTS (	SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCSP
					INNER JOIN ZnodeSearchProfile SP ON PCSP.SearchProfileId=SP.SearchProfileId
					WHERE PCSP.PublishCatalogId=@PublishCatalogId) AND @IsRevertPublish=1
		BEGIN
			EXEC dbo.Znode_UpdateSearchProfileStateOnIndexCreationFailure @PublishCatalogId=@PublishCatalogId, @UserId=@UserId
		END

		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogSearchProfile PCSP
						INNER JOIN ZnodeSearchProfile SP ON PCSP.SearchProfileId=SP.SearchProfileId
						WHERE PCSP.PublishCatalogId=@PublishCatalogId) AND @IsRevertPublish=0
		BEGIN
			DECLARE @PublishStateId TINYINT;
			SET @PublishStateId=(SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName='Publish');

			UPDATE SP
			SET SP.PublishStateId=@PublishStateId, SP.ModifiedBy=@UserId, SP.ModifiedDate=GETDATE()
			FROM ZnodePublishCatalogSearchProfile PCSP
			INNER JOIN ZnodeSearchProfile SP ON PCSP.SearchProfileId=SP.SearchProfileId
			WHERE PCSP.PublishCatalogId=@PublishCatalogId;
		END
		SET @Status = 1
		Commit Transaction 
		SELECT @PublishCatalogId AS id,@Status AS Status;   
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePublishCatalogEntity 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@IsRevertPublish='+CAST(@IsRevertPublish AS VARCHAR(10))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeletePublishCatalogEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO


CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 3  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	DECLARE @Status Bit =0 , @PublishCatalogId INT=0  
	IF (@PimCatalogId=0)  
	BEGIN  
	--SET @Status =0  
		SELECT 0 AS ID,@Status AS Status;  
		SET @PublishCatalogId=0  
		SELECT @PublishCatalogId;  
	END  
	ELSE  
	BEGIN  
   
		DECLARE @Type VARCHAR(50) = '', @CMSSEOCode VARCHAR(300);  
		SET @Status = 1   
		DECLARE @IsPreviewEnable INT  
		,@PreviewVersionId INT = 0    
		,@ProductionVersionId INT = 0  
		,@CatalogProfileId VARCHAR(1000)  
   
		IF OBJECT_ID('tempdb..#CatalogAttributeDetails') IS NOT NULL  
		DROP TABLE #CatalogAttributeDetails  
		CREATE TABLE [dbo].[#CatalogAttributeDetails]  
		(  
			[ZnodeCatalogId] [INT] NULL,  
			[AttributeCode] [NVARCHAR](300) NULL,  
			[AttributeTypeName] [VARCHAR](300) NULL,  
			[IsComparable] [bit] NOT NULL,  
			[IsHtmlTags] [bit] NOT NULL,  
			[IsFacets] [bit] NOT NULL,  
			[IsUseInSearch] [bit] NOT NULL,  
			[IsPersonalizable] [bit] NOT NULL,  
			[IsConfigurable] [bit] NOT NULL,  
			[AttributeName] [NVARCHAR](300) NULL,  
			[LocaleId] [INT] NULL,  
			[DisplayOrder] [INT] NULL,  
			[DefaultValueDisplayOrder] [INT] NULL,  
			[AttributeDefaultValue] [NVARCHAR](max) NULL  
		) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY] 
		
		DECLARE @CatalogName VARCHAR(100),@UserName VARCHAR(50)  
		SET @PublishCatalogId = ISNULL((SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalog ZPC WHERE ZPC.PimCatalogId = @PimCatalogId), 0)  
    
	SELECT TOP 1  @UserName = UserName 
	FROM ZnodeUser 
	WHERE ZnodeUser.UserId = @userId  
  
	SELECT @CatalogName = CatalogName FROM ZnodePimCatalog WHERE PimCatalogId = @PimCatalogId
	
	DELETE FROM ZnodePublishProgressNotifierEntity WHERE JOBName =@CatalogName   

	INSERT INTO ZnodePublishProgressNotifierEntity  
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriENDlyName)  
	VALUES(0,@NewGUID , Isnull(@CatalogName,'') + ' Catalog ', 0 , 0 , 0 , '' , @UserId, @UserName )  
  
	IF EXISTS (SELECT  * FROM ZnodePublishStateApplicationTypeMapping PSA WHERE PSA.IsEnabled =1 AND    
	EXISTS (SELECT TOP 1 1  FROM ZnodePublishState PS WHERE PS.PublishStateId = PSA.PublishStateId ) AND ApplicationType =  'WebstorePreview')  
		SET @IsPreviewEnable = 1   
	ELSE   
		SET @IsPreviewEnable = 0   
  
	--Genrate preview entry   
	DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1    
	DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))  
    
	IF OBJECT_ID('tempdb..[#Tbl_NewVersionEntity]') IS NOT NULL  
		DROP TABLE tempdb..#Tbl_NewVersionEntity  
	
	CREATE TABLE #Tbl_NewVersionEntity(PublishCatalogId INT , VersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
  
	--IF OBJECT_ID('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL  
	--	DROP TABLE tempdb..#Tbl_OldVersionEntity  
	
	--CREATE TABLE #Tbl_OldVersionEntity(PublishCatalogId INT , NewVersionId INT ,OldVersionId INT , LocaleId INT , PublishType VARCHAR(50) )  
    
    
	IF @PublishCatalogId > 0   
    BEGIN
		UPDATE ZPC SET CatalogName = ZC.CatalogName,ExternalId = ZC.ExternalId,PimCatalogId= @PimCatalogId,CreatedBy = @UserId,  
		CreatedDate = Getdate(),ModifiedBy = @UserId,ModifiedDate = Getdate()  
		FROM ZnodePublishCatalog ZPC   
		INNER JOIN ZnodePimCatalog ZC ON(ZC.PimCatalogId = ZPC.PimCatalogId)  
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
	END
	ELSE  
	BEGIN  
		INSERT INTO ZnodePublishCatalog (PimCatalogId,CatalogName,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT PimCatalogId,CatalogName,ExternalId,@UserId,Getdate(),@UserId,Getdate() FROM ZnodePimCatalog AS ZPC   
		WHERE ZPC.PimCatalogId = @PimCatalogId;  
                        
		SET @PublishCatalogId = SCOPE_IDENTITY();  
	END  
  
	--Getting active local for catalog which are associated to store
	INSERT INTO @TBL_Locale (LocaleId) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
  
	SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)  

	WHILE @IncrementalId <= @MaxCount  
	BEGIN   
		SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)  

		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )    
		BEGIN  
			
			INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
  
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PREVIEW'  
      
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			--UPDATE B
   --         SET IsPublishSuccess = 0
   --         FROM ZnodePublishVersionEntity B
   --         WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
   --             AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
   --         AND B.RevisionType = 'PRODUCTION'

			--Genrate production entry   
			INSERT INTO ZnodePublishCatalogLog  
			(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
			SELECT @PublishCatalogId,  @PimCatalogId,NULL,0,  
			NULL,0,  
			NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(), null ,@SetLocaleId ,DBO.Fn_GetPublishStateIdForProcessing()   
     
			INSERT INTO #Tbl_NewVersionEntity (PublishCatalogId,VersionId,LocaleId,PublishType)  
			SELECT @PublishCatalogId, @@Identity , @SetLocaleId ,'PRODUCTION'  
		END   
			SET @IncrementalId = @IncrementalId +1   
	END  
	
	DECLARE  @VersionIdString VARCHAR(2000)= ''    
     
	TRUNCATE TABLE ZnodePublishCatalogErrorLogEntity  

	UPDATE ZnodePublishProgressNotifierEntity SET   
	ProgressMark =5,   
	IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
	IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
	WHERE  JobId = @NewGUID  
   
	--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	--@NewGUID =@NewGUID   
  
	IF @Type = 'ZnodePublishCatalogEntity' OR @Type = ''  
	BEGIN  
   
		INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing)  
		SELECT Distinct VE.VersionId, ZPC.PublishCatalogId, PC.CatalogName,VE.PublishType, VE.LocaleId, isnull(PC.IsAllowIndexing,0)  
		FROM ZnodePublishCatalog ZPC  
		INNER JOIN  #Tbl_NewVersionEntity VE ON (VE.PublishCatalogId = ZPC.PublishCatalogId)  
		INNER JOIN ZnodePimCatalog PC on ZPC.PimCatalogId = PC.PimCatalogId  
		-- Data inserted INTo flat table ZnodeWebStoreEntity (Replica of MongoDB Collection )    
    
		IF @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  )   
		BEGIN  
			--UPDATE B
   --         SET IsPublishSuccess = 0
   --         FROM ZnodePublishVersionEntity B
   --         WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
   --             AND A.PublishType = 'PREVIEW' AND A.LocaleId = B.LocaleId) 
   --         AND B.RevisionType = 'PREVIEW'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE A.PublishType = 'PREVIEW'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PREVIEW' AND A.LocaleId = B.LocaleId )
		END  

		IF (@RevisionState like '%Production%' OR @RevisionState = 'None')  
		BEGIN  
			--UPDATE B
   --         SET IsPublishSuccess = 0
   --         FROM ZnodePublishVersionEntity B
   --         WHERE EXISTS(SELECT * FROM #Tbl_NewVersionEntity A WHERE A.PublishCatalogId = B.ZnodeCatalogId 
   --             AND A.PublishType = 'PRODUCTION' AND A.LocaleId = B.LocaleId) 
   --         AND B.RevisionType = 'PRODUCTION'

			INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
			SELECT VersionId,PublishCatalogId,PublishType,LocaleId,0 FROM  #Tbl_NewVersionEntity A
			WHERE PublishType = 'PRODUCTION'  
			AND NOT EXISTS(SELECT * FROM ZnodePublishVersionEntity B WHERE A.PublishCatalogId = B.ZnodeCatalogId 
			AND B.RevisionType = 'PRODUCTION' AND A.LocaleId = B.LocaleId )
		END  
  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCatalogEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
	END  
  
    IF @RevisionState = 'Preview'
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE RevisionType = 'Preview' AND ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '')   
	END
	ELSE
	BEGIN
		SELECT @VersionIdString = STUFF((SELECT ',' + cast (VersionId as VARCHAR(50))  
		FROM ZnodePublishVersionEntity WHERE ZnodeCatalogId = @PublishCatalogId FOR XML PATH ('')), 1, 1, '') 
	END


	IF @Type = 'ZnodePublishCategoryEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_GetPublishCategoryJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@Status  =@Status Out,  
		@RevisionState = @RevisionState   
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =30,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	IF @Type = 'ZnodePublishProductEntity' OR @Type = ''  
	BEGIN  
		-- Process call catalog publish (include category, products with multiple types)  
		DECLARE @PimProductId TransferId   
		EXEC [Znode_PublishLatestAssociatedProduct] @PublishCatalogId = @PublishCatalogId, @PimProductId = @PimProductId  , @UserId = @UserId , @PublishStateId =0   
		EXEC [dbo].[Znode_InsertPublishProductIds] @PublishCatalogId= @PublishCatalogId ,@userid =@userid ,@PimProductId = @PimProductId   
		EXEC Znode_GetPublishProductJson   
		@PublishCatalogId =@PublishCatalogId   
		,@PimProductId = @PimProductId   
		,@UserId = @userid  
		,@PimCatalogId = @PimCatalogId   
		,@VersionIdString = @VersionIdString  
		,@Status  =@Status  Out  
		,@RevisionState = @RevisionState   
		,@IsDraftProductsOnly = @IsDraftProductsOnly  
   
		EXECUTE [Znode_PublishCategoryHierarchyParentIds] @PimCatalogId = @PimCatalogId
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =50,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
		If @Status  = 1  
		BEGIN  
			UPDATE ZPCE SET ZPCE.ProductIds =   
			'[' +SUBSTRING((SELECT ','+CAST(PublishProductId AS VARCHAR(50))  
			FROM ZnodePublishCategoryProduct ZPCP   
			WHERE ZPCP.PublishCategoryId = ZPCE.ZnodeCategoryId  
			AND ZPCP.PublishCatalogId = ZPCE.ZnodeCatalogId  FOR XML PATH('')), 2, 8000) + ']'   
			FROM ZnodePublishCategoryEntity  ZPCE WHERE ZPCE.ProductIds is null   
		END  
  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END  

	IF @Type = 'ZnodePublishAddOnEntity' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedAddonsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@PimProductId   = @PimProductId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType='',  
		@Status  =@Status Out  
  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishAddOnEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =52,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   
   
	If @Type = 'BundleAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'BundleProduct'  
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'BundleAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =54,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'GroupedAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType    = 'GroupedProduct'  

		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'GroupedAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =56,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  

		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'ConfigurableAssociatedProducts' OR @Type = ''  
	BEGIN  
		Exec [Znode_GetPublishAssociatedProductsJson]  
		@PublishCatalogId = @PublishCatalogId ,  
		@UserId =@UserId,                 
		@VersionIdString = @VersionIdString,  
		@RevisionType = '',  
		@Status  =@Status Out,  
		@ProductType= 'ConfigurableProduct'  
  
      
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ConfigurableAssociatedProducts', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =58,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END   

	IF @Type = 'CatalogAttributeaDetail' OR @Type = ''  
	BEGIN  
	BEGIN TRY  
		--INSERT INTO #Tbl_VersionEntity (LocaleId,VersionId,RevisionType)  
		SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
		into #Tbl_VersionEntity
		FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item

		INSERT INTO [dbo].[#CatalogAttributeDetails]([ZnodeCatalogId],[AttributeCode],[AttributeTypeName],[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],[AttributeName],  
		[LocaleId],[DisplayOrder],[DefaultValueDisplayOrder],[AttributeDefaultValue] )  
		EXEC Znode_GetPublishProductAttribute @PublishCatalogId   

		SELECT Distinct   
		B.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  
		(SELECT Isnull(IA.AttributeDefaultValue,'') Value , Isnull(IA.[DefaultValueDisplayOrder],'') DisplayOrder    
		from [dbo].[#CatalogAttributeDetails] IA  WHERE IA.AttributeCode = A.AttributeCode AND IA.LocaleId = A.LocaleId   
		For JSON PATH) SELECTValues  
		INTO #Temp_PublishCatalogAttribute
		FROM [dbo].[#CatalogAttributeDetails] A INNER JOIN #Tbl_VersionEntity B on A.LocaleId = B.LocaleId

		DELETE X  
		FROM [dbo].ZnodePublishCatalogAttributeEntity X
		WHERE NOT EXISTS(SELECT * FROM #Temp_PublishCatalogAttribute A
			WHERE A.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
			AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId)
		AND X.ZnodeCatalogId = @PublishCatalogId


		UPDATE X SET    
		X.AttributeTypeName = A.[AttributeTypeName] ,X.IsComparable = A.[IsComparable],  
		X.IsHtmlTags = A.[IsHtmlTags],X.IsFacets = A.[IsFacets], X.IsUseInSearch = A.[IsUseInSearch],
		X.IsPersonalizable = A.[IsPersonalizable],X.IsConfigurable = A.[IsConfigurable],  
		X.AttributeName = A.[AttributeName],X.DisplayOrder = A.[DisplayOrder] , X.SELECTValues = A.SELECTValues
		FROM [dbo].#Temp_PublishCatalogAttribute A   
		INNER JOIN ZnodePublishCatalogAttributeEntity X ON A.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
		AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId
		AND X.ZnodeCatalogId = @PublishCatalogId

     
		INSERT INTO ZnodePublishCatalogAttributeEntity  
		(VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition,IsComparable,  
		IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,  
		AttributeName,LocaleId,DisplayOrder,SELECTValues)  
		SELECT Distinct   
		a.VersionId, A.[ZnodeCatalogId],A.[AttributeCode],A.[AttributeTypeName],0 IsPromoRuleCondition,[IsComparable],  
		[IsHtmlTags],[IsFacets],[IsUseInSearch],[IsPersonalizable],[IsConfigurable],  
		[AttributeName],A.[LocaleId],[DisplayOrder] ,  a.SELECTValues
		FROM [dbo].#Temp_PublishCatalogAttribute A   
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishCatalogAttributeEntity X WHERE a.VersionId=X.VersionId AND A.[ZnodeCatalogId]=X.ZnodeCatalogId 
		AND A.[AttributeCode]=X.AttributeCode AND A.LocaleId = X.LocaleId)
   
		SET @Status =1   
    
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =60,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
     
  
	END TRY   
	BEGIN CATCH   
		SET @Status   = 0   
     
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'CatalogAttributeaDetail', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		IF @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
	END CATCH    
	END   
  
	IF @Type = 'ZnodePublishSEOEntity' OR @Type = ''  
	BEGIN  
		EXEC [Znode_SetPublishSEOEntity]  
		@RevisionState = @RevisionState   
		,@CMSSEOTypeId  = '1,2'   
		,@UserId  = @UserId   
		,@Status  = @Status  OUTPUT   
		,@IsCatalogPublish = 1    
		,@VersionIdString  = @VersionIdString   
		,@IsPreviewEnable  = @IsPreviewEnable   
     
   
		INSERT INTO ZnodePublishCatalogErrorLogEntity(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' END , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
  
		UPDATE ZnodePublishProgressNotifierEntity SET   
		ProgressMark =70,   
		IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 END,  
		IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 END    
		WHERE  JobId = @NewGUID  
  
		If @Status  = 0   
		BEGIN  
			SELECT 1 AS ID,@Status AS Status;  
			Return 0   
		END  
  
	END   
  
	IF EXISTS (SELECT TOP 1 1  FROM ZnodePublishCatalogErrorLogEntity WHERE  ProcessStatus = 'Fail')   
	BEGIN  
    
		SET @Status  =0   
		SELECT 1 AS ID,@Status AS Status;  
		INSERT INTO ZnodePublishCatalogErrorLogEntity  
		(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
		SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(),   
		@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
     
		--EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
		--@NewGUID =@NewGUID   
  
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		
		UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
		IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0  
		, ModifiedDate = Getdate()  
		WHERE PublishStateId = DBO.Fn_GetPublishStateIdForProcessing()
		Return 0   
	END  
  
	SET @Status = 1  
  
    
	SELECT @PublishCatalogId AS id,@Status AS Status;     
END  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	INSERT INTO ZnodePublishCatalogErrorLogEntity  
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)  
	SELECT 'Znode_PublishCatalogEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(),   
	@UserId , Convert( VARCHAR(100), @PreviewVersionId) + '/' + Convert( VARCHAR(100), @ProductionVersionId)   
   
	EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = @PublishCatalogId,@UserId = @UserId , @IsRevertPublish = 0 ,  
	@NewGUID =@NewGUID   
  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate()   WHERE  PublishCatalogLogId in   
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PREVIEW' )  
	UPDATE ZnodePublishCatalogLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed() ,  
	IsCatalogPublished = 0 ,IsCategoryPublished = 0 ,IsProductPublished = 0 , ModifiedDate = Getdate() WHERE  PublishCatalogLogId in  
	(SELECT VersionId FROM #Tbl_NewVersionEntity WHERE PublishType = 'PRODUCTION' )  
                        
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE 
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 
		AND NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms i WHERE i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.SynonymCode,'') LIKE '%[^a-zA-Z0-9]%')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.RenameSynonymCode,'') LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND  NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms i WHERE i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND  NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms i WHERE i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND  NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms i WHERE i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.SynonymCode IN
			   (
				   select SynonymCode from @InsertSearchSynonyms
					group by SynonymCode
					having count(1)>1
			   );

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.RenameSynonymCode IN
			   (
				   select RenameSynonymCode from @InsertSearchSynonyms
					group by RenameSynonymCode
					having count(1)>1
			   ) AND ISNULL(ii.RenameSynonymCode,'') <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;

	--Update existing search synonym 
	UPDATE ZSS 
	SET ZSS.SynonymCode = CASE WHEN ISNULL(IPS.RenameSynonymCode,'') <> '' THEN IPS.RenameSynonymCode ELSE ZSS.SynonymCode END , ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' ELSE IPS.IsBidirectional END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' ELSE A.IsBidirectional END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode OR (A.RenameSynonymCode = ZSS.SynonymCode))
		
	
	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
	@PublishCatalogId INT = 0   
	,@PimProductId     TransferId Readonly  
	,@UserId     INT = 0   
	,@PimCatalogId     INT = 0   
	,@VersionIdString  VARCHAR(2000)= ''  
	,@Status     Bit  OutPut  
	,@RevisionState   Varchar(50) = ''  
	,@IsDraftProductsOnly BIT = 1  
)  
WITH RECOMPILE 
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
SELECT 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
BEGIN Try   
	SET NOCOUNT ON;  
	SET @Status = 0    
	Declare  @RevisionType VARCHAR(50) = ''   
	Declare @VersionId int = 0   
	DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
	DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
	DECLARE @DomainUrl varchar(max) = (SELECT TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
	DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
	DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
	DECLARE @LocaleIds transferId   

	INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
	SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
	FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item  

	 --Getting active local for catalog which are associated to store
	INSERT INTO @LocaleIds (Id) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
   
	DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
	--,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
	DECLARE @DefaultPortal int, @IsAllowIndexing int  
	SELECT @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 FROM ZnodePimCatalog ZPC INNER JOIN ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId WHERE ZPC1.PublishCatalogId =  @PublishCatalogId AND isnull(ZPC.IsAllowIndexing,0) = 1   
     
	-----DELETE unwanted publish data  
	DELETE ZPC FROM ZnodePublishCategoryProduct ZPC  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategory ZC WHERE ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
	DELETE ZPP FROM ZnodePublishCategoryProduct ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPP FROM ZnodePublishCatalogProductDetail ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPCP FROM ZnodePublishCatalogProductDetail ZPCP  
	INNER JOIN ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct a  
	INNER JOIN ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
	WHERE b.PimProductId = A.PimProductId AND ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
	AND isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 AND b.PublishCatalogId = @PublishCatalogId  
	---------  
  
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
	CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
	CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
	CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
	EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
	EXEC Znode_InsertUpdateCustomeFieldJson 1   
	EXEC Znode_InsertUpdatePimAttributeJson 1   
  
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN  
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
	END  

	UPDATE ZnodePublishProductEntity SET ElasticSearchEvent = 0

	EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId ,@IsDraftProductsOnly = @IsDraftProductsOnly 


	IF (@IsAllowIndexing=1)  
	BEGIN   
		INSERT INTO #ZnodePrice  
		SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
		FROM ZnodePrice ZP   
		INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
		INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
		INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
		WHERE ZP.PriceListId = @PriceListId   
		AND TY.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
		INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
		--+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
		INSERT INTO #ProductImages  
		SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
		INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
		WHERE  TYU.PublishCatalogId = @PublishCatalogId  
		AND RT.LocaleId = @DefaultLocaleId  
		AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
   
		INSERT INTO #ProductSKU   
		SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
		FROM ZnodeCMSSEODetail ZCSD   
		INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
		WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
		AND ZCDL.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		--AND ZCSD.PublishStateId = @PublishStateId  
		AND ZCSD.PortalId = @DefaultPortal  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
  
	END  
   
	CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId ON [dbo].[#ProductSKU] ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId ON [dbo].#ProductImages ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId ON [dbo].#ZnodePrice ([PublishProductId])  
	
	SELECT DISTINCT PublishProductId, x.LocaleId 
	INTO #PublishProducts 
	FROM ZnodePublishProduct ZPP
	INNER JOIN ##AttributeValueLocale x ON X.PimProductId = ZPP.PimProductId
	WHERE ZPP.PublishCatalogId = @PublishCatalogId

	CREATE INDEX #PublishProducts_PublishProductId on #PublishProducts(PublishProductId,LocaleId)
	--Creating products complete attribute json
	SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex, 
		'[' +  
		(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
		WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = ZPCPD.LocaleId   
		FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
		+ ']' AS ProductXML  
	INTO #ProductAttributeXML  
	FROM [ZnodePublishCatalogProductDetail] ZPCPD   
	INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
	WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId AND ZPCPD.LocaleId = X.LocaleId )
	GROUP BY ZPP.Pimproductid,ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

	CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
	ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
	
	IF (SELECT COUNT(*) FROM @LocaleIds) > 1
	BEGIN
		--INSERT INTO #ProductAttributeXML(Pimproductid,LocaleId,PublishProductId,ProductXML)
		SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex,
			'[' +  
			(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
			WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = @DefaultLocaleId   
			FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
			+ ']' AS ProductXML  
		INTO #ProductAttributeXML_LocaleWise
		FROM [ZnodePublishCatalogProductDetail] ZPCPD   
		INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
		WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
		AND NOT EXISTS(SELECT * FROM #ProductAttributeXML X WHERE ZPCPD.PublishProductId = X.PublishProductId AND X.LocaleId = ZPCPD.LocaleId )
		AND ZPCPD.LocaleId <> @DefaultLocaleId
		GROUP BY ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

		CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_LocaleWise_PimProductId_LocaleId  
		ON [dbo].#ProductAttributeXML (PimProductId,LocaleId) 
	END
	


	DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
	SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	SELECT @Rows = 50000  
          
	SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
	SELECT PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail 
	FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPAX.VersionId = V.VersionId)

	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId AND ZLW.IsActive = 0  )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPAX.VersionId = V.VersionId)
	
	--Delete products from category from publish tables which are removed from one category and added into other category
	--UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	--WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	--AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	--AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	--AND Not Exists (Select TOP 1 1 From ZnodePublishConfigurableProductEntity X Where X.AssociatedZnodeProductId = ZPPE.ZnodeProductId )
	--AND Isnull(ZPPE.ZnodeCategoryIds ,'') = '0'
	
	UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	AND Isnull(ZPPE.ZnodeCategoryIds ,'') <> ''
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPE.VersionId = V.VersionId)


 --   --Delete data which are not present in catalog publish
	--Declare @Batch Bigint
	--SET @Batch = 1;
	--WHILE @Batch > 0
	--BEGIN 
	--	--BEGIN TRAN DelProd
	--		DELETE top (5000)  ZPPAX
	--		from ZnodePublishProductEntity ZPPAX
	--		WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
	--							AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	--		AND ZPPAX.ZnodeCatalogId = @PublishCatalogId  
	--	--COMMIT TRAN DelProd
	--	SET @Batch = @@ROWCOUNT;
	--END
	
	SELECT ZPCP.PublishCategoryId,ZPCP.PublishProductId,ZPCP.PublishCatalogId,ZPCP.PimCategoryHierarchyId,ZPC.PimCategoryId,ZPCCF.PimProductId ,ZPCCF.DisplayOrder
	INTO #TempPublishCategoryProduct
	FROM ZnodePublishCategoryProduct ZPCP 
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId
	INNER JOIN ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
	INNER JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	WHERE EXISTS(SELECT * FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId))		
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCP.PublishProductId = X.PublishProductId)
	AND ZPCP.PublishCatalogId = @PublishCatalogId 

	CREATE NONCLUSTERED INDEX Id_#TempPublishCategoryProduct_1 ON #TempPublishCategoryProduct(PublishProductId,PublishCatalogId,PimCategoryHierarchyId)

	IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
		DROP TABLE #Temp_ImportLoop;  
          
	---- To get the min AND max rows for import in loop  
	;WITH cte AS   
	(  
		SELECT RowId = 1,   
		MinRow = 1,   
		MaxRow = cast(@Rows as int)  
		UNION ALL  
		SELECT RowId + 1,   
		MinRow + cast(@Rows as int),   
		MaxRow + cast(@Rows as int)  
		FROM cte  
		WHERE RowId + 1 <= @MaxCount  
	)  
	SELECT RowId, MinRow, MaxRow  
	INTO #Temp_ImportLoop  
	FROM cte  
	OPTION (maxrecursion 0);  

	DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
	FOR SELECT MinRow, MaxRow, B.LocaleId , B.RevisionType  ,b.VersionId
	FROM #Temp_ImportLoop L  
	CROSS APPLY @TBL_LocaleId B;  
  
	OPEN cur_BulkData;  
	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		IF OBJECT_ID('TEMPDB..#ProductEntity') IS NOT NULL
				DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#ProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #ProductEntity_LocaleWise
			
		SELECT   
			CAST(@VersionId AS VARCHAR(50)) VersionId --1   
			,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
			,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
			,CAST(ISNULL(ZPCPD.SKU ,'') AS VARCHAR(300)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
			,CAST(isnull(ZPCPD.ProductName,'') AS VARCHAR(300) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
			--'{"Attributes":[' + PAX.ProductXML + ']'  
			,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS VARCHAR(300)) CategoryName  --6  
			,CAST(Isnull(ZPCPD.CatalogName,'')  AS VARCHAR(300)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
			,@RevisionType RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8   
			ZPCPD.ProductIndex,  -- 9  
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
			Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
			CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU--, z.Id    		
		INTO #ProductEntity
		FROM #ProductAttributeXML ZPCPD  
		INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
		--INNER JOIN #ProductAttributeXML PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
		LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
		WHERE ZPCPD.LocaleId = @LocaleId  
		AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
		AND ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)

		CREATE INDEX Idx_#ProductEntity ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId,VersionId)
		INCLUDE (SKU,Lower_SKU,ProductName,Brands,CategoryName,CatalogName,DisplayOrder,AssociatedProductDisplayOrder,SalesPrice,
				RetailPrice,SEODescriptionForIndex,SEOKeywords,SEOTitle,SEOUrl,ImageSmallPath,ProductIndex,IsActive,IndexId,ProductXML)

		UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
			A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
			A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
			A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
			A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
			A.ElasticSearchEvent = 1
		FROM ZnodePublishProductEntity A
		INNER JOIN #ProductEntity B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
		AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

		INSERT INTO ZnodePublishProductEntity (  
			VersionId, --1  
			IndexId, --2   
			ZnodeProductId,ZnodeCatalogId, --3  
			SKU,LocaleId, --4   
			Name,ZnodeCategoryIds, --5  
			IsActive,Attributes,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)  
		SELECT VersionId, --1  
			IndexId, --2   
			PublishProductId,PublishCatalogId, --3  
			SKU,LocaleId, --4   
			ProductName,PublishCategoryId, --5  
			IsActive,ProductXML,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SEODescriptionForIndex,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,Lower_SKU,1 AS ElasticSearchEvent
		FROM #ProductEntity B
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)

		IF @LocaleId <> @DefaultLocaleId AND (SELECT COUNT(*) FROM @LocaleIds) > 1
		BEGIN
			SELECT 
				CAST(@VersionId AS VARCHAR(50)) VersionId --1 
				,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2
				,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3 
				,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4 
				,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
				,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6
				,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7 
				,@RevisionType as RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8 
				ZPCPD.ProductIndex,  -- 9
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,
				Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,
				CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU
			INTO #ProductEntity_LocaleWise
			FROM #ProductAttributeXML_LocaleWise ZPCPD
			INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)
			--INNER JOIN #ProductAttributeXML_LocaleWise PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId 
			LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
			WHERE ZPCPD.LocaleId = @LocaleId 
			AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			CREATE INDEX Idx_#ProductEntity_LocaleWise ON #ProductEntity_LocaleWise (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId,VersionId)
			INCLUDE (SKU,Lower_SKU,ProductName,Brands,CategoryName,CatalogName,DisplayOrder,AssociatedProductDisplayOrder,SalesPrice,
				RetailPrice,SEODescriptionForIndex,SEOKeywords,SEOTitle,SEOUrl,ImageSmallPath,ProductIndex,IsActive,IndexId,ProductXML)

			UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
				A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
				A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
				A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
				A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
				A.ElasticSearchEvent = 1
			FROM ZnodePublishProductEntity A
			INNER JOIN #ProductEntity_LocaleWise B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
			AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

			INSERT INTO ZnodePublishProductEntity (
			VersionId, --1
			IndexId, --2 
			ZnodeProductId,ZnodeCatalogId, --3
			SKU,LocaleId, --4 
			Name,ZnodeCategoryIds, --5
			IsActive,Attributes,Brands,CategoryName, --6 
			CatalogName,DisplayOrder, --7 
			RevisionType,AssociatedProductDisplayOrder, --8
			ProductIndex,--9
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)
			SELECT VersionId --1 
				,IndexId  --2
				,PublishProductId,PublishCatalogId  --3 
				,SKU,LocaleId -- 4 
				,ProductName ,PublishCategoryId  -- 5 
				,IsActive ,ProductXML,Brands,CategoryName  --6
				,CatalogName,DisplayOrder  -- 7 
				,RevisionType, AssociatedProductDisplayOrder,-- pending  -- 8 
				ProductIndex,  -- 9
				SalesPrice , 
				RetailPrice , 
				CultureCode , 
				CurrencySuffix , 
				CurrencyCode , 
				SEODescriptionForIndex,
				SEOKeywords,
				SEOTitle,
				SEOUrl,
				ImageSmallPath,
				Lower_SKU,1 as ElasticSearchEvent
			FROM #ProductEntity_LocaleWise B
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
		
			--select * from #ProductEntity_LocaleWise where PublishProductId = 191 

		END

		SET @VersionId = 0  

		IF OBJECT_ID('tempdb..#ProductEntity') is not null
			DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#TempProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #TempProductEntity_LocaleWise

	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	END;  
	CLOSE cur_BulkData;  
	DEALLOCATE cur_BulkData;  
  
  
	IF @RevisionState = 'PREVIEW'   
	begin
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
	end
	Else  
	begin
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
	end
		

	UPDATE ZnodePublishCatalogLog   
	SET IsProductPublished = 1   
	,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
		WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
	WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	and PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' ) 
    
	--UPDATE ZnodePublishCatalogLog   
	--SET IsProductPublished = 1   
	--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCatalogProductDetail ZPP   
	--	WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PimCategoryHierarchyId <> 0)   
	--WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	--AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' )  

	SET @Status = 1   

	IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL  
		DROP TABLE ##AttributeValueLocale; 

END TRY   
BEGIN CATCH   
	SELECT ERROR_MESSAGE()
	 SET @Status =0    
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
		 @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
	  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
	  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
	 EXEC Znode_InsertProcedureErrorLog  
	  @ProcedureName = 'Znode_GetPublishProductJson',  
	  @ErrorInProcedure = @Error_procedure,  
	  @ErrorMessage = @ErrorMessage,  
	  @ErrorLine = @ErrorLine,  
	  @ErrorCall = @ErrorCall;  
END CATCH  
  
END

GO

UPDATE ZnodeImportAttributeValidation 
SET ValidationValue=100, ValidationName = 'MaxCharacters',ControlName = 'Number'
WHERE AttributeCode='CatalogCode' AND EXISTS( SELECT TOP 1 1 FROM ZnodeImportHead B WHERE B.Name='Synonyms' AND B.ImportHeadId=ZnodeImportAttributeValidation.ImportHeadId)

GO
DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds  		
SELECT (SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName = 'Text')
,'Video1',0,0,1,1,0,0,0,500,null,0,0,null,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute ZPA WHERE ZPA.AttributeCode = 'Video1')
		
INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1 ,IPAS.PimAttributeId, 'Video 1', null, 2,GETDATE(),2,GETDATE()   
FROM @InsertedPimAttributeIds IPAS 
		
insert into ZnodePimFrontendProperties (PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
Select IPAZnodePimAttribute.PimAttributeId,0 IsComparable, 0 IsUseInSearch, 0 IsHtmlTags,0 IsFacets,2,getdate(),2,getdate()
from @InsertedPimAttributeIds IPAZnodePimAttribute
		
INSERT INTO ZnodePimAttributeGroupMapper
(PimAttributeGroupId,PimAttributeId,AttributeDisplayOrder,IsSystemDefined,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select TOP 1 PimAttributeGroupId from ZnodePimAttributeGroup where GroupCode = 'Image'),
(select TOP 1 PimAttributeId from znodePimattribute where AttributeCode = 'Video1'),null,1,2,getdate(),2,getdate()
WHERE NOT EXISTS (select * from ZnodePimAttributeGroupMapper where PimAttributeGroupId =(select PimAttributeGroupId from ZnodePimAttributeGroup where GroupCode = 'Image') AND
PimAttributeId = (select PimAttributeId from znodePimattribute where AttributeCode = 'Video1') )

INSERT INTO ZnodePimFamilyGroupMapper (PimAttributeFamilyId,PimAttributeGroupId,PimAttributeId,GroupDisplayOrder,IsSystemDefined
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT PimAttributeFamilyId, (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'Image'),
(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'Video1'),500,1,2,GETDATE(),2,GETDATE()
FROM  ZnodePimAttributeFamily PAF
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimFamilyGroupMapper PFG WHERE 
PimAttributeId = (SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'Video1')
AND PimAttributeGroupId = (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'Image') 
AND PFG.PimAttributeFamilyId = PAF.PimAttributeFamilyId)
AND PAF.IsCategory = 0

GO

DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds 		
SELECT (SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName = 'Text')
,'Video2',0,0,1,1,0,0,0,500,null,0,0,null,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute ZPA WHERE ZPA.AttributeCode = 'Video2')
		
INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1 ,IPAS.PimAttributeId, 'Video 2', null, 2,GETDATE(),2,GETDATE()   
FROM @InsertedPimAttributeIds IPAS 
		
insert into ZnodePimFrontendProperties (PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
Select IPAZnodePimAttribute.PimAttributeId,0 IsComparable, 0 IsUseInSearch, 0 IsHtmlTags,0 IsFacets,2,getdate(),2,getdate()
from @InsertedPimAttributeIds IPAZnodePimAttribute
		
INSERT INTO ZnodePimAttributeGroupMapper
(PimAttributeGroupId,PimAttributeId,AttributeDisplayOrder,IsSystemDefined,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select TOP 1 PimAttributeGroupId from ZnodePimAttributeGroup where GroupCode = 'Image'),
(select TOP 1 PimAttributeId from znodePimattribute where AttributeCode = 'Video2'),null,1,2,getdate(),2,getdate()
WHERE NOT EXISTS (select * from ZnodePimAttributeGroupMapper where PimAttributeGroupId =(select PimAttributeGroupId from ZnodePimAttributeGroup where GroupCode = 'Image') AND
PimAttributeId = (select PimAttributeId from znodePimattribute where AttributeCode = 'Video2') )

INSERT INTO ZnodePimFamilyGroupMapper (PimAttributeFamilyId,PimAttributeGroupId,PimAttributeId,GroupDisplayOrder,IsSystemDefined
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT PimAttributeFamilyId, (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'Image'),
(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'Video2'),500,1,2,GETDATE(),2,GETDATE()
FROM  ZnodePimAttributeFamily PAF
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimFamilyGroupMapper PFG WHERE 
PimAttributeId = (SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'Video2')
AND PimAttributeGroupId = (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'Image') 
AND PFG.PimAttributeFamilyId = PAF.PimAttributeFamilyId)
AND PAF.IsCategory = 0

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PostSubmitOrderProcess')
	DROP PROC Znode_PostSubmitOrderProcess
GO

CREATE PROCEDURE [dbo].[Znode_PostSubmitOrderProcess]
(
	@PostOrderXml XML,
	@InventoryData XML,
	@UserId INT,
	@PortalId INT = 0,
	@Status BIT OUT
)
AS
BEGIN
BEGIN TRY
--BEGIN TRAN PostOrder
	DECLARE @OmsOrderDetailsId INT
	DECLARE @OmsOrderId INT = (SELECT Tbl.Col.value( 'OrderID[1]', 'NVARCHAR(2000)' ) AS OrderId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsGuest BIT = (SELECT Tbl.Col.value( 'IsGuest[1]', 'NVARCHAR(2000)' ) AS IsGuest FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))

	DECLARE @OmsCookieMappingId INT = (SELECT Tbl.Col.value( 'CookieMappingId[1]', 'NVARCHAR(2000)' ) AS CookieMappingId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @BillingAddressId INT = (SELECT Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(2000)' ) AS BillingAddressId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsReferralCommission BIT = (SELECT Tbl.Col.value( 'IsReferralCommission[1]', 'NVARCHAR(2000)' ) AS IsReferralCommission FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @CommissionAmount NUMERIC(26,6) = (SELECT Tbl.Col.value( 'CommissionAmount[1]', 'NVARCHAR(2000)' ) AS CommissionAmount FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	SET @OmsOrderDetailsId = (SELECT OmsOrderDetailsId from ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderId AND IsActive = 1)
	DECLARE @SetBillingShippingFlags BIT = (SELECT Tbl.Col.value( 'SetBillingShippingFlags[1]', 'NVARCHAR(2000)' ) AS SetBillingShippingFlags FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col)) 
	DECLARE @GetDate DATETIME = GETDATE()
	
	--Fetching required user details 
	DECLARE @ReferralCommissionTypeId INT, @ReferralCommission NUMERIC(28,6) , @FirstName VARCHAR(100),@LastName VARCHAR(100)
	SELECT @FirstName = FirstName,@LastName = LastName, @ReferralCommission = CASE WHEN ReferralCommission IS NULL THEN 0 ELSE ReferralCommission END, @ReferralCommissionTypeId = ReferralCommissionTypeId
	FROM ZnodeUser WITH (NOLOCK) 
	WHERE UserId = @UserId
	
	---Voucher model fetch
	CREATE TABLE #TempVoucher
	(
		VoucherBalance NUMERIC(28,6),VoucherNumber NVARCHAR(600),VoucherMessage NVARCHAR(MAX),IsVoucherValid BIT,
		IsVoucherApplied BIT,VoucherAmountUsed NUMERIC(28,6),VoucherName NVARCHAR(600),ExpirationDate DATETIME,
		CultureCode NVARCHAR(600),PortalId INT,IsExistInOrder BIT,UserId INT,IsActive BIT,OrderVoucherAmount NUMERIC(28,6)
	)

	INSERT INTO #TempVoucher
	(
		VoucherBalance ,VoucherNumber,VoucherMessage ,IsVoucherValid ,
		IsVoucherApplied ,VoucherAmountUsed ,VoucherName ,ExpirationDate ,
		CultureCode ,PortalId ,IsExistInOrder ,UserId ,IsActive ,OrderVoucherAmount 
	)
	SELECT Tbl.Col.value( 'VoucherBalance[1]', 'NVARCHAR(2000)' ) AS VoucherBalance,
		Tbl.Col.value( 'VoucherNumber[1]', 'NVARCHAR(2000)' ) AS VoucherNumber,
		Tbl.Col.value( 'VoucherMessage[1]', 'NVARCHAR(2000)' ) AS VoucherMessage,
		Tbl.Col.value( 'IsVoucherValid[1]', 'NVARCHAR(2000)' ) AS IsVoucherValid,
		Tbl.Col.value( 'IsVoucherApplied[1]', 'NVARCHAR(2000)' ) AS IsVoucherApplied,
		Tbl.Col.value( 'VoucherAmountUsed[1]', 'NVARCHAR(2000)' ) AS VoucherAmountUsed,
		Tbl.Col.value( 'VoucherName[1]', 'NVARCHAR(2000)' ) AS VoucherName,
		Tbl.Col.value( 'ExpirationDate[1]', 'NVARCHAR(2000)' ) AS ExpirationDate,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(2000)' ) AS CultureCode,
		Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(2000)' ) AS PortalId,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,
		Tbl.Col.value( 'UserId[1]', 'NVARCHAR(2000)' ) AS UserId,	
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(2000)' ) AS IsActive,
		Tbl.Col.value( 'OrderVoucherAmount[1]', 'NVARCHAR(2000)' ) AS OrderVoucherAmount
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Vouchers/VoucherModel') AS Tbl(Col)


	----Promotion coupon start
	DECLARE @TempPromotionCoupon DBO.PromotionCoupons

	INSERT INTO @TempPromotionCoupon
	SELECT Tbl.Col.value( 'Code[1]', 'NVARCHAR(2000)' ) AS Code,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,@OmsOrderId AS OmsOrderId
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Coupons/CouponModel') AS Tbl(Col)

	--Deduct promotion coupon count
	EXEC [Znode_PromotionCouponDeduct] @PromotionCoupons = @TempPromotionCoupon
	----Promotion coupon END
	
	--Deduct inventory quantity
	EXEC [Znode_UpdateInventoryPostOrder] @SkuXml = @InventoryData,@PortalId = @PortalId, @UserId= @UserId,@OmsOrderId=@OmsOrderId,@Status = 0

	----Voucher start
	IF EXISTS(SELECT * FROM #TempVoucher)
	BEGIN
		INSERT INTO ZnodeGiftCardHistory(GiftCardId,TransactionDate,TransactionAmount,OmsOrderDetailsId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Notes,RemainingAmount)
		SELECT GC.GiftCardId, @GetDate, VoucherAmountUsed,@OmsOrderDetailsId,@UserId, @GetDate, @UserId, @GetDate, 'Voucher is used to make payments for the order' as Notes, NULL AS RemainingAmount
		FROM #TempVoucher V
		INNER JOIN ZnodeGiftCard GC WITH (NOLOCK) ON V.VoucherNumber = GC.CardNumber

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('TRUE','1'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = V.VoucherBalance,GC.UserId=@UserId
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('TRUE','1')
		END

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('FALSE','0'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = GC.RemainingAmount - V.VoucherAmountUsed,GC.UserId=@UserId
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('FALSE','0')
		END
	END
	----Voucher end
	
	--Update user details
	IF @FirstName IS NULL
	BEGIN
		DECLARE @FirstName1 VARCHAR(300), @LastName1 VARCHAR(300), @PhoneNumber VARCHAR(300)
		SELECT @FirstName1=FirstName, @LastName1 = LastName, @PhoneNumber=PhoneNumber
		FROM ZnodeAddress WITH (NOLOCK)  WHERE AddressId = @BillingAddressId

		UPDATE ZnodeUser 
		SET FirstName = @FirstName, LastName = @LastName, PhoneNumber = @PhoneNumber
		WHERE UserId = @UserId
	END

	--Update address details
	IF @SetBillingShippingFlags IN ('TRUE','1')
	BEGIN
		UPDATE ZnodeAddress
		SET IsBilling = 1, IsShipping = 1
		WHERE AddressId = @BillingAddressId
	END

	--ReferralCommission details
	IF @IsReferralCommission IN ('TRUE','1')
	BEGIN
		INSERT INTO ZnodeOmsReferralCommission
		(
			UserId,OmsOrderDetailsId,OrderCommission,TransactionId,Description,ReferralCommission,ReferralCommissionTypeId
			,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @UserId,@OmsOrderDetailsId,CASE WHEN @ReferralCommissionTypeId =1 THEN ((@CommissionAmount * ISNULL(@ReferralCommission,0)) / 100) ELSE @ReferralCommission END AS OrderCommission,'' AS TransactionId,'' AS Description,@ReferralCommission,@ReferralCommissionTypeId
			,@UserId,@GetDate,@UserId,@GetDate
	END
	
	---OmsTaxOrderSummary details
	IF EXISTS(SELECT * FROM ZnodeOmsTaxOrderSummary WITH (NOLOCK)  WHERE OmsOrderDetailsId = @OmsOrderDetailsId)
	BEGIN
		DELETE FROM ZnodeOmsTaxOrderSummary WHERE OmsOrderDetailsId = @OmsOrderDetailsId
	END

	INSERT INTO ZnodeOmsTaxOrderSummary (OmsOrderDetailsId,Tax,Rate,TaxName,TaxTypeName)
	SELECT 	@OmsOrderDetailsId AS OmsOrderDetailsId,
		Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) AS Tax,
		Tbl.Col.value( 'Rate[1]', 'NVARCHAR(2000)' ) AS Rate,
		Tbl.Col.value( 'TaxName[1]', 'NVARCHAR(2000)' ) AS TaxName,
		Tbl.Col.value( 'TaxTypeName[1]', 'NVARCHAR(2000)' ) AS TaxTypeName
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/TaxSummaryList/TaxSummaryModel') AS Tbl(Col)
	WHERE Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) IS NOT NULL
	--------

	--Remove 
	EXEC [Znode_DeleteSavedCartItem] @OmsCookieMappingId = @OmsCookieMappingId, @UserId = @UserId,@PortalId = @PortalId,@Status = 0  

	SET @Status = 1
	--COMMIT TRAN PostOrder
END TRY
BEGIN CATCH
--ROLLBACK TRAN PostOrder
	SET @Status = 0
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PostSubmitOrderProcess @PostOrderXml ='+CAST(@PostOrderXml AS VARCHAR(MAX))+' , @InventoryData = '+CAST(@InventoryData AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@PortalId ='+CAST(@PortalId AS VARCHAR(50))+',@Status ='+CAST(@Status AS VARCHAR(50));
	
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PostSubmitOrderProcess',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END

GO

IF NOT EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeExportProcessLog')
BEGIN
	CREATE TABLE ZnodeExportProcessLog
	(
		ExportProcessLogId INT IDENTITY(1,1) NOT NULL,
		ExportType NVARCHAR (100) NOT NULL,
		FileType NVARCHAR(100) NOT NULL,
		[Status] NVARCHAR (50) NULL,
		ProcessStartedDate DATETIME NOT NULL,
		ProcessCompletedDate DATETIME NULL,
		TableName NVARCHAR (100) NULL,
		CreatedBy INT NOT NULL,
		CreatedDate DATETIME NOT NULL,
		ModifiedBy INT NOT NULL,
		ModifiedDate DATETIME NOT NULL,
		CONSTRAINT [PK_ZnodeExportProcessLog] PRIMARY KEY CLUSTERED ([ExportProcessLogId] ASC)
	)
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteExportLogs')
	DROP PROC Znode_DeleteExportLogs
GO

CREATE PROCEDURE [dbo].[Znode_DeleteExportLogs]
(
	@DurationInDays			INT=0,
	@ExportProcessLogIds	NVARCHAR(MAX)=0,
	@Status					INT OUT
	
)
/*
	Summary: 
		This procedure is used to remove export logs/files and drop respective export tables.

	Unit Testing:
		EXEC dbo.Znode_DeleteExportLogs @DurationInDays=30, @Status=0, @ExportProcessLogIds=0
		EXEC dbo.Znode_DeleteExportLogs @DurationInDays=0, @Status=0, @ExportProcessLogIds='1,2,3,4'
		EXEC dbo.Znode_DeleteExportLogs @DurationInDays=0, @Status=0, @ExportProcessLogIds='58'
*/
AS
BEGIN
	BEGIN TRAN DeleteExportLogs;
	BEGIN TRY
		SET NOCOUNT ON;

		IF OBJECT_ID('tempdb..#TableName') IS NOT NULL
			DROP TABLE #TableName;

		IF OBJECT_ID('tempdb..#ExportProcessLog') IS NOT NULL
			DROP TABLE #ExportProcessLog;

		SELECT Item As ExportProcessLogId
		INTO #ExportProcessLog
		FROM dbo.Split(@ExportProcessLogIds,',');
		
		SELECT TableName
		INTO #TableName
		FROM ZnodeExportProcessLog
		WHERE ((@DurationInDays<>0 AND CONVERT(DATE,CreatedDate,121) < DATEADD(DAY,-@DurationInDays,CONVERT(DATE,GETDATE(),121)))
			OR ExportProcessLogId IN (SELECT ExportProcessLogId FROM #ExportProcessLog))
			AND [Status] <> 'In Progress';

		DECLARE @DropTable NVARCHAR(MAX) = (SELECT + STRING_AGG('DROP TABLE IF EXISTS '+TableName ,'; ') FROM #TableName);

		--PRINT @DropTable
		EXEC (@DropTable);

		DELETE
		FROM ZnodeExportProcessLog
		WHERE TableName IN (SELECT [TableName] FROM #TableName);

		SELECT TableName As [FileName]
		FROM #TableName;

		DROP TABLE #TableName;
		DROP TABLE #ExportProcessLog;

		SET @Status = 1;
	COMMIT TRAN DeleteExportLogs;
	END TRY
	BEGIN CATCH
		DECLARE @Error_Procedure VARCHAR(1000) = ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteExportLogs 
					@DurationInDays='+CAST(@DurationInDays AS VARCHAR(50))+',
					@ExportProcessLogIds='''+CAST(@ExportProcessLogIds AS NVARCHAR(MAX))+''',
					@Status='+CAST(@Status AS VARCHAR(50));
         
             SET @Status = 0;

             ROLLBACK TRAN DeleteExportLogs;

             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteExportLogs',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
		SELECT ERROR_MESSAGE()
	END CATCH
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ExportFormSubmissionByTableName')
	DROP PROC Znode_ExportFormSubmissionByTableName
GO

CREATE PROCEDURE [dbo].[Znode_ExportFormSubmissionByTableName]
(
	@TableName	NVARCHAR(100),
	@WhereClause NVARCHAR(MAX),
	@Rows        INT           = 100,
	@PageNo      INT           = 1,
	@Order_BY    VARCHAR(100)  = '',
	@RowsCount   INT OUT
	--@Status		 BIT = 0 OUT
)
/*
	Summary: 
		This Procedure is used to display exported FormSubmissions data from respective export table based on input values.

	Unit Testing :
		EXEC [Znode_ExportFormSubmissionByTableName] @TableName='ExportFormSubmissions_20220802_15_36_34',@WhereClause ='',@Rows=50,@PageNo=1,@Order_BY='',@RowsCount=0
		EXEC [Znode_ExportFormSubmissionByTableName] @TableName='ExportFormSubmissions_20220802_15_36_34',@WhereClause ='',@Rows=50,@PageNo=2,@Order_BY='',@RowsCount=0
*/
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @SSQLString NVARCHAR(MAX);

		IF OBJECT_ID('tempdb..[##TBL_FormBuilder]') IS NOT NULL
			DROP TABLE tempdb..[##TBL_FormBuilder];

		SET @SSQLString = '
		;With Cte_GetFormBuilderDetails 
		 AS (
			SELECT *
			FROM '+@TableName+' WITH (NOLOCK) 						
			)
			,Cte_GetFilterFormBuilder
			AS (
			SELECT *,ROW_NUMBER() OVER (ORDER BY FormBuilderSubmitId DESC) As RowId,				
			Count(*)Over() CountNo 
			FROM Cte_GetFormBuilderDetails CGPTL 
			WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'						
				)				
			SELECT *
			INTO ##TBL_FormBuilder
			FROM Cte_GetFilterFormBuilder
			'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows);
			
		--PRINT (@SSQLString)

		EXEC (@SSQLString);

		SET @RowsCount =ISNULL((SELECT TOP 1 CountNo FROM ##TBL_FormBuilder ),0);
			
		ALTER TABLE ##TBL_FormBuilder 
		DROP COLUMN IF EXISTS RowId;

		ALTER TABLE ##TBL_FormBuilder
		DROP COLUMN IF EXISTS CountNo;

		SELECT * FROM ##TBL_FormBuilder;
		
		IF OBJECT_ID('tempdb..[##TBL_FormBuilder]') IS NOT NULL
			DROP TABLE tempdb..[##TBL_FormBuilder];
	END TRY
              			 
	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= ' EXEC Znode_ExportFormSubmissionByTableName 
					@TableName = '+CAST(@TableName AS VARCHAR(100))+',
					@WhereClause = '+CAST(@WhereClause AS VARCHAR(MAX))+',
					@Rows='+CAST(@Rows AS VARCHAR(50))+',
					@PageNo='+CAST(@PageNo AS VARCHAR(50))+',
					@Order_BY='+CAST(@Order_BY AS VARCHAR(MAX))+',
					@RowsCount='+CAST(@RowsCount AS VARCHAR(50));
					
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ExportFormSubmissionByTableName',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ExportFormSubmissions')
	DROP PROC Znode_ExportFormSubmissions
GO

CREATE PROCEDURE [dbo].[Znode_ExportFormSubmissions] 
(
    @FileType NVARCHAR(20),
	@Status	BIT = 0 OUT
)
/*
	Summary: 
		This Procedure is used to export FormSubmissions data based on input values.

	Unit Testing :
		EXEC [Znode_ExportFormSubmissions]
*/
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @ExportProcessLogId INT = 0, @Count INT, @Table NVARCHAR(MAX), @GLobalAttributeCode NVARCHAR(MAX), @SSQLString NVARCHAR(MAX);
		DECLARE @TBL_FormBuilder TABLE (FormBuilderId INT,FormBuilderSubmitId INT,FormCode VARCHAR(200),StoreName NVARCHAR(MAX),UserName NVARCHAR(1024),FullName VARCHAR(100),CreatedDate DATETIME,RowId INT, CountNo INT);
			
		INSERT INTO ZnodeExportProcessLog (ExportType,FileType,[Status],ProcessStartedDate,ProcessCompletedDate,TableName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT 'FormSubmissions',@FileType,'Started',GETDATE(),NULL,NULL,3,GETDATE(),3,GETDATE()

		SET @ExportProcessLogId = SCOPE_IDENTITY()

		SET @Table = 'ExportFormSubmissions'+'_'+ CAST(@ExportProcessLogId As VARCHAR(20));

		UPDATE ZnodeExportProcessLog
		SET TableName = @Table
		WHERE ExportProcessLogId = @ExportProcessLogId;

		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
					
		SELECT A.FormBuilderSubmitId,C.AttributeCode,B.AttributeValue 
		INTO #GlobalAttribute
		FROM ZnodeFormBuilderGlobalAttributeValue A WITH (NOLOCK)
		INNER JOIN ZnodeFormBuilderGlobalAttributeValueLocale B WITH (NOLOCK) ON B.FormBuilderGlobalAttributeValueId=A.FormBuilderGlobalAttributeValueId
		INNER JOIN ZnodeGlobalAttribute C WITH (NOLOCK) ON C.GlobalAttributeId=A.GlobalAttributeId;
		
		SELECT @GLobalAttributeCode = STUFF((
		SELECT DISTINCT ',' + AttributeCode
		FROM #GlobalAttribute
		FOR XML PATH('') 
		), 1, 1, '');

		SET @SSQLString ='SELECT * INTO ##GLobalAttributeData
		FROM (
		SELECT FormBuilderSubmitId,AttributeCode, AttributeValue FROM #GlobalAttribute
		)T
		PIVOT(MAX(Attributevalue) FOR AttributeCode IN ('+@GLobalAttributeCode+'))PIV'

		EXEC (@SSQLString);
		
		SET @SSQLString='SELECT ZFB.FormCode,ZP.StoreName,ZU.UserName,ZU.FullName,SS.CreatedDate,V.*
		INTO '+@Table+'
		FROM ZnodeFormBuilderSubmit ss WITH (NOLOCK) 
		INNER JOIN ZnodeFormBuilder ZFB WITH (NOLOCK) on SS.FormBuilderId=ZFB.FormBuilderId
		INNER JOIN ZnodePortal ZP WITH (NOLOCK) ON ZP.PortalId=SS.PortalId 
		LEFT JOIN View_CustomerUserDetail ZU WITH (NOLOCK) ON ZU.UserId=SS.UserId												
		INNER JOIN ##GLobalAttributeData V ON (V.FormBuilderSubmitId=SS.FormBuilderSubmitId)'
		
		EXEC (@SSQLString);
		
		SET @Count = @@ROWCOUNT;
				
		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
				
		UPDATE ZnodeExportProcessLog 
		SET [Status]= 'In Progress',
			ProcessCompletedDate = GETDATE()
		WHERE ExportProcessLogId =@ExportProcessLogId;

		SELECT TableName
		FROM ZnodeExportProcessLog
		WHERE ExportProcessLogId = @ExportProcessLogId;

		SELECT @Count As [Count];

		SET @Status = 1;
	END TRY
 
	BEGIN CATCH
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'Znode_ExportFormSubmissions 
					@FileType='+CAST(@FileType AS VARCHAR(20))+'
					@Status='+CAST(@Status AS VARCHAR(10));
		
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ExportFormSubmissions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO
IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetExportLogs')
	DROP PROC Znode_GetExportLogs
GO

CREATE PROCEDURE [dbo].[Znode_GetExportLogs]
( 
	@WhereClause NVARCHAR(MAX),
	@Rows        INT           = 100,
	@PageNo      INT           = 1,
	@Order_BY    VARCHAR(1000)  = '',
	@RowsCount   INT OUT
)
AS
/*
	Summary : Get Export Log details and errorlog associated to it
	Unit Testing 
	begin tran
		DECLARE @RowsCount INT;
		EXEC Znode_GetExportLogs @WhereClause = '',@Rows = 1000,@PageNo = 1,@Order_BY = NULL,@RowsCount = @RowsCount OUT;
		EXEC Znode_GetExportLogs @WhereClause = '',@Rows = 1000,@PageNo = 1,@Order_BY = NULL,@RowsCount = null;
	rollback tran
*/
BEGIN
	BEGIN TRY
    SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		DECLARE @SQL NVARCHAR(MAX);
		DECLARE @TBL_ErrorLog TABLE (ExportProcessLogId INT, ExportType NVARCHAR(100), Status VARCHAR(50) , ProcessStartedDate DATETIME, ProcessCompletedDate DATETIME, RowId INT, CountNo INT, TableName NVARCHAR(100), FileType nvarchar(100))

		IF OBJECT_ID('Tempdb..[#ErrorLog]') IS NOT NULL
		DROP TABLE Tempdb..[#ErrorLog]

		CREATE TABLE #ErrorLog(ExportProcessLogId INT, ExportType NVARCHAR(100), Status NVARCHAR(100), ProcessStartedDate DATETIME, ProcessCompletedDate DATETIME, CreatedBy INT, TableName NVARCHAR(100), FileType nvarchar(100))

		INSERT INTO #ErrorLog(ExportProcessLogId,ExportType,Status,ProcessStartedDate, ProcessCompletedDate, TableName, FileType)				
		SELECT ExportProcessLogId,ExportType,Status,ProcessStartedDate, ProcessCompletedDate, TableName, FileType
		FROM ZnodeExportprocessLog

		SET @SQL = ';With Cte_ErrorlogFilter AS
		(

		SELECT ExportProcessLogId,ExportType,Status,ProcessStartedDate, ProcessCompletedDate, TableName, FileType
				,'+dbo.Fn_GetPagingRowId(@Order_BY,'ExportProcessLogId DESC')+', Count(*)Over() CountNo
		FROM #ErrorLog
		WHERE 1 = 1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
		) 
		SELECT ExportProcessLogId,ExportType,Status,ProcessStartedDate, ProcessCompletedDate,RowId,CountNo, TableName, FileType
		FROM Cte_ErrorlogFilter 
		'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)
	       
		INSERT INTO @TBL_ErrorLog (ExportProcessLogId, ExportType,[Status],ProcessStartedDate, ProcessCompletedDate,RowId,CountNo,TableName,FileType)
		EXEC(@SQl)
		
		SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ErrorLog ), 0);

		SELECT ExportProcessLogId, ExportType, [Status], ProcessStartedDate, ProcessCompletedDate, TableName, FileType
		FROM @TBL_ErrorLog

		IF OBJECT_ID('Tempdb..[#ErrorLog]') IS NOT NULL
			DROP TABLE Tempdb..[#ErrorLog]
    END TRY
    BEGIN CATCH
        DECLARE @Status BIT;
		SET @Status = 0;
		
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetExportLogs 
					@WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS	VARCHAR(50)),'''''')+',
					@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',
					@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		
        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetExportLogs',
			@ErrorInProcedure = 'Znode_GetExportLogs',
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;                   
    END CATCH;
END;

GO

INSERT INTO ZnodeApplicationSetting
	(GroupName,	ItemName,Setting,ViewOptions,FrontPageName,FrontObjectName,IsCompressed,OrderByFields,ItemNameWithoutCurrency,CreatedByName,ModifiedByName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'Table','ZnodeExportProcessLog','<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ExportProcessLogId</name><headertext>ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ExportProcessLogId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>ExportProcessLogId</islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ExportType</name><headertext>Export Type</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>FileType</name><headertext>File Type</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>Status</name><headertext>Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>IsCompletedorNot</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ProcessStartedDate</name><headertext>Start Date</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>ProcessCompletedDate</name><headertext>End Date</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Download|Delete</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Download|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Export/DownloadExportFile|/Export/Deletelogs</manageactionurl><manageparamfield>TableName|ExportProcessLogId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>TableName</name><headertext>File Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>','ZnodeExportProcessLog','ZnodeExportProcessLog','ZnodeExportProcessLog',0,NULL,NULL,NULL,NULL,2,getdate(),2,getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeApplicationSetting WHERE GroupName = 'Table' AND ItemName = 'ZnodeExportProcessLog')

GO

INSERT INTO ZnodeMenu
	(ParentMenuId,MenuName,MenuSequence,AreaName,ControllerName,ActionName,CSSClassName,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	( select Top 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Dev Center'),
'Export',13,NULL,'Export','List','z-import-export',1,
2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeMenu WHERE MenuName='Export')

GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.columns WHERE TABLE_NAME = 'ZnodeImportTemplate' and COLUMN_NAME = 'PromotionTypeId')
BEGIN
	ALTER TABLE ZnodeImportTemplate ADD PromotionTypeId INT NULL
END

GO

IF NOT EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeImportTemplate_ZnodePromotionType')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeImportTemplate'))
BEGIN
	ALTER TABLE [dbo].[ZnodeImportTemplate] ADD CONSTRAINT [FK_ZnodeImportTemplate_ZnodePromotionType] FOREIGN KEY ([PromotionTypeId]) REFERENCES [dbo].[ZnodePromotionType] ([PromotionTypeId])
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportData')
	DROP PROC Znode_ImportData
GO

CREATE PROCEDURE [dbo].[Znode_ImportData](
	  @TableName varchar(200), @NewGUID nvarchar(max), @TemplateId nvarchar(200), @UserId int, @LocaleId int= 1, @DefaultFamilyId int= 0, @IsDebug bit= 0, @PriceListId int= 0,@CountryCode Nvarchar(100) = '',@PortalId int = 0 ,
	  @IsDoNotCreateJob bit = 0 , @IsDoNotStartJob bit = 0, @StepName nvarchar(50) = 'Import' , @StartStepName nvarchar(50) = 'Import' ,
	  @step_id int  = 1 ,@Nextstep_id  int = 1 , @ERPTaskSchedulerId int = 0, @IsAccountAddress bit = 0,@IsAutoPublish Bit = 0  ,@ImportProcessLogId  int = 0,@PimCatalogId INT = 0, @PromotionTypeId	INT=0  )
AS
/*
    Summary :  Import Process call respective import method from @TemplateId 
    Process :  
	EXEC Znode_ImportValidatePimProductData @TableName = 'tempdb..[##SEODetails_61bbcb4c-5b83-49a0-8bb6-48eaf07f9ce0]',@NewGUID = '61bbcb4c-5b83-49a0-8bb6-48eaf07f9ce0' ,@TemplateId = 9,@UserId = 2,@PortalId = 0,@LocaleId = 1,@IsCategory= 1 ,@DefaultFamilyId = 0 ,@ImportHeadName = 'SEODetails', @ImportProcessLogId = 11, @PriceListId = 0, @CountryCode = ''
*/
BEGIN
BEGIN TRY 
	 DECLARE @ImportHeadName nvarchar(100), @SPScript nvarchar(max), @DatabaseName nvarchar(100), @ServerName nvarchar(100), @SPScript1 nvarchar(max),@UserName nvarchar(100);
	 DECLARE @GetDate datetime= dbo.Fn_GetDate();
	 DECLARE @SPName nvarchar(100)
	
	 SELECT TOP 1 @ImportHeadName = Name
	 FROM ZnodeImportTemplate AS zit
		 INNER JOIN
		 ZnodeImportHead AS zih
		 ON zit.ImportHeadId = zih.ImportHeadId
	 WHERE zit.ImportTemplateId = @TemplateId;
	 SET @DatabaseName = DB_NAME();
	 SET @ServerName = @@serverName;/*We can use for the customization*/
	 SET @UserName = SYSTEM_USER;
	 
	 If (@ImportHeadName = 'ProductUpdate')
	 Begin
		SET @SPName = 'Znode_ImportPartialValidatePimProductData'
		SET @Nextstep_id = 1 
	 End
	 ELSE
	 Begin
		SET @SPName = 'Znode_ImportValidatePimProductData'
		SET @Nextstep_id = 3 
	 End

	--Generate new process for current import 
	If @ImportProcessLogId   = 0 
	Begin
		If @ERPTaskSchedulerId = 0 
			INSERT INTO ZnodeImportProcessLog( ImportTemplateId, Status, ProcessStartedDate, ProcessCompletedDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
			   SELECT @TemplateId, dbo.Fn_GetImportStatus( 0 ), @GetDate, NULL, @UserId, @GetDate, @UserId, @GetDate;
		else 
			INSERT INTO ZnodeImportProcessLog( ImportTemplateId, Status, ProcessStartedDate, ProcessCompletedDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate ,ERPTaskSchedulerId)
			   SELECT @TemplateId, dbo.Fn_GetImportStatus( 0 ), @GetDate, NULL, @UserId, @GetDate, @UserId, @GetDate , @ERPTaskSchedulerId;
		SET @ImportProcessLogId = @@IDENTITY;
	
	End
	
	SET @SPScript1 = N' EXEC ' + @SPName + ' @TableName = '''+@TableName+''',@NewGUID = '''+@NewGUID+''' ,@TemplateId = '
					+CONVERT(varchar(100), @TemplateId)+',@UserId = '+CONVERT(varchar(100), @UserId)
					+',@PortalId = '+CONVERT(varchar(100), @PortalId)+
					+',@IsAccountAddress = '+CONVERT(varchar(100), @IsAccountAddress)
					+',@LocaleId = '+CONVERT(varchar(100), @LocaleId)+',@IsCategory= '+CASE
					WHEN @ImportHeadName IN( 'Pricing', 'Product', 'Inventory' ) THEN '0'
					ELSE '1'
					END+' ,@DefaultFamilyId = '+CONVERT(varchar(100), @DefaultFamilyId)+' ,@ImportHeadName = '''+@ImportHeadName+''', @ImportProcessLogId = '
					+CONVERT(varchar(100), @ImportProcessLogId)+', @PriceListId = '+CONVERT(varchar(100), @PriceListId)
					+', @PimCatalogId = '+CONVERT(varchar(100), @PimCatalogId)+ ', @CountryCode = ''' + @CountryCode  + ''', @PromotionTypeId = '+CONVERT(varchar(100), @PromotionTypeId)+'';

	    
	  IF @IsAutoPublish = 1 
	  BEGIN 
			SET @SPScript1 = @SPScript1 + N' 
		   
			DECLARE @PimProductId Transferid 

			INSERT INTO  @PimProductId 
			SELECT DISTINCT  c.PimProductId 
			FROM ZnodeImportSuccessLog a 
			INNER JOIN ZnodePimAttributeValueLocale  b ON (b.AttributeValue = a.ImportedSku)
			INNER JOIN ZnodePimAttributeValue c ON (c.PimAttributeValueId = b.PimAttributeValueId)
			INNER JOIN ZnodePimAttribute d ON (d.PimAttributeId = c.PimAttributeId)
			WHERE d.AttributeCode = ''SKU''
			AND a.ImportedGuId = '''+@NewGUID+'''
			
			Exec [Znode_PublishSingleProductEntity] @PimProductId = @PimProductId  , @UserId = 2 ,  @RevisionType = ''PRODUCTION''  
			,@IsAutoPublish = 1,@ImportGUID = '''+@NewGUID+'''

			UPDATE ZnodeImportSuccessLog 
			SET    IsProductPublish =  1 
			WHERE ImportedGuId = '''+@NewGUID+'''

		'

		print @SPScript1
	  END 

	IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
	BEGIN
	      EXEC sys.sp_sqlexec @SPScript1;
	END;
	ELSE
	BEGIN 
		
		IF @IsDebug = 1
		          BEGIN
		              EXEC sys.sp_sqlexec
		                   @SPScript1;
		              RETURN 0;
		          END;
		--DECLARE @jobId binary(16)
		--SELECT @jobId = job_id FROM msdb.dbo.sysjobs WHERE (name = N'Name of Your Job')
		--IF (@jobId IS NOT NULL)
		--BEGIN
		--EXEC msdb.dbo.sp_delete_job @jobId
		--END
		--Add a job

		SET @SPScript1 = N' EXEC '+ @SPName + ' @TableName = '''''+@TableName+''''',@NewGUID = '''''+@NewGUID+''''' ,@TemplateId = '+CONVERT(varchar(100), @TemplateId)+',@UserId = '+CONVERT(varchar(100), @UserId)+',@PortalId = '+CONVERT(varchar(100), @PortalId)+',@LocaleId = '+CONVERT(varchar(100), @LocaleId)+',@IsCategory= '+CASE
																																																																										   WHEN @ImportHeadName IN( 'Pricing', 'Product', 'Inventory' ) THEN '0'
																																																																										   ELSE '1'
																																																																										   END
					+' ,@DefaultFamilyId = '+CONVERT(varchar(100), @DefaultFamilyId)+' ,@ImportHeadName = '''''+@ImportHeadName+''''', @ImportProcessLogId = '+CONVERT(varchar(100), @ImportProcessLogId)+', @PriceListId = '+CONVERT(varchar(100), @PriceListId)+',@IsAccountAddress = '+CONVERT(varchar(100), @IsAccountAddress)+', @PimCatalogId = '+CONVERT(varchar(100), @PimCatalogId)
																																																																										   + ', @CountryCode = ''''' + @CountryCode  +''''', @PromotionTypeId = '+CONVERT(varchar(100), @PromotionTypeId)+'';


		
		 IF @IsAutoPublish = 1 
	  BEGIN 
		SET @SPScript1 = @SPScript1 + N' 
		   
			DECLARE @PimProductId Transferid 

			INSERT INTO  @PimProductId 
			SELECT DISTINCT  b.PimProductId 
			FROM ZnodeImportSuccessLog a 
			INNER JOIN View_loadManageProductInternal b ON (b.AttributeValue = a.ImportedSku)
			WHERE b.AttributeCode = ''''SKU''''
			AND a.ImportedGuId = '''''+@NewGUID+'''''
			
			
			Exec [Znode_PublishSingleProductEntity] @PimProductId = @PimProductId  , @UserId = 2 ,  @RevisionType = ''''PRODUCTION''''  
			,@IsAutoPublish = 1,@ImportGUID = '''''+@NewGUID+'''''

						
			UPDATE ZnodeImportSuccessLog 
			SET    IsProductPublish =  1 
			WHERE ImportedGuId = '''''+@NewGUID+'''''
			 '
	  END 

		DECLARE @jobId binary(16);
		
		SET @NewGUID = 'Import_'+REPLACE(@NewGUID, '''', '');
		

		IF @IsDoNotCreateJob =0 
		Begin
			SET @SPScript = N'EXEC msdb.dbo.sp_add_job
				  @job_name = '''+@NewGUID+''' ,
				  @enabled = 1,
				  @notify_level_eventlog = 2,
				  @notify_level_email = 2,
				  @notify_level_netsend = 2,
				  @notify_level_page = 2,
				  @delete_level = 3,
				  @category_name = N''[Uncategorized (Local)]'',
				  @owner_login_name = N'''+ @UserName +'''';
			--@job_id = '' + Convert(NVARCHAR(MAX),@jobId ) + '' OUTPUT; '

			EXEC sys.sp_sqlexec @SPScript;

			SET @SPScript = N' EXEC msdb.dbo.sp_add_jobserver
				  @job_name = '''+@NewGUID+'''';

			EXEC sys.sp_sqlexec @SPScript;
		END

		SET @SPScript = N' EXEC msdb.dbo.sp_add_jobstep
              @job_name = '''+ @NewGUID +''',
              @step_name = N'''+ @StepName +''',
			  @step_id =  ' + Convert(nvarchar(10),@step_id ) +  ',
			  @cmdexec_success_code = 0,
              @on_success_action = ' + Convert(nvarchar(10),@Nextstep_id ) +  ',
              @on_fail_action = '    + Convert(nvarchar(10),@Nextstep_id ) +  ',
			  @retry_attempts = 0,
              @retry_interval = 0,
              @os_run_priority = 0,
              @subsystem = N''TSQL'',
              @command = N'''+ @SPScript1 +''',
              @database_name = '''+@DatabaseName+''',
              @flags = 0 ';
		PRINT  @SPScript
		EXEC sys.sp_sqlexec @SPScript;

		DECLARE @ReturnCode tinyint= 0; -- 0 (success) or 1 (failure)
		IF @IsDoNotStartJob = 0 
		Begin
			SET @SPScript = N'EXEC @ReturnCode = msdb.dbo.sp_start_job 
				  @job_name = '''+ @NewGUID +''',
				  @server_name = '''+ @ServerName +''',
				  @step_name = N''' + @StartStepName +'''';

			EXEC sys.SP_EXECUTESQL @SPScript, N'@ReturnCode TINYINT OUT', @ReturnCode = @ReturnCode OUT;
		END 
		--      select 3  , @SPScript
		
		--RETURN (@ReturnCode)
		IF @ReturnCode = 1
		BEGIN
			UPDATE ZnodeImportProcessLog
			  SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId
		END;

		--EXEC msdb.dbo.sp_delete_job @job_id=N'4470113c-a592-41d8-951e-45d9982071da', @delete_unused_schedule=1
	END;
	END TRY 
	BEGIN CATCH 
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportData @TableName = '''+ISNULL(@TableName,'''''')+''',@NewGUID='''+ISNULL(CAST(@NewGUID AS
		VARCHAR(50)),'''''')+''',@TemplateId='''+ISNULL(CAST(@TemplateId AS VARCHAR(50)),'''''')+''',@CountryCode='''+ISNULL(@CountryCode,'''''')+''',
		@UserId='+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@DefaultFamilyId='+ISNULL(CAST(@DefaultFamilyId AS VARCHAR(50)),'''')+',@PriceListId='+ISNULL(CAST(@PriceListId AS VARCHAR(50)),'''')+',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(50)),'''')
            
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportData',
		@ErrorInProcedure = 'Znode_ImportData',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportGetDefaultFamilyAttribute')
	DROP PROC Znode_ImportGetDefaultFamilyAttribute
GO

CREATE PROCEDURE [dbo].[Znode_ImportGetDefaultFamilyAttribute]
(
	@ImportHeadId			INT = 0,
	@PimAttributeFamilyId	INT = 0,
	@PromotionTypeId		INT = 0
)
AS
/*
	Summary : - This procedure is used to get the default family attribute used in import/export (to download sample format for import) 
	Unit Testing
	EXEC Znode_ImportGetDefaultFamilyAttribute @ImportHeadId = 1, @PimAttributeFamilyId = 1
	EXEC Znode_ImportGetDefaultFamilyAttribute @ImportHeadId = 21, @PimAttributeFamilyId = 0, @PromotionTypeId = 17
	EXEC Znode_ImportGetDefaultFamilyAttribute @ImportHeadId = 21, @PimAttributeFamilyId = 0, @PromotionTypeId = 7
	EXEC Znode_ImportGetDefaultFamilyAttribute @ImportHeadId = 21, @PimAttributeFamilyId = 0, @PromotionTypeId = 13
	EXEC Znode_ImportGetDefaultFamilyAttribute @ImportHeadId = 22, @PimAttributeFamilyId = 0, @PromotionTypeId = 8
*/
 BEGIN 
 BEGIN TRY
	SET NOCOUNT ON

    DECLARE @ImportHead NVARCHAR(100) = (SELECT TOP 1 Name FROM ZnodeImportHead WHERE ImportHeadId = @ImportHeadId)

    DECLARE @DefaultFamilyId INT

	DECLARE @Tlb_AttributeCode TABLE (AttributeCode VARCHAR(300), GroupDisplayOrder INT,DisplayOrder INT)

	DECLARE @Tlb_OtherTemplateData TABLE (AttributeCode NVARCHAR(300), DisplayOrder INT) 

	IF @ImportHead IN ('Product')
	BEGIN 
	  	SET @DefaultFamilyId = dbo.Fn_GetDefaultPimProductFamilyId();
		
		INSERT INTO @Tlb_AttributeCode (AttributeCode,GroupDisplayOrder,DisplayOrder)	
	    SELECT DISTINCT AttributeCode ,ZPFM.GroupDisplayOrder,ZPA.DisplayOrder 
 		FROM ZnodePimAttribute ZPA 
		INNER JOIN ZnodeAttributeType ZAT ON (ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON (ZPFM.PimAttributeId = ZPA.PimAttributeId )
		INNER JOIN ZnodePimAttributeGroup ZPAG ON ZPFM.PimAttributeGroupId = ZPAG.PimAttributeGroupId
		WHERE ZPA.IsCategory = 0  AND PimAttributeFamilyId = @PimAttributeFamilyId 
		
		INSERT INTO @Tlb_AttributeCode (AttributeCode,GroupDisplayOrder,DisplayOrder)	 
		SELECT DISTINCT AttributeCode, ZPFM.GroupDisplayOrder,ZPA.DisplayOrder
		FROM ZnodePimAttribute ZPA 
		INNER JOIN ZnodeAttributeType ZAT ON (ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON (ZPFM.PimAttributeId = ZPA.PimAttributeId )
		INNER JOIN ZnodePimAttributeGroup ZPAG ON ZPFM.PimAttributeGroupId = ZPAG.PimAttributeGroupId
		WHERE ZPA.IsCategory = 0 AND PimAttributeFamilyId = @DefaultFamilyId
			AND AttributeCode NOT IN (SELECT AttributeCode FROM @Tlb_AttributeCode)
		
		SELECT AttributeCode TargetColumnName FROM @Tlb_AttributeCode 
		ORDER BY 
		--ISNULL(GroupDisplayOrder,0) ,ISNULL(DisplayOrder,0)
		CASE WHEN GroupDisplayOrder IS NULL THEN 1 ELSE 0 END , GroupDisplayOrder ,
		CASE WHEN DisplayOrder IS NULL THEN 1 ELSE 0 END , DisplayOrder		
	END
	ELSE IF @ImportHead IN ('Category')
	BEGIN
		SET @DefaultFamilyId = dbo.Fn_GetCategoryDefaultFamilyId();

		INSERT INTO @Tlb_AttributeCode (AttributeCode,DisplayOrder,GroupDisplayOrder)	
		SELECT DISTINCT AttributeCode ,DisplayOrder ,ZPA.DisplayOrder
 		FROM ZnodePimAttribute ZPA 
		INNER JOIN ZnodeAttributeType ZAT ON (ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON (ZPFM.PimAttributeId = ZPA.PimAttributeId )
		WHERE ZPA.IsCategory = 1 AND PimAttributeFamilyId = @PimAttributeFamilyId
		
		INSERT INTO @Tlb_AttributeCode (AttributeCode,DisplayOrder,GroupDisplayOrder) 
		SELECT DISTINCT AttributeCode ,DisplayOrder ,ZPA.DisplayOrder
 		FROM ZnodePimAttribute ZPA 
		INNER JOIN ZnodeAttributeType ZAT ON (ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON (ZPFM.PimAttributeId = ZPA.PimAttributeId )
		WHERE ZPA.IsCategory = 1  AND PimAttributeFamilyId = @DefaultFamilyId
			AND AttributeCode NOT IN (SELECT AttributeCode FROM @Tlb_AttributeCode)

		SELECT AttributeCode TargetColumnName FROM @Tlb_AttributeCode 
		ORDER BY 
		CASE WHEN GroupDisplayOrder IS NULL THEN 1 ELSE 0 END , GroupDisplayOrder ,
		CASE WHEN DisplayOrder IS NULL THEN 1 ELSE 0 END , DisplayOrder		
	END 
	ELSE
	BEGIN
		INSERT INTO @Tlb_OtherTemplateData (AttributeCode,DisplayOrder)
		SELECT DISTINCT ZiA.AttributeCode,ZiA.SequenceNumber FROM ZnodeImportAttributeValidation ZiA
		WHERE ZiA.importHeadId = @ImportHeadId
			AND ZiA.AttributeCode NOT IN (SELECT AttributeCode FROM @Tlb_OtherTemplateData)
			
		IF @ImportHead IN ('B2BCustomer')
		BEGIN
			INSERT INTO @Tlb_OtherTemplateData (AttributeCode,DisplayOrder)
			SELECT ZGA.AttributeCode, ZGA.DisplayOrder
			FROM ZnodeGlobalGroupEntityMapper zggem 
			INNER JOIN ZnodeGlobalEntity ZGE ON zggem.GlobalEntityId = ZGE.GlobalEntityId
			INNER JOIN ZnodeGlobalAttributeGroupMapper ZGAGM ON  zggem.GlobalAttributeGroupId = ZGAGM.GlobalAttributeGroupId
			INNER JOIN ZnodeGlobalAttribute ZGA ON ZGAGM.GlobalAttributeId = ZGA.GlobalAttributeId  
			WHERE ZGE.EntityName = 'User' AND ZGA.AttributeCode NOT IN (SELECT AttributeCode FROM @Tlb_OtherTemplateData )
		END

		ELSE IF @ImportHead IN ('Promotions')
		BEGIN
			DECLARE	@DiscountTypeName NVARCHAR(500) = (SELECT TOP 1 [Name] FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId)
			
			INSERT INTO @Tlb_OtherTemplateData (AttributeCode,DisplayOrder)
			SELECT DISTINCT AttributeCode, 999 As DisplayOrder
			FROM ZnodePromotionAttribute 
			WHERE PromotionAttributeId IN (SELECT PromotionAttributeId FROM ZnodePromotionDiscountAttributeMapper WHERE DiscountTypeName=@DiscountTypeName)
				AND AttributeCode NOT IN (SELECT AttributeCode FROM @Tlb_OtherTemplateData);
		END
			 
		SELECT AttributeCode TargetColumnName FROM @Tlb_OtherTemplateData ORDER BY DisplayOrder
	END
	END TRY

	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportGetDefaultFamilyAttribute 
					@ImportHeadId = '+CAST(@ImportHeadId AS VARCHAR(max))+',
					@PimAttributeFamilyId='+CAST(@PimAttributeFamilyId AS VARCHAR(50))+',
					@PromotionTypeId='+CAST(@PromotionTypeId AS VARCHAR(50))+',
					@Status='+CAST(@Status AS VARCHAR(10));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportGetDefaultFamilyAttribute',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportGetTemplateMapping')
	DROP PROC Znode_ImportGetTemplateMapping
GO

CREATE PROCEDURE dbo.Znode_ImportGetTemplateMapping
(
	@ImportTemplateId		INT = 0,
	@PimAttributeFamilyId	INT = 0,
	@PromotionTypeId		INT = 0
)
AS
/*
	Summary : - This procedure is used to get template mapping details used in import.  
	Unit Testing
	EXEC Znode_ImportGetTemplateMapping @ImportTemplateId = 33, @PimAttributeFamilyId = 0, @PromotionTypeId = 17
	EXEC Znode_ImportGetTemplateMapping @ImportTemplateId = 33, @PimAttributeFamilyId = 0, @PromotionTypeId = 7
	EXEC Znode_ImportGetTemplateMapping @ImportTemplateId = 33, @PimAttributeFamilyId = 0, @PromotionTypeId = 13
	EXEC Znode_ImportGetTemplateMapping @ImportTemplateId = 33, @PimAttributeFamilyId = 0, @PromotionTypeId = 8
*/
 BEGIN 
	BEGIN TRY
	SET NOCOUNT ON
		DECLARE	@DiscountTypeName NVARCHAR(500) = (SELECT TOP 1 Name FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId);

		SELECT ImportTemplateMappingId, ImportTemplateId, SourceColumnName, TargetColumnName, DisplayOrder, IsActive, IsAllowNull, 
			CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
		FROM ZnodeImportTemplateMapping
		WHERE ImportTemplateId = @ImportTemplateId

		UNION

		SELECT 999999 As PromotionAttributeId, @ImportTemplateId AS AttributeTypeId, AttributeCode As SourceColumnName, AttributeCode As TargetColumnName,
			0 As DisplayOrder, CAST(0 AS BIT) AS IsActive, CAST(0 AS BIT)  As IsAllowNull, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
		FROM ZnodePromotionAttribute 
		WHERE PromotionAttributeId IN (SELECT PromotionAttributeId FROM ZnodePromotionDiscountAttributeMapper WHERE DiscountTypeName=@DiscountTypeName)
			AND NOT EXISTS (SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId = @ImportTemplateId AND TargetColumnName=ZnodePromotionAttribute.AttributeCode)
		ORDER BY ImportTemplateMappingId ASC
	END TRY

	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportGetTemplateMapping 
					@ImportTemplateId = '+CAST(@ImportTemplateId AS VARCHAR(max))+',
					@PimAttributeFamilyId='+CAST(@PimAttributeFamilyId AS VARCHAR(50))+',
					@PromotionTypeId='+CAST(@PromotionTypeId AS VARCHAR(50));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportGetTemplateMapping',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPromotions')
	DROP PROC Znode_ImportPromotions
GO

CREATE PROCEDURE [dbo].[Znode_ImportPromotions]
(
	@TableName			NVARCHAR(100),
	@Status				BIT,
	@UserId				INT,
	@ImportProcessLogId	INT,
	@NewGUId			NVARCHAR(200),
	@LocaleId			INT=1,
	@CsvColumnString	NVARCHAR(MAX),
	@PromotionTypeId	INT
)
AS
/*
	Summary :  Made a provision to import Promotions details.
	
	Unit Testing: 
		EXEC dbo.Znode_ImportPromotions @TableName='',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId='',@LocaleId=1,
			@CsvColumnString=,@PromotionTypeId=17

	SELECT @TableName='##Temp',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId=NEWID(),@LocaleId=1,
			@CsvColumnString='PromoCode,Name,Description,StartDate,EndDate,DisplayOrder,Store,Profile,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,AvailableQuantity
				,DiscountAmount,MinimumQuantity,MinimumOrderAmount,Brand',
			@PromotionTypeId=17
*/
BEGIN
	SET NOCOUNT ON;
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(MAX);

		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

		DECLARE @GetDate1 VARCHAR(100) = CONVERT(VARCHAR(30),@GetDate,121)
		DECLARE @ImportProcessLogId1 VARCHAR(100) = CAST(@ImportProcessLogId AS VARCHAR)
		DECLARE @UserId1 VARCHAR(15) = CAST(@UserId AS VARCHAR(15))

		IF ISNULL(@LocaleId,0)=0
		BEGIN
			SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		END

		DECLARE @LocaleId1 VARCHAR(15) = CAST(@LocaleId AS VARCHAR(15))

		IF OBJECT_ID('tempdb..##Promotions') IS NOT NULL
			DROP TABLE ##Promotions

		SET @SSQL='CREATE TABLE ##Promotions (RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT , '+
			REPLACE(TRIM(LTRIM(@CsvColumnString)), ',' ,' NVARCHAR(MAX),') + CASE WHEN @CsvColumnString = '' THEN '' ELSE ' NVARCHAR(MAX)' END+', GUID NVARCHAR(400)) 
			INSERT INTO ##Promotions (RowNumber,' + @CsvColumnString + ',GUID) 
			SELECT ROW_NUMBER() OVER (ORDER BY PromoCode) As RowNumber,' + @CsvColumnString + ','''+@NewGUId+''' As GUID FROM '+ @TableName +'
			'
		
		EXEC (@SSQL)
		IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PortalId')
		BEGIN
			ALTER TABLE ##Promotions ADD PortalId INT

			UPDATE ##Promotions SET PortalId=NULL

			UPDATE P
			SET P.PortalId = CASE WHEN LTRIM(TRIM(P.Store))='All Stores' THEN NULL ELSE ZP.PortalId END
			FROM ##Promotions P
			INNER JOIN ZnodePortal ZP ON P.Store=ZP.StoreCode
		END

		IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProfileId')
		BEGIN
			ALTER TABLE ##Promotions ADD ProfileId INT

			UPDATE ##Promotions SET ProfileId=NULL

			UPDATE P
			SET P.ProfileId = CASE WHEN LTRIM(TRIM(P.Profile))='All Profiles' THEN NULL ELSE ZP.ProfileId END
			FROM ##Promotions P
			INNER JOIN ZnodeProfile ZP ON P.Profile=ZP.ProfileName
		END

		IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PromotionTypeId')
		BEGIN
			ALTER TABLE ##Promotions ADD PromotionTypeId INT
			UPDATE ##Promotions
			SET PromotionTypeId = @PromotionTypeId
		END

		IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='IsUnique')
		BEGIN
			ALTER TABLE ##Promotions ADD IsUnique BIT
			UPDATE ##Promotions
			SET IsUnique = 0
		END

		IF OBJECT_ID('tempdb..#DuplicatePromotionsData') IS NOT NULL
			DROP TABLE #DuplicatePromotionsData;

		UPDATE ##Promotions
		SET IsCouponRequired=0
		WHERE ISNULL(IsCouponRequired,'')='';

		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0
		WHERE ISNULL(IsAllowedWithOtherCoupons,'')='';

		UPDATE ##Promotions
		SET IsCouponRequired=1
		WHERE ISNULL(IsCouponRequired,'')='Yes';

		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=1
		WHERE ISNULL(IsAllowedWithOtherCoupons,'')='Yes';

		-- Code for not consider Discount Information for specific Promotion Type
		DECLARE @PromotionTypeName NVARCHAR(50);

		SELECT TOP 1 @PromotionTypeName = [Name] FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId;

		IF @PromotionTypeName IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price')
		BEGIN
			UPDATE ##Promotions
			SET IsAllowedWithOtherCoupons=0, IsCouponRequired=1, PromotionMessage='';
		END
		ELSE IF @PromotionTypeName IN ('Call For Pricing')
		BEGIN
			UPDATE ##Promotions
			SET IsAllowedWithOtherCoupons=0, IsCouponRequired=1;
		END

		SELECT PromoCode
		INTO #DuplicatePromotionsData
		FROM ##Promotions
		GROUP BY PromoCode
		HAVING COUNT(*) > 1;

	BEGIN TRAN Promotions;
	BEGIN TRY

		-- Start Functional Validation
		-----------------------------------------------
		INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.PromoCode,'')=''

		INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '53', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE EXISTS (SELECT * FROM #DuplicatePromotionsData bd WHERE bd.PromoCode=ii.PromoCode)
			--AND NOT EXISTS (SELECT * FROM ZnodePromotion zbd INNER JOIN #DuplicatePromotionsData bd ON bd.PromoCode=zbd.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '82', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE LEN(LTRIM(RTRIM(ii.PromoCode))) > 300 AND ISNULL(ii.PromoCode,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.[Name],'')=''
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '78', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE LEN(LTRIM(RTRIM(ii.[Name]))) > 100 AND ISNULL(ii.[Name],'')<>''
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '78', 'Description', Description, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE LEN(LTRIM(RTRIM(ii.Description))) > 100 AND ISNULL(ii.Description,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISDATE(ii.StartDate)=0
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '150', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISDATE(ii.StartDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)<CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),111),111))
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '151', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.StartDate,'')=''
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '5', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISDATE(ii.EndDate)=0
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '152', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.EndDate,'')=''
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.DisplayOrder,0)=0
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '149', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNUMERIC(ii.DisplayOrder)=0
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISNUMERIC(ii.DisplayOrder)=1 AND (CAST(ii.DisplayOrder As INT))>999)
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '120', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.PortalId,0)<>0
			AND NOT EXISTS (SELECT * FROM ZnodePortal WHERE PortalId=ii.PortalId)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.PortalId,0)=0 AND (ISNULL(ii.Store,'')<>'All Stores' OR ISNULL(ii.Store,'')='')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '153', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.ProfileId,0)<>0
			AND NOT EXISTS (SELECT * FROM ZnodePortalProfile WHERE ProfileId=ii.ProfileId AND PortalId=ii.PortalId AND ISNULL(ii.Profile,'')<>'All Profiles')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '78', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE LEN(LTRIM(RTRIM(ii.Profile))) > 100 AND ISNULL(ii.Profile,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.ProfileId,0)=0 AND (ISNULL(ii.Profile,'')<>'All Profiles' OR ISNULL(ii.Profile,'')='')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '142', 'IsCouponRequired', IsCouponRequired, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes','FALSE','0','No')
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '142', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') NOT IN ('True','1','Yes','FALSE','0','No')
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '154', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') IN ('True','1','Yes')
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.PromotionMessage,'')<>''
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '82', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISNULL(ii.PromotionMessage,'')<>'' AND LEN(LTRIM(RTRIM(ii.PromotionMessage)))>300)
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '138', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.Code,'')<>''
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
			AND EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code=ii.Code)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '139', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISNULL(ii.Code,'')<>'' AND LEN(LTRIM(RTRIM(ii.Code)))>20)
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '8', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE ISNULL(ii.Code,'')=''
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '4', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISNUMERIC(ii.AvailableQuantity)=0)
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '141', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND ii.AvailableQuantity%1<>0)
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
		SELECT '140', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM ##Promotions AS ii
		WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ISNULL(ii.AvailableQuantity,0)<0 OR ISNULL(ii.AvailableQuantity,0)>9999))
			AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

		-- Validations for Dynamic Attributes
		DECLARE @DiscountTypeName NVARCHAR(500), @SQL NVARCHAR(MAX), @AttributeCode  NVARCHAR(MAX)='';

		SET @DiscountTypeName=(SELECT TOP 1 Name FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId);

		SELECT @AttributeCode=STRING_AGG( PA.AttributeCode , ',')
		--PA.AttributeCode
		FROM ZnodePromotionAttribute PA
		INNER JOIN ZnodePromotionDiscountAttributeMapper PDAM ON PDAM.PromotionAttributeId = PA.PromotionAttributeId
			AND PDAM.DiscountTypeName=@DiscountTypeName--'Amount off Brand'
		--INNER JOIN ZnodePromotionAttribute PA ON PDAM.PromotionAttributeId = PA.PromotionAttributeId
		WHERE NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='ZnodePromotion' AND COLUMN_NAME = PA.AttributeCode)
			AND EXISTS (SELECT TOP 1 1 FROM tempdb.sys.columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name = PA.AttributeCode);	

		IF OBJECT_ID('tempdb..#PromotionAttributeData') IS NOT NULL 
			DROP TABLE #PromotionAttributeData;

		CREATE TABLE #PromotionAttributeData 
			(RowNumber INT,PromoCode NVARCHAR(300),AttributeCode NVARCHAR(300),AttributeValue NVARCHAR(MAX));

		SET @SQL =' 
					SELECT RowNumber,PromoCode,AttributeCode,AttributeValue
					FROM ##Promotions 
					UNPIVOT
					( AttributeValue For AttributeCode IN ('+@AttributeCode+')
					) UNPIVOT8
					'

		INSERT INTO #PromotionAttributeData (RowNumber,PromoCode,AttributeCode,AttributeValue)   
		EXEC SYS.SP_SQLEXEC @SQL;

		ALTER TABLE #PromotionAttributeData ADD AttributeTypeName VARCHAR(200), ValidationName VARCHAR(600), ValidationValue VARCHAR(600);
		
		UPDATE A
		SET A.AttributetypeName=C.AttributeTypeName, ValidationName = d.name, ValidationValue =  e.Name
		FROM #PromotionAttributeData A
		INNER JOIN ZnodePromotionAttribute B ON (B.AttributeCode=A.AttributeCode)
		INNER JOIN ZnodeAttributeType C ON (C.AttributeTypeId=B.AttributeTypeId)
		INNER JOIN ZnodeAttributeInputValidation d ON (d.AttributeTypeId = c.AttributeTypeId )
		INNER JOIN ZnodePromotionAttributeValidation e ON (e.InputValidationId = d.InputValidationId AND b.PromotionAttributeId = e.PromotionAttributeId)

		INSERT INTO ZnodeImportLog
			(ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)  
		SELECT --dbo.Fn_ValidateData (ii.AttributetypeName,ii.AttributeValue,ii.ValidationName, ii.ValidationValue),
		dbo.Fn_ValidateDataErrorCode(ii.AttributetypeName,ii.ValidationName ), ii.AttributeCode, ii.AttributeValue, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #PromotionAttributeData AS ii  
		WHERE dbo.Fn_ValidateData (ii.AttributetypeName,ii.AttributeValue,ii.ValidationName, ii.ValidationValue)=0

		DECLARE @Query NVARCHAR(MAX);

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='DiscountAmount')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''108'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DiscountAmount)=0 AND LEN(ii.DiscountAmount)>0)
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''137'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND LEN(PARSENAME(ii.DiscountAmount,1))>2)
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''155'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (ii.DiscountAmount) LIKE ''%.%.%'')
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
		
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''136'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (ii.DiscountAmount)>100)
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''8'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.DiscountAmount,'''')=''''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			'
			EXEC SP_EXECUTESQL @Query;
		END
		
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumQuantity')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''108'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ISNUMERIC(ii.MinimumQuantity)=0
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''141'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (ii.MinimumQuantity) LIKE ''%.%'')
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''136'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (ii.MinimumQuantity)>100)
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''8'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.MinimumQuantity,'''')=''''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumOrderAmount')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''108'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ISNUMERIC(ii.MinimumOrderAmount)=0
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''137'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND LEN(PARSENAME(ii.MinimumOrderAmount,1))>2)
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''155'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (ii.MinimumOrderAmount) LIKE ''%.%.%'')
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			--INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			--SELECT ''136'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			--FROM ##Promotions AS ii
			--WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (ii.MinimumOrderAmount)>100)
			--	AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
		
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''8'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.MinimumOrderAmount,'''')=''''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
			'
			EXEC SP_EXECUTESQL @Query;
		END
		
		IF EXISTS (SELECT TOP 1 1 FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='CallForPriceMessage')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''78'', ''CallForPriceMessage'', CallForPriceMessage, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.CallForPriceMessage))) > 100
			'
			EXEC SP_EXECUTESQL @Query;
		END


		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''143'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD INNER JOIN ZnodePortalBrand PB ON BD.BrandId = PB.BrandId AND PB.PortalId = ii.PortalId WHERE BD.BrandCode=ii.Brand)
				AND ISNULL(ii.Brand,'''')<>''''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''94'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Brand))) > 100
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''144'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE NOT EXISTS (	SELECT * FROM ZnodePimCatalog PC
								INNER JOIN ZnodePublishCatalog PbC ON PC.PimCatalogId=PbC.PimCatalogId
								INNER JOIN ZnodePortalCatalog PtC ON PbC.PublishCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
								WHERE PC.CatalogCode = ii.Catalog)
				AND ISNULL(ii.Catalog,'''')<>''''
				
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''94'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Catalog))) > 100
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''145'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE NOT EXISTS (	SELECT * FROM ZnodePimCategory PC
								INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PC.PimCategoryId=PCAV.PimCategoryId
								INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL ON PCAV.PimCategoryAttributeValueId=PCAVL.PimCategoryAttributeValueId
								INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
								INNER JOIN ZnodePimCategoryHierarchy PCH ON PC.PimCategoryId=PCH.PimCategoryId
								INNER JOIN ZnodePimCatalog PCt ON PCH.PimCatalogId=PCt.PimCatalogId
								INNER JOIN ZnodePublishCatalog PbC ON PCt.PimCatalogId=PbC.PimCatalogId
								INNER JOIN ZnodePortalCatalog PtC ON PbC.PublishCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
								WHERE LocaleId='+@LocaleId1+' AND PCAVL.CategoryValue=ii.Category)
				AND ISNULL(ii.Category,'''')<>''''
				
				
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''94'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Category))) > 100
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''146'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
								INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
								INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
								INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
								INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
								INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
								WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.ProductToDiscount AND PC.PortalId=ii.PortalId)
				AND ISNULL(ii.ProductToDiscount,'''')<>''''
				
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''94'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.ProductToDiscount))) > 100
			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''147'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ((LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''% %'')
				AND ISNULL(ii.ProductToDiscount,'''')<>''''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''148'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE NOT EXISTS (	SELECT * FROM ZnodeShipping SP
								INNER JOIN ZnodePortalShipping PS ON SP.ShippingId=PS.ShippingId
								WHERE SP.ShippingCode=ii.Shipping AND PS.PortalId=ii.PortalId)
				AND ISNULL(ii.Shipping,'''')<>''''
				
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''94'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Shipping))) > 100
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''146'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
								INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
								INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
								INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
								INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
								INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
								WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.ProductToDiscount AND PC.PortalId=ii.PortalId)
				AND ISNULL(ii.ProductToDiscount,'''')<>''''
				
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''94'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.ProductToDiscount))) > 100
			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''147'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ((LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''% %'')
				AND ISNULL(ii.ProductToDiscount,'''')<>''''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct')
		BEGIN
			SET @Query='
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''146'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
								INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
								INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
								INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
								INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
								INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
								WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.RequiredProduct AND PC.PortalId=ii.PortalId)
				AND ISNULL(ii.RequiredProduct,'''')<>''''
				
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''94'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.RequiredProduct))) > 100
			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT ''147'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
			FROM ##Promotions AS ii
			WHERE ((LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''% %'')
				AND ISNULL(ii.RequiredProduct,'''')<>''''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName --+ ' [ Promotion - ' + ISNULL(PromoCode,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN ##Promotions IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		 --Delete Invalid Data after functional validatin
		DELETE FROM ##Promotions
		WHERE RowNumber IN
		(
			SELECT DISTINCT RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
		);
	
		-- Update Record count in log
		DECLARE @FailedRecordCount BIGINT;
		DECLARE @SuccessRecordCount BIGINT;

		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber)
		FROM ZnodeImportLog 
		WHERE RowNumber IS NOT NULL AND ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) 
		FROM ##Promotions

		UPDATE ZnodeImportProcessLog
		SET FailedRecordcount = @FailedRecordCount ,
			SuccessRecordCount = @SuccessRecordCount ,
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'DiscountAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.DiscountAmount'', ''Discount'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
			PRINT @Query
		END
		
		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumQuantity'', ''QuantityMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumOrderAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumOrderAmount'', ''OrderMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--For Update Promotions Data
		DECLARE @UpdateColumns NVARCHAR (MAX);
		SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME),',') 
		--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
		FROM INFORMATION_SCHEMA.COLUMNS
		WHERE TABLE_NAME='ZnodePromotion'
			AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
			AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsCouponRequired','IsAllowedWithOtherCoupons','IsUnique');

		IF OBJECT_ID('tempdb..#UpdatedPromotions') IS NOT NULL
			DROP TABLE #UpdatedPromotions;

		CREATE TABLE #UpdatedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		SET @Query='
		UPDATE ZP SET '+@UpdateColumns+'
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #UpdatedPromotions (PromotionId, PromoCode, PromotionTypeId)
		FROM ##Promotions P
		INNER JOIN ZnodePromotion ZP ON LTRIM(RTRIM(P.PromoCode)) = ZP.PromoCode
		'
		EXEC SP_EXECUTESQL @Query;

		--For Insert Promotions Data
		DECLARE @MatchesColumns NVARCHAR (MAX);

		SELECT @MatchesColumns=STRING_AGG(COLUMN_NAME,',') FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME='ZnodePromotion'
			AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'));

		IF OBJECT_ID('tempdb..#InsertedPromotions') IS NOT NULL
			DROP TABLE #InsertedPromotions;

		CREATE TABLE #InsertedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		-- Import New Promotions
		SET @MatchesColumns='
		INSERT INTO ZnodePromotion
			('+@MatchesColumns+',CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			)
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #InsertedPromotions (PromotionId, PromoCode, PromotionTypeId)
		SELECT '+@MatchesColumns+','+CAST(@UserId AS VARCHAR(15))+',GETDATE(),'+CAST(@UserId AS VARCHAR(15))+',GETDATE()
		FROM ##Promotions
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode = LTRIM(RTRIM(##Promotions.PromoCode)))
		'

		EXEC SP_EXECUTESQL @MatchesColumns;

		-- Insert for ZnodePromotionCoupon
		SET @Query='
		INSERT INTO ZnodePromotionCoupon
			(PromotionId,Code,InitialQuantity,AvailableQuantity,IsActive,IsCustomCoupon,CustomCouponCode,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPs.PromotionId, P.Code, P.AvailableQuantity, P.AvailableQuantity, 1, 0, '''', '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		WHERE ISNULL(P.IsCouponRequired,'''') IN (''True'',''1'',''Yes'')
			AND NOT EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code = P.Code)
		'
		EXEC SP_EXECUTESQL @Query;

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand')
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT IPs.PromotionId, BD.BrandId, P.Brand, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON P.Brand=BD.BrandCode
			WHERE ISNULL(BD.BrandId,0)<>0
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog')
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT IPs.PromotionId, PbC.PublishCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCatalog PC ON P.Catalog=PC.CatalogCode
			INNER JOIN ZnodePublishCatalog PbC ON PC.PimCatalogId=PbC.PimCatalogId
			WHERE ISNULL(PbC.PublishCatalogId,0)<>0
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category')
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT IPs.PromotionId, MIN(PbC.PublishCategoryId), '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId
			INNER JOIN ZnodePublishCategory PbC ON PC.PimCategoryId=PbC.PimCategoryId
			WHERE ISNULL(PbC.PublishCategoryId,0)<>0
			GROUP BY IPs.PromotionId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT IPs.PromotionId, MIN(PP.PublishProductId), '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON P.ProductToDiscount=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			INNER JOIN ZnodePublishProduct PP ON PAV.PimProductId=PP.PimProductId
			WHERE ISNULL(PP.PublishProductId,0)<>0
			GROUP BY IPs.PromotionId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping')
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON P.Shipping=SP.ShippingCode
			--INNER JOIN ZnodePortalShipping PS ON SP.ShippingId=PS.ShippingId
			WHERE ISNULL(SP.ShippingId,0)<>0
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
		--BEGIN
		--	SET @Query='
		--	INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
		--	SELECT IPs.PromotionId, PP.PublishProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		--	FROM #InsertedPromotions IPs 
		--	INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		--	INNER JOIN ZnodePimAttributeValueLocale PAVL ON P.ProductToDiscount=PAVL.AttributeValue
		--	INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
		--	INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
		--	INNER JOIN ZnodePublishProduct PP ON PAV.PimProductId=PP.PimProductId
		--	'
		--	EXEC SP_EXECUTESQL @Query;
		--END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct')
		BEGIN
			SET @Query='
			UPDATE ZP
			SET ZP.PromotionProductQuantity=P.ProductQuantity, ZP.ReferralPublishProductId=PP.PublishProductId, ModifiedDate='''+@GetDate1+'''
			FROM ZnodePromotion ZP
			INNER JOIN #InsertedPromotions IPs ON ZP.PromotionId=IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON P.RequiredProduct=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			INNER JOIN ZnodePublishProduct PP ON PAV.PimProductId=PP.PimProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Promotions;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Promotions

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPromotions
					@TableName = '+CAST(@TableName AS VARCHAR(MAX)) +',
					@Status='+ CAST(@Status AS VARCHAR(10))+',
					@UserId = '+CAST(@UserId AS VARCHAR(50))+',
					@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',
					@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',
					@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
					@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(MAX))+',
					@PromotionTypeId='+CAST(@PromotionTypeId AS VARCHAR(20));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog 
		SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , 
			SuccessRecordCount = 0,
			TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPromotions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   
	@ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0,
	@PromotionTypeId	INT=0
)
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

BEGIN
    BEGIN TRY
        SET NOCOUNT ON;
        --BEGIN TRAN TRN_ImportValidProductData;
        DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
        DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
		@CsvColumnString nvarchar(max),
		@FailedRecordCount BIGINT,
		@SuccessRecordCount BIGINT
    --To get the total record count for update purpose in catch block
    SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
	INSERT INTO Znode_ImportCsvRowCount
	EXEC (@SQLQuery) 

        DECLARE @FamilyAttributeDetail TABLE
        (PimAttributeId       INT,
        AttributeTypeName    VARCHAR(300),
        AttributeCode        VARCHAR(300),
        SourceColumnName     NVARCHAR(600),
        IsRequired           BIT,
        PimAttributeFamilyId INT
        );
        DECLARE @AttributeDetail TABLE
        (PimAttributeId    INT,
        AttributeTypeName VARCHAR(300),
        AttributeCode     VARCHAR(300),
        SourceColumnName  NVARCHAR(600),
        IsRequired        BIT,
        ControlName       VARCHAR(300),
        ValidationName    VARCHAR(100),
        SubValidationName VARCHAR(300),
        ValidationValue   VARCHAR(300),
        RegExp            VARCHAR(300)
        );

	CREATE TABLE #DefaultAttributeCode
	(AttributeTypeName          VARCHAR(300),
	PimAttributeDefaultValueId INT,
	PimAttributeId             INT,
	AttributeDefaultValueCode  VARCHAR(100)
	);

	IF( @ImportHeadName = 'B2BCustomer' )
	BEGIN
		EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
	END
		
        DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
        IF NOT EXISTS
        (
            SELECT TOP 1 1
            FROM INFORMATION_SCHEMA.TABLES
            WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
        )
            CREATE TABLE #InvalidDefaultData
            (RowNumber  INT,
            Value      NVARCHAR(MAX),
            ColumnName NVARCHAR(600)
            );
        ELSE
        DROP TABLE #InvalidDefaultData;
        IF NOT EXISTS
        (
            SELECT TOP 1 1
            FROM INFORMATION_SCHEMA.TABLES
            WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
        )
            BEGIN

                SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
			(select database_id from sys.databases where name = ''tempdb''))';
                CREATE TABLE #GlobalTempTableColumns
                (ColumnName   NVARCHAR(MAX),
                TypeOfImport NVARCHAR(100)
                );
                INSERT INTO #GlobalTempTableColumns
                (ColumnName,
                TypeOfImport
                )
                EXEC sys.sp_sqlexec
                    @SQLQuery;
            END;

        IF EXISTS
        (
            SELECT TOP 1 1
            FROM #GlobalTempTableColumns
            WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
        )
            BEGIN
                INSERT INTO ZnodeImportLog
                (ErrorDescription,
                ColumnName,
                Data,
                GUID,
                CreatedBy,
                CreatedDate,
                ModifiedBy,
                ModifiedDate,
                ImportProcessLogId
                )
                VALUES
                (43,
                '',
                '',
                @newGUID,
                @UserId,
                @GetDate,
                @UserId,
                @GetDate,
                @ImportProcessLogId
                );
            END;
        SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

        IF NOT EXISTS
        (
            SELECT TOP 1 1  FROM ZnodeImportLog
            WHERE Guid = @NewGUID
                AND ErrorDescription IN(43, 42)
            AND ImportProcessLogId = @ImportProcessLogId
        )
            BEGIN
                IF @ImportHeadName = 'Product'
                BEGIN
					IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
						SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
					ELSE 
						SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
					EXEC sys.sp_sqlexec @SQLQuery;
			    END;
                ELSE
                IF @ImportHeadName = 'Category'
                    BEGIN
						IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
						SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
						ElSE
						SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
						EXEC sys.sp_sqlexec @SQLQuery;
                    END;
                ELSE
                    BEGIN
					IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
						SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
					Else 
						SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
					EXEC sys.sp_sqlexec @SQLQuery;
                    END;;
            END;

        SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

        SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
        IF @DefaultFamilyId = 0
        AND @ImportHeadName IN('Product', 'Category')
            BEGIN 
                --Get all default attribute values in attribute 
                INSERT INTO @FamilyAttributeDetail
                (PimAttributeId,
                AttributeTypeName,
                AttributeCode,
                SourceColumnName,
                IsRequired,
                PimAttributeFamilyId
                )
                --Call Process to insert data of defeult family with source column name and target column name 
                EXEC Znode_ImportGetTemplateDetails
                    @TemplateId = @TemplateId,
                    @IsValidationRules = 0,
                    @IsIncludeRespectiveFamily = 1,
                    @IsCategory = @IsCategory,
                    @DefaultFamilyId = @DefaultFamilyId;

			---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
			Delete FAD from @FamilyAttributeDetail FAD
			where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
			and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					        inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
            END;
        ELSE
        IF @ImportHeadName IN('Product', 'Category')
            BEGIN
				 
                --Get all default attribute values in attribute 
                INSERT INTO @FamilyAttributeDetail
                (PimAttributeId,
                AttributeTypeName,
                AttributeCode,
                SourceColumnName,
                IsRequired,
                PimAttributeFamilyId
                )
                --Call Process to insert data of defeult family with source column name and target column name 
                EXEC Znode_ImportGetTemplateDetails
                    @TemplateId = @TemplateId,
                    @IsValidationRules = 0,
                    @IsIncludeRespectiveFamily = 1,
                    @IsCategory = @IsCategory,
                    @DefaultFamilyId = @DefaultFamilyId;

			---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
			Delete FAD from @FamilyAttributeDetail FAD
			where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
			and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					        inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
            END;      
        -- Check attributes are manditory and not provided with source table
		   	 
	if @TABLENAME	like '%tempdb..%'
		SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
	else 
		SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
	 
	Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )
	IF @ImportHeadName = 'Promotions'
	BEGIN
			
		INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName)
		EXEC Znode_ImportGetDefaultFamilyAttribute @importHeadId=@importHeadId,@PimAttributeFamilyId=0,@PromotionTypeId=@PromotionTypeId
	END
	ELSE
	BEGIN
		INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
		SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
		FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
		ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
		LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
		and ZIAV.AttributeCode = ZITM.TargetColumnName
		AND ZITM.ImportTemplateId  = @TemplateId
		WHERE ZIAV.ImportHeadId = @ImportHeadId
		AND ISNULL(ZITM.SourceColumnName,'') <> ''--ORDER BY ZIAV.SequenceNumber
	END

	SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


    INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
        )
        EXEC sys.sp_sqlexec  @SQLQuery;
        IF NOT EXISTS
        (
            SELECT TOP 1 1
            FROM ZnodeImportLog
            WHERE Guid = @NewGUID
                AND ErrorDescription IN(43, 42)
            AND ImportProcessLogId = @ImportProcessLogId
        )
            BEGIN
                --Get all default attribute values in attribute 
                IF @ImportHeadName IN('Product', 'Category')
                    BEGIN
                        -- Check attributes are manditory and not provided with source table
                        INSERT INTO ZnodeImportLog
                        (ErrorDescription,
                        ColumnName,
                        Data,
                        GUID,
                        CreatedBy,
                        CreatedDate,
                        ModifiedBy,
                        ModifiedDate,
                        ImportProcessLogId
                        )
                            SELECT '14' AS ErrorDescription,
                                    AttributeCode,
                                    '',
                                    @NewGUID,
                                    @UserId,
                                    @GetDate,
                                    @UserId,
                                    @GetDate,
                                    @ImportProcessLogId
                            FROM @FamilyAttributeDetail
                            WHERE ISNULL(SourceColumnName, '') = ''
                                    AND IsRequired = 1;  

                        -- Read all attribute details with their datatype
                        INSERT INTO @AttributeDetail
                        (PimAttributeId,
                        AttributeTypeName,
                        AttributeCode,
                        SourceColumnName,
                        IsRequired,
                        ControlName,
                        ValidationName,
                        SubValidationName,
                        ValidationValue,
                        RegExp
                        )
                        EXEC Znode_ImportGetTemplateDetails
                            @TemplateId=@TemplateId,
							@DefaultFamilyId=@DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @AttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
									inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                        DELETE FROM @AttributeDetail
                        WHERE AttributeTypeName = 'Image'
                            AND ValidationName <> 'IsAllowMultiUpload';
					DELETE FROM @AttributeDetail
                        WHERE AttributeTypeName = 'File'
                            AND ValidationName <> 'IsAllowMultiUpload';

                                INSERT INTO #DefaultAttributeCode
                                (AttributeTypeName,
                                PimAttributeDefaultValueId,
                                PimAttributeId,
                                AttributeDefaultValueCode
                                )
                                --Call Process to insert default data value 
                                EXEC Znode_ImportGetPimAttributeDefaultValue;

                                DELETE FROM #DefaultAttributeCode
                                WHERE AttributeTypeName = 'Yes/No';

                    END;
                ELSE
                    BEGIN
					
					
                        --Read all attribute details with their datatype
                        INSERT INTO @AttributeDetail
                        (AttributeTypeName,
                        AttributeCode,
                        SourceColumnName,
                        IsRequired,
                        ControlName,
                        ValidationName,
                        SubValidationName,
                        ValidationValue,
                        RegExp
                        )
                        EXEC [Znode_ImportGetOtherTemplateDetails]
                            @TemplateId = @TemplateId,
                            @ImportHeadId = @ImportHeadId;

					IF @ImportHeadName IN('B2BCustomer')
					BEGIN

						INSERT INTO @AttributeDetail
							(PimAttributeId,
							AttributeTypeName,
							AttributeCode,
							SourceColumnName,
							IsRequired,
							ControlName,
							ValidationName,
							SubValidationName,
							ValidationValue,
							RegExp
							)
							EXEC [Znode_ImportGetGlobalTemplateDetails]
								@TemplateId = @TemplateId,
								@ImportHeadId = @ImportHeadId;

								
						INSERT INTO #DefaultAttributeCode
						(AttributeTypeName,
						PimAttributeDefaultValueId,
						PimAttributeId,
						AttributeDefaultValueCode
						)
						--Call Process to insert default data value 
						EXEC Znode_ImportGetGlobalAttributeDefaultValue;

						DELETE FROM #DefaultAttributeCode
						WHERE AttributeTypeName = 'Yes/No';

					END
						
                        --Check attributes are not mapped with any family of Pim Product
                        INSERT INTO ZnodeImportLog
                        (ErrorDescription,
                        ColumnName,
                        Data,
                        GUID,
                        CreatedBy,
                        CreatedDate,
                        ModifiedBy,
                        ModifiedDate,
                        ImportProcessLogId
                        )
                            SELECT DISTINCT
                                    '14' AS ErrorDescription,
                                    AttributeCode,
                                    '',
                                    @NewGUID,
                                    @UserId,
                                    @GetDate,
                                    @UserId,
                                    @GetDate,
                                    @ImportProcessLogId
                            FROM @AttributeDetail
                            WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                    END;
						
                --	Check attributes are not mapped with (Default / Other) family of Pim Product
                --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                --	Verify data in global temporary table (column wise)
					
                DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                FOR SELECT PimAttributeId,
                        AttributeTypeName,
                        AttributeCode,
                        IsRequired,
                        SourceColumnName,
                        ControlName,
                        ValidationName,
                        SubValidationName,
                        ValidationValue,
                        RegExp
                    FROM @AttributeDetail
                    WHERE ISNULL(SourceColumnName, '') <> '';
                OPEN Cr_Attribute;
                FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                WHILE @@FETCH_STATUS = 0
                    BEGIN
				        IF @AttributeTypeName = 'Number'
                            BEGIN
							EXEC Znode_ImportValidateNumber
                                    @TableName = @TableName,
                                    @SourceColumnName = @SourceColumnName,
                                    @CreateDateString = @CreateDateString,
                                    @ValidationName = @ValidationName,
                                    @ControlName = @ControlName,
                                    @ValidationValue = @ValidationValue,
                                    @NewGUID = @NewGUID,
                                    @ImportHeadId = @ImportHeadId,
                                    @ImportProcessLogId = @ImportProcessLogId;
                            END;
						-- Check invalid date
							
                        IF @AttributeTypeName = 'Date'
                            BEGIN
                                EXEC Znode_ImportValidateDate
                                    @TableName = @TableName,
                                    @SourceColumnName = @SourceColumnName,
                                    @CreateDateString = @CreateDateString,
                                    @ValidationName = @ValidationName,
                                    @ControlName = @ControlName,
                                    @ValidationValue = @ValidationValue,
                                    @NewGUID = @NewGUID,
                                    @ImportHeadId = @ImportHeadId,
                                    @ImportProcessLogId = @ImportProcessLogId;
                            END;
						-- Check Manditory Data
		 				IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
						BEGIN
							SET @CheckedSourceColumn = @SourceColumnName;
							EXEC Znode_ImportValidateMandatoryData
							@TableName = @TableName,
							@SourceColumnName = @SourceColumnName,
							@CreateDateString = @CreateDateString,
							@ValidationName = @ValidationName,
							@ControlName = @ControlName,
							@ValidationValue = @ValidationValue,
							@NewGUID = @NewGUID,
							@ImportHeadId = @ImportHeadId;
						END;
						--END 
							
                        IF @AttributeTypeName = 'Text'
                            BEGIN
								 
						        EXEC Znode_ImportValidateManditoryText
                                    @TableName = @TableName,
                                    @SourceColumnName = @SourceColumnName,
                                    @CreateDateString = @CreateDateString,
                                    @ValidationName = @ValidationName,
                                    @ControlName = @ControlName,
                                    @ValidationValue = @ValidationValue,
                                    @NewGUID = @NewGUID,
                                    @LocaleId = @LocaleId,
                                    @DefaultLocaleId = @DefaultLocaleId,
                                    @AttributeId = @AttributeId,
                                    @ImportProcessLogId = @ImportProcessLogId,
                                    @ImportHeadId = @ImportHeadId;
                            END;
                        IF @AttributeTypeName in ( 'Image','File')
                            BEGIN
                                EXEC Znode_ImportValidateImageData
                                    @TableName = @TableName,
                                    @SourceColumnName = @SourceColumnName,
                                    @CreateDateString = @CreateDateString,
                                    @ValidationName = @ValidationName,
                                    @ControlName = @ControlName,
                                    @ValidationValue = @ValidationValue,
                                    @NewGUID = @NewGUID,
                                    @LocaleId = @LocaleId,
                                    @DefaultLocaleId = @DefaultLocaleId,
                                    @AttributeId = @AttributeId,
                                    @ImportProcessLogId = @ImportProcessLogId,
                                    @ImportHeadId = @ImportHeadId;
                            END;

					

                        --Check Default data value is valid 
                        IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                            BEGIN
                                IF @AttributeId IN
                                (
                                    SELECT PimAttributeId
                                    FROM #DefaultAttributeCode
                                )
                                    BEGIN
							
                                    IF  @AttributeTypeName = 'Multi Select'
										BEGIN
										 	---Verify Image file is exists in media table or not 
											SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
											SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
											(Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
											DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
											' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
											)), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
											+ ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
										EXEC sys.sp_sqlexec @SQLQuery;
										END
										ELSE IF @AttributeTypeName = 'Simple Select'
										BEGIN
						
										---Verify Image file is exists in media table or not 
											SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
											SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
											+ ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
											NOT EXISTS 
											(Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
											DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
											' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
										EXEC sys.sp_sqlexec @SQLQuery;
										END   
										-- Check Invalid Image 
											SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
											Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
											INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
											EXEC sys.sp_sqlexec @SQLQuery;
											Delete from #InvalidDefaultData

       
                                    END;
                            END;
							
                        FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                    END;
                CLOSE Cr_Attribute;
                DEALLOCATE Cr_Attribute;
                --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
            END;
             
			 
			  
------------------------------------------------------------------------------------------
	Declare @SQLQueryNew NVARCHAR(4000)
	Declare @SourceColumnNameProduct nvarchar(4000) 
    IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
	BEGIN
		 	 
	SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
	AND ImportTemplateId = @TemplateId


	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;			
END
ELSE IF @ImportHeadName IN('ProductAttribute')
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'ZipCode'
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'Category'
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'CategoryAssociation'
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;

END
ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'SEODetails'
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'Highlight'
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'AddonAssociation'
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'AttributeDefaultValue'
BEGIN
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
AND ImportTemplateId = @TemplateId

	SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
	FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
	WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
    PRINT @SQLQueryNew
	EXEC sys.sp_sqlexec  @SQLQueryNew;
END
ELSE IF @ImportHeadName = 'Brands'  
BEGIN  
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'BrandCode'  
AND ImportTemplateId = @TemplateId  
  
    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  BrandCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''   
    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber   
    WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';  
    PRINT @SQLQueryNew  
    EXEC sys.sp_sqlexec  @SQLQueryNew;  
END  

ELSE IF @ImportHeadName = 'Promotions'  
BEGIN  
SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'PromoCode'  
AND ImportTemplateId = @TemplateId  
  
    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  PromoCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(300)) +' + ''' ]''   
    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber   
    WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';  
    PRINT @SQLQueryNew  
    EXEC sys.sp_sqlexec  @SQLQueryNew;  
END 
-------------------------------------------------------------------------------------------------------------
	
--------------------------------------------------------------------------------------------------------------------
			 
SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
        IF @ImportHeadName IN('Product', 'Category')
            BEGIN
                IF NOT EXISTS
                (
                    SELECT TOP 1 1
                    FROM @FamilyAttributeDetail
                    WHERE ISNULL(SourceColumnName, '') = ''
                        AND IsRequired = 1
                ) AND NOT EXISTS
				(
					SELECT TOP 1 1
					FROM ZnodeImportLog
					WHERE Guid = @NewGUID
						AND ErrorDescription IN(43, 42)
					AND ImportProcessLogId = @ImportProcessLogId
				)
                    BEGIN
                        IF @IsCategory = 0
                            BEGIN

                                EXEC Znode_ImportPimProductData
                                    @TableName = @TableName,
                                    @NewGUID = @NewGUID,
                                    @TemplateId = @TemplateId,
                                    @ImportProcessLogId = @ImportProcessLogId,
                                    @UserId = @UserId,
                                    @LocaleId = @LocaleId,
                                    @DefaultFamilyId = @DefaultFamilyId;

                            END;
                        ELSE
                            BEGIN
                                EXEC Znode_ImportPimCategoryData
                                    @TableName = @TableName,
                                    @NewGUID = @NewGUID,
                                    @TemplateId = @TemplateId,
                                    @ImportProcessLogId = @ImportProcessLogId,
                                    @UserId = @UserId,
                                    @LocaleId = @LocaleId,
                                    @DefaultFamilyId = @DefaultFamilyId;
                            END;
                    END
					ELSE
					BEGIN
						-- Update Record count in log 
								
							
						--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
						--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
						--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
						--WHERE ImportProcessLogId = @ImportProcessLogId;

						SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
						SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
						EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
						UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
						WHERE ImportProcessLogId = @ImportProcessLogId;
					END

            END;
		IF NOT EXISTS
				(
					SELECT TOP 1 1
					FROM ZnodeImportLog
					WHERE Guid = @NewGUID
						AND ErrorDescription IN(43, 42)
					AND ImportProcessLogId = @ImportProcessLogId
				)
        BEGIN
            IF @ImportHeadName = 'Pricing'
                BEGIN
                    EXEC [Znode_ImportPriceList]
                        @TableName = @TableName,
                        @Status = @Status,
                        @UserId = @UserId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID = @NewGUID,
                        @PriceListId = @PriceListId;
                END;

            IF @ImportHeadName = 'Inventory'
                BEGIN
				
                    EXEC Znode_ImportInventory_Ver1
                        @TableName = @TableName,
                        @Status = @Status,
                        @UserId = @UserId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID = @NewGUID;
                END;
            IF @ImportHeadName = 'ZipCode'
                BEGIN
					EXEC Znode_ImportZipCode
                        @TableName = @TableName,
                        @Status = @Status,
                        @UserId = @UserId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID = @NewGUID,
						@CountryCode = @CountryCode;
                END;
				IF @ImportHeadName = 'CategoryAssociation'
                BEGIN
					EXEC Znode_ImportCatalogCategory
                        @TableName = @TableName,
                        @Status = @Status,
                        @UserId = @UserId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID = @NewGUID,
						@PimCatalogId = @PimCatalogId;
                END;
				IF @ImportHeadName = 'ProductAssociation'
                BEGIN
					EXEC Znode_ImportAssociateProducts
                        @TableName = @TableName,
                        @Status = @Status,
                        @UserId = @UserId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID = @NewGUID
                END;
			
				IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                BEGIN
					EXEC Znode_ImportSEODetails
                        @TableName = @TableName,
                        @Status = @Status,
                        @UserId = @UserId,
						@LocaleId = @LocaleId,
						@PortalId =@PortalId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString 

				
                END;
				
				IF @ImportHeadName = 'ProductAttribute' 
                BEGIN
					EXEC Znode_ImportAttributes
                        @TableName = @TableName,
                        @Status = @Status,
                        @UserId = @UserId,
						@ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID = @NewGUID
				
                END;

				IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                BEGIN
					
					EXEC Znode_ImportCustomer
                        @TableName = @TableName,
                        @Status	 = @Status,
                        @UserId	 = @UserId,
						@LocaleId	 = @LocaleId,
						@PortalId  = @PortalId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID	 = @NewGUID,
						@CsvColumnString =@CsvColumnString
				
                END;
					 
				IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                BEGIN
					EXEC Znode_ImportUserApproval
                        @TableName = @TableName,
                        @Status	 = @Status,
                        @UserId	 = @UserId,
						@LocaleId	 = @LocaleId,
						@PortalId  = @PortalId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID	 = @NewGUID,
						@CsvColumnString =@CsvColumnString
				
                END;

				IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                BEGIN

						EXEC Znode_ImportB2BCustomer
                        @TableName = @TableName,
                        @Status	 = @Status,
                        @UserId	 = @UserId,
						@LocaleId	 = @LocaleId,
						@PortalId  = @PortalId,
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID	 = @NewGUID,
						@CsvColumnString =@CsvColumnString
				
                END;

				IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                BEGIN
					EXEC Znode_ImportCustomerAddress
                        @TableName = @TableName,
                        @Status	 = @Status,
                        @UserId	 = @UserId,
						@LocaleId	 = @LocaleId,
						--@PortalId  = 7, -- not implemented from forntend 
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID	 = @NewGUID,
						@CsvColumnString =@CsvColumnString,
						@IsAccountAddress = @IsAccountAddress
				
                END;
				IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                BEGIN
					EXEC Znode_ImportCustomerAddress
                        @TableName = @TableName,
                        @Status	 = @Status,
                        @UserId	 = @UserId,
						@LocaleId	 = @LocaleId,
						--@PortalId  = 7, -- not implemented from forntend 
                        @ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID	 = @NewGUID,
						@CsvColumnString =@CsvColumnString,
						@IsAccountAddress = @IsAccountAddress
				
                END;
				IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                BEGIN
					EXEC Znode_ImportStoreLocatorAddress
                        @TableName = @TableName,
                        @Status	 = @Status,
                        @UserId	 = @UserId,
						@ImportProcessLogId = @ImportProcessLogId,
                        @NewGUID	 = @NewGUID,
						@CsvColumnString =@CsvColumnString
                END;

			IF @ImportHeadName = 'Highlight'
			BEGIN
			EXEC Znode_ImportHighlight 
			@TableName = @TableName, 
			@Status = @Status, 
			@UserId = @UserId, 
			@ImportProcessLogId = @ImportProcessLogId, 
			@NewGUID = @NewGUID 
			END;

			IF @ImportHeadName = 'AddonAssociation'
			BEGIN
			EXEC Znode_ImportAddonAssociation 
			@TableName = @TableName, 
			@Status = @Status, 
			@UserId = @UserId, 
			@ImportProcessLogId = @ImportProcessLogId, 
			@NewGUID = @NewGUID,
			@PimCatalogId = @PimCatalogId
			END;

			IF @ImportHeadName = 'AttributeDefaultValue'
			BEGIN
			EXEC Znode_ImportAttributeDefaultValue 
			@TableName = @TableName, 
			@Status = @Status, 
			@UserId = @UserId, 
			@ImportProcessLogId = @ImportProcessLogId, 
			@NewGUID = @NewGUID
					
			END;

			IF @ImportHeadName = 'Voucher'
			BEGIN
				EXEC Znode_ImportVoucher 
				@TableName = @TableName, 
				@Status = @Status, 
				@UserId = @UserId, 
				@ImportProcessLogId = @ImportProcessLogId, 
				@NewGUID = @NewGUID
					
			END;

			IF @ImportHeadName = 'Account'
			BEGIN
						
				EXEC Znode_ImportAccount 
				@TableName = @TableName, 
				@Status = @Status, 
				@UserId = @UserId, 
				@ImportProcessLogId = @ImportProcessLogId, 
				@NewGUID = @NewGUID,
				@CsvColumnString = @CsvColumnString,
				@PortalId = @PortalId
					
			END;

			IF @ImportHeadName = 'Synonyms'
			BEGIN
				EXEC Znode_ImportSynonyms 
				@TableName = @TableName, 
				@Status = @Status, 
				@UserId = @UserId, 
				@ImportProcessLogId = @ImportProcessLogId, 
				@NewGUID = @NewGUID
			END

			IF @ImportHeadName = 'CatalogCategoryAssociation'
			BEGIN
				EXEC Znode_ImportCatalogCategoryHierarchyAssociation 
				@TableName = @TableName, 
				@Status = @Status, 
				@UserId = @UserId, 
				@ImportProcessLogId = @ImportProcessLogId, 
				@NewGUID = @NewGUID,
				@PimCatalogId = @PimCatalogId
			END
				 

            IF @ImportHeadName = 'Brands'
			BEGIN
				EXEC Znode_ImportBrands 
				@TableName = @TableName, 
				@Status = @Status, 
				@UserId = @UserId, 
				@ImportProcessLogId = @ImportProcessLogId, 
				@NewGUID = @NewGUID,
				@LocaleId	 = @LocaleId,
                @CsvColumnString = @CsvColumnString
			END;

			IF @ImportHeadName = 'Promotions'
			BEGIN
				EXEC Znode_ImportPromotions 
				@TableName = @TableName,
				@Status = @Status, 
				@UserId = @UserId, 
				@ImportProcessLogId = @ImportProcessLogId, 
				@NewGUID = @NewGUID,
				@LocaleId	 = @LocaleId,
                @CsvColumnString = @CsvColumnString,
				@PromotionTypeId = @PromotionTypeId
			END;
				 
        END
		ELSE 
			BEGIN
			-- Update Record count in log 	
			SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
			SELECT @SuccessRecordCount = 0
									
			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
			WHERE ImportProcessLogId = @ImportProcessLogId;

			END

        EXEC Znode_ImportReadErrorLog
            @ImportProcessLogId = @ImportProcessLogId,
            @NewGUID = @NewGUID;
        DROP TABLE #GlobalTempTableColumns;

        -- Finally call product insert process if error not found in error log table 
        IF EXISTS
        (
            SELECT TOP 1 1
            FROM ZnodeImportLog
            WHERE ImportProcessLogId = @ImportProcessLogId
                AND Guid = @NewGUID
        )
            BEGIN
            --Updating the import process status
			UPDATE ZnodeImportProcessLog
			SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
								WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
								WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
							END, 
				ProcessCompletedDate = getdate()
			WHERE ImportProcessLogId = @ImportProcessLogId;
            END;
			SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;

			print 'end';
    END TRY
    BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
		DECLARE @TempCount TABLE (Id INT)

		Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
		INSERT INTO @TempCount
		EXEC (@SQL)

			SELECT ERROR_MESSAGE(),
				ERROR_LINE(),
				ERROR_PROCEDURE();
			EXEC Znode_ImportReadErrorLog
				@ImportProcessLogId = @ImportProcessLogId,
				@NewGUID = @NewGUID; 
             
			---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		SET @SQLQuery = 'Drop Table ' + @TableName
		EXEC sys.sp_sqlexec @SQLQuery;
			--ROLLBACK TRAN TRN_ImportValidProductData;
    END CATCH;
END;

GO

-- ZnodeImportHead
INSERT INTO ZnodeImportHead
	([Name],IsUsedInImport,IsUsedInDynamicReport,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsCsvUploader)
SELECT 'Promotions', 1, 0, 1, 2, GETDATE(), 2, GETDATE(), NULL
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportHead WHERE [Name] = 'Promotions')

-- ZnodeImportTemplate
INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Brand', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Brand')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Brand'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Brand'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Brand', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Brand')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Brand'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Brand'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Catalog', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Catalog')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Catalog'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Catalog'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Catalog', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Catalog')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Catalog'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Catalog'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Category', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Category')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Category'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Category'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Category', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Category')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Category'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Category'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Displayed Product Price', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Displayed Product Price')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Displayed Product Price'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Displayed Product Price'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Displayed Product Price', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Displayed Product Price')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Displayed Product Price'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Displayed Product Price'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Order', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Order')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Order'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Order'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Order', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Order')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Order'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Order'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Product', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Product')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Product'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Product'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Product', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Product')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Product'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Product'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Shipping', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Shipping')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Shipping'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Shipping'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Shipping', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Shipping')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Shipping'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Shipping'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off Shipping with carrier', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Shipping with carrier')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off Shipping with carrier'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off Shipping with carrier'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off Shipping with carrier', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Shipping with carrier')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off Shipping with carrier'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off Shipping with carrier'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Amount Off X If Y Purchased', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off X If Y Purchased')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Amount Off X If Y Purchased'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Amount Off X If Y Purchased'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Percent Off X If Y Purchased', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off X If Y Purchased')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Percent Off X If Y Purchased'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Percent Off X If Y Purchased'))

INSERT INTO ZnodeImportTemplate
	(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, PromotionTypeId)
SELECT
	(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions'),
	'Call For Pricing', NULL, NULL, 1, 2, GETDATE(), 2, GETDATE(),
	(SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Call For Pricing')
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplate 
				WHERE ImportHeadId = (SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name] = 'Promotions') AND TemplateName = 'Call For Pricing'
					AND PromotionTypeId = (SELECT TOP 1 PromotionTypeId FROM ZnodePromotionType WHERE [Name] = 'Call For Pricing'))

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Brand'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'Brand' As SourceColumnName, 'Brand' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'Brand' AND TargetColumnName = 'Brand')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Brand')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Brand'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'Brand' As SourceColumnName, 'Brand' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'Brand' AND TargetColumnName = 'Brand')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Brand')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Catalog'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'Catalog' As SourceColumnName, 'Catalog' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'Catalog' AND TargetColumnName = 'Catalog')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Catalog')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Catalog'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'Catalog' As SourceColumnName, 'Catalog' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'Catalog' AND TargetColumnName = 'Catalog')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Catalog')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Category'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'Category' As SourceColumnName, 'Category' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'Category' AND TargetColumnName = 'Category')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Category')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Category'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'Category' As SourceColumnName, 'Category' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'Category' AND TargetColumnName = 'Category')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Category')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Displayed Product Price'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price'),
	'ProductToDiscount' As SourceColumnName, 'ProductToDiscount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Displayed Product Price')
					AND SourceColumnName = 'ProductToDiscount' AND TargetColumnName = 'ProductToDiscount')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Displayed Product Price'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price'),
	'ProductToDiscount' As SourceColumnName, 'ProductToDiscount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Displayed Product Price')
					AND SourceColumnName = 'ProductToDiscount' AND TargetColumnName = 'ProductToDiscount')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Order'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Order')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Order'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Order')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Product'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product'),
	'ProductToDiscount' As SourceColumnName, 'ProductToDiscount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Product')
					AND SourceColumnName = 'ProductToDiscount' AND TargetColumnName = 'ProductToDiscount')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Product'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product'),
	'ProductToDiscount' As SourceColumnName, 'ProductToDiscount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Product')
					AND SourceColumnName = 'ProductToDiscount' AND TargetColumnName = 'ProductToDiscount')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Shipping'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Shipping'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off Shipping with carrier'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier'),
	'Shipping' As SourceColumnName, 'Shipping' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off Shipping with carrier')
					AND SourceColumnName = 'Shipping' AND TargetColumnName = 'Shipping')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off Shipping with carrier'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'MinimumOrderAmount' As SourceColumnName, 'MinimumOrderAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'MinimumOrderAmount' AND TargetColumnName = 'MinimumOrderAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier'),
	'Shipping' As SourceColumnName, 'Shipping' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off Shipping with carrier')
					AND SourceColumnName = 'Shipping' AND TargetColumnName = 'Shipping')

-- ZnodeImportTemplateMapping, TemplateName = 'Amount Off X If Y Purchased'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'ProductQuantity' As SourceColumnName, 'ProductQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'ProductQuantity' AND TargetColumnName = 'ProductQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'ProductToDiscount' As SourceColumnName, 'ProductToDiscount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'ProductToDiscount' AND TargetColumnName = 'ProductToDiscount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased'),
	'RequiredProduct' As SourceColumnName, 'RequiredProduct' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Amount Off X If Y Purchased')
					AND SourceColumnName = 'RequiredProduct' AND TargetColumnName = 'RequiredProduct')

-- ZnodeImportTemplateMapping, TemplateName = 'Percent Off X If Y Purchased'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'DiscountAmount' As SourceColumnName, 'DiscountAmount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'DiscountAmount' AND TargetColumnName = 'DiscountAmount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'MinimumQuantity' As SourceColumnName, 'MinimumQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'MinimumQuantity' AND TargetColumnName = 'MinimumQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'ProductQuantity' As SourceColumnName, 'ProductQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'ProductQuantity' AND TargetColumnName = 'ProductQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'ProductToDiscount' As SourceColumnName, 'ProductToDiscount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'ProductToDiscount' AND TargetColumnName = 'ProductToDiscount')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased'),
	'RequiredProduct' As SourceColumnName, 'RequiredProduct' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Percent Off X If Y Purchased')
					AND SourceColumnName = 'RequiredProduct' AND TargetColumnName = 'RequiredProduct')

-- ZnodeImportTemplateMapping, TemplateName = 'Call For Pricing'
INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'PromoCode' As SourceColumnName, 'PromoCode' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'PromoCode' AND TargetColumnName = 'PromoCode')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'Name' As SourceColumnName, 'Name' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'Name' AND TargetColumnName = 'Name')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'Description' As SourceColumnName, 'Description' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'Description' AND TargetColumnName = 'Description')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'StartDate' As SourceColumnName, 'StartDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'StartDate' AND TargetColumnName = 'StartDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'EndDate' As SourceColumnName, 'EndDate' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'EndDate' AND TargetColumnName = 'EndDate')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'DisplayOrder' As SourceColumnName, 'DisplayOrder' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'DisplayOrder' AND TargetColumnName = 'DisplayOrder')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'Store' As SourceColumnName, 'Store' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'Store' AND TargetColumnName = 'Store')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'Profile' As SourceColumnName, 'Profile' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'Profile' AND TargetColumnName = 'Profile')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'IsCouponRequired' As SourceColumnName, 'IsCouponRequired' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'IsCouponRequired' AND TargetColumnName = 'IsCouponRequired')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'IsAllowedWithOtherCoupons' As SourceColumnName, 'IsAllowedWithOtherCoupons' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'IsAllowedWithOtherCoupons' AND TargetColumnName = 'IsAllowedWithOtherCoupons')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'PromotionMessage' As SourceColumnName, 'PromotionMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'PromotionMessage' AND TargetColumnName = 'PromotionMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'Code' As SourceColumnName, 'Code' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'Code' AND TargetColumnName = 'Code')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'AvailableQuantity' As SourceColumnName, 'AvailableQuantity' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'AvailableQuantity' AND TargetColumnName = 'AvailableQuantity')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'CallForPriceMessage' As SourceColumnName, 'CallForPriceMessage' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'CallForPriceMessage' AND TargetColumnName = 'CallForPriceMessage')

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing'),
	'ProductToDiscount' As SourceColumnName, 'ProductToDiscount' As TargetColumnName, 0 As DisplayOrder, 1 As IsActive, 0 As IsAllowNull,
		2 As CreatedBy, GETDATE() As CreatedDate, 2 As ModifiedBy, GETDATE() As ModifiedDate
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
				WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'Call For Pricing')
					AND SourceColumnName = 'ProductToDiscount' AND TargetColumnName = 'ProductToDiscount')

GO

--ZnodeImportAttributeValidation
INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','PromoCode',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Text','RegularExpression',
NULL,300,'',NULL,2,GETDATE(),2,GETDATE(),1
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'PromoCode' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Name',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Text','RegularExpression',
NULL,100,'',NULL,2,GETDATE(),2,GETDATE(),2
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'Name' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Description',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Text','RegularExpression',
NULL,100,'',NULL,2,GETDATE(),2,GETDATE(),3
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'Description' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Date','StartDate',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Date','MinDate',
NULL,'','',NULL,2,GETDATE(),2,GETDATE(),4
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Date' AND AttributeCode = 'StartDate' 
      AND ControlName = 'Date' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'MinDate')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Date','EndDate',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Date','MinDate',
NULL,'','',NULL,2,GETDATE(),2,GETDATE(),5
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Date' AND AttributeCode = 'EndDate' 
      AND ControlName = 'Date' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'MinDate')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','DisplayOrder',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Yes/No','AllowNegative',
NULL,'false','',NULL,2,GETDATE(),2,GETDATE(),6
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'DisplayOrder' 
      AND ControlName = 'Yes/No' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'AllowNegative')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','DisplayOrder',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Yes/No','AllowDecimals',
NULL,'false','',NULL,2,GETDATE(),2,GETDATE(),6
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'DisplayOrder' 
      AND ControlName = 'Yes/No' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'AllowDecimals')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','DisplayOrder',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Number','MinNumber',
NULL,'0','',NULL,2,GETDATE(),2,GETDATE(),6
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'DisplayOrder' 
      AND ControlName = 'Number' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'MinNumber')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','DisplayOrder',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Number','MaxNumber',
NULL,'999999','',NULL,2,GETDATE(),2,GETDATE(),6
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'DisplayOrder' 
      AND ControlName = 'Number' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'MaxNumber')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Store',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Text','RegularExpression',
NULL,100,'',NULL,2,GETDATE(),2,GETDATE(),7
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'Store' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Profile',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),1,'Text','RegularExpression',
NULL,100,'',NULL,2,GETDATE(),2,GETDATE(),8
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'Profile' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','IsCouponRequired',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Text','RegularExpression',
NULL,'','',NULL,2,GETDATE(),2,GETDATE(),9
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'IsCouponRequired' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','IsAllowedWithOtherCoupons',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Text','RegularExpression',
NULL,'','',NULL,2,GETDATE(),2,GETDATE(),10
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'IsAllowedWithOtherCoupons' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','PromotionMessage',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Text','RegularExpression',
NULL,'','',NULL,2,GETDATE(),2,GETDATE(),11
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'PromotionMessage' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Text','Code',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Text','RegularExpression',
NULL,'','',NULL,2,GETDATE(),2,GETDATE(),12
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'Code' 
      AND ControlName = 'Text' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'RegularExpression')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','AvailableQuantity',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Yes/No','AllowNegative',
NULL,'false','',NULL,2,GETDATE(),2,GETDATE(),13
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'AvailableQuantity' 
      AND ControlName = 'Yes/No' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'AllowNegative')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','AvailableQuantity',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Yes/No','AllowDecimals',
NULL,'false','',NULL,2,GETDATE(),2,GETDATE(),13
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'AvailableQuantity' 
      AND ControlName = 'Yes/No' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'AllowDecimals')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','AvailableQuantity',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Number','MinNumber',
NULL,'0','',NULL,2,GETDATE(),2,GETDATE(),13
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'AvailableQuantity' 
      AND ControlName = 'Number' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'MinNumber')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,
		RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','AvailableQuantity',(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions'),0,'Number','MaxNumber',
NULL,'999999','',NULL,2,GETDATE(),2,GETDATE(),13
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'AvailableQuantity' 
      AND ControlName = 'Number' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Promotions')
      AND ValidationName = 'MaxNumber')

GO

-- ZnodeMessage
INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 136,'Text','Input must not exceed the maximum value limit of 100.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 136)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 137,'Text','Only 2 digits are allowed after the decimal point.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 137)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 138,'Text','Input must not be available as a Code saved against any existing Coupon.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 138)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 139,'Text','Input value length must be between 1-20.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 139)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 140,'Text','Input must be an integer value between 1 and 9999.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 140)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 141,'Text','No decimal point is allowed.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 141)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 142,'Text','Input value must either be True/1/Yes or False/0/No.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 142)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 143,'Text','Input must be available as a Code saved against any existing Brand associated to the selected Store.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 143)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 144,'Text','Input must be available as a Code saved against any existing catalog associated to the selected Store.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 144)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 145,'Text','Input must be available as a Code saved against any existing Category associated to the selected Store.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 145)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 146,'Text','Input must be available as a Code saved against any existing Product associated to the selected Store.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 146)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 147,'Text','Multiple SKUs cannot be entered.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 147)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 148,'Text','Input must be any existing Shipping method associated to the selected Store.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 148)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 149,'Text','The field Display Order must be a number.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 149)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 150,'Text','Invalid Date: The entered date precedes the current date.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 150)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 151,'Text','Invaid Date: The entered date exceeds the end date.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 151)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 152,'Text','Invalid Date: The entered date precedes the start date.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 152)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 153,'Text','Input must be available as a Code saved against any existing Profile.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 153)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 154,'Text','Input value cannot be set for this column as the value is not set to TRUE/1/Yes in the Requires a coupon field.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 154)

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 155,'Text','Only 1 decimal point is allowed.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 155)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductJson')
	DROP PROC Znode_GetPublishProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductJson]  
(  
	@PublishCatalogId INT = 0   
	,@PimProductId     TransferId Readonly  
	,@UserId     INT = 0   
	,@PimCatalogId     INT = 0   
	,@VersionIdString  VARCHAR(2000)= ''  
	,@Status     Bit  OutPut  
	,@RevisionState   Varchar(50) = ''  
	,@IsDraftProductsOnly BIT = 1  
)  
WITH RECOMPILE 
AS  
/*  
DECLARE @rrte transferId   
INSERT INTO @rrte  
SELECT 1  
  
EXEC [_POC_Znode_GetPublishProductbulk] @PublishCatalogId=9,@UserId= 2 ,@localeIDs = @rrte,@PublishStateId = 3   
  
*/  
BEGIN  
BEGIN Try   
	SET NOCOUNT ON;  
	SET @Status = 0    
	Declare  @RevisionType VARCHAR(50) = ''   
	Declare @VersionId int = 0   
	DECLARE @PortalId INT = (SELECT TOP 1 POrtalId FROM ZnodePortalCatalog WHERE PublishCatalogId = @PublishCatalogId)  
	DECLARE @PriceListId INT = (SELECT TOP 1 PriceListId FROM ZnodePriceListPortal WHERE PortalId = @PortalId )  
	DECLARE @DomainUrl varchar(max) = (SELECT TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)  
	DECLARE @MaxSmallWidth INT  = (SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)  
	DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()  
  
	DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT , VersionId int,RevisionType varchar(50)  )  
	DECLARE @LocaleIds transferId   

	INSERT INTO @TBL_LocaleId (LocaleId,VersionId,RevisionType)  
	SELECT PV.LocaleId , PV.VersionId , PV.RevisionType  
	FROM ZnodePublishVersionEntity PV INNER JOIN Split(@VersionIdString,',') S ON PV.VersionId = S.Item  

	 --Getting active local for catalog which are associated to store
	INSERT INTO @LocaleIds (Id) 
	SELECT LocaleId FROM DBO.FN_GetCatalogPortalActiveLocale(@PublishCatalogId)
   
	DECLARE --@ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),  
	@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0   
	--,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()  
	DECLARE @GetDate DATETIME =dbo.Fn_GetDate()  
  
	DECLARE @DefaultPortal int, @IsAllowIndexing int  
	SELECT @DefaultPortal = ZPC.PortalId, @IsAllowIndexing = 1 FROM ZnodePimCatalog ZPC INNER JOIN ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId WHERE ZPC1.PublishCatalogId =  @PublishCatalogId AND isnull(ZPC.IsAllowIndexing,0) = 1   
     
	-----DELETE unwanted publish data  
	DELETE ZPC FROM ZnodePublishCategoryProduct ZPC  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategory ZC WHERE ZPC.PublishCategoryId = ZC.PublishCategoryId )  
  
	DELETE ZPP FROM ZnodePublishCategoryProduct ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPP FROM ZnodePublishCatalogProductDetail ZPP  
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishProduct ZP WHERE ZPP.PublishProductId = ZP.PublishProductId )  
  
	DELETE ZPCP FROM ZnodePublishCatalogProductDetail ZPCP  
	INNER JOIN ZnodePublishProduct b on ZPCP.PublishProductId = b.PublishProductId   
	WHERE NOT EXISTS(SELECT * FROM ZnodePimCategoryProduct a  
	INNER JOIN ZnodePimCategoryHierarchy ZPCH on ZPCH.PimCategoryID = a.PimCategoryId   
	WHERE b.PimProductId = A.PimProductId AND ZPCP.PimCategoryHierarchyId = ZPCH.PimCategoryHierarchyId)  
	AND isnull(ZPCP.PimCategoryHierarchyId,0) <> 0 AND b.PublishCatalogId = @PublishCatalogId  
	---------  
  
	DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId )   
  
	CREATE TABLE #ZnodePrice (RetailPrice numeric(28,13),SalesPrice numeric(28,13),CurrencyCode varchar(100), CultureCode varchar(100), CurrencySuffix varchar(100), PublishProductId int)  
   
	CREATE TABLE #ProductSKU (SEOUrl nvarchar(max), SEODescription  nvarchar(max),SEOKeywords  nvarchar(max),SEOTitle  nvarchar(max), PublishProductId int)  
  
	CREATE TABLE #ProductImages (PublishProductId int, ImageSmallPath  varchar(max))  
  
	EXEC Znode_InsertUpdateAttributeDefaultValueJson 1   
	EXEC Znode_InsertUpdateCustomeFieldJson 1   
	EXEC Znode_InsertUpdatePimAttributeJson 1   
  
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN  
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PublishCatalogId   
	END  

	UPDATE ZnodePublishProductEntity SET ElasticSearchEvent = 0

	EXEC [Znode_InsertUpdatePimCatalogProductDetailJson] @PublishCatalogId=@PublishCatalogId,@LocaleId=@LocaleIds ,@UserId=@UserId ,@IsDraftProductsOnly = @IsDraftProductsOnly 


	IF (@IsAllowIndexing=1)  
	BEGIN   
		INSERT INTO #ZnodePrice  
		SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId  
		FROM ZnodePrice ZP   
		INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)  
		INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )  
		INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU )   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)   
		WHERE ZP.PriceListId = @PriceListId   
		AND TY.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP   
		INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
		--+ CAST(@DefaultPortal AS VARCHAr(100)) + '/'  
		INSERT INTO #ProductImages  
		SELECT  TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(@MaxSmallWidth AS VARCHAR(100)) + '/' + RT.MediaPath AS ImageSmallPath     
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)  
		INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )  
		WHERE  TYU.PublishCatalogId = @PublishCatalogId  
		AND RT.LocaleId = @DefaultLocaleId  
		AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
   
		INSERT INTO #ProductSKU   
		SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId  
		FROM ZnodeCMSSEODetail ZCSD   
		INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)  
		INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId)   
		INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)  
		WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product')   
		AND ZCDL.LocaleId = @DefaultLocaleId  
		AND TYU.PublishCatalogId = @PublishCatalogId  
		--AND ZCSD.PublishStateId = @PublishStateId  
		AND ZCSD.PortalId = @DefaultPortal  
		AND EXISTS(SELECT * FROM ZnodePimProduct ZPP1 WHERE TYU.PimProductId = ZPP1.PimProductId )  
  
	END  
   
	CREATE NONCLUSTERED INDEX Idx_#ProductSKU_PublishProductId ON [dbo].[#ProductSKU] ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ProductImages_PublishProductId ON [dbo].#ProductImages ([PublishProductId])  
	CREATE NONCLUSTERED INDEX Idx_#ZnodePrice_PublishProductId ON [dbo].#ZnodePrice ([PublishProductId])  
	
	SELECT DISTINCT PublishProductId, x.LocaleId 
	INTO #PublishProducts 
	FROM ZnodePublishProduct ZPP
	INNER JOIN ##AttributeValueLocale x ON X.PimProductId = ZPP.PimProductId
	WHERE ZPP.PublishCatalogId = @PublishCatalogId

	CREATE INDEX #PublishProducts_PublishProductId on #PublishProducts(PublishProductId,LocaleId)
	--Creating products complete attribute json
	SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex, 
		'[' +  
		(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
		WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = ZPCPD.LocaleId   
		FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
		+ ']' AS ProductXML  
	INTO #ProductAttributeXML  
	FROM [ZnodePublishCatalogProductDetail] ZPCPD   
	INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
	WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId AND ZPCPD.LocaleId = X.LocaleId)
	AND ZPCPD.IsActive = 1 
	GROUP BY ZPP.Pimproductid,ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

	CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_PimProductId_LocaleId  
	ON [dbo].#ProductAttributeXML (PimProductId,LocaleId)  
	
	IF (SELECT COUNT(*) FROM @LocaleIds) > 1
	BEGIN
		--INSERT INTO #ProductAttributeXML(Pimproductid,LocaleId,PublishProductId,ProductXML)
		SELECT ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex,
			'[' +  
			(SELECT STUFF((SELECT ','+ AttributeEntity FROM ##AttributeValueLocale a   
			WHERE a.pimproductid = ZPP.pimproductid AND a.LocaleId = @DefaultLocaleId   
			FOR XML Path (''),Type).value('.', 'varchar(max)') ,1,1,'')  )   
			+ ']' AS ProductXML  
		INTO #ProductAttributeXML_LocaleWise
		FROM [ZnodePublishCatalogProductDetail] ZPCPD   
		INNER JOIN ZnodePublishProduct ZPP ON ZPCPD.PublishProductId = ZPP.PublishProductId AND ZPCPD.PublishCatalogId = ZPP.PublishCatalogId --WHERE TY.PimProductId = ZPP.PimProductId  AND TY.LocaleId = ZPCPD.LocaleId   
		WHERE ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
		AND NOT EXISTS(SELECT * FROM #ProductAttributeXML X WHERE ZPCPD.PublishProductId = X.PublishProductId AND X.LocaleId = ZPCPD.LocaleId )
		AND ZPCPD.LocaleId <> @DefaultLocaleId 
		and ZPCPD.IsActive = 1 
		GROUP BY ZPP.Pimproductid, 
			ZPCPD.PimCatalogProductDetailId,ZPCPD.PublishProductId
			,ZPCPD.PublishCatalogId,ZPCPD.PimCategoryHierarchyId
			,ZPCPD.SKU,ZPCPD.ProductName,ZPCPD.CategoryName,ZPCPD.CatalogName
			,ZPCPD.LocaleId,ZPCPD.IsActive,ZPCPD.ProfileIds,ZPCPD.ProductIndex

		CREATE NONCLUSTERED INDEX Idx_#ProductAttributeXML_LocaleWise_PimProductId_LocaleId  
		ON [dbo].#ProductAttributeXML (PimProductId,LocaleId) 
	END
	


	DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);  
	SELECT @MaxCount = COUNT(*) FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	SELECT @Rows = 50000  
          
	SELECT @MaxCount = CEILING(@MaxCount / @Rows);  
  
	SELECT PimCatalogProductDetailId, PublishProductId,Row_Number() over(Order by PublishProductId) ID into #ZnodePublishCatalogProductDetail 
	FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE PublishCatalogId = @PublishCatalogId  
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)
  
	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
	FROM ZnodePublishProductEntity ZPPAX
	WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
						AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	AND ZPPAX.ZnodeCatalogId = @PublishCatalogId 
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPAX.VersionId = V.VersionId)

	UPDATE ZPPAX SET ZPPAX.ElasticSearchEvent = 2
    FROM ZnodePublishProductEntity ZPPAX Inner join [ZnodePublishCatalogProductDetail] ZLW  
    ON ZPPAX.ZnodeProductId = ZLW.PublishProductId  
    AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId AND ZLW.IsActive = 0  
    AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPAX.VersionId = V.VersionId)

	--Delete products from category from publish tables which are removed from one category and added into other category
	--UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	--WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	--AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	--AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	--AND Not Exists (Select TOP 1 1 From ZnodePublishConfigurableProductEntity X Where X.AssociatedZnodeProductId = ZPPE.ZnodeProductId )
	--AND Isnull(ZPPE.ZnodeCategoryIds ,'') = '0'
	
	UPDATE ZPPE SET ZPPE.ElasticSearchEvent = 2 FROM ZnodePublishProductEntity ZPPE
	WHERE NOT EXISTS(SELECT * FROM ZnodePublishCategoryProduct ZPCP WHERE ZPPE.ZnodeCategoryIds = ZPCP.PublishCategoryId AND ZPPE.ZnodeProductId = ZPCP.PublishProductId
	AND ZPPE.ZnodeCatalogId = ZPCP.PublishCatalogId)
	AND ZPPE.ZnodeCatalogId = @PublishCatalogId
	AND Isnull(ZPPE.ZnodeCategoryIds ,'') <> ''
	AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE ZPPE.VersionId = V.VersionId)


 --   --Delete data which are not present in catalog publish
	--Declare @Batch Bigint
	--SET @Batch = 1;
	--WHILE @Batch > 0
	--BEGIN 
	--	--BEGIN TRAN DelProd
	--		DELETE top (5000)  ZPPAX
	--		from ZnodePublishProductEntity ZPPAX
	--		WHERE NOT EXISTS(SELECT * from [ZnodePublishCatalogProductDetail] ZLW WHERE ZPPAX.ZnodeProductId = ZLW.PublishProductId 
	--							AND ZPPAX.LocaleId = ZLW.LocaleId AND ZPPAX.ZnodeCatalogId = ZLW.PublishCatalogId )
	--		AND ZPPAX.ZnodeCatalogId = @PublishCatalogId  
	--	--COMMIT TRAN DelProd
	--	SET @Batch = @@ROWCOUNT;
	--END
	
	SELECT ZPCP.PublishCategoryId,ZPCP.PublishProductId,ZPCP.PublishCatalogId,ZPCP.PimCategoryHierarchyId,ZPC.PimCategoryId,ZPCCF.PimProductId ,ZPCCF.DisplayOrder
	INTO #TempPublishCategoryProduct
	FROM ZnodePublishCategoryProduct ZPCP 
	INNER JOIN ZnodePublishProduct ZPP ON ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId
	INNER JOIN ZnodePublishCategory ZPC ON (ZPCP.PublishCatalogId = ZPC.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCP.PimCategoryHierarchyId = ZPC.PimCategoryHierarchyId)
	INNER JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	WHERE EXISTS(SELECT * FROM [ZnodePublishCatalogProductDetail] ZPCPD WHERE (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId))		
	AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCP.PublishProductId = X.PublishProductId)
	AND ZPCP.PublishCatalogId = @PublishCatalogId 

	CREATE NONCLUSTERED INDEX Id_#TempPublishCategoryProduct_1 ON #TempPublishCategoryProduct(PublishProductId,PublishCatalogId,PimCategoryHierarchyId)

	IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL  
		DROP TABLE #Temp_ImportLoop;  
          
	---- To get the min AND max rows for import in loop  
	;WITH cte AS   
	(  
		SELECT RowId = 1,   
		MinRow = 1,   
		MaxRow = cast(@Rows as int)  
		UNION ALL  
		SELECT RowId + 1,   
		MinRow + cast(@Rows as int),   
		MaxRow + cast(@Rows as int)  
		FROM cte  
		WHERE RowId + 1 <= @MaxCount  
	)  
	SELECT RowId, MinRow, MaxRow  
	INTO #Temp_ImportLoop  
	FROM cte  
	OPTION (maxrecursion 0);  

	DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD  
	FOR SELECT MinRow, MaxRow, B.LocaleId , B.RevisionType  ,b.VersionId
	FROM #Temp_ImportLoop L  
	CROSS APPLY @TBL_LocaleId B;  
  
	OPEN cur_BulkData;  
	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
		IF OBJECT_ID('TEMPDB..#ProductEntity') IS NOT NULL
				DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#ProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #ProductEntity_LocaleWise
			
		SELECT   
			CAST(@VersionId AS VARCHAR(50)) VersionId --1   
			,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2  
			,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3   
			,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4   
			,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5   
			--'{"Attributes":[' + PAX.ProductXML + ']'  
			,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6  
			,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7   
			,@RevisionType RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8   
			ZPCPD.ProductIndex,  -- 9  
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode ,   
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,  
			Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,  
			Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,  
			CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU--, z.Id    		
		INTO #ProductEntity
		FROM #ProductAttributeXML ZPCPD  
		INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)  
		--INNER JOIN #ProductAttributeXML PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId   
		LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)  
		LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
		WHERE ZPCPD.LocaleId = @LocaleId  
		AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
		AND ZPCPD.PublishCatalogId = @PublishCatalogId  
		AND EXISTS(SELECT * FROM #PublishProducts X WHERE ZPCPD.PublishProductId = X.PublishProductId)

		CREATE INDEX Idx_#ProductEntity ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

		UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
			A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
			A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
			A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
			A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
			--A.ElasticSearchEvent = 1
			A.ElasticSearchEvent = Case When B.IsActive =1 Then  1 else 2 End 
		FROM ZnodePublishProductEntity A
		INNER JOIN #ProductEntity B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
		AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

		INSERT INTO ZnodePublishProductEntity (  
			VersionId, --1  
			IndexId, --2   
			ZnodeProductId,ZnodeCatalogId, --3  
			SKU,LocaleId, --4   
			Name,ZnodeCategoryIds, --5  
			IsActive,Attributes,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)  
		SELECT VersionId, --1  
			IndexId, --2   
			PublishProductId,PublishCatalogId, --3  
			SKU,LocaleId, --4   
			ProductName,PublishCategoryId, --5  
			IsActive,ProductXML,Brands,CategoryName, --6   
			CatalogName,DisplayOrder, --7   
			RevisionType,AssociatedProductDisplayOrder, --8  
			ProductIndex,--9  
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SEODescriptionForIndex,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,Lower_SKU,1 AS ElasticSearchEvent
		FROM #ProductEntity B
		WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
			AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
			--select * from #ProductEntity where PublishProductId = 191 
		IF @LocaleId <> @DefaultLocaleId
		BEGIN
			SELECT 
				CAST(@VersionId AS VARCHAR(50)) VersionId --1 
				,CAST(ZPCPD.ProductIndex AS VARCHAr(100)) + CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50))  + CAST(Isnull(ZPCPD.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) IndexId  --2
				,CAST(ZPCPD.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPCPD.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId  --3 
				,CAST(ISNULL(ZPCPD.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(ZPCPD.LocaleId,'') AS VARCHAR(50)) LocaleId -- 4 
				,CAST(isnull(ZPCPD.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCP.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
				,CAST(ISNULL(ZPCPD.IsActive ,'0') AS VARCHAR(50)) IsActive ,ZPCPD.ProductXML,'[]' Brands,CAST(isnull(ZPCPD.CategoryName,'') AS NVARCHAR(2000)) CategoryName  --6
				,CAST(Isnull(ZPCPD.CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCP.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 7 
				,@RevisionType as RevisionType, 0 AssociatedProductDisplayOrder,-- pending  -- 8 
				ZPCPD.ProductIndex,  -- 9
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.SalesPrice  AS VARCHAr(500)),'') else '' end SalesPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(CAST(TBZP.RetailPrice  AS VARCHAr(500)),'') else '' end RetailPrice , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CultureCode ,'') else '' end CultureCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencySuffix ,'') else '' end CurrencySuffix , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBZP.CurrencyCode ,'') else '' end CurrencyCode , 
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEODescription,'') else '' end SEODescriptionForIndex,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOKeywords,'') else '' end SEOKeywords,
				Case When @IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPS.SEOUrl ,'') else '' end SEOUrl,
				Case When @IsAllowIndexing = 1 then  ISNULL(TBPI.ImageSmallPath,'') else '' end ImageSmallPath,
				CAST(ISNULL(LOWER(ZPCPD.SKU) ,'') AS NVARCHAR(2000)) Lower_SKU
			INTO #ProductEntity_LocaleWise
			FROM #ProductAttributeXML_LocaleWise ZPCPD
			INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPCPD.PublishCatalogId)
			--INNER JOIN #ProductAttributeXML_LocaleWise PAX ON PAX.PublishProductId = ZPCPD.PublishProductId  AND PAX.LocaleId = ZPCPD.LocaleId 
			LEFT JOIN  #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductSKU TBPS ON (TBPS.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN  #ProductImages TBPI ON (TBPI.PublishProductId = ZPCPD.PublishProductId)
			LEFT JOIN #TempPublishCategoryProduct ZPCP  ON (ZPCP.PublishProductId = ZPCPD.PublishProductId AND ZPCP.PublishCatalogId = ZPCPD.PublishCatalogId AND ZPCP.PimCategoryHierarchyId = ZPCPD.PimCategoryHierarchyId)
			WHERE ZPCPD.LocaleId = @LocaleId 
			AND EXISTS(SELECT * FROM #ZnodePublishCatalogProductDetail z WHERE ZPCPD.PimCatalogProductDetailId = z.PimCatalogProductDetailId AND z.Id BETWEEN @MinRow AND @MaxRow)
			AND ZPCPD.PublishCatalogId = @PublishCatalogId

			CREATE INDEX Idx_#ProductEntity_LocaleWise ON #ProductEntity (PublishProductId,PublishCatalogId,LocaleId,PublishCategoryId)

			UPDATE A SET a.SKU = b.SKU,A.SKULower = Lower_SKU,A.Name = B.ProductName, A.Brands = B.Brands, A.CategoryName = B.CategoryName, A.CatalogName = B.CatalogName,
				A.DisplayOrder = B.DisplayOrder, A.AssociatedProductDisplayOrder = B.AssociatedProductDisplayOrder,
				A.SalesPrice = B.SalesPrice, A.RetailPrice = B.RetailPrice, A.SeoDescription=B.SEODescriptionForIndex,
				A.SeoKeywords = B.SEOKeywords, A.SeoTitle = B.SEOTitle, A.SeoUrl = B.SEOUrl, A.ImageSmallPath = B.ImageSmallPath,
				A.ProductIndex = B.ProductIndex, A.IsActive = B.IsActive, A.IndexId = B.IndexId, A.Attributes = B.ProductXML,
				--A.ElasticSearchEvent = 1
				A.ElasticSearchEvent = Case When  B.IsActive =1 Then  1 else 2 End 
			FROM ZnodePublishProductEntity A
			INNER JOIN #ProductEntity_LocaleWise B ON A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2
			AND EXISTS(SELECT * FROM @TBL_LocaleId V WHERE A.VersionId = V.VersionId)

			INSERT INTO ZnodePublishProductEntity (
			VersionId, --1
			IndexId, --2 
			ZnodeProductId,ZnodeCatalogId, --3
			SKU,LocaleId, --4 
			Name,ZnodeCategoryIds, --5
			IsActive,Attributes,Brands,CategoryName, --6 
			CatalogName,DisplayOrder, --7 
			RevisionType,AssociatedProductDisplayOrder, --8
			ProductIndex,--9
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent)
			SELECT VersionId --1 
				,IndexId  --2
				,PublishProductId,PublishCatalogId  --3 
				,SKU,LocaleId -- 4 
				,ProductName ,PublishCategoryId  -- 5 
				,IsActive ,ProductXML,Brands,CategoryName  --6
				,CatalogName,DisplayOrder  -- 7 
				,RevisionType, AssociatedProductDisplayOrder,-- pending  -- 8 
				ProductIndex,  -- 9
				SalesPrice , 
				RetailPrice , 
				CultureCode , 
				CurrencySuffix , 
				CurrencyCode , 
				SEODescriptionForIndex,
				SEOKeywords,
				SEOTitle,
				SEOUrl,
				ImageSmallPath,
				Lower_SKU,1 as ElasticSearchEvent
			FROM #ProductEntity_LocaleWise B
			WHERE NOT EXISTS(SELECT * FROM ZnodePublishProductEntity A WHERE A.ZnodeProductId = B.PublishProductId AND A.ZnodeCatalogId = B.PublishCatalogId AND A.LocaleId = B.LocaleId 
				AND ISNULL(A.ZnodeCategoryIds,0) = ISNULL(B.PublishCategoryId,0) AND A.VersionId = B.VersionId AND A.ElasticSearchEvent <> 2)
		
			--select * from #ProductEntity_LocaleWise where PublishProductId = 191 

		END

		SET @VersionId = 0  

		IF OBJECT_ID('tempdb..#ProductEntity') is not null
			DROP TABLE #ProductEntity

		IF OBJECT_ID('TEMPDB..#TempProductEntity_LocaleWise') IS NOT NULL
			DROP TABLE #TempProductEntity_LocaleWise

	FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow,@LocaleId, @RevisionType ,@VersionId 
	END;  
	CLOSE cur_BulkData;  
	DEALLOCATE cur_BulkData;  
  
  
	IF @RevisionState = 'PREVIEW'   
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPreview()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId)  
	Else  
		UPDATE ZnodePimProduct SET IsProductPublish = 1,PublishStateId =  DBO.Fn_GetPublishStateIdForPublish()    
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishProduct ZPP WHERE ZPP.PimProductId = ZnodePimProduct.PimProductId   
		AND ZPP.PublishCatalogId = @PublishCatalogId) 
		

	UPDATE ZnodePublishCatalogLog   
	SET IsProductPublished = 1   
	,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCategoryProduct ZPP   
		WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PublishCategoryId IS NOT NULL)   
	WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	and PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' ) 
    
	--UPDATE ZnodePublishCatalogLog   
	--SET IsProductPublished = 1   
	--,PublishProductId = (SELECT  COUNT(DISTINCT PublishProductId) FROM ZnodePublishCatalogProductDetail ZPP   
	--	WHERE ZPP.PublishCatalogId = ZnodePublishCatalogLog.PublishCatalogId AND ZPP.PimCategoryHierarchyId <> 0)   
	--WHERE ZnodePublishCatalogLog.PublishCatalogId = @PublishCatalogId  
	--AND PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE PublishStateCode = 'Processing' )  

	SET @Status = 1   

	IF OBJECT_ID('tempdb..##AttributeValueLocale') IS NOT NULL  
		DROP TABLE ##AttributeValueLocale; 

END TRY   
BEGIN CATCH   
	SELECT ERROR_MESSAGE()
	 SET @Status =0    
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	  @ErrorLine VARCHAR(100)= ERROR_LINE(),  
	  @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductJson   
		 @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))  
	  +',@PimCatalogId = ' + CAST(@PimCatalogId AS varchar(20))  
	  +',@VersionIdString= ' + CAST(@VersionIdString AS varchar(20))  
       
	 EXEC Znode_InsertProcedureErrorLog  
	  @ProcedureName = 'Znode_GetPublishProductJson',  
	  @ErrorInProcedure = @Error_procedure,  
	  @ErrorMessage = @ErrorMessage,  
	  @ErrorLine = @ErrorLine,  
	  @ErrorCall = @ErrorCall;  
END CATCH  
  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAssociateProducts')
	DROP PROC Znode_ImportAssociateProducts
GO

CREATE PROCEDURE [dbo].[Znode_ImportAssociateProducts](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Product Association 
	
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	
	BEGIN TRY
	BEGIN TRAN A;
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();

		IF OBJECT_ID('TEMPDB..#InsertProductAssociation') IS NOT NULL 
			DROP TABLE #InsertProductAssociation

		IF OBJECT_ID('TEMPDB..#InsertProduct') IS NOT NULL 
			DROP TABLE #InsertProduct

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL 
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertProductAssociation_Parent_type') IS NOT NULL 
			DROP TABLE #InsertProductAssociation_Parent_type
		-- Retrive RoundOff Value from global setting 

		CREATE TABLE #InsertProductAssociation 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, ParentSKU varchar(300), ChildSKU varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400),BundleQuantity varchar(10) null
		);

		CREATE TABLE #InsertProductAssociation_Parent_type
		( 
			RowId int  PRIMARY KEY, RowNumber int, ParentSKU varchar(300), ChildSKU varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400),BundleQuantity varchar(10) null
			,PT_ParentProductId varchar(300), PT_ProductType nvarchar(100)
		);
		
		CREATE TABLE #InsertProduct 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, ParentProductId varchar(300), ChildProductId varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400), ProductType nvarchar(100),BundleQuantity varchar(10) null
		);


		DECLARE @CategoryAttributId int;

		DECLARE @InventoryListId int;

		SET @SSQL = 'Select RowNumber,ParentSKU,ChildSKU,DisplayOrder,IsDefault,GUID,Quantity FROM '+@TableName;
		INSERT INTO #InsertProductAssociation( RowNumber, ParentSKU,ChildSKU,DisplayOrder,IsDefault, GUID, BundleQuantity )
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		CREATE TABLE #SKU 
		( 
						   SKU nvarchar(300), PimProductId int
		);
		INSERT INTO #SKU
			   SELECT b.AttributeValue, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;

		DECLARE @ProductType TABLE
		( 
			ProductType nvarchar(100) ,PimProductId int
		);
		INSERT INTO @ProductType
			   SELECT  ZPADV.AttributeDefaultValueCode, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimProductAttributeDefaultValue AS b
					ON a.PimAttributeId = dbo.Fn_GetProductTypeAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId
					   Inner join ZnodePimAttributeDefaultValue ZPADV On b.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId
					   where  ZPADV.AttributeDefaultValueCode in ('GroupedProduct','BundleProduct','ConfigurableProduct');

		INSERT INTO #InsertProductAssociation_Parent_type
			SELECT IPAC.*,SKUParent.PimProductId, PT.ProductType
					FROM #InsertProductAssociation AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 
					inner join @ProductType PT on PT.PimProductId = SKUParent.PimProductId


		-- start Functional Validation 
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '84', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') = '' and ii.PT_ProductType ='ConfigurableProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') not in ('true','1','false','0') and isnull(ii.IsDefault,'') <> '' and ii.PT_ProductType ='ConfigurableProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') not in ('true','1','false','0') and isnull(ii.IsDefault,'') <> '' and ii.PT_ProductType ='BundleProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '98', 'ChildSKU', ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE NOT EXISTS( SELECT SKU FROM #SKU SKU WHERE ii.ChildSKU = SKU.SKU)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'ParentSKU / ChildSKU', ParentSKU+' / '+ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE ii.ParentSKU IN
			   (
				   select ParentSKU from #InsertProductAssociation_Parent_type
					group by ParentSKU,ChildSKU
					having count(1)>1
			   );

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '49', 'ParentSKU',   ParentSKU , @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE not exists
			   ( SELECT SKU  FROM #SKU SKU inner join @ProductType  PT ON SKU.PimProductId = PT.PimProductId Where  ii.ParentSKU = SKU.SKU )
			   AND  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ParentSKU = SKU.SKU);

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '94', 'ParentSKU',   ParentSKU , @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE NOT  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ParentSKU = SKU.SKU) ;


			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '51', 'ChildSKU',   ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE exists 
			   (SELECT SKU  FROM #SKU SKU inner join @ProductType  PT ON SKU.PimProductId = PT.PimProductId and ii.ChildSKU = SKU.SKU)
			    AND  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ChildSKU = SKU.SKU);
			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '94', 'ChildSKU',   ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE NOT EXISTS (SELECT SKU  FROM #SKU SKU where ii.ChildSKU = SKU.SKU);

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '101', 'ParentSKU',  'Configure Attribute Missing: '+ Convert(nvarchar(400),isnull(ParentSKU,'')), @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii Inner join #SKU PS ON 
			   ii.ParentSKU = PS.SKU 
			   Inner join @ProductType  PT ON PS.PimProductId = PT.PimProductId  AND PT.ProductType  in ('ConfigurableProduct')
			   where  NOT exists 
			   (select PimProductId  from ZnodePimConfigureProductAttribute d where PS.PimProductId = d.PimProductId)
			   -- End Function Validation 	

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE (ISNUMERIC(ii.DisplayOrder)=0 OR ii.DisplayOrder < 0 OR ii.DisplayOrder > 99999)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '26', 'BundleQuantity', BundleQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE ((isnull(ii.BundleQuantity,0) < 1 ) and ii.PT_ProductType ='BundleProduct' ) --or  ii.DisplayOrder = 0

			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '2', 'BundleQuantity', BundleQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE (ii.BundleQuantity ='' and ii.PT_ProductType ='BundleProduct'  ) --or  ii.DisplayOrder = 0


		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	FROM #InsertProductAssociation_Parent_type AS ii
		--	WHERE ((isnull(ii.DisplayOrder,'') = '' ) and ii.PT_ProductType !='ConfigurableProduct' ) --or  ii.DisplayOrder > 999

			   UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(ParentSKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAssociation_Parent_type IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--- Delete Invalid Data after functional validation  
		DELETE FROM #InsertProductAssociation_Parent_type
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  GUID = @NewGUID
		);

		SELECT RowNumber , SKUParent.PimProductId SKUParentId  ,
				   ( Select TOP 1 SKUChild.PimProductId from #SKU AS SKUChild where  SKUChild.SKU = IPAC.ChildSKU ) SKUChildId,
				    case when isnull(DisplayOrder,'')= '' and IPAC.PT_ProductType ='ConfigurableProduct'  then 99 else DisplayOrder end DisplayOrder ,
					 case when (isnull(IsDefault,'')= '' or IsDefault =0 or IsDefault > 999) and IPAC.PT_ProductType !='ConfigurableProduct'  then '0' else IsDefault end IsDefault, IPAC.PT_ProductType
					, BundleQuantity
					FROM #InsertProductAssociation_Parent_type AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 

		insert into #InsertProduct (RowNumber,  ParentProductId , ChildProductId , DisplayOrder, IsDefault, ProductType, BundleQuantity)
			SELECT RowNumber , SKUParent.PimProductId SKUParentId  ,
				   ( Select TOP 1 SKUChild.PimProductId from #SKU AS SKUChild where  SKUChild.SKU = IPAC.ChildSKU ) SKUChildId,
				    case when isnull(DisplayOrder,'')= '' and IPAC.PT_ProductType ='ConfigurableProduct'  then 99 else DisplayOrder end DisplayOrder ,
					 case when (isnull(IsDefault,'')= '' or IsDefault =0 or IsDefault > 999) and IPAC.PT_ProductType !='ConfigurableProduct'  then '0' else IsDefault end IsDefault, IPAC.PT_ProductType
					, BundleQuantity
					FROM #InsertProductAssociation_Parent_type AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 

	-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProduct
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

		update #InsertProduct
		set IsDefault =0
		where RowNumber < (select max(RowNumber) from #InsertProduct where IsDefault = '1' or  IsDefault = 'True' and ProductType ='ConfigurableProduct')
		and  ProductType ='ConfigurableProduct';


		update ZnodePimProductTypeAssociation
		set  IsDefault =0
		where  exists (select top 1 1  from #InsertProduct IP where IsDefault = '1' or  IsDefault = 'true' and PimParentProductId = IP.ParentProductId and ProductType ='ConfigurableProduct')
		

		UPDATE B set b.ModifiedDate = @GetDate, b.ModifiedBy = @UserId, b.DisplayOrder = case when ISNULL(a.DisplayOrder,0)<>0 then a.DisplayOrder else b.DisplayOrder end
				,b.IsDefault = A.IsDefault,b.BundleQuantity= case when A.Producttype = 'BundleProduct' then  case when isnull(a.BundleQuantity,'') ='' then case when b.BundleQuantity >=1 then b.BundleQuantity else 1 end else cast (a.BundleQuantity as int) end else null end
		from #InsertProduct A
		INNER JOIN ZnodePimProductTypeAssociation B ON a.ParentProductId = b.PimParentProductId and a.ChildProductId = b.PimProductId

	
		INSERT INTO ZnodePimProductTypeAssociation (PimParentProductId, PimProductId, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, IsDefault,BundleQuantity) 
		select  ParentProductId , ChildProductId , CASE WHEN ISNULL(DisplayOrder,0)=0 THEN 1 ELSE DisplayOrder END, @UserId, @GetDate, @UserId, @GetDate, IsDefault ,case when Producttype = 'BundleProduct' then case when  isnull(BundleQuantity,'') ='' then 1 else cast (BundleQuantity as int) end else null end
		from #InsertProduct  
		where  NOT Exists (Select TOP 1 1 from ZnodePimProductTypeAssociation where PimParentProductId =  #InsertProduct.ParentProductId
		AND PimProductId = #InsertProduct.ChildProductId )

								 
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						  WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						  WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					 END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
END TRY
	BEGIN CATCH
		ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAssociateProducts @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAssociateProducts',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetBlogFeedList')
	DROP PROC Znode_GetBlogFeedList
GO

   
CREATE PROCEDURE [dbo].[Znode_GetBlogFeedList]
( 
	@PortalId NVARCHAR(MAX) = NULL,
	@LocaleId INT
)
AS
/*
	Summary : This procedure is used to get effective keyword feeding of content list
	Unit Testing:
	EXEC [Znode_GetBlogFeedList] 2,1
	R
*/
     BEGIN
         SET NOCOUNT ON;
		 BEGIN TRY
         DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
         DECLARE @TBL_DomainName TABLE
         (PortalId   INT,
          DomainName NVARCHAR(300),
          RowId      INT
         );

         DECLARE @TBL_PortalIds TABLE(PortalId INT);
         DECLARE @TBL_SEODetails TABLE
         (loc                   NVARCHAR(MAX),
          lastmod               DATETIME,
          [g:condition]         VARCHAR(100),
          [description]         NVARCHAR(MAX),
          [g:id]                INT,
          link                  VARCHAR(100),
          [g:identifier_exists] VARCHAR(200),
          DomainName            NVARCHAR(300),
          PortalId              INT,
		  SEOCode               NVARCHAR(4000),
		  CanonicalURL          NVARCHAR(200),
		  RobotTag              NVARCHAR(50)
         );

         INSERT INTO @TBL_PortalIds
                SELECT Zp.PortalId
                FROM Znodeportal AS ZP
                INNER JOIN ZnodeBlogNews AS ZBN ON(ZBN.PortalId = Zp.PortalId)
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM DBO.Split(@PortalID, ',') AS Sp
                    WHERE(CAST(sp.Item AS INT) = ZP.PortalId
                          OR @PortalID = '0' )
                )
                GROUP BY Zp.PortalId;

				INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 1


			if not exists(select top 1 1 from @TBL_DomainName) 
			INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 0


		 ---------- CMS Content Page Details
         ;WITH Cte_SeoDetailsWithLocale AS 
		 (
				SELECT DISTINCT ZCSD.CMSSEODetailId,ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZBN.BlogNewsId AS [g:id],'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZBN.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId, ZCSD.SEOCode
				,ZCSDL.CanonicalURL, ZCSDL.RobotTag
                FROM ZnodeBlogNews AS ZBN 
                LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(ZBN.BlogNewsCode = ZCSD.SEOCode AND EXISTS ( SELECT TOP 1 1 FROM ZnodeCMSSEOType AS ZCST WHERE ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId
                                                AND ZCST.Name = 'BlogNews'))
                LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId
                                                        AND LocaleId IN(@LocaleId, @DefaultLocaleId))
                LEFT JOIN @TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = ZBN.PortalId )
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE ZBN.PortalId = TBP.PortalId
                )
				AND ZBN.IsBlogNewsActive =1 
			),
			Cte_SeoDetailsWithFirstLocale AS 
			(
				SELECT * FROM Cte_SeoDetailsWithLocale WHERE LocaleId = @LocaleId
			),
			Cte_SeoDetailsWithDefaultLocale AS 
			(
				  SELECT * FROM Cte_SeoDetailsWithFirstLocale
				  UNION ALL
				  SELECT * FROM Cte_SeoDetailsWithLocale AS CTSDWL
				  WHERE LocaleId = @DefaultLocaleId
				  AND NOT EXISTS
				  (
					  SELECT TOP 1 1
					  FROM Cte_SeoDetailsWithFirstLocale AS CTSDWDL
					  WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId
				  )
			)
			INSERT INTO @TBL_SEODetails
            SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId, SEOCode,CanonicalURL,RobotTag
            FROM Cte_SeoDetailsWithDefaultLocale

         ;WITH Cte_BlogNews AS 
		 (
			SELECT ZBN.BlogNewsId,ZBNL.BlogNewsTitle,ZBNL.LocaleId,ZBNL.BlogNewsTitle Name
            FROM ZnodeBlogNews ZBN
            INNER JOIN ZnodeBlogNewsLocale ZBNL ON(ZBN.BlogNewsId = ZBNL.BlogNewsId)
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM @TBL_SEODetails TBSD
                WHERE TBSD.[g:id] = ZBN.BlogNewsId
            )
            AND LocaleID IN(@LocaleId, @DefaultLocaleId)
		),
		Cte_BlogNewsFirstLocale AS 
		(
			SELECT *
            FROM Cte_BlogNews CTCP
            WHERE LocaleId = @LocaleId
		),
		Cte_BlogNewsSecondLocale AS 
		(
              SELECT *
              FROM Cte_BlogNewsFirstLocale CTPFL
              UNION ALL
              SELECT *
              FROM Cte_BlogNews CTCP
              WHERE LocaleId = @LocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_BlogNewsFirstLocale CTCPFL
                  WHERE CTCPFL.BlogNewsId = CTCP.BlogNewsId
              )
		)
        SELECT DISTINCT loc,lastmod,DomainName,'' AS [image], Name,[g:id] BlogNewsId,PortalId,SEOCode, CanonicalURL, RobotTag
        FROM @TBL_SEODetails TBSD
        LEFT JOIN Cte_BlogNewsSecondLocale CTCPSL ON(TBSD.[g:id] = CTCPSL.BlogNewsId);

		END TRY
		BEGIN CATCH
		  DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetBlogFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetBlogFeedList',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		END CATCH

     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetContentFeedList')
	DROP PROC Znode_GetContentFeedList
GO

CREATE PROCEDURE [dbo].[Znode_GetContentFeedList]
( @PortalId NVARCHAR(MAX) = NULL,
  @LocaleId INT)
AS
/*
	Summary : This procedure is used to get effective keyword feeding of content list
	Unit Testing:
	EXEC Znode_GetContentFeedList 4,1
	
*/
     BEGIN
         SET NOCOUNT ON;
		 BEGIN TRY
         DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
         DECLARE @TBL_DomainName TABLE
         (PortalId   INT,
          DomainName NVARCHAR(300),
          RowId      INT
         );

         DECLARE @TBL_PortalIds TABLE(PortalId INT);
         DECLARE @TBL_SEODetails TABLE
         (loc                   NVARCHAR(MAX),
          lastmod               DATETIME,
          [g:condition]         VARCHAR(100),
          [description]         NVARCHAR(MAX),
          [g:id]                INT,
          link                  VARCHAR(100),
          [g:identifier_exists] VARCHAR(200),
          DomainName            NVARCHAR(300),
          PortalId              INT,
		  SEOCode               NVARCHAR(4000),
		  CanonicalURL          NVARCHAR(200),
		  RobotTag              NVARCHAR(50)
         );

		 if object_id('tempdb..#CMSSEOData') is not null
			drop table #CMSSEOData

		 CREATE TABLE #CMSSEOData 
		 (loc varchar(max),lastmod DateTime,DomainName varchar(200),[image] varchar(1000),Name varchar(500), CMSContentPagesId Int,PortalId Int, SEOCode NVARCHAR(4000)
		 , CanonicalURL NVARCHAR(200), RobotTag NVARCHAR(50))

         INSERT INTO @TBL_PortalIds
                SELECT Zp.PortalId
                FROM Znodeportal AS ZP
                INNER JOIN ZnodeCMSContentPages AS ZPC ON(ZPC.PortalId = Zp.PortalId)
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM DBO.Split(@PortalID, ',') AS Sp
                    WHERE(CAST(sp.Item AS INT) = ZP.PortalId
                          OR @PortalID = '0' )
                )
                GROUP BY Zp.PortalId;

				
         INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 1


			if not exists(select top 1 1 from @TBL_DomainName) 
			INSERT INTO @TBL_DomainName
                SELECT TOP 1 ZD.PortalId,ZD.DomainName,                     
                       ROW_NUMBER() OVER(PArtition BY ZD.DomainName,
                                                  ZD.PortalId ORDER BY ZD.DomainName,
                                                  ZD.PortalId) RowId
                FROM ZnodeDomain ZD
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_PortalIds TBP
                    WHERE TBP.PortalId = ZD.PortalId
                )
			AND IsActive =1 
			AND applicationType = 'Webstore'
			AND ZD.IsDefault = 0

         ;WITH Cte_SeoDetailsWithLocale
              AS (SELECT DISTINCT ZCSD.CMSSEODetailId,  ZCSD.SEOURL AS loc,ZCSD.ModifiedDate AS lastmod,'new' AS [g:condition],ZCSDL.SEODescription AS [description],ZPCC.CMSContentPagesId AS [g:id],'' AS link,'false' AS [g:identifier_exists],TBDN.DomainName,ZPCC.PortalId,ISNULL(ZCSDL.LocaleId, @DefaultLocaleId) AS LocaleId,ZCSD.SEOCode
			      , ZCSDL.CanonicalURL, ZCSDL.RobotTag
                 FROM ZnodeCMSContentPages AS ZPCC 
                 LEFT JOIN ZnodeCMSSEODetail AS ZCSD ON(ZPCC.PageName = ZCSD.SEOCode AND EXISTS ( SELECT TOP 1 1 FROM ZnodeCMSSEOType AS ZCST WHERE ZCST.CMSSEOTypeId = ZCSD.CMSSEOTypeId
                                                   AND ZCST.Name = 'Content Page') AND ZCSD.PortalId = ZPCC.PortalId )
                 LEFT JOIN ZnodeCMSSEODetailLocale AS ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId
                                                            AND LocaleId IN(@LocaleId, @DefaultLocaleId))
                 LEFT JOIN @TBL_DomainName AS TBDN ON(TBDN.RowId = 1 AND TBDN.PortalId = ZPCC.PortalId )
                  WHERE  ZPCC.IsActive = 1 AND exists (select top 1 1 from ZnodePublishState ZPS where ZPS.StateName in ( 'Publish','Preview') and ZPCC.PublishStateId= ZPS.PublishStateId)
				  AND EXISTS
                  (
                      SELECT TOP 1 1
                      FROM @TBL_PortalIds TBP
                      WHERE ZPCC.PortalId = TBP.PortalId
                  )
				  AND EXISTS (SELECT TOP 1 1 FROM   @TBL_PortalIds TBPL
                      WHERE ZCSD.PortalId = TBPL.PortalId  
					  )
				  )
				   
				  --select  * from Cte_SeoDetailsWithLocale

             ,Cte_SeoDetailsWithFirstLocale
              AS (SELECT *
                  FROM Cte_SeoDetailsWithLocale
                  WHERE LocaleId = @LocaleId),

              Cte_SeoDetailsWithDefaultLocale
              AS (
              SELECT *
              FROM Cte_SeoDetailsWithFirstLocale
              UNION ALL
              SELECT *
              FROM Cte_SeoDetailsWithLocale AS CTSDWL
              WHERE LocaleId = @DefaultLocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_SeoDetailsWithFirstLocale AS CTSDWDL
                  WHERE CTSDWDL.CMSSEODetailId = CTSDWL.CMSSEODetailId
              ))

              INSERT INTO @TBL_SEODetails
                     SELECT loc,lastmod,[g:condition],[description],[g:id],link,[g:identifier_exists],DomainName,PortalId,SEOCode,CanonicalURL,RobotTag
                     FROM Cte_SeoDetailsWithDefaultLocale;

         WITH Cte_ContentPages
              AS (SELECT ZCCP.CMSContentPagesId,ZCCPl.PageTitle,ZCCPL.LocaleId,ZCCP.PageName
                  FROM ZnodeCMSContentPages ZCCP
                  INNER JOIN ZnodeCMSContentPagesLocale ZCCPL ON(ZCCPL.CMSContentPagesId = ZCCP.CMSContentPagesId)
                  WHERE ZCCP.IsActive = 1 AND exists (select top 1 1 from ZnodePublishState ZPS where ZPS.PublishStateCode in ( 'Publish','Preview') and ZCCP.PublishStateId= ZPS.PublishStateId)				  
				  AND EXISTS
                  (
                      SELECT TOP 1 1
                      FROM @TBL_SEODetails TBSD
                      WHERE TBSD.[g:id] = ZCCP.CMSContentPagesId
                  )
                        AND LocaleID IN(@LocaleId, @DefaultLocaleId)),

              Cte_ContentPageFirstLocale
              AS (SELECT *
                  FROM Cte_ContentPages CTCP
                  WHERE LocaleId = @LocaleId),

              Cte_ContentPageSecondLocale
              AS (
              SELECT *
              FROM Cte_ContentPageFirstLocale CTPFL
              UNION ALL
              SELECT *
              FROM Cte_ContentPages CTCP
              WHERE LocaleId = @LocaleId
                    AND NOT EXISTS
              (
                  SELECT TOP 1 1
                  FROM Cte_ContentPageFirstLocale CTCPFL
                  WHERE CTCPFL.CMSContentPagesId = CTCP.CMSContentPagesId
              ))
			  INSERT INTO #CMSSEOData(loc,lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag)
              SELECT DISTINCT loc,lastmod,DomainName,'' AS [image],PageName Name,[g:id] CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag
              FROM @TBL_SEODetails TBSD
              LEFT JOIN Cte_ContentPageSecondLocale CTCPSL ON(TBSD.[g:id] = CTCPSL.CMSContentPagesId);

			  ---- CMS SEO Blog News Details
			  INSERT INTO #CMSSEOData(loc,lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag)
			  EXEC [Znode_GetBlogFeedList] @PortalId, @LocaleId

			  SELECT DISTINCT loc, REPLACE(CONVERT(VARCHAR(30),lastmod,102),'.','-') AS lastmod,DomainName,[image], Name, CMSContentPagesId,PortalId,CanonicalURL,RobotTag FROM #CMSSEOData

		END TRY
		BEGIN CATCH
		  DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetContentFeedList @PortalId = '+@PortalId+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetContentFeedList',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		END CATCH
     END;

GO

IF EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_IsActive_SKULower' AND object_id = OBJECT_ID('ZnodePublishProductEntity'))
BEGIN
	DROP INDEX IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_IsActive_SKULower ON ZnodePublishProductEntity
END

GO

IF EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_SKULower' AND object_id = OBJECT_ID('ZnodePublishProductEntity'))
BEGIN
	DROP INDEX IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_SKULower ON ZnodePublishProductEntity
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'SKULower')
BEGIN
    ALTER TABLE ZnodePublishProductEntity ALTER COLUMN SKULower VARCHAR (300) NOT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPromotions')
	DROP PROC Znode_ImportPromotions
GO

CREATE PROCEDURE [dbo].[Znode_ImportPromotions]
(
	@TableName			NVARCHAR(100),
	@Status				BIT,
	@UserId				INT,
	@ImportProcessLogId	INT,
	@NewGUId			NVARCHAR(200),
	@LocaleId			INT=1,
	@CsvColumnString	NVARCHAR(MAX),
	@PromotionTypeId	INT , 
	@IsGenerateErrorLog       BIT = 1 
)
AS 
/*
	Summary :  Made a provision to import Promotions details.
	
	Unit Testing: 
		EXEC dbo.Znode_ImportPromotions @TableName='',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId='',@LocaleId=1,
			@CsvColumnString=,@PromotionTypeId=17

	SELECT @TableName='##Temp',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId=NEWID(),@LocaleId=1,
			@CsvColumnString='PromoCode,Name,Description,StartDate,EndDate,DisplayOrder,Store,Profile,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,AvailableQuantity
				,DiscountAmount,MinimumQuantity,MinimumOrderAmount,Brand',
			@PromotionTypeId=17
*/
BEGIN
	SET NOCOUNT ON;
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(MAX);

	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

	DECLARE @GetDate1 VARCHAR(100) = CONVERT(VARCHAR(30),@GetDate,121)
	DECLARE @ImportProcessLogId1 VARCHAR(100) = CAST(@ImportProcessLogId AS VARCHAR(15))
	DECLARE @UserId1 VARCHAR(15) = CAST(@UserId AS VARCHAR(15))

	IF ISNULL(@LocaleId,0)=0
	BEGIN
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
	END

	DECLARE @LocaleId1 VARCHAR(15) = CAST(@LocaleId AS VARCHAR(15))

	IF OBJECT_ID('tempdb..##Promotions') IS NOT NULL
		DROP TABLE ##Promotions

	SET @SSQL='CREATE TABLE ##Promotions (RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT , '+
		REPLACE(TRIM(LTRIM(@CsvColumnString)), ',' ,' NVARCHAR(MAX),') + CASE WHEN @CsvColumnString = '' THEN '' ELSE ' NVARCHAR(MAX)' END+', GUID NVARCHAR(400)) 
		INSERT INTO ##Promotions (RowNumber,' + @CsvColumnString + ',GUID) 
		SELECT ROW_NUMBER() OVER (ORDER BY PromoCode) As RowNumber,' + @CsvColumnString + ','''+@NewGUId+''' As GUID FROM '+ @TableName +'
		'
		
	EXEC (@SSQL)
	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PortalId')
	BEGIN
		ALTER TABLE ##Promotions ADD PortalId INT

		--UPDATE ##Promotions SET PortalId=NULL

		UPDATE P
		SET P.PortalId = CASE WHEN LTRIM(TRIM(P.Store))='All Stores' THEN NULL ELSE ISNULL(ZP.PortalId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodePortal ZP ON P.Store=ZP.StoreCode
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProfileId')
	BEGIN
		ALTER TABLE ##Promotions ADD ProfileId INT

		--UPDATE ##Promotions SET ProfileId=NULL

		UPDATE P
		SET P.ProfileId = CASE WHEN LTRIM(TRIM(P.Profile))='All Profiles' THEN NULL ELSE ISNULL(ZP.ProfileId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodeProfile ZP ON P.Profile=ZP.DefaultExternalAccountNo
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PromotionTypeId')
	BEGIN
		ALTER TABLE ##Promotions ADD PromotionTypeId INT
		UPDATE ##Promotions
		SET PromotionTypeId = @PromotionTypeId
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='IsUnique')
	BEGIN
		ALTER TABLE ##Promotions ADD IsUnique BIT
		UPDATE ##Promotions
		SET IsUnique = 0
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='InitialQuantity')
	BEGIN
		ALTER TABLE ##Promotions ADD InitialQuantity INT
		UPDATE ##Promotions
		SET InitialQuantity = AvailableQuantity
	END

	UPDATE ##Promotions
	SET IsCouponRequired=0
	WHERE ISNULL(IsCouponRequired,'')='' OR ISNULL(IsCouponRequired,'')='No';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=0
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='' OR ISNULL(IsAllowedWithOtherCoupons,'')='No';

	UPDATE ##Promotions
	SET IsCouponRequired=1
	WHERE ISNULL(IsCouponRequired,'')='Yes';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=1
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='Yes';

	-- Code for not consider Discount Information for specific Promotion Type
	DECLARE @PromotionTypeName NVARCHAR(50);

	SELECT TOP 1 @PromotionTypeName = [Name] FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId;

	IF @PromotionTypeName IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price')
	BEGIN
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, PromotionMessage='';
	END
	ELSE IF @PromotionTypeName IN ('Call For Pricing')
	BEGIN
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, PromotionMessage = CallForPriceMessage;
	END

	IF OBJECT_ID('tempdb..#DuplicatePromotionsData') IS NOT NULL
		DROP TABLE #DuplicatePromotionsData;

	SELECT PromoCode,ISNULL(Profile,'') As [Profile]
	INTO #DuplicatePromotionsData
	FROM ##Promotions
	GROUP BY PromoCode,ISNULL(Profile,'')
	HAVING COUNT(*) > 1;

	IF OBJECT_ID('tempdb..#DuplicatePromotionsDataCouponCode') IS NOT NULL
		DROP TABLE #DuplicatePromotionsDataCouponCode;

	SELECT Code,ISNULL(Profile,'') As [Profile]
	INTO #DuplicatePromotionsDataCouponCode
	FROM ##Promotions
	GROUP BY Code,ISNULL(Profile,'')
	HAVING COUNT(*) > 1;

	BEGIN TRAN Promotions;
	BEGIN TRY
		-- Start Functional Validation
		-----------------------------------------------
		IF @IsGenerateErrorLog = 1 
		BEGIN 
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.PromoCode,'')=''

			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '53', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE EXISTS (SELECT * FROM #DuplicatePromotionsData bd WHERE bd.PromoCode=ii.PromoCode AND bd.Profile=ii.Profile)
				--AND NOT EXISTS (SELECT * FROM ZnodePromotion zbd INNER JOIN #DuplicatePromotionsData bd ON bd.PromoCode=zbd.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '82', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.PromoCode))) > 300 AND ISNULL(ii.PromoCode,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.[Name],'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.[Name]))) > 100 AND ISNULL(ii.[Name],'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Description', Description, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Description))) > 100 AND ISNULL(ii.Description,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.StartDate)=0 AND LEN(ii.StartDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '150', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)<CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),111),111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '151', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.StartDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.EndDate)=0 AND LEN(ii.EndDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '152', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.EndDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
		
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNULL(ii.DisplayOrder,0)=0 OR ISNULL(ii.DisplayOrder,'')='')
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '149', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNUMERIC(ii.DisplayOrder)=0 AND LEN(ii.DisplayOrder)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DisplayOrder)=1 AND (CAST(ii.DisplayOrder As INT))>999)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '120', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')<>''
				AND NOT EXISTS (SELECT * FROM ZnodePortal WHERE PortalId=ii.PortalId)
				AND ISNULL(ii.Store,'')<>'All Stores'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '153', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')<>''
				AND (NOT EXISTS (SELECT * FROM ZnodePortalProfile WHERE ProfileId=ii.ProfileId AND PortalId=ii.PortalId)
					AND ISNULL(ii.Store,'')<>'All Stores')
				OR (NOT EXISTS (SELECT * FROM ZnodeProfile WHERE DefaultExternalAccountNo=ii.Profile)
					AND ISNULL(ii.Profile,'')<>'All Profiles')

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Profile))) > 100 AND ISNULL(ii.Profile,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			IF @PromotionTypeName NOT IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price','Call For Pricing')
			BEGIN
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsCouponRequired', IsCouponRequired, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '154', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') IN ('True','1','Yes')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.PromotionMessage,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '82', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.PromotionMessage,'')<>'' AND LEN(LTRIM(RTRIM(ii.PromotionMessage)))>300)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
			
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '53', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE EXISTS (SELECT * FROM #DuplicatePromotionsDataCouponCode bd WHERE bd.Code=ii.Code AND bd.Profile=ii.Profile)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '138', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
					AND EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code=ii.Code)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '139', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.Code,'')<>'' AND LEN(LTRIM(RTRIM(ii.Code)))>20)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '8', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')=''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '4', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=0)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '141', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ii.AvailableQuantity LIKE '%.%'
					--(ISNUMERIC(ii.AvailableQuantity)=1 AND LEN(PARSENAME(ii.AvailableQuantity,1))>1)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '140', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)<0 OR ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)>9999))
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
			END
		END 
		-- Validations for Dynamic Attributes
		DECLARE @SQL NVARCHAR(MAX), @AttributeCode  NVARCHAR(MAX)='';

		SELECT @AttributeCode=STRING_AGG( PA.AttributeCode , ',')
		--PA.AttributeCode
		FROM ZnodePromotionAttribute PA
		INNER JOIN ZnodePromotionDiscountAttributeMapper PDAM ON PDAM.PromotionAttributeId = PA.PromotionAttributeId
			AND PDAM.DiscountTypeName=@PromotionTypeName--'Amount off Brand'
		--INNER JOIN ZnodePromotionAttribute PA ON PDAM.PromotionAttributeId = PA.PromotionAttributeId
		WHERE NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='ZnodePromotion' AND COLUMN_NAME = PA.AttributeCode)
			AND EXISTS (SELECT TOP 1 1 FROM tempdb.sys.columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name = PA.AttributeCode);

		IF OBJECT_ID('tempdb..#PromotionAttributeData') IS NOT NULL 
			DROP TABLE #PromotionAttributeData;

		CREATE TABLE #PromotionAttributeData 
			(RowNumber INT,PromoCode NVARCHAR(300),AttributeCode NVARCHAR(300),AttributeValue NVARCHAR(MAX));

		SET @SQL =' 
					SELECT RowNumber,PromoCode,AttributeCode,AttributeValue
					FROM ##Promotions 
					UNPIVOT
					( AttributeValue For AttributeCode IN ('+@AttributeCode+')
					) UNPIVOT8
					'

		INSERT INTO #PromotionAttributeData (RowNumber,PromoCode,AttributeCode,AttributeValue)   
		EXEC SYS.SP_SQLEXEC @SQL;

		ALTER TABLE #PromotionAttributeData ADD AttributeTypeName VARCHAR(200), ValidationName VARCHAR(600), ValidationValue VARCHAR(600);
		
		UPDATE A
		SET A.AttributetypeName=C.AttributeTypeName, ValidationName = d.name, ValidationValue =  e.Name
		FROM #PromotionAttributeData A
		INNER JOIN ZnodePromotionAttribute B ON (B.AttributeCode=A.AttributeCode)
		INNER JOIN ZnodeAttributeType C ON (C.AttributeTypeId=B.AttributeTypeId)
		INNER JOIN ZnodeAttributeInputValidation d ON (d.AttributeTypeId = c.AttributeTypeId )
		INNER JOIN ZnodePromotionAttributeValidation e ON (e.InputValidationId = d.InputValidationId AND b.PromotionAttributeId = e.PromotionAttributeId)

		IF @IsGenerateErrorLog = 1 
		BEGIN
			INSERT INTO ZnodeImportLog
				(ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)  
			SELECT --dbo.Fn_ValidateData (ii.AttributetypeName,ii.AttributeValue,ii.ValidationName, ii.ValidationValue),
			dbo.Fn_ValidateDataErrorCode(ii.AttributetypeName,ii.ValidationName ), ii.AttributeCode, ii.AttributeValue, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #PromotionAttributeData AS ii  
			WHERE dbo.Fn_ValidateData (ii.AttributetypeName,ii.AttributeValue,ii.ValidationName, ii.ValidationValue)=0

			DECLARE @Query NVARCHAR(MAX);

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='DiscountAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''108'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=0 AND LEN(ii.DiscountAmount)>0) OR CAST(ii.DiscountAmount As FLOAT)<0

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (LEN(PARSENAME(ii.DiscountAmount,1))>2 AND CAST(ii.DiscountAmount As FLOAT)>0))
			
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''155'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ii.DiscountAmount) LIKE ''%.%.%''
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (CAST(ii.DiscountAmount As FLOAT))>100)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.DiscountAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumQuantity')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''108'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=0 AND LEN(ii.MinimumQuantity)>0) OR CAST(ii.MinimumQuantity As FLOAT)<0

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''141'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (ii.MinimumQuantity) LIKE ''%.%'')

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (CAST(ii.MinimumQuantity As FLOAT))>100)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumQuantity,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumOrderAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''108'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=0 AND LEN(ii.MinimumOrderAmount)>0) OR CAST(ii.MinimumOrderAmount As FLOAT)<0

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (LEN(PARSENAME(ii.MinimumOrderAmount,1))>2 AND CAST(ii.MinimumOrderAmount As FLOAT)>0))

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''155'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ii.MinimumOrderAmount) LIKE ''%.%.%''

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (CAST(ii.MinimumOrderAmount As FLOAT))>100)
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumOrderAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END
		
			IF EXISTS (SELECT TOP 1 1 FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='CallForPriceMessage')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''CallForPriceMessage'', CallForPriceMessage, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.CallForPriceMessage))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''143'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD INNER JOIN ZnodePortalBrand PB ON BD.BrandId = PB.BrandId AND PB.PortalId = ii.PortalId WHERE BD.BrandCode=ii.Brand)
					AND ISNULL(ii.Brand,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD WHERE BD.BrandCode=ii.Brand) AND ISNULL(ii.Brand,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Brand))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''144'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCatalog PC
									INNER JOIN ZnodePublishCatalog PbC ON PC.PimCatalogId=PbC.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PbC.PublishCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE PC.CatalogCode = ii.Catalog)
					AND ISNULL(ii.Catalog,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCatalog PC WHERE PC.CatalogCode = ii.Catalog) AND ISNULL(ii.Catalog,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Catalog))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''145'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCategory PC
									INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PC.PimCategoryId=PCAV.PimCategoryId
									INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL ON PCAV.PimCategoryAttributeValueId=PCAVL.PimCategoryAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PC.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PCt ON PCH.PimCatalogId=PCt.PimCatalogId
									INNER JOIN ZnodePublishCatalog PbC ON PCt.PimCatalogId=PbC.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PbC.PublishCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE LocaleId='+@LocaleId1+' AND PCAVL.CategoryValue=ii.Category)
					AND ISNULL(ii.Category,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCategoryAttributeValueLocale PCAVL WHERE PCAVL.CategoryValue=ii.Category) AND ISNULL(ii.Category,'''')<>'''')
				
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Category))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''148'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodeShipping SP
									INNER JOIN ZnodePortalShipping PS ON SP.ShippingId=PS.ShippingId
									WHERE SP.ShippingCode=ii.Shipping AND PS.PortalId=ii.PortalId)
					AND ISNULL(ii.Shipping,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeShipping SP WHERE SP.ShippingCode=ii.Shipping) AND ISNULL(ii.Shipping,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Shipping))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.ProductToDiscount AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.ProductToDiscount) AND ISNULL(ii.ProductToDiscount,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.ProductToDiscount))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''% %'')
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.RequiredProduct AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.RequiredProduct,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.RequiredProduct) AND ISNULL(ii.RequiredProduct,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.RequiredProduct))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''% %'')
					AND ISNULL(ii.RequiredProduct,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName --+ ' [ Promotion - ' + ISNULL(PromoCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN ##Promotions IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			 --Delete Invalid Data after functional validation
			DELETE FROM ##Promotions
			WHERE RowNumber IN
			(
				SELECT DISTINCT RowNumber
				FROM ZnodeImportLog
				WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
			);
	
			-- Update Record count in log
			DECLARE @FailedRecordCount BIGINT;
			DECLARE @SuccessRecordCount BIGINT;

			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber)
			FROM ZnodeImportLog 
			WHERE RowNumber IS NOT NULL AND ImportProcessLogId = @ImportProcessLogId;

			SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) 
			FROM ##Promotions

			UPDATE ZnodeImportProcessLog
			SET FailedRecordcount = @FailedRecordCount ,
				SuccessRecordCount = @SuccessRecordCount ,
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END 

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'DiscountAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.DiscountAmount'', ''Discount'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
			PRINT @Query
		END
		
		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumQuantity'', ''QuantityMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumOrderAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumOrderAmount'', ''OrderMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'ProductQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.ProductQuantity'', ''PromotionProductQuantity'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END
	
		--For Update Promotions Data
		DECLARE @UpdateColumns NVARCHAR (MAX);
		SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=CASE WHEN ISNULL(P.'+COLUMN_NAME+','''')='''' THEN ZP.'+COLUMN_NAME+' ELSE P.'+COLUMN_NAME+' END'),',')
		--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
		FROM INFORMATION_SCHEMA.COLUMNS
		WHERE TABLE_NAME='ZnodePromotion'
			AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
			AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsCouponRequired','IsAllowedWithOtherCoupons','IsUnique','ProfileId')
			--AND COLUMN_NAME NOT IN ('DiscountAmount','MinimumQuantity','MinimumOrderAmount');

		IF OBJECT_ID('tempdb..#UpdatedPromotions') IS NOT NULL
			DROP TABLE #UpdatedPromotions;

		CREATE TABLE #UpdatedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		SET @Query='
		UPDATE ZP SET '+@UpdateColumns+'
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #UpdatedPromotions (PromotionId, PromoCode, PromotionTypeId)
		FROM ##Promotions P
		INNER JOIN ZnodePromotion ZP ON LTRIM(RTRIM(P.PromoCode)) = ZP.PromoCode
		'
		EXEC SP_EXECUTESQL @Query;

		--For Insert Promotions Data
		DECLARE @MatchesColumns NVARCHAR (MAX);

		SELECT @MatchesColumns=STRING_AGG(COLUMN_NAME,',') FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME='ZnodePromotion'
			AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
			AND COLUMN_NAME NOT IN ('ProfileId');

		IF OBJECT_ID('tempdb..#InsertedPromotions') IS NOT NULL
			DROP TABLE #InsertedPromotions;

		CREATE TABLE #InsertedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		-- Import New Promotions
		SET @MatchesColumns='
		INSERT INTO ZnodePromotion
			('+@MatchesColumns+',CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			)
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #InsertedPromotions (PromotionId, PromoCode, PromotionTypeId)
		SELECT DISTINCT '+@MatchesColumns+','+CAST(@UserId AS VARCHAR(15))+',GETDATE(),'+CAST(@UserId AS VARCHAR(15))+',GETDATE()
		FROM ##Promotions
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode = LTRIM(RTRIM(##Promotions.PromoCode)))
		'

		EXEC SP_EXECUTESQL @MatchesColumns;

		DECLARE @checkTable TABLE (Code VARCHAR(1000) , valued NVARCHAR(max))

		IF @IsGenerateErrorLog = 0  
		BEGIN 
			INSERT INTO #InsertedPromotions (PromotionId,PromoCode,PromotionTypeId)
			SELECT PromotionId,PromoCode,PromotionTypeId
			FROM #UpdatedPromotions a 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM #InsertedPromotions b WHERE b.PromoCode = a.PromoCode)

			DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )
			DELETE FROM ZnodePromotionCoupon WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )
			DELETE FROM ZnodePromotionBrand WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
			AND (SELECT TOP 1 brand FROM ##Promotions ) <> ''
			DELETE FROM ZnodePromotionCategory WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
			AND (SELECT TOP 1 category FROM ##Promotions ) <> ''
			DELETE FROM ZnodePromotionCatalogs WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
			AND (SELECT TOP 1 catalog FROM ##Promotions ) <> ''
			DELETE FROM ZnodePromotionShipping WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
			AND (SELECT TOP 1 Shipping FROM ##Promotions ) <> ''
				DELETE FROM ZnodePromotionProduct WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
			AND (SELECT TOP 1 ProductToDiscount FROM ##Promotions ) <> ''
		
			INSERT INTO @checkTable 
			SELECT 'brand' ,(SELECT TOP 1 brand FROM ##Promotions )
			UNION ALL 
			SELECT 'catalog' ,(SELECT TOP 1 catalog FROM ##Promotions )
			UNION ALL 
			SELECT 'category' ,(SELECT TOP 1 category FROM ##Promotions )
			UNION ALL 
			SELECT 'Shipping' ,(SELECT TOP 1 Shipping FROM ##Promotions )
			UNION ALL
			SELECT 'ProductToDiscount' ,(SELECT TOP 1 ProductToDiscount FROM ##Promotions )
			UNION ALL
			SELECT 'RequiredProduct' ,(SELECT TOP 1 RequiredProduct FROM ##Promotions )
		END 
		
		--SELECT 1 
		-- Insert for ZnodePromotionProfileMapper
		--SET @Query='
		--INSERT INTO ZnodePromotionProfileMapper
		--	(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--SELECT DISTINCT IPs.PromotionId, CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN IIF(p.Profile=0,NULL,p.Profile) ELSE    P.Profileid END ,'+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		--FROM #InsertedPromotions IPs 
		--INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		--WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper WHERE Promotionid = IPs.PromotionId AND ISNULL(Profileid,0)=CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN p.Profile ELSE    P.Profileid END )  
		--'
		--PRINT @Query 
		--EXEC SP_EXECUTESQL @Query;

		SET @Query='
		INSERT INTO ZnodePromotionProfileMapper
			(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
				WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0))
		'
		EXEC SP_EXECUTESQL @Query;

		IF @IsGenerateErrorLog = 1
		BEGIN 
		-- Update for ZnodePromotionProfileMapper
		SET @Query='
		DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #UpdatedPromotions ) 

		INSERT INTO ZnodePromotionProfileMapper
			(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #UpdatedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
				WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0))
		'
		EXEC SP_EXECUTESQL @Query;
		END 

		-- Insert for ZnodePromotionCoupon
		SET @Query='
		INSERT INTO ZnodePromotionCoupon
			(PromotionId,Code,InitialQuantity,AvailableQuantity,IsActive,IsCustomCoupon,CustomCouponCode,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPs.PromotionId, P.Code, P.InitialQuantity, P.AvailableQuantity, 1, 0, '''', '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		WHERE ISNULL(P.IsCouponRequired,'''') IN (''True'',''1'',''Yes'')
			AND NOT EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code = P.Code)
		'
		EXEC SP_EXECUTESQL @Query;

				
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand' AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Brand') <> '' )
		BEGIN 
		
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, BD.BrandId, BD.BrandCode, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON (' +CASE WHEN @IsGenerateErrorLog = 1 THEN ' P.Brand=BD.BrandCode ' ELSE ' BD.BrandId IN (  '+(SELECT TOP 1 Brand FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(BD.BrandId,0)<>0
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Catalog') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PbC.PublishCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		   '+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
		  INNER JOIN ZnodePimCatalog PC     ON  (  P.Catalog=PC.CatalogCode  ) 
			' ELSE '' END +'
			INNER JOIN ZnodePublishCatalog PbC  ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCatalogId=PbC.PimCatalogId ' ELSE ' PbC.PublishCatalogId IN (  '+(SELECT TOP 1 Catalog FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PbC.PublishCatalogId,0)<>0
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Category') <> '' )
		BEGIN
		   
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT  DISTINCT IPs.PromotionId, PbC.PublishCategoryId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN +'
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL  ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId 
			' ELSE '' END +'
			INNER JOIN ZnodePublishCategory PbC ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCategoryId=PbC.PimCategoryId ' ELSE ' PbC.PublishCategoryId IN (  '+(SELECT TOP 1 Category FROM ##Promotions )+') ' END +' )
			WHERE ISNULL(PbC.PublishCategoryId,0)<>0
			GROUP BY IPs.PromotionId,PbC.PublishCategoryId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping' AND @IsGenerateErrorLog = 1 ) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Shipping') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   P.Shipping=SP.ShippingCode ' ELSE ' sp.shippingId  IN (  '+(SELECT TOP 1 Shipping FROM ##Promotions )+') ' END +' ) 
			
			WHERE ISNULL(SP.ShippingId,0)<>0
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount' AND @IsGenerateErrorLog = 1  )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'ProductToDiscount')  <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PP.PublishProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.ProductToDiscount))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END + '
			INNER JOIN ZnodePublishProduct PP  ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PublishProductId  IN (  '+(SELECT TOP 1 ProductToDiscount FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PP.PublishProductId,0)<>0
			GROUP BY IPs.PromotionId,PP.PublishProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct'  AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'RequiredProduct')<> '' )
		BEGIN
			SET @Query='
			UPDATE ZP
			SET ZP.PromotionProductQuantity=P.PromotionProductQuantity, ZP.ReferralPublishProductId=PP.PublishProductId, ModifiedDate='''+@GetDate1+'''
			FROM ZnodePromotion ZP
			INNER JOIN #InsertedPromotions IPs ON ZP.PromotionId=IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.RequiredProduct))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END +'
			INNER JOIN ZnodePublishProduct PP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PublishProductId  IN (  '+(SELECT TOP 1 RequiredProduct FROM ##Promotions )+') ' END +' )  
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Promotions;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Promotions

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPromotions
					@TableName = '+CAST(@TableName AS VARCHAR(MAX)) +',
					@Status='+ CAST(@Status AS VARCHAR(10))+',
					@UserId = '+CAST(@UserId AS VARCHAR(50))+',
					@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',
					@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',
					@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
					@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(MAX))+',
					@PromotionTypeId='+CAST(@PromotionTypeId AS VARCHAR(20))+',
					@IsGenerateErrorLog='+CAST(@IsGenerateErrorLog AS VARCHAR(10));

		IF @IsGenerateErrorLog = 1
		BEGIN
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
			UPDATE ZnodeImportProcessLog 
			SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , 
				SuccessRecordCount = 0,
				TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPromotions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

UPDATE ZnodeImportAttributeValidation
SET IsRequired=0
WHERE ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE [Name]='Promotions')
	AND AttributeCode IN ('Name','StartDate','EndDate','DisplayOrder','Store','Profile')
	AND IsRequired=1

GO

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 156,'Text','Invalid Product Code (SKU).',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 156)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePromotions')
	DROP PROC Znode_InsertUpdatePromotions
GO

CREATE PROC [dbo].[Znode_InsertUpdatePromotions]
( 
	@PromotionXML XML,
	@UserId INT,
	@Status BIT=0 OUT
)
/*  Unit Testing:-
	begin tran  
 Exec Znode_InsertUpdatePromotions @PromotionXML='<PromotionModel>
  <PromotionId>0</PromotionId>
  <PromoCode>Aditya</PromoCode>
  <Name>Aditya</Name>
  <PromotionTypeId>5</PromotionTypeId>
  <PromotionTypeName>Amount Off Order</PromotionTypeName>
  <Discount>10.0</Discount>
  <StartDate>2022-08-25T00:00:00</StartDate>
  <EndDate>2022-09-24T00:00:00</EndDate>
  <OrderMinimum>1.0</OrderMinimum>
  <QuantityMinimum>0</QuantityMinimum> p2:nil="true" xmlns:p2="http://www.w3.org/2001/XMLSchema-instance" />
  <IsCouponRequired>true</IsCouponRequired>
  <DisplayOrder>99</DisplayOrder>
  <IsUnique>false</IsUnique>
  <PortalId>0</PortalId> p2:nil="true" xmlns:p2="http://www.w3.org/2001/XMLSchema-instance" />
  <ProfileId>0</ProfileId> p2:nil="true" xmlns:p2="http://www.w3.org/2001/XMLSchema-instance" />
  <ProfileIdsList>
    <int>80</int>
	</ProfileIdsList>
  <PromotionProductQuantity>0.0</PromotionProductQuantity>
  <ReferralPublishProductId>0</ReferralPublishProductId>
  <CouponList>
    <PageIndex>0</PageIndex> p3:nil="true" xmlns:p3="http://www.w3.org/2001/XMLSchema-instance" />
    <PageSize>0</PageSize> p3:nil="true" xmlns:p3="http://www.w3.org/2001/XMLSchema-instance" />
    <TotalResults>0</TotalResults>
    <CouponList>
      <CouponModel>
        <PromotionCouponId>0</PromotionCouponId>
        <PromotionId>0</PromotionId>
        <Code>Aditya</Code>
        <InitialQuantity>6</InitialQuantity>
        <AvailableQuantity>6</AvailableQuantity>
        <IsEnableUrl>false</IsEnableUrl>
        <IsActive>true</IsActive>
        <CouponApplied>false</CouponApplied>
        <CouponValid>false</CouponValid>
        <CustomCouponCode>0</CustomCouponCode>
        <IsCustomCoupon>false</IsCustomCoupon>
        <IsExistInOrder>false</IsExistInOrder>
      </CouponModel>
    </CouponList>
  </CouponList>
  <PortalAllowsMultipleCoupon>false</PortalAllowsMultipleCoupon>
  <IsAllowedWithOtherCoupons>true</IsAllowedWithOtherCoupons>
  <AssociatedCatelogIds>0</AssociatedCatelogIds>
  <AssociatedCategoryIds>0</AssociatedCategoryIds>
  <AssociatedProductIds>0</AssociatedProductIds>
  <AssociatedBrandIds>0</AssociatedBrandIds>
  <AssociatedShippingIds>0</AssociatedShippingIds>
  <IsAllowWithOtherPromotionsAndCoupons>false</IsAllowWithOtherPromotionsAndCoupons>
  <IsActive>false</IsActive>
  <IsUsedInOrder>false</IsUsedInOrder>
</PromotionModel>',@UserID=1,@Status=1
rollback tran
*/
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DROP TABLE IF EXISTS tempdb..#TEMP
	SELECT Tbl.Col.value('PromotionId[1]','NVARCHAR(600)') AS PromotionId  
		,Tbl.Col.value('PromoCode[1]','NVARCHAR(600)') AS [PromoCode]
		,Tbl.Col.value('Name[1]','NVARCHAR(600)') AS [Name]
		,Tbl.Col.value ('PromotionTypeId[1]','NVARCHAR(600)') AS PromotionTypeId
		,Tbl.Col.value ('PromotionTypeName[1]','NVARCHAR(600)') AS PromotionTypeName
		,Tbl.Col.value ('Discount[1]','NVARCHAR(600)') AS Discount
		,Tbl.Col.value ('StartDate[1]','NVARCHAR(600)') AS StartDate
		,Tbl.Col.value ('EndDate[1]','NVARCHAR(600)') AS EndDate
		,Tbl.Col.value ('OrderMinimum[1]','NVARCHAR(600)') AS OrderMinimum
		,Tbl.Col.value ('QuantityMinimum[1]','NVARCHAR(600)') AS QuantityMinimum
		,Tbl.Col.value ('IsCouponRequired[1]','NVARCHAR(600)') AS IsCouponRequired
		,Tbl.Col.value ('DisplayOrder[1]','NVARCHAR(600)') AS DisplayOrder
		,Tbl.Col.value ('IsUnique[1]','NVARCHAR(600)') AS IsUnique
		,Tbl.Col.value ('PortalId[1]','NVARCHAR(600)') AS PortalId
		,Tbl.Col.value ('ProfileId[1]','NVARCHAR(600)') AS ProfileIds
		,Tbl3.Col3.value ('.','NVARCHAR(600)') AS ProfileId
		,Tbl.Col.value ('PromotionProductQuantity[1]','NVARCHAR(600)') AS PromotionProductQuantity
		,Tbl.Col.value ('ReferralPublishProductId[1]','NVARCHAR(600)') AS ReferralPublishProductId
		,Tbl2.Col2.value ('PageIndex[1]','NVARCHAR(600)') AS PageIndex
		,Tbl2.Col2.value ('PageSize[1]','NVARCHAR(600)') AS PageSize
		,Tbl2.Col2.value ('TotalResults[1]','NVARCHAR(600)') AS TotalResults
		,Tbl.Col.value ('PortalAllowsMultipleCoupon[1]','NVARCHAR(600)') AS PortalAllowsMultipleCoupon
		,Tbl.Col.value ('PromotionMessage[1]','NVARCHAR(600)') AS PromotionMessage
		,Tbl.Col.value ('IsAllowedWithOtherCoupons[1]','NVARCHAR(600)') AS IsAllowedWithOtherCoupons
		,Tbl.Col.value ('AssociatedCatelogIds[1]','NVARCHAR(600)') AS AssociatedCatelogIds
		,Tbl.Col.value ('AssociatedCategoryIds[1]','NVARCHAR(600)') AS AssociatedCategoryIds
		,Tbl.Col.value ('AssociatedProductIds[1]','NVARCHAR(600)') AS AssociatedProductIds
		,Tbl.Col.value ('AssociatedBrandIds[1]','NVARCHAR(600)') AS AssociatedBrandIds
		,Tbl.Col.value ('AssociatedShippingIds[1]','NVARCHAR(600)') AS AssociatedShippingIds
		,Tbl.Col.value ('IsAllowWithOtherPromotionsAndCoupons[1]','NVARCHAR(600)') AS IsAllowWithOtherPromotionsAndCoupons
		,Tbl.Col.value ('IsActive[1]','NVARCHAR(600)') AS IsActiveCoupon
		,Tbl.Col.value ('IsUsedInOrder[1]','NVARCHAR(600)') AS IsUsedInOrder
	INTO tempdb..#TEMP
	FROM @PromotionXML.nodes('PromotionModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes('CouponList') AS Tbl2(Col2)
	CROSS APPLY Tbl.Col.nodes('//ProfileIds/int') AS Tbl3(Col3)

	--Select * from tempdb..##TEMP

	CREATE TABLE #coupnModel (PromotionCouponId NVARCHAR(600), PromotionCouponModelId NVARCHAR(600), Code NVARCHAR(600),InitialQuantity NVARCHAR(600)
	,AvailableQuantity NVARCHAR(600),IsEnableUrl NVARCHAR(600),IsActive NVARCHAR(600),CouponApplied NVARCHAR(600)
	,CouponValid NVARCHAR(600),CustomCouponCode NVARCHAR(600) ,IsCustomCoupon NVARCHAR(600),IsExistInOrder NVARCHAR(600))
	
	IF CAST(@PromotionXML AS nvarchar(max))  like '%<CouponModel>%'
	BEGIN 
	INSERT INTO  #coupnModel 
	SELECT  Tbl1.Col1.value ('PromotionCouponId[1]','NVARCHAR(600)') AS PromotionCouponId
		,Tbl1.Col1.value ('PromotionId[1]','NVARCHAR(600)') AS PromotionCouponModelId
		,Tbl1.Col1.value ('Code[1]','NVARCHAR(600)') AS Code
		,Tbl1.Col1.value ('InitialQuantity[1]','NVARCHAR(600)') AS InitialQuantity
		,Tbl1.Col1.value ('AvailableQuantity[1]','NVARCHAR(600)') AS AvailableQuantity
		,Tbl1.Col1.value ('IsEnableUrl[1]','NVARCHAR(600)') AS IsEnableUrl
		,Tbl1.Col1.value ('IsActive[1]','NVARCHAR(600)') AS IsActive
		,Tbl1.Col1.value ('CouponApplied[1]','NVARCHAR(600)') AS CouponApplied
		,Tbl1.Col1.value ('CouponValid[1]','NVARCHAR(600)') AS CouponValid
		,Tbl1.Col1.value ('CustomCouponCode[1]','NVARCHAR(600)') AS CustomCouponCode
		,Tbl1.Col1.value ('IsCustomCoupon[1]','NVARCHAR(600)') AS IsCustomCoupon
		,Tbl1.Col1.value ('IsExistInOrder[1]','NVARCHAR(600)') AS IsExistInOrder
	--INTO #coupnModel 
	FROM @PromotionXML.nodes('//PromotionModel/CouponList/CouponList/CouponModel') AS Tbl1(Col1)
	
	--SELECT * FROM #coupnModel

	END 
	ELSE
	BEGIN 
		INSERT INTO #coupnModel (PromotionCouponId)
		SELECT 0
	END 
	
	UPDATE #TEMP SET QuantityMinimum = 0 WHERE ISNULL(QuantityMinimum,'') = ''

	DECLARE @SQL VARCHAR(MAX)
	DECLARE @GUID VARCHAR(100) = CAST(NEWID() AS VARCHAR(100))
	DECLARE @TableName VARCHAR(500) = '##Temp_Promotion_'+CAST(@@SPID AS varchar(30))
	DECLARE @LocaleId INT = DBO.Fn_GetDefaultLocaleId();
	DECLARE @PromotionTypeId INT = (SELECT TOP 1 PromotionTypeId FROM tempdb..#TEMP);
	
    CREATE TABLE #Temp_Promotion_ (PromoCode NVARCHAR(500),Name NVARCHAR(500),Description NVARCHAR(500),StartDate NVARCHAR(500),
		EndDate NVARCHAR(500),DisplayOrder NVARCHAR(500),PortalId NVARCHAR(500),Profile NVARCHAR(500),IsCouponRequired NVARCHAR(500),
		IsAllowedWithOtherCoupons NVARCHAR(500),PromotionMessage NVARCHAR(500),Code NVARCHAR(500),AvailableQuantity NVARCHAR(500),
		Brand NVARCHAR(500),CallForPriceMessage NVARCHAR(500),Catalog NVARCHAR(500),Category NVARCHAR(500),DiscountAmount NVARCHAR(500),
		MinimumOrderAmount NVARCHAR(500),MinimumQuantity NVARCHAR(500),ProductQuantity NVARCHAR(500),ProductToDiscount NVARCHAR(500),
		RequiredProduct NVARCHAR(500),Shipping NVARCHAR(500), InitialQuantity NVARCHAR(500),IsUnique NVARCHAR(500) )


	INSERT INTO #Temp_Promotion_
	SELECT DISTINCT PromoCode,Name,'',StartDate,EndDate,DisplayOrder,IIF(PortalId='0' OR PortalId ='' , NULL,PortalId),
		IIF(ProfileId='0' OR ProfileId ='' , NULL,ProfileId) ProfileId,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,
		AvailableQuantity,AssociatedBrandIds,'',AssociatedCatelogIds,AssociatedCategoryIds,Discount,OrderMinimum,QuantityMinimum,
		PromotionProductQuantity,AssociatedProductIds,ReferralPublishProductId,AssociatedShippingIds,InitialQuantity,IsUnique 
	FROM tempdb..#TEMP 
	CROSS APPLY #coupnModel
		
	EXEC dbo.Znode_ImportPromotions @TableName='#Temp_Promotion_',@Status=0,@UserId=1,@ImportProcessLogId=0,@NewGUId=@GUID,@LocaleId=@LocaleId,
		@CsvColumnString='PromoCode,Name,Description,StartDate,EndDate,DisplayOrder,PortalId,Profile,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,AvailableQuantity,Brand,CallForPriceMessage,Catalog,Category,DiscountAmount,MinimumOrderAmount,MinimumQuantity,ProductQuantity,ProductToDiscount,RequiredProduct,Shipping,InitialQuantity,IsUnique'
		,@PromotionTypeId=@PromotionTypeId ,@IsGenerateErrorLog =0 

	SET @Status = 1
	
	SELECT 1 ID , CAST(1 AS BIT ) Status

	END TRY
              			 
	BEGIN CATCH
		SELECT ERROR_MESSAGE() 
		
		SET @Status = 0
		
		SELECT 1 ID , CAST(0 AS BIT ) Status
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'Znode_InsertUpdatePromotions	
					@PromotionXML='+CAST(@PromotionXML AS VARCHAR(MAX))+',
					@UserId='+CAST(@UserId AS VARCHAR(10))+',
					@Status='+CAST(@Status AS VARCHAR(10));
		
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_InsertUpdatePromotions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeGiftCard' AND COLUMN_NAME = 'IsActive')
BEGIN
    ALTER TABLE ZnodeGiftCard ALTER COLUMN IsActive BIT NOT NULL;
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeGiftCard' AND COLUMN_NAME = 'RemainingAmount')
BEGIN
    ALTER TABLE ZnodeGiftCard ALTER COLUMN RemainingAmount NUMERIC (26, 6) NULL;
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeGiftCard' AND COLUMN_NAME = 'RestrictToCustomerAccount')
BEGIN
    ALTER TABLE ZnodeGiftCard ALTER COLUMN RestrictToCustomerAccount BIT NOT NULL;
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeGiftCard' AND COLUMN_NAME = 'StartDate')
BEGIN
    ALTER TABLE ZnodeGiftCard ALTER COLUMN StartDate DATETIME NOT NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'ProductType')
BEGIN
	ALTER TABLE ZnodePimProduct ADD ProductType NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'ProductName')
BEGIN
	ALTER TABLE ZnodePimProduct ADD ProductName NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'SKU')
BEGIN
	ALTER TABLE ZnodePimProduct ADD SKU NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'ProductCode')
BEGIN
	ALTER TABLE ZnodePimProduct ADD ProductCode NVARCHAR (MAX) NULL;
END            
    	            
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'Assortment')
BEGIN
	ALTER TABLE ZnodePimProduct ADD Assortment NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'Brand')
BEGIN
	ALTER TABLE ZnodePimProduct ADD Brand NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'Vendor')
BEGIN
	ALTER TABLE ZnodePimProduct ADD Vendor NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'Highlights')
BEGIN
	ALTER TABLE ZnodePimProduct ADD Highlights NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'ProductImage')
BEGIN
	ALTER TABLE ZnodePimProduct ADD ProductImage NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'IsActive')
BEGIN
	ALTER TABLE ZnodePimProduct ADD IsActive NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'Weight')
BEGIN
	ALTER TABLE ZnodePimProduct ADD [Weight] NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'IsDownloadable')
BEGIN
	ALTER TABLE ZnodePimProduct ADD IsDownloadable NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'Color')
BEGIN
	ALTER TABLE ZnodePimProduct ADD Color NVARCHAR (MAX) NULL;
END               
              
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'CategoryBanner')
BEGIN
	ALTER TABLE ZnodePimProduct ADD CategoryBanner NVARCHAR (MAX) NULL;
END             
        
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'CategoryName')
BEGIN
	ALTER TABLE ZnodePimProduct ADD CategoryName NVARCHAR (MAX) NULL;
END
              
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'CategoryTitle')
BEGIN
	ALTER TABLE ZnodePimProduct ADD CategoryTitle NVARCHAR (MAX) NULL;
END       
               
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'DisplayOrderCategory')
BEGIN
	ALTER TABLE ZnodePimProduct ADD DisplayOrderCategory NVARCHAR (MAX) NULL;
END      
        
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'CategoryImage')
BEGIN
	ALTER TABLE ZnodePimProduct ADD CategoryImage NVARCHAR (MAX) NULL;
END       
     
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'CategoryCode')
BEGIN
	ALTER TABLE ZnodePimProduct ADD CategoryCode NVARCHAR (MAX) NULL;
END             
             
GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePimProduct' AND COLUMN_NAME = 'FootCondition')
BEGIN
	ALTER TABLE ZnodePimProduct ADD FootCondition NVARCHAR (MAX) NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePortalCatalog' AND COLUMN_NAME = 'OldPublishCatalogId')
BEGIN
	ALTER TABLE ZnodePortalCatalog ADD OldPublishCatalogId INT NULL;
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodePublishCatalogLog_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePublishCatalogLog'))
BEGIN
	ALTER TABLE [dbo].[ZnodePublishCatalogLog] DROP CONSTRAINT [FK_ZnodePublishCatalogLog_ZnodePublishCatalog]
END

GO

IF EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_IsActive_SKULower_E2E28' AND object_id = OBJECT_ID('ZnodePublishProductEntity'))
BEGIN
	DROP INDEX IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_IsActive_SKULower_E2E28 ON ZnodePublishProductEntity
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'SKULower')
BEGIN
    ALTER TABLE ZnodePublishProductEntity ALTER COLUMN SKULower NVARCHAR (300) NULL;
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'ElasticSearchEvent')
BEGIN
    ALTER TABLE ZnodePublishProductEntity ALTER COLUMN ElasticSearchEvent INT NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'ModifiedDate')
BEGIN
	ALTER TABLE ZnodePublishProductEntity ADD ModifiedDate DATETIME NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'IsSingleProductPublish')
BEGIN
	ALTER TABLE ZnodePublishProductEntity ADD IsSingleProductPublish BIT NULL;
END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'IsCacheClear')
BEGIN
	ALTER TABLE ZnodePublishProductEntity ADD IsCacheClear BIT NULL;
END

GO

IF EXISTS (SELECT * FROM sys.views WHERE name='View_ManageProductTypeAssociationList' and type='v')
	DROP View View_ManageProductTypeAssociationList;
GO

CREATE View [dbo].[View_ManageProductTypeAssociationList]
AS
with AttributeValuePvot AS (
SELECT        zpald.PimProductId,  zpavl1.AttributeValue AttributeValue, zpa.AttributeCode,zpafl.AttributeFamilyName,Zpald.PimProductTypeAssociationId, zpav.PimProductId RelatedProductId,zpal.LocaleId
FROM            ZnodePimAttribute zpa INNER JOIN
                         ZnodePimAttributeLocale zpal ON (zpa.PimAttributeId = zpal.PimAttributeId) INNER JOIN
						 ZnodePimAttributeValue zpav ON (zpa.PimAttributeId = zpav.PimAttributeId) INNER JOIN
                         ZnodePimAttributeValueLocale zpavl ON (zpavl.PimAttributeValueId = zpav.PimAttributeValueId AND zpal.LocaleId = zpavl.LocaleId)
						 LEFT JOIN  ZnodePimProductTypeAssociation zpald ON (zpald.PimParentProductId = zpav.PimProductId )
						  Left JOIN  ZnodePimAttributeValue zpav1 ON (zpa.PimAttributeId = zpav1.PimAttributeId AND zpav1.PimProductId = zpald.PimProductId) INNER JOIN
                         ZnodePimAttributeValueLocale zpavl1 ON (zpavl1.PimAttributeValueId = zpav1.PimAttributeValueId AND zpavl.localeid = zpal.localeid)
						 LEFT JOIN ZnodePimAttributeFamily zpaf ON (zpav.PimAttributeFamilyId=zpaf.PimAttributeFamilyId )
						 INNER JOIN ZnodePimFamilyLocale zpafl ON (zpafl.PimAttributeFamilyId=zpaf.PimAttributeFamilyId AND zpal.LocaleId=zpafl.LocaleId )
						 --LEFT JOIN ZnodePimAttributeValueLocale zpavl1 ON (zpa.PimAttributeValueId = zpav.PimAttributeValueId AND zpa.LocaleId = zpavl.LocaleId)
WHERE        zpa.AttributeCode IN ('ProductName','ProductType', 'SKU', 'Price', 'Quantity', 'Status','Assortment')
)

-- SEELCT * FROM ZnodePimAttributeValue


SELECT zpp.PimProductid ProductId, piv.[ProductName], piv.ProductType,piv.AttributeFamilyName  AttributeFamily , piv.[SKU], [Price], [Quantity], [Status],PIV.[Assortment],PimProductTypeAssociationId,RelatedProductId,Piv.LocaleId
FROM ZNodePimProduct zpp 
INNER JOIN  AttributeValuePvot 
PIVOT 
(
 Max(AttributeValue) FOR AttributeCode  IN ([ProductName],[SKU],[Price],[Quantity],[Status],[Assortment],[ProductType] )
)Piv  ON (Piv.PimProductId = zpp.PimProductid)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCatalogList')
	DROP PROC Znode_GetCatalogList
GO


CREATE PROCEDURE [dbo].[Znode_GetCatalogList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetCatalogList '',100,1,'',0
	  EXEC  Znode_GetCatalogList null,100,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_CatalogId TABLE (PimCatalogId int, PublishCatalogLogId int,CatalogName VARCHAR(max),PublishStatus VARCHAR(300),RowId INT ,CountId INT,PublishCreatedDate DATETIME ,PublishModifiedDate DATETIME,PublishCategoryCount INT ,PublishProductCount INT, IsActive BIT, CatalogCode  nvarchar(100))
	 
		 SET @SQL = '

		;With Cte_MaxPublish AS 
		(
			 SELECT max(PublishCatalogLogId) PublishCatalogLogId,PimCatalogId
			 FROM ZnodePublishCatalogLog ZPCL   
			 GROUP BY PimCatalogId
		)
		,Cte_CatalogLog AS (
		SELECT ZPC.CatalogName CatalogName, PublishCatalogLogId PublishCatalogLogId,  TYU.DisplayName   PublishStatus ,ZPC.PimCatalogId
		,ZPCL.CreatedDate AS PublishCreatedDate,ZPCL.ModifiedDate AS PublishModifiedDate,
		ISNULL(0,0)PublishCategoryCount,ISNULL(0,0) PublishProductCount,ZPC.IsActive, ZPC.CatalogCode
		FROM ZnodePimCatalog ZPC 
		LEFT JOIN ZnodePublishCatalogLog ZPCL  ON ( EXISTS (SELECT TOP 1 1 FROM Cte_MaxPublish CTE 											
		WHERE CTE.PimCatalogId = ZPC.PimCatalogId AND CTE.PublishCatalogLogId =  ZPCL.PublishCatalogLogId) )	
		LEFT JOIN ZnodePublishState TYU ON (TYU.PublishStateId = ZPCL.PublishStateId )
		
		)
	     ,Cte_PublishStatus 
		 AS (
		 SELECT PimCatalogId, PublishCatalogLogId, CatalogName, PublishStatus,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive,CatalogCode,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'PublishCatalogLogId DESC')+' , Count(*)Over() CountId FROM Cte_CatalogLog
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT PimCatalogId, PublishCatalogLogId,CatalogName,PublishStatus,RowId,CountId,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive,CatalogCode
		 FROM Cte_PublishStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	

	     PRINT @sql 
		 INSERT INTO @TBL_CatalogId 
		 EXEC (@SQL)

		 SELECT  PimCatalogId,PublishCatalogLogId,CatalogName,PublishStatus,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive, CatalogCode
		 FROM @TBL_CatalogId

		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_CatalogId),0)
	 

	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCatalogList @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS
			VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetCatalogList',
					@ErrorInProcedure = 'Znode_GetCatalogList',
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportStatusForCatalogPublish')
	DROP PROC Znode_GetImportStatusForCatalogPublish
GO


CREATE PROCEDURE [dbo].[Znode_GetImportStatusForCatalogPublish]
(
   @Status bit = 0 Out
)
AS 
--EXEC Znode_GetImportStatusForCatalogPublish
BEGIN

SET NOCOUNT ON
 BEGIN TRY
	 DECLARE @TemplateName  NVARCHAR(MAX) = N'Product,Pricing,Inventory,Category,ProductAttribute,CategoryAssociation,ProductAssociation,SEODetails,ProductUpdate,AddonAssociation,AttributeDefaultValue';
   
	DECLARE @TBL_Template TABLE (TemplateId INT);

	INSERT INTO @TBL_Template  
	SELECT ZIPL.ImportTemplateId FROM ZnodeImportHead ZIH INNER JOIN
	                            ZnodeImportTemplate ZIPL on ZIPL.ImportHeadId = ZIH.ImportHeadId
								WHERE ZIH.Name IN (SELECT CAST(value AS nvarchar) FROM STRING_SPLIT(@TemplateName,','))
	
	IF EXISTS (SELECT TOP 1 1 FROM ZnodeImportProcessLog ZIPL INNER JOIN 
	          @TBL_Template TBL ON ZIPL.ImportTemplateId = TBL.TemplateId
	          WHERE ZIPL.Status = dbo.Fn_GetImportStatus(0) OR ZIPL.Status = dbo.Fn_GetImportStatus(1))
	 BEGIN
	   SET @Status = 0;
	   SELECT 0 Id,@Status [Status]
	 END
	ELSE
	 BEGIN
	   SET @Status = 0;
	   SELECT 1 Id,@Status [Status]
	 END
 END TRY
 BEGIN CATCH
		     SET @Status = 0;
			 SELECT 2 Id,@Status [Status]

		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
			 @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			 @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportStatusForCatalogPublish';                   

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetImportStatusForCatalogPublish',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
 END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductDataForWebStore')
	DROP PROC Znode_GetProductDataForWebStore
GO



CREATE PROCEDURE [dbo].[Znode_GetProductDataForWebStore]  
(   @SKU              [dbo].[SelectColumnList] READONLY,  
    @PublishCatalogId int = 0 ,  
    @PublishProductId VARCHAR(MAX),  
    @PortalId         INT,  
    @LocaleId         INT)  
AS   
  /*    
    Summary: WebStore: SP for getting products data   
       Get average rating of products   
       Get Price / Inventory / SEO details .  
    Unit Testing  
 begin tran     
    EXEC [Znode_GetProductDataForWebStore] 'SKBCA1112,SKWI122,SKFVR123,FVZK0237,SKPMAR123,SKLS232',0,'96,92,98,103,94,97',@PortalId=2 ,@LocaleId=1  
    EXEC [Znode_GetProductDataForWebStore] 'SKPMAR123',3,'',@PortalId=1 ,@LocaleId=0  
 rollback tran  
   */  
     BEGIN  
         BEGIN TRAN A;  
         BEGIN TRY  
             SET NOCOUNT ON;  
  
             DECLARE @Tlb_SKU TABLE  
             (SKU        VARCHAR(100),  
              SequenceNo INT IDENTITY  
             );  
	If EXISTS(select * from @SKU)
		INSERT INTO @Tlb_SKU(SKU) SELECT StringColumn FROM @SKU;  
	Else if @PublishCatalogId > 0   
		INSERT INTO @Tlb_SKU(SKU)   
		select Distinct ZPCP.SKU  from ZnodePublishProductEntity  ZPCP
		where  ZPCP.ZnodeCatalogId = @PublishCatalogId  
  
             DECLARE @Tlb_PublishProduct TABLE  
             (PublishProductId INT,  
              SequenceNo       INT IDENTITY,
			  PublishCatalogId INT
             );  
  
    If @PublishProductId <> '' 
	Begin
		 INSERT INTO @Tlb_PublishProduct(PublishProductId, PublishCatalogId)  
		 SELECT Distinct ZPCP.ZnodeProductId, ZPCP.ZnodeCatalogId 
		 FROM ZnodePublishProductEntity ZPCP 
		 INNER JOIN Dbo.split(@PublishProductId, ',') PPI ON ZPCP.ZnodeProductId = PPI.Item;   
	End
    Else if @PublishCatalogId > 0   
	Begin
		INSERT INTO @Tlb_PublishProduct(PublishProductId,PublishCatalogId)  
		select Distinct ZPCP.ZnodeProductId,ZPCP.ZnodeCatalogId  
		from ZnodePublishProductEntity ZPCP 
		where  ZPCP.ZnodeCatalogId = @PublishCatalogId  
    End
	Else if @PublishCatalogId = 0 AND  @PublishProductId = ''   AND    exists(select * from @SKU)
	Begin
		INSERT INTO @Tlb_PublishProduct(PublishProductId,PublishCatalogId)  
		SELECT Distinct ZPPD.ZnodeProductId,ZPPD.ZnodeCatalogId  
		FROM ZnodePublishProductEntity ZPPD 
		INNER JOIN @Tlb_SKU TSK ON (ZPPD.SKU = TSK.SKU)
		
	End  
  
  
    CREATE TABLE #Tlb_ProductData   
             (PublishProductId INT,  
              SKU              NVARCHAR(100),  
              SEOTitle         NVARCHAR(200),  
              SEODescription   NVARCHAR(MAX),  
              SEOKeywords      NVARCHAR(MAX),  
              SEOUrl           NVARCHAR(MAX),  
              Rating           Numeric(28,6),  
              TotalReviews     INT,
			  IsPublish        bit,
			  CanonicalURL VARCHAR(200),   
			  RobotTag VARCHAR(50),
			  PublishCatalogId INT
             );  
  
             INSERT INTO #Tlb_ProductData (PublishProductId,SKU,PublishCatalogId)  
             SELECT PP.PublishProductId,SK.SKU, PP.PublishCatalogId FROM @Tlb_PublishProduct AS PP INNER JOIN @Tlb_SKU AS SK ON PP.SequenceNo = SK.SequenceNo;  
  
             DECLARE @Tlb_CustomerAverageRatings TABLE  
             (PublishProductId INT,  
              Rating           NUMERIC(28,6),  
              TotalReviews     INT  
             );   
             -- Calculate Average rating   
             INSERT INTO @Tlb_CustomerAverageRatings(PublishProductId,Rating,TotalReviews)  
             SELECT CCR.PublishProductId,SUM(CAST(CCR.Rating AS NUMERIC(28,6)) )/ COUNT(CCR.PublishProductId),COUNT(CCR.PublishProductId)   
    FROM ZnodeCMSCustomerReview AS CCR  
             INNER JOIN #Tlb_ProductData AS PD ON CCR.PublishProductId = PD.PublishProductId AND CCR.Status = 'A'   
    AND  (CCR.PortalId  = @PortalId OR @PortalId = 0 )  
    GROUP BY CCR.PublishProductId    ;  
  
             UPDATE PD SET PD.Rating = CAR.Rating,PD.TotalReviews = CAR.TotalReviews   
    FROM @Tlb_CustomerAverageRatings CAR  
             INNER JOIN #Tlb_ProductData PD ON CAR.PublishProductId = PD.PublishProductId;  
  
    UPDATE PD SET PD.SEOTitle = ZCSDL.SEOTitle,PD.SEODescription = ZCSDL.SEODescription,PD.SEOKeywords = ZCSDL.SEOKeywords,PD.SEOUrl = ZCSO.SEOUrl, PD.IsPublish = ZCSO.IsPublish,
	              PD.CanonicalURL = ZCSDL.CanonicalURL, PD.RobotTag = ZCSDL.RobotTag
    FROM #Tlb_ProductData PD  
             INNER JOIN ZnodeCMSSEODetail ZCSO ON PD.SKU = ZCSO.SEOCode  
             LEFT JOIN ZnodeCMSSEODetailLocale ZCSDL ON(ZCSDL.CMSSEODetailId = ZCSO.CMSSEODetailId AND ZCSDL.LocaleId = @LocaleId)  
             INNER JOIN ZnodeCMSSEOType ZCOT ON ZCOT.CMSSEOTypeId = ZCSO.CMSSEOTypeId AND ZCOT.Name = 'Product'  
    WHERE ZCSO.PortalId = @PortalId  
  
    UPDATE PD SET PD.SEOTitle = ZCPS.ProductTitle,PD.SEODescription = ZCPS.ProductDescription,PD.SEOKeywords = ZCPS.ProductKeyword 
	FROM #Tlb_ProductData PD  
    INNER JOIN ZnodeCMSPortalSEOSetting ZCPS ON ZCPS.PortalId = @PortalId 
	WHERE PD.SEOTitle IS NULL AND PD.SEODescription IS NULL AND PD.SEOKeywords IS NULL AND PD.SEOUrl IS NULL  
     --AND ZCSO.PortalId = @PortalId  

    SELECT PD.PublishCatalogId , PD.PublishProductId,PD.SKU,PD.SEOTitle,PD.SEODescription,PD.SEOKeywords,PD.SEOUrl,PD.Rating,PD.TotalReviews, 
		   CASE WHEN ISNULL(PD.IsPublish,0) = 0  THEN 'Draft' ELSE 'Published' END PublishStatus, PD.CanonicalURL, PD.RobotTag    
    FROM #Tlb_ProductData PD 
	--LEFT Outer join ZnodePublishCategoryProduct ZPCP  ON PD.PublishProductId = ZPCP.PublishProductId ;
	               
    COMMIT TRAN A;  
     
         END TRY  
         BEGIN CATCH  
              DECLARE @Status BIT ;  
       SET @Status = 0;  
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductDataForWebStore @PublishProductId='+@PublishProductId+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
             EXEC Znode_InsertProcedureErrorLog  
    @ProcedureName = 'Znode_GetProductDataForWebStore',  
    @ErrorInProcedure = @Error_procedure,  
    @ErrorMessage = @ErrorMessage,  
    @ErrorLine = @ErrorLine,  
    @ErrorCall = @ErrorCall;  
         END CATCH;  
     END;
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchProfileList')
	DROP PROC Znode_GetSearchProfileList
GO


CREATE PROCEDURE [dbo].[Znode_GetSearchProfileList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetSearchProfileList '',100,1,'',0
*/
BEGIN 
	BEGIN TRY 
	SET NOCOUNT ON 

		DECLARE @SQL  NVARCHAR(MAX);

		DECLARE @PublishStateIdForForNotPublishedState INT = dbo.Fn_GetPublishStateIdForForNotPublishedState()

		DECLARE @TBL_CatalogId TABLE 
		(PublishCatalogId int ,CatalogName NVARCHAR(2000), SearchProfileId INT , SearchQueryTypeId INT , ProfileName NVARCHAR(2000),
			QueryTypeName NVARCHAR(2000),QueryBuilderClassName  NVARCHAR(2000),SearchSubQueryTypeId INT,SubQueryTypeName  NVARCHAR(2000),
			SubQueryBuilderClassName  NVARCHAR(2000),--RowId INT ,
			PortalId INT,PortalName NVARCHAR(MAX),IsDefault BIT,CountId INT,CreatedDate Datetime,PublishStateId INT,CatalogCode VARCHAR(300), 
			PublishStatus VARCHAR(50)
		)
		
	 
		SET @SQL = '
		;With Cte_CatalogLog AS 
		(
		Select dd.PublishCatalogId,zpc.CatalogName,B.SearchProfileId,  b.SearchQueryTypeId ,b.ProfileName,c.QueryTypeName,c.QueryBuilderClassName,
			b.SearchSubQueryTypeId,d.QueryTypeName SubQueryTypeName,d.QueryBuilderClassName SubQueryBuilderClassName,ZPSP.PortalId,ZP.StoreName as PortalName,
			isnull(ZPSP.IsDefault,0) as Isdefault, B.CreatedDate,B.PublishStateId,ZPC.CatalogCode, PS.DisplayName As PublishStatus
		FROM ZnodeSearchProfile B 
		INNER JOIN ZnodePublishCatalogSearchProfile dd on  dd.SearchProfileId=b.SearchProfileId
		LEFT JOIN ZnodePimCatalog zpc on ZPC.PimCatalogId = dd.PublishCatalogId
		INNER JOIN ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
		LEFT JOIN ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
		LEFT JOIN ZnodePortalSearchProfile ZPSP ON (ZPSP.SearchProfileId = B.SearchProfileId AND ZPSP.PublishCatalogId = DD.PublishCatalogId)
		LEFT JOIN ZnodePortal ZP ON (ZP.PortalId = ZPSP.PortalId)
		LEFT JOIN ZnodePublishState PS ON ISNULL(B.PublishStateId,'+CAST(@PublishStateIdForForNotPublishedState AS VARCHAR(10))+') = PS.PublishStateId
		)	 
			,Cte_PublishStatus AS 
		(
		SELECT PublishCatalogId,CatalogName,SearchProfileId , SearchQueryTypeId ,ProfileName,QueryTypeName,QueryBuilderClassName,SearchSubQueryTypeId,
			SubQueryTypeName,SubQueryBuilderClassName,PortalId,PortalName,IsDefault,PublishStateId,
			'+[dbo].[Fn_GetPagingRowId](@Order_BY,'SearchProfileId DESC')+' , Count(*) Over () CountId ,CreatedDate,CatalogCode,PublishStatus
		FROM Cte_CatalogLog
		WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		SELECT PublishCatalogId,CatalogName,SearchProfileId , SearchQueryTypeId ,ProfileName,QueryTypeName,QueryBuilderClassName, SearchSubQueryTypeId,
			SubQueryTypeName,SubQueryBuilderClassName,PortalId,PortalName,IsDefault,CountId, CreatedDate,PublishStateId,CatalogCode,PublishStatus
		FROM Cte_PublishStatus 
		'+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	
		PRINT @sql

		INSERT INTO @TBL_CatalogId 
		EXEC (@SQL)

		SELECT PublishCatalogId,CatalogName,SearchProfileId, SearchQueryTypeId,	ProfileName,QueryTypeName,QueryBuilderClassName,SearchSubQueryTypeId,
			SubQueryTypeName,SubQueryBuilderClassName,PortalId,PortalName,IsDefault,CountId, a.CreatedDate,a.PublishStatus,a.CatalogCode
		FROM @TBL_CatalogId a
		
		SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_CatalogId),0)

	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		SELECT ERROR_MESSAGE()
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 
					'EXEC Znode_GetSearchProfileList 
						@WhereClause = '''+ISNULL(@WhereClause,'''''')+''',
						@Rows='+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+',
						@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',
						@Order_BY='''+ISNULL(@Order_BY,'''''')+''',
						@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''');
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetSearchProfileList',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetStoreList')
	DROP PROC Znode_GetStoreList
GO


CREATE PROCEDURE [dbo].[Znode_GetStoreList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
	@UserId		 INT=0,
    @RowsCount   INT OUT

)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the Portal 
	 Unit Testig
	 begin tran 
	 EXEC  Znode_GetStoreList '',100,'','',0

	 EXEC  Znode_GetStoreList '',100,1,null,2,0
	 rollback tran
	 select * from ZnodeDomain
*/
   BEGIN 
		BEGIN TRY 
			SET NOCOUNT ON 

			 DECLARE @SQL  NVARCHAR(MAX) 
			 DECLARE @TBL_PortalId TABLE (PortalId INT, PublishPortalLogId INT,StoreName NVARCHAR(MAX),CompanyName NVARCHAR(MAX),LogoPath NVARCHAR(MAX),UseSSL BIT,AdminEmail 
			 NVARCHAR(MAX),SalesEmail NVARCHAR(MAX),CustomerServiceEmail NVARCHAR(MAX),SalesPhoneNumber NVARCHAR(MAX),CustomerServicePhoneNumber NVARCHAR(MAX),ImageNotAvailablePath NVARCHAR(MAX),ShowSwatchInCategory BIT,
			 ShowAlternateImageInCategory BIT,ExternalID VARCHAR(50),MobileLogoPath NVARCHAR(MAX),DefaultOrderStateID INT,DefaultReviewStatus NVARCHAR(2),SplashCategoryID INT,SplashImageFile NVARCHAR(MAX),
			 MobileTheme NVARCHAR(MAX),CopyContentBasedOnPortalId INT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME,InStockMsg NVARCHAR(max),OutOfStockMsg NVARCHAR(MAX),BackOrderMsg NVARCHAR(MAX)
			 ,PublishStatus VARCHAR(300),ThemeName VARCHAR(200),CSSName NVARCHAr(2000),CatalogName NVARCHAR(max),DomainUrl NVARCHAR(200),OrderStatus NVARCHAR(200),LocaleId INT,PublishCatalogId INT,StoreCode NVARCHAR(200),RowId INT ,CountId INT)
	

			 SET @SQL = '
			 ;With Cte_MaxPublish AS 
			 (
			 SELECT MAX(PublishPortalLogId) PublishPortalLogId,PortalId
			 FROM ZnodePublishPortalLog ZPCL  
			 GROUP BY PortalId
			 )
			 ,Cte_PortalLog AS (
			 SELECT ZPC.StoreName ,ZPC.CompanyName ,ZPC.LogoPath ,ZPC.UseSSL ,ZPC.AdminEmail ,ZPC.SalesEmail ,ZPC.CustomerServiceEmail ,ZPC.SalesPhoneNumber ,ZPC.CustomerServicePhoneNumber ,
			 ZPC.ImageNotAvailablePath ,ZPC.ShowSwatchInCategory ,ZPC.ShowAlternateImageInCategory ,ZPC.ExternalID ,ZPC.MobileLogoPath ,ZPC.DefaultOrderStateID ,ZPC.DefaultReviewStatus ,
			 ZPC.SplashCategoryID ,ZPC.SplashImageFile ,ZPC.MobileTheme ,ZPC.CopyContentBasedOnPortalId ,
			 ZPC.CreatedBy ,ZPC.CreatedDate ,ZPC.ModifiedBy ,ZPC.ModifiedDate ,ZPC.InStockMsg ,ZPC.OutOfStockMsg ,ZPC.BackOrderMsg , PublishPortalLogId ,DT.DisplayName    PublishStatus ,ZPC.PortalId
			 , ZCT.Name as ThemeName, ZCTC.CSSName, ZPUC.CatalogName,
			 CASE WHEN ZD.DomainName IS NULL  THEN ''#'' ELSE ZD.DomainName END DomainUrl,ZOOS.Description OrderStatus,
			 ZPL.LocaleId, ZPPC.PublishCatalogId,ZPC.StoreCode
			FROM ZnodePortal ZPC 
			INNER JOIN ZnodeCMSPortalTheme AS ZCPT ON (ZCPT.PortalId = ZPC.PortalId )
			INNER JOIN ZnodeCMSThemeCSS AS ZCTC ON ZCPT.CMSThemeCSSId = ZCTC.CMSThemeCSSId 
			INNER JOIN ZnodeCMSTheme AS ZCT ON ZCPT.CMSThemeId = ZCT.CMSThemeId AND ZCTC.CMSThemeId = ZCT.CMSThemeId 
			LEFT JOIN ZnodePortalCatalog ZPCI ON ZPCI.PortalId = ZPC.PortalId 
			LEFT JOIN ZnodePimCatalog ZPUC ON ZPCI.PublishCatalogId = ZPUC.PimCatalogId 
			LEFT JOIN ZnodeOmsOrderState ZOOS ON ZPC.DefaultOrderStateID = ZOOS.OmsOrderStateId
			LEFT JOIN ZnodePortalCatalog ZPPC ON ZPPC.PortalId = ZPC.PortalId
			LEFT JOIN ZnodePortalLocale ZPL ON (ZPL.LocaleId = ( select TOP 1 LocaleId from ZnodePortalLocale WHERE ZPC.PortalId = ZPL.PortalId AND ZPL.IsDefault = 1)) 
			LEFT JOIN ZnodePublishPortalLog ZPCL  ON ( EXISTS (SELECT TOP 1 1 FROM Cte_MaxPublish CTE WHERE CTE.PortalId = ZPC.PortalId AND CTE.PublishPortalLogId =  ZPCL.PublishPortalLogId)  )
			LEFT JOIN ZnodePublishState DT ON (DT.PublishStateId = ZPCL.PublishStateId)
			LEFT JOIN ZnodeDomain ZD ON (ZD.DomainId = (SELECT TOP 1 DomainId FROM ZnodeDomain ZDR WHERE ZDR.PortalId = ZPC.PortalId AND ZDR.IsActive = 1 AND ZDR.ApplicationType = ''WebStore''))
			WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeUserPortal ZUP WHERE (ZUP.PortalId=ZPC.PortalId OR ZUP.PortalId IS NULL)   AND ZUP.UserId='+CAST(@UserId AS VARCHAR (200)) +')
			 )
			 ,Cte_PublishStatus 
			 AS (
			 SELECT PortalId,PublishPortalLogId, StoreName,CompanyName,LogoPath,UseSSL,AdminEmail,SalesEmail,CustomerServiceEmail,SalesPhoneNumber,CustomerServicePhoneNumber,ImageNotAvailablePath,
			 ShowSwatchInCategory,ShowAlternateImageInCategory,ExternalID,MobileLogoPath,DefaultOrderStateID,DefaultReviewStatus,SplashCategoryID,SplashImageFile,MobileTheme,CopyContentBasedOnPortalId,
			 CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,InStockMsg,OutOfStockMsg,BackOrderMsg, PublishStatus,ThemeName,CSSName,CatalogName,DomainUrl,OrderStatus,LocaleId,PublishCatalogId,StoreCode,
			 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'PortalId ,PublishPortalLogId DESC')+' , Count(*)Over() CountId FROM Cte_PortalLog
			 WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
			 SELECT PortalId,PublishPortalLogId,StoreName,CompanyName,LogoPath,UseSSL,AdminEmail,SalesEmail,CustomerServiceEmail,SalesPhoneNumber,CustomerServicePhoneNumber,ImageNotAvailablePath,
			 ShowSwatchInCategory,ShowAlternateImageInCategory,ExternalID,MobileLogoPath,DefaultOrderStateID,DefaultReviewStatus,SplashCategoryID,SplashImageFile,MobileTheme,CopyContentBasedOnPortalId,
			 CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,InStockMsg,OutOfStockMsg,BackOrderMsg,PublishStatus,ThemeName,CSSName,CatalogName,DomainUrl,OrderStatus,LocaleId,PublishCatalogId,StoreCode,RowId,CountId 
			 FROM Cte_PublishStatus 
			 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)
	

	         PRINT @SQL
			 INSERT INTO @TBL_PortalId 
			
			 EXEC (@SQL)

			 SET @RowsCount = ISNULL((SELECT TOP 1 CountId FROM @TBL_PortalId),0)

		
			 SELECT  PortalId,PublishPortalLogId,StoreName,CompanyName,LogoPath,UseSSL,AdminEmail,SalesEmail,CustomerServiceEmail,SalesPhoneNumber,CustomerServicePhoneNumber,ImageNotAvailablePath,
			 ShowSwatchInCategory,ShowAlternateImageInCategory,ExternalID,MobileLogoPath,DefaultOrderStateID,DefaultReviewStatus,SplashCategoryID,SplashImageFile,MobileTheme,CopyContentBasedOnPortalId,
			 CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,InStockMsg,OutOfStockMsg,BackOrderMsg,PublishStatus,ThemeName,CSSName,CatalogName,DomainUrl,OrderStatus,LocaleId,PublishCatalogId,StoreCode
			 FROM @TBL_PortalId
	 
				

		 END TRY 
		 BEGIN CATCH 
		 SELECT ERROR_MESSAGE()
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetStoreList @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS
			VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')
             
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		 
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetStoreList',
					@ErrorInProcedure = 'Znode_GetStoreList',
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportInsertUpdatePimProduct')
	DROP PROC Znode_ImportInsertUpdatePimProduct
GO


CREATE PROCEDURE [dbo].[Znode_ImportInsertUpdatePimProduct]
(
    @PimProductDetail  PIMPRODUCTDETAIL READONLY,
    @UserId            INT       ,
    @status            BIT    OUT,
    @IsNotReturnOutput BIT    = 0,
	@CopyPimProductId  INT	  = 0 )
AS
   /*
     Summary : To Insert / Update single Product with multiple attribute values 
     Update Logic: 
*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
			 DECLARE @PimProductId INT;
			 DECLARE @TBL_PimProductId TABLE(PimAttributeValueId INT,ZnodePimAttributeValueLocaleId INT );
			 DECLARE @TBL_CopyPimProductId TABLE(PimAttributeValueId INT,OldPimAttributeValueId INT);
			 DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId()
			 DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 DECLARE @TBL_DefaultAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeId TABLE (PimAttributeId INT PRIMARY KEY, AttributeCode VARCHAR(600))
			 DECLARE @TBL_TextAreaAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeValue TABLE (PimAttributeValueId INT ,LocaleId INT ,AttributeValue VARCHAr(300),MediaId INT)
			 DECLARE @TBL_DefaultAttributeValue TABLE (PimAttributeValueId INT , LocaleId INT , AttributeValue INT)
			 DECLARE @ZnodePimAttributeValue TABLE (PimAttributeValueId  INT, PimAttributeFamilyId INT,PimAttributeId INT);

			 DECLARE @AssociatedProduct VARCHAR(4000);
			 DECLARE @ConfigureAttributeId VARCHAR(4000);
			 DECLARE @ConfigureFamilyId VARCHAR(4000);
			 DECLARE @PimAttributeFamilyId INT;
			 DECLARE @LocaleId INT 

			 DECLARE @pimSkuAttributeId VARCHAR(50) = [dbo].[Fn_GetProductSKUAttributeId] ()
			 DECLARE @pimProductNameAttributeId VARCHAR(50) =[dbo].Fn_GetProductNameAttributeId ()
			 DECLARE @PimIsDownlodableAttributeId VARCHAR(50) = [dbo].[Fn_GetIsDownloadableAttributeId]()
			 Declare @SKU nvarchar(300),@ProductName nvarchar(300)
			 Select * into #PimProductDetail from @PimProductDetail
			
			--DECLARE @PimAttributeFamily VARCHAR(50) =  [dbo].[Fn_GetAttributeFamilyId]()
			--Update #PimProductDetail SET AttributeValue = 
			--(SELECT FamilyCode from ZnodePimAttributeFamily where PimAttributeFamilyId = @PimAttributeFamilyId)
			--where PimAttributeId = @PimAttributeFamily

			--DECLARE @PimAttributeIsPublish VARCHAR(50) =  [dbo].[Fn_GetAttributeIsPublish]()
			 
			--insert into #PimProductDetail ([PimAttributeId],[PimAttributeFamilyId],[ProductAttributeCode],[ProductAttributeDefaultValueId],
			--[PimAttributeValueId],	[LocaleId],[PimProductId],[AttributeValue],[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]) 
			 
			--SELECT TOP 1 @PimAttributeIsPublish,[PimAttributeFamilyId],'PublishStatus' ProductAttributeCode,NULL ProductAttributeDefaultValueId,
			--NULL PimAttributeValueId,	[LocaleId],[PimProductId],
			--CASE when isnull([PimProductId] ,0) > 1 then 'Draft' else 'Not Publish' END AttributeValue,
			--[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]
			--from @PimProductDetail  


			INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM  [dbo].[Fn_GetDefaultAttributeId] ()
			 
			 INSERT INTO @TBL_MediaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM [dbo].[Fn_GetProductMediaAttributeId]()

			 INSERT INTO @TBL_TextAreaAttributeId (PimAttributeId ,AttributeCode)
			 SELECT PimAttributeId, AttributeCode   FROM [dbo].[Fn_GetTextAreaAttributeId]()

			 
			 SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId
                FROM #PimProductDetail;
             
			 

			 
			 
			 SELECT TOP 1 @LocaleId = LocaleId
                FROM #PimProductDetail;

             -- Retrive input productId from #PimProductDetail table ( having multiple attribute values with common productId) 

             SELECT TOP 1 @PimProductId = PimProductId
             FROM #PimProductDetail;
			
			DECLARE @PublishStateIdForDraft INT =  [dbo].[Fn_GetPublishStateIdForDraftState]()
			  DECLARE @PublishStateIdForNotPublished INT = [dbo].[Fn_GetPublishStateIdForForNotPublishedState]()

			

             IF ISNULL(@PimProductId, 0) = 0
                 BEGIN
                     INSERT INTO ZnodePimProduct
                     (PimAttributeFamilyId,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate ,PublishStateId
                     )
                            SELECT @PimAttributeFamilyId,
                                   @UserId,
                                   @GetDate,
                                   @UserId,
                                   @GetDate,@PublishStateIdForNotPublished ;
                     SET @PimProductId = SCOPE_IDENTITY();
					 If EXISTS (select TOP 1 1 from #PimProductDetail where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						
						Select TOP 1 @SKU  =  AttributeValue from  #PimProductDetail where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  #PimProductDetail where PimAttributeId =  @pimProductNameAttributeId
						insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 
					 End
		

                 END;
             ELSE 
                 BEGIN
                     UPDATE ZNodePimProduct
                       SET
                           PimAttributeFamilyId = @PimAttributeFamilyId,
						   PublishStateId = @PublishStateIdForDraft,
                           ModifiedBy = @UserId,
                           ModifiedDate = @GetDate
                     WHERE PimProductId = @PimProductId;

					Update ZnodePimProduct SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE()  where PimProductId in
					(select PimProductId  From ZnodePimProductTypeAssociation where PimParentProductId=@PimProductId )
            									
					 INSERT INTO @TBL_PimProductId(PimAttributeValueId)
					 SELECT ZPAV.PimAttributeValueId
                     FROM ZnodePimAttributeValue ZPAV
					 INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId AND ( @localeID = @DefaultLocaleId OR ZPA.IsLocalizable = 1 OR EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FN WHERE FN.PimAttributeId = ZPAV.PimAttributeId)))
					 INNER JOIN ZnodePimFamilyGroupMapper ZPFGMI  ON (ZPFGMI.PimAttributeId = ZPAV.PimAttributeId AND ZPFGMI.PimAttributeFamilyId = @PimAttributeFamilyId)
					 WHERE ZPAV.PimProductId = @PimProductId
					 AND NOT EXISTS
                            (
                                SELECT TOP 1 1
                                FROM #PimProductDetail TBPDI
                                WHERE TBPDI.PimAttributeId = ZPAV.PimAttributeId
                                      AND TBPDI.PimProductId = ZPAV.PimProductId
							 )
                     
				    --  SELECT * FROM @TBL_PimProductId

			
                     DELETE FROM ZnodePimAttributeValueLocale
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimAttributeValueLocale.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId;
					 DELETE  ZnodePimProductAttributeDefaultValue 
					  WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId;
					


					 DELETE FROM ZnodePimProductAttributeMedia 
					  WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeMedia.PimAttributeValueId 
								
                     ) 
					 AND LocaleId = @LocaleId;

					-- SELECT * FROM @TBL_PimProductId
					

					 DELETE FROM ZnodePimProductAttributeTextAreaValue
					   WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeTextAreaValue.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId ;

					 
                     DELETE FROM ZnodePimAttributeValue
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId
                     )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeTextAreaValue ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeDefaultValue ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeMedia ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId );
					
				
					
					If EXISTS (select TOP 1 1 from #PimProductDetail where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						Select TOP 1 @SKU  =  AttributeValue from  #PimProductDetail where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  #PimProductDetail where PimAttributeId =  @pimProductNameAttributeId

						insert into ZnodePimDownloadableProduct(SKU,ProductName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select TOP 1 PD.AttributeValue, @ProductName,@UserId , @GetDate, @UserId , @GetDate from  #PimProductDetail PD where  PD.PimAttributeId = @pimSkuAttributeId 
						AND not exists (select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  =  PD.AttributeValue)
						IF NOT Exists (	select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  = @SKU)
							insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
							Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 

					 End
                 END;
		
		 

		    MERGE INTO ZnodePimAttributeValue TARGET
              USING #PimProductDetail SOURCE
              ON(
				TARGET.PimProductId = @PimProductId
                AND TARGET.PimAttributeId = SOURCE.PimAttributeId)
                --AND ISNULL(TARGET.PimAttributeFamilyId, 0) = ISNULL(SOURCE.PimAttributeFamilyId, 0))
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.PimAttributeFamilyId = CASE
                                                                   WHEN Source.PimAttributeFamilyId = 0
                                                                   THEN NULL
                                                                   ELSE Source.PimAttributeFamilyId
                                                               END,
                                 --TARGET.PimAttributeDefaultValueId = CASE
                                 --                                        WHEN SOURCE.ProductAttributeDefaultValueId = 0
                                 --                                        THEN NULL
                                 --                                        ELSE SOURCE.ProductAttributeDefaultValueId
                                 --                                    END, 
                                 -- ,TARGET.AttributeValue					= SOURCE.AttributeValue
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeFamilyId,
                             PimProductId,
                             PimAttributeId,
                             PimAttributeDefaultValueId,
                             --,AttributeValue
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (CASE
                  WHEN Source.PimAttributeFamilyId = 0
                  THEN @PimDefaultFamily
                  ELSE Source.PimAttributeFamilyId
              END,
              @PimProductId,
              SOURCE.PimAttributeId,
              CASE
                  WHEN SOURCE.ProductAttributeDefaultValueId = 0
                  THEN NULL
                  ELSE SOURCE.ProductAttributeDefaultValueId
              END, 
              --,SOURCE.AttributeValue
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             )
             --WHEN NOT MATCHED BY SOURCE AND TARGET.PimProductId = @PimProductId
             --                               AND Target.PimAttributeFamilyId IS NOT NULL
             --THEN DELETE
             OUTPUT INSERTED.PimAttributeValueId,
                    INSERTED.PimAttributeFamilyId,
                    INSERTED.PimAttributeId
                    INTO @ZnodePimAttributeValue;
        		
		DECLARE @MediaData Table (MediaId INT , PimProductId INT , PimAttributeId INT ,PimAttributeFamilyId INT,LocaleId INT  )
	    
		INSERT INTO @MediaData (MediaId,PimProductId,PimAttributeId ,PimAttributeFamilyId, LocaleId)
		SELECT sp.item, a.PimProductId, a.PimAttributeId ,PimAttributeFamilyId,a.LocaleId
		FROM #PimProductDetail a
		CROSS APPLY dbo.split(a.AttributeValue,',' ) SP
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_MediaAttributeId c WHERE c.PimAttributeId = a.PimAttributeId ) 
				
				 
		INSERT INTO @TBL_MediaAttributeValue (PimAttributeValueId,LocaleId , AttributeValue,MediaId)
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                         zm.Path AttributeValue
						 ,ZM.MediaId
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN  @MediaData AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
				INNER JOIN ZnodeMedia ZM ON ( b.MediaId = ZM.MediaId )
		
		DELETE FROM ZnodePimProductAttributeMedia 
		WHERE EXISTS 
		 (SELECT TOP 1 1 FROM @TBL_MediaAttributeValue TBLM WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId 
		 AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId  AND ZnodePimProductAttributeMedia.Localeid = @LocaleId)



		MERGE INTO ZnodePimProductAttributeMedia TARGET 
		USING @TBL_MediaAttributeValue SOURCE 
		ON (        TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
		        AND TARGET.MediaPAth = SOURCE.AttributeValue
                  AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.MediaPath = SOURCE.AttributeValue,
						   TARGET.MediaId   = SOURCE.MediaId,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             MediaPath,
							 MediaId ,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
			  SOURCE.MediaId,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
		 --WHEN NOT MATCHED BY SOURCE AND EXISTS 
		 --(SELECT TOP 1 1 FROM @TBL_MediaAttributeValue TBLM WHERE TARGET.PimAttributeValueId = TBLM.PimAttributeValueId AND TBLM.MediaId = TARGET.MediaId  AND TARGET.Localeid = @LocaleId)
		 --  THEN 
		 --DELETE  ;


	   ;With Cte_TextAreaAttributeValue AS 
		 (
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_TextAreaAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		
		)
		
		MERGE INTO ZnodePimProductAttributeTextAreaValue TARGET 
		USING Cte_TextAreaAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );



        INSERT INTO @TBL_DefaultAttributeValue (PimAttributeValueId,LocaleId,AttributeValue)  
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        d.PimAttributeDefaultValueId  AttributeValue
        FROM @ZnodePimAttributeValue AS a
          INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_DefaultAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		INNER JOIN ZnodePimAttributeDefaultValue d ON (EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,',') SP WHERE d.PimAttributeId = b.PimAttributeId AND SP.Item = d.AttributeDefaultValueCode))
	
	     -- SELECT * FROM @TBL_DefaultAttributeValue

		--  SELECT * FROM Cte_DefaultAttributeValue
		DELETE FROM ZnodePimProductAttributeDefaultValue 
		WHERE  EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeValue TBLAV WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId 
												AND TBLAV.AttributeValue   <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId 
												 AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId )

		MERGE INTO ZnodePimProductAttributeDefaultValue TARGET 
		USING @TBL_DefaultAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
              AND TARGET.PimAttributeDefaultValueId =  SOURCE.AttributeValue
			    AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             PimAttributeDefaultValueId,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
			 --WHEN NOT MATCHED BY SOURCE  AND EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeValue TBLAV WHERE TBLAV.PimAttributeValueId = TARGET.PimAttributeValueId 
				--								AND TBLAV.AttributeValue   = TARGET.PimAttributeDefaultValueId  AND TARGET.LocaleId = @LocaleId )
			 --THEN 
			 --DELETE 
			 --;
		
   
			 
		   MERGE INTO ZnodePimAttributeValueLocale TARGET
             USING
             (
                 SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
                 FROM @ZnodePimAttributeValue AS a
                      INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                             AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
                 WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId  )
			     AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId  )
				 AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId  )
			 ) SOURCE
             ON(TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
             SET @AssociatedProduct =
             (
                 SELECT MAX(AssociatedProducts)
                 FROM #PimProductDetail AS a
             );
             INSERT INTO ZnodePimProductTypeAssociation
             (PimParentProductId,
              PimProductId,
              DisplayOrder,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           Item,
                           ID AS RowId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@AssociatedProduct, ',') AS b
                         INNER JOIN ZNodePimProduct AS q ON(q.PimProductId = b.Item)
						 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductTypeAssociation PPT
						 WHERE PPT.PimParentProductId = @PimProductId AND PPT.PimProductId = b.Item)


             SET @ConfigureAttributeId =
             (
                 SELECT MAX(ConfigureAttributeIds)
                 FROM #PimProductDetail AS a
             );
             SET @ConfigureFamilyId =
             (
                 SELECT MAX(ConfigureFamilyIds)
                 FROM #PimProductDetail AS a
             );
             INSERT INTO [ZnodePimConfigureProductAttribute]
             (PimProductId,
              PimFamilyId,
              PimAttributeId,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           @ConfigureFamilyId,
                           q.PimAttributeId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@ConfigureAttributeId, ',') AS b
                         INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimConfigureProductAttribute RTR  WHERE  RTR.PimProductId = @PimProductId AND RTR.PimAttributeId = q.PimAttributeId);



             IF @IsNotReturnOutput = 0
                 SELECT @PimProductId AS Id,
                        CAST(1 AS BIT) AS Status;
             SET @status = 1;

			 IF @CopyPimProductId > 0 
			 BEGIN 
			   INSERT INTO ZnodePimAttributeValueLocale  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimAttributeValueLocale ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId

			    INSERT INTO ZnodePimProductAttributeDefaultValue  (PimAttributeValueId,LocaleId,PimAttributeDefaultValueId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.PimAttributeDefaultValueId,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeDefaultValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId


			   INSERT INTO ZnodePimProductAttributeTextAreaValue  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeTextAreaValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   			   
			   INSERT INTO ZnodePimProductAttributeMedia  (PimAttributeValueId,LocaleId,MediaPath,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.MediaPath,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeMedia ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   
			 END 

				 IF @LocaleId = @DefaultLocaleId
			 BEGIN 	 
	
DECLARE @sqlt NVARCHAr(max) = ''
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int 

DECLARE Cur_AttributeDataUpdate CURSOR FOR 

SELECT b.AttributeCode , PimAttributeId 
FROM INFORMATION_SCHEMA.COLUMNS a 
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )
WHERE TABLE_NAME = 'ZnodePimProduct'
AND IsCategory = 0 
AND IsShowOnGrid = 1 
AND EXISTS (SELECT TOP 1 1 FROM #PimProductDetail n  WHERE n.ProductAttributeCode = b.AttributeCode  )
OPEN Cur_AttributeDataUpdate 
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
WHILE @@FETCH_STATUS = 0 
BEGIN 

 SET @sqlt = 'UPDATE a  
 SET '+@AttributeCodeAtt+'= AttributeValue 
 FROM ZnodePimProduct a 
 INNER JOIN #PimProductDetail m ON(m.PimProductId = a.pimProductId ) 
 WHERE m.ProductAttributeCode = '''+@AttributeCodeAtt+'''
 ' 

 EXEC (@sqlt)

FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
END 
CLOSE Cur_AttributeDataUpdate
DEALLOCATE Cur_AttributeDataUpdate 

END 

             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportInsertUpdatePimProduct @UserId = '+CAST(@UserId AS VARCHAR(50))+',@IsNotReturnOutput='+CAST(@IsNotReturnOutput AS VARCHAR(50))+',@CopyPimProductId='+CAST(@CopyPimProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportInsertUpdatePimProduct',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPartialInsertUpdatePimProduct')
	DROP PROC Znode_ImportPartialInsertUpdatePimProduct
GO

CREATE PROCEDURE [dbo].[Znode_ImportPartialInsertUpdatePimProduct]
(
    @PimProductDetail  PIMPRODUCTDETAIL READONLY,
    @UserId            INT       ,
    @status            BIT    OUT,
    @IsNotReturnOutput BIT    = 0,
	@CopyPimProductId  INT	  = 0 
)
AS
   /*
     Summary : To Insert / Update single Product with multiple attribute values 
     Update Logic: 
*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
			 DECLARE @PimProductId INT;
			 DECLARE @TBL_PimProductId TABLE(PimAttributeValueId INT,ZnodePimAttributeValueLocaleId INT );
			 DECLARE @TBL_CopyPimProductId TABLE(PimAttributeValueId INT,OldPimAttributeValueId INT);
			 DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId()
			 DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 DECLARE @TBL_DefaultAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeId TABLE (PimAttributeId INT PRIMARY KEY, AttributeCode VARCHAR(600))
			 DECLARE @TBL_TextAreaAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeValue TABLE (PimAttributeValueId INT ,LocaleId INT ,AttributeValue VARCHAr(300),MediaId INT)
			 DECLARE @TBL_DefaultAttributeValue TABLE (PimAttributeValueId INT , LocaleId INT , AttributeValue INT)
			 DECLARE @ZnodePimAttributeValue TABLE (PimAttributeValueId  INT, PimAttributeFamilyId INT,PimAttributeId INT);

			 DECLARE @AssociatedProduct VARCHAR(4000);
			 DECLARE @ConfigureAttributeId VARCHAR(4000);
			 DECLARE @ConfigureFamilyId VARCHAR(4000);
			 DECLARE @PimAttributeFamilyId INT;
			 DECLARE @LocaleId INT 

			 DECLARE @pimSkuAttributeId VARCHAR(50) = [dbo].[Fn_GetProductSKUAttributeId] ()
			 DECLARE @pimProductNameAttributeId VARCHAR(50) =[dbo].Fn_GetProductNameAttributeId ()
			 DECLARE @PimIsDownlodableAttributeId VARCHAR(50) = [dbo].[Fn_GetIsDownloadableAttributeId]()
			 Declare @SKU nvarchar(300),@ProductName nvarchar(300)
			 Select * into ##PimProductData from @PimProductDetail
			--DECLARE @PimAttributeFamily VARCHAR(50) =  [dbo].[Fn_GetAttributeFamilyId]()
			--Update ##PimProductData SET AttributeValue = 
			--(SELECT FamilyCode from ZnodePimAttributeFamily where PimAttributeFamilyId = @PimAttributeFamilyId)
			--where PimAttributeId = @PimAttributeFamily

			--DECLARE @PimAttributeIsPublish VARCHAR(50) =  [dbo].[Fn_GetAttributeIsPublish]()
			 
			--insert into ##PimProductData ([PimAttributeId],[PimAttributeFamilyId],[ProductAttributeCode],[ProductAttributeDefaultValueId],
			--[PimAttributeValueId],	[LocaleId],[PimProductId],[AttributeValue],[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]) 
			 
			--SELECT TOP 1 @PimAttributeIsPublish,[PimAttributeFamilyId],'PublishStatus' ProductAttributeCode,NULL ProductAttributeDefaultValueId,
			--NULL PimAttributeValueId,	[LocaleId],[PimProductId],
			--CASE when isnull([PimProductId] ,0) > 1 then 'Draft' else 'Not Publish' END AttributeValue,
			--[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]
			--from @PimProductDetail  


			INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM  [dbo].[Fn_GetDefaultAttributeId] ()
			 
			 INSERT INTO @TBL_MediaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM [dbo].[Fn_GetProductMediaAttributeId]()

			 INSERT INTO @TBL_TextAreaAttributeId (PimAttributeId ,AttributeCode)
			 SELECT PimAttributeId, AttributeCode   FROM [dbo].[Fn_GetTextAreaAttributeId]()

			 
			 SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId
                FROM ##PimProductData;
             			 
			 
			 SELECT TOP 1 @LocaleId = LocaleId
                FROM ##PimProductData;

             -- Retrive input productId from ##PimProductData table ( having multiple attribute values with common productId) 
			 DECLARE @PublishStateIdForDraft INT =  [dbo].[Fn_GetPublishStateIdForDraftState]()

             SELECT TOP 1 @PimProductId = PimProductId
             FROM ##PimProductData;
			
             IF ISNULL(@PimProductId, 0) = 0
                 BEGIN
                     INSERT INTO ZnodePimProduct
                     (PimAttributeFamilyId,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate
                     )
                            SELECT @PimAttributeFamilyId,
                                   @UserId,
                                   @GetDate,
                                   @UserId,
                                   @GetDate;
                     SET @PimProductId = SCOPE_IDENTITY();
					 If EXISTS (select TOP 1 1 from ##PimProductData where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						
						Select TOP 1 @SKU  =  AttributeValue from  ##PimProductData where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  ##PimProductData where PimAttributeId =  @pimProductNameAttributeId
						insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 
					 End
		

                 END;
             ELSE 
                 BEGIN
                     UPDATE ZNodePimProduct
                       SET
                          PublishStateId = @PublishStateIdForDraft, 
                           ModifiedBy = @UserId,
                           ModifiedDate = @GetDate
                     WHERE PimProductId = @PimProductId;
            									
					 INSERT INTO @TBL_PimProductId(PimAttributeValueId)
					 SELECT ZPAV.PimAttributeValueId
                     FROM ZnodePimAttributeValue ZPAV
					 INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId AND ( @localeID = @DefaultLocaleId OR ZPA.IsLocalizable = 1 OR EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FN WHERE FN.PimAttributeId = ZPAV.PimAttributeId)))
					 --INNER JOIN ZnodePimFamilyGroupMapper ZPFGMI  ON (ZPFGMI.PimAttributeId = ZPAV.PimAttributeId AND ZPFGMI.PimAttributeFamilyId = @PimAttributeFamilyId)
					 WHERE ZPAV.PimProductId = @PimProductId
					 AND NOT EXISTS
                     (
                        SELECT TOP 1 1
                        FROM ##PimProductData TBPDI
                        WHERE TBPDI.PimAttributeId = ZPAV.PimAttributeId
                                AND TBPDI.PimProductId = ZPAV.PimProductId
					 )
                     
		
					If EXISTS (select TOP 1 1 from ##PimProductData where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						Select TOP 1 @SKU  =  AttributeValue from  ##PimProductData where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  ##PimProductData where PimAttributeId =  @pimProductNameAttributeId

						insert into ZnodePimDownloadableProduct(SKU,ProductName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select TOP 1 PD.AttributeValue, @ProductName,@UserId , @GetDate, @UserId , @GetDate from  ##PimProductData PD where  PD.PimAttributeId = @pimSkuAttributeId 
						AND not exists (select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  =  PD.AttributeValue)
						IF NOT Exists (	select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  = @SKU)
							insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
							Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 

					 End
                 END;
		
		    MERGE INTO ZnodePimAttributeValue TARGET
              USING ##PimProductData SOURCE
              ON(
				TARGET.PimProductId = @PimProductId
                AND TARGET.PimAttributeId = SOURCE.PimAttributeId)
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.PimAttributeFamilyId = CASE
                                                                   WHEN Source.PimAttributeFamilyId = 0
                                                                   THEN NULL
                                                                   ELSE Source.PimAttributeFamilyId
                                                               END,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeFamilyId,
                             PimProductId,
                             PimAttributeId,
                             PimAttributeDefaultValueId,                            
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (CASE
                  WHEN Source.PimAttributeFamilyId = 0
                  THEN @PimDefaultFamily
                  ELSE Source.PimAttributeFamilyId
              END,
              @PimProductId,
              SOURCE.PimAttributeId,
              CASE
                  WHEN SOURCE.ProductAttributeDefaultValueId = 0
                  THEN NULL
                  ELSE SOURCE.ProductAttributeDefaultValueId
              END,              
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             )
             
             OUTPUT INSERTED.PimAttributeValueId,
                    INSERTED.PimAttributeFamilyId,
                    INSERTED.PimAttributeId
                    INTO @ZnodePimAttributeValue;
        		 
		INSERT INTO @TBL_MediaAttributeValue (PimAttributeValueId,LocaleId , AttributeValue,MediaId)
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                         zm.Path AttributeValue
						 ,ZM.MediaId
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN ##PimProductData AS b ON(a.PimAttributeId = b.PimAttributeId)
                                                --AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_MediaAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		INNER JOIN ZnodeMedia ZM ON (EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue ,',') SP WHERE sp.Item = ZM.MediaId ))
		
		

		DELETE FROM ZnodePimProductAttributeMedia 
		WHERE EXISTS 
		 (SELECT TOP 1 1 FROM @TBL_MediaAttributeValue TBLM WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId 
		 AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId  AND ZnodePimProductAttributeMedia.Localeid = @LocaleId)



		MERGE INTO ZnodePimProductAttributeMedia TARGET 
		USING @TBL_MediaAttributeValue SOURCE 
		ON (        TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
		        AND TARGET.MediaPAth = SOURCE.AttributeValue
                  AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.MediaPath = SOURCE.AttributeValue,
						   TARGET.MediaId   = SOURCE.MediaId,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             MediaPath,
							 MediaId ,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
			  SOURCE.MediaId,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
		

	   ;With Cte_TextAreaAttributeValue AS 
		 (
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN ##PimProductData AS b ON(a.PimAttributeId = b.PimAttributeId)
                                                --AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_TextAreaAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		
		)
		
		MERGE INTO ZnodePimProductAttributeTextAreaValue TARGET 
		USING Cte_TextAreaAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );


        INSERT INTO @TBL_DefaultAttributeValue (PimAttributeValueId,LocaleId,AttributeValue)  
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        d.PimAttributeDefaultValueId  AttributeValue
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN ##PimProductData AS b ON(a.PimAttributeId = b.PimAttributeId)
		INNER JOIN @TBL_DefaultAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		INNER JOIN ZnodePimAttributeDefaultValue d ON (EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,',') SP WHERE d.PimAttributeId = b.PimAttributeId AND ltrim(rtrim(SP.Item ))= ltrim(rtrim(d.AttributeDefaultValueCode))))
	    
	    
		DELETE FROM ZnodePimProductAttributeDefaultValue 
		WHERE  EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeValue TBLAV WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId 
												AND TBLAV.AttributeValue   <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId 
												 AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId )

		MERGE INTO ZnodePimProductAttributeDefaultValue TARGET 
		USING @TBL_DefaultAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
              AND TARGET.PimAttributeDefaultValueId =  SOURCE.AttributeValue
			    AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             PimAttributeDefaultValueId,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
			 
		
		   MERGE INTO ZnodePimAttributeValueLocale TARGET
             USING
             (
                 SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
                 FROM @ZnodePimAttributeValue AS a
                      INNER JOIN ##PimProductData AS b ON(a.PimAttributeId = b.PimAttributeId)
                                                             --AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
                 WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId  )
			     AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId  )
				 AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId  )
			 ) SOURCE
             ON(TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
             SET @AssociatedProduct =
             (
                 SELECT MAX(AssociatedProducts)
                 FROM ##PimProductData AS a
             );
             INSERT INTO ZnodePimProductTypeAssociation
             (PimParentProductId,
              PimProductId,
              DisplayOrder,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           Item,
                           ID AS RowId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@AssociatedProduct, ',') AS b
                         INNER JOIN ZNodePimProduct AS q ON(q.PimProductId = b.Item)
						 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductTypeAssociation PPT
						 WHERE PPT.PimParentProductId = @PimProductId AND PPT.PimProductId = b.Item)


             SET @ConfigureAttributeId =
             (
                 SELECT MAX(ConfigureAttributeIds)
                 FROM ##PimProductData AS a
             );
             SET @ConfigureFamilyId =
             (
                 SELECT MAX(ConfigureFamilyIds)
                 FROM ##PimProductData AS a
             );

            --To get the product SKU in temp table
			SELECT ZPAV.PimProductId, ZPAVL.AttributeValue as SKU
			INTO #ProductSKU
			FROM ZnodePimAttributeValue ZPAV
			INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId 
			WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPAV.PimAttributeId = zpa.PimAttributeId AND ZPA.AttributeCode = 'SKU')

			--Inserting the link attribute product association
			INSERT INTO ZnodePimLinkProductDetail (PimParentProductId,PimProductId,PimAttributeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DisplayOrder)  
			SELECT a.PimProductId, f.PimProductId, b.PimAttributeId,@UserId,@GetDate,@UserId,@GetDate,1 displayOrder  
			FROM @PimProductDetail a 
			CROSS APPLY DBO.SPLIT(a.AttributeValue,',') s
			INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = a.PimAttributeId )  
			INNER JOIN ZnodeAttributeType c ON (c.AttributeTypeId = b.AttributeTypeId)  
			INNER JOIN #ProductSKU f ON (f.SKU = s.Item)  
			WHERE c.AttributeTypeName = 'link'  
			AND a.PimProductId != f.PimProductId  
			AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimLinkProductDetail ER WHERE ER.PimParentProductId = a.PimProductId AND ER.PimProductId = f.PimProductId AND ER.PimAttributeId = b.PimAttributeId)  
  
             INSERT INTO [ZnodePimConfigureProductAttribute]
             (PimProductId,
              PimFamilyId,
              PimAttributeId,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           @ConfigureFamilyId,
                           q.PimAttributeId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@ConfigureAttributeId, ',') AS b
                         INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimConfigureProductAttribute RTR  WHERE  RTR.PimProductId = @PimProductId AND RTR.PimAttributeId = q.PimAttributeId);



             IF @IsNotReturnOutput = 0
                 SELECT @PimProductId AS Id,
                        CAST(1 AS BIT) AS Status;
             SET @status = 1;

			 IF @CopyPimProductId > 0 
			 BEGIN 
			   INSERT INTO ZnodePimAttributeValueLocale  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimAttributeValueLocale ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId

			    INSERT INTO ZnodePimProductAttributeDefaultValue  (PimAttributeValueId,LocaleId,PimAttributeDefaultValueId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.PimAttributeDefaultValueId,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeDefaultValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId


			   INSERT INTO ZnodePimProductAttributeTextAreaValue  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeTextAreaValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   			   
			   INSERT INTO ZnodePimProductAttributeMedia  (PimAttributeValueId,LocaleId,MediaPath,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.MediaPath,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeMedia ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   
			 END 
			 


			  IF @LocaleId = @DefaultLocaleId
			 BEGIN 	 
	
DECLARE @sqlt NVARCHAr(max) = ''
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int 

DECLARE Cur_AttributeDataUpdate CURSOR FOR 

SELECT b.AttributeCode , PimAttributeId 
FROM INFORMATION_SCHEMA.COLUMNS a 
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )
WHERE TABLE_NAME = 'ZnodePimProduct'
AND IsCategory = 0 
AND IsShowOnGrid = 1 
AND EXISTS (SELECT TOP 1 1 FROM ##PimProductDetail n  WHERE n.ProductAttributeCode = b.AttributeCode  )
OPEN Cur_AttributeDataUpdate 
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
WHILE @@FETCH_STATUS = 0 
BEGIN 

 SET @sqlt = 'UPDATE a  
 SET '+@AttributeCodeAtt+'= AttributeValue 
 FROM ZnodePimProduct a 
 INNER JOIN ##PimProductDetail m ON(m.PimProductId = a.pimProductId ) 
 WHERE m.ProductAttributeCode = '''+@AttributeCodeAtt+'''
 ' 

 EXEC (@sqlt)

FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
END 
CLOSE Cur_AttributeDataUpdate
DEALLOCATE Cur_AttributeDataUpdate 

END 



			 If Object_id ('Tempdb..##PimProductData')  is not null 
				DROP TABLE Tempdb..##PimProductData

             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPartialInsertUpdatePimProduct @UserId = '+CAST(@UserId AS VARCHAR(50))+',@IsNotReturnOutput='+CAST(@IsNotReturnOutput AS VARCHAR(50))+',@CopyPimProductId='+CAST(@CopyPimProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportPartialInsertUpdatePimProduct',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() 
			,@Getdate DATETIME = dbo.fn_getdate()
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,IsAddon bit   )
    
	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-'+CAST(@Getdate as varchar(200))+'Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email


	INSERT INTO @Tbl_versions 
	SELECT 'Preview'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'Production'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	


	
	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId, a.RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionType FROM @Tbl_versions)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 IsAddon
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 IsAddon
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault, 1 IsAddon
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault, 0 IsAddon
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



DROP TABLE IF EXISTS #PimProduct_distinct



SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 

DELETE p
OUTPUT deleted.ZnodeProductId INTO @Deleted_Products
FROM ZnodePublishProductEntity p  WHERE PublishProductEntityId IN   (SELECT PublishProductEntityId FROM #PublishProductEntityId) 


DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 


SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


SELECT DISTINCT PimCategoryHierarchyId, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT , DisplayOrder INT , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  


UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = b.DisplayOrder , IsActive = b.IsActive, ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
INNER JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)




UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(200),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId



INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(2000),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1

FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode

--SELECT * FROM @Versions_working

SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, 0 SalesPrice,0 RetailPrice,'' CultureCode,'' CurrencySuffix
	   ,'' CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(200),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU)
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId



UPDATE a
SET Name = b.name 
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)




EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
SELECT q.VersionId,a.PimProductId, @PimCatalogId, b.PimProductId , b.DisplayOrder,'[]', '', IsDefault,1
FROM ZnodePimConfigureProductAttribute a 
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = q.VersionId AND a.PimProductId = t.ZnodeProductId )


INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, PimProductId, a.DisplayOrder, 0 ,1 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.PimProductId AND tt.ProductType = 'Bundle Product')
INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, PimProductId, a.DisplayOrder ,1 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.PimProductId AND tt.ProductType = 'Group Product')

INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)

SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,LocaleId,'','' DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.IsAddon = 1 

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID


	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId = 3
	WHERE PublishStateId IN (1,2)

	SELECT @PimCatalogId AS id,@Status AS Status;     
  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	   
	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson
GO

CREATE    PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
DECLARE @pimProductId_loop TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,b.IsSwatch
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@LocaleId)
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID

WHILE EXISTS (SELECT TOP 1 1 FROM #pimProductIds ) 
BEGIN 
DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

INSERT INTO @pimProductId_loop
SELECT TOP 2000 PimProductId 
FROM #pimProductIds 



SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  @pimProductId_loop t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue 
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @LocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue 
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @LocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue 
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @LocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue 
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @LocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue 
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @LocaleId




-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @LocaleId AND rt.LocaleId = bc.LocaleId


create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @pimProductId_loop n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID

UPDATE ZnodePublishProductEntity
SET Attributes = 
 (

SELECT IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '',0 , 1 )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(a.AttributeValue,'') AttributeValues
				,ISNULL((
				   SELECT Code,LocaleId,Value,DisplayOrder,IsEditable,SwatchText,Path
				   FROM #default_value nt 
				   WHERE nt.PimProductId = a.PimProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId)
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =@LocaleId)
WHERE a.PimProductId = ZnodePublishProductEntity.ZnodeProductId
ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
) 
WHERE PublishProductEntityId  IN (SELECT PublishProductEntityId FROM #PublishProductEntityId)

	
	DELETE FROM #pimProductIds WHERE PimProductId IN (SELECT PImProductId FROM @pimProductId_loop)
	DELETE FROM @pimProductId_loop
END 

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateAttributeValue')
	DROP PROC Znode_UpdateAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_UpdateAttributeValue](@ProductId        VARCHAR(2000),      
                                                   @PimAttributeCode NVARCHAR(300),      
                                                   @LocaleId         INT,      
                                                   @AttributeValue   NVARCHAR(MAX),      
                                                   @UserId           INT,      
                                                   @Status           BIT OUT,      
                                                   @IsUnAssociated   BIT           = 0,      
                                                   @IsDebug          BIT           = 0)      
AS       
         
/* ---------------------------------------------------------------------------------------------------------------      
    --Summary : Update AttributeValue for specific product       
    --          Input parameter : @LocaleId , @PimAttributeCode,  @ProductId,@AttributeValue,@UserId      
    --Unit Testing :       
    BEGIN TRANSACTION       
    DECLARE @Status bit       
    EXEC [Znode_UpdateAttributeValue]      
    @ProductId        = 10637,      
    @PimAttributeCode = 'Brand' ,      
    @LocaleId         =1 ,      
    @AttributeValue   = 'Tropicana',      
    @UserId           =2,      
    @Status           =@Status OUT      
    SELECT @Status       
    --SELECT zpa.AttributeCode ,ZpAVL .AttributeValue  FROM ZnodePimAttributeValueLocale ZpAVL INNER JOIN ZnodePimAttributeValue zpav ON ZpAVL.PimAttributeValueId = zpav.PimAttributeValueId      
    --INNER JOIN dbo.ZnodePimAttribute zpa ON zpav.PimAttributeId = zpa.PimAttributeId      
    --WHERE zpav.PimProductId =12 AND ZpAVL.LocaleId = 1 AND zpa.AttributeCode = 'ProductName'       
    --ROLLBACK Transaction       
    ---------------------------------------------------------------------------------------------------------------      
*/      
      
     BEGIN    

		BEGIN TRAN UpdateAttributeValue;      
			BEGIN TRY      
				DECLARE @GetDate DATETIME= dbo.Fn_GetDate();      
				DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();      
				DECLARE @TBL_PimProductId TABLE      
				(PimProductId               INT,      
				PimAttributeId             INT,      
				AttributeCode              VARCHAR(300),      
				AttributeValue             NVARCHAR(MAX),      
				PimAttributeDefaultValueId INT ,
				Attributetype VARCHAR(50)     
				); -- table holds the PimProductId   
				    
				DECLARE @TBL_DefaultAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))      
      
				INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)      
				SELECT PimAttributeId,AttributeCode FROM  [dbo].[Fn_GetDefaultAttributeId] ()      
      
				DECLARE @TBL_PimAttributeValueId TABLE      
				(PimAttributeValueId INT,      
				PimAttributeId      INT,      
				PimProductId        INT,      
				PimAttributeDefaultValueId int       
				);      
	  
  
				INSERT INTO @TBL_PimProductId      
				(PimProductId,      
				PimAttributeId,      
				AttributeCode,      
				AttributeValue,      
				PimAttributeDefaultValueId      
				)      
				SELECT item,      
					ZPA.PimAttributeId,      
					@PimAttributeCode,      
					@AttributeValue,      
					ZPADV.PimAttributeDefaultValueId      
				FROM dbo.Split(@ProductId, ',') SP      
					LEFT JOIN ZnodePimAttribute ZPA ON(ZPA.AttributeCode = @PimAttributeCode)      
					LEFT JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPA.PimAttributeId = ZPADV.PimAttributeId AND ( ZPADV.AttributeDefaultValueCode = @AttributeValue OR ISNULL(@AttributeValue, '') = ''  ))      
					--WHERE NOT EXISTS (SELECT * FROM @TBL_PimProductId_Simple WHERE PimProductId = SP.item AND PimAttributeId = ZPA.pimattributeid)-- AND AttributeCode = @AttributeValue AND AttributeValue = @AttributeValue AND PimAttributeDefaultValueId= ZPADV.PimAttributeDefaultValueId)


					Update TBL 
					SET Attributetype = 'Simple Select'
					FROM @TBL_PimProductId TBL
					WHERE EXISTS (SELECT * FROM ZnodePimAttribute WHERE AttributeCode = @PimAttributeCode AND AttributeTypeId = (SELECT Top 1 AttributeTypeId from ZnodeAttributeType where AttributeTypeName = 'Simple Select'))
					--INNER JOIN ZnodePimAttribute ZPA ON(ZPA.AttributeCode = @PimAttributeCode and ZPA.AttributeTypeId = (SELECT AttributeTypeId from ZnodeAttributeType where AttributeTypeName = 'Simple Select'))      


		  
      
				IF @IsUnAssociated = 1      
				BEGIN      
				INSERT INTO @TBL_PimAttributeValueId      
				(PimAttributeValueId,      
				PimAttributeId,      
				PimProductId,      
				PimAttributeDefaultValueId     
				)      
					SELECT ZPAV.PimAttributeValueId,      
							ZPAV.PimAttributeId,      
							ZPAV.PimProductId,      
							ZPADV.PimAttributeDefaultValueId      
					FROM ZnodePimAttributeValue ZPAV      
							INNER JOIN @TBL_PimProductId TBLP ON(TBLP.PimProductId = ZPAV.PimProductId AND TBLP.PimAttributeId = ZPAV.PimAttributeId AND TBLP.AttributeValue = @AttributeValue)
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON (ZPADV.PimAttributeValueId = ZPAV.PimAttributeValueId)
							INNER JOIN ZnodePimAttributeDefaultValue ZADV ON (ZPADV.PimAttributeDefaultValueId = ZADV.PimAttributeDefaultValueId AND ZADV.AttributeDefaultValueCode =@AttributeValue )

      
				DELETE FROM ZnodePimProductAttributeDefaultValue 
				WHERE EXISTS      
				(      
					SELECT TOP 1 1      
					FROM @TBL_PimAttributeValueId TBLAP      
					WHERE TBLAP.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId      
					AND ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId = TBLAP.PimAttributeDefaultValueId --@PimAttributeDefaultValueId      
				)      
				AND LocaleId = @LocaleId
					

				DELETE FROM ZnodePimAttributeValue    
				WHERE EXISTS      
				(      
					SELECT TOP 1 1      
					FROM @TBL_PimAttributeValueId TBLAP      
					WHERE TBLAP.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId      
						AND ZnodePimAttributeValue.PimAttributeDefaultValueId =TBLAP.PimAttributeDefaultValueId -- @PimAttributeDefaultValueId      
				)
				AND not exists (select * from   ZnodePimProductAttributeDefaultValue where PimAttributeValueId =ZnodePimAttributeValue.PimAttributeValueId )--AND PimAttributeDefaultValueId <>TBLAP.PimAttributeDefaultValueId ) 
				--AND LocaleId = @LocaleId     

				END;   

				---- here needs to handle which records will be updated and which records will be inserted 	

				--INSERT INTO @TBL_PimProductId 
				--(PimProductId,      
				--PimAttributeId,      
				--AttributeCode,      
				--AttributeValue,      
				--PimAttributeDefaultValueId      
				--)     
				--SELECT 	TBL.PimProductId,      
				--TBL.PimAttributeId,      
				--AttributeCode,      
				--TBL.AttributeValue,      
				--TBL.PimAttributeDefaultValueId 
				--FROM @TBL_PimProductId_Simple TBL 
				--INNER JOIN 	Znodepimattributevalue ZPA ON (ZPA.PimProductId = TBL.PimProductId AND ZPA.PimAttributeId = TBL.PimAttributeId)	 
			 

				UPDATE ZnodePimAttributeValue       
				SET  ModifiedBy = @UserId      
				, ModifiedDate = @GetDate      
				,PimAttributeDefaultValueId = ZAV.PimAttributeDefaultValueId      
				OUTPUT INSERTED.PimAttributeValueId,      
				INSERTED.PimAttributeId,      
				INSERTED.PimProductId,      
				INSERTED.PimAttributeDefaultValueId      
				INTO @TBL_PimAttributeValueId      
				FROM ZnodePimAttributeValue        
				INNER JOIN @TBL_PimProductId ZAV ON ( ZAV.PimProductId = ZnodePimAttributeValue.PimProductId      
						AND ZAV.PimAttributeId = ZnodePimAttributeValue.PimAttributeId)      
				WHERE @IsUnAssociated = 0  


				--INSERT INTO @TBL_PimProductId 
				--(PimProductId,      
				--PimAttributeId,      
				--AttributeCode,      
				--AttributeValue,      
				--PimAttributeDefaultValueId      
				--)     
				--SELECT 	PimProductId,      
				--PimAttributeId,      
				--AttributeCode,      
				--AttributeValue,      
				--PimAttributeDefaultValueId 
				--FROM @TBL_PimProductId_Simple TBL 
				--WHERE NOT EXISTS (SELECT * FROM Znodepimattributevalue WHERE PimAttributeId = TBL.pimattributeid AND PimProductId = TBL.PimProductId)
     
				INSERT INTO ZnodePimAttributeValue      
				(PimProductId,      
				PimAttributeId,      
				PimAttributeDefaultValueId,      
				AttributeValue,      
				CreatedBy,      
				CreatedDate,      
				ModifiedBy,      
				ModifiedDate,      
				PimAttributeFamilyId      
				)      
				OUTPUT INSERTED.PimAttributeValueId,      
				INSERTED.PimAttributeId,      
				INSERTED.PimProductId,      
				INSERTED.PimAttributeDefaultValueId      
				INTO @TBL_PimAttributeValueId      
				SELECT TBPP.PimProductId,      
					TBPP.PimAttributeId,      
					TBPP.PimAttributeDefaultValueId,      
					TBPP.AttributeValue,      
					@UserId,      
					@GetDate,      
					@UserId,      
					@GetDate,      
					@PimDefaultFamily      
				FROM @TBL_PimProductId TBPP      
				WHERE NOT EXISTS      
				(      
				SELECT TOP 1 1      
				FROM ZnodePimAttributeValue ZAV      
				WHERE ZAV.PimProductId = TBPP.PimProductId      
						AND ZAV.PimAttributeId = TBPP.PimAttributeId      
				)      
				AND @IsUnAssociated = 0;      
                   
				UPDATE A      
				SET      
				AttributeValue = C.AttributeValue      
				FROM ZnodePimAttributeValueLocale A      
				INNER JOIN ZnodePimAttributeValue B ON(B.PimAttributeValueId = A.PimAttributeValueId)      
				INNER JOIN @TBL_PimProductId C ON(B.PimAttributeId = C.PimAttributeId      
											AND B.PimProductId = C.PimProductId)      
				WHERE LocaleId = @LocaleId;  

 
				Declare @Pimattriutedefaultvalueid INT = 0
						 
				SELECT @Pimattriutedefaultvalueid =  A.PimAttributeDefaultValueId from ZnodePimAttributeDefaultValue A 
				INNER JOIN ZnodePimAttributeDefaultValueLocale B On (A.PimAttributeDefaultValueId = B.PimAttributeDefaultValueId AND A.PimAttributeId = (SELECT TOP 1 PimAttributeId from ZnodePimAttribute WHERE AttributeCode = @PimAttributeCode))
				WHERE A.AttributeDefaultValueCode = @AttributeValue AND B.LocaleId  = @LocaleId	


				-- UP ZnodePimProductAttributeDefaultValue 
				IF @Pimattriutedefaultvalueid <>0
				Update ZPDA
				SET ZPDA.ModifiedBy = @UserId,
				ZPDA.Modifieddate = @getdate,
				ZPDA.pimattributedefaultvalueid = ZPA.pimattributedefaultvalueid
				FROM @TBL_PimProductId TBL
				INNER JOIN @TBL_PimAttributeValueId ZPA ON (TBL.pimattributeid = ZPA.pimattributeid AND TBL.pimproductid = ZPA.PimProductId)
				INNER JOIN ZnodePimProductAttributeDefaultValue ZPDA ON (ZPDA.PimAttributeValueId = ZPA.pimattributevalueid)
				WHERE TBL.Attributetype = 'Simple Select'
				

				DELETE TBL
				FROM @TBL_PimAttributeValueId TBL
				INNER JOIN @TBL_PimProductId TBLP On (TBL.PimAttributeId = TBLP.PimAttributeId AND TBL.PimProductId = TBLP.pimproductid AND TBL.pimattributevalueid = TBLP.pimattributedefaultvalueid)
				WHERE TBLP.Attributetype = 'Simple Select'
				AND (EXISTS (SELECT * FROM ZnodePimProductAttributeDefaultValue WHERE PimAttributeValueId = TBL.pimattributevalueid )
				OR  EXISTS (SELECt * FROM ZnodePimAttributeValueLocale WHERE PimAttributeValueId = TBL.pimattributevalueid))
		   
				INSERT INTO ZnodePimProductAttributeDefaultValue      
				(PimAttributeValueId,      
				LocaleId,      
				PimAttributeDefaultValueId,      
				CreatedBy,      
				CreatedDate,      
				ModifiedBy,      
				ModifiedDate      
				)      
				SELECT DISTINCT TBPAV.PimAttributeValueId,      
					@LocaleId,      
					TBPAV.PimAttributeDefaultValueId,      
					@UserId,      
					@GetDate,      
					@UserId,      
					@GetDate      
				FROM @TBL_PimProductId TBPP      
					INNER JOIN @TBL_PimAttributeValueId TBPAV ON(TBPAV.PimProductId = TBPP.PimProductId      
																AND TBPAV.PimAttributeId = TBPP.PimAttributeId)      
																AND @IsUnAssociated = 0      
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)
				AND NOT EXISTS (SELECT * FROM ZnodePimProductAttributeDefaultValue WHERE PimAttributeValueId =TBPAV.PimAttributeValueId AND PimAttributeDefaultValueId = TBPP.PimAttributeDefaultValueId )
				  
				UPDATE ZPAVL      
				SET AttributeValue =@AttributeValue      
				FROM ZnodePimAttributeValueLocale ZPAVL       
				INNER JOIN @TBL_PimAttributeValueId TBPAV ON( TBPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )      
																AND @IsUnAssociated = 0  
   
      
				INSERT INTO ZnodePimAttributeValueLocale      
				(PimAttributeValueId,      
				LocaleId,      
				AttributeValue,      
				CreatedBy,      
				CreatedDate,      
				ModifiedBy,      
				ModifiedDate      
				)      
				SELECT TBPAV.PimAttributeValueId,      
					@LocaleId,      
					TBPP.AttributeValue,      
					@UserId,      
					@GetDate,      
					@UserId,      
					@GetDate      
				FROM @TBL_PimProductId TBPP      
					INNER JOIN @TBL_PimAttributeValueId TBPAV ON(TBPAV.PimProductId = TBPP.PimProductId      
																AND TBPAV.PimAttributeId = TBPP.PimAttributeId)      
																WHERE @IsUnAssociated = 0      
				AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)      
				AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale TBH WHERE TBH.PimAttributeValueId = TBPAV.PimAttributeValueId);      
				  
				 SELECT *  INTO #TBL_PimProductId
			 FROM @TBL_PimProductId


			  IF @LocaleId = 1
			 BEGIN 	 
	
DECLARE @sqlt NVARCHAr(max) = ''
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int 

DECLARE Cur_AttributeDataUpdate CURSOR FOR 



SELECT b.AttributeCode , PimAttributeId 
FROM INFORMATION_SCHEMA.COLUMNS a 
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )
WHERE TABLE_NAME = 'ZnodePimProduct'
AND IsCategory = 0 
AND IsShowOnGrid = 1 
AND EXISTS (SELECT TOP 1 1 FROM @TBL_PimProductId n  WHERE n.AttributeCode = b.AttributeCode  )
OPEN Cur_AttributeDataUpdate 
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
WHILE @@FETCH_STATUS = 0 
BEGIN 

 SET @sqlt = 'UPDATE a  
 SET '+@AttributeCodeAtt+'= AttributeValue 
 FROM ZnodePimProduct a 
 INNER JOIN #TBL_PimProductId m ON(m.PimProductId = a.pimProductId ) 
 WHERE m.ProductAttributeCode = '''+@AttributeCodeAtt+'''
 ' 

 EXEC (@sqlt)

FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
END 
CLOSE Cur_AttributeDataUpdate
DEALLOCATE Cur_AttributeDataUpdate 

END 

			






				SET @Status = 1;      
				SELECT 1 AS ID,      
				CAST(1 AS BIT) AS [Status];      
      
			COMMIT TRAN UpdateAttributeValue;      
		END TRY      
		BEGIN CATCH      
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),       
		@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdateAttributeValue @ProductId = '+      
		@ProductId+',@PimAttributeCode='+@PimAttributeCode+',@Status='+CAST(@Status AS VARCHAR(50))+      
		',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@AttributeValue='+CAST(@AttributeValue AS NVARCHAR(MAX))+',@UserId='+CAST(@UserId AS NVARCHAR(50));      
		SET @Status = 0;      
		SELECT 1 AS ID,      
		CAST(0 AS BIT) AS [Status],      
		@ErrorMessage;      
		ROLLBACK TRAN UpdateAttributeValue;      
		EXEC Znode_InsertProcedureErrorLog      
		@ProcedureName = 'Znode_UpdateAttributeValue',      
		@ErrorInProcedure = @Error_procedure,      
		@ErrorMessage = @ErrorMessage,      
		@ErrorLine = @ErrorLine,      
		@ErrorCall = @ErrorCall;      
		END CATCH;      
     END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateProductAttributeValue')
	DROP PROC Znode_UpdateProductAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_UpdateProductAttributeValue]
(
	@SKU				 NVARCHAR(MAX),
	@LocaleCode			 nvarchar(100),
	@AttributeCodeValues XML,
	@UserId				 INT = 0,
	@Status				 BIT OUT,
	@IsUnAssociated		 BIT = 0
)
AS    
/* ---------------------------------------------------------------------------------------------------------------
    --Summary : Update AttributeValue for specific product 
    --          Input parameter : @LocaleId , @PimAttributeCode,  @ProductId,@AttributeValue,@UserId
    --Unit Testing : 

     BEGIN TRANSACTION 
    DECLARE @Status bit 
    EXEC [Znode_UpdateProductAttributeValue]
    @SKU        = 10637,
    @LocaleCode         = 'en-US',
    @AttributeCodeValues   = 'Tropicana',
    @UserId           =2,
    @Status           =@Status OUT
    SELECT @Status 
    --SELECT zpa.AttributeCode ,ZpAVL .AttributeValue  FROM ZnodePimAttributeValueLocale ZpAVL INNER JOIN ZnodePimAttributeValue zpav ON ZpAVL.PimAttributeValueId = zpav.PimAttributeValueId
    --INNER JOIN dbo.ZnodePimAttribute zpa ON zpav.PimAttributeId = zpa.PimAttributeId
    --WHERE zpav.PimProductId =12 AND ZpAVL.LocaleId = 1 AND zpa.AttributeCode = 'ProductName' 
    ROLLBACK Transaction 
    ---------------------------------------------------------------------------------------------------------------
	*/

     BEGIN
         BEGIN TRAN UpdateAttributeValue;
         BEGIN TRY
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
			 DECLARE @ProductId INT, @LocaleId INT
			 
             DECLARE @TBL_PimProductId TABLE
             ( RowId INT IDENTITY(1,1),
				PimProductId INT,
				PimAttributeId INT,
                AttributeCode VARCHAR(300),
                AttributeValue NVARCHAR(MAX),
                PimAttributeDefaultValueId INT
             ); -- table holds the PimProductId 

			  DECLARE @TBL_DefaultAttributeId TABLE 
			  ( 
				PimAttributeId INT PRIMARY KEY , 
				AttributeCode VARCHAR(600)
			  )
			 SELECT TOP 1 @LocaleId  =  LocaleId  from ZnodeLocale where Code = @LocaleCode
			 If @LocaleId is null 
			 Begin
				SET @Status = 0 
				 Rollback TRAN UpdateAttributeValue;
				Return 0
			 End
		     INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM  ZnodePimAttribute a 
			 INNER JOIN ZnodeAttributeType r ON (r.AttributeTypeId = a.AttributeTypeId)
			 WHERE AttributeTypeName IN ('Simple Select', 'Multi Select')
			 		 AND IsCategory = 0 

			  DECLARE @TBL_TextAreaAttributeId TABLE 
			  ( 
				PimAttributeId INT PRIMARY KEY , 
				AttributeCode VARCHAR(600)
			  )

		     INSERT INTO @TBL_TextAreaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM  ZnodePimAttribute a 
			 INNER JOIN ZnodeAttributeType r ON (r.AttributeTypeId = a.AttributeTypeId)
			 WHERE AttributeTypeName IN ('Text Area')
			 AND IsCategory = 0 


             DECLARE @TBL_PimAttributeValueId TABLE
             (
				
				PimAttributeValueId INT,
				PimAttributeId      INT,
				PimProductId        INT,
				PimAttributeDefaultValueId int 
             );


			 SELECT @ProductId = PAV.PimProductId FROM ZnodePimAttributeValueLocale PAVL 
			 INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId = PAV.PimAttributeValueId
			 INNER JOIN ZnodePimAttribute PA ON PA.PimAttributeId = PAV.PimAttributeId
			 WHERE PA.AttributeCode = 'SKU' AND PAVL.AttributeValue = @SKU

			 INSERT INTO @TBL_PimProductId ( PimProductId, AttributeCode, AttributeValue )
			 SELECT @ProductId, Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(max)' ) AS AttributeCode, DV.Item
			 FROM @AttributeCodeValues.nodes( '//ArrayOfPIMAttributeCodeValueModel/PIMAttributeCodeValueModel' ) AS Tbl(Col)
			 CROSS APPLY dbo.split( Tbl.Col.value( 'AttributeValues[1]', 'NVARCHAR(max)' ),',') DV			

			 UPDATE @TBL_PimProductId
			 SET PimAttributeId = ZPA.PimAttributeId, PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId
			 FROM @TBL_PimProductId Tbl
			 inner JOIN ZnodePimAttribute AS ZPA ON( ZPA.AttributeCode = Tbl.AttributeCode )
			 LEFT JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPA.PimAttributeId = ZPADV.PimAttributeId and ZPADV.AttributeDefaultValueCode = Tbl.AttributeValue )
			 where ZPA.IsCategory <> 1

			
			 ;WITH Cte_DeleteDuplicate As
			 (
			   SELECT  Row_Number()over(Partition By PimProductId, PimAttributeId, PimAttributeDefaultValueId order by PimProductId, PimAttributeId, PimAttributeDefaultValueId, rowid )SRNO ,*
			   FROM @TBL_PimProductId 		 
			 ),
			 CTE_Last_Dataset as
			 (
				SELECT MAX(SRNO)SRNO, PimProductId, PimAttributeId, PimAttributeDefaultValueId from Cte_DeleteDuplicate
				GROUP BY PimProductId, PimAttributeId, PimAttributeDefaultValueId
			 )
			 DELETE A FROM Cte_DeleteDuplicate a
			 WHERE NOT EXISTS ( SELECT * FROM CTE_Last_Dataset b WHERE a.SRNO = b.SRNO and ISNULL(a.PimProductId,0) = ISNULL(B.PimProductId,0)  and ISNULL(a.PimAttributeId,0) = ISNULL(B.PimAttributeId,0) )
			 AND PimAttributeId IS NOT NULL

	
             IF @IsUnAssociated = 1
                 BEGIN
                     INSERT INTO @TBL_PimAttributeValueId ( PimAttributeValueId, PimAttributeId, PimProductId, PimAttributeDefaultValueId )
                     SELECT PimAttributeValueId, ZPAV.PimAttributeId, ZPAV.PimProductId, TBLP.PimAttributeDefaultValueId
                     FROM ZnodePimAttributeValue ZPAV
                     INNER JOIN @TBL_PimProductId TBLP ON(TBLP.PimProductId = ZPAV.PimProductId AND TBLP.PimAttributeId = ZPAV.PimAttributeId );

			
                     DELETE FROM ZnodePimProductAttributeDefaultValue
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimAttributeValueId TBLAP
                         WHERE TBLAP.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId
                               AND ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId = TBLAP.PimAttributeDefaultValueId --@PimAttributeDefaultValueId
                     )
                     AND LocaleId = @LocaleId;
					 

                     DELETE FROM ZnodePimAttributeValue
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimAttributeValueId TBLAP
                         WHERE TBLAP.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId
                               AND ZnodePimAttributeValue.PimAttributeDefaultValueId =TBLAP.PimAttributeDefaultValueId -- @PimAttributeDefaultValueId
                     );
                     --AND LocaleId = @LocaleId 					

                 END;

             INSERT INTO ZnodePimAttributeValue ( PimProductId, PimAttributeId, PimAttributeDefaultValueId, AttributeValue, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, PimAttributeFamilyId )
             OUTPUT INSERTED.PimAttributeValueId, INSERTED.PimAttributeId, INSERTED.PimProductId, INSERTED.PimAttributeDefaultValueId INTO @TBL_PimAttributeValueId
             SELECT DISTINCT TBPP.PimProductId, TBPP.PimAttributeId, NULL,NULL, @UserId, @GetDate, @UserId, @GetDate, @PimDefaultFamily
             FROM @TBL_PimProductId TBPP
             WHERE NOT EXISTS
             (
                SELECT TOP 1 1
                FROM ZnodePimAttributeValue ZAV
                WHERE ZAV.PimProductId = TBPP.PimProductId
                        AND ZAV.PimAttributeId = TBPP.PimAttributeId
             )
             AND @IsUnAssociated = 0 AND TBPP.PimProductId IS NOT NULL;
              
			 UPDATE ZnodePimAttributeValue 
			 SET  ModifiedBy = @UserId , 
				  ModifiedDate = @GetDate,
				  PimAttributeDefaultValueId = ZAV.PimAttributeDefaultValueId
			 OUTPUT INSERTED.PimAttributeValueId,
                    INSERTED.PimAttributeId,
                    INSERTED.PimProductId,
				    INSERTED.PimAttributeDefaultValueId
             INTO @TBL_PimAttributeValueId
			 FROM ZnodePimAttributeValue  
			 INNER JOIN @TBL_PimProductId ZAV ON ( ZAV.PimProductId = ZnodePimAttributeValue.PimProductId AND ZAV.PimAttributeId = ZnodePimAttributeValue.PimAttributeId) 
			 WHERE @IsUnAssociated = 0
			  
             UPDATE A
             SET PimAttributeDefaultValueId = C.PimAttributeDefaultValueId,
				 ModifiedBy = @UserId ,
			     ModifiedDate = @GetDate
             FROM ZnodePimProductAttributeDefaultValue A
             INNER JOIN ZnodePimAttributeValue B ON(B.PimAttributeValueId = A.PimAttributeValueId)
             INNER JOIN @TBL_PimProductId C ON(B.PimAttributeId = C.PimAttributeId AND B.PimProductId = C.PimProductId);
			
             UPDATE A
             SET AttributeValue = C.AttributeValue,
				 ModifiedBy = @UserId ,
			     ModifiedDate = @GetDate
             FROM ZnodePimAttributeValueLocale A
             INNER JOIN ZnodePimAttributeValue B ON(B.PimAttributeValueId = A.PimAttributeValueId)
             INNER JOIN @TBL_PimProductId C ON(B.PimAttributeId = C.PimAttributeId AND B.PimProductId = C.PimProductId)
			 WHERE LocaleId = @LocaleId;

             INSERT INTO ZnodePimProductAttributeDefaultValue ( PimAttributeValueId, LocaleId, PimAttributeDefaultValueId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
             SELECT TBPAV.PimAttributeValueId, @LocaleId, TBPP.PimAttributeDefaultValueId, @UserId, @GetDate, @UserId, @GetDate
             FROM @TBL_PimProductId TBPP 
			 INNER JOIN @TBL_PimAttributeValueId TBPAV ON(TBPAV.PimProductId = TBPP.PimProductId AND TBPAV.PimAttributeId = TBPP.PimAttributeId)
             WHERE @IsUnAssociated = 0
			 AND EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)
			 AND NOT EXISTS ( SELECT * FROM ZnodePimProductAttributeDefaultValue Z WHERE Z.PimAttributeValueId = TBPAV.PimAttributeValueId AND Z.PimAttributeDefaultValueId = TBPP.PimAttributeDefaultValueId ) ;
			 

			  UPDATE ZPAVL
			  SET AttributeValue = PP.AttributeValue			      
			  FROM ZnodePimAttributeValueLocale ZPAVL 
			  INNER JOIN @TBL_PimAttributeValueId TBPAV ON( TBPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId AND  ZPAVL.LocaleId = @localeId )  AND @IsUnAssociated = 0
			  INNER JOIN @TBL_PimProductId PP ON ( TBPAV.PimProductId = PP.PimProductId AND TBPAV.PimAttributeId = PP.PimAttributeId ) 
																	-- AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)

             
			 INSERT INTO ZnodePimAttributeValueLocale ( PimAttributeValueId, LocaleId, AttributeValue, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
             SELECT DISTINCT TBPAV.PimAttributeValueId, @LocaleId, TBPP.AttributeValue, @UserId, @GetDate, @UserId, @GetDate
             FROM @TBL_PimProductId TBPP
             INNER JOIN @TBL_PimAttributeValueId TBPAV ON(TBPAV.PimProductId = TBPP.PimProductId AND TBPAV.PimAttributeId = TBPP.PimAttributeId)
             WHERE @IsUnAssociated = 0
			 AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)
			 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale TBH WHERE TBH.PimAttributeValueId = TBPAV.PimAttributeValueId AND TBH.LocaleId = @LocaleId )
			 AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_TextAreaAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)
			
			  UPDATE ZPAVL
			  SET AttributeValue = PP.AttributeValue			      
			  FROM ZnodePimProductAttributeTextAreaValue ZPAVL 
			  INNER JOIN @TBL_PimAttributeValueId TBPAV ON( TBPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId AND  ZPAVL.LocaleId = @localeId )  AND @IsUnAssociated = 0
			  INNER JOIN @TBL_PimProductId PP ON ( TBPAV.PimProductId = PP.PimProductId AND TBPAV.PimAttributeId = PP.PimAttributeId ) 
																	-- AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)
             
			 INSERT INTO ZnodePimProductAttributeTextAreaValue ( PimAttributeValueId, LocaleId, AttributeValue, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
             SELECT DISTINCT TBPAV.PimAttributeValueId, @LocaleId, TBPP.AttributeValue, @UserId, @GetDate, @UserId, @GetDate
             FROM @TBL_PimProductId TBPP
             INNER JOIN @TBL_PimAttributeValueId TBPAV ON(TBPAV.PimProductId = TBPP.PimProductId AND TBPAV.PimAttributeId = TBPP.PimAttributeId)
             WHERE @IsUnAssociated = 0
			 AND  EXISTS (SELECT TOP 1 1 FROM @TBL_TextAreaAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)
			 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeTextAreaValue TBH WHERE TBH.PimAttributeValueId = TBPAV.PimAttributeValueId AND TBH.LocaleId = @LocaleId );

			 
			 SELECT @SKU SKU, AttributeCode, AttributeValue --PimProductId ,
			 FROM @TBL_PimProductId a
			 WHERE NOT EXISTS ( SELECT * FROM @TBL_PimAttributeValueId b WHERE isnull(a.PimProductId,0) = isnull(b.PimProductId,0) and a.PimAttributeId = b.PimAttributeId )--and a.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId )

			 IF NOT EXISTS ( SELECT PimProductId , AttributeCode, AttributeValue
							 FROM @TBL_PimProductId a
							 WHERE NOT EXISTS ( SELECT * FROM @TBL_PimAttributeValueId b WHERE a.PimProductId = b.PimProductId and a.PimAttributeId = b.PimAttributeId ))--and a.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId ) )
			 BEGIN
				SET @Status = 1;
				--SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];
			 END
			 ELSE 
			 BEGIN
				SET @Status = 0;
				--SELECT 1 AS ID, CAST(0 AS BIT) AS [Status];
			 END

             --SELECT 1 AS ID, CAST(1 AS BIT) AS [Status];
			 --SELECT @Status

			 SELECT *  INTO #TBL_PimProductId
			 FROM @TBL_PimProductId


			  IF @LocaleId = 1
			 BEGIN 	 
	
DECLARE @sqlt NVARCHAr(max) = ''
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int 

DECLARE Cur_AttributeDataUpdate CURSOR FOR 



SELECT b.AttributeCode , PimAttributeId 
FROM INFORMATION_SCHEMA.COLUMNS a 
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )
WHERE TABLE_NAME = 'ZnodePimProduct'
AND IsCategory = 0 
AND IsShowOnGrid = 1 
AND EXISTS (SELECT TOP 1 1 FROM @TBL_PimProductId n  WHERE n.AttributeCode = b.AttributeCode  )
OPEN Cur_AttributeDataUpdate 
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
WHILE @@FETCH_STATUS = 0 
BEGIN 

 SET @sqlt = 'UPDATE a  
 SET '+@AttributeCodeAtt+'= AttributeValue 
 FROM ZnodePimProduct a 
 INNER JOIN #TBL_PimProductId m ON(m.PimProductId = a.pimProductId ) 
 WHERE m.ProductAttributeCode = '''+@AttributeCodeAtt+'''
 ' 

 EXEC (@sqlt)

FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
END 
CLOSE Cur_AttributeDataUpdate
DEALLOCATE Cur_AttributeDataUpdate 

END 



             COMMIT TRAN UpdateAttributeValue;
         END TRY
         BEGIN CATCH

			 SELECT @SKU SKU, AttributeCode, AttributeValue --PimProductId ,
			 FROM @TBL_PimProductId a
			 WHERE NOT EXISTS ( SELECT * FROM @TBL_PimAttributeValueId b WHERE a.PimProductId = b.PimProductId and a.PimAttributeId = b.PimAttributeId )

		  --SELECT ERROR_MESSAGE ()
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			         @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdateProductAttributeValue @ProductId = '+ @ProductId+',@Status='+CAST(@Status AS VARCHAR(50))+
		             ',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@AttributeCodeValues='+CAST(@AttributeCodeValues AS NVARCHAR(MAX))+',@UserId='+CAST(@UserId AS NVARCHAR(50));
             SET @Status = 0;
             SELECT 1 AS ID,
                    CAST(0 AS BIT) AS [Status],
                    @ErrorMessage;
             ROLLBACK TRAN UpdateAttributeValue;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_UpdateProductAttributeValue',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateShowOnGridColumInternal')
	DROP PROC Znode_UpdateShowOnGridColumInternal
GO

CREATE PROC [dbo].[Znode_UpdateShowOnGridColumInternal]  
(  
@PimAttributeId INT = 0   
)  
AS   
BEGIN   
BEGIN TRY   
SET NOCOUNT ON   
DECLARE @sql NVARCHAr(max) = ''  
  
  
  SELECT a.PimProductId , b.AttributeValue , c.AttributeCode    
INTO #Temp_value   
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimAttributeValueLocale b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE LocaleId = 1   
AND c.PimAttributeId = @PimAttributeId  
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
)  
UNION ALL   
  
SELECT a.PimProductId , b.AttributeValue , c.AttributeCode    
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimProductAttributeTextAreaValue b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE LocaleId = 1   
AND c.PimAttributeId = @PimAttributeId  
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
 )  
UNION ALL   
SELECT a.PimProductId , g.AttributeDefaultValue , c.AttributeCode    
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimProductAttributeDefaultValue b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttributeDefaultValueLocale g ON (g.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId)  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE b.LocaleId = 1    
AND c.PimAttributeId = @PimAttributeId  
AND g.LocaleId = 1   
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
 )  
UNION ALL   
SELECT a.PimProductId ,CAST( b.MediaId AS VARCHAR(500)) , c.AttributeCode    
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimProductAttributeMedia b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE b.LocaleId = 1   
AND c.PimAttributeId = @PimAttributeId   
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
 )  
  
 SET @sql = ''   
  
--SELECT * FROM #Temp_value WHERE AttributeCode = 'IsActive' AND AttributeValue = 'Yes'  
--UPDATE #Temp_value SET attributeValue = 'true' WHERE AttributeCode = 'IsActive' AND AttributeValue = 'Yes'  
  
  
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int   
  
DECLARE Cur_AttributeDataUpdate CURSOR FOR   
  
  
  
SELECT b.AttributeCode , PimAttributeId   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
  
  
  
OPEN Cur_AttributeDataUpdate   
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr   
WHILE @@FETCH_STATUS = 0   
BEGIN   
  
 SET @sql = 'UPDATE a    
 SET '+@AttributeCodeAtt+'= AttributeValue   
 FROM ZnodePimProduct a   
 INNER JOIN #Temp_value m ON(m.PimProductId = a.pimProductId )   
 WHERE m.AttributeCode = '''+@AttributeCodeAtt+'''  
 '   
  
 EXEC (@sql)  
  
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr   
END   
CLOSE Cur_AttributeDataUpdate  
DEALLOCATE Cur_AttributeDataUpdate   
  
  
  
END TRY   
BEGIN CATCH   
SELECT ERROR_MESSAGE()  
END CATCH   
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateShowOnGridColumn')
	DROP PROC Znode_UpdateShowOnGridColumn
GO

CREATE PROCEDURE  [dbo].[Znode_UpdateShowOnGridColumn]   
(  
   @PimAttributeId INT = 0   
 , @UserId int = 0   
 , @IsShowOngrid bit = 0   
 , @Status bit Out   
 ,@IsCreateJob bit = 0 
)  
AS   
BEGIN   
SET NOCOUNT ON   
 BEGIN TRY   
    
  
   DECLARE @ImportHeadName NVARCHAR(100), @SPScript NVARCHAR(MAX),@Tockem nvarchar(2000), @DatabaseName NVARCHAR(100), @ServerName NVARCHAR(100), @ImportProcessLogId INT= 0,@sql_job NVARCHAR(max),@UserName nvarchar(100);  
      SET @DatabaseName = DB_NAME();  
         SET @ServerName = @@serverName;  
   SET @UserName = SYSTEM_USER;  
   SET @Tockem = NEWID()  
  
  DECLARE @sql NVARCHAr(max) = '', @AttributeCode VARCHAR(2000) = (SELECT TOP 1 AttributeCode FROM ZnodePimAttribute WHERE PimAttributeId = @PimAttributeId )  
  IF @IsShowOngrid = 1  AND NOT EXISTS (SELECT TOP 1 1 FROM  INFORMATION_SCHEMA.COLUMNS a WHERE a.TABLE_NAME = 'ZnodePimProduct'   
  AND a.COLUMN_NAME = @AttributeCode  
   )  
  BEGIN   
  SET @sql = ' ALTER TABLE ZnodePimProduct ADD '+@AttributeCode + ' NVARCHAR(max)'  
  END   
  --ELSE  IF @IsShowOngrid = 0  
  --BEGIN   
  --  SET @sql = ' ALTER TABLE ZnodePimProduct DROP COLUMN  '+@AttributeCode   
  --END   
  
  EXEC (@sql)  
  
  SET @sql = ' EXEC Znode_UpdateShowOnGridColumInternal '+CAST(@PimAttributeId AS varchar (2000) )  
  
   SELECT @PimAttributeId AS ID, CAST(1 AS BIT)  AS [Status];   
  
  IF @IsCreateJob = 1 
  BEGIN 

   SET @sql_job = '  
         DECLARE @jobId BINARY(16);  
         -- SET @NewGUID = REPLACE(@Tockem, '''', '');  
         EXEC msdb.dbo.sp_add_job   
              @job_name = @Tockem,@enabled = 1,@notify_level_eventlog = 0,@notify_level_email = 2,@notify_level_netsend = 2,@notify_level_page = 2,@delete_level = 3,  
              @category_name = N''[Uncategorized (Local)]'',@owner_login_name = N'''+@UserName+''',@job_id = @jobId OUTPUT;  
  
         SELECT @jobId;  
  
         EXEC msdb.dbo.sp_add_jobserver  
              @job_name = @Tockem,@server_name = @ServerName;  
  
         EXEC msdb.dbo.sp_add_jobstep  
              @job_name = @Tockem,@step_name = N''ShowOngridUpdate'',@step_id = 1,@cmdexec_success_code = 0,@on_success_action = 1,@on_fail_action = 2,@retry_attempts = 3,  
              @retry_interval = 0,@os_run_priority = 0,@subsystem = N''TSQL'',@command = @SQL,@database_name = @DatabaseName,@flags = 0;  
    
   --IF @ReturnCode= 0 (success) or 1 (failure)  
         DECLARE @ReturnCode TINYINT;   
         EXEC @ReturnCode = msdb.dbo.sp_start_job  
              @job_name = @Tockem,@server_name = @ServerName,@step_name = N''ShowOngridUpdate'';  
      SELECT @Tockem  '  
  
    
  
   IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'  AND  @IsShowOngrid = 1   
   BEGIN   
        EXEC sys.sp_executesql  @SQL;      
  
   END   
   ELSE IF  @IsShowOngrid = 1   
   BEGIN   
     
  EXEC sys.sp_executesql  @sql_job,N' @SQL NVARCHAR(max) ,@DatabaseName NVARCHAR(100), @ServerName NVARCHAR(100),@Tockem uniqueidentifier,@LocaleId TransferId READONLY',@SQL  =@SQL,@DatabaseName=@DatabaseName,@ServerName=@ServerName,@Tockem =@Tockem   ;  
  
        
   END  
   END 
   ELSE 
   BEGIN 

   EXEC (@sql) 

   END 

    
   SET @Status = 1;  
 END TRY   
 BEGIN CATCH   
 SET @Status = 0;  
 SELECT ERROR_MESSAGE()  
 END CATCH    
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodePortalCatalog_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePortalCatalog'))
BEGIN
	ALTER TABLE [dbo].[ZnodePortalCatalog] DROP CONSTRAINT [FK_ZnodePortalCatalog_ZnodePublishCatalog]
END

GO

IF NOT EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodePromotionProfileMapper')
BEGIN
	CREATE TABLE [dbo].[ZnodePromotionProfileMapper] (
		[PromotionProfileMapperId]   INT      IDENTITY (1,1) NOT NULL,
		[PromotionId]                INT      NOT NULL,
		[ProfileId]                  INT      NULL,
		[CreatedBy]                  INT      NOT NULL,
		[CreatedDate]                DATETIME NOT NULL,
		[ModifiedBy]                 INT      NOT NULL,
		[ModifiedDate]               DATETIME NOT NULL,  
	CONSTRAINT [PK_ZnodePromotionProfileMapper] PRIMARY KEY CLUSTERED ([PromotionProfileMapperId] ASC) WITH (FILLFACTOR = 90),
	CONSTRAINT [FK_ZnodePromotionProfileMapper_ZnodePromotion] FOREIGN KEY ([PromotionId]) REFERENCES [dbo].[ZnodePromotion] ([PromotionId]),
	CONSTRAINT [FK_ZnodePromotionProfileMapper_ZnodeProfile] FOREIGN KEY ([ProfileId]) REFERENCES [dbo].[ZnodeProfile] ([ProfileId])
	);
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePromotion')
	DROP PROC Znode_DeletePromotion
GO

CREATE PROCEDURE [dbo].[Znode_DeletePromotion]
      ( @PromotionId VARCHAR(300) ,
        @Status      INT OUT)
AS
/*
Summary: This Procedure is used to delete promotion associated to user
Unit Testing:
EXEC Znode_DeletePromotion @PromotionId =,0
*/
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             BEGIN TRAN A;
             DECLARE @DeletdAttributeId TABLE (
                                              PromotionId INT
                                              );
             INSERT INTO @DeletdAttributeId
                    SELECT Item
                    FROM dbo.split ( @PromotionId , ','
                                   ) AS a; 

             DELETE FROM ZnodeAccountPromotion
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @DeletdAttributeId AS a
                            WHERE a.PromotionId = ZnodeAccountPromotion.PromotionId
                          );
             DELETE FROM ZnodeUserPromotion
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @DeletdAttributeId AS a
                            WHERE a.PromotionId = ZnodeUserPromotion.PromotionId
                          );
             DELETE FROM ZnodePromotionCoupon
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @DeletdAttributeId AS a
                            WHERE a.PromotionId = ZnodePromotionCoupon.PromotionId
                          ); 

             DELETE FROM ZnodePromotionCatalogs WHERE EXISTS (SELECT TOP 1 1 FROM @DeletdAttributeId a WHERE a.PromotionId = ZnodePromotionCatalogs.PromotionId) 

             DELETE FROM ZnodePromotionCategory WHERE EXISTS (SELECT TOP 1 1 FROM @DeletdAttributeId a WHERE a.PromotionId = ZnodePromotionCategory.PromotionId)

             DELETE FROM ZnodePromotionProduct WHERE EXISTS (SELECT TOP 1 1 FROM @DeletdAttributeId a WHERE a.PromotionId = ZnodePromotionProduct.PromotionId) 

			 DELETE FROM ZnodePromotionBrand WHERE EXISTS (SELECT TOP 1 1 FROM @DeletdAttributeId a WHERE a.PromotionId = ZnodePromotionBrand.PromotionId) 

			 DELETE FROM ZnodePromotionShipping WHERE EXISTS (SELECT TOP 1 1 FROM @DeletdAttributeId a WHERE a.PromotionId = ZnodePromotionShipping.PromotionId) 

			 Delete From ZnodePromotionProfileMapper where exists (SELECT TOP 1 1
                            FROM @DeletdAttributeId AS a
                            WHERE a.PromotionId = ZnodePromotionProfileMapper.PromotionId
                          );
             DELETE FROM ZnodePromotion
             WHERE EXISTS ( SELECT TOP 1 1
                            FROM @DeletdAttributeId AS a
                            WHERE a.PromotionId = ZnodePromotion.PromotionId
                          );
             IF ( SELECT COUNT(1)
                  FROM @DeletdAttributeId
                ) = ( SELECT COUNT(1)
                      FROM dbo.split ( @PromotionId , ','
                                     ) AS a
                    )
                 BEGIN
                     SELECT 1 AS ID , CAST(1 AS BIT) AS Status;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID , CAST(0 AS BIT) AS Status;
                 END;
             SET @Status = 1;
             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
            DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePromotion @PromotionId = '+@PromotionId+',@Status='+CAST(@Status AS VARCHAR(200));
             SET @Status = 0;
             SELECT 0 AS ID,
                    CAST(0 AS BIT) AS Status;
			 ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeletePromotion',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetAllPromotionsList')
	DROP PROC Znode_GetAllPromotionsList
GO

CREATE PROCEDURE [dbo].[Znode_GetAllPromotionsList]
AS
BEGIN
    SET NOCOUNT ON;
    BEGIN Try
        SELECT zp.PromotionId, zp.PromoCode,zp.Name,zp.Description,zp.PromotionTypeId,zp.Discount,zp.StartDate,
            zp.EndDate,zp.OrderMinimum,zp.QuantityMinimum,zp.IsCouponRequired,zp.DisplayOrder,zp.IsUnique,zp.PortalId, zpp.ProfileId,zp.PromotionProductQuantity,zp.ReferralPublishProductId,zp.PromotionMessage,zp.IsAllowedWithOtherCoupons,zpt.ClassName,zpt.ClassType,zpt.IsActive,zpt.Name,zpt.Description,zpt.PromotionTypeId 
        FROM ZnodePromotion As zp
        INNER JOIN ZnodePromotionType As zpt ON zp.PromotionTypeId = zpt.PromotionTypeId
        LEFT JOIN ZnodePromotionProfileMapper As zpp ON zp.PromotionId = zpp.PromotionId;
    END TRY
    BEGIN CATCH
        DECLARE @Status BIT ;
        SET @Status = 0;
        DECLARE @Error_procedure VARCHAR(1000) = ERROR_PROCEDURE(), 
                @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
                @ErrorLine VARCHAR(100)= ERROR_LINE(), 
                @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetAllPromotionsList';
                           
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
            
        EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_GetAllPromotionsList',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
    END CATCH;
END

GO

INSERT INTO ZnodePromotionProfileMapper
	(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT P.PromotionId,P.ProfileId,2,GETDATE(),2,GETDATE()
FROM ZnodePromotion P
WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper WHERE PromotionId=P.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0))

GO

IF EXISTS (SELECT * FROM sys.views WHERE name='View_ManageLinkProductList' and type='v')
	DROP View View_ManageLinkProductList;
GO

CREATE View [dbo].[View_ManageLinkProductList]
AS
with AttributeValuePvot AS (
SELECT        zpald.PimParentProductId,  zpavl1.AttributeValue , zpa.AttributeCode,Zpald.PimLinkProductDetailid,zpald.PimProductId RelatedProductId,zpavl1.LocaleId,zpald.PimAttributeId
FROM ZnodePimLinkProductDetail zpald
INNER JOIN  ZnodePimAttributeValue zpav1 ON (zpav1.PimProductId = zpald.PimProductId) 
INNER JOIN ZnodePimAttribute zpa ON (zpa.PimAttributeId = zpav1.PimAttributeId) 						
LEFT JOIN ZnodePimAttributeValueLocale zpavl1 ON (zpavl1.PimAttributeValueId = zpav1.PimAttributeValueId)
WHERE zpa.AttributeCode IN ('ProductName','ProductType', 'SKU', 'Price', 'Quantity', 'Status','Assortment')
)

SELECT zpp.PimProductId Productid, Piv.[ProductName],Piv.ProductType, ''  AttributeFamily , Piv.[SKU], [Price], [Quantity][Qty], [Status],PimLinkProductDetailid,RelatedProductId,Piv.[Assortment],piv.LocaleId,Piv.PimAttributeId
FROM ZNodePimProduct zpp 
INNER JOIN  AttributeValuePvot 
PIVOT 
(
 Max(AttributeValue) FOR AttributeCode  IN ([ProductName],[SKU],[Price],[Quantity],[Status],[ProductType],[Assortment] )
)Piv  ON (Piv.PimParentProductId = zpp.PimProductId)

GO

IF NOT EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodeTradeCentricUser')
BEGIN
	CREATE TABLE [dbo].[ZnodeTradeCentricUser] (
		[TradeCentricUserId]   INT            IDENTITY(1,1) NOT NULL, 
		[OrganizationId]       NVARCHAR(50)   NULL, 
		[OrganizationName]     NVARCHAR(500)  NOT NULL, 
		[ReturnUrl]            NVARCHAR(500)  NOT NULL, 
		[UserId]               INT            NOT NULL, 
		[CreatedBy]            INT            NOT NULL, 
		[CreatedDate]          DATETIME       NOT NULL, 
		[ModifiedBy]           INT            NOT NULL, 
		[ModifiedDate]         DATETIME       NOT NULL,
		CONSTRAINT [PK_ZnodeTradeCentricUser] PRIMARY KEY CLUSTERED ([TradeCentricUserId] ASC),
		CONSTRAINT [FK_ZnodeTradeCentricUser_ZnodeUser] FOREIGN KEY ([UserId]) REFERENCES [dbo].[ZnodeUser] ([UserId])
	);
END

GO

IF EXISTS (SELECT * FROM sys.views WHERE name='View_ManageProductList' and type='v')
	DROP View View_ManageProductList;
GO

CREATE VIEW [dbo].[View_ManageProductList]
AS
     WITH AttributeValuePvot
          AS (SELECT zpav.PimProductId,
                     zpavl.AttributeValue AttributeValue,
                     zpa.AttributeCode,
                     ISNULL(zpafl.AttributeFamilyName, '') AttributeFamilyName,
                     zpaL.LocaleId
              FROM ZnodePimAttribute zpa
                   INNER JOIN ZnodePimAttributeLocale zpal ON(zpa.PimAttributeId = zpal.PimAttributeId)
                   INNER JOIN ZnodePimAttributeValue zpav ON(zpa.PimAttributeId = zpav.PimAttributeId)
                   INNER JOIN ZnodePimAttributeValueLocale zpavl ON(zpavl.PimAttributeValueId = zpav.PimAttributeValueId
                                                                    AND zpal.LOcaleid = zpavl.LOcaleid)
                   LEFT JOIN ZnodePimAttributeFamily zpaf ON((EXISTS
                                                             (
                                                                 SELECT DISTINCT
                                                                        PimAttributeFamilyId
                                                                 FROM ZnodePimAttributeValue qwq
                                                                 WHERE qwq.PimProductId = zpav.PimProductId
                                                                       AND qwq.PimAttributeFamilyId = zpaf.PimAttributeFamilyId
                                                             )
                                                              OR EXISTS
                                                             (
                                                                 SELECT TOP 1 1
                                                                 FROM ZnodePimConfigureProductAttribute zpc
                                                                 WHERE zpc.PimProductId = zpav.PimProductId
                                                                       AND zpc.PimFamilyId = zpaf.PimAttributeFamilyId
                                                             ))
                                                             AND zpaf.IsDefaultFamily <> 1)
                   LEFT JOIN ZnodePimFamilyLocale zpafl ON(zpafl.PimAttributeFamilyId = zpaf.PimAttributeFamilyId
                                                           AND zpal.LOcaleid = zpafl.LOcaleid)
              WHERE zpa.AttributeCode IN('ProductName', 'SKU', 'Price', 'Quantity', 'IsActive', 'ProductType', 'Image', 'Assortment'))
          SELECT DISTINCT
                 zpp.PimProductid ProductId,
                 Piv.[ProductName],
                 Piv.ProductType,
                 piv.AttributeFamilyName AttributeFamily,
                 Piv.[SKU],
                 [Price],
                 [Quantity],
                 CASE
                     WHEN Piv.[IsActive] IS NULL
                     THEN CAST(0 AS BIT)
                     ELSE CAST(Piv.[IsActive] AS BIT)
                 END [IsActive],
                 [Image] ImagePath,
                 Piv.[Assortment],
                 Piv.LocaleId
          FROM ZNodePimProduct zpp
               INNER JOIN AttributeValuePvot PIVOT(MAX(AttributeValue) FOR AttributeCode IN([ProductName],
                                                                                            [SKU],
                                                                                            [Price],
                                                                                            [Quantity],
                                                                                            [IsActive],
                                                                                            [ProductType],
                                                                                            [Image],
                                                                                            [Assortment])) Piv ON(Piv.PimProductId = zpp.PimProductid);

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCatalogList')
	DROP PROC Znode_GetCatalogList
GO


CREATE PROCEDURE [dbo].[Znode_GetCatalogList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetCatalogList '',100,1,'',0
	  EXEC  Znode_GetCatalogList null,100,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_CatalogId TABLE (PimCatalogId int, PublishCatalogLogId int,CatalogName VARCHAR(max),PublishStatus VARCHAR(300),RowId INT ,CountId INT,PublishCreatedDate DATETIME ,PublishModifiedDate DATETIME,PublishCategoryCount INT ,PublishProductCount INT, IsActive BIT, CatalogCode  nvarchar(100))
	 
		 SET @SQL = '

		;With Cte_MaxPublish AS 
		(
			 SELECT max(PublishCatalogLogId) PublishCatalogLogId,PimCatalogId
			 FROM ZnodePublishCatalogLog ZPCL   
			 GROUP BY PimCatalogId
		)
		,Cte_CatalogLog AS (
		SELECT ZPC.CatalogName CatalogName, PublishCatalogLogId PublishCatalogLogId,  TYU.DisplayName   PublishStatus ,ZPC.PimCatalogId
		,ZPCL.CreatedDate AS PublishCreatedDate,ZPCL.ModifiedDate AS PublishModifiedDate,
		ISNULL(ZPCL.PublishCategoryId,0)PublishCategoryCount,ISNULL(ZPCL.PublishProductId,0) PublishProductCount,ZPC.IsActive, ZPC.CatalogCode
		FROM ZnodePimCatalog ZPC 
		LEFT JOIN ZnodePublishCatalogLog ZPCL  ON ( EXISTS (SELECT TOP 1 1 FROM Cte_MaxPublish CTE 											
		WHERE CTE.PimCatalogId = ZPC.PimCatalogId AND CTE.PublishCatalogLogId =  ZPCL.PublishCatalogLogId) )	
		LEFT JOIN ZnodePublishState TYU ON (TYU.PublishStateId = ZPCL.PublishStateId )
		
		)
	     ,Cte_PublishStatus 
		 AS (
		 SELECT PimCatalogId, PublishCatalogLogId, CatalogName, PublishStatus,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive,CatalogCode,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'PublishCatalogLogId DESC')+' , Count(*)Over() CountId FROM Cte_CatalogLog
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT PimCatalogId, PublishCatalogLogId,CatalogName,PublishStatus,RowId,CountId,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive,CatalogCode
		 FROM Cte_PublishStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	

	     PRINT @sql 
		 INSERT INTO @TBL_CatalogId 
		 EXEC (@SQL)

		 SELECT  PimCatalogId,PublishCatalogLogId,CatalogName,PublishStatus,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive, CatalogCode
		 FROM @TBL_CatalogId

		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_CatalogId),0)
	 

	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCatalogList @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS
			VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetCatalogList',
					@ErrorInProcedure = 'Znode_GetCatalogList',
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() 
			,@Getdate DATETIME = dbo.fn_getdate()
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,IsAddon bit   )
    
	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-'+CAST(@Getdate as varchar(200))+'Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email


	INSERT INTO @Tbl_versions 
	SELECT 'Preview'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'Production'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	


	
	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	



	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId, a.RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionType FROM @Tbl_versions)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 IsAddon
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 IsAddon
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault, 1 IsAddon
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault, 0 IsAddon
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



DROP TABLE IF EXISTS #PimProduct_distinct



SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)




UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 

DELETE p
OUTPUT deleted.ZnodeProductId INTO @Deleted_Products
FROM ZnodePublishProductEntity p  WHERE PublishProductEntityId IN   (SELECT PublishProductEntityId FROM #PublishProductEntityId) 


DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 


SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT , DisplayOrder INT , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  


UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = b.DisplayOrder , IsActive = b.IsActive, ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
INNER JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)




UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(200),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId



INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(2000),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1

FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode




SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


--SELECT * FROM @Versions_working

SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,'' CultureCode,'' CurrencySuffix
	   ,'' CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(200),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU)
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)




EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )

INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
SELECT q.VersionId,a.PimProductId, @PimCatalogId, b.PimProductId , b.DisplayOrder,'[]', '', IsDefault,1
FROM ZnodePimConfigureProductAttribute a 
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = q.VersionId AND a.PimProductId = t.ZnodeProductId )

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, PimProductId, a.DisplayOrder, 0 ,1 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Bundle Product')


INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, PimProductId, a.DisplayOrder ,1 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Group Product')

INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)

SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,LocaleId,'','' DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.IsAddon = 1 
	
	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID


	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId = 3
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 


	SELECT @PimCatalogId AS id,@Status AS Status;     
  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	   
	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetActiveCatalogIds')
	DROP PROC Znode_GetActiveCatalogIds
GO

CREATE PROCEDURE [dbo].[Znode_GetActiveCatalogIds]
AS
BEGIN
BEGIN TRY 
with cte AS 
(
 SELECT PublishCatalogId    
 from ZnodePortalCatalog PC 
 left join ZnodePublishCatalogEntity  PCE on  PC.PublishCatalogId = PCE.ZnodeCatalogId 
 GROUP BY PublishCatalogId
 )
 SELECT STRING_AGG( PublishCatalogId , ',') PublishCatalogId  FROM cte

END TRY 
BEGIN CATCH 
 DECLARE @Status BIT ;    
  SET @Status = 0;    
  DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetActiveCatalogIds  ';    
                      
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
        
        EXEC Znode_InsertProcedureErrorLog    
   @ProcedureName = 'Znode_GetActiveCatalogIds',    
   @ErrorInProcedure = @Error_procedure,    
   @ErrorMessage = @ErrorMessage,    
   @ErrorLine = @ErrorLine,    
   @ErrorCall = @ErrorCall;   

END CATCH 
END

GO

UPDATE ZnodeImportAttributeValidation 
SET IsRequired=1 WHERE AttributeCode IN ('StartDate','ExpirationDate','VoucherNumber','VoucherAmount','RemainingAmount') 
AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE NAME = 'Voucher')

GO

delete ZnodePortalGlobalAttributeValueLocale 
where PortalGlobalAttributeValueId in (select  PortalGlobalAttributeValueId from ZnodePortalGlobalAttributeValue where GlobalAttributeId = 
(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableTradeCentric')) 

delete ZnodePortalGlobalAttributeValue where 
GlobalAttributeId = ((select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableTradeCentric'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() 
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,IsAddon bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	

	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-'+CAST(@Getdate as varchar(200))+'Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'Preview'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'Production'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	


	
	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	



	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId, a.RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionType FROM @Tbl_versions)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 IsAddon
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 IsAddon
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault, 1 IsAddon
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault, 0 IsAddon
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



DROP TABLE IF EXISTS #PimProduct_distinct



SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)




UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 

DELETE p
OUTPUT deleted.ZnodeProductId INTO @Deleted_Products
FROM ZnodePublishProductEntity p  WHERE PublishProductEntityId IN   (SELECT PublishProductEntityId FROM #PublishProductEntityId) 


DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 


SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT , DisplayOrder INT , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  


UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = b.DisplayOrder , IsActive = b.IsActive, ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
INNER JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(200),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId



INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(2000),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1

FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT r.PimProductId , MAX(Quantity) Quantity
INTO #ZnodeInventory
FROM ZnodeInventory a with (nolock)
INNER JOIN  #PimProduct_distinct r ON ( r.SKU = a.SKU )
GROUP BY PimProductId


--SELECT * FROM @Versions_working

SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(200),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU)
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds





EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
SELECT q.VersionId,a.PimProductId, @PimCatalogId, b.PimProductId , b.DisplayOrder,'[]', '', IsDefault,1
FROM ZnodePimConfigureProductAttribute a 
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = q.VersionId AND a.PimProductId = t.ZnodeProductId )

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, a.PimProductId, a.DisplayOrder, b.Quantity ,1 
FROM @PimProduct_catalog a 
LEFT JOIN #ZnodeInventory b ON (b.PimProductId = a.PimProductId )
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Bundle Product')



INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, PimProductId, a.DisplayOrder ,1 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)

SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,LocaleId,'','' DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.IsAddon = 1 
	
	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID


	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId = 3
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 


	SELECT @PimCatalogId AS id,@Status AS Status;     
  
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
     
	   
	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ManageProductListByAttributes')
	DROP PROC Znode_ManageProductListByAttributes
GO

CREATE PROCEDURE [dbo].[Znode_ManageProductListByAttributes]
(   @WhereClause      XML,
	@PimAttributeIds  VARCHAR(3000) = NULL,
	@Rows             INT           = 100,
	@PageNo           INT           = 0,
	@Order_BY         VARCHAR(1000) = '',
	@LocaleId         INT,
	@PimProductId     VARCHAR(max) = NULL,
	@IsProductNotIn   BIT           = 0,
	@RelatedProductId INT           = 0, 
	@IsDebug		    BIT = 0 
	)
AS
   /*  Summary:-  This Procedure is used for get product List with extra column attribute supllied to the procedure 
     Unit Testing 
     DECLARE @EDE INT = 0 
	 exec Znode_ManageProductListByAttributes @WhereClause='',@PimAttributeIds = '115',@Rows = 10,@PageNo=1,@Order_BY = '',@RelatedProductId = 179,@PimProductId = '',@IsProductNotIn= 0 ,@LocaleId=1 --SELECT @EDE 
	SELECT * FROM ZnodePimAttribute 
	*/
     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
		  --  SELECT '123112'
             DECLARE @SQL NVARCHAR(MAX), @AttributeCode_filter NVARCHAR(2000), @WhereClauseChanges NVARCHAR(MAX)= '',@OutPimProductIds varchar(max) ;
             SET @WhereClauseChanges = CONVERT(NVARCHAR(MAX), @WhereClause);
             DECLARE @PimAttributeFamilyId INT= Dbo.Fn_GetDefaultValue('PimFamily'), @RowsCount INT, @DefaultLocaleId INT= Dbo.Fn_GetDefaultlocaleId();
             DECLARE @TransferPimProductId TransferId 
			 DECLARE @TBL_PimMediaAttributeId TABLE (PimAttributeId INT ,AttributeCode VARCHAR(600))
			 INSERT INTO @TBL_PimMediaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM Dbo.Fn_GetProductMediaAttributeId ()					 
			
	
			 DECLARE @ProductIdTable TABLE
             (PimProductId INT,
              CountId      INT,
              RowId        INT identity(1,1)
             );
             DECLARE @TBL_PimAttributeId TABLE
             (PimAttributeId INT,
              AttributeCode  VARCHAR(600)
             );
             INSERT INTO @TBL_PimAttributeId
             (PimAttributeId,
              AttributeCode
             )
                    SELECT PimAttributeId,
                           AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.Split(@PimAttributeIds, ',') SP
                        WHERE SP.Item = ZPA.PimAttributeId
                    );
					
             SET @AttributeCode_filter = ISNULL(CAST((
                                                      SELECT CAST('<WhereClauseModel><attributecode>'+ '  = '+''''+TBPA.AttributeCode+''''+'</attributecode></WhereClauseModel>' AS XML )
                                                      FROM @TBL_PimAttributeId TBPA
                                                      FOR XML PATH(''),TYPE
                                                  ) AS NVARCHAR(max)),'');
          
		     SET @WhereClauseChanges = [dbo].[Fn_GetXmlWhereClauseForAttribute](@WhereClauseChanges,@AttributeCode_filter, @LocaleId);
             SET @WhereClause = CONVERT(XML, @WhereClauseChanges);	
	    
		  INSERT INTO @TransferPimProductId
		  SELECT ITEM
		  FROM DBO.SPLIT(@PIMPRODUCTID,',')
		  UNION ALL 
		  SELECT PimProductId 
		  FROM ZnodePimProductTypeAssociation  
		  WHERE PimParentProductId=  @RelatedProductId
		  AND @PIMPRODUCTID = '0'
		
		   DECLARE @AttributeCode NVARCHAR(max)
		   SET @AttributeCode = SUBSTRING ((SELECT ','+AttributeCode FROM [dbo].[Fn_GetProductGridAttributes]() qt WHERE (EXISTS (SELECT TOP 1 1 
				FROM dbo.split(@PimAttributeIds,',') TR WHERE tr.Item = qt.PimAttributeId)  OR AttributeCode = 'ProductType')
		   FOR XML PATH('')  ),2,4000)
	
	SET @IsProductNotIn = CASE WHEN @IsProductNotIn = 1 THEN 0 
	 WHEN @IsProductNotIn = 0 THEN 1  END
     DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid 
	 DECLARE @tBL_mainList TABLE(Id INT , RowId INT )
	
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList @IsProductNotIn ,@TransferPimProductId


	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN 
	  
	  SET @SQL = 'SELECT PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))
	  --INSERT INTO @TAB 
	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId
	  
      INSERT INTO @TAB 
	  EXEC (@SQL)
	 
	 END 
	 	
	 
	 IF EXISTS (SELECT Top 1 1 FROM @TAb )OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 
	
	 SET @AttributeCode = dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC',''))
	 INSERT INTO @TBL_MainList
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId
	
	 END 
	 ELSE 
	 BEGIN
	 SET @AttributeCode = dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC',''))
	 INSERT INTO @TBL_MainList
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId 
	 END 

	
			 INSERT INTO @ProductIdTable
             (PimProductId) 
			 select id
			 from @TBL_MainList
		
             SET @AttributeCode_filter = SUBSTRING(
                                                  (
                                                      SELECT ','+TBPA.AttributeCode
                                                      FROM @TBL_PimAttributeId TBPA
                                                      FOR XML PATH('')
                                                  ), 1, 4000);
     

			 DECLARE @PimProductIds TransferId

			 INSERT INTO @PimProductIds ( Id )
			 SELECT distinct id FROM @TBL_MainList
														      		
             DECLARE @DefaultAttributeCode VARCHAR(MAX)= dbo.Fn_GetDefaultValue('AttributeCode');
          			
			 INSERT INTO @TBL_PimAttributeId
             (PimAttributeId,
              AttributeCode
             )
                    SELECT PimAttributeId,
                           AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.Split(@DefaultAttributeCode, ',') SP
                        WHERE SP.Item = ZPA.AttributeCode
                    );
			
		

			INSERT INTO @TBL_PimAttributeId
             (PimAttributeId,
              AttributeCode
             )
                    SELECT PimAttributeId,
                           'OR_'+AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.Split(@PimAttributeIds, ',') SP
                        WHERE SP.Item = ZPA.PimAttributeId
                    );
             
	
             SET @DefaultAttributeCode = @DefaultAttributeCode + @AttributeCode_filter;
             Create TABLE #TBL_AttributeDetails 
             (
				  PimProductId                INT ,
				  AttributeValue              NVARCHAR(MAX),
				  AttributeCode               VARCHAR(600),
				  PimAttributeId              INT,
				  PimProductTypeAssociationId INT,
				  DisplayOrder                INT,
				  IsNonEditableRow            BIT DEFAULT 0,
				  IsDefault bit
             );
             DECLARE @TBL_AttributeCode TABLE
             (
				  PimAttributeId INT,
				  AttributeCode  VARCHAR(300)
             );
             INSERT INTO @TBL_AttributeCode
             (
				  PimAttributeId,
				  AttributeCode
             )
                    SELECT PimAttributeId,
                           AttributeCode
                    FROM ZnodePimAttribute ZPA
                    WHERE EXISTS
                    (
                        SELECT TOP 1 1
                        FROM dbo.split(@DefaultAttributeCode, ',') SP
                        WHERE Sp.Item = ZPA.AttributeCode
                    );

             DECLARE @TBL_AttributeDefaultValue TABLE
             (
				PimAttributeId            INT,
				AttributeDefaultValueCode VARCHAR(100),
				IsEditable                BIT,
				AttributeDefaultValue     NVARCHAR(MAX),
				DisplayOrder INT
             );
			  
             DECLARE @PimAttributeId VARCHAR(MAX);
             SET @PimAttributeId = SUBSTRING(
                                            (
                                                SELECT ','+CAST(TBAC.PimAttributeId AS VARCHAR(50))
                                                FROM @TBL_AttributeCode TBAC
                                                     INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON(ZPADV.PimAttributeId = TBAC.PimAttributeId)
                                                FOR XML PATH('')
                                            ), 2, 4000);

													
             INSERT INTO @TBL_AttributeDefaultValue
             (
				PimAttributeId,
				AttributeDefaultValueCode,
				IsEditable,
				AttributeDefaultValue,
				DisplayOrder
             )
             EXEC Znode_GetAttributeDefaultValueLocale
                  @PimAttributeId,
                  @LocaleId;

			
             INSERT INTO #TBL_AttributeDetails
             (
				  PimProductId,
				  AttributeValue,
				  AttributeCode,
				  PimAttributeId
             )
             EXEC Znode_GetProductsAttributeValue
                  @PimProductIds,
                  @DefaultAttributeCode,
                  @localeId;
				
			 INSERT INTO #TBL_AttributeDetails
             (
				  PimProductId,
				  AttributeValue,
				  AttributeCode,
				  PimAttributeId
             )
			SELECT ZPAV.PimProductId ,ZPPAVD.PimAttributeDefaultValueId,'OR_'+ZPA.AttributeCode,ZPA.PimAttributeId
			FROM ZnodePimAttributeValue ZPAV 
			INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId) 
			INNER JOIN @ProductIdTable TBL ON (TBL.PimProductId = ZPAV.PimProductId )
			INNER JOIN ZnodePimProductAttributeDefaultValue ZPPAVD ON (ZPPAVD.PimAttributeValueId = ZPAV.PimAttributeValueId  )
			WHERE ZPPAVD.LocaleId = @DefaultLocaleId
			AND EXISTS (SELECT TOP 1 1 FROM dbo.Split(@PimAttributeIds,',') SP WHERE Sp.Item = ZPA.PimAttributeId )

				
			----------------------------------------------------------------------------------------------
			DECLARE @SKU SelectColumnList
			Create TABLE  #Temp_Inventory (Quantity NVARCHAR(MAX),PimProductId INT)

			INSERT INTO @SKU
			SELECT AttributeValue FROM #TBL_AttributeDetails
			WHERE AttributeCode = 'SKU'
						
			INSERT INTO #Temp_Inventory(Quantity,PimProductId)
			EXEC Znode_GetPimProductAttributeInventory @SKU=@SKU, @LocaleId=@LocaleId
						
			---------------------------------------------------------------------------------------------------------

             DECLARE @FamilyDetails TABLE
             (PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(3000)
             );

             INSERT INTO @FamilyDetails
             (PimAttributeFamilyId,
              PimProductId
             )
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId]
                  @PimProductIds,
                  1;
					  
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @LocaleId);
             UPDATE a
               SET
                   FamilyName = b.AttributeFamilyName
             FROM @FamilyDetails a
                  INNER JOIN ZnodePimFamilyLocale b ON(a.PimAttributeFamilyId = b.PimAttributeFamilyId
                                                       AND LocaleId = @DefaultLocaleId)
             WHERE a.FamilyName IS NULL
                   OR a.FamilyName = '';
			
             --- Update the  product families name locale wise   

				   
			   SELECT TBA.PimProductId , TBA.PimAttributeId 
			   , SUBSTRING( ( SELECT ','+dbo.Fn_GetMediaThumbnailMediaPath (zm.PATH) 
			   FROM ZnodeMedia AS ZM
              
			   INNER JOIN #TBL_AttributeDetails AS TBAI ON (TBAI.AttributeValue  = CAST(ZM.MediaId AS VARCHAR(50)) )
			   INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBAI.PimATtributeId)
			   WHERE TBAI.PimProductId = TBA.PimProductId AND TBAI.PimAttributeId = TBA.PimAttributeId 
			   FOR XML PATH('') ), 2 , 4000) AS AttributeValue 
			   into #TBL_ProductMedia
			   FROM #TBL_AttributeDetails AS TBA 
			   INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBA.PimATtributeId )
                         
   
		       UPDATE TBAV SET AttributeValue = CTPM.AttributeVALue
			   FROM #TBL_AttributeDetails TBAV 
			   INNER JOIN #TBL_ProductMedia CTPM ON CTPM.PimProductId = TBAV.PimProductId  AND CTPM.PimAttributeId = TBAV.PimAttributeId 
			   AND CTPM.PimAttributeId = TBAV.PimAttributeId;
			  					
		
             UPDATE TBAD
               SET
                   PimProductTypeAssociationId = ZPTA.PimProductTypeAssociationId,
                   DisplayOrder = ZPTA.DisplayOrder, IsDefault = ZPTA.IsDefault
             FROM #TBL_AttributeDetails TBAD
                  INNER JOIN ZnodePimproductTypeAssociation ZPTA ON(ZPTA.PimProductId = TBAD.PimProductId)
             WHERE ZPTA.PimParentProductId = @RelatedProductId;
            
			-- DECLARE @AttributeCode NVARCHAR(4000);
             SET @AttributeCode = SUBSTRING(
                                           (
                                               SELECT DISTINCT
                                                      ','+QUOTENAME(AttributeCode)
                                               FROM @TBL_PimAttributeId
                                               FOR XML PATH('')
                                           ), 2, 4000);
             DECLARE @AttributeCode_Duplicate NVARCHAR(4000)= SUBSTRING(
                                                                       (
                                                                           SELECT 
                                                                                  ', Piv.'+QUOTENAME(AttributeCode)
                                                                           FROM ZnodePimAttribute ZPA
                                                                           WHERE EXISTS
                                                                           (
                                                                               SELECT TOP 1 1
                                                                               FROM dbo.Split(@PimAttributeIds, ',') SP
                                                                               WHERE SP.Item = ZPA.PimAttributeId
                                                                               ORDER BY AttributeCode
                                                                           )
																		   GROUP BY ZPA.AttributeCode,ZPA.DisplayOrder
																		   ORDER BY ZPA.DisplayOrder  DESC
                                                                           FOR XML PATH('')
                                                                       ), 1, 4000);
             DECLARE @AttributeCode_Duplicate_Data NVARCHAR(4000);
			 	 
			

			  SET  @AttributeCode_Duplicate_Data= SUBSTRING(
                                                                       (
                                                                           SELECT 
                                                                                  'AND Piv.'+QUOTENAME('OR_'+AttributeCode) +'= Isa.'+QUOTENAME(AttributeCode)+' '
                                                                           FROM ZnodePimAttribute ZPA
                                                                           WHERE EXISTS
                                                                           (
                                                                               SELECT TOP 1 1
                                                                               FROM dbo.Split(@PimAttributeIds, ',') SP
                                                                               WHERE SP.Item = ZPA.PimAttributeId
                                                                               ORDER BY AttributeCode
                                                                           )
																		   GROUP BY ZPA.AttributeCode,ZPA.DisplayOrder
																		   ORDER BY ZPA.DisplayOrder  DESC
                                                                           FOR XML PATH('')
                                                                       ), 4, 4000) +' '

            -- SET @AttributeCode_Duplicate_Data = REPLACE(SUBSTRING(@AttributeCode_Duplicate, 2, 4000), ',', '+'',''+');
             SELECT PimProductId,
                    AttributeValue,
                    AttributeCode,
                    PimProductTypeAssociationId,
                    DisplayOrder, IsDefault
             INTO #Temp_attribute
             FROM #TBL_AttributeDetails
             ORDER BY DisplayOrder;
             SELECT *
             INTO #temp_Family
             FROM @FamilyDetails;
             
			 DECLARE @IsSelectedAttributeValue TABLE
             (ProductId      INT,
              AttributeValue NVARCHAR(500),
              AttributeCode  NVARCHAR(500),
              PimAttributeId INT,PimAttributeDefaultValueId INT 
             );

			  
		   DECLARE @IsSelectedAttributeValueLocale TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode NVARCHAR(600),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(max),
			  DisplayOrder   INT 
             );
          

		  -- select @PimProductId ,@AttributeCode ,@LocaleId 
		  ;With Cte_AttributeVAkuestest AS 
		  (
		    SELECT ZPAV.PimAttributeId , ZPPAD.PimAttributeDefaultValueId ,ZPAV.PimProductId
			FROM ZnodePimAttributeVAlue ZPAV 
			INNER JOIN ZnodePimProductAttributeDefaultValue ZPPAD ON (ZPPAD.PimAttributeValueId = ZPAV.PimAttributeValueId)
			LEFT JOIN ZnodePimproductTypeAssociation ZPPTA on ZPAV.PimProductId = ZPPTA.PimProductId and ZPPTA.PimParentProductId = @RelatedProductId 
			WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(@PimAttributeIds,',') SP WHERE SP.Item = ZPAV.PimAttributeId )
			AND EXISTS (SELECT TOP 1 1 FROM dbo.split(@PimProductId,',') SP WHERE SP.Item = ZPAV.PimProductId )-- or @PimProductId = '0')
		) ,Cte_PimAttributeDefaultValueLocale AS 
		(
		  SELECT  AttributeDefaultValue ,PimAttributeId,PimProductId,CTA.PimAttributeDefaultValueId
		  FROM ZnodePimAttributeDefaultValueLocale CTA  
		  INNER JOIN Cte_AttributeVAkuestest CTB ON (CTB.PimAttributeDefaultValueId = CTA.PimAttributeDefaultValueId)		
		  WHERE LocaleId = @DefaultLocaleId 
		  UNION 
		  SELECT  AttributeDefaultValue ,PimAttributeId,PimProductId,CTA.PimAttributeDefaultValueId
		  FROM ZnodePimAttributeDefaultValueLocale CTA 
		  INNER JOIN Cte_AttributeVAkuestest CTB ON (CTB.PimAttributeDefaultValueId = CTA.PimAttributeDefaultValueId)		
		  WHERE LocaleId = @DefaultLocaleId 	
		)
		,Cte_AttributeValueForCode 
		As
		(
		  SELECT AttributeDefaultValue AtributeValue , AttributeCode ,PimProductId ,a.PimAttributeDefaultValueId
		  FROM Cte_PimAttributeDefaultValueLocale a
		  INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = a.PimAttributeId )
		)
			 INSERT INTO @IsSelectedAttributeValue (ProductId,AttributeCode,AttributeValue,PimAttributeDefaultValueId)
             SELECT PimProductId,AttributeCode,AtributeValue,PimAttributeDefaultValueId
			 FROM Cte_AttributeValueForCode
             
			 --INSERT INTO @IsSelectedAttributeValueLocale
    --         EXEC Znode_GetAttributeDefaultValueLocale
    --              @PimAttributeIds,
    --              @LocaleId;
             
			 --UPDATE izav
    --           SET
    --               izav.AttributeValue = isval.AttributeDefaultValue
    --         FROM @IsSelectedAttributeValue izav
    --              INNER JOIN @IsSelectedAttributeValueLocale isval ON izav.AttributeValue = isval.AttributeDefaultValueCode AND izav.PimAttributeId = isval.PimAttributeId ;
             

			 SELECT * 
			 --SUBSTRING(
    --                         (
    --                             SELECT ','+isav.AttributeValue
    --                             FROM @IsSelectedAttributeValue isav
				--				 INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ISAV.PimAttributeID )
    --                             WHERE isa.ProductId = isav.ProductId
    --                             ORDER BY ZPA.DisplayOrder DESC
    --                             FOR XML PATH('')
    --                         ), 2, 4000) AttributeValue,
							

             INTO #IsSelectedAttribute
             FROM @IsSelectedAttributeValue isa
			; 
				 
			 IF @IsDebug = 1 
			 BEGIN 
			 SELECT * FROM @IsSelectedAttributeValue izav

			 SELECT * FROM #IsSelectedAttribute

			 END 
             --select * from @IsSelectedAttributeValue
             --select @AttributeCode_Duplicate,@AttributeCode_Duplicate_data
             --select * from #IsSelectedAttribute
			 
             SET @AttributeCode = REPLACE(@AttributeCode, ',[DisplayOrder]', '');
             SET @SQL = '
			     
				 ;with Cte_Getvalue AS (
				 SELECT ProductId , '+SUBSTRING(@AttributeCode_Duplicate, 2, 4000)+'
				 FROM ( SELECT ProductId,AttributeCode,PimAttributeDefaultValueId FROM #IsSelectedAttribute gt ) dd 
				 PIVOT ( MAX (PimAttributeDefaultValueId) FOR AttributeCode IN ('+REPLACE(SUBSTRING(@AttributeCode_Duplicate, 2, 4000),'Piv.','')+')  ) PIV 
				 )

				SELECT DISTINCT  piv.PimProductTypeAssociationId, zpp.PimProductid ProductId, Piv.[ProductName],Piv.ProductType ,ISNULL(zf.FamilyName,'''')  AttributeFamily , Piv.[SKU]
						  , CASE WHEN Piv.[IsActive] IS NULL THEN ''false'' ELSE   Piv.[IsActive]  END  [Status],  piv.[ProductImage] ImagePath,Piv.[Assortment],DisplayOrder  ,'+CAST(@LocaleId AS VARCHAR(50))+' LocaleId
						  ,DENSE_RANK()Over(Order By'+SUBSTRING(@AttributeCode_Duplicate, 2, 4000)+') CombinationId '+@AttributeCode_Duplicate+'
					, CASE When isa.ProductId Is Null then 0 ELSE 1 END IsNonEditableRow,'+ CAST(@RelatedProductId AS VARCHAR(50))+' RelatedProductId, IDD.Quantity AvailableInventory, piv.IsDefault
				FROM ZNodePimProduct zpp 
				LEFT JOIN  #temp_Family zf ON (zf.PimProductId = zpp.PimProductId)
				INNER JOIN #Temp_attribute 
				PIVOT 
				(
				Max(AttributeValue) FOR AttributeCode  IN ( '+@AttributeCode+')
				)Piv  
				ON (Piv.PimProductId = zpp.PimProductid) 
				LEFT JOIN #Temp_Inventory IDD ON (IDD.PimProductId = Piv.PimProductId)
				--LEFT JOIN ZnodeMedia zm ON (zm.MediaId = piv.[ProductImage])
				LEFT OUTER JOIN Cte_Getvalue isa ON ('+@AttributeCode_Duplicate_Data+')
				    '+' Order BY '+ISNULL(CASE
                                                  WHEN @Order_BY = ''
                                                  THEN 'DisplayOrder'
                                                  ELSE @Order_BY
                                              END, 'DisplayOrder');
		
	
             -- SELECT '''+SUBSTRINg(REPLACE(@AttributeCode_Duplicate,'Piv.',''),2,4000)+''' Ids
			 
             SELECT AttributeCode
             FROM ZnodePimAttribute ZPA
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM dbo.Split(@PimAttributeIds, ',') SP
                 WHERE SP.Item = ZPA.PimAttributeId
             );
             
			PRINT @SQL
             EXEC SP_executesql
                  @SQL;
        
     IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN 

		  SELECT (SELECT COUNT(1) FROM @TAb) AS RowsCount   
	 END 
	 ELSE 
	 BEGIN
	 		  SELECT (SELECT COUNT(1) FROM @ProductListIdRTR) AS RowsCount   
	 END ;

             DROP TABLE #Temp_attribute;
             DROP TABLE #temp_Family;
   
             -- find the all locale values 
         END TRY
         BEGIN CATCH
		  SELECT ERROR_MESSAGE()
                DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ManageProductListByAttributes @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@PimAttributeIds='+@PimAttributeIds+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimProductId='+@PimProductId+',@IsProductNotIn='+CAST(@IsProductNotIn AS VARCHAR(50))+',@RelatedProductId='+CAST(@RelatedProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ManageProductListByAttributes',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteUserDetails')
	DROP PROC Znode_DeleteUserDetails
GO

CREATE PROCEDURE [dbo].[Znode_DeleteUserDetails]  
(
    @UserId VARCHAR(2000) = NULL,
    @Status INT OUT   ,   
    @UserIds Transferid READONLY,
    @IsForceFullyDelete BIT =0,
	@IsCallInternal BIT = 0
)
AS
/*  
	Summary: This Procedure Is used to delete user details
	Unit Testing:
	EXEC Znode_DeleteUserDetails
*/  
     BEGIN  
         BEGIN TRY  
             SET NOCOUNT ON;  
             BEGIN TRAN A;  
    DECLARE @StatusOut Table (Id INT ,Message NVARCHAR(max), Status BIT )  
             DECLARE @V_table TABLE (  
                                    USERID1 NVARCHAR(200)  
                                    );  
             DECLARE @V_tabledeleted TABLE (  
                                           UserId1      INT ,  
                                           AspnetUserid NVARCHAR(1000)  
                                           );  
             DECLARE @TBL_DeleteduserName TABLE (  
                                                id NVARCHAR(MAX)  
                                                );  
             INSERT INTO @V_tabledeleted  
                    SELECT ITEM , b.AspNetUserId  
                    FROM dbo.split ( @UserId , ','  
                                   ) AS a INNER JOIN ZnodeUser AS b ON ( a.Item = b.UserId )  
           WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsOrderDetails zood WHERE zood.UserId= b.UserId)  
      AND UserId <> 2   
       INSERT INTO @V_tabledeleted            
       SELECT a.Id , b.AspNetUserId  
                    FROM @UserIds AS a   
     INNER JOIN ZnodeUser AS b ON ( a.Id = b.UserId )  
           WHERE (NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsOrderDetails zood WHERE zood.UserId= b.UserId) OR @IsForceFullyDelete =1 )   
           AND UserId <> 2        
             DELETE FROM ZnodeUserProfile  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUserProfile.UserId  
                          );  
             DELETE FROM ZnodeUserAddress  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUserAddress.UserId  
                          );   
  
   --------  

 
   delete from ZnodeOmsPersonalizeCartItem   
   where OmsSavedCartLineItemId in (  
    select OmsSavedCartLineItemId  from ZnodeOmsSavedCartLineItem where OmsSavedCartId in (  
    select OmsSavedCartId FROM ZnodeOmsSavedCart  
    where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping  
           WHERE EXISTS ( SELECT TOP 1 1  
              FROM @V_tabledeleted AS a  
              WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
               ))));  
  
   delete from ZnodeOmsSavedCartLineItem where OmsSavedCartId in (  
   select OmsSavedCartId FROM ZnodeOmsSavedCart  
   where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping  
           WHERE EXISTS ( SELECT TOP 1 1  
              FROM @V_tabledeleted AS a  
              WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
               )));  
 
   DELETE FROM ZnodeOmsSavedCart  
   where OmsCookieMappingId in (select OmsCookieMappingId from ZnodeOmsCookieMapping  
           WHERE EXISTS ( SELECT TOP 1 1  
              FROM @V_tabledeleted AS a  
              WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
               ));  
   
   DELETE FROM ZnodeOmsCookieMapping  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeOmsCookieMapping.UserId  
                          );  
   
   DELETE ZGCH  
   FROM ZnodeGiftCardHistory ZGCH  
   INNER JOIN ZnodeGiftCard ZGC ON (ZGCH.GiftCardId = ZGC.GiftCardId)  
   WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZGC.UserId)  
  
   DELETE FROM ZnodeGiftCard              
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeGiftCard.UserId  
                          );  
     ---------  
 
             DELETE FROM ZnodeAccountUserOrderApproval  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeAccountUserOrderApproval.UserId  
                          );  
             DELETE FROM AspNetUserRoles  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.aspNetUserId = AspNetUserRoles.UserId  
                          );  
						
           
             DELETE FROM dbo.ZnodeAccountUserPermission  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeAccountUserPermission.UserId  
                          );  
       
    DELETE FROM ZnodeSalesRepCustomerUserPortal  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeSalesRepCustomerUserPortal.CustomerUserid  
                          );  
   
       delete from ZnodeSalesRepCustomerUserPortal   
    WHERE exists(select TOP 1 1  FROM ZnodeUserPortal ZUP where EXISTS ( SELECT TOP 1 1 FROM @V_tabledeleted AS a WHERE a.UserId1 = ZUP.UserId )  
                 and ZnodeSalesRepCustomerUserPortal.UserPortalId = ZUP.UserPortalId );  
       
    DELETE FROM ZnodeUserPortal  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUserPortal.UserId  
                          );  
						
             DELETE FROM ZnodeAccountUserOrderApproval  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeAccountUserOrderApproval.UserId  
                                  OR  
                                  TBDL.UserId1 = ZnodeAccountUserOrderApproval.ApprovalUserId  
                          );  
						   
    DELETE FROM ZnodeOmsUsersReferralUrl   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsUsersReferralUrl.UserId  
                           );  
						    
    DELETE FROM ZnodeOmsReferralCommission   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsReferralCommission.UserId        
                          );  
						  
   DELETE FROM ZnodeUserWishList   
   WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeUserWishList.UserId        
                          );  
						   
    DELETE FROM ZnodeDepartmentUser   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeDepartmentUser.UserId        
                          );  
						  
    DELETE FROM ZnodeUserPromotion   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeUserPromotion.UserId        
                          );  
   
    DELETE FROM AspNetUserClaims   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = AspNetUserClaims.UserId        
                          );   
					
    DELETE FROM ZnodeNote   
    WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeNote.UserId        
                          );   
  
    DELETE FROM ZnodeOmsQuotePersonalizeItem WHERE OmsQuoteLineItemId IN (SELECT OmsQuoteLineItemId FROM ZnodeOmsQuoteLineItem  WHERE OmsQuoteId IN (SELECT OmsQuoteId FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) ))   
						  
    DELETE FROM ZnodeOmsQuoteLineItem  WHERE OmsQuoteId IN (SELECT OmsQuoteId FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) )  
   
   DELETE FROM ZnodeUserApprovers  
   WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeUserApprovers.ApproverUserId        
                          )   
  
   
   DELETE FROM ZnodeOMSQuoteApproval   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOMSQuoteApproval.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;  
   
   DELETE FROM ZnodeOmsQuoteComment   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOmsQuoteComment.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;  
  
  
  
   DELETE FROM ZnodeOmsNotes   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOmsNotes.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;  
  
   DELETE FROM ZnodeOmsQuoteHistory   
     WHERE exists(select *  FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          ) AND ZnodeOmsQuoteHistory.OMSQuoteId = ZnodeOmsQuote.OmsQuoteId) ;   
  
    DELETE FROM ZnodeOmsQuote   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsQuote.UserId        
                          );   
						 
    DELETE FROM ZnodeAccountUserPermission   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeAccountUserPermission.UserId        
                          );  
						
     DELETE FROM ZnodePriceListUser   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodePriceListUser.UserId        
                          );   
						  
     DELETE FROM ZnodeMediaFolderUser   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeMediaFolderUser.UserId        
                          ); 
						  
     DELETE FROM ZnodeAccountUserOrderApproval   
     WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeAccountUserOrderApproval.UserId        
                          );   
						   
    DELETE FROM ZnodeOmsTemplateLineItem WHERE OmsTemplateId IN (SELECT OmsTemplateId   
    FROM ZnodeOmsTemplate WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsTemplate.UserId        
                          ) )  
						
  
    DELETE FROM dbo.ZnodeFormBuilderGlobalAttributeValueLocale   WHERE FormBuilderGlobalAttributeValueId IN   
    (SELECT FormBuilderGlobalAttributeValueId  FROM dbo.ZnodeFormBuilderGlobalAttributeValue  WHERE FormBuilderSubmitId IN (SELECT FormBuilderSubmitId FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId        
                          ) ))  
  
     DELETE FROM dbo.ZnodeFormBuilderGlobalAttributeValue  WHERE FormBuilderSubmitId IN (SELECT FormBuilderSubmitId FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId        
                          ) )  
						
     DELETE FROM dbo.ZnodeFormBuilderSubmit WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeFormBuilderSubmit.UserId        
                          )    

    DELETE FROM ZnodeOmsTemplate  WHERE  EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS TBDL  
                            WHERE TBDL.UserId1 = ZnodeOmsTemplate.UserId        
                          )   
      
      
   DELETE FROM ZnodeCaseRequestHistory WHERE CaseRequestId IN (SELECT CaseRequestId  FROM ZnodeCaseRequest  WHERE EXISTS (SELECT TOP  1 1 FROM @V_tabledeleted AS TBDL WHERE TBDL.UserId1 = ZnodeCaseRequest.UserId))  
     DELETE FROM ZnodeCaseRequest  WHERE EXISTS (SELECT TOP  1 1 FROM @V_tabledeleted AS TBDL WHERE TBDL.UserId1 = ZnodeCaseRequest.UserId)  
     DECLARE @OrderId Transferid   
    INSERT INTO @OrderId   
    SELECT DISTINCT  a.OmsOrderId   
    FROM ZnodeOMsOrder A   
    INNER JOIN ZnodeOmsOrderDetails b ON(b.OmsOrderId = a.OmsOrderId)  
    WHERE EXISTS (SELECT TOP 1  1 FROM @V_tabledeleted t WHERE b.UserId = t.UserId1 )  
    INSERT INTO @StatusOut (Id ,Status)   
   EXEC  Znode_DeleteOrderById   @OmsOrderIds =@OrderId ,@Status = 0   
   UPDATE ZnodePublishCatalogLog  SET Userid =2   
   WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)  
  
      
    DELETE FROM ZnodeCMSCustomerReview WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)  
             DELETE FROM ZnodeBlogNewsCommentLocale where BlogNewsCommentId in (select BlogNewsCommentId from  ZnodeBlogNewsComment WHERE UserId IN  
     (SELECT UserId1 FROM @V_tabledeleted t))  
    DELETE FROM ZnodeBlogNewsComment WHERE UserId IN (SELECT UserId1 FROM @V_tabledeleted t)  
  
   -----------  

   DELETE FROM ZnodePublishedPortalXml  
   WHERE EXISTS(SELECT *  FROM ZnodePublishPortalLog  
      WHERE EXISTS ( SELECT TOP 1 1  
         FROM @V_tabledeleted AS TBDL  
         WHERE TBDL.UserId1 = ZnodePublishPortalLog.UserId  
      AND ZnodePublishedPortalXml.PublishPortalLogId = ZnodePublishPortalLog.PublishPortalLogId));  
  
   DELETE FROM ZnodePublishPortalLog  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodePublishPortalLog.UserId        
           );   

   DELETE FROM ZnodeUserGlobalAttributeValueLocale  
   WHERE EXISTS(SELECT *  FROM ZnodeUserGlobalAttributeValue  
      WHERE EXISTS ( SELECT TOP 1 1  
         FROM @V_tabledeleted AS TBDL  
         WHERE TBDL.UserId1 = ZnodeUserGlobalAttributeValue.UserId  
      AND ZnodeUserGlobalAttributeValueLocale.UserGlobalAttributeValueId = ZnodeUserGlobalAttributeValue.UserGlobalAttributeValueId));   
   DELETE FROM ZnodeUserGlobalAttributeValue  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeUserGlobalAttributeValue.UserId        
           );   

   DELETE FROM ZnodeOMSQuoteApproval  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeOMSQuoteApproval.UserId        
           );   

   DELETE FROM AspNetUserLogins  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = AspNetUserLogins.UserId        
           );   
  
   DELETE FROM ZnodePasswordLog  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.aspNetUserId = ZnodePasswordLog.UserId        
           );   
   
   DELETE FROM ZnodeSavedReportViews  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeSavedReportViews.UserId        
           );   
 
   DELETE FROM ZnodeSearchActivity  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeSearchActivity.UserId        
           );   
  
   DELETE FROM ZnodeOmsCustomerShipping  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeOmsCustomerShipping.UserId        
           );   

   DELETE FROM ZnodeOMSQuoteApproval  
   WHERE EXISTS ( SELECT TOP 1 1  
          FROM @V_tabledeleted AS TBDL  
          WHERE TBDL.UserId1 = ZnodeOMSQuoteApproval.ApproverUserId        
           );   
     
	DELETE FROM ZnodeTradeCentricUser  
	WHERE EXISTS ( SELECT TOP 1 1
          FROM @V_tabledeleted AS TBDL
          WHERE TBDL.UserId1 = ZnodeTradeCentricUser.UserId
           );
   ------------  
     
  
   DELETE FROM ZnodeUser  
             OUTPUT deleted.UserId  
                    INTO @V_table  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.UserId1 = ZnodeUser.UserId  
                          );  
 
             DELETE FROM AspNetUsers  
             OUTPUT deleted.UserName  
                    INTO @TBL_DeleteduserName  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @V_tabledeleted AS a  
                            WHERE a.AspnetUserid = AspNetUsers.Id  
                          );  
  
             DELETE FROM AspNetZnodeUser  
             WHERE EXISTS ( SELECT TOP 1 1  
                            FROM @TBL_DeleteduserName AS TBUN  
                            WHERE TBUN.id = AspNetZnodeUser.AspNetZnodeUserId  
                          );  
      
     
     IF  @IsCallInternal = 0    
     BEGIN   
             IF ( SELECT COUNT(1)  
                  FROM @V_tabledeleted  
                ) = ( SELECT COUNT(1)  
                      FROM dbo.split ( @UserId , ','  
                                     )  
                    ) OR @UserId IS NULL   
                 BEGIN  
                     SELECT 0 AS ID , CAST(1 AS BIT) AS Status;  
                 END;  
             ELSE  
                 BEGIN  
                     SELECT 0 AS ID , CAST(0 AS BIT) AS Status;  
                 END;  
         END   
             SET @Status = 1;  
             COMMIT TRAN A;  
         END TRY  
         BEGIN CATCH  
   SELECT ERROR_MESSAGE()  
              DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteUserDetails @UserId = '+@UserId+',@Status='+CAST(@Status AS VARCHAR(200));  
             SET @Status = 0;  
             SELECT 0 AS ID,  
                    CAST(0 AS BIT) AS Status;  
    ROLLBACK TRAN A;  
             EXEC Znode_InsertProcedureErrorLog  
                  @ProcedureName = 'Znode_DeleteUserDetails',  
                  @ErrorInProcedure = @Error_procedure,  
                  @ErrorMessage = @ErrorMessage,  
                  @ErrorLine = @ErrorLine,  
                  @ErrorCall = @ErrorCall;  
         END CATCH;  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ExportFormSubmissions')
	DROP PROC Znode_ExportFormSubmissions
GO

CREATE PROCEDURE [dbo].[Znode_ExportFormSubmissions] 
(
    @WhereClause NVARCHAR(MAX),
	@FileType NVARCHAR(20),
	@Status	BIT = 0 OUT
)
/*
	Summary: 
		This Procedure is used to export FormSubmissions data based on input values.

	Unit Testing :
		EXEC Znode_ExportFormSubmissions @WhereClause='',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'formcode like ''%BottleSuggestionForm%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'storename like ''%QA Znode Bottles%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'username like ''%shubham.yende@yopmail.com%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'fullname like ''%Tapesh D%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'CreatedDate between ''05/19/2022 12:00:00 am'' and ''05/19/2022 11:59:59 pm''',@FileType=N'CSV',@Status=1

*/
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @ExportProcessLogId INT = 0, @Count INT, @Table NVARCHAR(MAX), @GLobalAttributeCode NVARCHAR(MAX), @SSQLString NVARCHAR(MAX);
		DECLARE @Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		SET @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause);

		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'FormCode','ZFB.FormCode')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'StoreName','ZP.StoreName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'UserName','ZU.UserName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'FullName','ZU.FullName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'CreatedDate','SS.CreatedDate')
			
		INSERT INTO ZnodeExportProcessLog (ExportType,FileType,[Status],ProcessStartedDate,ProcessCompletedDate,TableName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT 'FormSubmissions',@FileType,'Started',GETDATE(),NULL,NULL,3,GETDATE(),3,GETDATE()

		SET @ExportProcessLogId = SCOPE_IDENTITY()

		SET @Table = 'ExportFormSubmissions'+'_'+ CAST(@ExportProcessLogId As VARCHAR(20));

		UPDATE ZnodeExportProcessLog
		SET TableName = @Table
		WHERE ExportProcessLogId = @ExportProcessLogId;

		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
					
		SELECT A.FormBuilderSubmitId,C.AttributeCode,B.AttributeValue 
		INTO #GlobalAttribute
		FROM ZnodeFormBuilderGlobalAttributeValue A WITH (NOLOCK)
		INNER JOIN ZnodeFormBuilderGlobalAttributeValueLocale B WITH (NOLOCK) ON B.FormBuilderGlobalAttributeValueId=A.FormBuilderGlobalAttributeValueId
		INNER JOIN ZnodeGlobalAttribute C WITH (NOLOCK) ON C.GlobalAttributeId=A.GlobalAttributeId;
		
		SELECT @GLobalAttributeCode = STUFF((
		SELECT DISTINCT ',' + AttributeCode
		FROM #GlobalAttribute
		FOR XML PATH('') 
		), 1, 1, '');

		SET @SSQLString ='SELECT * INTO ##GLobalAttributeData
		FROM (
		SELECT FormBuilderSubmitId,AttributeCode, AttributeValue FROM #GlobalAttribute
		)T
		PIVOT(MAX(Attributevalue) FOR AttributeCode IN ('+@GLobalAttributeCode+'))PIV'

		EXEC (@SSQLString);
		
		SET @SSQLString='SELECT ZFB.FormCode,ZP.StoreName,ZU.UserName,ZU.FullName,SS.CreatedDate,V.*
		INTO '+@Table+'
		FROM ZnodeFormBuilderSubmit ss WITH (NOLOCK) 
		INNER JOIN ZnodeFormBuilder ZFB WITH (NOLOCK) on SS.FormBuilderId=ZFB.FormBuilderId
		INNER JOIN ZnodePortal ZP WITH (NOLOCK) ON ZP.PortalId=SS.PortalId 
		LEFT JOIN View_CustomerUserDetail ZU WITH (NOLOCK) ON ZU.UserId=SS.UserId												
		INNER JOIN ##GLobalAttributeData V ON (V.FormBuilderSubmitId=SS.FormBuilderSubmitId)
		WHERE 1=1 '+ @Fn_GetFilterWhereClause+'
		'		
		EXEC (@SSQLString);
		
		SET @Count = @@ROWCOUNT;
				
		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
				
		UPDATE ZnodeExportProcessLog 
		SET [Status]= 'In Progress',
			ProcessCompletedDate = GETDATE()
		WHERE ExportProcessLogId =@ExportProcessLogId;

		SELECT TableName
		FROM ZnodeExportProcessLog
		WHERE ExportProcessLogId = @ExportProcessLogId;

		SELECT @Count As [Count];

		SET @Status = 1;
	END TRY
 
	BEGIN CATCH
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'Znode_ExportFormSubmissions 
					@WhereClause = '+CAST(@WhereClause AS NVARCHAR(MAX))+',
					@FileType='+CAST(@FileType AS VARCHAR(20))+',
					@Status='+CAST(@Status AS VARCHAR(10));
		
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ExportFormSubmissions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO
--dt\12\09\2022 ZPD-19702
Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Import','GetPromotionTypeList',0,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeActions where ControllerName = 'Import' and ActionName = 'GetPromotionTypeList')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Import' AND ControllerName = 'Import')
   ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Import' and ActionName= 'GetPromotionTypeList') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
    (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Import' AND ControllerName = 'Import') and ActionId =
    (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Import' and ActionName= 'GetPromotionTypeList'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Import' AND ControllerName = 'Import'),
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Import' and ActionName= 'GetPromotionTypeList')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Import' AND ControllerName = 'Import') and ActionId =
(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Import' and ActionName= 'GetPromotionTypeList'))

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeCatalogIndex_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeCatalogIndex'))
BEGIN
	ALTER TABLE [dbo].[ZnodeCatalogIndex] DROP CONSTRAINT [FK_ZnodeCatalogIndex_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodePortalSearchProfile_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePortalSearchProfile'))
BEGIN
	ALTER TABLE [dbo].[ZnodePortalSearchProfile] DROP CONSTRAINT [FK_ZnodePortalSearchProfile_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodePromotionCatalog_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePromotionCatalogs'))
BEGIN
	ALTER TABLE [dbo].[ZnodePromotionCatalogs] DROP CONSTRAINT [FK_ZnodePromotionCatalog_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodePromotionCategory_ZnodePublishCategory')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePromotionCategory'))
BEGIN
	ALTER TABLE [dbo].[ZnodePromotionCategory] DROP CONSTRAINT [FK_ZnodePromotionCategory_ZnodePublishCategory]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodePromotionProduct_ZnodePublishProduct')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePromotionProduct'))
BEGIN
	ALTER TABLE [dbo].[ZnodePromotionProduct] DROP CONSTRAINT [FK_ZnodePromotionProduct_ZnodePublishProduct]
END

GO

IF NOT EXISTS (SELECT *  FROM sys.default_constraints WHERE object_id = OBJECT_ID(N'DF_ZnodePublishConfigurableProductEntity_IsDefault')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePublishConfigurableProductEntity'))
BEGIN
	ALTER TABLE ZnodePublishConfigurableProductEntity ADD CONSTRAINT DF_ZnodePublishConfigurableProductEntity_IsDefault DEFAULT (0) FOR IsDefault;
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishConfigurableProductEntity' AND COLUMN_NAME = 'ElasticSearchEvent')
BEGIN
    ALTER TABLE ZnodePublishConfigurableProductEntity ALTER COLUMN ElasticSearchEvent INT NULL;
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchDocumentMapping_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchDocumentMapping'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchDocumentMapping] DROP CONSTRAINT [FK_ZnodeSearchDocumentMapping_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchGlobalProductBoost_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchGlobalProductBoost'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchGlobalProductBoost] DROP CONSTRAINT [FK_ZnodeSearchGlobalProductBoost_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchGlobalProductBoost_ZnodePublishProduct')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchGlobalProductBoost'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchGlobalProductBoost] DROP CONSTRAINT [FK_ZnodeSearchGlobalProductBoost_ZnodePublishProduct]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchGlobalProductCategoryBoost_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchGlobalProductCategoryBoost'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchGlobalProductCategoryBoost] DROP CONSTRAINT [FK_ZnodeSearchGlobalProductCategoryBoost_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchGlobalProductCategoryBoost_ZnodePublishCategory')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchGlobalProductCategoryBoost'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchGlobalProductCategoryBoost] DROP CONSTRAINT [FK_ZnodeSearchGlobalProductCategoryBoost_ZnodePublishCategory]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchGlobalProductCategoryBoost_ZnodePublishProduct')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchGlobalProductCategoryBoost'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchGlobalProductCategoryBoost] DROP CONSTRAINT [FK_ZnodeSearchGlobalProductCategoryBoost_ZnodePublishProduct]
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchKeywordsRedirect_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchKeywordsRedirect'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchKeywordsRedirect] DROP CONSTRAINT [FK_ZnodeSearchKeywordsRedirect_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodeSearchSynonyms' AND COLUMN_NAME = 'SynonymCode')
BEGIN
    ALTER TABLE ZnodeSearchSynonyms ALTER COLUMN SynonymCode NVARCHAR (100) NOT NULL;
END

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodeSearchSynonyms_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodeSearchSynonyms'))
BEGIN
	ALTER TABLE [dbo].[ZnodeSearchSynonyms] DROP CONSTRAINT [FK_ZnodeSearchSynonyms_ZnodePublishCatalog]
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO

CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() 
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,IsAddon bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	

	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-'+CAST(@Getdate as varchar(200))+'Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'Preview'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'Production'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	


	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId, a.RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionType FROM @Tbl_versions)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 IsAddon
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 IsAddon
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault, 1 IsAddon
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault, 0 IsAddon
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



DROP TABLE IF EXISTS #PimProduct_distinct



SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)




UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p
OUTPUT deleted.ZnodeProductId INTO @Deleted_Products
FROM ZnodePublishProductEntity p  WHERE PublishProductEntityId IN   (SELECT PublishProductEntityId FROM #PublishProductEntityId) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )
WHERE @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT , DisplayOrder INT , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  


UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = b.DisplayOrder , IsActive = b.IsActive, ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
INNER JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(200),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(2000),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1

FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND  @PimProductId = 0  

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT r.PimProductId , MAX(Quantity) Quantity
INTO #ZnodeInventory
FROM ZnodeInventory a with (nolock)
INNER JOIN  #PimProduct_distinct r ON ( r.SKU = a.SKU )
GROUP BY PimProductId


--SELECT * FROM @Versions_working

SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(200),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU)
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
SELECT q.VersionId,a.PimProductId, @PimCatalogId, b.PimProductId , b.DisplayOrder,'', ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n WHERE n.PimAttributeId = a.PimAttributeId ),'[]'), IsDefault,1
FROM ZnodePimConfigureProductAttribute a 
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = q.VersionId AND a.PimProductId = t.ZnodeProductId )

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, a.PimProductId, a.DisplayOrder, b.Quantity ,1 
FROM @PimProduct_catalog a 
LEFT JOIN #ZnodeInventory b ON (b.PimProductId = a.PimProductId )
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Bundle Product')



INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT q.VersionId, ParentPimProductId,@PimCatalogId, PimProductId, a.DisplayOrder ,1 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Grouped Product')

INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)

SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,LocaleId,'','' DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.IsAddon = 1 
	
	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId = 3
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 

	IF @PimProductId = 0 
	BEGIN 
	SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	--SELECT * FROM #PimProduct_distinct
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleProductEntity')
	DROP PROC Znode_PublishSingleProductEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleProductEntity]
(
    @PimProductId TransferId READONLY
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAutoPublish bit = 0 
   ,@ImportGUID Varchar(500) = '' 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	DECLARE @PimProductIdIn INT , @PimCatalogId INT 

	DECLARE @PimCatalogProduct TABLE (PimProductId INT , IsDeleted BIT,  ZnodecatalogId INT  , VersionId INT )

	

	IF EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	)
	BEGIN 



	DECLARE Cur_CatalogProduct CURSOR FOR 
	SELECT DISTINCT PimProductId, b.PimCatalogId
	FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	OPEN Cur_CatalogProduct 

	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId

	WHILE @@FETCH_STATUS=0 
	BEGIN 

	INSERT INTO @PimCatalogProduct 
	EXEC Znode_PublishCatalogEntity @PimCatalogId= @PimCatalogId
									,@RevisionState =@RevisionType
									,@UserId =@UserId
									,@NewGUID = @ImportGUID
									,@IsDraftProductsOnly = 0 
									,@PimProductId =@PimProductIdIn
									,@PimCategoryHierarchyId = 0 



	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId
	END 
	CLOSE Cur_CatalogProduct
	DEALLOCATE Cur_CatalogProduct 

	   	  
	SET @Status =1 

	END 
	ELSE 
	BEGIN 


	SET @Status = 0 
	END 


	SELECT * 
	FROM ZnodePublishProductEntity a with (nolock)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimCatalogProduct r WHERE r.VersionId = a.VersionId AND r.PimProductId = a.ZnodeProductId AND r.IsDeleted = 0)

	SELECT PimProductId ZnodeProductId , IsDeleted ,  ZnodecatalogId   , VersionId 
	FROM @PimCatalogProduct 
	WHERE IsDeleted =1 


	SELECT 0 AS id,@Status AS Status;   

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleProductEntity
		@PimProductIds = '',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleProductErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleProductEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleProductEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ExportFormSubmissions')
	DROP PROC Znode_ExportFormSubmissions
GO

CREATE PROCEDURE [dbo].[Znode_ExportFormSubmissions] 
(
    @WhereClause NVARCHAR(MAX),
	@FileType NVARCHAR(20),
	@Status	BIT = 0 OUT
)
/*
	Summary: 
		This Procedure is used to export FormSubmissions data based on input values.

	Unit Testing :
		EXEC Znode_ExportFormSubmissions @WhereClause='',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'formcode like ''%BottleSuggestionForm%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'storename like ''%QA Znode Bottles%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'username like ''%shubham.yende@yopmail.com%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'fullname like ''%Tapesh D%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'CreatedDate between ''05/19/2022 12:00:00 am'' and ''05/19/2022 11:59:59 pm''',@FileType=N'CSV',@Status=1

*/
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @ExportProcessLogId INT = 0, @Count INT, @Table NVARCHAR(MAX), @GLobalAttributeCode NVARCHAR(MAX), @SSQLString NVARCHAR(MAX);
		DECLARE @Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		SET @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause);

		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'FormCode','ZFB.FormCode')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'StoreName','ZP.StoreName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'UserName','ZU.UserName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'FullName','ZU.FullName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'CreatedDate','SS.CreatedDate')
			
		INSERT INTO ZnodeExportProcessLog (ExportType,FileType,[Status],ProcessStartedDate,ProcessCompletedDate,TableName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT 'FormSubmissions',@FileType,'Started',GETDATE(),NULL,NULL,3,GETDATE(),3,GETDATE()

		SET @ExportProcessLogId = SCOPE_IDENTITY()

		SET @Table = 'ExportFormSubmissions'+'_'+ CAST(@ExportProcessLogId As VARCHAR(20));

		UPDATE ZnodeExportProcessLog
		SET TableName = @Table
		WHERE ExportProcessLogId = @ExportProcessLogId;

		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
					
		SELECT A.FormBuilderSubmitId,C.AttributeCode
			,CASE WHEN B.MediaPath IS NOT NULL THEN RIGHT(B.MediaPath,LEN(B.MediaPath)-(CHARINDEX('--',B.MediaPath,1)+1)) ELSE B.AttributeValue END As AttributeValue
			, B.GlobalAttributeDefaultValueId, B.LocaleId
		INTO #GlobalAttribute
		FROM ZnodeFormBuilderGlobalAttributeValue A WITH (NOLOCK)
		INNER JOIN ZnodeFormBuilderGlobalAttributeValueLocale B WITH (NOLOCK) ON B.FormBuilderGlobalAttributeValueId=A.FormBuilderGlobalAttributeValueId
		INNER JOIN ZnodeGlobalAttribute C WITH (NOLOCK) ON C.GlobalAttributeId=A.GlobalAttributeId;

		UPDATE aa
		SET AttributeValue=CASE WHEN aa.AttributeValue IS NULL THEN RIGHT(h.AttributeDefaultValueCode,LEN(h.AttributeDefaultValueCode)-(CHARINDEX('--',h.AttributeDefaultValueCode,1)+1)) ELSE aa.AttributeValue END
		FROM #GlobalAttribute aa
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId
		WHERE ISNULL(aa.AttributeValue,'')='';

		UPDATE h
		SET h.AttributeValue=RIGHT(g.AttributeDefaultValue,LEN(g.AttributeDefaultValue)-(CHARINDEX('--',g.AttributeDefaultValue,1)+1))
		FROM #GlobalAttribute h
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId
        WHERE ISNULL(h.AttributeValue,'')='' AND g.LocaleId=h.LocaleId;

		ALTER TABLE #GlobalAttribute DROP COLUMN IF EXISTS GlobalAttributeDefaultValueId;
		ALTER TABLE #GlobalAttribute DROP COLUMN IF EXISTS LocaleId;
		
		SELECT @GLobalAttributeCode = STUFF((
		SELECT DISTINCT ',' + AttributeCode
		FROM #GlobalAttribute
		FOR XML PATH('') 
		), 1, 1, '');

		SET @SSQLString ='SELECT * INTO ##GLobalAttributeData
		FROM (
		SELECT FormBuilderSubmitId,AttributeCode, AttributeValue FROM #GlobalAttribute
		)T
		PIVOT(MAX(Attributevalue) FOR AttributeCode IN ('+@GLobalAttributeCode+'))PIV'

		EXEC (@SSQLString);
		
		SET @SSQLString='SELECT ZFB.FormCode,ZP.StoreName,ZU.UserName,ZU.FullName,SS.CreatedDate,V.*
		INTO '+@Table+'
		FROM ZnodeFormBuilderSubmit ss WITH (NOLOCK) 
		INNER JOIN ZnodeFormBuilder ZFB WITH (NOLOCK) on SS.FormBuilderId=ZFB.FormBuilderId
		INNER JOIN ZnodePortal ZP WITH (NOLOCK) ON ZP.PortalId=SS.PortalId 
		LEFT JOIN View_CustomerUserDetail ZU WITH (NOLOCK) ON ZU.UserId=SS.UserId												
		INNER JOIN ##GLobalAttributeData V ON (V.FormBuilderSubmitId=SS.FormBuilderSubmitId)
		WHERE 1=1 '+ @Fn_GetFilterWhereClause+'
		'		
		EXEC (@SSQLString);
		
		SET @Count = @@ROWCOUNT;
				
		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
				
		UPDATE ZnodeExportProcessLog 
		SET [Status]= 'In Progress',
			ProcessCompletedDate = GETDATE()
		WHERE ExportProcessLogId =@ExportProcessLogId;

		SELECT TableName
		FROM ZnodeExportProcessLog
		WHERE ExportProcessLogId = @ExportProcessLogId;

		SELECT @Count As [Count];

		SET @Status = 1;
	END TRY
 
	BEGIN CATCH
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'Znode_ExportFormSubmissions 
					@WhereClause = '+CAST(@WhereClause AS NVARCHAR(MAX))+',
					@FileType='+CAST(@FileType AS VARCHAR(20))+',
					@Status='+CAST(@Status AS VARCHAR(10));
		
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ExportFormSubmissions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Export','List',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Export' and ActionName = 'List')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Export' AND ControllerName = 'Export')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Export' and ActionName = 'List') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Export' AND ControllerName = 'Export') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Export' and ActionName = 'List'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Export' AND ControllerName = 'Export'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Export' and ActionName = 'List')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Export' AND ControllerName = 'Export') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Export' and ActionName = 'List'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,IsAddon bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 


	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	

	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-'+CAST(@Getdate as varchar(200))+'Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'Preview'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'Production'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	


	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId, a.RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionType FROM @Tbl_versions)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 IsAddon
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 IsAddon
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault, 1 IsAddon
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault, 0 IsAddon
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



DROP TABLE IF EXISTS #PimProduct_distinct



SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)




UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p
OUTPUT deleted.ZnodeProductId INTO @Deleted_Products
FROM ZnodePublishProductEntity p  WHERE PublishProductEntityId IN   (SELECT PublishProductEntityId FROM #PublishProductEntityId) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )
WHERE @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT , DisplayOrder INT , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  


UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = b.DisplayOrder , IsActive = b.IsActive, ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
INNER JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(200),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(2000),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1

FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND  @PimProductId = 0  

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT r.PimProductId , MAX(Quantity) Quantity
INTO #ZnodeInventory
FROM ZnodeInventory a with (nolock)
INNER JOIN  #PimProduct_distinct r ON ( r.SKU = a.SKU )
GROUP BY PimProductId


--SELECT * FROM @Versions_working

SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(200),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU)
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n WHERE n.PimAttributeId = a.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a 
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = q.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = b.PimProductId )

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, b.Quantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
LEFT JOIN #ZnodeInventory b ON (b.PimProductId = a.PimProductId )
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Bundle Product')


DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, Quantity , ElasticSearchEvent
FROM #temp_bundleProduct

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Grouped Product')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct


INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)

SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,LocaleId,'','' DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.IsAddon = 1 
	
	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId = 3
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 

	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleProductEntity')
	DROP PROC Znode_PublishSingleProductEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleProductEntity]
(
    @PimProductId TransferId READONLY
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAutoPublish bit = 0 
   ,@ImportGUID Varchar(500) = '' 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	DECLARE @PimProductIdIn INT , @PimCatalogId INT 

	SET @ImportGUID = CASE WHEN @ImportGUID = '' THEN CAST( NEWID() AS VARCHAR(200)) ELSE @ImportGUID END 

	DECLARE @PimCatalogProduct TABLE (PimProductId INT , IsDeleted BIT,  ZnodecatalogId INT  , VersionId INT )
	IF EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	)
	BEGIN 



	DECLARE Cur_CatalogProduct CURSOR FOR 
	SELECT DISTINCT PimProductId, b.PimCatalogId
	FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	OPEN Cur_CatalogProduct 

	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId

	WHILE @@FETCH_STATUS=0 
	BEGIN 

	INSERT INTO @PimCatalogProduct 
	EXEC Znode_PublishCatalogEntity @PimCatalogId= @PimCatalogId
									,@RevisionState =@RevisionType
									,@UserId =@UserId
									,@NewGUID = @ImportGUID
									,@IsDraftProductsOnly = 0 
									,@PimProductId =@PimProductIdIn
									,@PimCategoryHierarchyId = 0 



	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId
	END 
	CLOSE Cur_CatalogProduct
	DEALLOCATE Cur_CatalogProduct 

	   	  
	SET @Status =1 

	END 
	ELSE 
	BEGIN 


	SET @Status = 0 
	END 


	SELECT * 
	FROM ZnodePublishProductEntity a with (nolock)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimCatalogProduct r WHERE r.VersionId = a.VersionId AND r.PimProductId = a.ZnodeProductId AND r.IsDeleted = 0)

	SELECT PimProductId ZnodeProductId , IsDeleted ,  ZnodecatalogId   , VersionId 
	FROM @PimCatalogProduct 
	WHERE IsDeleted =1 


	UPDATE ZnodePublishProgressNotifierEntity 
	SET IsCompleted = 1 ,ProgressMark = 100 
	WHERE JobId = @ImportGUID

	SELECT 0 AS id,@Status AS Status;   

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleProductEntity
		@PimProductIds = '',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleProductErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleProductEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleProductEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson
GO

CREATE    PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
DECLARE @pimProductId_loop TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId 
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,b.IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID

WHILE EXISTS (SELECT TOP 1 1 FROM #pimProductIds ) 
BEGIN 
DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

INSERT INTO @pimProductId_loop
SELECT TOP 2000 PimProductId 
FROM #pimProductIds 

SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  @pimProductId_loop t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId


create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @pimProductId_loop n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)


IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct )
BEGIN 
   

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   
   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValue 
   SELECT PimProductId, PimAttributeId , AttributeValue, CustomCode ,  IsDefaultValue , m.LocaleId
   FROM #tbl_AttributeValue a 
   CROSS APPLY @LocaleIds_distinct m

   UPDATE a
   SET a.AttributeValue = aa.AttributeValue
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE a.LocaleId <> @DefaultLocaleId


   UPDATE a
   SET a.AttributeValue = aa.AttributeValue
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE a.LocaleId <> @DefaultLocaleId
 
   INSERT INTO #default_value 
   SELECT PimProductId ,PimAttributeId,  Code , m.LocaleId	, Value,DisplayOrder,IsEditable,SwatchText,Path,PimAttributeDefaultValueId
   FROM #default_value a 
   CROSS APPLY @LocaleIds_distinct m

   UPDATE a
   SET Value = bc.AttributeDefaultValue
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId
   



END 


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID




UPDATE ZnodePublishProductEntity
SET Attributes = 
 (

SELECT IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '',0 , 1 )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(a.AttributeValue,'') AttributeValues
				,ISNULL((
				   SELECT Code,LocaleId,Value,DisplayOrder,IsEditable,SwatchText,Path
				   FROM #default_value nt 
				   WHERE nt.PimProductId = a.PimProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId = ZnodePublishProductEntity.LocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = ZnodePublishProductEntity.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =ZnodePublishProductEntity.LocaleId)
WHERE a.PimProductId = ZnodePublishProductEntity.ZnodeProductId AND a.LocaleId = ZnodePublishProductEntity.LocaleId
ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
) 
WHERE PublishProductEntityId  IN (SELECT PublishProductEntityId FROM #PublishProductEntityId)


UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValue ty ON ( ty.PimProductId = a.ZnodeProductId  )
WHERE PublishProductEntityId  IN (SELECT PublishProductEntityId FROM #PublishProductEntityId)
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct t WHERE t.LocaleId = a.LocaleId AND ty.LocaleId = t.LocaleId )
AND ty.PimAttributeId IN (SELECT w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')
	
	DELETE FROM #pimProductIds WHERE PimProductId IN (SELECT PImProductId FROM @pimProductId_loop)
	DELETE FROM @pimProductId_loop
END 

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAddonAssociation')
	DROP PROC Znode_ImportAddonAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportAddonAssociation](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

		IF OBJECT_ID('TEMPDB..#InsertProductAddonAssociation') IS NOT NULL
			DROP TABLE #InsertProductAddonAssociation

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertZnodePimAddOnProduct') IS NOT NULL
			DROP TABLE #InsertZnodePimAddOnProduct

		CREATE TABLE #InsertZnodePimAddOnProduct ( PimAddOnProductId int,PimAddonGroupId int,PimProductId int)

		CREATE TABLE #InsertProductAddonAssociation
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300),AddonGroupName varchar(300),AddOnSKU varchar(300),DisplayOrder int, IsDefault varchar(10), GUID nvarchar(400)
		
		);

		CREATE TABLE #SKU 
		( 
			SKU nvarchar(300), PimProductId int
		);

		----Get All SKU Data From DB
		INSERT INTO #SKU (SKU, PimProductId)
		SELECT ZPAVL.AttributeValue, ZPAV.PimProductId
		FROM ZnodePimAttributeValue AS ZPAV
		INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		WHERE ZPA.AttributeCode = 'SKU';

		SET @SSQL = 'Select RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID FROM '+@TableName;
		INSERT INTO #InsertProductAddonAssociation( RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID )
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE #InsertProductAddonAssociation 
		SET DisplayOrder=1
		WHERE DisplayOrder='' OR DisplayOrder=0

		SELECT SKU,AddonGroupName,AddOnSKU 
		INTO #DuplicateProductAddonAssociation 
		FROM #InsertProductAddonAssociation 
		Group BY SKU,AddonGroupName,AddOnSKU  having count(*) > 1

		----Checking AddonGroupName present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '99', 'AddonGroupName', AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS ( SELECT * FROM ZnodePimAddonGroupLocale i where i.AddonGroupName = ii.AddonGroupName );

		----Checking SKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.SKU = SKU.SKU)

		----Checking AddOnSKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'AddOnSKU', AddOnSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.AddOnSKU = SKU.SKU)
		
		----Duplicate Record (SKU \ AddOnSKU \ AddonGroupName)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '53', 'SKU \ AddOnSKU \ AddonGroupName ', SKU+' \ '+AddOnSKU+' \ '+AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE EXISTS ( select * FROM #DuplicateProductAddonAssociation i WHERE i.SKU = ii.SKU and i.AddOnSKU = ii.AddOnSKU and i.AddonGroupName = ii.AddonGroupName );

		----Checking is default value data validation
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertProductAddonAssociation AS ii  
		WHERE ISNULL(ii.IsDefault,0) not in ('True','1','Yes','FALSE','0','No','')
		
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--	FROM #InsertProductAddonAssociation AS ii
		--	WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAddonAssociation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertProductAddonAssociation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProductAddonAssociation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))  
		WHERE ImportProcessLogId = @ImportProcessLogId;


		UPDATE PAPD
		SET PAPD.ModifiedBy =@UserId  ,PAPD.ModifiedDate = GETDATE(),
		PAPD.IsDefault = case when IPAA.IsDefault in ('True','1','Yes') then 1 else 0 end,
		PAPD.DisplayOrder = CASE WHEN IPAA.DisplayOrder IS NOT NULL THEN IPAA.DisplayOrder ELSE PAPD.DisplayOrder END
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct PAP ON (PAP.PimProductId = SKU.PimProductId AND PAP.PimAddonGroupId = ZPAGL.PimAddonGroupId)
		INNER JOIN ZnodePimAddOnProductDetail PAPD ON (PAPD.PimAddOnProductId =PAP.PimAddOnProductId AND SKU1.PimProductId = PAPD.PimChildProductId )

		-----Inserting records in ZnodePimAddOnProduct
		INSERT INTO ZnodePimAddOnProduct(PimAddonGroupId,PimProductId,DisplayOrder,RequiredType,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT inserted.PimAddOnProductId, inserted.PimAddonGroupId,inserted.PimProductId into #InsertZnodePimAddOnProduct (PimAddOnProductId,PimAddonGroupId,PimProductId)
		SELECT DISTINCT ZPAGL.PimAddonGroupId,SKU.PimProductId, 999 as DisplayOrder,
		'Required' RequiredType,@UserId as CreatedBy,@GetDate,@UserId as ModifiedBy,@GetDate
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProduct ZPAP where ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId and ZPAP.PimProductId = SKU.PimProductId )

		-----Inserting records in ZnodePimAddOnProductDetail
		INSERT INTO ZnodePimAddOnProductDetail(PimAddOnProductId,PimChildProductId,IsDefault,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT ZPAP.PimAddOnProductId, SKU.PimProductId as PimChildProductId, CASE WHEN isnull(IPAA.IsDefault,0) IN ('True','1','Yes') THEN 1 ELSE 0 END, ISNULL(IPAA.DisplayOrder,999),@UserId ,@GetDate,@UserId,@GetDate 
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.SKU
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on IPAA.AddonGroupName = ZPAGL.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct ZPAP on SKU1.PimProductId = ZPAP.PimProductId and ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProductDetail ZPAPD WHERE ZPAPD.PimAddOnProductId = ZPAP.PimAddOnProductId and ZPAPD.PimChildProductId = SKU.PimProductId )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;

	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAddonAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAddonAssociation',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE @InsertPimAtrribute
		SET DisplayOrder=1
		WHERE DisplayOrder='' OR DisplayOrder=0

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '117', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%' OR ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %'

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--	FROM @InsertPimAtrribute AS ii
		--	WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportHighlight')
	DROP PROC Znode_ImportHighlight
GO

CREATE PROCEDURE [dbo].[Znode_ImportHighlight](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			RowNumber int, HighlightCode varchar(300), HighlightName varchar(1000),DisplayPopup varchar(300),Hyperlink varchar(1000),HighlightType varchar(300),IsActive varchar(100),DisplayOrder int,HighlightImage varchar(500),HighlightImagePath varchar(500), Description varchar(max), ShortDescription varchar(max), ImageAltTag varchar(400), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE @InsertPimAtrribute
		SET DisplayOrder=1
		WHERE DisplayOrder='' OR DisplayOrder=0


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @HighlightAttributeDefaultCode TABLE
		( 
		   AttributeDefaultCode nvarchar(300)
		);
		INSERT INTO @HighlightAttributeDefaultCode
			   SELECT AttributeDefaultValueCode
			   FROM ZnodePimAttributeDefaultValue ZPADV
			   inner join ZnodePimAttribute ZPA on ZPADV.PimAttributeId = ZPA.PimAttributeId
			   where ZPA.AttributeCode = 'Highlights' 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '118', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode not in 
			   (
				   SELECT AttributeDefaultCode FROM @HighlightAttributeDefaultCode 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'DisplayPopup', DisplayPopup, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.DisplayPopup not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'HighlightType', HighlightType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightType NOT in 
			   (
				   SELECT HT.Name  FROM ZnodeHighlightType  HT
			   );

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--	FROM @InsertPimAtrribute AS ii
		--	WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.HighlightCode,''))) like '% %' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode in 
			   (
				   select HighlightCode  FROM @InsertPimAtrribute  Group BY HighlightCode  having count(*) > 1 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Highlight - ' + ISNULL(HighlightCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName and IPA.HighlightImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName)

		DECLARE @InsertedZnodeHighlight TABLE(HighlightId INT,HighlightCode VARCHAR(600)) 

			UPDATE ZH SET ZH.DisplayPopup = IPA.DisplayPopup, ZH.Hyperlink = IPA.Hyperlink, ZH.IsActive = case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end,
			       ZH.DisplayOrder = IPA.DisplayOrder , ZH.ModifiedBy = @UserId, ZH.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId

			UPDATE ZHL SET ZHL.Name = IPA.HighlightName, ZHL.Description = IPA.Description, ZHL.ShortDescription = IPA.ShortDescription, ZHL.ImageAltTag = IPA.ImageAltTag
			       , ZHL.ModifiedBy = @UserId, ZHL.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId
			INNER JOIN ZnodeHighlightLocale ZHL  ON ZH.HighlightId = ZHL.HighlightId 

			INSERT INTO ZnodeHighlight (MediaId,HighlightCode,DisplayPopup,Hyperlink,HighlightTypeId,IsActive,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			OUTPUT Inserted.HighlightId,Inserted.HighlightCode INTO @InsertedZnodeHighlight
			SELECT DISTINCT @MediaId,IPA.HighlightCode, IPA.DisplayPopup , IPA.Hyperlink, ZHT.HighlightTypeId,
				   case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end, Case when Isnull(IPA.DisplayOrder,0) = 0 then  999 else IPA.DisplayOrder end  , @UserId , @GetDate ,@UserId , @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			WHERE NOT EXISTS(select * from ZnodeHighlight ZH where ZH.HighlightCode = IPA.HighlightCode and ZH.HighlightTypeId = ZHT.HighlightTypeId)

			INSERT INTO ZnodeHighlightLocale(LocaleId,HighlightId,ImageAltTag,Name,Description,ShortDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT @LocaleId, IZH.HighlightId, IPA.ImageAltTag, IPA.HighlightName, IPA.Description, IPA.ShortDescription, @UserId , @GetDate ,@UserId , @GetDate
			FROM @InsertPimAtrribute IPA 
			INNER JOIN @InsertedZnodeHighlight IZH on IPA.HighlightCode = IZH.HighlightCode 


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportHighlight @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportHighlight',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,IsAddon bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 


	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	

	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-'+CAST(@Getdate as varchar(200))+'Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'Preview'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'Production'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	


	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId, a.RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionType FROM @Tbl_versions)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 IsAddon
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 IsAddon
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault, 1 IsAddon
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault, 0 IsAddon
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



DROP TABLE IF EXISTS #PimProduct_distinct



SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)




UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p
OUTPUT deleted.ZnodeProductId INTO @Deleted_Products
FROM ZnodePublishProductEntity p  WHERE PublishProductEntityId IN   (SELECT PublishProductEntityId FROM #PublishProductEntityId) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )
WHERE @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT , DisplayOrder INT , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  


UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = b.DisplayOrder , IsActive = b.IsActive, ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
INNER JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(200),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(2000),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1

FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND  @PimProductId = 0  

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode AND n.PortalId = a.PortalId)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT r.PimProductId , MAX(Quantity) Quantity
INTO #ZnodeInventory
FROM ZnodeInventory a with (nolock)
INNER JOIN  #PimProduct_distinct r ON ( r.SKU = a.SKU )
GROUP BY PimProductId


--SELECT * FROM @Versions_working

SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(200),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU)
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n WHERE n.PimAttributeId = a.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a 
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = q.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = b.PimProductId )

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, b.Quantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
LEFT JOIN #ZnodeInventory b ON (b.PimProductId = a.PimProductId )
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Bundle Product')


DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, Quantity , ElasticSearchEvent
FROM #temp_bundleProduct

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Grouped Product')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct


INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)

SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,LocaleId,'','' DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.IsAddon = 1 
	
	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId = 3
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 

	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportInsertUpdatePimProduct')
	DROP PROC Znode_ImportInsertUpdatePimProduct
GO


CREATE PROCEDURE [dbo].[Znode_ImportInsertUpdatePimProduct]
(
    @PimProductDetail  PIMPRODUCTDETAIL READONLY,
    @UserId            INT       ,
    @status            BIT    OUT,
    @IsNotReturnOutput BIT    = 0,
	@CopyPimProductId  INT	  = 0 )
AS
   /*
     Summary : To Insert / Update single Product with multiple attribute values 
     Update Logic: 
*/
     BEGIN
         BEGIN TRAN A;
         BEGIN TRY
			 DECLARE @PimProductId INT;
			 DECLARE @TBL_PimProductId TABLE(PimAttributeValueId INT,ZnodePimAttributeValueLocaleId INT );
			 DECLARE @TBL_CopyPimProductId TABLE(PimAttributeValueId INT,OldPimAttributeValueId INT);
			 DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId()
			 DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
			 DECLARE @TBL_DefaultAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeId TABLE (PimAttributeId INT PRIMARY KEY, AttributeCode VARCHAR(600))
			 DECLARE @TBL_TextAreaAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))
			 DECLARE @TBL_MediaAttributeValue TABLE (PimAttributeValueId INT ,LocaleId INT ,AttributeValue VARCHAr(300),MediaId INT)
			 DECLARE @TBL_DefaultAttributeValue TABLE (PimAttributeValueId INT , LocaleId INT , AttributeValue INT)
			 DECLARE @ZnodePimAttributeValue TABLE (PimAttributeValueId  INT, PimAttributeFamilyId INT,PimAttributeId INT);

			 DECLARE @AssociatedProduct VARCHAR(4000);
			 DECLARE @ConfigureAttributeId VARCHAR(4000);
			 DECLARE @ConfigureFamilyId VARCHAR(4000);
			 DECLARE @PimAttributeFamilyId INT;
			 DECLARE @LocaleId INT 

			 DECLARE @pimSkuAttributeId VARCHAR(50) = [dbo].[Fn_GetProductSKUAttributeId] ()
			 DECLARE @pimProductNameAttributeId VARCHAR(50) =[dbo].Fn_GetProductNameAttributeId ()
			 DECLARE @PimIsDownlodableAttributeId VARCHAR(50) = [dbo].[Fn_GetIsDownloadableAttributeId]()
			 Declare @SKU nvarchar(300),@ProductName nvarchar(300)
			 Select * into #PimProductDetail from @PimProductDetail
			
			

			--DECLARE @PimAttributeFamily VARCHAR(50) =  [dbo].[Fn_GetAttributeFamilyId]()
			--Update #PimProductDetail SET AttributeValue = 
			--(SELECT FamilyCode from ZnodePimAttributeFamily where PimAttributeFamilyId = @PimAttributeFamilyId)
			--where PimAttributeId = @PimAttributeFamily

			--DECLARE @PimAttributeIsPublish VARCHAR(50) =  [dbo].[Fn_GetAttributeIsPublish]()
			 
			--insert into #PimProductDetail ([PimAttributeId],[PimAttributeFamilyId],[ProductAttributeCode],[ProductAttributeDefaultValueId],
			--[PimAttributeValueId],	[LocaleId],[PimProductId],[AttributeValue],[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]) 
			 
			--SELECT TOP 1 @PimAttributeIsPublish,[PimAttributeFamilyId],'PublishStatus' ProductAttributeCode,NULL ProductAttributeDefaultValueId,
			--NULL PimAttributeValueId,	[LocaleId],[PimProductId],
			--CASE when isnull([PimProductId] ,0) > 1 then 'Draft' else 'Not Publish' END AttributeValue,
			--[AssociatedProducts],[ConfigureAttributeIds],[ConfigureFamilyIds]
			--from @PimProductDetail  


			INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM  [dbo].[Fn_GetDefaultAttributeId] ()
			 
			 INSERT INTO @TBL_MediaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM [dbo].[Fn_GetProductMediaAttributeId]()

			 INSERT INTO @TBL_TextAreaAttributeId (PimAttributeId ,AttributeCode)
			 SELECT PimAttributeId, AttributeCode   FROM [dbo].[Fn_GetTextAreaAttributeId]()

			 
			 SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId
                FROM #PimProductDetail;
             
			 

			 
			 
			 SELECT TOP 1 @LocaleId = LocaleId
                FROM #PimProductDetail;

             -- Retrive input productId from #PimProductDetail table ( having multiple attribute values with common productId) 

             SELECT TOP 1 @PimProductId = PimProductId
             FROM #PimProductDetail;
			
			DECLARE @PublishStateIdForDraft INT =  [dbo].[Fn_GetPublishStateIdForDraftState]()
			  DECLARE @PublishStateIdForNotPublished INT = [dbo].[Fn_GetPublishStateIdForForNotPublishedState]()

			

             IF ISNULL(@PimProductId, 0) = 0
                 BEGIN
                     INSERT INTO ZnodePimProduct
                     (PimAttributeFamilyId,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate ,PublishStateId
                     )
                            SELECT @PimAttributeFamilyId,
                                   @UserId,
                                   @GetDate,
                                   @UserId,
                                   @GetDate,@PublishStateIdForNotPublished ;
                     SET @PimProductId = SCOPE_IDENTITY();
					 UPDATE #PimProductDetail SET PimProductId = @PimProductId
					 If EXISTS (select TOP 1 1 from #PimProductDetail where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						
						Select TOP 1 @SKU  =  AttributeValue from  #PimProductDetail where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  #PimProductDetail where PimAttributeId =  @pimProductNameAttributeId
						insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 
					 End
		

                 END;
             ELSE 
                 BEGIN
                     UPDATE ZNodePimProduct
                       SET
                           PimAttributeFamilyId = @PimAttributeFamilyId,
						   PublishStateId = @PublishStateIdForDraft,
                           ModifiedBy = @UserId,
                           ModifiedDate = @GetDate
                     WHERE PimProductId = @PimProductId;

					Update ZnodePimProduct SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE()  where PimProductId in
					(select PimProductId  From ZnodePimProductTypeAssociation where PimParentProductId=@PimProductId )
            									
					 INSERT INTO @TBL_PimProductId(PimAttributeValueId)
					 SELECT ZPAV.PimAttributeValueId
                     FROM ZnodePimAttributeValue ZPAV
					 INNER JOIN ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId AND ( @localeID = @DefaultLocaleId OR ZPA.IsLocalizable = 1 OR EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetProductMediaAttributeId]() FN WHERE FN.PimAttributeId = ZPAV.PimAttributeId)))
					 INNER JOIN ZnodePimFamilyGroupMapper ZPFGMI  ON (ZPFGMI.PimAttributeId = ZPAV.PimAttributeId AND ZPFGMI.PimAttributeFamilyId = @PimAttributeFamilyId)
					 WHERE ZPAV.PimProductId = @PimProductId
					 AND NOT EXISTS
                            (
                                SELECT TOP 1 1
                                FROM #PimProductDetail TBPDI
                                WHERE TBPDI.PimAttributeId = ZPAV.PimAttributeId
                                      AND TBPDI.PimProductId = ZPAV.PimProductId
							 )
                     
				    --  SELECT * FROM @TBL_PimProductId

			
                     DELETE FROM ZnodePimAttributeValueLocale
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimAttributeValueLocale.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId;
					 DELETE  ZnodePimProductAttributeDefaultValue 
					  WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId;
					


					 DELETE FROM ZnodePimProductAttributeMedia 
					  WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeMedia.PimAttributeValueId 
								
                     ) 
					 AND LocaleId = @LocaleId;

					-- SELECT * FROM @TBL_PimProductId
					

					 DELETE FROM ZnodePimProductAttributeTextAreaValue
					   WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimProductAttributeTextAreaValue.PimAttributeValueId 
								
                     ) AND LocaleId = @LocaleId ;

					 
                     DELETE FROM ZnodePimAttributeValue
                     WHERE EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @TBL_PimProductId TBPD
                         WHERE TBPD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId
                     )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeTextAreaValue ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeDefaultValue ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId )
					 AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeMedia ZPVD WHERE ZPVD.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId );
					
				
					
					If EXISTS (select TOP 1 1 from #PimProductDetail where PimAttributeId = @PimIsDownlodableAttributeId and AttributeValue = 'true'  )
					 Begin
						Select TOP 1 @SKU  =  AttributeValue from  #PimProductDetail where PimAttributeId =  @pimSkuAttributeId
						Select TOP 1 @ProductName  = AttributeValue from  #PimProductDetail where PimAttributeId =  @pimProductNameAttributeId

						insert into ZnodePimDownloadableProduct(SKU,ProductName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
						Select TOP 1 PD.AttributeValue, @ProductName,@UserId , @GetDate, @UserId , @GetDate from  #PimProductDetail PD where  PD.PimAttributeId = @pimSkuAttributeId 
						AND not exists (select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  =  PD.AttributeValue)
						IF NOT Exists (	select top 1 1 from  ZnodePimDownloadableProduct where  ZnodePimDownloadableProduct.SKU  = @SKU)
							insert into ZnodePimDownloadableProduct(SKU,ProductName,  CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
							Select @SKU, @ProductName, @UserId , @GetDate, @UserId , @GetDate 

					 End
                 END;
		
		 

		    MERGE INTO ZnodePimAttributeValue TARGET
              USING #PimProductDetail SOURCE
              ON(
				TARGET.PimProductId = @PimProductId
                AND TARGET.PimAttributeId = SOURCE.PimAttributeId)
                --AND ISNULL(TARGET.PimAttributeFamilyId, 0) = ISNULL(SOURCE.PimAttributeFamilyId, 0))
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.PimAttributeFamilyId = CASE
                                                                   WHEN Source.PimAttributeFamilyId = 0
                                                                   THEN NULL
                                                                   ELSE Source.PimAttributeFamilyId
                                                               END,
                                 --TARGET.PimAttributeDefaultValueId = CASE
                                 --                                        WHEN SOURCE.ProductAttributeDefaultValueId = 0
                                 --                                        THEN NULL
                                 --                                        ELSE SOURCE.ProductAttributeDefaultValueId
                                 --                                    END, 
                                 -- ,TARGET.AttributeValue					= SOURCE.AttributeValue
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeFamilyId,
                             PimProductId,
                             PimAttributeId,
                             PimAttributeDefaultValueId,
                             --,AttributeValue
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (CASE
                  WHEN Source.PimAttributeFamilyId = 0
                  THEN @PimDefaultFamily
                  ELSE Source.PimAttributeFamilyId
              END,
              @PimProductId,
              SOURCE.PimAttributeId,
              CASE
                  WHEN SOURCE.ProductAttributeDefaultValueId = 0
                  THEN NULL
                  ELSE SOURCE.ProductAttributeDefaultValueId
              END, 
              --,SOURCE.AttributeValue
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             )
             --WHEN NOT MATCHED BY SOURCE AND TARGET.PimProductId = @PimProductId
             --                               AND Target.PimAttributeFamilyId IS NOT NULL
             --THEN DELETE
             OUTPUT INSERTED.PimAttributeValueId,
                    INSERTED.PimAttributeFamilyId,
                    INSERTED.PimAttributeId
                    INTO @ZnodePimAttributeValue;
        		
		DECLARE @MediaData Table (MediaId INT , PimProductId INT , PimAttributeId INT ,PimAttributeFamilyId INT,LocaleId INT  )
	    
		INSERT INTO @MediaData (MediaId,PimProductId,PimAttributeId ,PimAttributeFamilyId, LocaleId)
		SELECT sp.item, a.PimProductId, a.PimAttributeId ,PimAttributeFamilyId,a.LocaleId
		FROM #PimProductDetail a
		CROSS APPLY dbo.split(a.AttributeValue,',' ) SP
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_MediaAttributeId c WHERE c.PimAttributeId = a.PimAttributeId ) 
				
				 
		INSERT INTO @TBL_MediaAttributeValue (PimAttributeValueId,LocaleId , AttributeValue,MediaId)
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                         zm.Path AttributeValue
						 ,ZM.MediaId
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN  @MediaData AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
				INNER JOIN ZnodeMedia ZM ON ( b.MediaId = ZM.MediaId )
		
		DELETE FROM ZnodePimProductAttributeMedia 
		WHERE EXISTS 
		 (SELECT TOP 1 1 FROM @TBL_MediaAttributeValue TBLM WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId 
		 AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId  AND ZnodePimProductAttributeMedia.Localeid = @LocaleId)



		MERGE INTO ZnodePimProductAttributeMedia TARGET 
		USING @TBL_MediaAttributeValue SOURCE 
		ON (        TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
		        AND TARGET.MediaPAth = SOURCE.AttributeValue
                  AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.MediaPath = SOURCE.AttributeValue,
						   TARGET.MediaId   = SOURCE.MediaId,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             MediaPath,
							 MediaId ,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
			  SOURCE.MediaId,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
		 --WHEN NOT MATCHED BY SOURCE AND EXISTS 
		 --(SELECT TOP 1 1 FROM @TBL_MediaAttributeValue TBLM WHERE TARGET.PimAttributeValueId = TBLM.PimAttributeValueId AND TBLM.MediaId = TARGET.MediaId  AND TARGET.Localeid = @LocaleId)
		 --  THEN 
		 --DELETE  ;


	   ;With Cte_TextAreaAttributeValue AS 
		 (
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
        FROM @ZnodePimAttributeValue AS a
        INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_TextAreaAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		
		)
		
		MERGE INTO ZnodePimProductAttributeTextAreaValue TARGET 
		USING Cte_TextAreaAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );



        INSERT INTO @TBL_DefaultAttributeValue (PimAttributeValueId,LocaleId,AttributeValue)  
		SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        d.PimAttributeDefaultValueId  AttributeValue
        FROM @ZnodePimAttributeValue AS a
          INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
		INNER JOIN @TBL_DefaultAttributeId c ON ( c.PimAttributeId  = b.PimAttributeId )
		INNER JOIN ZnodePimAttributeDefaultValue d ON (EXISTS (SELECT TOP 1 1 FROM dbo.split(b.AttributeValue,',') SP WHERE d.PimAttributeId = b.PimAttributeId AND SP.Item = d.AttributeDefaultValueCode))
	
	     -- SELECT * FROM @TBL_DefaultAttributeValue

		--  SELECT * FROM Cte_DefaultAttributeValue
		DELETE FROM ZnodePimProductAttributeDefaultValue 
		WHERE  EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeValue TBLAV WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId 
												AND TBLAV.AttributeValue   <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId 
												 AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId )

		MERGE INTO ZnodePimProductAttributeDefaultValue TARGET 
		USING @TBL_DefaultAttributeValue SOURCE 
		ON (TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
              AND TARGET.PimAttributeDefaultValueId =  SOURCE.AttributeValue
			    AND TARGET.LocaleId = SOURCE.LocaleId)
		WHEN MATCHED THEN 
		UPDATE SET
                                 TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN 
		    INSERT(PimAttributeValueId,
                             LocaleId,
                             PimAttributeDefaultValueId,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) 
			VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
			 --WHEN NOT MATCHED BY SOURCE  AND EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeValue TBLAV WHERE TBLAV.PimAttributeValueId = TARGET.PimAttributeValueId 
				--								AND TBLAV.AttributeValue   = TARGET.PimAttributeDefaultValueId  AND TARGET.LocaleId = @LocaleId )
			 --THEN 
			 --DELETE 
			 --;
		
   
			 
		   MERGE INTO ZnodePimAttributeValueLocale TARGET
             USING
             (
                 SELECT a.PimAttributeValueId,
                        b.LocaleId,
                        AttributeValue
                 FROM @ZnodePimAttributeValue AS a
                      INNER JOIN #PimProductDetail AS b ON(a.PimAttributeId = b.PimAttributeId
                                                             AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0))
                 WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId  )
			     AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId  )
				 AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId  )
			 ) SOURCE
             ON(TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                AND TARGET.LocaleId = SOURCE.LocaleId)
                 WHEN MATCHED
                 THEN UPDATE SET
                                 TARGET.AttributeValue = SOURCE.AttributeValue,
                                 TARGET.CreatedBy = @UserId,
                                 TARGET.CreatedDate = @GetDate,
                                 TARGET.ModifiedBy = @UserId,
                                 TARGET.ModifiedDate = @GetDate
                 WHEN NOT MATCHED
                 THEN INSERT(PimAttributeValueId,
                             LocaleId,
                             AttributeValue,
                             CreatedBy,
                             CreatedDate,
                             ModifiedBy,
                             ModifiedDate) VALUES
             (SOURCE.PimAttributeValueId,
              SOURCE.LocaleId,
              SOURCE.AttributeValue,
              @UserId,
              @GetDate,
              @UserId,
              @GetDate
             );
             SET @AssociatedProduct =
             (
                 SELECT MAX(AssociatedProducts)
                 FROM #PimProductDetail AS a
             );
             INSERT INTO ZnodePimProductTypeAssociation
             (PimParentProductId,
              PimProductId,
              DisplayOrder,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           Item,
                           ID AS RowId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@AssociatedProduct, ',') AS b
                         INNER JOIN ZNodePimProduct AS q ON(q.PimProductId = b.Item)
						 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimProductTypeAssociation PPT
						 WHERE PPT.PimParentProductId = @PimProductId AND PPT.PimProductId = b.Item)


             SET @ConfigureAttributeId =
             (
                 SELECT MAX(ConfigureAttributeIds)
                 FROM #PimProductDetail AS a
             );
             SET @ConfigureFamilyId =
             (
                 SELECT MAX(ConfigureFamilyIds)
                 FROM #PimProductDetail AS a
             );
             INSERT INTO [ZnodePimConfigureProductAttribute]
             (PimProductId,
              PimFamilyId,
              PimAttributeId,
              CreatedBy,
              CreatedDate,
              ModifiedBy,
              ModifiedDate
             )
                    SELECT @PimProductId,
                           @ConfigureFamilyId,
                           q.PimAttributeId,
                           @UserId,
                           @GetDate,
                           @UserId,
                           @GetDate
                    FROM dbo.Split(@ConfigureAttributeId, ',') AS b
                         INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimConfigureProductAttribute RTR  WHERE  RTR.PimProductId = @PimProductId AND RTR.PimAttributeId = q.PimAttributeId);



             IF @IsNotReturnOutput = 0
                 SELECT @PimProductId AS Id,
                        CAST(1 AS BIT) AS Status;
             SET @status = 1;

			 IF @CopyPimProductId > 0 
			 BEGIN 
			   INSERT INTO ZnodePimAttributeValueLocale  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimAttributeValueLocale ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId

			    INSERT INTO ZnodePimProductAttributeDefaultValue  (PimAttributeValueId,LocaleId,PimAttributeDefaultValueId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.PimAttributeDefaultValueId,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeDefaultValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId


			   INSERT INTO ZnodePimProductAttributeTextAreaValue  (PimAttributeValueId,LocaleId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.AttributeValue,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeTextAreaValue ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   			   
			   INSERT INTO ZnodePimProductAttributeMedia  (PimAttributeValueId,LocaleId,MediaPath,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			   SELECT ZPAVI.PimAttributeValueId,ZPAVL.LocaleId,ZPAVL.MediaPath,@UserId,@GetDate,@UserId,@GetDate
			   FROM ZnodePimProductAttributeMedia ZPAVL 
			   INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )
			   INNER JOIN ZnodePimAttributeValue ZPAVI ON (ZPAVI.PimAttributeId = ZPAV.PimAttributeId AND ZPAVI.PimProductId = @PimProductId )
			   WHERE ZPAVL.LocaleId <> dbo.Fn_GetDefaultLocaleId()
			   AND ZPAV.PimProductId = @CopyPimProductId
			   
			 END 

				 IF @LocaleId = @DefaultLocaleId
			 BEGIN 	 
	
DECLARE @sqlt NVARCHAr(max) = ''
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int 

DECLARE Cur_AttributeDataUpdate CURSOR FOR 

SELECT b.AttributeCode , PimAttributeId 
FROM INFORMATION_SCHEMA.COLUMNS a 
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )
WHERE TABLE_NAME = 'ZnodePimProduct'
AND IsCategory = 0 
AND IsShowOnGrid = 1 
AND EXISTS (SELECT TOP 1 1 FROM #PimProductDetail n  WHERE n.ProductAttributeCode = b.AttributeCode  )

OPEN Cur_AttributeDataUpdate 
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
WHILE @@FETCH_STATUS = 0 
BEGIN 

 SET @sqlt = 'UPDATE a  
 SET '+@AttributeCodeAtt+'= AttributeValue 
 FROM ZnodePimProduct a 
 INNER JOIN #PimProductDetail m ON(m.PimProductId = a.pimProductId ) 
 WHERE m.ProductAttributeCode = '''+@AttributeCodeAtt+'''
 ' 

 EXEC (@sqlt)

FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
END 
CLOSE Cur_AttributeDataUpdate
DEALLOCATE Cur_AttributeDataUpdate 

END 

             COMMIT TRAN A;
         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE()
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportInsertUpdatePimProduct @UserId = '+CAST(@UserId AS VARCHAR(50))+',@IsNotReturnOutput='+CAST(@IsNotReturnOutput AS VARCHAR(50))+',@CopyPimProductId='+CAST(@CopyPimProductId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			ROLLBACK TRAN A;
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportInsertUpdatePimProduct',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,IsAddon bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-'+CAST(@Getdate as varchar(200))+'Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'Preview'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'Production'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	


	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() 
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId, a.RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionType FROM @Tbl_versions)


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 IsAddon
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 IsAddon
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault, 1 IsAddon
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault, 0 IsAddon
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p
OUTPUT deleted.ZnodeProductId INTO @Deleted_Products
FROM ZnodePublishProductEntity p  WHERE PublishProductEntityId IN   (SELECT PublishProductEntityId FROM #PublishProductEntityId) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )
WHERE @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT , DisplayOrder INT , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  


UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = b.DisplayOrder , IsActive = b.IsActive, ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
INNER JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1

FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND  @PimProductId = 0  

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT r.PimProductId , MAX(Quantity) Quantity
INTO #ZnodeInventory
FROM ZnodeInventory a with (nolock)
INNER JOIN  #PimProduct_distinct r ON ( r.SKU = a.SKU )
GROUP BY PimProductId

SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n WHERE n.PimAttributeId = a.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a 
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = q.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = b.PimProductId )

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, b.Quantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
LEFT JOIN #ZnodeInventory b ON (b.PimProductId = a.PimProductId )
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Bundle Product')


DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, Quantity , ElasticSearchEvent
FROM #temp_bundleProduct

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = q.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
AND EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'Grouped Product')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct


INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)

SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,LocaleId,'','' DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.IsAddon = 1 
	
	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+CAST(GETDATE() as varchar(200))+'-Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 


	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT PimCategoryId FROM  #Temp_categoryDetails ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 157,'Text','Input must be available as a Store Code saved against the specified promotional code.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 157)

GO

IF EXISTS (SELECT *  FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'FK_ZnodePublishCatalogSearchProfile_ZnodePublishCatalog')
	AND parent_object_id = OBJECT_ID(N'dbo.ZnodePublishCatalogSearchProfile'))
BEGIN
	ALTER TABLE [dbo].[ZnodePublishCatalogSearchProfile] DROP CONSTRAINT [FK_ZnodePublishCatalogSearchProfile_ZnodePublishCatalog]
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProgressNotifierEntity' AND COLUMN_NAME = 'JobName')
BEGIN
    ALTER TABLE ZnodePublishProgressNotifierEntity ALTER COLUMN JobName VARCHAR (MAX) NOT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchProfileDetails')
	DROP PROC Znode_GetSearchProfileDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetSearchProfileDetails]
(
	@SearchProfileId int 
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetCatalogList '',100,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		   Declare @SearchQueryTypeId int 

				Select @SearchQueryTypeId=SearchQueryTypeId 
				from ZnodeSearchProfile
				Where  SearchProfileId=@SearchProfileId	

				Exec [dbo].[Znode_GetSearchQueryTypeWiseFeatureDetails] @SearchProfileId=@SearchProfileId,@SearchQueryTypeId=@SearchQueryTypeId
						

				Select b.SearchProfileId,b.AttributeCode,b.BoostValue,b.IsNgramEnabled,b.IsUseInSearch,b.IsFacets
				from ZnodeSearchProfileAttributeMapping b
				Where  b.SearchProfileId=@SearchProfileId AND IsUseInSearch=1

				Select b.SearchProfileId,b.AttributeCode,b.BoostValue,b.IsNgramEnabled,b.IsFacets,b.IsUseInSearch
				from ZnodeSearchProfileAttributeMapping b
				Where  b.SearchProfileId=@SearchProfileId AND IsFacets=1

				Select b.SearchQueryTypeId , b.SearchQueryTypeId ,b.ProfileName,b.Operator,
				c.QueryTypeName,c.QueryBuilderClassName,
				b.SearchSubQueryTypeId,d.QueryTypeName SubQueryTypeName,d.QueryBuilderClassName SubQueryBuilderClassName,
				cc.PublishCatalogId,pc.CatalogName, b.SearchProfileId
				from  ZnodeSearchProfile B 
				left join dbo.ZnodePublishCatalogSearchProfile cc on cc.SearchProfileId=b.SearchProfileId
				left join dbo.ZnodePimCatalog pc on pc.PimcatalogId=cc.PublishCatalogId
				inner join ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
				Left join ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
				Where  b.SearchProfileId=@SearchProfileId	 

				select pfv.FieldName,pfv.FieldValueFactor 
				from ZnodeSearchProfileFieldValueFactor pfv
				WHERE pfv.SearchProfileId = @SearchProfileId

		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
			@ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)
	--		= 'EXEC Znode_GetCatalogList @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS
 --VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetZnodeSearchProfileList',
					@ErrorInProcedure = @Error_procedure,
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSearchProfileEntity')
	DROP PROC Znode_PublishSearchProfileEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSearchProfileEntity] 
(
	@SearchProfileId INT,
	@UserId INT
)
AS
BEGIN
	BEGIN TRY			
		SET NOCOUNT ON
		DECLARE @SearchProfilePublishLogId INT, @ProfileName NVARCHAR(200);

		SELECT TOP 1 @ProfileName=ProfileName FROM ZnodeSearchProfile WHERE SearchProfileId=@SearchProfileId;

		IF NOT EXISTS 
		(SELECT TOP 1 1 FROM ZnodePimCatalog 
		WHERE PimCatalogId =(SELECT TOP 1 PublishCatalogId FROM ZnodePublishCatalogSearchProfile 
													WHERE SearchProfileId = @SearchProfileId
													)
							
		) AND @ProfileName<>'ZnodeSearchProfile'
		BEGIN
			SELECT CAST(0 AS BIT) Status 
		END
		ELSE
		BEGIN
			INSERT INTO ZnodeSearchProfilePublishLog
				(SearchProfileId,PublishstateId,PublishStartDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
			SELECT @SearchProfileId, dbo.Fn_GetPublishStateIdForProcessing(),Getdate(),@UserId , GETDATE(),@UserId , GETDATE()

			SET @SearchProfilePublishLogId = @@IDENTITY

			SELECT a.SearchProfileId,A.SearchFeatureValue,B.FeatureCode,b.FeatureName,b.IsAdvanceFeature,B.HelpDescription  
			INTO #ZnodeSearchFeature
			FROM ZnodeSearchProfileFeatureMapping A 
			INNER JOIN ZnodeSearchFeature B ON A.SearchFeatureId = B.SearchFeatureId
			WHERE A.SearchProfileId = @SearchProfileId
				
			SELECT B.SearchProfileId,
				'['+(SELECT A.SearchFeatureValue,A.FeatureCode,A.FeatureName,A.IsAdvanceFeature
			From #ZnodeSearchFeature A
			WHERE A.SearchProfileId = b.SearchProfileId 
			For Json path, Without_Array_Wrapper)+']' as FeatureValueJson
			INTO #ZnodeSearchFeatureJson
			FROM #ZnodeSearchFeature B 
			GROUP BY B.SearchProfileId

			SELECT A.SearchProfileId,
				'['+(	SELECT B.AttributeCode, B.IsFacets,B.IsUseInSearch,B.BoostValue,B.IsNgramEnabled
						FROM ZnodeSearchProfileAttributeMapping B  
						WHERE A.SearchProfileId = B.SearchProfileId
						For Json Path, Without_Array_Wrapper)
				+']' as SearchProfileAttributeMappingJson
			INTO #ZnodeSearchProfileAttributeMappingJson 
			FROM ZnodeSearchProfileAttributeMapping A
			WHERE A.SearchProfileId = @SearchProfileId
			GROUP BY A.SearchProfileId

			SELECT A.SearchProfileId,
				'['+(	select B.FieldName, B.FieldValueFactor
						from ZnodeSearchProfileFieldValueFactor B  
						Where A.SearchProfileId = B.SearchProfileId
						For Json Path, Without_Array_Wrapper)
				+']' as FieldValueFactor
			INTO #ZnodeSearchProfileFieldValueFactor 
			FROM ZnodeSearchProfileFieldValueFactor A
			WHERE A.SearchProfileId = @SearchProfileId
			GROUP BY A.SearchProfileId

			SELECT @SearchProfilePublishLogId SearchProfilePublishLogId,  b.SearchProfileId,
				b.ProfileName,pc.PimCatalogId PublishCatalogId,ZSFJ.FeatureValueJson FeaturesList
				,c.QueryTypeName,b.SearchQueryTypeId  
				,c.QueryBuilderClassName,d.QueryTypeName SubQueryTypeName,vf.FieldValueFactor,
				b.Operator,ZSPAMJ.SearchProfileAttributeMappingJson SearchProfileAttributeMappingJson,
				@UserId CreatedBy, GETDATE() CreatedDate,@UserId Modifiedby, GETDATE() ModifiedDate
			INTO #ZnodeSearchProfile
			FROM  ZnodeSearchProfile B 
			LEFT JOIN dbo.ZnodePublishCatalogSearchProfile cc on cc.SearchProfileId=b.SearchProfileId
			LEFT JOIN dbo.ZnodePImCatalog pc on pc.PimCatalogId=cc.PublishCatalogId
			INNER JOIN ZnodeSearchQueryType C on b.SearchQueryTypeId=C.SearchQueryTypeId 
			--LEFT JOIN ZnodeSearchProfileFieldValueFactor ZSPF on ZSPF.SearchProfileId = b.SearchProfileId
			LEFT JOIN #ZnodeSearchFeatureJson ZSFJ on ZSFJ.SearchProfileId = b.SearchProfileId
			LEFT JOIN  #ZnodeSearchProfileAttributeMappingJson ZSPAMJ on  ZSPAMJ.SearchProfileId = b.SearchProfileId
			LEFT JOIN ZnodeSearchQueryType d on  d.SearchQueryTypeId =b.SearchSubQueryTypeId
			LEFT JOIN #ZnodeSearchProfileFieldValueFactor vf on vf.SearchProfileId =b.SearchProfileId
			WHERE b.SearchProfileId=@SearchProfileId

			IF EXISTS (SELECT TOP 1 1 FROM #ZnodeSearchProfile)
			BEGIN 
				INSERT INTO ZnodePublishSearchProfileEntity(
					SearchProfilePublishLogId,SearchProfileId,SearchProfileName,ZnodeCatalogId,FeaturesList,
					QueryTypeName,SearchQueryType,
					QueryBuilderClassName,SubQueryType,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
					CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT SearchProfilePublishLogId,SearchProfileId,ProfileName,PublishCatalogId,FeaturesList,
					QueryTypeName,SearchQueryTypeId  ,
					QueryBuilderClassName,SubQueryTypeName,FieldValueFactor,Operator,SearchProfileAttributeMappingJson,
					CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
				FROM #ZnodeSearchProfile 
		
		     

				UPDATE ZnodeSearchProfilePublishLog
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish()
				WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId

				UPDATE ZnodeSearchProfile
				SET PublishStateId = dbo.Fn_GetPublishStateIdForPublish() 
				WHERE SearchProfileId = @SearchProfileId

				UPDATE ZnodePublishSearchProfileEntity 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublish() 
				WHERE SearchProfileId = @SearchProfileId 

				DELETE
				FROM ZnodePublishSearchProfileEntity
				WHERE SearchProfilePublishLogId  < @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
				SELECT CAST(1 AS BIT) Status
			END
			ELSE
			BEGIN
				UPDATE ZnodeSearchProfilePublishLog 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId 

				SELECT CAST(0 AS BIT) Status 

				UPDATE ZnodeSearchProfile 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfileId = @SearchProfileId 
		
	     		UPDATE ZnodePublishSearchProfileEntity 
				SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
				WHERE SearchProfileId = @SearchProfileId
			END
		END
	END TRY

	BEGIN CATCH
		UPDATE ZnodeSearchProfile 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		UPDATE ZnodeSearchProfilePublishLog 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfilePublishLogId = @SearchProfilePublishLogId AND SearchProfileId = @SearchProfileId
		
		UPDATE ZnodePublishSearchProfileEntity 
		SET PublishstateId = dbo.Fn_GetPublishStateIdForPublishFailed() 
		WHERE SearchProfileId = @SearchProfileId 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSearchProfileEntity @SearchProfileId = '+CAST(@SearchProfileId AS VARCHAR(10))+',@UserId='+CAST(@UserId AS VARCHAR(10));

		SELECT CAST(0 AS BIT) Status
		 
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_PublishSearchProfileEntity',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishChildCategory')
	DROP PROC Znode_GetPublishChildCategory
GO

CREATE PROC Znode_GetPublishChildCategory 
(
 @VersionId INT = 0
,@ZnodeCategoryId int  = 0 
) 
AS 
BEGIN 
BEGIN TRY
SET NOCOUNT ON 
;with cte as 
(
SELECT a.ZnodeCategoryId, CAST(TRANSLATE(a.ZnodeParentCategoryIds ,'[]','  ') AS INT ) ZnodeParentCategoryIds
FROM ZnodePublishCategoryEntity a with(nolock) 
WHERE a.VersionId = @VersionId AND ZnodeCategoryId = @ZnodeCategoryId 
UNION ALL 
SELECT a.ZnodeCategoryId, CAST(TRANSLATE(a.ZnodeParentCategoryIds ,'[]','  ') AS INT )
FROM ZnodePublishCategoryEntity a with(nolock) 
INNER JOIN cte v ON (CAST(TRANSLATE(a.ZnodeParentCategoryIds ,'[]','  ') AS INT )  =  v.ZnodeCategoryId)
WHERE a.VersionId = @VersionId 


) 

SELECT cast(1 as int) as Id , STRING_AGG( ZnodeCategoryId,',') as MessageDetails, cast(1 as bit) as Status 
FROM cte 
 
END TRY 

BEGIN CATCH  
 SELECT cast(0 as int) as Id , ERROR_MESSAGE() as MessageDetails, cast(0 as bit) as Status
END CATCH 
END 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdatePromotions')
	DROP PROC Znode_InsertUpdatePromotions
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdatePromotions]   
(
	@PromotionXML XML,
	@UserId INT,
	@Status BIT=0 OUT
)
/*  Unit Testing:-
	begin tran  
 Exec Znode_InsertUpdatePromotions @PromotionXML='<PromotionModel>
  <PromotionId>0</PromotionId>
  <PromoCode>Aditya</PromoCode>
  <Name>Aditya</Name>
  <PromotionTypeId>5</PromotionTypeId>
  <PromotionTypeName>Amount Off Order</PromotionTypeName>
  <Discount>10.0</Discount>
  <StartDate>2022-08-25T00:00:00</StartDate>
  <EndDate>2022-09-24T00:00:00</EndDate>
  <OrderMinimum>1.0</OrderMinimum>
  <QuantityMinimum>0</QuantityMinimum> p2:nil="true" xmlns:p2="http://www.w3.org/2001/XMLSchema-instance" />
  <IsCouponRequired>true</IsCouponRequired>
  <DisplayOrder>99</DisplayOrder>
  <IsUnique>false</IsUnique>
  <PortalId>0</PortalId> p2:nil="true" xmlns:p2="http://www.w3.org/2001/XMLSchema-instance" />
  <ProfileId>0</ProfileId> p2:nil="true" xmlns:p2="http://www.w3.org/2001/XMLSchema-instance" />
  <ProfileIdsList>
    <int>80</int>
	</ProfileIdsList>
  <PromotionProductQuantity>0.0</PromotionProductQuantity>
  <ReferralPublishProductId>0</ReferralPublishProductId>
  <CouponList>
    <PageIndex>0</PageIndex> p3:nil="true" xmlns:p3="http://www.w3.org/2001/XMLSchema-instance" />
    <PageSize>0</PageSize> p3:nil="true" xmlns:p3="http://www.w3.org/2001/XMLSchema-instance" />
    <TotalResults>0</TotalResults>
    <CouponList>
      <CouponModel>
        <PromotionCouponId>0</PromotionCouponId>
        <PromotionId>0</PromotionId>
        <Code>Aditya</Code>
        <InitialQuantity>6</InitialQuantity>
        <AvailableQuantity>6</AvailableQuantity>
        <IsEnableUrl>false</IsEnableUrl>
        <IsActive>true</IsActive>
        <CouponApplied>false</CouponApplied>
        <CouponValid>false</CouponValid>
        <CustomCouponCode>0</CustomCouponCode>
        <IsCustomCoupon>false</IsCustomCoupon>
        <IsExistInOrder>false</IsExistInOrder>
      </CouponModel>
    </CouponList>
  </CouponList>
  <PortalAllowsMultipleCoupon>false</PortalAllowsMultipleCoupon>
  <IsAllowedWithOtherCoupons>true</IsAllowedWithOtherCoupons>
  <AssociatedCatelogIds>0</AssociatedCatelogIds>
  <AssociatedCategoryIds>0</AssociatedCategoryIds>
  <AssociatedProductIds>0</AssociatedProductIds>
  <AssociatedBrandIds>0</AssociatedBrandIds>
  <AssociatedShippingIds>0</AssociatedShippingIds>
  <IsAllowWithOtherPromotionsAndCoupons>false</IsAllowWithOtherPromotionsAndCoupons>
  <IsActive>false</IsActive>
  <IsUsedInOrder>false</IsUsedInOrder>
</PromotionModel>',@UserID=1,@Status=1
rollback tran
*/
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DROP TABLE IF EXISTS tempdb..#TEMP
	SELECT Tbl.Col.value('PromotionId[1]','NVARCHAR(600)') AS PromotionId  
		,Tbl.Col.value('PromoCode[1]','NVARCHAR(600)') AS [PromoCode]
		,Tbl.Col.value('Description[1]','NVARCHAR(Max)') AS [Description] 
		,Tbl.Col.value('Name[1]','NVARCHAR(600)') AS [Name]
		,Tbl.Col.value ('PromotionTypeId[1]','NVARCHAR(600)') AS PromotionTypeId
		,Tbl.Col.value ('PromotionTypeName[1]','NVARCHAR(600)') AS PromotionTypeName
		,Tbl.Col.value ('Discount[1]','NVARCHAR(600)') AS Discount
		,Tbl.Col.value ('StartDate[1]','NVARCHAR(600)') AS StartDate
		,Tbl.Col.value ('EndDate[1]','NVARCHAR(600)') AS EndDate
		,Tbl.Col.value ('OrderMinimum[1]','NVARCHAR(600)') AS OrderMinimum
		,Tbl.Col.value ('QuantityMinimum[1]','NVARCHAR(600)') AS QuantityMinimum
		,Tbl.Col.value ('IsCouponRequired[1]','NVARCHAR(600)') AS IsCouponRequired
		,Tbl.Col.value ('DisplayOrder[1]','NVARCHAR(600)') AS DisplayOrder
		,Tbl.Col.value ('IsUnique[1]','NVARCHAR(600)') AS IsUnique
		,Tbl.Col.value ('PortalId[1]','NVARCHAR(600)') AS PortalId
		,Tbl.Col.value ('ProfileId[1]','NVARCHAR(600)') AS ProfileIds
		,Tbl3.Col3.value ('.','NVARCHAR(600)') AS ProfileId
		,Tbl.Col.value ('PromotionProductQuantity[1]','NVARCHAR(600)') AS PromotionProductQuantity
		,Tbl.Col.value ('ReferralPublishProductId[1]','NVARCHAR(600)') AS ReferralPublishProductId
		,Tbl2.Col2.value ('PageIndex[1]','NVARCHAR(600)') AS PageIndex
		,Tbl2.Col2.value ('PageSize[1]','NVARCHAR(600)') AS PageSize
		,Tbl2.Col2.value ('TotalResults[1]','NVARCHAR(600)') AS TotalResults
		,Tbl.Col.value ('PortalAllowsMultipleCoupon[1]','NVARCHAR(600)') AS PortalAllowsMultipleCoupon
		,Tbl.Col.value ('PromotionMessage[1]','NVARCHAR(600)') AS PromotionMessage
		,Tbl.Col.value ('IsAllowedWithOtherCoupons[1]','NVARCHAR(600)') AS IsAllowedWithOtherCoupons
		,Tbl.Col.value ('AssociatedCatelogIds[1]','NVARCHAR(600)') AS AssociatedCatelogIds
		,Tbl.Col.value ('AssociatedCategoryIds[1]','NVARCHAR(600)') AS AssociatedCategoryIds
		,Tbl.Col.value ('AssociatedProductIds[1]','NVARCHAR(600)') AS AssociatedProductIds
		,Tbl.Col.value ('AssociatedBrandIds[1]','NVARCHAR(600)') AS AssociatedBrandIds
		,Tbl.Col.value ('AssociatedShippingIds[1]','NVARCHAR(600)') AS AssociatedShippingIds
		,Tbl.Col.value ('IsAllowWithOtherPromotionsAndCoupons[1]','NVARCHAR(600)') AS IsAllowWithOtherPromotionsAndCoupons
		,Tbl.Col.value ('IsActive[1]','NVARCHAR(600)') AS IsActiveCoupon
		,Tbl.Col.value ('IsUsedInOrder[1]','NVARCHAR(600)') AS IsUsedInOrder
	INTO tempdb..#TEMP
	FROM @PromotionXML.nodes('PromotionModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes('CouponList') AS Tbl2(Col2)
	CROSS APPLY Tbl.Col.nodes('//ProfileIds/int') AS Tbl3(Col3)
	
	CREATE TABLE #coupnModel (PromotionCouponId NVARCHAR(600), PromotionCouponModelId NVARCHAR(600), Code NVARCHAR(600),InitialQuantity NVARCHAR(600)
	,AvailableQuantity NVARCHAR(600),IsEnableUrl NVARCHAR(600),IsActive NVARCHAR(600),CouponApplied NVARCHAR(600)
	,CouponValid NVARCHAR(600),CustomCouponCode NVARCHAR(600) ,IsCustomCoupon NVARCHAR(600),IsExistInOrder NVARCHAR(600))
	
	IF CAST(@PromotionXML AS nvarchar(max))  like '%<CouponModel>%'
	BEGIN 
	INSERT INTO  #coupnModel 
	SELECT  Tbl1.Col1.value ('PromotionCouponId[1]','NVARCHAR(600)') AS PromotionCouponId
		,Tbl1.Col1.value ('PromotionId[1]','NVARCHAR(600)') AS PromotionCouponModelId
		,Tbl1.Col1.value ('Code[1]','NVARCHAR(600)') AS Code
		,Tbl1.Col1.value ('InitialQuantity[1]','NVARCHAR(600)') AS InitialQuantity
		,Tbl1.Col1.value ('AvailableQuantity[1]','NVARCHAR(600)') AS AvailableQuantity
		,Tbl1.Col1.value ('IsEnableUrl[1]','NVARCHAR(600)') AS IsEnableUrl
		,Tbl1.Col1.value ('IsActive[1]','NVARCHAR(600)') AS IsActive
		,Tbl1.Col1.value ('CouponApplied[1]','NVARCHAR(600)') AS CouponApplied
		,Tbl1.Col1.value ('CouponValid[1]','NVARCHAR(600)') AS CouponValid
		,Tbl1.Col1.value ('CustomCouponCode[1]','NVARCHAR(600)') AS CustomCouponCode
		,Tbl1.Col1.value ('IsCustomCoupon[1]','NVARCHAR(600)') AS IsCustomCoupon
		,Tbl1.Col1.value ('IsExistInOrder[1]','NVARCHAR(600)') AS IsExistInOrder
	--INTO #coupnModel 
	FROM @PromotionXML.nodes('//PromotionModel/CouponList/CouponList/CouponModel') AS Tbl1(Col1)
	
	--SELECT * FROM #coupnModel

	END 
	ELSE
	BEGIN 
		INSERT INTO #coupnModel (PromotionCouponId)
		SELECT 0
	END 
		
	UPDATE #TEMP SET QuantityMinimum = 0 WHERE ISNULL(QuantityMinimum,'') = ''

	DECLARE @SQL VARCHAR(MAX)
	DECLARE @GUID VARCHAR(100) = CAST(NEWID() AS VARCHAR(100))
	DECLARE @TableName VARCHAR(500) = '##Temp_Promotion_'+CAST(@@SPID AS varchar(30))
	DECLARE @LocaleId INT = DBO.Fn_GetDefaultLocaleId();
	DECLARE @PromotionTypeId INT = (SELECT TOP 1 PromotionTypeId FROM tempdb..#TEMP);
	
    CREATE TABLE #Temp_Promotion_ (PromoCode NVARCHAR(500),Name NVARCHAR(500),Description NVARCHAR(500),StartDate NVARCHAR(500),
		EndDate NVARCHAR(500),DisplayOrder NVARCHAR(500),PortalId NVARCHAR(500),ProfileId NVARCHAR(500),IsCouponRequired NVARCHAR(500),
		IsAllowedWithOtherCoupons NVARCHAR(500),PromotionMessage NVARCHAR(500),Code NVARCHAR(500),AvailableQuantity NVARCHAR(500),
		Brand NVARCHAR(500),CallForPriceMessage NVARCHAR(500),Catalog NVARCHAR(500),Category NVARCHAR(500),DiscountAmount NVARCHAR(500),
		MinimumOrderAmount NVARCHAR(500),MinimumQuantity NVARCHAR(500),ProductQuantity NVARCHAR(500),ProductToDiscount NVARCHAR(500),
		RequiredProduct NVARCHAR(500),Shipping NVARCHAR(500), InitialQuantity NVARCHAR(500),IsUnique NVARCHAR(500) )

	INSERT INTO #Temp_Promotion_
	SELECT DISTINCT PromoCode,Name,ISNULL(Description,''),StartDate,EndDate,DisplayOrder,IIF(PortalId='0' OR PortalId ='' , NULL,PortalId),
		IIF(ProfileId='0' OR ProfileId ='' , NULL,ProfileId) ProfileId,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,
		AvailableQuantity,AssociatedBrandIds,'',AssociatedCatelogIds,AssociatedCategoryIds,Discount,OrderMinimum,QuantityMinimum,
		PromotionProductQuantity,AssociatedProductIds,ReferralPublishProductId,AssociatedShippingIds,InitialQuantity,IsUnique 
	FROM tempdb..#TEMP 
	CROSS APPLY #coupnModel

	UPDATE ZP SET ZP.PromoCode=T.PromoCode
	FROM ZnodePromotion ZP
	INNER JOIN tempdb..#TEMP T ON ZP.PromotionId=CAST(T.PromotionId As INT)
	WHERE (CASE WHEN T.PromotionId IS NULL OR  T.PromotionId ='' THEN '0' ELSE CAST(T.PromotionId AS INT) END) <>0
	
	EXEC dbo.Znode_ImportPromotions @TableName='#Temp_Promotion_',@Status=0,@UserId=1,@ImportProcessLogId=0,@NewGUId=@GUID,@LocaleId=@LocaleId,
		@CsvColumnString='PromoCode,Name,Description,StartDate,EndDate,DisplayOrder,PortalId,ProfileId,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,AvailableQuantity,Brand,CallForPriceMessage,Catalog,Category,DiscountAmount,MinimumOrderAmount,MinimumQuantity,ProductQuantity,ProductToDiscount,RequiredProduct,Shipping,InitialQuantity,IsUnique'
		,@PromotionTypeId=@PromotionTypeId ,@IsGenerateErrorLog =0 

	SET @Status = 1
	
	SELECT * 
	FROM ZnodePromotion a 
	WHERE PromoCode = (SELECT TOP 1 PromoCode FROM #Temp_Promotion_ )

	END TRY
              			 
	BEGIN CATCH
		SELECT ERROR_MESSAGE() 
		
		SET @Status = 0
		
		SELECT 1 ID , CAST(0 AS BIT ) Status
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'Znode_InsertUpdatePromotions	
					@PromotionXML='+CAST(@PromotionXML AS VARCHAR(MAX))+',
					@UserId='+CAST(@UserId AS VARCHAR(10))+',
					@Status='+CAST(@Status AS VARCHAR(10));
		
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_InsertUpdatePromotions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

Declare @GlobalAttribute_EnableTradeCentric int
select @GlobalAttribute_EnableTradeCentric = GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'EnableTradeCentric'
delete from ZnodeGlobalAttributeGroupMapper where GlobalAttributeId = @GlobalAttribute_EnableTradeCentric
execute [Znode_DeleteGlobalAttribute] @GlobalAttributeId = @GlobalAttribute_EnableTradeCentric,@Status = 0

GO

Declare @GlobalAttributeGroup_TradeCentric int
select @GlobalAttributeGroup_TradeCentric = GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'TradeCentric'
delete from ZnodeGlobalGroupEntityMapper where GlobalAttributeGroupId = @GlobalAttributeGroup_TradeCentric
delete from ZnodeGlobalFamilyGroupMapper where GlobalAttributeGroupId = @GlobalAttributeGroup_TradeCentric
execute [Znode_DeleteGlobalAttributeGroup] @GlobalAttributeGroupId = @GlobalAttributeGroup_TradeCentric,@Status = 0

GO

INSERT INTO ZnodeActions(ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'Order','GetIframeViewWithToken',1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT 1 FROM ZnodeActions WHERE ControllerName='Order' AND ActionName='GetIframeViewWithToken')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimCategoryProductList')
	DROP PROC Znode_GetPimCategoryProductList
GO

CREATE PROCEDURE [dbo].[Znode_GetPimCategoryProductList]
(   @WhereClause   XML,
    @Rows          INT           = 100,
    @PageNo        INT           = 1,
    @Order_BY      VARCHAR(1000) = '',
    @RowsCount     INT OUT,
    @LocaleId      INT           = 1,
    @PimCategoryId INT,
    @IsAssociated  BIT           = 0
	,@AttributeCode VARCHAR(max) = ''
	)
AS
/*
     Summary :- This Procedure is used to get the product list for category products
				The result is fetched order by DisplayOrder or status as per requirement in both asc and desc

     Unit Testing
	 begin tran
     EXEC Znode_GetPimCategoryProductList '',@RowsCount = 0, @PimCategoryId = 22,@Order_BY ='DisplayOrder asc'
	 rollback tran
	*/
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;

			  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

             DECLARE @TBL_AttributeDefaultValue TABLE
             (PimAttributeId            INT,
              AttributeDefaultValueCode VARCHAR(100),
              IsEditable                BIT,
              AttributeDefaultValue     NVARCHAR(MAX),
			  DisplayOrder INT
             );
			 DECLARE @TransferPimProductId TransferId
             DECLARE @TBL_AttributeDetails AS TABLE
             (PimProductId   INT,
              AttributeValue NVARCHAR(MAX),
              AttributeCode  VARCHAR(600),
              PimAttributeId INT
             );
             DECLARE @TBL_FamilyDetails TABLE
             (PimProductId         INT,
              PimAttributeFamilyId INT,
              FamilyName           NVARCHAR(3000)
             );
             DECLARE @OrderByDisplay INT= 0;
             DECLARE @DefaultAttributeFamilyId INT= dbo.Fn_GetDefaultPimProductFamilyId(), @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();

			 DECLARE @TBL_ProductIdTable TABLE
             ([PimProductId] INT,
              [CountId]      INT,
              PimCategoryId  INT,
              RowId          INT
             );

             DECLARE @PimProductId TransferId ,--VARCHAR(MAX)= '',
					 @PimAttributeId VARCHAR(MAX),
					 @OutPimProductIds VARCHAR(MAX);

			 DECLARE @PimProductIds TransferId

             IF @Order_BY LIKE '%DisplayOrder%'
                 BEGIN
                     SET @OrderByDisplay = 1;
                 END;
             ELSE
             IF @Order_BY LIKE '%Status%'
                 BEGIN
                     SET @OrderByDisplay = 2;
                 END;
			 DECLARE @TBL_PimMediaAttributeId TABLE (PimAttributeId INT ,AttributeCode VARCHAR(600))
			 INSERT INTO @TBL_PimMediaAttributeId (PimAttributeId,AttributeCode)
			 SELECT PimAttributeId,AttributeCode FROM Dbo.Fn_GetProductMediaAttributeId ()

            INSERT INTO @TransferPimProductId
			SELECT PimProductId
			FROM ZnodePimCategoryProduct ZCP
            WHERE ZCP.PimCategoryId = @PimCategoryId
			ORDER BY CASE WHEN @Order_By LIKE '% DESC%'
            THEN
			CASE WHEN @OrderByDisplay = 1
					THEN ZCP.DisplayOrder
				WHEN @OrderByDisplay = 2
					THEN ZCP.Status
				 ELSE 1 END
				 ELSE 1 END DESC,
            CASE WHEN @Order_By LIKE '% ASC%'
				THEN
					CASE WHEN @OrderByDisplay = 1
					THEN ZCP.DisplayOrder
						WHEN @OrderByDisplay = 2
							THEN ZCP.Status
							 ELSE 1 END
							  ELSE 1 END
	         IF NOT EXISTS (SELECT TOP 1 1 FROM @TransferPimProductId  )
			 BEGIN
			   INSERT INTO @TransferPimProductId
			   SELECT '0'
			   SET @IsAssociated = 0
             END


   DECLARE @SQL NVARcHAR(max)= ''
		 DECLARE  @ProductListIdRTR TransferId
	 DECLARE @TAb Transferid
	 DECLARE @tBL_mainList TABLE (Id INT,RowId INT)
	 --	IF   @IsCallForAttribute=1
		--BEGIN
	 SET @IsAssociated = CASE WHEN @IsAssociated = 0 THEN 1
					 WHEN @IsAssociated = 1 THEN 0 END
		--END
	 INSERT INTO @ProductListIdRTR
	 EXEC Znode_GetProductList  @IsAssociated,@TransferPimProductId

	 IF CAST(@WhereClause AS NVARCHAR(max))<> N''
	 BEGIN

	  SET @SQL = 'SELECT PimProductId FROM ##Temp_PimProductId'+CAST(@@SPID AS VARCHAR(500))

	  EXEC Znode_GetFilterPimProductId @WhereClause,@ProductListIdRTR,@localeId

      INSERT INTO @TAB
	  EXEC (@SQL)

	 END

	
	 IF EXISTS (SELECT Top 1 1 FROM @TAb ) OR CAST(@WhereClause AS NVARCHAR(max)) <> N''
	 BEGIN

	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO @TBL_MainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @TAb ,@AttributeCode,@localeId

	 END
	 ELSE
	 BEGIN

	 SET @AttributeCode = REPLACE(dbo.FN_TRIM(REPLACE(REPLACE(@order_by,' DESC',''),' ASC','')),'DisplayOrder','ProductName')
	 SET @order_by = REPLACE(@order_by,'DisplayOrder','ProductName')
	 INSERT INTO @TBL_MainList(id,RowId)
	 EXEC Znode_GetOrderByPagingProduct @order_by,@rows,@PageNo, @ProductListIdRTR ,@AttributeCode,@localeId
	 END

			 INSERT INTO @TBL_ProductIdTable(PimProductId,RowId)
			 SELECT ID ,RowId FROM @TBL_MainList SP

			 INSERT INTO @PimProductIds ( Id )
			 SELECT Id FROM @TBL_MainList SP

             UPDATE @TBL_ProductIdTable SET PimCategoryId = @PimCategoryId;
             SET @PimAttributeId = SUBSTRING((SELECT ','+CAST(PimAttributeId AS VARCHAR(50)) FROM [dbo].[Fn_GetGridPimAttributes]() FOR XML PATH('')), 2, 4000);
 
             INSERT INTO @TBL_AttributeDetails(PimProductId, AttributeValue,AttributeCode,PimAttributeId)
			 EXEC Znode_GetProductsAttributeValue @PimProductIds,@PimAttributeId,@LocaleId;
             
	
			   DROP TABLE IF EXISTS #Cte_ProductMedia
			 
			   SELECT TBA.PimProductId , TBA.PimAttributeId
			   , SUBSTRING( ( SELECT ','+ISNULL(CASE WHEN ZMC.CDNURL = '' THEN NULL ELSE ZMC.CDNURL END,ZMC.URL)+ZMSM.ThumbnailFolderName+'/'+ zm.PATH  
			  
			   FROM ZnodeMedia AS ZM
               INNER JOIN ZnodeMediaConfiguration ZMC  ON (ZM.MediaConfigurationId = ZMC.MediaConfigurationId)
			   INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
			   INNER JOIN @TBL_AttributeDetails AS TBAI ON (TBAI.AttributeValue  = CAST(ZM.MediaId AS VARCHAR(50)) )
			   INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBAI.PimATtributeId)
			   WHERE TBAI.PimProductId = TBA.PimProductId AND TBAI.PimAttributeId = TBA.PimAttributeId
			   FOR XML PATH('') ), 2 , 4000) AS AttributeValue , SUBSTRING( ( SELECT ','+AttributeValue
			   FROM  @TBL_AttributeDetails AS TBAI
			   WHERE TBAI.PimProductId = TBA.PimProductId AND TBAI.PimAttributeId = TBA.PimAttributeId
			   FOR XML PATH('') ), 2 , 4000) MediaIds
			    
			   INTO #Cte_ProductMedia
			   
			   FROM @TBL_AttributeDetails AS TBA
			   INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = TBA.PimATtributeId )
			   
			   
			
		      UPDATE TBAV SET AttributeValue = CTPM.AttributeVALue
			  FROM @TBL_AttributeDetails TBAV
			  INNER JOIN #Cte_ProductMedia CTPM ON CTPM.PimProductId = TBAV.PimProductId  AND CTPM.PimAttributeId = TBAV.PimAttributeId
			  AND CTPM.PimAttributeId = TBAV.PimAttributeId;


			 INSERT INTO @TBL_FamilyDetails(PimAttributeFamilyId,PimProductId)
             EXEC [dbo].[Znode_GetPimProductAttributeFamilyId] @PimProductId,1;

             UPDATE TFD SET FamilyName = ZPFL.AttributeFamilyName FROM @TBL_FamilyDetails TFD INNER JOIN ZnodePimFamilyLocale ZPFL
			 ON(TFD.PimAttributeFamilyId = ZPFL.PimAttributeFamilyId AND LocaleId = @LocaleId);

             UPDATE TFD SET FamilyName = ZPFL.AttributeFamilyName FROM @TBL_FamilyDetails TFD INNER JOIN ZnodePimFamilyLocale ZPFL
			 ON(TFD.PimAttributeFamilyId = ZPFL.PimAttributeFamilyId AND LocaleId = @DefaultLocaleId) WHERE TFD.FamilyName IS NULL OR TFD.FamilyName = '';

			  IF OBJECT_ID('tempdb.dbo.#productdata', 'U') IS NOT NULL 
		                DROP TABLE #productdata

				 
             SELECT  zpp.[PimProductId] AS [Productid],zpp.[PimProductId],ZPCP.[PimCategoryId],TBFD.FamilyName,[ProductName],[SKU],[ProductType],[Assortment],
      
			piv.[ProductImage] [ImagePath],ZPCP.DisplayOrder into #productdata

			 FROM @TBL_ProductIdTable AS zpp
			 LEFT JOIN ZnodePimCategoryProduct ZPCP ON(ZPCP.PimProductId = Zpp.PimProductId AND ZPCP.PimCategoryId = Zpp.PimCategoryId)
             INNER JOIN (SELECT PimProductId,AttributeValue,AttributeCode FROM @TBL_AttributeDetails) TB
			  PIVOT(MAX([AttributeValue])
			 FOR [AttributeCode] IN([ProductName],[IsActive],[ProductImage],[SKU],[ProductType],[Assortment])) AS Piv ON(Piv.[PimProductId] = zpp.[PimProductId])
             LEFT JOIN @TBL_FamilyDetails TBFD ON(TBFD.PimProductId = zpp.[PimProductId])
             ORDER BY CASE WHEN @Order_By LIKE '% DESC%' THEN CASE WHEN @OrderByDisplay = 1 THEN ZPCP.DisplayOrder
			 WHEN @OrderByDisplay = 2 THEN ZPCP.Status ELSE 1 END ELSE 1 END DESC,
             CASE WHEN @Order_By LIKE '% ASC%' THEN CASE WHEN @OrderByDisplay = 1 THEN ZPCP.DisplayOrder
             WHEN @OrderByDisplay = 2 THEN ZPCP.Status ELSE 1 END ELSE 1 END,zpp.RowId;

			  IF OBJECT_ID('tempdb.dbo.#FinalProductData', 'U') IS NOT NULL 
		                DROP TABLE #FinalProductData

			 select zppe.SKU, zppe.VersionId, zppe.IsActive, zppe.Name into #FinalProductData from ZnodePublishProductEntity zppe inner join ZnodePublishVersionEntity zpve
             on zppe.VersionId =zpve.VersionId
			 select distinct pd.*, fpd.IsActive from #productdata pd inner join #FinalProductData fpd
			 on pd.SKU = fpd.SKU order by DisplayOrder 

			   IF EXISTS (SELECT Top 1 1 FROM @TAb )
	 BEGIN

		  SELECT @RowsCount = (SELECT COUNT(1) FROM @TAb)
	 END
	 ELSE
	 BEGIN
	 		  SELECT @RowsCount=(SELECT COUNT(1) FROM @ProductListIdRTR)
	 END

    END TRY
    BEGIN CATCH
	SELECT ERROR_MESSAGE()
    DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimCategoryProductList @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PimCategoryId='+CAST(@PimCategoryId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPimCategoryProductList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPromotions')
	DROP PROC Znode_ImportPromotions
GO

Create PROCEDURE [dbo].[Znode_ImportPromotions]
(
	@TableName			NVARCHAR(100),
	@Status				BIT,
	@UserId				INT,
	@ImportProcessLogId	INT,
	@NewGUId			NVARCHAR(200),
	@LocaleId			INT=1,
	@CsvColumnString	NVARCHAR(MAX),
	@PromotionTypeId	INT , 
	@IsGenerateErrorLog	BIT = 1
)
AS 
/*
	Summary :  Made a provision to import Promotions details.
	
	Unit Testing: 
		EXEC dbo.Znode_ImportPromotions @TableName='',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId='',@LocaleId=1,
			@CsvColumnString=,@PromotionTypeId=17

	SELECT @TableName='##Temp',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId=NEWID(),@LocaleId=1,
			@CsvColumnString='PromoCode,Name,Description,StartDate,EndDate,DisplayOrder,Store,Profile,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,AvailableQuantity
				,DiscountAmount,MinimumQuantity,MinimumOrderAmount,Brand',
			@PromotionTypeId=17
*/
BEGIN
	SET NOCOUNT ON;
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(MAX);

	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

	DECLARE @GetDate1 VARCHAR(100) = CONVERT(VARCHAR(30),@GetDate,121)
	DECLARE @ImportProcessLogId1 VARCHAR(100) = CAST(@ImportProcessLogId AS VARCHAR(15))
	DECLARE @UserId1 VARCHAR(15) = CAST(@UserId AS VARCHAR(15))

	IF ISNULL(@LocaleId,0)=0
	BEGIN
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
	END

	DECLARE @LocaleId1 VARCHAR(15) = CAST(@LocaleId AS VARCHAR(15))

	IF OBJECT_ID('tempdb..##Promotions') IS NOT NULL
		DROP TABLE ##Promotions

	SET @SSQL='CREATE TABLE ##Promotions (RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT , '+
		REPLACE(TRIM(LTRIM(@CsvColumnString)), ',' ,' NVARCHAR(MAX),') + CASE WHEN @CsvColumnString = '' THEN '' ELSE ' NVARCHAR(MAX)' END+', GUID NVARCHAR(400)) 
		INSERT INTO ##Promotions (RowNumber,' + @CsvColumnString + ',GUID) 
		SELECT ROW_NUMBER() OVER (ORDER BY PromoCode) As RowNumber,' + @CsvColumnString + ','''+@NewGUId+''' As GUID FROM '+ @TableName +'
		'
		
	EXEC (@SSQL)
	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PortalId') AND @IsGenerateErrorLog = 1 
	BEGIN
		ALTER TABLE ##Promotions ADD PortalId INT

		UPDATE P
		SET P.PortalId = CASE WHEN LTRIM(TRIM(P.Store))='All Stores' THEN NULL ELSE ISNULL(ZP.PortalId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodePortal ZP ON P.Store=ZP.StoreCode
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProfileId') AND @IsGenerateErrorLog = 1 
	BEGIN
		ALTER TABLE ##Promotions ADD ProfileId INT

		UPDATE P
		SET P.ProfileId = CASE WHEN LTRIM(TRIM(P.Profile))='All Profiles' THEN NULL ELSE ISNULL(ZP.ProfileId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodeProfile ZP ON P.Profile=ZP.DefaultExternalAccountNo
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PromotionTypeId')
	BEGIN
		ALTER TABLE ##Promotions ADD PromotionTypeId INT
		UPDATE ##Promotions
		SET PromotionTypeId = @PromotionTypeId
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='IsUnique')
	BEGIN
		ALTER TABLE ##Promotions ADD IsUnique BIT
		UPDATE ##Promotions
		SET IsUnique = 0
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='InitialQuantity')
	BEGIN
		ALTER TABLE ##Promotions ADD InitialQuantity FLOAT
		UPDATE ##Promotions
		SET InitialQuantity = AvailableQuantity
	END

	UPDATE ##Promotions
	SET IsCouponRequired=0
	WHERE ISNULL(IsCouponRequired,'')='' OR ISNULL(IsCouponRequired,'')='No';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=0
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='' OR ISNULL(IsAllowedWithOtherCoupons,'')='No';

	UPDATE ##Promotions
	SET IsCouponRequired=1
	WHERE ISNULL(IsCouponRequired,'')='Yes';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=1
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='Yes';

	-- Code for not consider Discount Information for specific Promotion Type
	DECLARE @PromotionTypeName NVARCHAR(50);

	SELECT TOP 1 @PromotionTypeName = [Name] FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId;

	IF @PromotionTypeName IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price')
	BEGIN
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, PromotionMessage='';
	END
	ELSE IF @PromotionTypeName IN ('Call For Pricing')
	BEGIN
		SET @SSQL='
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, 
			PromotionMessage = '+CASE WHEN @IsGenerateErrorLog = 1 THEN ' CallForPriceMessage ' ELSE 'PromotionMessage' END;
		
		EXEC (@SSQL);
	END
	
	BEGIN TRAN Promotions;
	BEGIN TRY
		-- Start Functional Validation
		-----------------------------------------------
		IF @IsGenerateErrorLog = 1 
		BEGIN
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.PromoCode,'')=''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '82', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.PromoCode))) > 300 AND ISNULL(ii.PromoCode,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.[Name],'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.[Name]))) > 100 AND ISNULL(ii.[Name],'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Description', Description, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Description))) > 100 AND ISNULL(ii.Description,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.StartDate)=0 AND LEN(ii.StartDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '150', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)<CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),111),111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '151', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.StartDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.EndDate)=0 AND LEN(ii.EndDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '152', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.EndDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
		
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNULL(ii.DisplayOrder,0)=0 OR ISNULL(ii.DisplayOrder,'')='')
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '149', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNUMERIC(ii.DisplayOrder)=0 AND LEN(ii.DisplayOrder)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DisplayOrder)=1 AND (CAST(ii.DisplayOrder As INT))>999)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '120', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')<>''
				AND NOT EXISTS (SELECT * FROM ZnodePortal WHERE PortalId=ii.PortalId)
				AND ISNULL(ii.Store,'')<>'All Stores'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '157', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')<>''
				AND EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode AND ISNULL(PortalId,0)<>ISNULL(ii.PortalId,0))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '153', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')<>''
				AND (NOT EXISTS (SELECT * FROM ZnodePortalProfile WHERE ProfileId=ii.ProfileId AND PortalId=ii.PortalId)
					AND ISNULL(ii.Store,'')<>'All Stores')
				OR (NOT EXISTS (SELECT * FROM ZnodeProfile WHERE DefaultExternalAccountNo=ii.Profile)
					AND ISNULL(ii.Profile,'')<>'All Profiles' AND ISNULL(ii.Profile,'')<>'')

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Profile))) > 100 AND ISNULL(ii.Profile,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			IF @PromotionTypeName NOT IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price','Call For Pricing')
			BEGIN
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsCouponRequired', IsCouponRequired, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '154', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') IN ('True','1','Yes')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.PromotionMessage,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '82', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.PromotionMessage,'')<>'' AND LEN(LTRIM(RTRIM(ii.PromotionMessage)))>300)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '138', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
					AND EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code=ii.Code)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '139', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.Code,'')<>'' AND LEN(LTRIM(RTRIM(ii.Code)))>20)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '8', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')=''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '108', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=0)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '141', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ii.AvailableQuantity) LIKE '%.%')
					--(ISNUMERIC(ii.AvailableQuantity)=1 AND LEN(PARSENAME(ii.AvailableQuantity,1))>1)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '140', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)<0 OR ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)>9999))
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
			END
		END 

		IF @IsGenerateErrorLog = 1 
		BEGIN
			DECLARE @Query NVARCHAR(MAX);

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='DiscountAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''109'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((ISNUMERIC(ii.DiscountAmount)=0 AND LEN(ii.DiscountAmount)>0) OR CAST(ii.DiscountAmount As FLOAT)<0)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (LEN(PARSENAME(ii.DiscountAmount,1))>2 AND (ii.DiscountAmount) LIKE ''%.%'' AND CAST(ii.DiscountAmount As FLOAT)>0))
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (CAST(ii.DiscountAmount As FLOAT))>100)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.DiscountAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumQuantity')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''108'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=0 AND LEN(ii.MinimumQuantity)>0) OR CAST(ii.MinimumQuantity As FLOAT)<0

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''141'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (ii.MinimumQuantity) LIKE ''%.%'')

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (CAST(ii.MinimumQuantity As FLOAT))>100)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumQuantity,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumOrderAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''109'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((ISNUMERIC(ii.MinimumOrderAmount)=0 AND LEN(ii.MinimumOrderAmount)>0) OR CAST(ii.MinimumOrderAmount As FLOAT)<0)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (LEN(PARSENAME(ii.MinimumOrderAmount,1))>2 AND (ii.MinimumOrderAmount) LIKE ''%.%'' AND CAST(ii.MinimumOrderAmount As FLOAT)>0))

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (CAST(ii.MinimumOrderAmount As FLOAT))>100)
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumOrderAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END
		
			IF EXISTS (SELECT TOP 1 1 FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='CallForPriceMessage')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''CallForPriceMessage'', CallForPriceMessage, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.CallForPriceMessage))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''143'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD INNER JOIN ZnodePortalBrand PB ON BD.BrandId = PB.BrandId AND PB.PortalId = ii.PortalId WHERE BD.BrandCode=ii.Brand)
					AND ISNULL(ii.Brand,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD WHERE BD.BrandCode=ii.Brand) AND ISNULL(ii.Brand,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Brand))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''144'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCatalog PC
									INNER JOIN ZnodePimCatalog PbC ON PC.PimCatalogId=PbC.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PbC.pimCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE PC.CatalogCode = ii.Catalog)
					AND ISNULL(ii.Catalog,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCatalog PC WHERE PC.CatalogCode = ii.Catalog) AND ISNULL(ii.Catalog,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Catalog))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''145'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCategory PC
									INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PC.PimCategoryId=PCAV.PimCategoryId
									INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL ON PCAV.PimCategoryAttributeValueId=PCAVL.PimCategoryAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PC.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PCt ON PCH.PimCatalogId=PCt.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PCt.PImCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE LocaleId='+@LocaleId1+' AND PCAVL.CategoryValue=ii.Category)
					AND ISNULL(ii.Category,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCategoryAttributeValueLocale PCAVL WHERE PCAVL.CategoryValue=ii.Category) AND ISNULL(ii.Category,'''')<>'''')
				
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Category))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''148'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodeShipping SP
									INNER JOIN ZnodePortalShipping PS ON SP.ShippingId=PS.ShippingId
									WHERE SP.ShippingCode=ii.Shipping AND PS.PortalId=ii.PortalId)
					AND ISNULL(ii.Shipping,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeShipping SP WHERE SP.ShippingCode=ii.Shipping) AND ISNULL(ii.Shipping,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Shipping))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.ProductToDiscount AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.ProductToDiscount) AND ISNULL(ii.ProductToDiscount,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.ProductToDiscount))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''% %'')
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.RequiredProduct AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.RequiredProduct,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.RequiredProduct) AND ISNULL(ii.RequiredProduct,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.RequiredProduct))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''% %'')
					AND ISNULL(ii.RequiredProduct,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName --+ ' [ Promotion - ' + ISNULL(PromoCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN ##Promotions IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			--Delete Invalid Data after functional validation
			DELETE FROM ##Promotions
			WHERE RowNumber IN
			(
				SELECT DISTINCT RowNumber
				FROM ZnodeImportLog
				WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
			);

			-- Update Record count in log
			DECLARE @FailedRecordCount BIGINT;
			DECLARE @SuccessRecordCount BIGINT;

			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber)
			FROM ZnodeImportLog 
			WHERE RowNumber IS NOT NULL AND ImportProcessLogId = @ImportProcessLogId;

			SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) 
			FROM ##Promotions

			UPDATE ZnodeImportProcessLog
			SET FailedRecordcount = @FailedRecordCount ,
				SuccessRecordCount = @SuccessRecordCount ,
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END

		--To identify duplicate records
		IF OBJECT_ID('tempdb..#DuplicatePromotionsData') IS NOT NULL
			DROP TABLE #DuplicatePromotionsData;

		SELECT PromoCode,RowId,ROW_NUMBER() OVER (PARTITION BY PromoCode ORDER BY RowId DESC) As Rn
		INTO #DuplicatePromotionsData
		FROM ##Promotions;

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'DiscountAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.DiscountAmount'', ''Discount'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
			PRINT @Query
		END
		
		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumQuantity'', ''QuantityMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumOrderAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumOrderAmount'', ''OrderMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'ProductQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.ProductQuantity'', ''PromotionProductQuantity'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--For Update Promotions Data
		DECLARE @UpdateColumns NVARCHAR (MAX);

		IF @IsGenerateErrorLog = 1 
		BEGIN
			SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=CASE WHEN ISNULL(P.'+COLUMN_NAME+','''')='''' THEN ZP.'+COLUMN_NAME+' ELSE P.'+COLUMN_NAME+' END'),',')
			--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME='ZnodePromotion'
				AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
				AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsCouponRequired','IsAllowedWithOtherCoupons','IsUnique','ProfileId','PortalId')
				--AND COLUMN_NAME NOT IN ('DiscountAmount','MinimumQuantity','MinimumOrderAmount');
         END
		 ELSE
		 BEGIN 
			SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=CASE WHEN ISNULL(P.'+COLUMN_NAME+','''')='''' THEN P.'+COLUMN_NAME+' ELSE P.'+COLUMN_NAME+' END'),',')
			--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME='ZnodePromotion'
				AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
				AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsUnique','ProfileId')
				-- AND COLUMN_NAME NOT IN ('DiscountAmount','MinimumQuantity','MinimumOrderAmount');
		END

		IF OBJECT_ID('tempdb..#UpdatedPromotions') IS NOT NULL
			DROP TABLE #UpdatedPromotions;

		CREATE TABLE #UpdatedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		SET @Query='
		UPDATE ZP SET '+@UpdateColumns+'
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #UpdatedPromotions (PromotionId, PromoCode, PromotionTypeId)
		FROM ##Promotions P
		INNER JOIN ZnodePromotion ZP ON LTRIM(RTRIM(P.PromoCode)) = ZP.PromoCode
		INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
		'
		EXEC SP_EXECUTESQL @Query;

		--For Insert Promotions Data
		DECLARE @MatchesColumns NVARCHAR (MAX);

		SELECT @MatchesColumns=STRING_AGG(COLUMN_NAME,',') FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME='ZnodePromotion'
			AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
			AND COLUMN_NAME NOT IN ('ProfileId');

		IF OBJECT_ID('tempdb..#InsertedPromotions') IS NOT NULL
			DROP TABLE #InsertedPromotions;

		CREATE TABLE #InsertedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		-- Import New Promotions
		SET @MatchesColumns='
		INSERT INTO ZnodePromotion
			('+@MatchesColumns+',CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			)
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #InsertedPromotions (PromotionId, PromoCode, PromotionTypeId)
		SELECT DISTINCT P.'+@MatchesColumns+','+CAST(@UserId AS VARCHAR(15))+',GETDATE(),'+CAST(@UserId AS VARCHAR(15))+',GETDATE()
		FROM ##Promotions P
		INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode = LTRIM(RTRIM(P.PromoCode)))
		'

		EXEC SP_EXECUTESQL @MatchesColumns;

		DECLARE @checkTable TABLE (Code VARCHAR(1000) , valued NVARCHAR(max))

		DECLARE @InsertData int = 1 
		IF @IsGenerateErrorLog = 0  
		BEGIN 
		    
			SET @InsertData= CASE WHEN NOT EXISTS (SELECT TOP 1 1  FROM #UpdatedPromotions)  THEN 1 ELSE 0 END 
 
			INSERT INTO #InsertedPromotions (PromotionId,PromoCode,PromotionTypeId)
			SELECT PromotionId,PromoCode,PromotionTypeId
			FROM #UpdatedPromotions a 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM #InsertedPromotions b WHERE b.PromoCode = a.PromoCode)

			DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )

			DELETE FROM ZnodePromotionCoupon WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )

			IF @PromotionTypeName IN ('Percent Off X If Y Purchased','Amount Off X If Y Purchased')
			BEGIN
				DELETE FROM ZnodePromotionProduct
					WHERE PromotionId IN (SELECT PromotionId FROM #InsertedPromotions)
						AND (SELECT TOP 1 ProductToDiscount FROM ##Promotions) <> ''
			
				DELETE FROM ZnodePromotionBrand WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 brand FROM ##Promotions ) <> ''

				DELETE FROM ZnodePromotionCategory WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 category FROM ##Promotions ) <> ''

				DELETE FROM ZnodePromotionCatalogs WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 catalog FROM ##Promotions ) <> ''
				DELETE FROM ZnodePromotionShipping WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 Shipping FROM ##Promotions ) <> ''

				SET @InsertData = 1 
			END

			INSERT INTO @checkTable 
			SELECT 'brand' ,(SELECT TOP 1 brand FROM ##Promotions )
			UNION ALL 
			SELECT 'catalog' ,(SELECT TOP 1 catalog FROM ##Promotions )
			UNION ALL 
			SELECT 'category' ,(SELECT TOP 1 category FROM ##Promotions )
			UNION ALL 
			SELECT 'Shipping' ,(SELECT TOP 1 Shipping FROM ##Promotions )
			UNION ALL
			SELECT 'ProductToDiscount' ,(SELECT TOP 1 ProductToDiscount FROM ##Promotions )
			UNION ALL
			SELECT 'RequiredProduct' ,(SELECT TOP 1 RequiredProduct FROM ##Promotions )
		END 
		
		--SELECT 1 
		-- Insert for ZnodePromotionProfileMapper
		--SET @Query='
		--INSERT INTO ZnodePromotionProfileMapper
		--	(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--SELECT DISTINCT IPs.PromotionId, CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN IIF(p.Profile=0,NULL,p.Profile) ELSE    P.Profileid END ,'+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		--FROM #InsertedPromotions IPs 
		--INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		--WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper WHERE Promotionid = IPs.PromotionId AND ISNULL(Profileid,0)=CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN p.Profile ELSE    P.Profileid END )  
		--'
		--PRINT @Query 
		--EXEC SP_EXECUTESQL @Query;

		SET @Query='
		INSERT INTO ZnodePromotionProfileMapper
			(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
				WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0))
		'
		EXEC SP_EXECUTESQL @Query;

		IF @IsGenerateErrorLog = 1
		BEGIN 
			-- Update for ZnodePromotionProfileMapper
			SET @Query='
			DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #UpdatedPromotions) AND ProfileId IS NULL

			DELETE PPM
			FROM ZnodePromotionProfileMapper PPM
			INNER JOIN #UpdatedPromotions IPs ON PPM.Promotionid = IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode AND P.ProfileId IS NULL

			INSERT INTO ZnodePromotionProfileMapper
				(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
					WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0)) AND ISNULL(P.Profile,'''')<>''''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		-- Insert for ZnodePromotionCoupon
		SET @Query='
		INSERT INTO ZnodePromotionCoupon
			(PromotionId,Code,InitialQuantity,AvailableQuantity,IsActive,IsCustomCoupon,CustomCouponCode,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT IPs.PromotionId, P.Code, P.InitialQuantity, P.AvailableQuantity, 1, 0, '''', '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
				INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
			' ELSE '' END +'
		WHERE ISNULL(P.IsCouponRequired,'''') IN (''True'',''1'',''Yes'')
			AND NOT EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code = P.Code)
		'
		EXEC SP_EXECUTESQL @Query;
	
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand' AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Brand') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, BD.BrandId, BD.BrandCode, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON (' +CASE WHEN @IsGenerateErrorLog = 1 THEN ' P.Brand=BD.BrandCode ' ELSE ' BD.BrandId IN (  '+(SELECT TOP 1 Brand FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(BD.BrandId,0)<>0   '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END 
			
			EXEC SP_EXECUTESQL @Query; 
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand' AND @IsGenerateErrorLog = 1 )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, BD.BrandId, BD.BrandCode, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON P.Brand=BD.BrandCode
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionBrand	WHERE Promotionid = IPs.PromotionId AND BrandId=BD.BrandId)
			'
			EXEC SP_EXECUTESQL @Query; 
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Catalog') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PbC.PimCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		   '+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
			INNER JOIN ZnodePimCatalog PC     ON  (  P.Catalog=PC.CatalogCode  ) 
			' ELSE '' END +'
			INNER JOIN ZnodePimcatalog PbC  ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCatalogId=PbC.PimCatalogId ' ELSE ' PbC.PimCatalogId IN (  '+(SELECT TOP 1 Catalog FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PbC.PimCatalogId,0)<>0
			'+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END 

			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PC.PimCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCatalog PC ON (P.Catalog=PC.CatalogCode) 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionCatalogs WHERE Promotionid = IPs.PromotionId AND PublishCatalogId=PC.PimCatalogId)
			'
			EXEC SP_EXECUTESQL @Query;
		END
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Category') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT  DISTINCT IPs.PromotionId, PbC.PimCategoryHierarchyId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN +'
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL  ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId 
			' ELSE '' END +'
			INNER JOIN ZnodePimCategoryHierarchy PbC ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCategoryId=PbC.PimCategoryId ' ELSE ' PbC.PimCategoryHierarchyId IN (  '+(SELECT TOP 1 Category FROM ##Promotions )+') ' END +' )
			WHERE ISNULL(PbC.PimCategoryId,0)<>0 '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END +'
			GROUP BY IPs.PromotionId,PbC.PimCategoryHierarchyId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PbC.PimCategoryHierarchyId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL  ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId 
			INNER JOIN ZnodePimCategoryHierarchy PbC ON PC.PimCategoryId=PbC.PimCategoryId
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionCategory WHERE Promotionid = IPs.PromotionId AND PublishCategoryId=PbC.PimCategoryHierarchyId)
			GROUP BY IPs.PromotionId,PbC.PimCategoryHierarchyId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping' AND @IsGenerateErrorLog = 1 ) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Shipping') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   P.Shipping=SP.ShippingCode ' ELSE ' sp.shippingId  IN (  '+(SELECT TOP 1 Shipping FROM ##Promotions )+') ' END +' ) 
			
			WHERE ISNULL(SP.ShippingId,0)<>0 
			'+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON P.Shipping=SP.ShippingCode 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionShipping WHERE Promotionid = IPs.PromotionId AND ShippingId=SP.ShippingId)
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount' AND @IsGenerateErrorLog = 1  )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'ProductToDiscount')  <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PP.PimProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.ProductToDiscount))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END + '
			INNER JOIN ZnodePimProduct PP  ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PimProductId  IN (  '+(SELECT TOP 1 ProductToDiscount FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PP.PimProductId,0)<>0 '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END +'
			GROUP BY IPs.PromotionId,PP.PimProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PP.PimProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.ProductToDiscount))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			INNER JOIN ZnodePimProduct PP  ON PAV.PimProductId=PP.PimProductId 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProduct WHERE Promotionid = IPs.PromotionId AND PublishProductId=PP.PimProductId)
			GROUP BY IPs.PromotionId,PP.PimProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct'  AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'RequiredProduct')<> '' )
		BEGIN
			SET @Query='
			UPDATE ZP
			SET ZP.PromotionProductQuantity=P.PromotionProductQuantity, ZP.ReferralPublishProductId=PP.PimProductId, ModifiedDate='''+@GetDate1+'''
			FROM ZnodePromotion ZP
			INNER JOIN #InsertedPromotions IPs ON ZP.PromotionId=IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.RequiredProduct))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END +'
			INNER JOIN ZnodePimProduct PP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PimProductId  IN (  '+(SELECT TOP 1 RequiredProduct FROM ##Promotions )+') ' END +' )  
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;


		DROP TABLE IF EXISTS ##Promotions 

		COMMIT TRAN Promotions;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Promotions

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPromotions
					@TableName = '+CAST(@TableName AS VARCHAR(MAX)) +',
					@Status='+ CAST(@Status AS VARCHAR(10))+',
					@UserId = '+CAST(@UserId AS VARCHAR(50))+',
					@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',
					@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',
					@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
					@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(MAX))+',
					@PromotionTypeId='+CAST(@PromotionTypeId AS VARCHAR(20))+',
					@IsGenerateErrorLog='+CAST(@IsGenerateErrorLog AS VARCHAR(10));

		IF @IsGenerateErrorLog = 1
		BEGIN
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
			UPDATE ZnodeImportProcessLog 
			SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , 
				SuccessRecordCount = 0,
				TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPromotions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCatalogCategorySEODetail')
	DROP PROC Znode_GetCatalogCategorySEODetail
GO

CREATE PROCEDURE [dbo].[Znode_GetCatalogCategorySEODetail]
(
	  @WhereClause      VARCHAR(MAX),
	  @Rows             INT           = 100,
	  @PageNo           INT           = 1,
	  @Order_BY         VARCHAR(1000) = '',
	  @RowsCount        INT OUT,
	  @LocaleId         INT           = 1,
	  @PortalId         INT
)
AS
BEGIN
	SET NOCOUNT ON;

	Declare @PimCatalogId INT, @SQL VARCHAR(MAX), @DefaultLocaleId VARCHAR(20)= dbo.Fn_GetDefaultLocaleId()

	SELECT @PimCatalogId = ZPC.PublishCatalogId 
	FROM ZnodePortalCatalog ZPC WHERE PortalId = @PortalId


	IF OBJECT_ID('TEMPDB..#CategoryDetail') IS NOT NULL
		DROP TABLE #CategoryDetail

	IF OBJECT_ID('TEMPDB..##TempCategoryDetail') IS NOT NULL
		DROP TABLE ##TempCategoryDetail

		IF OBJECT_ID('TEMPDB..#znodeCatalogCategory') IS NOT NULL
		DROP TABLE #znodeCatalogCategory

	SELECT PimCategoryId, CategoryName, CategoryCode, LocaleId
	INTO #CategoryDetail
	FROM
	(
		SELECT ZPCAV.PimCategoryId,ZPA.AttributeCode,ZPCAVL.CategoryValue, ZPCAVL.LocaleId 
		FROM ZnodePimCategoryAttributeValue ZPCAV
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId
		where ZPA.AttributeCode in ( 'CategoryName', 'CategoryCode')
	)TB PIVOT(MAX(CategoryValue) FOR AttributeCode in ( CategoryName, CategoryCode))AS PVT
	
	

	SET @SQL = '

	select distinct ZPCH.PimCatalogId,ZPCP.PimCategoryId into #znodeCatalogCategory
	FROm ZnodePimCategoryProduct ZPCP
	Inner Join ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId AND ZPCH.PimCatalogId = '+CAST(@PimCatalogId AS VARCHAR(10))+'

	;With CTE_CategoryDetail AS
	(
		SELECT DISTINCT PC.PimCatalogId, PC.CatalogName, CD.PimCategoryId, CD.CategoryCode, CD.CategoryName , ISNULL(CSD.SEOCode,CD.CategoryCode) as SEOCode , CSD.SEOUrl, CSDL.SEOTitle, CSDL.SEODescription, CSDL.SEOKeywords,
		case when  ZPPO.DisplayName IS NULL THEN '''' ELSE ZPPO.DisplayName END IsPublish , ActivationDate , ExpirationDate, 
		CH.IsActive, CD.LocaleId, CSDL.CanonicalURL, CSDL.RobotTag
		FROM #CategoryDetail CD
		INNER JOIN ZnodePimCategory ZPC ON (ZPC.PimCategoryId = CD.PimCategoryId)
		INNER JOIN  #znodeCatalogCategory PCC on CD.PimCategoryId = PCC.PimCategoryId
		INNER JOIN ZnodePimCatalog PC on PCC.PimCatalogId = PC.PimCatalogId
		LEFT JOIN ZnodePimCategoryHierarchy CH ON (CH.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodeCMSSEOType CST ON CST.Name = ''Category''
		LEFT JOIN ZnodeCMSSEODetail CSD on CD.CategoryCode = CSD.SEOCode and CSD.CMSSEOTypeId = CST.CMSSEOTypeId AND CSD.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
		LEFT JOIN ZnodeCMSSEODetailLocale CSDL ON  CSD.CMSSEODetailId = CSDL.CMSSEODetailId AND CSDL.LocaleId =  '+CAST(@LocaleId AS VARCHAR(10))+'
		LEFT JOIN ZnodePublishState ZPPO ON (ZPPO.PublishStateId = CSD.PublishStateId)
		WHERE PCC.PimCatalogId = '+CAST(@PimCatalogId AS VARCHAR(10))+' AND CD.LocaleId IN ('+CAST(@LocaleId AS VARCHAR(50))+', '+CAST(@DefaultLocaleId AS VARCHAR(50))+') 
			AND PC.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
	)
	,CTE_CategoryDetail_SEO AS
	(
		SELECT DISTINCT null as PimCatalogId, '''' CatalogName, CD.PimCategoryId, CD.CategoryCode, CD.CategoryName , ISNULL(CSD.SEOCode,CD.CategoryCode) as SEOCode , CSD.SEOUrl, CSDL.SEOTitle, CSDL.SEODescription, CSDL.SEOKeywords,
		case when  ZPPO.DisplayName IS NULL THEN '''' ELSE ZPPO.DisplayName END IsPublish , ActivationDate , ExpirationDate, 
		CH.IsActive, CD.LocaleId, CSDL.CanonicalURL, CSDL.RobotTag
		FROM #CategoryDetail CD
		INNER JOIN ZnodePimCategory ZPC ON (ZPC.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodePimCategoryHierarchy CH ON (CH.PimCategoryId = CD.PimCategoryId)
		LEFT JOIN ZnodeCMSSEOType CST ON CST.Name = ''Category''
		LEFT JOIN ZnodeCMSSEODetail CSD on CD.CategoryCode = CSD.SEOCode and CSD.CMSSEOTypeId = CST.CMSSEOTypeId AND CSD.PortalId = '+CAST(@PortalId AS VARCHAR(10))+'
		LEFT JOIN ZnodeCMSSEODetailLocale CSDL ON  CSD.CMSSEODetailId = CSDL.CMSSEODetailId AND CSDL.LocaleId =  '+CAST(@LocaleId AS VARCHAR(10))+'
		LEFT JOIN ZnodePublishState ZPPO ON (ZPPO.PublishStateId = CSD.PublishStateId)
		WHERE CD.LocaleId IN ('+CAST(@LocaleId AS VARCHAR(50))+', '+CAST(@DefaultLocaleId AS VARCHAR(50))+') AND CH.PimCatalogId = '+CAST(@PimCatalogId AS VARCHAR(10))+'
		AND NOT EXISTS(select * from CTE_CategoryDetail CDC where CD.PimCategoryId = CDC.PimCategoryId )
	)
	,CTE_CategoryDetail_Locale as
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, LocaleId, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail CD
		WHERE CD.LocaleId ='+CAST(@LocaleId AS VARCHAR(50))+'
		union ALL
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, LocaleId, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_SEO CD
		WHERE CD.LocaleId ='+CAST(@LocaleId AS VARCHAR(50))+'
	)
	,CTE_CategoryDetail_BothLocale as
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_Locale
		Union All
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail CDS
		WHERE LocaleId ='+CAST(@DefaultLocaleId AS VARCHAR(50))+' AND
			NOT EXISTS( SELECT TOP 1 1 FROM CTE_CategoryDetail_Locale CSD1
						WHERE CDS.PimCategoryId = CSD1.PimCategoryId AND CDS.CatalogName = CSD1.CatalogName )
		Union All
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag
		FROM CTE_CategoryDetail_SEO CDS2
		WHERE LocaleId ='+CAST(@DefaultLocaleId AS VARCHAR(50))+' AND
			NOT EXISTS( SELECT TOP 1 1 FROM CTE_CategoryDetail_Locale CSD1
						WHERE CDS2.PimCategoryId = CSD1.PimCategoryId AND CDS2.CatalogName = CSD1.CatalogName )
	)
	,CTE_CategoryDetail_WhereClause AS
	(
		SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag, '+[dbo].[Fn_GetPagingRowId](@Order_BY, 'PimCategoryId')+',Count(*)Over() CountId
		FROM CTE_CategoryDetail_BothLocale CD
		WHERE 1 = 1 '+CASE WHEN @WhereClause = '' THEN '' ELSE ' AND '+@WhereClause END +'
	)
	SELECT PimCatalogId, CatalogName, PimCategoryId, CategoryCode,CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag, CountId
	INTO ##TempCategoryDetail
	FROM CTE_CategoryDetail_WhereClause
	'+[dbo].[Fn_GetPaginationWhereClause](@PageNo, @Rows);
	print @SQL
	EXEC (@SQL)

	SET @RowsCount = ISNULL((SELECT TOP 1 CountId FROM ##TempCategoryDetail ),0)

	SELECT  PimCategoryId, CategoryName, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish, ActivationDate,ExpirationDate,IsActive, CanonicalURL, RobotTag 
	FROM ##TempCategoryDetail

	IF OBJECT_ID('TEMPDB..#CategoryDetail') IS NOT NULL
		DROP TABLE #CategoryDetail

	IF OBJECT_ID('TEMPDB..##TempCategoryDetail') IS NOT NULL
		DROP TABLE ##TempCategoryDetail

	IF OBJECT_ID('TEMPDB..#znodeCatalogCategory') IS NOT NULL
	DROP TABLE #znodeCatalogCategory

END

GO

IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishCatalogLog' AND COLUMN_NAME = 'PublishType')
BEGIN
	ALTER TABLE ZnodePublishCatalogLog ADD PublishType VARCHAR (500) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCatalogList')
	DROP PROC Znode_GetCatalogList
GO


CREATE PROCEDURE [dbo].[Znode_GetCatalogList]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetCatalogList '',100,1,'',0
	  EXEC  Znode_GetCatalogList null,100,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_CatalogId TABLE (PimCatalogId int, PublishCatalogLogId int,CatalogName VARCHAR(max),PublishStatus VARCHAR(300),RowId INT ,CountId INT,PublishCreatedDate DATETIME ,PublishModifiedDate DATETIME,PublishCategoryCount INT ,PublishProductCount INT, IsActive BIT, CatalogCode  nvarchar(100))
	 
		 SET @SQL = '

		;With Cte_MaxPublish AS 
		(
			 SELECT max(PublishCatalogLogId) PublishCatalogLogId,PimCatalogId
			 FROM ZnodePublishCatalogLog ZPCL   
			 WHERE ZPCL.PublishType=''Catalog'' OR ZPCL.PublishType IS NULL 
			 GROUP BY PimCatalogId
		)
		,Cte_CatalogLog AS (
		SELECT ZPC.CatalogName CatalogName, PublishCatalogLogId PublishCatalogLogId,  TYU.DisplayName   PublishStatus ,ZPC.PimCatalogId
		,ZPCL.CreatedDate AS PublishCreatedDate,ZPCL.ModifiedDate AS PublishModifiedDate,
		ISNULL(ZPCL.PublishCategoryId,0)PublishCategoryCount,ISNULL(ZPCL.PublishProductId,0) PublishProductCount,ZPC.IsActive, ZPC.CatalogCode
		FROM ZnodePimCatalog ZPC 
		LEFT JOIN ZnodePublishCatalogLog ZPCL  ON ( EXISTS (SELECT TOP 1 1 FROM Cte_MaxPublish CTE 											
		WHERE CTE.PimCatalogId = ZPC.PimCatalogId AND CTE.PublishCatalogLogId =  ZPCL.PublishCatalogLogId) )	
		LEFT JOIN ZnodePublishState TYU ON (TYU.PublishStateId = ZPCL.PublishStateId )
		
		)
	     ,Cte_PublishStatus 
		 AS (
		 SELECT PimCatalogId, PublishCatalogLogId, CatalogName, PublishStatus,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive,CatalogCode,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'PublishCatalogLogId DESC')+' , Count(*)Over() CountId FROM Cte_CatalogLog
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT PimCatalogId, PublishCatalogLogId,CatalogName,PublishStatus,RowId,CountId,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive,CatalogCode
		 FROM Cte_PublishStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	

	     PRINT @sql 
		 INSERT INTO @TBL_CatalogId 
		 EXEC (@SQL)

		 SELECT  PimCatalogId,PublishCatalogLogId,CatalogName,PublishStatus,PublishCreatedDate,PublishModifiedDate,PublishCategoryCount,PublishProductCount,IsActive, CatalogCode
		 FROM @TBL_CatalogId

		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_CatalogId),0)
	 

	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCatalogList @WhereClause = '''+ISNULL(@WhereClause,'''''')+''',@Rows='+ISNULL(CAST(@Rows AS
			VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetCatalogList',
					@ErrorInProcedure = 'Znode_GetCatalogList',
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPromotionPublishProduct')
	DROP PROC Znode_GetPromotionPublishProduct
GO

CREATE PROCEDURE [dbo].[Znode_GetPromotionPublishProduct]
( @WhereClause NVarchar(Max)  = '',
  @Rows        INT            = 100,
  @PageNo      INT            = 1,
  @Order_BY VARCHAR(1000)	  = '',
  @RowsCount   INT OUT,
  @LocaleId    int = 0,
  @PromotionId    int = 0
 )
AS

/*
 Summary : This Procedure is used to get PromotionPublishProduct  
 Unit Testing
 EXEC [Znode_GetPromotionPublishProduct]  @RowsCount = 0
 
*/
     BEGIN
		
         SET NOCOUNT ON;
         BEGIN TRY
		  DECLARE @SQL NVARCHAR(MAX);
		  DECLARE @TBL_GetPromotionPublishProduct   TABLE (PublishProductId INT,ProductName NVARCHAR(4000),SKU NVARCHAR(4000),CatalogName VARCHAR(max),RowId INT,CountNo INT )
		   SET @SQL = CONCAT ('
		   ;WITH CTE_PromotionPublishProduct AS
		   (
			SELECT distinct ZPCP.ZnodeProductId PublishProductId,ZPCP.Name as name,ZPCP.SKU,ZPC.CatalogName
			FROM ZnodePublishProductEntity ZPCP with(nolock)
			INNER JOIN ZnodePimCatalog ZPC ON (ZPC.PimCatalogId = ZPCP.ZnodecatalogId )
		    where ZPCP.LocaleId = ',@LocaleId,'
		   )
		   , CTE_PromotionPublishProductList AS
		   (
		   SELECT PublishProductId,name,SKU,CatalogName,',dbo.Fn_GetPagingRowId(@Order_BY,'PublishProductId DESC'),',Count(*)Over() CountNo
		   FROM CTE_PromotionPublishProduct
		   WHERE 1=1 
		   ',dbo.Fn_GetFilterWhereClause(@WhereClause),'	
		   )
		   SELECT PublishProductId,name,SKU,CatalogName,RowId,CountNo
		   FROM CTE_PromotionPublishProductList
		    ',dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows))

		print @SQL;
		INSERT INTO @TBL_GetPromotionPublishProduct
		EXEC(@SQL);

		SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_GetPromotionPublishProduct), 0);

		SELECT PublishProductId,ProductName Name,SKU,CatalogName , @PromotionId PromotionId
		FROM @TBL_GetPromotionPublishProduct
		
		
		END TRY
		BEGIN CATCH
			DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPromotionPublishProduct @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPromotionPublishProduct',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		END CATCH
	END









GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishStatus')
	DROP PROC Znode_GetPublishStatus
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishStatus]
(
	@WhereClause NVARCHAR(MAX),
    @Rows        INT           = 100,
    @PageNo      INT           = 1,
    @Order_BY    VARCHAR(100)  = '',
    @RowsCount   INT OUT
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  Znode_GetPublishStatus_TP '',10,1,'',0
*/
   BEGIN 
		BEGIN TRY 
		SET NOCOUNT ON 

		 DECLARE @SQL  NVARCHAR(max) 
		 DECLARE @TBL_CatalogId TABLE (PublishCatalogLogId INT,PublishStatus VARCHAR(300),UserName NVARCHAR(512),PublishCategoryCount INT ,PublishProductCount INT ,CreatedDate DATETIME ,ModifiedDate DATETIME ,RowId INT ,CountId INT)
	 
		 SET @SQL = '

		  DECLARE @TBL_PublishProductId TABLE (PublishProductId int,PublishCatalogId int )
		INSERT INTO @TBL_PublishProductId
		SELECT COUNT( DISTINCT PublishProductId ),PublishCatalogId
		FROM ZnodePublishCategoryProduct a
		WHERE PublishCatalogId IN  (select PublishCatalogId from ZnodePublishCatalog b where a.PublishCatalogId = b.PublishCatalogId)
		AND a.PublishCategoryId  <> 0 and a.PublishCategoryId is not null
		GROUP BY PublishCatalogId 


		 ;With Cte_CatalogLog AS
		 (
		 SELECT PublishCatalogLogId,CASE WHEN IsCatalogPublished IS NULL THEN ''Processing'' WHEN IsCatalogPublished = 0 THEN ''Publish Failed''
         WHEN IsCatalogPublished = 1 THEN  ''Published Successfully'' END   PublishStatus ,APZU.UserName ,ISNULL(ZPCL.PublishCategoryId,0) PublishCategoryCount,
		 ISNULL(ZPCL.PublishProductId,0) PublishProductCount,ZPCL.CreatedDate,ZPCL.ModifiedDate ,PimCatalogId
	     FROM ZnodePublishCatalogLog  ZPCL 
		 LEFT JOIN ZnodeUser ZU ON (ZU.UserId = ZPCL.CreatedBy )
	     LEFT JOIN AspNetUsers APU ON (APU.Id = ZU.AspNetUserId) 
		 LEFT JOIN AspNetZnodeUser APZU ON (APZU.AspNetZnodeUserId = APU.UserName)
		 LEFT JOIN  @TBL_PublishProductId a on (zpcl.PublishCatalogId = a.PublishCatalogId)
		 WHERE ZPCL.PublishType = ''Catalog'' OR ZPCL.PublishType IS NULL  
		 )
	 
	     ,Cte_PublishStatus 
		 AS (SELECT PublishCatalogLogId, PublishStatus ,UserName , PublishCategoryCount, PublishProductCount,CreatedDate,ModifiedDate ,
		 '+[dbo].[Fn_GetPagingRowId](@Order_BY,'PublishCatalogLogId DESC')+' , Count(*)Over() CountId FROM Cte_CatalogLog
         WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+' )
	 
		 SELECT PublishCatalogLogId,PublishStatus,UserName,PublishCategoryCount,PublishProductCount,CreatedDate,ModifiedDate,RowId,CountId 
		 FROM Cte_PublishStatus 
		 '+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	
		 PRINT @SQL
		 INSERT INTO @TBL_CatalogId
		 EXEC (@SQL)

		 SELECT  PublishCatalogLogId,PublishStatus,UserName,PublishCategoryCount,PublishProductCount,CreatedDate,ModifiedDate
		 FROM @TBL_CatalogId

		 SET @RowsCount = ISNULL((SELECT TOP 1 COUNTID FROM @TBL_CatalogId),0)
	 
		 END TRY 
		 BEGIN CATCH 
			DECLARE @Status BIT ;
			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishStatus @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
			EXEC Znode_InsertProcedureErrorLog
					@ProcedureName = 'Znode_GetPublishStatus',
					@ErrorInProcedure = @Error_procedure,
					@ErrorMessage = @ErrorMessage,
					@ErrorLine = @ErrorLine,
					@ErrorCall = @ErrorCall;
		 END CATCH 
   END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder 
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  rt.ParentPimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder 
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
INNER JOIN  @PimProduct_catalog rt ON ( rt.ParentPimCategoryHierarchyId = ty.PimCategoryHierarchyId  )
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = rt.ParentPimCategoryHierarchyId)
AND @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT  , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  

UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,1), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT PimCategoryId FROM  #Temp_categoryDetails ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleProductEntity')
	DROP PROC Znode_PublishSingleProductEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleProductEntity]
(
    @PimProductId TransferId READONLY
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAutoPublish bit = 0 
   ,@ImportGUID Varchar(500) = '' 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	DECLARE @PimProductIdIn INT , @PimCatalogId INT 

	SET @ImportGUID = CASE WHEN @ImportGUID = '' THEN CAST( NEWID() AS VARCHAR(200)) ELSE @ImportGUID END 

	DECLARE @PimCatalogProduct TABLE (PimProductId INT , IsDeleted BIT,  ZnodecatalogId INT  , VersionId INT )
	IF EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	)
	BEGIN 



	DECLARE Cur_CatalogProduct CURSOR FOR 
	SELECT DISTINCT PimProductId, b.PimCatalogId
	FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	OPEN Cur_CatalogProduct 

	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId

	WHILE @@FETCH_STATUS=0 
	BEGIN 

	INSERT INTO @PimCatalogProduct 
	EXEC Znode_PublishCatalogEntity @PimCatalogId= @PimCatalogId
									,@RevisionState =@RevisionType
									,@UserId =@UserId
									,@NewGUID = @ImportGUID
									,@IsDraftProductsOnly = 0 
									,@PimProductId =@PimProductIdIn
									,@PimCategoryHierarchyId = 0 



	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId
	END 
	CLOSE Cur_CatalogProduct
	DEALLOCATE Cur_CatalogProduct 

	   	  
	SET @Status =1 

	END 
	ELSE 
	BEGIN 


	SET @Status = 0 
	END 


	SELECT * 
	FROM ZnodePublishProductEntity a with (nolock)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimCatalogProduct r WHERE r.VersionId = a.VersionId AND r.PimProductId = a.ZnodeProductId AND r.IsDeleted = 0)

	SELECT PimProductId ZnodeProductId , IsDeleted ,  ZnodecatalogId   , VersionId 
	FROM @PimCatalogProduct 
	WHERE IsDeleted =1 


	UPDATE ZnodePublishProgressNotifierEntity 
	SET IsCompleted = 1 ,ProgressMark = 100 
	WHERE JobId = @ImportGUID

	SELECT 0 AS id,@Status AS Status;   

	DELETE FROM ZnodePublishProgressNotifierEntity  	WHERE JobId = @ImportGUID

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleProductEntity
		@PimProductIds = '',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleProductErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleProductEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleProductEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson
GO


CREATE    PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
DECLARE @pimProductId_loop TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId 
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,b.IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID

WHILE EXISTS (SELECT TOP 1 1 FROM #pimProductIds ) 
BEGIN 
DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

INSERT INTO @pimProductId_loop
SELECT  PimProductId 
FROM #pimProductIds 

SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  @pimProductId_loop t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN @pimProductId_loop b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @pimProductId_loop b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN @pimProductId_loop bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @pimProductId_loop n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)


IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   
   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValue 
   SELECT PimProductId, PimAttributeId , AttributeValue, CustomCode ,  IsDefaultValue , m.LocaleId
   FROM #tbl_AttributeValue a 
   CROSS APPLY @LocaleIds_distinct m

   UPDATE a
   SET a.AttributeValue = aa.AttributeValue
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE a.LocaleId <> @DefaultLocaleId


   UPDATE a
   SET a.AttributeValue = aa.AttributeValue
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE a.LocaleId <> @DefaultLocaleId
 
   INSERT INTO #default_value 
   SELECT PimProductId ,PimAttributeId,  Code , m.LocaleId	, Value,DisplayOrder,IsEditable,SwatchText,Path,PimAttributeDefaultValueId,VariantSKU,VariantDisplayOrder
   FROM #default_value a 
   CROSS APPLY @LocaleIds_distinct m

   UPDATE a
   SET Value = bc.AttributeDefaultValue
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId
   



END 


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID




UPDATE ZnodePublishProductEntity
SET Attributes = 
 (

SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(a.AttributeValue,'') AttributeValues
				,ISNULL((
				   SELECT DISTINCT  Code,LocaleId,Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   WHERE nt.PimProductId = a.PimProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId = ZnodePublishProductEntity.LocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = ZnodePublishProductEntity.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =ZnodePublishProductEntity.LocaleId)
WHERE a.PimProductId = ZnodePublishProductEntity.ZnodeProductId AND a.LocaleId = ZnodePublishProductEntity.LocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
) 
WHERE PublishProductEntityId  IN (SELECT PublishProductEntityId FROM #PublishProductEntityId)


UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValue ty ON ( ty.PimProductId = a.ZnodeProductId  )
WHERE PublishProductEntityId  IN (SELECT PublishProductEntityId FROM #PublishProductEntityId)
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct t WHERE t.LocaleId = a.LocaleId AND ty.LocaleId = t.LocaleId )
AND ty.PimAttributeId IN (SELECT w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')
	
	DELETE FROM #pimProductIds WHERE PimProductId IN (SELECT PImProductId FROM @pimProductId_loop)
	DELETE FROM @pimProductId_loop
END 

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishWidgetSliderBannerEntity')
	DROP PROC Znode_SetPublishWidgetSliderBannerEntity
GO


CREATE  PROCEDURE [dbo].[Znode_SetPublishWidgetSliderBannerEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@PreviewVersionId INT = 0 
  ,@IsPreviewEnable int = 0 
  ,@ProductionVersionId INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@CMSContentPagesId int = 0
  ,@CMSSliderId INT = 0 
  ,@UserId int = 0 
  ,@Status int = 0 OUTPUT 
)
AS
/*
    This Procedure is used to publish the slider banner widgets,
	This sp get call for catalog publish , store , and slider 
	  
	EXEC ZnodeSetPublishWidgetSliderBannerEntity 1 2,3
	A. 
		1. Preview - Preview
		2. None    - Production   --- 
		3. Production - Preview/Production
	B.
		select * from ZnodePublishStateApplicationTypeMapping
		select * from ZnodePublishState where PublishStateId in (3,4) 
		select * from ZnodePublishPortalLog 
	C.
		Select * from ZnodePublishState where IsDefaultContentState = 1  and IsContentState = 1  --Production 
    
	Unit testing 
	

Exec [ZnodeSetPublishWidgetSliderBannerEntity]
@PortalId  = 1
,@LocaleId  = 0 
,@PreviewVersionId = 0 
,@ProductionVersionId = 0 
,@RevisionState = 'Preview@Production' 
,@CMSContentPagesId = 88
,@CMSSliderId = 0
,@UserId = 0 
	*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
   
   ---Following code is manditory because this sp get call from multiple places
   If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
	Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
		SET @IsPreviewEnable = 1 
	else 
		SET @IsPreviewEnable = 0 

   DECLARE @Tbl_PreviewVersionId    TABLE    (PreviewVersionId int , PortalId int , LocaleId int)
   DECLARE @Tbl_ProductionVersionId TABLE    (ProductionVersionId int  , PortalId int , LocaleId int)

   If @PreviewVersionId = 0 
		Begin
   			Insert into @Tbl_PreviewVersionId 
			SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PREVIEW'
		end
	Else 
			Insert into @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
			where VersionId = @PreviewVersionId
	
	If @ProductionVersionId = 0 
   		Begin
			Insert into @Tbl_ProductionVersionId 
			SELECT distinct VersionId , PortalId , LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PRODUCTION'
		End 
	Else 
		Insert into @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
			where VersionId = @ProductionVersionId
 
   If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
   Begin
		If not exists (Select TOP 1 1 from @Tbl_PreviewVersionId) 
			Begin
				SET @Status =0 ;
				If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
					SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
					Return 0
			End
   End
   If  (@RevisionState like '%Production%' OR @RevisionState = 'None')
   Begin
		If not exists (Select TOP 1 1 from @Tbl_ProductionVersionId) 
		Begin
			SET @Status =0 ;
			If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
				SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
			Return 0 
		End
   End


   Begin 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
	
		--CMSContentPage associated with portal 
		DECLARE @TBL_CMSContentPagesPortalWise TABLE(CMSContentPagesId INT, PortalId int );
		 
		 If @CMSSliderId	 = 0 AND @CMSContentPagesId  > 0 and @PortalId > 0 -- content page  
			INSERT INTO @TBL_CMSContentPagesPortalWise(CMSContentPagesId, PortalId)	SELECT CMSContentPagesId , PortalId FROM ZnodeCMSContentPages
			WHERE PortalId = @PortalId	AND IsActive = 1 AND (CMSContentPagesId = @CMSContentPagesId )
		 Else  If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
			INSERT INTO @TBL_CMSContentPagesPortalWise(CMSContentPagesId , PortalId)	SELECT ZCCP.CMSContentPagesId , ZCCP.PortalId FROM ZnodeCMSContentPages ZCCP
			WHERE ZCCP.IsActive = 1 AND 
			(Exists   (Select TOP 1 1 from @Tbl_ProductionVersionId TPC where TPC.PortalId = ZCCP.PortalId) 
			OR Exists (Select TOP 1 1 from @Tbl_PreviewVersionId TPC where TPC.PortalId = ZCCP.PortalId) )
		 Else If @CMSSliderId	= 0  AND @CMSContentPagesId  = 0 and @PortalId > 0 -- portal publish
			INSERT INTO @TBL_CMSContentPagesPortalWise(CMSContentPagesId,  PortalId )	SELECT CMSContentPagesId ,  PortalId FROM ZnodeCMSContentPages
			WHERE PortalId = @PortalId	AND IsActive = 1 
		

		Declare @CMSWidgetDataFinal TABLE 
		(
			WidgetSliderBannerId	int,MappingId	int,PortalId	int,LocaleId	int,Type	varchar(100),Navigation	varchar(100),
			AutoPlay	bit,AutoplayTimeOut	int,AutoplayHoverPause	bit,TransactionStyle	varchar(100),WidgetsKey	varchar(300),
			TypeOFMapping	varchar(100),SliderId	int,SliderBanners	nvarchar(max)
		)

		    DECLARE @Tlb_ZnodeCMSWidgetSliderBanner TABLE
                     (CMSWidgetSliderBannerId INT,
                      CMSMappingId            INT,
                      PortalId                INT,
                      Type                    NVARCHAR(100) NULL,
                      Navigation              NVARCHAR(100) NULL,
                      AutoPlay                BIT,
                      AutoplayTimeOut         INT,
                      AutoplayHoverPause      BIT,
                      TransactionStyle        NVARCHAR(100) NULL,
                      WidgetsKey              NVARCHAR(256),
                      TypeOFMapping           NVARCHAR(100),
                      CMSSliderId             INT
                     );

                     DECLARE @TBL_ZnodeCMSSliderDetail TABLE
                     (CMSSliderId        INT,
                      CMSSliderBannerId  INT,
                      MediaPath          VARCHAR(300),
                      Title              NVARCHAR(1000),
					  ButtonLabelName    NVARCHAR(1200),
                      ButtonLink         NVARCHAR(600),
                      TextAlignment      NVARCHAR(200),
                      BannerSequence     INT,
                      ActivationDate     DATETIME,
                      ExpirationDate     DATETIME,
                      ImageAlternateText NVARCHAR(1000),
                      DEscription        NVARCHAR(MAX)
                     );

                     DECLARE @TBL_ZnodeCMSSliderDetail_Locale TABLE
                     (CMSSliderId        INT,
                      CMSSliderBannerId  INT,
                      MediaPath          VARCHAR(300),
                      Title              NVARCHAR(1000),
                      ButtonLabelName    NVARCHAR(1200),
                      ButtonLink         NVARCHAR(600),
                      TextAlignment      NVARCHAR(200),
                      BannerSequence     INT,
                      ActivationDate     DATETIME,
                      ExpirationDate     DATETIME,
                      ImageAlternateText NVARCHAR(1000),
                      DEscription        NVARCHAR(MAX),
                      LocaleId           INT
                     );

		If @CMSSliderId	 = 0 AND @CMSContentPagesId  > 0 and @PortalId > 0 -- content page  
		   
			INSERT INTO @Tlb_ZnodeCMSWidgetSliderBanner(CMSWidgetSliderBannerId,CMSMappingId,PortalId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping,CMSSliderId)
			SELECT ACWSB.CMSWidgetSliderBannerId,ACWSB.CMSMappingId,
			@PortalId PortalId,
			ACWSB.Type,ACWSB.Navigation,ACWSB.AutoPlay,ACWSB.AutoplayTimeOut
			,ACWSB.AutoplayHoverPause,ACWSB.TransactionStyle,ACWSB.WidgetsKey,ACWSB.TypeOfMapping
			OFMapping,ACWSB.CMSSliderId FROM ZnodeCMSWidgetSliderBanner AS ACWSB WHERE
			((TypeOfMapping = 'ContentPageMapping' AND CMSMappingId IN
			(SELECT CMSContentPagesId	FROM @TBL_CMSContentPagesPortalWise	) ))
         Else  If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
			INSERT INTO @Tlb_ZnodeCMSWidgetSliderBanner(CMSWidgetSliderBannerId,CMSMappingId,PortalId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping,CMSSliderId)
			SELECT ACWSB.CMSWidgetSliderBannerId,ACWSB.CMSMappingId,
			CASE when TypeOfMapping = 'PortalMapping'  THEN ACWSB.CMSMappingId ELSE 
			(SELECT TOP 1 PortalId	FROM @TBL_CMSContentPagesPortalWise  where ACWSB.CMSMappingId =CMSMappingId )
			END 	AS PortalId,
			ACWSB.Type,ACWSB.Navigation,ACWSB.AutoPlay,ACWSB.AutoplayTimeOut
			,ACWSB.AutoplayHoverPause,ACWSB.TransactionStyle,ACWSB.WidgetsKey,ACWSB.TypeOfMapping
			OFMapping,ACWSB.CMSSliderId FROM ZnodeCMSWidgetSliderBanner AS ACWSB 
			WHERE
			((TypeOfMapping = 'PortalMapping'	AND ( Exists (Select TOP 1 1 from @Tbl_ProductionVersionId TPC where TPC.PortalId = CMSMappingId) 
			OR Exists (Select TOP 1 1 from @Tbl_PreviewVersionId TPC where TPC.PortalId = CMSMappingId) )	OR 
			 (TypeOfMapping = 'ContentPageMapping' AND CMSMappingId IN  (SELECT CMSContentPagesId	FROM @TBL_CMSContentPagesPortalWise)))
			AND (ACWSB.CMSSliderId = @CMSSliderId OR @CMSSliderId = 0 ))
			

		Else If @CMSSliderId	= 0  AND @CMSContentPagesId  = 0 and @PortalId > 0 -- portal publish
			INSERT INTO @Tlb_ZnodeCMSWidgetSliderBanner(CMSWidgetSliderBannerId,CMSMappingId,PortalId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping,CMSSliderId)
			SELECT ACWSB.CMSWidgetSliderBannerId,ACWSB.CMSMappingId,
			CASE when TypeOfMapping = 'PortalMapping'  THEN ACWSB.CMSMappingId ELSE @PortalId END 	AS PortalId,
			ACWSB.Type,ACWSB.Navigation,ACWSB.AutoPlay,ACWSB.AutoplayTimeOut
			,ACWSB.AutoplayHoverPause,ACWSB.TransactionStyle,ACWSB.WidgetsKey,ACWSB.TypeOfMapping
			OFMapping,ACWSB.CMSSliderId FROM ZnodeCMSWidgetSliderBanner AS ACWSB WHERE
			((TypeOfMapping = 'PortalMapping'	AND CMSMappingId = @PortalId OR @PortalId = 0 )	OR 
				(TypeOfMapping = 'ContentPageMapping' AND CMSMappingId IN (SELECT CMSContentPagesId	FROM @TBL_CMSContentPagesPortalWise	) ))
							
		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

		
		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
	
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			;With Cte_GetCMSSEODetails AS 
			(
					SELECT ZCSB.CMSSliderId,ZCSB.CMSSliderBannerId,ZM.Path MediaPath ,ZCSBL.Title,ZCSBL.ButtonLabelName,ZCSBL.ButtonLink,ZCSB.TextAlignment,ZCSB.BannerSequence,ZCSB.ActivationDate,ZCSB.ExpirationDate,ZCSBL.ImageAlternateText,ZCSBL.DEscription,ISNULL(ZCSBL.LocaleId, @DefaultLocaleId) AS LocaleId
					FROM ZnodeCMSSliderBanner AS ZCSB LEFT JOIN ZnodeCMSSliderBannerLocale AS ZCSBL ON(ZCSB.CMSSliderBannerId = ZCSBL.CMSSliderBannerId
					AND	(ZCSBL.LocaleId  = @SetLocaleId OR ZCSBL.LocaleId  = @DefaultLocaleId))  
					LEFT OUTER JOIN ZnodeMEdia  AS ZM ON ZCSBL.MediaId = ZM.MediaId
					WHERE EXISTS
					(
						SELECT TOP 1 1
						FROM @Tlb_ZnodeCMSWidgetSliderBanner AS ACWSB
						WHERE ACWSB.CMSSliderId = ZCSB.CMSSliderId
					)

			)
			, Cte_GetFirstCMSSEODetails  AS
			(
				SELECT 
					CMSSliderId,CMSSliderBannerId,MediaPath,Title,ButtonLabelName,ButtonLink,TextAlignment,BannerSequence,ActivationDate,ExpirationDate,ImageAlternateText,DEscription
				FROM Cte_GetCMSSEODetails 
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT 
					CMSSliderId,CMSSliderBannerId,MediaPath,Title,ButtonLabelName,ButtonLink,TextAlignment,BannerSequence,ActivationDate,ExpirationDate,ImageAlternateText,DEscription
					 FROM  Cte_GetFirstCMSSEODetails 
				UNION ALL 
				SELECT 
					CMSSliderId,CMSSliderBannerId,MediaPath,Title,ButtonLabelName,ButtonLink,TextAlignment,BannerSequence,ActivationDate,ExpirationDate,ImageAlternateText,DEscription
				FROM Cte_GetCMSSEODetails CTEC 
				WHERE LocaleId = @DefaultLocaleId 
				AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstCMSSEODetails CTEFD WHERE   CTEC.CMSSliderBannerId = CTEFD.CMSSliderBannerId
                                      AND CTEC.CMSSliderId = CTEFD.CMSSliderId)
			)
	
			INSERT INTO @CMSWidgetDataFinal 
			(
				WidgetSliderBannerId,MappingId,PortalId,LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners
			)
		   SELECT DISTINCT
		   CMSWidgetSliderBannerId AS WidgetSliderBannerId,CMSMappingId AS MappingId,PortalId,
		   @SetLocaleId AS LocaleId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping
		   ,CMSSliderId AS SliderId,
			(  
				SELECT ISNULL(CMSSliderId,'') AS SliderId,ISNULL(CMSSliderBannerId,'') AS SliderBannerId,ISNULL(MediaPath,'')MediaPath
				,ISNULL(Title,'')Title,ISNULL(ButtonLabelName,'')ButtonLabelName,ISNULL(ButtonLink,'')ButtonLink
				,ISNULL(TextAlignment,'')TextAlignment,ISNULL(BannerSequence,'')BannerSequence,ISNULL(ActivationDate,'')ActivationDate
				,ISNULL(ExpirationDate,'') ExpirationDate,ISNULL(ImageAlternateText,'')ImageAlternateText,ISNULL(Description,'')Description
				FROM Cte_GetDefaultFilterData AS wd
				WHERE wd.CMSSliderId = a.CMSSliderId 
				FOR JSON PATH  
			)SliderBanners
			FROM @Tlb_ZnodeCMSWidgetSliderBanner AS a

			SET @IncrementalId = @IncrementalId +1 
		END 
	End
		
	If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
	Begin
	    --Data inserted into flat table ZnodePublishWidgetSliderBannerEntity (Replica of MongoDB Collection )  

		Delete from ZnodePublishWidgetSliderBannerEntity where VersionId in (Select PreviewVersionId from @Tbl_PreviewVersionId )
	 		 AND (SliderId = @CMSSliderId OR @CMSSliderId = 0   )
			 AND (MappingId in (Select CMSContentPagesId from @TBL_CMSContentPagesPortalWise) OR @CMSContentPagesId  = 0);

		Insert Into ZnodePublishWidgetSliderBannerEntity 
		(VersionId,PublishStartTime,WidgetSliderBannerId,MappingId,PortalId,LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners	)

		SELECT B.PreviewVersionId , Getdate(),WidgetSliderBannerId,MappingId,A.PortalId,A.LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners
	    FROM @CMSWidgetDataFinal A INNER JOIN @Tbl_PreviewVersionId B
		On A.LocaleId = B.LocaleId AND A.PortalId = B.PortalId 
	
	End
	-------------------------- End Preview 
	If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	Begin
			-- Only production version id will process 
		Delete from ZnodePublishWidgetSliderBannerEntity where VersionId in (Select ProductionVersionId from @Tbl_ProductionVersionId )
	 		 AND (SliderId = @CMSSliderId OR @CMSSliderId = 0   )
			 AND (MappingId in (Select CMSContentPagesId from @TBL_CMSContentPagesPortalWise) OR @CMSContentPagesId  = 0);

		Insert Into ZnodePublishWidgetSliderBannerEntity 
		(
			VersionId,PublishStartTime,WidgetSliderBannerId,MappingId,PortalId,LocaleId,Type,Navigation,
			AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
			TypeOFMapping,SliderId,SliderBanners
		)
		
		SELECT B.ProductionVersionId, Getdate(),WidgetSliderBannerId,MappingId,A.PortalId,A.LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners
	    FROM @CMSWidgetDataFinal A INNER JOIN @Tbl_ProductionVersionId B
		On A.LocaleId = B.LocaleId AND A.PortalId = B.PortalId
		
	End

	If @RevisionState ='PREVIEW'
	Begin
			update A SET A.IsPublished = 1 , A.PublishStateId = [dbo].[Fn_GetPublishStateIdForPreview]() 
			from ZnodeCMSSlider A INNER JOIN @CMSWidgetDataFinal B on A.CMSSliderId = B.SliderId 
	End
	Else 
			update A SET A.IsPublished = 1 , A.PublishStateId = [dbo].[Fn_GetPublishStateIdForPublish]() 
			from ZnodeCMSSlider A INNER JOIN @CMSWidgetDataFinal B on A.CMSSliderId = B.SliderId 
		

	SET @Status =1 ;
	
	If Not Exists (select TOP 1 1 from @CMSWidgetDataFinal ) 
	Begin
		If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
		Begin
			SET @Status =0 ;
			SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
		End
	End
	Else 
		If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
		SELECT 1 AS ID,cast(@Status as BIT) AS Status;

END TRY 
BEGIN CATCH 
	SET @Status =0 ;
	If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
		SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	 @ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeSetPublishWidgetSliderBannerEntity 
			@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
			+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
			+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
			+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
			+''',@CMSContentPagesId= ' + CAST(@CMSContentPagesId  AS varchar(20))
			+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'ZnodeSetPublishWidgetSliderBannerEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateShowOnGridColumInternal')
	DROP PROC Znode_UpdateShowOnGridColumInternal
GO

CREATE PROC [dbo].[Znode_UpdateShowOnGridColumInternal]  
(  
@PimAttributeId INT = 0   
)  
AS   
BEGIN   
BEGIN TRY   
SET NOCOUNT ON   
DECLARE @sql NVARCHAr(max) = ''  
  
  
  SELECT a.PimProductId , b.AttributeValue , c.AttributeCode    
INTO #Temp_value   
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimAttributeValueLocale b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE LocaleId = 1   
AND c.PimAttributeId = @PimAttributeId  
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
)  
UNION ALL   
  
SELECT a.PimProductId , b.AttributeValue , c.AttributeCode    
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimProductAttributeTextAreaValue b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE LocaleId = 1   
AND c.PimAttributeId = @PimAttributeId  
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
 )  
UNION ALL   
SELECT a.PimProductId , mp.AttributeDefaultValueCode , c.AttributeCode    
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimProductAttributeDefaultValue b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttributeDefaultValue mp ON (mp.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale g ON (g.PimAttributeDefaultValueId = b.PimAttributeDefaultValueId)  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE b.LocaleId = 1    
AND c.PimAttributeId = @PimAttributeId  
AND g.LocaleId = 1   
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
 )  
UNION ALL   
SELECT a.PimProductId ,CAST( b.MediaId AS VARCHAR(500)) , c.AttributeCode    
FROM ZnodePimAttributeValue a   
INNER JOIN ZnodePimProductAttributeMedia b ON (b.PimAttributeValueId = a.PimAttributeValueId )  
INNER JOIN ZnodePimAttribute c ON (c.PimAttributeId = a.PimAttributeId)  
WHERE b.LocaleId = 1   
AND c.PimAttributeId = @PimAttributeId   
AND AttributeCode IN (SELECT b.AttributeCode   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
 )  
  
 SET @sql = ''   
  
--SELECT * FROM #Temp_value WHERE AttributeCode = 'IsActive' AND AttributeValue = 'Yes'  
--UPDATE #Temp_value SET attributeValue = 'true' WHERE AttributeCode = 'IsActive' AND AttributeValue = 'Yes'  
  
  
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int   
  
DECLARE Cur_AttributeDataUpdate CURSOR FOR   
  
  
  
SELECT b.AttributeCode , PimAttributeId   
FROM INFORMATION_SCHEMA.COLUMNS a   
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )  
WHERE TABLE_NAME = 'ZnodePimProduct'  
AND IsCategory = 0   
  
  
  
OPEN Cur_AttributeDataUpdate   
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr   
WHILE @@FETCH_STATUS = 0   
BEGIN   
  
 SET @sql = 'UPDATE a    
 SET '+@AttributeCodeAtt+'= AttributeValue   
 FROM ZnodePimProduct a   
 INNER JOIN #Temp_value m ON(m.PimProductId = a.pimProductId )   
 WHERE m.AttributeCode = '''+@AttributeCodeAtt+'''  
 '   
  
 EXEC (@sql)  
  
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr   
END   
CLOSE Cur_AttributeDataUpdate  
DEALLOCATE Cur_AttributeDataUpdate   
  
  
  
END TRY   
BEGIN CATCH   
SELECT ERROR_MESSAGE()  
END CATCH   
END

GO


IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCatalogProductSEODetail')
	DROP PROC Znode_GetCatalogProductSEODetail
GO

CREATE PROCEDURE [dbo].[Znode_GetCatalogProductSEODetail]
(
  @WhereClause      NVARCHAR(MAX),
  @Rows             INT           = 100,
  @PageNo           INT           = 1,
  @Order_BY         VARCHAR(1000) = '',
  @RowsCount        INT OUT,
  @LocaleId         INT           = 1,
  @PortalId INT
 
  )
AS
   
/*
  Summary:  Get product List  Catalog / category / respective product list    
  Unit Testing  
  begin tran
  declare @p7 int = 0  
  EXEC Znode_GetCatalogProductSEODetail @WhereClause=N'',@Rows=100,@PageNo=1,@Order_By=N'',
  @RowsCount=@p7 output,@PortalId= 1 ,@LocaleId=1
  rollback tran
 
    declare @p7 int = 0  
  EXEC Znode_GetCatalogProductSEODetail @WhereClause=N'',@Rows=10,@PageNo=1,@Order_By=N'',
  @RowsCount=@p7 output,@PortalId= 5 ,@LocaleId=1
 */

BEGIN
    SET NOCOUNT ON;
    BEGIN TRY
        DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
        DECLARE @SQL NVARCHAR(MAX)
		DECLARE @PimProductId TransferId
		DECLARE @PimAttributeId VARCHAR(MAX)
        DECLARE @TransferPimProductId TransferId


	IF OBJECT_ID('TEMPDB..#ProductDetailPivot') IS NOT NULL
	DROP TABLE #ProductDetailPivot

	IF OBJECT_ID('TEMPDB..##TempProductDetail') IS NOT NULL
	DROP TABLE ##TempProductDetail

	IF OBJECT_ID('TEMPDB..#znodeCatalogProduct') IS NOT NULL
	DROP TABLE #znodeCatalogProduct

	IF OBJECT_ID('TEMPDB..#ProductAttributeDetailS') IS NOT NULL
	DROP TABLE #ProductAttributeDetailS


	IF OBJECT_ID('TEMPDB..#TBL_MediaValue') IS NOT NULL
	DROP TABLE #TBL_MediaValue


	Declare @PimCatalogId INT

	SELECT @PimCatalogId = ZPC.PublishCatalogId
	FROM ZnodePortalCatalog ZPC	WHERE PortalId = @PortalId

	SELECT DISTINCT ZPCH.PimCatalogId,ZPCP.PimProductId 
	INTO #ZnodeCatalogProduct
	FROm ZnodePimCategoryProduct ZPCP
	INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId 
	where ZPCH.PimCatalogId = @PimCatalogId

	-----------------------------------========

	Create TABLE #ProductAttributeDetailS ( pimproductId int ,attributecode varchar(300),AttributeValue  varchar(1000) ,LocaleId int )

	INSERT INTO #ProductAttributeDetailS (pimproductId,attributecode,AttributeValue ,LocaleId)
	SELECT d.pimproductId,PA.attributecode,e.AttributeValue ,e.LocaleId--, ZPS.DisplayName  PublishState
	FROM ZnodePimAttributeValue d
	inner join ZnodePimAttributeValueLocale e on (d.PimAttributeValueId = e.PimAttributeValueId)
	inner join ZnodePimAttribute PA ON (PA.PimAttributeId = d.PimAttributeId)
	where  PA.Attributecode IN ('SKU','ProductName','ProductImage','IsActive')
	and exists(select * from #znodeCatalogProduct ZPC where d.pimproductId = ZPC.PimProductId )

	CREATE TABLE #ProductDetailPivot( PimProductid INT,SKU VARCHAR(1000),ProductName VARCHAR(1000),ProductImage VARCHAR(1000),IsActive VARCHAR(1000),LocaleId  INT)

	INSERT INTO #ProductDetailPivot(pimproductId, LocaleId)
	SELECT distinct PimProductId,LocaleId from #ProductAttributeDetailS

	--Create Index Ind_#ProductAttributeDetailS on  #ProductAttributeDetailS(PimProductid)
	--Create Index Ind_#ProductAttributeDetailS_IdAndCode on  #ProductAttributeDetailS(attributecode,PimProductid)

	--Create Index #ProductDetail on  #ProductDetailPivot(PimProductid)

		----------------------------------------------------------
	--SELECT
	--PD.PimProductid ,Piv.SKU ,Piv.ProductName ,Piv.ProductImage ,Piv.IsActive ,PD.LocaleId  into #ProductDetail  
	--FROM #ProductDetailPivot AS PD
	--INNER JOIN
	--(
	--SELECT PimProductId,AttributeValue,AttributeCode FROM #ProductAttributeDetailS
	--)   TB PIVOT(MAX(AttributeValue) FOR AttributeCode IN([SKU], [ProductName],ProductImage ,IsActive)) AS Piv ON(Piv.PimProductId = PD.PimProductid)
             
	----     -----------------------------------========

	UPDATE b SET b.SKU = a.AttributeValue, B.ProductName = a1.AttributeValue 
				 , b.IsActive = a11.AttributeValue
	FROM #ProductAttributeDetailS A
	INNER JOIN #ProductDetailPivot B ON A.PimProductid = B.PimProductid
	INNER JOIN #ProductAttributeDetailS A1 ON B.PimProductid = A1.PimProductid
	LEFT JOIN #ProductAttributeDetailS A11 ON A.PimProductid = A11.PimProductid AND A11.attributecode = 'IsActive'
	WHERE A.attributecode = 'SKU' 
	AND A1.attributecode = 'ProductName' 

	UPDATE b SET b.ProductImage = a.AttributeValue
	FROM #ProductAttributeDetailS A
	INNER JOIN #ProductDetailPivot B ON A.PimProductid = B.PimProductid
	WHERE A.attributecode = 'ProductImage'


	--update b set b.ProductName = a.AttributeValue
	--FROM #ProductAttributeDetailS A
	--INNER JOIN #ProductDetailPivot B ON A.PimProductid = B.PimProductid
	--WHERE A.attributecode = 'SKU'


	--update b set b.ProductName = a.AttributeValue
	--FROM #ProductAttributeDetailS A
	--INNER JOIN #ProductDetailPivot B ON A.PimProductid = B.PimProductid
	--WHERE A.attributecode = 'ProductName'

	--update b set b.ProductImage = a.AttributeValue
	--FROM #ProductAttributeDetailS A
	--INNER JOIN #ProductDetailPivot B ON A.PimProductid = B.PimProductid
	--WHERE A.attributecode = 'ProductImage'

	--update b set b.IsActive = a.AttributeValue
	--FROM #ProductAttributeDetailS A
	--INNER JOIN #ProductDetailPivot B ON A.PimProductid = B.PimProductid
	--WHERE A.attributecode = 'IsActive'

	CREATE TABLE #TBL_MediaValue(PimAttributeValueId INT,PimProductId INT,MediaPath INT,PimAttributeId INt,LocaleId INT )
	INSERT INTO #TBL_MediaValue
	SELECT ZPAV.PimAttributeValueId ,ZPAV.PimProductId ,ZPPAM.MediaId MediaPath,ZPAV.PimAttributeId , ZPPAM.LocaleId
	FROM ZnodePimAttributeValue ZPAV
	INNER JOIN ZnodePimProductAttributeMedia ZPPAM ON ( ZPPAM.PimAttributeValueId = ZPAV.PimAttributeValueId)
	INNER JOIN #ProductDetailPivot PD ON (PD.PimProductId = ZPAV.PimProductId)
	LEFT JOIN ZnodeMedia ZM ON (Zm.Path = ZPPAM.MediaPath)
	WHERE  ZPAV.PimAttributeId = (select PimAttributeId from ZnodePimAttribute pa where attributecode = 'ProductImage')


	SELECT PD.PimProductId  ,
	URL+ZMSM.ThumbnailFolderName+'/'+ zm.PATH  AS ProductImagePath
	INTO #Cte_ProductMedia
	FROM ZnodeMedia AS ZM
    INNER JOIN ZnodeMediaConfiguration ZMC  ON (ZM.MediaConfigurationId = ZMC.MediaConfigurationId)
	INNER JOIN ZnodeMediaServerMaster ZMSM ON (ZMSM.MediaServerMasterId = ZMC.MediaServerMasterId)
	INNER JOIN #TBL_MediaValue PD ON (PD.MediaPath = ZM.MediaId)--CAST(ZM.MediaId AS VARCHAR(50)))
	--INNER JOIN  @TBL_PimMediaAttributeId AS FNMA ON (FNMA.PImAttributeId = PD.PimATtributeId )

	SELECT DISTINCT  CD.pimproductId, SKU,ProductName,
	case WHEN  CD.IsActive = 'true' THEN 1 ELSE 0 END IsActive, ISNULL(CSD.SEOCode,SKU) as SEOCode, CSD.SEOUrl, CSDL.SEOTitle, CSDL.SEODescription, CSDL.SEOKeywords,
	case when  ZPS.DisplayName IS NULL THEN '' ELSE ZPS.DisplayName END IsPublish  , CPM.ProductImagePath, PC.CatalogName, CD.LocaleId, CSDL.CanonicalURL , CSDL.RobotTag
	INTO #CTE_ProductDetail
	FROM #ProductDetailPivot CD
	INNER JOIN #znodeCatalogProduct PCC on CD.PimProductId = PCC.PimProductId
	INNER JOIN ZnodePimCatalog PC on PCC.PimCatalogId = PC.PimCatalogId
	LEFT JOIN ZnodeCMSSEOType CST ON CST.Name = 'Product'
	LEFT JOIN ZnodeCMSSEODetail CSD on LTRIM(RTRIM(CD.SKU)) = LTRIM(RTRIM(CSD.SEOCode)) and CSD.CMSSEOTypeId = CST.CMSSEOTypeId AND CSD.PortalId = @PortalId 
	LEFT JOIN ZnodeCMSSEODetailLocale CSDL ON  CSD.CMSSEODetailId = CSDL.CMSSEODetailId AND CSDL.LocaleId =  @LocaleId 
	LEFT JOIN ZnodePublishState ZPS ON (ZPS.PublishStateId = CSD.PublishStateId)
	LEFT JOIN #Cte_ProductMedia CPM ON (CPM.PimProductId = CD.PimProductId)
	WHERE PCC.PimCatalogId = @PimCatalogId AND CD.LocaleId IN (@LocaleId ,@DefaultLocaleId )

	SELECT pimproductId, SKU,ProductName,IsActive , SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords, IsPublish,ProductImagePath,CatalogName, LocaleId, CanonicalURL, RobotTag
	INTO #CTE_ProductLocale
	FROM #CTE_ProductDetail CPD
	WHERE CPD.LocaleId = @LocaleId


	SELECT pimproductId, SKU,ProductName,IsActive , SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords, IsPublish,ProductImagePath,CatalogName, CanonicalURL, RobotTag
	INTO #CTE_ProductBothLocale
	FROM #CTE_ProductLocale PL
	UNION ALL
	SELECT pimproductId, SKU,ProductName,IsActive , SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords, IsPublish,ProductImagePath,CatalogName, CanonicalURL, RobotTag
	FROM #CTE_ProductDetail PD
	WHERE LocaleId = @DefaultLocaleId AND
	NOT EXISTS (select TOP 1 1 from #CTE_ProductLocale PCL WHERE PCL.pimproductId = PD.pimproductId AND PCL.CatalogName = PD.CatalogName )

	SET @SQL =
	'SELECT  pimproductId, SKU,ProductName, cast(IsActive as bit) IsActive , SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords, 
	         IsPublish,ProductImagePath,CatalogName, CanonicalURL, RobotTag,'
			 +[dbo].[Fn_GetPagingRowId](@Order_BY, 'PimProductId')+',Count(*)Over() CountId
	into #CTE_ProductDetail_WhereClause
	FROM #CTE_ProductBothLocale CD
	WHERE 1 = 1  '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'

	SELECT  pimproductId, SKU,ProductName,IsActive, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,
	        ProductImagePath,CatalogName, CanonicalURL, RobotTag, CountId
	INTO ##TempProductDetail
	FROM #CTE_ProductDetail_WhereClause
	'+[dbo].[Fn_GetPaginationWhereClause](@PageNo, @Rows);
	--select @SQL for xml path,type
	EXEC (@SQL)

	SET @RowsCount = ISNULL((SELECT TOP 1 CountId FROM ##TempProductDetail ),0)

	SELECT PimProductId,LTRIM(RTRIM(SKU)) AS SKU,ProductName,IsActive,LTRIM(RTRIM(SEOCode)) AS SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ProductImagePath, CanonicalURL, RobotTag
	FROM ##TempProductDetail
	--GROUP by pimproductId, SKU,ProductName,IsActive, SEOCode, SEOUrl, SEOTitle, SEODescription, SEOKeywords,IsPublish,ProductImagePath


	IF OBJECT_ID('TEMPDB..ProductDetailPivot') IS NOT NULL
	DROP TABLE ProductDetailPivot

	IF OBJECT_ID('TEMPDB..##TempProductDetail') IS NOT NULL
	DROP TABLE ##TempProductDetail


	IF OBJECT_ID('TEMPDB..#znodeCatalogProduct') IS NOT NULL
	   DROP TABLE #znodeCatalogProduct

	IF OBJECT_ID('TEMPDB..#TBL_MediaValue') IS NOT NULL
	   DROP TABLE #TBL_MediaValue

END TRY
BEGIN CATCH
   SELECT ERROR_message()
    DECLARE @Status BIT ;
    SET @Status = 0;
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCatalogCategoryProducts @WhereClause = '''+ISNULL(CAST(@WhereClause AS VARCHAR(MAX)),'''''')+''',@Rows='+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')
	 +',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')
	 +',@LocaleId = '+ISNULL(CAST(@LocaleId AS VARCHAR(50)),'''')+',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(50)),'''');
             
            -- SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
 
             EXEC Znode_InsertProcedureErrorLog
			 @ProcedureName = 'Znode_GetCatalogProductSEODetail',
			 @ErrorInProcedure = 'Znode_GetCatalogProductSEODetail',
			 @ErrorMessage = @ErrorMessage,
			 @ErrorLine = @ErrorLine,
			 @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder 
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  rt.ParentPimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder 
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
INNER JOIN  @PimProduct_catalog rt ON ( rt.ParentPimCategoryHierarchyId = ty.PimCategoryHierarchyId  )
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = rt.ParentPimCategoryHierarchyId)
AND @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT  , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  

UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,1), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT PimCategoryId FROM  #Temp_categoryDetails ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleCategoryEntity')
	DROP PROC Znode_PublishSingleCategoryEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleCategoryEntity]
(
    @PimCategoryId  int 
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAssociate int  = 0 OUT
   ,@PimCatalogId int = 0
)
AS
/*
	To publish single category 
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@DefaultLocaleId int = dbo.fn_getdefaultLocaleId()
	SET @Status = 1 
	Declare @IsPreviewEnable int 
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionType = 'Production' OR  @RevisionType = 'None'

		
    SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId ) 
WHERE  a.IsCategory =1



SELECT DISTINCT yu.VersionId,yu.LocaleId, yu.CatalogName, yu.ZnodeCatalogId, a.PimCategoryId ,RT.ParentPimCategoryHierarchyId, rt.DisplayOrder, rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues,rt.ActivationDate, rt.ExpirationDate
		,RT.IsActive
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  ZnodePimCategoryHierarchy  rt with(nolock) ON ( rt.PimCategoryId = a.PimCategoryId  )
INNER JOIN  ZnodePublishCatalogEntity yu with(nolock) ON (yu.ZnodeCatalogId = rt.PimCatalogId)
WHERE rt.PimCategoryId =@PimCategoryId
AND yu.RevisionType IN (SELECT t.RevisionState FROM @Tbl_versions t)


SELECT DISTINCT PimCategoryHierarchyId,LocaleId,ZnodeCatalogId, CatalogName,PimCategoryId,ParentPimCategoryHierarchyId,DisplayOrder,VersionId, CategoryName, CategoryCode ,ActivationDate, ExpirationDate,IsActive
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

-- SELECT * FROM #Temp_categoryDetails

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId = t.PimCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.VersionId = a.VersionId)

INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT a.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId  = a.PimCategoryId  )+']' 
	,a.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = a.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )

DELETE t FROM ZnodePublishSeoEntity t WHERE EXISTS (SELECT TOP 1 1 FROM #Temp_categoryDetails yu WHERE yu.CategoryCode  = t.SEOCode 
AND t.CMSSEOTypeId = 2 
)

INSERT INTO ZnodePublishSeoEntity(VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,ElasticSearchEvent) 

SELECT VersionId,GETDATE(),a.SEOCode,a.CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,'Category' SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,1 ElasticSearchEvent
FROM ZnodeCMSSEODetail a 
INNER JOIN ZnodeCMSSEODetailLocale b ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN #Temp_categoryDetails c ON (c.CategoryCode = a.SEOCode )
WHERE a.CMSSEOTypeId =2 

     
	SELECT PimCategoryHierarchyId PublishCategoryId ,
			ZnodeCatalogId  PublishCatalogId  ,
           ''   CategoryXml       ,
              LocaleId          ,
			  VersionId		     FROM  #Temp_categoryDetails y 

	SELECT PortalId, y.ZnodeCatalogId PublishCatalogId, y.PimCategoryHierarchyId PublishCategoryId, y.CategoryCode, yu.SEOUrl,y. VersionId,y.LocaleId FROM ZnodePublishSeoEntity yu 
	INNER JOIN #Temp_categoryDetails y ON ( y.VersionId = yu.VersionId
	AND y.CategoryCode = yu.SEOCode)  
	
	SELECT 0 AS id,@Status AS Status;   


	UPDATE ZnodePimCategory 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PimCategoryId =@PimCategoryId

END TRY 
BEGIN CATCH 
	SET @Status =0  
	
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	-- Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleCategoryEntity
		@PimCategoryId = '+CAST(@PimCategoryId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleCategoryErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleCategoryEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleCategoryEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleProductEntity')
	DROP PROC Znode_PublishSingleProductEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleProductEntity]
(
    @PimProductId TransferId READONLY
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAutoPublish bit = 0 
   ,@ImportGUID Varchar(500) = '' 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	DECLARE @PimProductIdIn INT , @PimCatalogId INT 

	SET @ImportGUID = CASE WHEN @ImportGUID = '' THEN CAST( NEWID() AS VARCHAR(200)) ELSE @ImportGUID END 

	DECLARE @PimCatalogProduct TABLE (PimProductId INT , IsDeleted BIT,  ZnodecatalogId INT  , VersionId INT )
	IF EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	)
	BEGIN 



	DECLARE Cur_CatalogProduct CURSOR FOR 
	SELECT DISTINCT PimProductId, b.PimCatalogId
	FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	OPEN Cur_CatalogProduct 

	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId

	WHILE @@FETCH_STATUS=0 
	BEGIN 

	INSERT INTO @PimCatalogProduct 
	EXEC Znode_PublishCatalogEntity @PimCatalogId= @PimCatalogId
									,@RevisionState =@RevisionType
									,@UserId =@UserId
									,@NewGUID = @ImportGUID
									,@IsDraftProductsOnly = 0 
									,@PimProductId =@PimProductIdIn
									,@PimCategoryHierarchyId = 0 



	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId
	END 
	CLOSE Cur_CatalogProduct
	DEALLOCATE Cur_CatalogProduct 

	   	  
	SET @Status =1 

	END 
	ELSE 
	BEGIN 


	SET @Status = 0 
	END 


	SELECT * 
	FROM ZnodePublishProductEntity a with (nolock)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimCatalogProduct r WHERE r.VersionId = a.VersionId AND r.PimProductId = a.ZnodeProductId AND r.IsDeleted = 0)

	SELECT PimProductId ZnodeProductId , IsDeleted ,  ZnodecatalogId   , VersionId 
	FROM @PimCatalogProduct 
	WHERE IsDeleted =1 


	UPDATE ZnodePublishCatalogLog 
	SET PublishStateId = CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	, IsCatalogPublished = 1 
	WHERE PublishType= 'Product'

	UPDATE ZnodePublishProgressNotifierEntity 
	SET IsCompleted = 1 ,ProgressMark = 100 
	WHERE JobId = @ImportGUID

	SELECT 0 AS id,@Status AS Status;   

	DELETE FROM ZnodePublishProgressNotifierEntity  	WHERE JobId = @ImportGUID

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleProductEntity
		@PimProductIds = '',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleProductErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleProductEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleProductEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateAttributeValue')
	DROP PROC Znode_UpdateAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_UpdateAttributeValue](@ProductId        VARCHAR(2000),      
                                                   @PimAttributeCode NVARCHAR(300),      
                                                   @LocaleId         INT,      
                                                   @AttributeValue   NVARCHAR(MAX),      
                                                   @UserId           INT,      
                                                   @Status           BIT OUT,      
                                                   @IsUnAssociated   BIT           = 0,      
                                                   @IsDebug          BIT           = 0)      
AS       
         
/* ---------------------------------------------------------------------------------------------------------------      
    --Summary : Update AttributeValue for specific product       
    --          Input parameter : @LocaleId , @PimAttributeCode,  @ProductId,@AttributeValue,@UserId      
    --Unit Testing :       
    BEGIN TRANSACTION       
    DECLARE @Status bit       
    EXEC [Znode_UpdateAttributeValue]      
    @ProductId        = 10637,      
    @PimAttributeCode = 'Brand' ,      
    @LocaleId         =1 ,      
    @AttributeValue   = 'Tropicana',      
    @UserId           =2,      
    @Status           =@Status OUT      
    SELECT @Status       
    --SELECT zpa.AttributeCode ,ZpAVL .AttributeValue  FROM ZnodePimAttributeValueLocale ZpAVL INNER JOIN ZnodePimAttributeValue zpav ON ZpAVL.PimAttributeValueId = zpav.PimAttributeValueId      
    --INNER JOIN dbo.ZnodePimAttribute zpa ON zpav.PimAttributeId = zpa.PimAttributeId      
    --WHERE zpav.PimProductId =12 AND ZpAVL.LocaleId = 1 AND zpa.AttributeCode = 'ProductName'       
    --ROLLBACK Transaction       
    ---------------------------------------------------------------------------------------------------------------      
*/      
      
     BEGIN    

		BEGIN TRAN UpdateAttributeValue;      
			BEGIN TRY      
				DECLARE @GetDate DATETIME= dbo.Fn_GetDate();      
				DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();      
				DECLARE @TBL_PimProductId TABLE      
				(PimProductId               INT,      
				PimAttributeId             INT,      
				AttributeCode              VARCHAR(300),      
				AttributeValue             NVARCHAR(MAX),      
				PimAttributeDefaultValueId INT ,
				Attributetype VARCHAR(50)     
				); -- table holds the PimProductId   
				    
				DECLARE @TBL_DefaultAttributeId TABLE (PimAttributeId INT PRIMARY KEY , AttributeCode VARCHAR(600))      
      
				INSERT INTO @TBL_DefaultAttributeId (PimAttributeId,AttributeCode)      
				SELECT PimAttributeId,AttributeCode FROM  [dbo].[Fn_GetDefaultAttributeId] ()      
      
				DECLARE @TBL_PimAttributeValueId TABLE      
				(PimAttributeValueId INT,      
				PimAttributeId      INT,      
				PimProductId        INT,      
				PimAttributeDefaultValueId int       
				);      
	  
  
				INSERT INTO @TBL_PimProductId      
				(PimProductId,      
				PimAttributeId,      
				AttributeCode,      
				AttributeValue,      
				PimAttributeDefaultValueId      
				)      
				SELECT item,      
					ZPA.PimAttributeId,      
					@PimAttributeCode,      
					@AttributeValue,      
					ZPADV.PimAttributeDefaultValueId      
				FROM dbo.Split(@ProductId, ',') SP      
					LEFT JOIN ZnodePimAttribute ZPA ON(ZPA.AttributeCode = @PimAttributeCode)      
					LEFT JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPA.PimAttributeId = ZPADV.PimAttributeId AND ( ZPADV.AttributeDefaultValueCode = @AttributeValue OR ISNULL(@AttributeValue, '') = ''  ))      
					--WHERE NOT EXISTS (SELECT * FROM @TBL_PimProductId_Simple WHERE PimProductId = SP.item AND PimAttributeId = ZPA.pimattributeid)-- AND AttributeCode = @AttributeValue AND AttributeValue = @AttributeValue AND PimAttributeDefaultValueId= ZPADV.PimAttributeDefaultValueId)


					Update TBL 
					SET Attributetype = 'Simple Select'
					FROM @TBL_PimProductId TBL
					WHERE EXISTS (SELECT * FROM ZnodePimAttribute WHERE AttributeCode = @PimAttributeCode AND AttributeTypeId = (SELECT Top 1 AttributeTypeId from ZnodeAttributeType where AttributeTypeName = 'Simple Select'))
					--INNER JOIN ZnodePimAttribute ZPA ON(ZPA.AttributeCode = @PimAttributeCode and ZPA.AttributeTypeId = (SELECT AttributeTypeId from ZnodeAttributeType where AttributeTypeName = 'Simple Select'))      


		  
      
				IF @IsUnAssociated = 1      
				BEGIN      
				INSERT INTO @TBL_PimAttributeValueId      
				(PimAttributeValueId,      
				PimAttributeId,      
				PimProductId,      
				PimAttributeDefaultValueId     
				)      
					SELECT ZPAV.PimAttributeValueId,      
							ZPAV.PimAttributeId,      
							ZPAV.PimProductId,      
							ZPADV.PimAttributeDefaultValueId      
					FROM ZnodePimAttributeValue ZPAV      
							INNER JOIN @TBL_PimProductId TBLP ON(TBLP.PimProductId = ZPAV.PimProductId AND TBLP.PimAttributeId = ZPAV.PimAttributeId AND TBLP.AttributeValue = @AttributeValue)
							INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON (ZPADV.PimAttributeValueId = ZPAV.PimAttributeValueId)
							INNER JOIN ZnodePimAttributeDefaultValue ZADV ON (ZPADV.PimAttributeDefaultValueId = ZADV.PimAttributeDefaultValueId AND ZADV.AttributeDefaultValueCode =@AttributeValue )

      
				DELETE FROM ZnodePimProductAttributeDefaultValue 
				WHERE EXISTS      
				(      
					SELECT TOP 1 1      
					FROM @TBL_PimAttributeValueId TBLAP      
					WHERE TBLAP.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId      
					AND ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId = TBLAP.PimAttributeDefaultValueId --@PimAttributeDefaultValueId      
				)      
				AND LocaleId = @LocaleId
					

				DELETE FROM ZnodePimAttributeValue    
				WHERE EXISTS      
				(      
					SELECT TOP 1 1      
					FROM @TBL_PimAttributeValueId TBLAP      
					WHERE TBLAP.PimAttributeValueId = ZnodePimAttributeValue.PimAttributeValueId      
						AND ZnodePimAttributeValue.PimAttributeDefaultValueId =TBLAP.PimAttributeDefaultValueId -- @PimAttributeDefaultValueId      
				)
				AND not exists (select * from   ZnodePimProductAttributeDefaultValue where PimAttributeValueId =ZnodePimAttributeValue.PimAttributeValueId )--AND PimAttributeDefaultValueId <>TBLAP.PimAttributeDefaultValueId ) 
				--AND LocaleId = @LocaleId     

				END;   

				---- here needs to handle which records will be updated and which records will be inserted 	

				--INSERT INTO @TBL_PimProductId 
				--(PimProductId,      
				--PimAttributeId,      
				--AttributeCode,      
				--AttributeValue,      
				--PimAttributeDefaultValueId      
				--)     
				--SELECT 	TBL.PimProductId,      
				--TBL.PimAttributeId,      
				--AttributeCode,      
				--TBL.AttributeValue,      
				--TBL.PimAttributeDefaultValueId 
				--FROM @TBL_PimProductId_Simple TBL 
				--INNER JOIN 	Znodepimattributevalue ZPA ON (ZPA.PimProductId = TBL.PimProductId AND ZPA.PimAttributeId = TBL.PimAttributeId)	 
			 

				UPDATE ZnodePimAttributeValue       
				SET  ModifiedBy = @UserId      
				, ModifiedDate = @GetDate      
				,PimAttributeDefaultValueId = ZAV.PimAttributeDefaultValueId      
				OUTPUT INSERTED.PimAttributeValueId,      
				INSERTED.PimAttributeId,      
				INSERTED.PimProductId,      
				INSERTED.PimAttributeDefaultValueId      
				INTO @TBL_PimAttributeValueId      
				FROM ZnodePimAttributeValue        
				INNER JOIN @TBL_PimProductId ZAV ON ( ZAV.PimProductId = ZnodePimAttributeValue.PimProductId      
						AND ZAV.PimAttributeId = ZnodePimAttributeValue.PimAttributeId)      
				WHERE @IsUnAssociated = 0  


				--INSERT INTO @TBL_PimProductId 
				--(PimProductId,      
				--PimAttributeId,      
				--AttributeCode,      
				--AttributeValue,      
				--PimAttributeDefaultValueId      
				--)     
				--SELECT 	PimProductId,      
				--PimAttributeId,      
				--AttributeCode,      
				--AttributeValue,      
				--PimAttributeDefaultValueId 
				--FROM @TBL_PimProductId_Simple TBL 
				--WHERE NOT EXISTS (SELECT * FROM Znodepimattributevalue WHERE PimAttributeId = TBL.pimattributeid AND PimProductId = TBL.PimProductId)
     
				INSERT INTO ZnodePimAttributeValue      
				(PimProductId,      
				PimAttributeId,      
				PimAttributeDefaultValueId,      
				AttributeValue,      
				CreatedBy,      
				CreatedDate,      
				ModifiedBy,      
				ModifiedDate,      
				PimAttributeFamilyId      
				)      
				OUTPUT INSERTED.PimAttributeValueId,      
				INSERTED.PimAttributeId,      
				INSERTED.PimProductId,      
				INSERTED.PimAttributeDefaultValueId      
				INTO @TBL_PimAttributeValueId      
				SELECT TBPP.PimProductId,      
					TBPP.PimAttributeId,      
					TBPP.PimAttributeDefaultValueId,      
					TBPP.AttributeValue,      
					@UserId,      
					@GetDate,      
					@UserId,      
					@GetDate,      
					@PimDefaultFamily      
				FROM @TBL_PimProductId TBPP      
				WHERE NOT EXISTS      
				(      
				SELECT TOP 1 1      
				FROM ZnodePimAttributeValue ZAV      
				WHERE ZAV.PimProductId = TBPP.PimProductId      
						AND ZAV.PimAttributeId = TBPP.PimAttributeId      
				)      
				AND @IsUnAssociated = 0;      
                   
				UPDATE A      
				SET      
				AttributeValue = C.AttributeValue      
				FROM ZnodePimAttributeValueLocale A      
				INNER JOIN ZnodePimAttributeValue B ON(B.PimAttributeValueId = A.PimAttributeValueId)      
				INNER JOIN @TBL_PimProductId C ON(B.PimAttributeId = C.PimAttributeId      
											AND B.PimProductId = C.PimProductId)      
				WHERE LocaleId = @LocaleId;  

 
				Declare @Pimattriutedefaultvalueid INT = 0
						 
				SELECT @Pimattriutedefaultvalueid =  A.PimAttributeDefaultValueId from ZnodePimAttributeDefaultValue A 
				INNER JOIN ZnodePimAttributeDefaultValueLocale B On (A.PimAttributeDefaultValueId = B.PimAttributeDefaultValueId AND A.PimAttributeId = (SELECT TOP 1 PimAttributeId from ZnodePimAttribute WHERE AttributeCode = @PimAttributeCode))
				WHERE A.AttributeDefaultValueCode = @AttributeValue AND B.LocaleId  = @LocaleId	


				-- UP ZnodePimProductAttributeDefaultValue 
				IF @Pimattriutedefaultvalueid <>0
				Update ZPDA
				SET ZPDA.ModifiedBy = @UserId,
				ZPDA.Modifieddate = @getdate,
				ZPDA.pimattributedefaultvalueid = ZPA.pimattributedefaultvalueid
				FROM @TBL_PimProductId TBL
				INNER JOIN @TBL_PimAttributeValueId ZPA ON (TBL.pimattributeid = ZPA.pimattributeid AND TBL.pimproductid = ZPA.PimProductId)
				INNER JOIN ZnodePimProductAttributeDefaultValue ZPDA ON (ZPDA.PimAttributeValueId = ZPA.pimattributevalueid)
				WHERE TBL.Attributetype = 'Simple Select'
				

				DELETE TBL
				FROM @TBL_PimAttributeValueId TBL
				INNER JOIN @TBL_PimProductId TBLP On (TBL.PimAttributeId = TBLP.PimAttributeId AND TBL.PimProductId = TBLP.pimproductid AND TBL.pimattributevalueid = TBLP.pimattributedefaultvalueid)
				WHERE TBLP.Attributetype = 'Simple Select'
				AND (EXISTS (SELECT * FROM ZnodePimProductAttributeDefaultValue WHERE PimAttributeValueId = TBL.pimattributevalueid )
				OR  EXISTS (SELECt * FROM ZnodePimAttributeValueLocale WHERE PimAttributeValueId = TBL.pimattributevalueid))
		   
				INSERT INTO ZnodePimProductAttributeDefaultValue      
				(PimAttributeValueId,      
				LocaleId,      
				PimAttributeDefaultValueId,      
				CreatedBy,      
				CreatedDate,      
				ModifiedBy,      
				ModifiedDate      
				)      
				SELECT DISTINCT TBPAV.PimAttributeValueId,      
					@LocaleId,      
					TBPAV.PimAttributeDefaultValueId,      
					@UserId,      
					@GetDate,      
					@UserId,      
					@GetDate      
				FROM @TBL_PimProductId TBPP      
					INNER JOIN @TBL_PimAttributeValueId TBPAV ON(TBPAV.PimProductId = TBPP.PimProductId      
																AND TBPAV.PimAttributeId = TBPP.PimAttributeId)      
																AND @IsUnAssociated = 0      
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)
				AND NOT EXISTS (SELECT * FROM ZnodePimProductAttributeDefaultValue WHERE PimAttributeValueId =TBPAV.PimAttributeValueId AND PimAttributeDefaultValueId = TBPP.PimAttributeDefaultValueId )
				  
				UPDATE ZPAVL      
				SET AttributeValue =@AttributeValue      
				FROM ZnodePimAttributeValueLocale ZPAVL       
				INNER JOIN @TBL_PimAttributeValueId TBPAV ON( TBPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId )      
																AND @IsUnAssociated = 0  
   
      
				INSERT INTO ZnodePimAttributeValueLocale      
				(PimAttributeValueId,      
				LocaleId,      
				AttributeValue,      
				CreatedBy,      
				CreatedDate,      
				ModifiedBy,      
				ModifiedDate      
				)      
				SELECT TBPAV.PimAttributeValueId,      
					@LocaleId,      
					TBPP.AttributeValue,      
					@UserId,      
					@GetDate,      
					@UserId,      
					@GetDate      
				FROM @TBL_PimProductId TBPP      
					INNER JOIN @TBL_PimAttributeValueId TBPAV ON(TBPAV.PimProductId = TBPP.PimProductId      
																AND TBPAV.PimAttributeId = TBPP.PimAttributeId)      
																WHERE @IsUnAssociated = 0      
				AND NOT EXISTS (SELECT TOP 1 1 FROM @TBL_DefaultAttributeId TBL WHERE TBL.PimAttributeId = TBPP.PimAttributeId)      
				AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale TBH WHERE TBH.PimAttributeValueId = TBPAV.PimAttributeValueId);      
				  
				 SELECT *  INTO #TBL_PimProductId
			 FROM @TBL_PimProductId


			  IF @LocaleId = 1
			 BEGIN 	 
	
DECLARE @sqlt NVARCHAr(max) = ''
DECLARE @AttributeCodeAtt VARCHAR(600) , @PimAttributeIdAttr int 

DECLARE Cur_AttributeDataUpdate CURSOR FOR 



SELECT b.AttributeCode , PimAttributeId 
FROM INFORMATION_SCHEMA.COLUMNS a 
INNER JOIN ZnodePimAttribute b ON (a.COLUMN_NAME = b.AttributeCode )
WHERE TABLE_NAME = 'ZnodePimProduct'
AND IsCategory = 0 
AND IsShowOnGrid = 1 
AND EXISTS (SELECT TOP 1 1 FROM @TBL_PimProductId n  WHERE n.AttributeCode = b.AttributeCode  )
OPEN Cur_AttributeDataUpdate 
FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
WHILE @@FETCH_STATUS = 0 
BEGIN 

 SET @sqlt = 'UPDATE a  
 SET '+@AttributeCodeAtt+'= AttributeValue 
 FROM ZnodePimProduct a 
 INNER JOIN #TBL_PimProductId m ON(m.PimProductId = a.pimProductId ) 
 WHERE m.AttributeCode = '''+@AttributeCodeAtt+'''
 ' 

 EXEC (@sqlt)

FETCH NEXT FROM Cur_AttributeDataUpdate INTO @AttributeCodeAtt,@PimAttributeIdAttr 
END 
CLOSE Cur_AttributeDataUpdate
DEALLOCATE Cur_AttributeDataUpdate 

END 

			






				SET @Status = 1;      
				SELECT 1 AS ID,      
				CAST(1 AS BIT) AS [Status];      
      
			COMMIT TRAN UpdateAttributeValue;      
		END TRY      
		BEGIN CATCH      
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),       
		@ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdateAttributeValue @ProductId = '+      
		@ProductId+',@PimAttributeCode='+@PimAttributeCode+',@Status='+CAST(@Status AS VARCHAR(50))+      
		',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@AttributeValue='+CAST(@AttributeValue AS NVARCHAR(MAX))+',@UserId='+CAST(@UserId AS NVARCHAR(50));      
		SET @Status = 0;      
		SELECT 1 AS ID,      
		CAST(0 AS BIT) AS [Status],      
		@ErrorMessage;      
		ROLLBACK TRAN UpdateAttributeValue;      
		EXEC Znode_InsertProcedureErrorLog      
		@ProcedureName = 'Znode_UpdateAttributeValue',      
		@ErrorInProcedure = @Error_procedure,      
		@ErrorMessage = @ErrorMessage,      
		@ErrorLine = @ErrorLine,      
		@ErrorCall = @ErrorCall;      
		END CATCH;      
     END

GO

INSERT INTO ZNodePaymentGateway
   ([GatewayName], [WebsiteURL], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GatewayCode])
SELECT
    N'PaypalExpress', N'http://www.paypal.com', 2, GETDATE(), 2, GETDATE(), N'paypalexpress'
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZNodePaymentGateway 
                WHERE [GatewayCode] = 'paypalexpress')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductPricingBySku')
	DROP PROC Znode_GetPublishProductPricingBySku
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductPricingBySku]
(   
    @SKU              VARCHAR(MAX),
    @PortalId         INT,
    @currentUtcDate   VARCHAR(100), -- this date is required for the user date r
    @UserId           INT          = 0, -- userid is optional
	@ProfileId        INT          = 0, 
	@OmsOrderId		  INT        = 0,
	@IsFetchPriceFromOrder  BIT          = 0,
    @PublishProductId TransferId READONLY,
	@IsDebug          BIT          = 0
)
AS 
/* 
--Summary: Retrive Price of product FROM pricelist
--Input Parameters:
--UserId, SKU(Comma separated multiple), PortalId
--Conditions :
--1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
--Unit Testing : 
--EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
--2. If There is no any PriceList having given sku associated to profile  then check for  
--PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--Unit Testing : 
--EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
--3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--4. If There is no any PriceList having given sku associated to user  then check for  
--PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--5. If There is no any PriceList having given sku associated to account  then check for  
--PriceList associated Profile having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--6. If There is no any PriceList having given sku associated to Profile  then check for  
--PriceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--7. If in each case Precedence is same then get PriceList according to higher PriceListId ActivationDate and ExpirationDate for PriceList and SKU also.
--8. Also get the Tier Price, Tier Quantity of given sku.
--Unit Testing   
--Exec Znode_GetPublishProductPricingBySku  @SKU = 'Levi''s T-Shirt & Jeans - Bundle Product',@PortalId = 1, @currentUtcDate = '2016-07-31 00:00:00.000'
*/
    
     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             CREATE TABLE #Tlb_SKU 
             (
				SKU        VARCHAR(100),
				SequenceNo INT IDENTITY
             );

			 CREATE INDEX Idx_#Tlb_SKU ON #Tlb_SKU(SKU)
			  
			 DECLARE @DefaultLocaleId INT = dbo.FN_GETDEFAULTLocaleId()

			 IF @SKU = '' 
			 BEGIN 
				INSERT INTO #Tlb_SKU(SKU)
				SELECT a.SKU
				FROM ZnodePublishProductEntity a with (nolock) 
				INNER JOIN @PublishProductId b ON (b.Id = a.ZnodeProductId )
				WHERE LocaleId = @DefaultLocaleId

			 END 
			 ELSE 
			 BEGIN
				INSERT INTO #Tlb_SKU(SKU)
				SELECT Item FROM Dbo.split(@SKU, ',');
			 END 

		-- DECLARE #TLB_SKUPRICELIST TABLE
		CREATE TABLE #TLB_SKUPRICELIST
		(
			SKU VARCHAR(100),
			RetailPrice NUMERIC(28, 6),
			SalesPrice NUMERIC(28, 6),
			PriceListId INT,
			TierPrice NUMERIC(28, 6),
			TierQuantity NUMERIC(28, 6),
			ExternalId NVARCHAR(2000),
			Custom1 NVARCHAR(MAX),
			Custom2 NVARCHAR(MAX),
			Custom3 NVARCHAR(MAX)
        );
        DECLARE @PriceListId INT, @PriceRoundOff INT;
        SELECT @PriceRoundOff = CONVERT( INT, FeatureValues)
        FROM ZnodeGlobalSetting
        WHERE FeatureName = 'PriceRoundOff';
		
        --Retrive portal wise pricelist  
		CREATE TABLE #Tbl_PortalWisePriceList  
		(
			PriceListId    INT,
			ActivationDate DATETIME,
			ExpirationDate DATETIME NULL,
			Precedence     INT,
			SKU NVARCHAR(300)
        );
        --Retrive price for respective pricelist   
        CREATE TABLE #Tbl_PriceListWisePriceData 
        (
			PriceListId INT,
			SKU VARCHAR(300),
			SalesPrice NUMERIC(28, 6),
			RetailPrice NUMERIC(28, 6),
			UomId INT,
			UnitSize NUMERIC(28, 6),
			ActivationDate DATETIME,
			ExpirationDate DATETIME NULL,
			TierPrice NUMERIC(28, 6),
			TierQuantity NUMERIC(28, 6),
			TierUomId INT,
			TierUnitSize NUMERIC(28, 6), 
			ExternalId NVARCHAR(2000),
			Custom1 NVARCHAR(MAX),
			Custom2 NVARCHAR(MAX),
			Custom3 NVARCHAR(MAX)
        );
			
	CREATE TABLE #Tbl_SKUWisePriceList(PriceListId INT, SKU NVARCHAR(300))

			INSERT INTO #Tbl_SKUWisePriceList(PriceListId,SKU) 
			SELECT  PriceListId,SKU from ZnodePrice ZP where exists(Select SKU from #Tlb_SKU SKU where SKU.SKU = ZP.SKU )
			Union
			SELECT PriceListId,SKU  from ZnodePriceTier ZPT where exists(Select SKU from #Tlb_SKU SKU where SKU.SKU = ZPT.SKU )
			 
	--1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
    IF @UserId = 0
    BEGIN
		INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
		SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
		FROM ZnodePriceList AS a 
		INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
		INNER JOIN ZnodePortalProfile AS c ON b.PortalProfileId = c.PortalProfileID AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId 
		INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
		WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId
		ORDER BY b.Precedence;
		
			 
		--2. If There is no any PriceList having given sku associated to profile  then check for PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1  FROM #Tbl_SKUWisePriceList tspl WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
					WHERE tspl.SKU = tpwl.SKU))
		BEGIN
			INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
			SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
			FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
			INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
			INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
			AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
			WHERE @CurrentUtcDate BETWEEN a.ActivationDate 
			AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
			ORDER BY b.Precedence
			;				
		END;
    END;
    --3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    ELSE
    BEGIN
				 
		INSERT INTO #Tbl_PortalWisePriceList (PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
		SELECT a.PriceListId, ActivationDate,ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
		FROM ZnodePriceList AS a 
		INNER JOIN ZnodePriceListUser AS b ON a.PriceListId = b.PriceListId
		INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId  
		INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
		WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.UserID = @UserId
		ORDER BY b.Precedence ;

		--4. If There is no any PriceList having given sku associated to user  then check for PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1  FROM #Tbl_SKUWisePriceList tspl WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))
						BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
								   SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), c.Precedence,tsw.SKU
								   FROM ZnodePriceList AS a INNER JOIN ZnodePriceListAccount AS c ON a.PriceListId = c.PriceListId
										INNER JOIN ZnodeUser AS d ON c.Accountid = d.Accountid INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
										AND zupu.PortalId = @PortalId
										inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								   WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND d.UserID = @UserId
									ORDER BY c.Precedence
							--Delete from #Tbl_SKUWisePriceList where PriceListId in (Select PriceListId from  #Tbl_PortalWisePriceList )
						 END;
                     -- 5. If There is no any PriceList having given sku associated to account  then check for PriceList associated Profile having PortalId and having higher   Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
				IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl 
				where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
                             INSERT INTO #Tbl_PortalWisePriceList(PriceListId,ActivationDate,ExpirationDate,Precedence,SKU)
                                    SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
                                    FROM ZnodePriceList AS a
                                         INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
										 INNER JOIN ZnodePortalProfile AS c ON b.PortalProfileId = c.PortalProfileId  AND c.PortalId = @PortalId                                          
                                         INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId 
										 inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
										 AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
                                    WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) 
									AND EXISTS (SELECT TOP 1 1 FROM dbo.ZnodeUserProfile zup WHERE c.ProfileId = zup.ProfileId AND (IsDefault = 1 OR   @ProfileId <> 0)
									AND (( zup.UserId = @UserId OR  @ProfileId <> 0) AND (ZUP.ProfileId = @ProfileId OR @ProfileId = 0 )));  
					     END;
                   ---6. If There is no any PriceList having given sku associated to Profile  then check for priceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
						IF Exists (Select top 1 1 FROM #Tbl_SKUWisePriceList tspl 
						WHERE NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl WHERE tspl.SKU = tpwl.SKU))

                         BEGIN
							INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
							SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
							FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
								INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId AND  zupu.PortalId = b.PortalId    
								inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
								AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
								WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
							    ORDER BY b.Precedence;
						 END;
						 
				--IF Exists (Select top 1 1  FROM #Tbl_SKUWisePriceList tspl where NOT Exists (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				--WHERE tspl.SKU = tpwl.SKU))
				--BEGIN
				
				--	INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
				--	SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
				--	FROM ZnodePriceList AS a INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId INNER JOIN ZnodePortalProfile AS c
				--	ON b.ProfileId = c.ProfileId AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CurrencyId = zupu.CurrencyId
				--	inner join #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				--	AND NOT EXISTS (Select TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
				--	WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId;
				--END

                 END;
			
             SET @PriceListId = 0;
             -- Check Activation date and expiry date 
			
			 If (@OmsOrderId>0  and  @IsFetchPriceFromOrder=1)
			   begin 
			      EXEC Znode_GetOrderPricList @OmsOrderId=@OmsOrderId,@SKU=@SKU,@PublishProductId=@PublishProductId;
		       end


             else 
			 begin
				 IF EXISTS( SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList)
					 begin
						 -- Declare  @d datetime
						 -- SET @d = @GetDate
						 -- Select ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ),b.Precedence,* from ZnodePriceList  a inner join ZnodePriceListPortal b on a.PriceListId = b.PriceListId where @d between ISNULL(ActivationDate,@d) 
						 -- and ISNULL(ExpirationDate,@GetDate ) --and a.PriceListId <>  80
						 -- Order by ISNULL(ActivationDate,@d)  , ISNULL( ExpirationDate,@GetDate ) ,  b.Precedence DESC 
						 --	Retrive pricelist wise price
					   
					   SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

					   INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize , ExternalId ,Custom1,Custom2,Custom3)
					   SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, ZP.ExternalId,
					   ZPT.Custom1,ZPT.Custom2,ZPT.Custom3
					   FROM [ZnodePrice] AS ZP 
					   INNER JOIN #Tlb_SKU AS TSKU ON (ZP.SKU = TSKU.SKU )
					   LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId
					   WHERE ZP.PriceListId = @PriceListId

					   -- Check Activation date and expiry date 
						INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3 )
						   SELECT DISTINCT  PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
						   FROM #Tbl_PriceListWisePriceData
						   WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					   
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData
			WHERE SKU NOT IN(SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null 
				
        END;
        -- Retrive data as per precedance FROM ZnodePriceListPortal table  
					
        ELSE
        BEGIN
			SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

			--Retrive pricelist wise price  
			INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize, ExternalId ,Custom1,Custom2,Custom3)
			SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), 
				ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, zp.ExternalId,Custom1,Custom2,Custom3
			FROM [ZnodePrice] AS ZP INNER JOIN #Tlb_SKU AS TSKU ON ZP.SKU = TSKU.SKU LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND 
					ZP.PriceListId = ZPT.PriceListId WHERE ZP.PriceListId = @PriceListId; 

				-- Check Activation date and expiry date 
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData
			WHERE SKU NOT IN ( SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null;

        END;
        SELECT SKU,
            ROUND(RetailPrice, @PriceRoundOff) AS RetailPrice,
            ROUND(SalesPrice, @PriceRoundOff) AS SalesPrice,
            ROUND(TierPrice, @PriceRoundOff) AS TierPrice,
            ROUND(TierQuantity, @PriceRoundOff) AS TierQuantity,
			ZCC.CurrencyCode  AS CurrencyCode,    
            ZC.Symbol AS CurrencySuffix,  ZC.CultureCode,
			TSPL.ExternalId,
			Custom1,Custom2,Custom3
        FROM #TLB_SKUPRICELIST AS TSPL
        INNER JOIN ZnodePriceList AS ZPL ON TSPL.PriceListId = ZPL.PriceListId
        INNER JOIN ZnodeCulture AS ZC ON ZPL.CultureId = ZC.CultureId    
		LEFT JOIN ZnodeCurrency AS ZCC ON ZC.CurrencyId = ZCC.CurrencyId   
		ORDER BY TierQuantity ASC;
END
END TRY
BEGIN CATCH
    DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductPricingBySku @SKU = '+@SKU+',@PortalId = '+CAST(@PortalId AS VARCHAR(10))+',@currentUtcDate = '+@currentUtcDate+',@UserId='+CAST(@UserId AS VARCHAR(100))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPublishProductPricingBySku',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishProductPricingBySkuBundle')
	DROP PROC Znode_GetPublishProductPricingBySkuBundle
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishProductPricingBySkuBundle]
(   
	@SKU VARCHAR(MAX),
	@PortalId INT,
	@currentUtcDate VARCHAR(100), -- this date is required for the user date r
	@UserId INT = 0, -- userid is optional
	@ProfileId INT = 0, 
	@IsBundleProduct BIT = 0,
	@ParentSKU VARCHAR(600) = '',
	@PublishProductId TransferId READONLY,	
	@IsDebug BIT = 0
)
AS 
/* 
--Summary: Retrive Price of product FROM pricelist
--Input Parameters:
--UserId, SKU(Comma separated multiple), PortalId
--Conditions :
--1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
--Unit Testing : 
--EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
--2. If There is no any PriceList having given sku associated to profile  then check for  
--PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--Unit Testing : 
--EXEC Znode_GetPublishProductPricingBySku_2 @SKU = 'apple,apr234' , @PortalId = 34 , @currentUtcDate = '2016-09-17 00:00:00.000';
--3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--4. If There is no any PriceList having given sku associated to user  then check for  
--PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--5. If There is no any PriceList having given sku associated to account  then check for  
--PriceList associated Profile having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--6. If There is no any PriceList having given sku associated to Profile  then check for  
--PriceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
--7. If in each case Precedence is same then get PriceList according to higher PriceListId ActivationDate and ExpirationDate for PriceList and SKU also.
--8. Also get the Tier Price, Tier Quantity of given sku.
--Unit Testing   
--Exec Znode_GetPublishProductPricingBySku  @SKU = 'Levi''s T-Shirt & Jeans - Bundle Product',@PortalId = 1, @currentUtcDate = '2016-07-31 00:00:00.000'
*/
    
BEGIN
BEGIN TRY
SET NOCOUNT ON;
		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
        DECLARE @Tlb_SKU TABLE (SKU VARCHAR(100), SequenceNo INT IDENTITY);

		DECLARE @DefaultLocaleId INT = dbo.FN_GETDEFAULTLocaleId()

		IF @SKU = '' 
		BEGIN 
			INSERT INTO @Tlb_SKU(SKU)
			SELECT SKU
			FROM ZnodePublishProductEntity a with(nolock)
			INNER JOIN @PublishProductId b ON (b.Id = a.ZnodeProductId )
			WHERE LocaleId = @DefaultLocaleId
		END 
		ELSE 
		BEGIN
			INSERT INTO @Tlb_SKU(SKU)
			SELECT Item FROM Dbo.split(@SKU, ',');
		END 

		-- DECLARE #TLB_SKUPRICELIST TABLE
		CREATE TABLE #TLB_SKUPRICELIST
		(
			SKU VARCHAR(100),
			RetailPrice NUMERIC(28, 6),
			SalesPrice NUMERIC(28, 6),
			PriceListId INT,
			TierPrice NUMERIC(28, 6),
			TierQuantity NUMERIC(28, 6),
			ExternalId NVARCHAR(2000),
			Custom1 NVARCHAR(MAX),
			Custom2 NVARCHAR(MAX),
			Custom3 NVARCHAR(MAX)
        );
        DECLARE @PriceListId INT, @PriceRoundOff INT;
        SELECT @PriceRoundOff = CONVERT( INT, FeatureValues)
        FROM ZnodeGlobalSetting
        WHERE FeatureName = 'PriceRoundOff';
		
        --Retrive portal wise pricelist  
		CREATE TABLE #Tbl_PortalWisePriceList  
		(
			PriceListId    INT,
			ActivationDate DATETIME,
			ExpirationDate DATETIME NULL,
			Precedence     INT,
			SKU NVARCHAR(300)
        );
        --Retrive price for respective pricelist   
        CREATE TABLE #Tbl_PriceListWisePriceData 
        (
			PriceListId INT,
			SKU VARCHAR(300),
			SalesPrice NUMERIC(28, 6),
			RetailPrice NUMERIC(28, 6),
			UomId INT,
			UnitSize NUMERIC(28, 6),
			ActivationDate DATETIME,
			ExpirationDate DATETIME NULL,
			TierPrice NUMERIC(28, 6),
			TierQuantity NUMERIC(28, 6),
			TierUomId INT,
			TierUnitSize NUMERIC(28, 6), 
			ExternalId NVARCHAR(2000),
			Custom1 NVARCHAR(MAX),
			Custom2 NVARCHAR(MAX),
			Custom3 NVARCHAR(MAX)
        );
			
	CREATE TABLE #Tbl_SKUWisePriceList(PriceListId INT, SKU NVARCHAR(300))
	 
	IF @IsBundleProduct = 1
	BEGIN
		SELECT ZPAV.PimProductId,ZPAVL.AttributeValue AS Child_SKU, ZPAVL_PAR.AttributeValue AS Parent_SKU,ZPAV_PAR.PimProductId AS Parent_PimProductId
		INTO #BundleProductAssociation
		FROM ZnodePimAttributeValue ZPAV 
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePimProductTypeAssociation ZPPTA ON ZPAV.PimProductId = ZPPTA.PimProductId
		INNER JOIN ZnodePimAttributeValue ZPAV_PAR ON ZPAV_PAR.PimProductId = ZPPTA.PimParentProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL_PAR ON ZPAV_PAR.PimAttributeValueId = ZPAVL_PAR.PimAttributeValueId
		WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode = 'SKU')
		AND EXISTS(SELECT * FROM ZnodePimAttribute ZPA_PAR WHERE ZPAV_PAR.PimAttributeId = ZPA_PAR.PimAttributeId AND ZPA_PAR.AttributeCode = 'SKU')
		AND EXISTS(SELECT SKU FROM @Tlb_SKU SKU WHERE SKU.SKU = ZPAVL.AttributeValue )
	
		INSERT INTO #Tbl_SKUWisePriceList(PriceListId,SKU) 
		SELECT ZP.PriceListId,BPA.Child_SKU 
		FROM ZnodePrice ZP 
		INNER JOIN #BundleProductAssociation BPA ON ZP.SKU = BPA.Parent_SKU
		WHERE ZP.SKU = @ParentSKU
		UNION
		SELECT ZPT.PriceListId,BPA.Child_SKU  
		FROM ZnodePriceTier ZPT 
		INNER JOIN #BundleProductAssociation BPA ON ZPT.SKU = BPA.Parent_SKU
		WHERE ZPT.SKU = @ParentSKU
	END
	ELSE
	BEGIN
		INSERT INTO #Tbl_SKUWisePriceList(PriceListId,SKU) 
		SELECT  PriceListId,SKU FROM ZnodePrice ZP WHERE EXISTS(SELECT SKU FROM @Tlb_SKU SKU WHERE SKU.SKU = ZP.SKU )
		UNION
		SELECT PriceListId,SKU  FROM ZnodePriceTier ZPT WHERE EXISTS(SELECT SKU FROM @Tlb_SKU SKU WHERE SKU.SKU = ZPT.SKU )
	END	
	--1. If userId is null then check for PriceList having sku associated to profile which is associated to Portal having  PortalId and  having higher Precedence and valid ActivationDate and ExpirationDate for PriceList  and SKU also.
    IF @UserId = 0
    BEGIN

		INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
		SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
		FROM ZnodePriceList AS a 
		INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
		INNER JOIN ZnodePortalProfile AS c ON b.PortalProfileId = c.PortalProfileID AND  c.IsDefaultAnonymousProfile = 1 INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId 
		INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
		WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND c.PortalId = @PortalId
		ORDER BY b.Precedence;
		
			 
		--2. If There is no any PriceList having given sku associated to profile  then check for PriceList associated portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1  FROM #Tbl_SKUWisePriceList tspl WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
					WHERE tspl.SKU = tpwl.SKU))
		BEGIN

			INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
			SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
			FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
			INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
			INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
			AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
			WHERE @CurrentUtcDate BETWEEN a.ActivationDate 
			AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
			ORDER BY b.Precedence
			;				
		END;
    END;
    --3. If userId is not null then check for PriceList having sku associated to User having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
    ELSE
    BEGIN
		INSERT INTO #Tbl_PortalWisePriceList (PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
		SELECT a.PriceListId, ActivationDate,ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
		FROM ZnodePriceList AS a 
		INNER JOIN ZnodePriceListUser AS b ON a.PriceListId = b.PriceListId
		INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId  
		INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
		WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.UserID = @UserId
		ORDER BY b.Precedence ;


		--4. If There is no any PriceList having given sku associated to user  then check for PriceList associated Account having UserId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1  FROM #Tbl_SKUWisePriceList tspl WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
				WHERE tspl.SKU = tpwl.SKU))
		BEGIN

			INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
			SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), c.Precedence,tsw.SKU
			FROM ZnodePriceList AS a INNER JOIN ZnodePriceListAccount AS c ON a.PriceListId = c.PriceListId
				INNER JOIN ZnodeUser AS d ON c.Accountid = d.Accountid INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId   
				AND zupu.PortalId = @PortalId
				INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
				AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
			WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND d.UserID = @UserId
			ORDER BY c.Precedence

		END;
            -- 5. If There is no any PriceList having given sku associated to account  then check for PriceList associated Profile having PortalId and having higher   Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1  FROM #Tbl_SKUWisePriceList tspl 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl
			WHERE tspl.SKU = tpwl.SKU))
        BEGIN
            INSERT INTO #Tbl_PortalWisePriceList(PriceListId,ActivationDate,ExpirationDate,Precedence,SKU)
                SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
                FROM ZnodePriceList AS a
                        INNER JOIN ZnodePriceListProfile AS b ON a.PriceListId = b.PriceListId 
						INNER JOIN ZnodePortalProfile AS c ON b.PortalProfileId = c.PortalProfileId  AND c.PortalId = @PortalId 
                        INNER JOIN ZnodePortalunit zupu ON a.CultureId = zupu.CultureId AND zupu.PortalId = @PortalId 
						INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
						AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
                WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate)  
				AND EXISTS (SELECT TOP 1 1 FROM dbo.ZnodeUserProfile zup WHERE c.ProfileId = zup.ProfileId AND (IsDefault = 1 OR   @ProfileId <> 0)
				AND (( zup.UserId = @UserId OR  @ProfileId <> 0) AND (ZUP.ProfileId = @ProfileId OR @ProfileId = 0 )))
	
		END;
		---6. If There is no any PriceList having given sku associated to Profile  then check for priceList associated Portal having PortalId and having higher Precedence ActivationDate and ExpirationDate for PriceList and SKU also.
		IF EXISTS (SELECT top 1 1 FROM #Tbl_SKUWisePriceList tspl 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList tpwl WHERE tspl.SKU = tpwl.SKU))
        BEGIN
			INSERT INTO #Tbl_PortalWisePriceList( PriceListId, ActivationDate, ExpirationDate, Precedence,SKU )
			SELECT a.PriceListId, ActivationDate, ISNULL(ExpirationDate, @GetDate), b.Precedence,tsw.SKU
			FROM ZnodePriceList AS a INNER JOIN ZnodePriceListPortal AS b ON a.PriceListId = b.PriceListId
			INNER JOIN ZnodePortalunit AS zupu ON a.CultureId = zupu.CultureId AND  zupu.PortalId = b.PortalId    
			INNER JOIN #Tbl_SKUWisePriceList tsw  ON a.PriceListId = tsw.PriceListId
			AND NOT EXISTS (SELECT TOP 1 1 FROM  #Tbl_PortalWisePriceList tpwl WHERE tpwl.SKU = tsw.SKU )
			WHERE @CurrentUtcDate BETWEEN a.ActivationDate AND ISNULL(a.ExpirationDate, @GetDate) AND b.PortalId = @PortalId
			ORDER BY b.Precedence;
		END;
				
	END;
			
        SET @PriceListId = 0;
        -- Check Activation date and expiry date 
        IF EXISTS( SELECT TOP 1 1 FROM #Tbl_PortalWisePriceList)
        BEGIN

			IF @IsBundleProduct = 1
			BEGIN
				INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize , ExternalId ,Custom1,Custom2,Custom3)
				SELECT ZP.PriceListId, TSKU.Child_SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, ZP.ExternalId,
				ZPT.Custom1,ZPT.Custom2,ZPT.Custom3
				FROM [ZnodePrice] AS ZP 
				INNER JOIN #BundleProductAssociation AS TSKU ON (ZP.SKU = TSKU.Parent_SKU )
				LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId
				WHERE ZP.SKU = @ParentSKU AND
				ZP.PriceListId IN
				(
					SELECT TOP 1 PriceListId
					FROM #Tbl_PortalWisePriceList AS TBPWPL
					WHERE  TBPWPL.SKU = TSKU.Child_SKU
					ORDER BY Precedence 
				);

			END
			ELSE
			BEGIN
				INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize , ExternalId ,Custom1,Custom2,Custom3)
				SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, ZP.ExternalId,
				ZPT.Custom1,ZPT.Custom2,ZPT.Custom3
				FROM [ZnodePrice] AS ZP 
				INNER JOIN @Tlb_SKU AS TSKU ON (ZP.SKU = TSKU.SKU )
				LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId
				WHERE ZP.PriceListId IN
				(
					SELECT TOP 1 PriceListId
					FROM #Tbl_PortalWisePriceList AS TBPWPL
					WHERE  TBPWPL.SKU = ZP.SKU
					ORDER BY Precedence 
				);
			END
			-- Check Activation date and expiry date 
            INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3 )
				SELECT DISTINCT  PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
				FROM #Tbl_PriceListWisePriceData
				WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					   
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData
			WHERE SKU NOT IN(SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null 
				
        END;
        -- Retrive data as per precedance FROM ZnodePriceListPortal table  
					
        ELSE
        BEGIN
			SET @PriceListId =( SELECT TOP 1 PriceListId FROM #Tbl_PortalWisePriceList ORDER BY Precedence  );

			IF @IsBundleProduct = 1
			BEGIN
			
				--Retrive pricelist wise price  
				INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize, ExternalId ,Custom1,Custom2,Custom3)
				SELECT ZP.PriceListId, TSKU.Child_SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), 
					ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, zp.ExternalId,Custom1,Custom2,Custom3
				FROM [ZnodePrice] AS ZP 
				INNER JOIN #BundleProductAssociation AS TSKU ON ZP.SKU = TSKU.Parent_SKU 
				LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId 
				WHERE ZP.SKU = @ParentSKU AND ZP.PriceListId = @PriceListId; 
			END
			ELSE
			BEGIN
				--Retrive pricelist wise price  
				INSERT INTO #Tbl_PriceListWisePriceData( PriceListId, SKU, SalesPrice, RetailPrice, UomId, UnitSize, ActivationDate, ExpirationDate, TierPrice, TierQuantity, TierUomId, TierUnitSize, ExternalId ,Custom1,Custom2,Custom3)
				SELECT ZP.PriceListId, ZP.SKU, ZP.SalesPrice, ZP.RetailPrice, ZP.UomId, ZP.UnitSize, ISNULL(ZP.ActivationDate, @CurrentUtcDate), 
					ISNULL(ZP.ExpirationDate, @GetDate), ZPT.Price, ZPT.Quantity, ZPT.UomId, ZPT.UnitSize, zp.ExternalId,Custom1,Custom2,Custom3
				FROM [ZnodePrice] AS ZP 
				INNER JOIN @Tlb_SKU AS TSKU ON ZP.SKU = TSKU.SKU 	
				LEFT OUTER JOIN ZnodePriceTier AS ZPT ON ZP.SKU = ZPT.SKU AND ZP.PriceListId = ZPT.PriceListId 
				WHERE ZP.PriceListId = @PriceListId; 
			END
				-- Check Activation date and expiry date 
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData WHERE @currentUtcDate BETWEEN ActivationDate AND ISNULL(ExpirationDate, @GetDate);
					
			INSERT INTO #TLB_SKUPRICELIST( PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId ,Custom1,Custom2,Custom3)
			SELECT PriceListId, SKU, RetailPrice, SalesPrice, TierPrice, TierQuantity, ExternalId,Custom1,Custom2,Custom3
			FROM #Tbl_PriceListWisePriceData
			WHERE SKU NOT IN ( SELECT SKU FROM #TLB_SKUPRICELIST) and ActivationDate is null;

        END;
		
        SELECT SKU,
            ROUND(RetailPrice, @PriceRoundOff) AS RetailPrice,
            ROUND(SalesPrice, @PriceRoundOff) AS SalesPrice,
            ROUND(TierPrice, @PriceRoundOff) AS TierPrice,
            ROUND(TierQuantity, @PriceRoundOff) AS TierQuantity,
			ZCC.CurrencyCode  AS CurrencyCode,    
            ZC.Symbol AS CurrencySuffix,  ZC.CultureCode,
			TSPL.ExternalId,
			Custom1,Custom2,Custom3
        FROM #TLB_SKUPRICELIST AS TSPL
        INNER JOIN ZnodePriceList AS ZPL ON TSPL.PriceListId = ZPL.PriceListId
        INNER JOIN ZnodeCulture AS ZC ON ZPL.CultureId = ZC.CultureId    
		LEFT JOIN ZnodeCurrency AS ZCC ON ZC.CurrencyId = ZCC.CurrencyId   
		ORDER BY TierQuantity ASC;

END TRY
BEGIN CATCH
    DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishProductPricingBySkuBundle @SKU = '+@SKU+',@PortalId = '+CAST(@PortalId AS VARCHAR(10))+',@currentUtcDate = '+@currentUtcDate+',@UserId='+CAST(@UserId AS VARCHAR(100))+',@IsBundleProduct='+CAST(@UserId AS VARCHAR(100))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPublishProductPricingBySkuBundle',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSkuPricebyCatalog')
	DROP PROC Znode_GetSkuPricebyCatalog
GO

CREATE PROCEDURE [dbo].[Znode_GetSkuPricebyCatalog]
(   @WhereClause		NVARCHAR(max),
    @Rows				INT            = 100,
    @PageNo				INT            = 1,
    @Order_BY			VARCHAR(1000)  = '',
    @RowsCount			INT  out,
	@LocaleId			INT			   = 0,
	@Sku                VARCHAR(MAX),
	@PortalId		    INT = 0,
	@currentUtcDate     VARCHAR(200) = '',
	@PublishProductId   ProductForSortPrice READONLY,
	@IsInStock			varchar(5) ,
	@IsSorting			Bit = 1 
)		
AS 
/*
    Summary: This procedure is used to find the PriceList by catalog 
	Unit Testing: 
	
    @IsInStock --- for 1 - In stock data , for 0 - out off stock data , for -1 - all data

	declare @p7 int
	set @p7=NULL
	declare @p12 dbo.ProductForSortPrice
	insert into @p12 values(947,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(948,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(949,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(950,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(951,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(953,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(957,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1002,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1003,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1004,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1005,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1026,N'BundleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1030,N'BundleProduct',N'DisablePurchasing',1)
	insert into @p12 values(1039,N'GroupedProduct',N'DontTrackInventory',0)
	insert into @p12 values(1013,N'BundleProduct',N'AllowBackOrdering',0)
	insert into @p12 values(1031,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1032,N'SimpleProduct',N'DisablePurchasing',0)
	insert into @p12 values(1042,N'SimpleProduct',N'DisablePurchasing',0)

	exec sp_executesql N'Znode_GetSkuPricebyCatalog  @WhereClause,@Rows,@PageNo,@Order_By,@RowCount OUT
	,@LocaleId,@Sku,@PortalId,@currentUtcDate,@PublishProductId,@IsInStock',N'@WhereClause nvarchar(4000),
	@Rows int,@PageNo int,@Order_By nvarchar(15),@RowCount int output,@LocaleId int,
	@Sku nvarchar(4000),@PortalId int,@currentUtcDate datetime,@PublishProductId [dbo].[ProductForSortPrice] 
	READONLY,@IsInStock nvarchar(2)',@WhereClause=N'',@Rows=16,@PageNo=1,@Order_By=N'retailprice asc',@RowCount=@p7 output,
	@LocaleId=1,@Sku=N'',@PortalId=1,@currentUtcDate='2017-11-30 00:00:00',@PublishProductId=@p12,@IsInStock=N'1'
	select @p7

	GO

	declare @p7 int
	set @p7=NULL
	declare @p12 dbo.TransferId
	insert into @p12 values(947)
	insert into @p12 values(948)
	insert into @p12 values(949)
	insert into @p12 values(950)
	insert into @p12 values(951)
	insert into @p12 values(953)
	insert into @p12 values(957)
	insert into @p12 values(1002)
	insert into @p12 values(1003)
	insert into @p12 values(1004)
	insert into @p12 values(1005)
	insert into @p12 values(1026)
	insert into @p12 values(1030)
	insert into @p12 values(1039)
	insert into @p12 values(1013)
	insert into @p12 values(1031)
	insert into @p12 values(1032)
	insert into @p12 values(1042)

	exec sp_executesql N'Znode_GetSkuPricebyCatalog  @WhereClause,@Rows,@PageNo,@Order_By,@RowCount OUT
	,@LocaleId,@Sku,@PortalId,@currentUtcDate,@PublishProductId,@IsInStock',N'@WhereClause nvarchar(4000),
	@Rows int,@PageNo int,@Order_By nvarchar(15),@RowCount int output,@LocaleId int,
	@Sku nvarchar(4000),@PortalId int,@currentUtcDate datetime,@PublishProductId [dbo].[TransferId] 
	READONLY,@IsInStock nvarchar(2)',@WhereClause=N'',@Rows=16,@PageNo=1,@Order_By=N'retailprice asc',@RowCount=@p7 output,
	@LocaleId=1,@Sku=N'',@PortalId=1,@currentUtcDate='2017-11-30 00:00:00',@PublishProductId=@p12,@IsInStock=N'1'
	select @p7

*/


     BEGIN
     BEGIN TRY
	 SET NOCOUNT ON;
			 DECLARE @ProductIdForPricing   TransferId 
             DECLARE @SQL NVARCHAR(MAX);
			 DECLARE @TBL_PricebyCatalog TABLE (SKU NVARCHAR(4000),RetailPrice numeric(28,6),RowId INT,CountNo INT,ProductType nvarchar(200),OutOfStockOptions nvarchar(200),SalesPrice numeric(28,6))
			 CREATE TABLE #TBL_PricebyCatalogforAssociateProduct  (PimProductId int ,AssociatedProductId int,ParentSKU NVARCHAR(300),
			 ChildSKU NVARCHAR(300),RetailPrice  numeric(28,6),AssociatedProductDisplayOrder int , TypeOfProduct nvarchar(100),SalesPrice  numeric(28,6))
			 DECLARE @DefaultLocaleId INT = dbo.FN_GetDefaultLocaleId()
			 
			 DECLARE @tbl_PricingSku TABLE (sku nvarchar(200),RetailPrice numeric(28,6),SalesPrice numeric(28,6),TierPrice numeric(28,6),
						TierQuantity numeric(28,6),CurrencyCode varchar(200),CurrencySuffix varchar(2000),CultureCode VARCHAR(100), ExternalId NVARCHAR(2000),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),
			  Custom3 NVARCHAR(MAX))
			  
			 CREATE TABLE #tbl_PricingSkuOfAssociatedProduct (sku nvarchar(200),RetailPrice numeric(28,6),SalesPrice numeric(28,6),TierPrice numeric(28,6),
						TierQuantity numeric(28,6),CurrencyCode varchar(200),CurrencySuffix varchar(2000),CultureCode VARCHAR(100), ExternalId NVARCHAR(2000),Custom1 NVARCHAR(MAX), Custom2 NVARCHAR(MAX),
			  Custom3 NVARCHAR(MAX))				
			
			Select [Id],[ProductType],[OutOfStockOptions],--[CallForPricing] ,
			 Convert(varchar(300),'') SKU into #PublishProductId from @PublishProductId
			
			UPDATE PDI SET PDI.SKU = ZPPD.SKU 
						from #PublishProductId PDI inner join
						ZnodePublishProductEntity ZPPD On PDI.ID = ZPPD.ZnodeProductId
		
					--Read price for all products
					--Start
					INSERT INTO @ProductIdForPricing SELECT id FROM @PublishProductId
	 
					INSERT INTO @tbl_PricingSku (sku,RetailPrice ,SalesPrice,TierPrice,TierQuantity,CurrencyCode,CurrencySuffix,CultureCode, ExternalId ,Custom1,Custom2,Custom3)	
					EXEC Znode_GetPublishProductPricingBySku   @SKU=@Sku ,@PortalId=@portaliD  ,@currentUtcDate=@currentUtcDate,@UserId=2,@PublishProductId=@ProductIdForPricing
					--End
					
					--Read Associate Products price only
					--Start

					INSERT INTO #TBL_PricebyCatalogforAssociateProduct (PimProductId ,AssociatedProductId, ParentSKU,ChildSKU,AssociatedProductDisplayOrder,TypeOfProduct ) 
					SELECT PDI.ID  PublishedId,c.ZnodeProductId PublishProductId, PDI.SKU, c.sku ,a.AssociatedProductDisplayOrder DisplayOrder ,'ConfigurableProduct'
					from #PublishProductId PDI 
					INNER JOIN ZnodePublishConfigurableProductEntity a with(nolock) ON (a.ZnodeProductId = PDI.Id)
					INNER JOIN ZnodePublishProductEntity c  with(nolock) ON (c.ZnodeProductId = a.AssociatedZnodeProductId)
					WHERE PDI.ProductType = 'ConfigurableProduct'
					
					INSERT INTO #TBL_PricebyCatalogforAssociateProduct (PimProductId ,AssociatedProductId, ParentSKU,ChildSKU,AssociatedProductDisplayOrder,TypeOfProduct ) 
					SELECT PDI.ID  PublishedId,c.ZnodeProductId PublishProductId, PDI.SKU, c.sku ,a.AssociatedProductDisplayOrder DisplayOrder ,'GroupedProduct'
					from #PublishProductId PDI 
					INNER JOIN ZnodePublishGroupProductEntity a  with(nolock) ON (a.ZnodeProductId = PDI.Id)
					INNER JOIN ZnodePublishProductEntity c  with(nolock) ON (c.ZnodeProductId = a.AssociatedZnodeProductId)
					WHERE PDI.ProductType = 'GroupedProduct'

				--	SELECT ZPP.PublishProductId PublishedId,ZPP1.PublishProductId, PDI.SKU,ChildZPPD.SKU,ZPXML.DisplayOrder ,'ConfigurableProduct'
				--	from #PublishProductId PDI 
				--	INNER JOIN ZnodePublishProduct ZPP ON PDI.id = ZPP.PublishProductId
				----	INNER JOIN ZnodePublishAssociatedProduct ZPXML ON (ZPP.PimProductId = ZPXML.ParentPimProductId) 	
				--	INNER JOIN ZnodePublishProduct ZPP1 ON ZPXML.PimProductId = ZPP1.PimProductId				
				--	Left Outer JOIN ZnodePublishProductEntity ChildZPPD On ZPP1.PublishProductId = ChildZPPD.ZnodeProductId
				--	WHERE PDI.ProductType = 'ConfigurableProduct' AND ZPXML.IsConfigurable = 1

				--	INSERT INTO #TBL_PricebyCatalogforAssociateProduct (PimProductId ,AssociatedProductId, ParentSKU,ChildSKU, TypeOfProduct ) 
				--	SELECT ZPP.PublishProductId,ZPP1.PublishProductId, PDI.SKU,ChildZPPD.SKU,'GroupedProduct'
				--	FROM #PublishProductId PDI 
				--	INNER JOIN ZnodePublishProduct ZPP ON PDI.id = ZPP.PublishProductId
				--	INNER JOIN ZnodePublishAssociatedProduct ZPXML ON (ZPP.PimProductId = ZPXML.ParentPimProductId) 	
				--	INNER JOIN ZnodePublishProduct ZPP1 ON ZPXML.PimProductId = ZPP1.PimProductId	
				--	Left Outer JOIN ZnodePublishProductEntity ChildZPPD On ZPP1.PublishProductId = ChildZPPD.ZnodeProductId
				--	WHERE PDI.ProductType = 'GroupedProduct' AND ZPXML.IsGroup = 1

				

					DELETE FROM @ProductIdForPricing 
					INSERT INTO @ProductIdForPricing 
					SELECT Distinct AssociatedProductId 
					FROM #TBL_PricebyCatalogforAssociateProduct 
					where AssociatedProductId is not null 

					INSERT INTO #tbl_PricingSkuOfAssociatedProduct (sku,RetailPrice ,SalesPrice,TierPrice,TierQuantity,CurrencyCode,CurrencySuffix,CultureCode, ExternalId,Custom1,Custom2,Custom3 )	
					EXEC Znode_GetPublishProductPricingBySku   @SKU=@Sku ,@PortalId=@portaliD  ,@currentUtcDate=@currentUtcDate,@UserId=2,@PublishProductId=@ProductIdForPricing
								

					update PLC SET PLC.RetailPrice = PLCA.RetailPrice , PLC.SalesPrice = PLCA.SalesPrice 
					FROM #TBL_PricebyCatalogforAssociateProduct PLC 
					INNER JOIN #tbl_PricingSkuOfAssociatedProduct PLCA on PLC.ChildSKU = PLCA.sku
 
		
					SELECT DISTINCT sku,RetailPrice,SalesPrice  INTO #tbl_PricingSku FROM   @tbl_PricingSku 
					UNION  ALL 
					SELECT item sku,NULL RetailPrice  ,NULL SalesPrice FROM dbo.split(@Sku,',') SP  
					WHERE NOT EXISTS (SELECT TOP 1 1  FROM @tbl_PricingSku TBSP WHERE TBSP.sku = Sp.Item) AND @Sku <> ''
					UNION ALL 
					SELECT a.SKU , NULL RetailPrice , NULL SalesPrice  FROM ZnodePublishProductEntity  a  INNER JOIN @PublishProductId b ON (b.Id = a.ZnodeProductId) 
					WHERE LocaleId = @DefaultLocaleId AND NOT EXISTS (SELECT TOP 1 1  FROM @tbl_PricingSku TBSP WHERE TBSP.sku = a.SKU) 
					AND @Sku = ''
							
					Update PBC SET PBC.RetailPrice = 
						(Select min(Isnull(RetailPrice, SalesPrice)) from #TBL_PricebyCatalogforAssociateProduct PCBA  
						where PCBA.ParentSKU =PBC.SKU and PCBA.ParentSKU is not null)
					FROM #tbl_PricingSku  PBC  where 
					EXISTS (Select TOP 1 1  from #TBL_PricebyCatalogforAssociateProduct PCBA  where PCBA.ParentSKU =PBC.SKU and PCBA.TypeOfProduct = 'GroupedProduct')
			      
				 	Update PBC SET PBC.RetailPrice = 
						(Select TOP 1 Isnull(RetailPrice ,SalesPrice) from #TBL_PricebyCatalogforAssociateProduct PCBA  where PCBA.ParentSKU =PBC.SKU
						 and PCBA.ParentSKU is not null and PCBA.ChildSKU is not null
					Order by AssociatedProductDisplayOrder)
					from #tbl_PricingSku  PBC  where 
					Exists (Select TOP 1 1  from #TBL_PricebyCatalogforAssociateProduct PCBA  where PCBA.ParentSKU =PBC.SKU and PCBA.TypeOfProduct = 'ConfigurableProduct')
					and PBC.RetailPrice IS null 
			

 			    If @IsSorting = 1 
				BEGIN
					SET @Order_BY = Replace (@Order_BY,'RetailPrice', 'Case when SalesPrice is not null then SalesPrice else RetailPrice end ')
					
					SET @SQL = 
					';WITH CTE_GetFilteredList AS
					(
						SELECT DISTINCT A.sku,A.RetailPrice,SalesPrice , '+dbo.Fn_GetPagingRowId(@Order_BY,'A.SKU DESC ')+',Count(*)Over() CountNo
						FROM #tbl_PricingSku A 
						WHERE 1=1
						'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
					)
					SELECT TOP '+Cast(@Rows AS VARCHAR(10))+' SKU,RetailPrice,SalesPrice,RowId,CountNo
					FROM CTE_GetFilteredList
					'+CASE WHEN @Order_BY = '' THEN '' ELSE ' ORDER BY '+ @Order_BY END
					--dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)+
					
				END
				Else 
				BEGIN
				
					SET @SQL = 
					';WITH CTE_GetFilteredList AS
					(
						SELECT DISTINCT A.sku,A.RetailPrice,A.SalesPrice ,'+dbo.Fn_GetPagingRowId(@Order_BY,'A.SKU DESC ')+',Count(*)Over() CountNo
						FROM #tbl_PricingSku A 
						WHERE 1=1
						'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
					)
					SELECT TOP '+Cast(@Rows AS VARCHAR(10))+' SKU,RetailPrice,SalesPrice , RowId,CountNo
					FROM CTE_GetFilteredList'
					--'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)
					--CASE WHEN @Order_BY = '' THEN '' ELSE ' ORDER BY '+ @Order_BY END
				END
		   

			INSERT INTO @TBL_PricebyCatalog(SKU,RetailPrice,SalesPrice,RowId,CountNo)
			EXEC sys.sp_sqlexec @SQL
        	
			DECLARE @TBL_PricebyCatalogFinalResult TABLE ( SKU NVARCHAR(4000), RetailPrice numeric(28,6),SalesPrice numeric(28,6) , RowId INT,CountNo INT, PublishProductId int  )
	
			IF ( @IsInStock = '-1' )  
			BEGIN 
				INSERT INTO @TBL_PricebyCatalogFinalResult ( SKU,RetailPrice,SalesPrice, RowId ,CountNo,PublishProductId )
				SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
				FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
			END
			ELSE IF ( @IsInStock = '1' )
			BEGIN	
				  INSERT INTO @TBL_PricebyCatalogFinalResult ( SKU,RetailPrice,SalesPrice, RowId ,CountNo,PublishProductId )			
					  SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU AND 1 =
					  (case when PPI.OutOfStockOptions = 'DisablePurchasing' and I.Quantity < 1 then 0 else 1 end))
					  Union All 
					  SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE NOT EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU AND 1 =
					  (case when PPI.OutOfStockOptions = 'DisablePurchasing' and I.Quantity < 1 then 0 else 1 end))
			END
			ELSE IF ( @IsInStock = '0' )
			BEGIN
		
				  INSERT INTO @TBL_PricebyCatalogFinalResult ( SKU,RetailPrice,SalesPrice, RowId ,CountNo,PublishProductId )			
					  SELECT PBC.SKU,RetailPrice,SalesPrice, RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU 
					  AND  PPI.OutOfStockOptions = 'DisablePurchasing' 
					  GROUP BY I.SKU HAVING SUM(I.Quantity ) < 1   )
					  Union all 
					  SELECT PBC.SKU,RetailPrice,SalesPrice,RowId ,CountNo,PPI.ID
					  FROM @TBL_PricebyCatalog  PBC LEft Outer JOIN #PublishProductId PPI On PBC.SKU = PPI.SKU 
					  WHERE NOT EXISTS ( SELECT TOP 1 1 FROM [dbo].[ZnodeInventory] I WHERE I.SKU = PPI.SKU 
					  AND  PPI.OutOfStockOptions = 'DisablePurchasing' 
					  GROUP BY I.SKU HAVING SUM(I.Quantity ) < 1   )

			END

			SET @RowsCount =ISNULL((SELECT TOP 1 CountNo FROM @TBL_PricebyCatalogFinalResult),0)

			SELECT SKU,RetailPrice,SalesPrice,PublishProductId FROM @TBL_PricebyCatalogFinalResult
			--Order by Isnull(RetailPrice,SalesPrice)
			
		END TRY
		BEGIN CATCH
		DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetSkuPricebyCatalog @WhereClause = '
			 +CAST(@WhereClause AS VARCHAR(MAX))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))
			 +',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(20))
			 +',@PortalId= '+cast(@PortalId as varchar(200))+',@currentUtcDate= '
			 +@currentUtcDate+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status,ERROR_MESSAGE();                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetSkuPricebyCatalog',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;

		END CATCH

	END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder 
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  rt.ParentPimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder 
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
INNER JOIN  @PimProduct_catalog rt ON ( rt.ParentPimCategoryHierarchyId = ty.PimCategoryHierarchyId  )
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = rt.ParentPimCategoryHierarchyId)
AND @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT  , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  

UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,1), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , sku=b.SKU
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 -- AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT PimCategoryId FROM  #Temp_categoryDetails ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleCategoryEntity')
	DROP PROC Znode_PublishSingleCategoryEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleCategoryEntity]
(
    @PimCategoryId  int 
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAssociate int  = 0 OUT
   ,@PimCatalogId int = 0
)
AS
/*
	To publish single category 
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@DefaultLocaleId int = dbo.fn_getdefaultLocaleId()
	SET @Status = 1 
	Declare @IsPreviewEnable int 
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionType = 'Production' OR  @RevisionType = 'None'

		
    SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId ) 
WHERE  a.IsCategory =1



SELECT DISTINCT yu.VersionId,yu.LocaleId, yu.CatalogName, yu.ZnodeCatalogId, a.PimCategoryId ,RT.ParentPimCategoryHierarchyId, rt.DisplayOrder, rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues,rt.ActivationDate, rt.ExpirationDate
		,RT.IsActive
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  ZnodePimCategoryHierarchy  rt with(nolock) ON ( rt.PimCategoryId = a.PimCategoryId  )
INNER JOIN  ZnodePublishCatalogEntity yu with(nolock) ON (yu.ZnodeCatalogId = rt.PimCatalogId)
WHERE rt.PimCategoryId =@PimCategoryId
AND yu.RevisionType IN (SELECT t.RevisionState FROM @Tbl_versions t)


SELECT DISTINCT PimCategoryHierarchyId,LocaleId,ZnodeCatalogId, CatalogName,PimCategoryId,ParentPimCategoryHierarchyId,DisplayOrder,VersionId, CategoryName, CategoryCode ,ActivationDate, ExpirationDate,IsActive
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

-- SELECT * FROM #Temp_categoryDetails

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId = t.PimCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.VersionId = a.VersionId)

INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT a.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId  = a.PimCategoryId  )+']' 
	,a.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = a.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )

DELETE t FROM ZnodePublishSeoEntity t WHERE EXISTS (SELECT TOP 1 1 FROM #Temp_categoryDetails yu WHERE yu.CategoryCode  = t.SEOCode 
AND t.CMSSEOTypeId = 2 
)

INSERT INTO ZnodePublishSeoEntity(VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,ElasticSearchEvent) 

SELECT VersionId,GETDATE(),a.SEOCode,a.CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,'Category' SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,1 ElasticSearchEvent
FROM ZnodeCMSSEODetail a 
INNER JOIN ZnodeCMSSEODetailLocale b ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN #Temp_categoryDetails c ON (c.CategoryCode = a.SEOCode )
WHERE a.CMSSEOTypeId =2 

     
	SELECT PimCategoryHierarchyId PublishCategoryId ,
			ZnodeCatalogId  PublishCatalogId  ,
           ''   CategoryXml       ,
              LocaleId          ,
			  VersionId		     FROM  #Temp_categoryDetails y 

	SELECT PortalId, y.ZnodeCatalogId PublishCatalogId, y.PimCategoryHierarchyId PublishCategoryId, y.CategoryCode, yu.SEOUrl,y. VersionId,y.LocaleId FROM ZnodePublishSeoEntity yu 
	INNER JOIN #Temp_categoryDetails y ON ( y.VersionId = yu.VersionId
	AND y.CategoryCode = yu.SEOCode)  
	
	SELECT 0 AS id,@Status AS Status;   


	UPDATE ZnodePimCategory 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PimCategoryId =@PimCategoryId

END TRY 
BEGIN CATCH 
	SET @Status =0  
	
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	-- Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleCategoryEntity
		@PimCategoryId = '+CAST(@PimCategoryId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleCategoryErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleCategoryEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleCategoryEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity
GO



CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder 
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  rt.ParentPimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder 
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
INNER JOIN  @PimProduct_catalog rt ON ( rt.ParentPimCategoryHierarchyId = ty.PimCategoryHierarchyId  )
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = rt.ParentPimCategoryHierarchyId)
AND @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder, CategoryName, CategoryCode 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD ParentPimCategoryHierarchyId INT  , IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  

UPDATE a
SET ParentPimCategoryHierarchyId = b.ParentPimCategoryHierarchyId 
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,1), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 
	    , PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT PimCategoryId FROM  #Temp_categoryDetails ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleCategoryEntity')
	DROP PROC Znode_PublishSingleCategoryEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleCategoryEntity]
(
    @PimCategoryId  int 
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAssociate int  = 0 OUT
   ,@PimCatalogId int = 0
)
AS
/*
	To publish single category 
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@DefaultLocaleId int = dbo.fn_getdefaultLocaleId()
	SET @Status = 1 
	Declare @IsPreviewEnable int 
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionType = 'Production' OR  @RevisionType = 'None'

		
    SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId ) 
WHERE  a.IsCategory =1



SELECT DISTINCT yu.VersionId,yu.LocaleId, yu.CatalogName, yu.ZnodeCatalogId, a.PimCategoryId ,RT.ParentPimCategoryHierarchyId, rt.DisplayOrder, rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues,rt.ActivationDate, rt.ExpirationDate
		,RT.IsActive
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  ZnodePimCategoryHierarchy  rt with(nolock) ON ( rt.PimCategoryId = a.PimCategoryId  )
INNER JOIN  ZnodePublishCatalogEntity yu with(nolock) ON (yu.ZnodeCatalogId = rt.PimCatalogId)
WHERE rt.PimCategoryId =@PimCategoryId
AND yu.RevisionType IN (SELECT t.RevisionState FROM @Tbl_versions t)


SELECT DISTINCT PimCategoryHierarchyId,LocaleId,ZnodeCatalogId, CatalogName,PimCategoryId,ParentPimCategoryHierarchyId,DisplayOrder,VersionId, CategoryName, CategoryCode ,ActivationDate, ExpirationDate,IsActive
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

-- SELECT * FROM #Temp_categoryDetails

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId = t.PimCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.VersionId = a.VersionId)

INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT a.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId  = a.PimCategoryId  )+']' 
	,a.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = a.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )

DELETE t FROM ZnodePublishSeoEntity t WHERE EXISTS (SELECT TOP 1 1 FROM #Temp_categoryDetails yu WHERE yu.CategoryCode  = t.SEOCode 
AND t.CMSSEOTypeId = 2 
)

INSERT INTO ZnodePublishSeoEntity(VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,ElasticSearchEvent) 

SELECT VersionId,GETDATE(),a.SEOCode,a.CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,'Category' SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,1 ElasticSearchEvent
FROM ZnodeCMSSEODetail a 
INNER JOIN ZnodeCMSSEODetailLocale b ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN #Temp_categoryDetails c ON (c.CategoryCode = a.SEOCode )
WHERE a.CMSSEOTypeId =2 

     
	SELECT PimCategoryHierarchyId PublishCategoryId ,
			ZnodeCatalogId  PublishCatalogId  ,
           ''   CategoryXml       ,
              LocaleId          ,
			  VersionId		     FROM  #Temp_categoryDetails y 

	SELECT PortalId, y.ZnodeCatalogId PublishCatalogId, y.PimCategoryHierarchyId PublishCategoryId, y.CategoryCode, yu.SEOUrl,y. VersionId,y.LocaleId FROM ZnodePublishSeoEntity yu 
	INNER JOIN #Temp_categoryDetails y ON ( y.VersionId = yu.VersionId
	AND y.CategoryCode = yu.SEOCode)  
	
	SELECT 0 AS id,@Status AS Status;   


	UPDATE ZnodePimCategory 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PimCategoryId =@PimCategoryId

END TRY 
BEGIN CATCH 
	SET @Status =0  
	
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	-- Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleCategoryEntity
		@PimCategoryId = '+CAST(@PimCategoryId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleCategoryErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleCategoryEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleCategoryEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishPortalEntity')
	DROP PROC Znode_PublishPortalEntity
GO

CREATE PROCEDURE [dbo].[Znode_PublishPortalEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@UserId int = 0
  ,@Status Bit =0 OUTPUT 
  ,@IsContentType Bit= 1
  ,@NewGUID nvarchar(500)  
)
AS
/*
  To publish all Content pages and their mapping into their respective entities 
	ZnodePublishContentPageConfigEntity
	ZnodePublishSEOEntity
	ZnodePublishWidgetProductEntity
	ZnodePublishMediaWidgetEntity
	ZnodePublishSearchWidgetEntity
	ZnodePublishTextWidgetEntity
	ZnodePublishWidgetSliderBannerEntity
	ZnodePublishWidgetTitleEntity

	Unit Testing : 
	Declare @Status bit 
	

	Declare @Status bit 
	Exec [dbo].[Znode_PublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 


*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @PortalCode Varchar(100)
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@UserName Varchar(50);
	SET @Status = 1 
	Declare @IsPreviewEnable int,@PreviewVersionId INT = 0  ,@ProductionVersionId INT = 0
	
	Select TOP 1  @UserName = aspNetZnodeUser.UserName from ZnodeUser Inner Join aspNetUsers ON ZnodeUser.aspNetUserId = aspNetUsers.Id 
	Inner Join aspNetZnodeUser on aspNetUsers.UserName = aspNetZnodeUser.AspNetZnodeUserId
	where ZnodeUser.UserId = @userId
            


 		If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
		Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
			SET @IsPreviewEnable = 1 
		else 
			SET @IsPreviewEnable = 0 

		--Generate preview entry 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		
		DECLARE @TBL_StoreEntity TABLE 
		(
			 PortalThemeId	int,PortalId	int,ThemeId	int,ThemeName	varchar(200),CSSId	int,CSSName	nvarchar(2000),
			 WebsiteLogo	varchar(300),WebsiteTitle	nvarchar(400),FaviconImage	varchar(300),WebsiteDescription	nvarchar(MAX),
			 PublishState	varchar(100),LocaleId	int	
		)
		
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		Create Table #Tbl_VersionEntity(PortalId int , VersionId int , LocaleId int , PublishType varchar(50) )

		IF object_id('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntity
		Create Table #Tbl_OldVersionEntity(PortalId int , NewVersionId int ,OldVersionId int , LocaleId int , PublishType varchar(50) )

	
		DECLARE @WebStoreEntityId int 
		
		select @PortalCode  = StoreName  from ZnodePortal where PortalId = @PortalId 
		
		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
		
		---managed brand seo data
		--delete ZCSDL from ZnodeCMSSEODetailLocale ZCSDL
		--where exists(select *  from ZnodeCMSSEODetail ZCSD1
		--where not exists(select * from ZnodeBrandDetails ZBD
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		--and ZBD.BrandCode = ZCSD1.SEOCode) and ZCSDL.CMSSEODetailId = ZCSD1.CMSSEODetailId
		--and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'))


		--delete ZCSD1 from ZnodeCMSSEODetail ZCSD1
		--where not exists(select * from ZnodeBrandDetails ZBD
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		--and ZBD.BrandCode = ZCSD1.SEOCode)
		--and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')

		--insert into ZnodeCMSSEODetail(CMSSEOTypeId,SEOId,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		--,IsPublish,SEOCode,PublishStateId)
		--select distinct (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'),null,null,null,ZPB.PortalId,isnull(ZBDL.SEOFriendlyPageName,ZBD.BrandCode),@userId,
		--getdate(),@userId,getdate(),null,ZBD.BrandCode,3
		--from ZnodeBrandDetails ZBD
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		--inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		--where not exists(select * from ZnodeCMSSEODetail ZCSD1 where ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		--and ZCSD1.PortalId = ZPB.PortalId
		--and ZBD.BrandCode = ZCSD1.SEOCode) and ZPB.PortalId = @PortalId

		--insert into ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)
		--select distinct ZCSD.CMSSEODetailId,L.LocaleId,ZBDL.BrandName,ZBDL.BrandName,ZBDL.BrandName,@userId,getdate(),@userId,getdate(),null,null
		--from ZnodeCMSSEODetail ZCSD
		--inner join ZnodeBrandDetails ZBD on ZCSD.SEOCode = ZBD.BrandCode
		--inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		--inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		--cross apply @TBL_Locale L
		--where CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		--and not exists(select * from ZnodeCMSSEODetailLocale ZCSDL where ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId)
		-- ---managed brand seo data
		
		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			if (@IsPreviewEnable = 1 AND ( @RevisionState like '%Preview%'  OR @RevisionState like '%Production%' ) ) 
			Begin
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
				
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PREVIEW'
				
			End
			If (@RevisionState like '%Production%' OR @RevisionState = 'None')
			Begin
				--Genrate production entry 
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
			
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PRODUCTION'
			End 
	   	SET @IncrementalId = @IncrementalId +1 
		END 

	Truncate table ZnodePublishPortalErrorLogEntity

	Declare @IsFirstTimeContentPublish bit 
	If Exists (Select TOP 1 1  from ZnodePublishWebStoreEntity where PortalId = @PortalId)
		SET @IsFirstTimeContentPublish =1 
	else 
		SET @IsFirstTimeContentPublish =0
    
	Declare @Tbl_PreviewVersionId  TABLE (VersionId int , PortalId int , LocaleId int )
	Declare @Tbl_ProductionVersionId  TABLE (VersionId int , PortalId int , LocaleId int )

	If @IsContentType = 0 AND @IsFirstTimeContentPublish =1 
	Begin 
		Insert into #Tbl_OldVersionEntity (PortalId,NewVersionId,OldVersionId, LocaleId, PublishType)
		Select A.PortalId , A.VersionId, B.VersionId, a.LocaleId,a.PublishType from #Tbl_VersionEntity A Inner join ZnodePublishWebStoreEntity B on 
		A.PortalId = B.PortalId and A.LocaleId = B.LocaleId AND A.PublishType= B.PublishState  
	End
	Delete from ZnodePublishProgressNotifierEntity where JobName  = @PortalCode 
	
	INSERT INTO ZnodePublishProgressNotifierEntity
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	Values(0,@NewGUID , Isnull(@PortalCode,'') + ' Store' , 0 , 0 , 0 , '' , @UserId, @UserName)

	if @Type = 'ZnodePublishWebStoreEntity' OR @Type = ''
	Begin
		 Declare  @PreviewVersionIdString varchar(1000)= ''  ,@ProductionVersionIdString varchar(1000) = '' 
		 SELECT   @PreviewVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PREVIEW'  FOR XML PATH ('')), 1, 1, '') 
		 SELECT   @ProductionVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PRODUCTION'  FOR XML PATH ('')), 1, 1, '') 
		 
		 EXEC [dbo].[Znode_SetPublishWebStoreEntity]
			 @PortalId  = @PortalId 
			,@LocaleId   = @LocaleId 
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = @PreviewVersionIdString 
			,@ProductionVersionId = @ProductionVersionIdString 
			,@RevisionState = @RevisionState 
			,@UserId = @UserId	
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWebStoreEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =5 , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End
	
	if (@Type = 'ZnodePublishPortalBrandEntity' OR @Type = '' ) AND @Status = 1 
	Begin
			Exec [Znode_SetPublishPortalBrandEntity]
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@UserId = @UserId  
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark = CASE When (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) THEN 10 Else 100 End , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End 

	if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1 and (@IsContentType = 0 or @PortalId > 0)
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '4'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

			End 
	If (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) AND @Status = 1  
	Begin
			if @Type = 'ZnodePublishBlogNewsEntity' OR @Type = '' 
			Begin
				 EXEC [dbo].[Znode_SetPublishBlogNewsEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishBlogNewsEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 15 , 
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			End
			if (@Type = 'ZnodePublishPortalCustomCssEntity' OR @Type = '' ) AND @Status = 1  
			Begin
				 EXEC [dbo].[Znode_SetPublishPortalCustomCssEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalCustomCssEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 20  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID


			End
			if (@Type = 'ZnodePublishWidgetCategoryEntity' OR @Type = '' ) AND @Status = 1 
			Begin
				 EXEC [dbo].[Znode_SetPublishWidgetCategoryEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 25  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			End
	
			if (@Type = 'ZnodePublishWidgetProductEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetProductEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 30  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			END 

			if (@Type = 'ZnodePublishWidgetTitleEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetTitleEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetTitleEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 35  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			END 
			if (@Type = 'ZnodePublishWidgetSliderBannerEntity' OR @Type = '')AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetSliderBannerEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@CMSSliderId = 0 
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetSliderBannerEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 40  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishTextWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishTextWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishTextWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 45  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 
			if (@Type = 'ZnodeSetPublishMediaWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishMediaWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMediaWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
										
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 50  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishSearchWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishSearchWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSearchWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 55  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 

			if (@Type = 'ZnodePublishContentPageConfigEntity' OR @Type = '') AND @Status = 1
			Begin
				 EXEC [dbo].[Znode_SetPublishContentPageConfigEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContentPageConfigEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			End

			if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '3,5'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
			if (@Type = 'ZnodePublishMessageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishMessageEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMessageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 65,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

		   if (@Type = 'ZnodePublishPortalGlobalAttributeEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishPortalGlobalAttributeEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalGlobalAttributeEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 67,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
 
		   if (@Type = 'ZnodePublishProductPageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishProductPageEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishProductPageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 73,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			


			End 
			
			if (@Type = 'ZnodePublishWidgetBrandEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishWidgetBrandEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 80,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

			if (@Type = 'ZnodePublishContainerWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishContainerWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContainerWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 90  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 

	End
		IF Exists (select TOP 1 1  from ZnodePublishPortalErrorLogEntity where  ProcessStatus = 'Fail') 
		Begin
			SET @Status  =0 
			SELECT 1 AS ID,@Status AS Status;
			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Delete  From ZnodePublishWebStoreEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
			Delete  From ZnodePublishBlogNewsEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetTitleEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishTextWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishMediaWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSearchWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishContentPageConfigEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSEOEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId and CMSSEOTypeId in (3,5)
			Delete  From ZnodePublishMessageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalBrandEntity Where  VersionId  in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishProductPageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetBrandEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
		    Delete  From ZnodePublishContainerWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),ModifiedDate=GETDATE()  where  PublishPortalLogId in  (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed(),ModifiedDate=GETDATE()  where  PublishPortalLogId in (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )

		End
	Else 
		Begin
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPreview(),ModifiedDate=GETDATE()  where  PublishPortalLogId in 
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublish(),ModifiedDate=GETDATE()  where  PublishPortalLogId in
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )
			 
			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PortalId,'portal','portal has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from ZnodePublishWebStoreEntity where LocaleId = A.LocaleId AND PublishState = A.PublishType
				 and PortalId = @PortalId),A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId

			If @RevisionState = 'PREVIEW'
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End 
			Else 
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End
			
			if (@IsContentType =1  OR (@IsContentType = 0 AND @IsFirstTimeContentPublish =0))
			Begin
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishContainerWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishContainerWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

				End
			End
			Else 
			Begin
				
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId =6)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5) 

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContainerWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
	

				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContainerWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

				End 
			End

			--update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
			--update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
			--SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
		 SET @Status = 1
		End
	SELECT 1 AS ID,@Status AS Status;   

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   

	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishPortalEntity 
		@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
			
	INSERT INTO ZnodePublishPortalErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'ZnodePublishPortalEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishPortalEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PostSubmitOrderProcess')
	DROP PROC Znode_PostSubmitOrderProcess

GO

CREATE PROCEDURE [dbo].[Znode_PostSubmitOrderProcess]
(
	@PostOrderXml XML,
	@InventoryData XML,
	@UserId INT,
	@PortalId INT = 0,
	@Status BIT OUT
)
AS
BEGIN
BEGIN TRY
--BEGIN TRAN PostOrder
	DECLARE @OmsOrderDetailsId INT
	DECLARE @OmsOrderId INT = (SELECT Tbl.Col.value( 'OrderID[1]', 'NVARCHAR(2000)' ) AS OrderId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsGuest BIT = (SELECT Tbl.Col.value( 'IsGuest[1]', 'NVARCHAR(2000)' ) AS IsGuest FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))

	DECLARE @OmsCookieMappingId INT = (SELECT Tbl.Col.value( 'CookieMappingId[1]', 'NVARCHAR(2000)' ) AS CookieMappingId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @BillingAddressId INT = (SELECT Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(2000)' ) AS BillingAddressId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsReferralCommission BIT = (SELECT Tbl.Col.value( 'IsReferralCommission[1]', 'NVARCHAR(2000)' ) AS IsReferralCommission FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @CommissionAmount NUMERIC(26,6) = (SELECT Tbl.Col.value( 'CommissionAmount[1]', 'NVARCHAR(2000)' ) AS CommissionAmount FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	SET @OmsOrderDetailsId = (SELECT OmsOrderDetailsId from ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderId AND IsActive = 1)
	DECLARE @SetBillingShippingFlags BIT = (SELECT Tbl.Col.value( 'SetBillingShippingFlags[1]', 'NVARCHAR(2000)' ) AS SetBillingShippingFlags FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col)) 
	DECLARE @GetDate DATETIME = GETDATE()
	
	--Fetching required user details 
	DECLARE @ReferralCommissionTypeId INT, @ReferralCommission NUMERIC(28,6) , @FirstName VARCHAR(100),@LastName VARCHAR(100)
	SELECT @FirstName = FirstName,@LastName = LastName, @ReferralCommission = CASE WHEN ReferralCommission IS NULL THEN 0 ELSE ReferralCommission END, @ReferralCommissionTypeId = ReferralCommissionTypeId
	FROM ZnodeUser WITH (NOLOCK) 
	WHERE UserId = @UserId
	
	---Voucher model fetch
	CREATE TABLE #TempVoucher
	(
		VoucherBalance NUMERIC(28,6),VoucherNumber NVARCHAR(600),VoucherMessage NVARCHAR(MAX),IsVoucherValid BIT,
		IsVoucherApplied BIT,VoucherAmountUsed NUMERIC(28,6),VoucherName NVARCHAR(600),ExpirationDate DATETIME,
		CultureCode NVARCHAR(600),PortalId INT,IsExistInOrder BIT,UserId INT,IsActive BIT,OrderVoucherAmount NUMERIC(28,6)
	)

	INSERT INTO #TempVoucher
	(
		VoucherBalance ,VoucherNumber,VoucherMessage ,IsVoucherValid ,
		IsVoucherApplied ,VoucherAmountUsed ,VoucherName ,ExpirationDate ,
		CultureCode ,PortalId ,IsExistInOrder ,UserId ,IsActive ,OrderVoucherAmount 
	)
	SELECT Tbl.Col.value( 'VoucherBalance[1]', 'NVARCHAR(2000)' ) AS VoucherBalance,
		Tbl.Col.value( 'VoucherNumber[1]', 'NVARCHAR(2000)' ) AS VoucherNumber,
		Tbl.Col.value( 'VoucherMessage[1]', 'NVARCHAR(2000)' ) AS VoucherMessage,
		Tbl.Col.value( 'IsVoucherValid[1]', 'NVARCHAR(2000)' ) AS IsVoucherValid,
		Tbl.Col.value( 'IsVoucherApplied[1]', 'NVARCHAR(2000)' ) AS IsVoucherApplied,
		Tbl.Col.value( 'VoucherAmountUsed[1]', 'NVARCHAR(2000)' ) AS VoucherAmountUsed,
		Tbl.Col.value( 'VoucherName[1]', 'NVARCHAR(2000)' ) AS VoucherName,
		Tbl.Col.value( 'ExpirationDate[1]', 'NVARCHAR(2000)' ) AS ExpirationDate,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(2000)' ) AS CultureCode,
		Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(2000)' ) AS PortalId,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,
		Tbl.Col.value( 'UserId[1]', 'NVARCHAR(2000)' ) AS UserId,	
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(2000)' ) AS IsActive,
		Tbl.Col.value( 'OrderVoucherAmount[1]', 'NVARCHAR(2000)' ) AS OrderVoucherAmount
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Vouchers/VoucherModel') AS Tbl(Col)


	----Promotion coupon start
	DECLARE @TempPromotionCoupon DBO.PromotionCoupons

	INSERT INTO @TempPromotionCoupon
	SELECT Tbl.Col.value( 'Code[1]', 'NVARCHAR(2000)' ) AS Code,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,@OmsOrderId AS OmsOrderId
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Coupons/CouponModel') AS Tbl(Col)

	--Deduct promotion coupon count
	EXEC [Znode_PromotionCouponDeduct] @PromotionCoupons = @TempPromotionCoupon
	----Promotion coupon END
	
	--Deduct inventory quantity
	EXEC [Znode_UpdateInventoryPostOrder] @SkuXml = @InventoryData,@PortalId = @PortalId, @UserId= @UserId,@OmsOrderId=@OmsOrderId,@Status = 0

	----Voucher start
	IF EXISTS(SELECT * FROM #TempVoucher)
	BEGIN
		INSERT INTO ZnodeGiftCardHistory(GiftCardId,TransactionDate,TransactionAmount,OmsOrderDetailsId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Notes,RemainingAmount)
		SELECT GC.GiftCardId, @GetDate, VoucherAmountUsed,@OmsOrderDetailsId,@UserId, @GetDate, @UserId, @GetDate, 'Voucher is used to make payments for the order' as Notes, NULL AS RemainingAmount
		FROM #TempVoucher V
		INNER JOIN ZnodeGiftCard GC WITH (NOLOCK) ON V.VoucherNumber = GC.CardNumber

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('TRUE','1'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = V.VoucherBalance
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('TRUE','1')  			
		END

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('FALSE','0'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = GC.RemainingAmount - V.VoucherAmountUsed
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('FALSE','0')			
		END
	END

		UPDATE GC SET GC.UserId=@UserId  
		FROM  ZnodeGiftCard GC 
		WHERE  GC.Userid IS NULL

	----Voucher end
	
	--Update user details
	IF @FirstName IS NULL
	BEGIN
		DECLARE @FirstName1 VARCHAR(300), @LastName1 VARCHAR(300), @PhoneNumber VARCHAR(300)
		SELECT @FirstName1=FirstName, @LastName1 = LastName, @PhoneNumber=PhoneNumber
		FROM ZnodeAddress WITH (NOLOCK)  WHERE AddressId = @BillingAddressId

		UPDATE ZnodeUser 
		SET FirstName = @FirstName, LastName = @LastName, PhoneNumber = @PhoneNumber
		WHERE UserId = @UserId
	END

	--Update address details
	IF @SetBillingShippingFlags IN ('TRUE','1')
	BEGIN
		UPDATE ZnodeAddress
		SET IsBilling = 1, IsShipping = 1
		WHERE AddressId = @BillingAddressId
	END

	--ReferralCommission details
	IF @IsReferralCommission IN ('TRUE','1')
	BEGIN
		INSERT INTO ZnodeOmsReferralCommission
		(
			UserId,OmsOrderDetailsId,OrderCommission,TransactionId,Description,ReferralCommission,ReferralCommissionTypeId
			,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @UserId,@OmsOrderDetailsId,CASE WHEN @ReferralCommissionTypeId =1 THEN ((@CommissionAmount * ISNULL(@ReferralCommission,0)) / 100) ELSE @ReferralCommission END AS OrderCommission,'' AS TransactionId,'' AS Description,@ReferralCommission,@ReferralCommissionTypeId
			,@UserId,@GetDate,@UserId,@GetDate
	END
	
	---OmsTaxOrderSummary details
	IF EXISTS(SELECT * FROM ZnodeOmsTaxOrderSummary WITH (NOLOCK)  WHERE OmsOrderDetailsId = @OmsOrderDetailsId)
	BEGIN
		DELETE FROM ZnodeOmsTaxOrderSummary WHERE OmsOrderDetailsId = @OmsOrderDetailsId
	END

	INSERT INTO ZnodeOmsTaxOrderSummary (OmsOrderDetailsId,Tax,Rate,TaxName,TaxTypeName)
	SELECT 	@OmsOrderDetailsId AS OmsOrderDetailsId,
		Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) AS Tax,
		Tbl.Col.value( 'Rate[1]', 'NVARCHAR(2000)' ) AS Rate,
		Tbl.Col.value( 'TaxName[1]', 'NVARCHAR(2000)' ) AS TaxName,
		Tbl.Col.value( 'TaxTypeName[1]', 'NVARCHAR(2000)' ) AS TaxTypeName
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/TaxSummaryList/TaxSummaryModel') AS Tbl(Col)
	WHERE Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) IS NOT NULL
	--------

	--Remove 
	EXEC [Znode_DeleteSavedCartItem] @OmsCookieMappingId = @OmsCookieMappingId, @UserId = @UserId,@PortalId = @PortalId,@Status = 0  

	SET @Status = 1
	--COMMIT TRAN PostOrder
END TRY
BEGIN CATCH
--ROLLBACK TRAN PostOrder
	SET @Status = 0
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PostSubmitOrderProcess @PostOrderXml ='+CAST(@PostOrderXml AS VARCHAR(MAX))+' , @InventoryData = '+CAST(@InventoryData AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@PortalId ='+CAST(@PortalId AS VARCHAR(50))+',@Status ='+CAST(@Status AS VARCHAR(50));
	
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PostSubmitOrderProcess',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE  PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )



INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 

--SELECT * FROM #Temp_Categoryvalue

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder, CategoryName, CategoryCode ,ParentPimCategoryHierarchyId 
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  

UPDATE a
SET DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,1), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId)
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT PimCategoryId FROM  #Temp_categoryDetails ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

DELETE FROM  ZnodeImportAttributeValidation WHERE AttributeTypeName ='Text' AND AttributeCode = 'CategoryCode' 
AND ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'CategoryAssociation')
AND ValidationName = 'RegularExpression'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 
SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  )
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT PimCategoryId FROM  #Temp_categoryDetails ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategory')
	DROP PROC Znode_ImportCatalogCategory

GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategory](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Catalog Category Product association
	
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		DECLARE @DefaultLocaleId INT=dbo.Fn_GetDefaultLocaleId()

		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertCatalogCategory TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300), CategoryCode varchar(200), DisplayOrder int, IsActive varchar(10), GUID nvarchar(400)
			--,Index Ind_SKU1 (SKU),Index Ind_CategoryName (CategoryName)
		);

		DECLARE @CategoryAttributId int;

		SET @CategoryAttributId =
		(
			SELECT TOP 1 PimAttributeId
			FROM ZnodePimAttribute AS ZPA
			WHERE ZPA.AttributeCode = 'CategoryCode' AND 
				  ZPA.IsCategory = 1
		);

		DECLARE @InventoryListId int;

		SET @SSQL = 'Select RowNumber,trim(SKU),CategoryCode,DisplayOrder ,IsActive,GUID FROM '+@TableName;
		INSERT INTO @InsertCatalogCategory( RowNumber, SKU, CategoryCode, DisplayOrder, IsActive, GUID )
		EXEC sys.sp_sqlexec @SSQL;

		----Removing Duplicate data
		;with cte as
		(
			select SKU, CategoryCode,max(RowNumber) as RowNumber from @InsertCatalogCategory
			group by SKU, CategoryCode
		)
		delete a from @InsertCatalogCategory a
		where  not exists (select * from CTE b where a.RowNumber = b.RowNumber )

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @SKU TABLE
		( 
		   SKU nvarchar(300), PimProductId INT--, Index Ins_SKU (SKU)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId AND b.LocaleId=@DefaultLocaleId;

		Declare @PimCategoryAttributeId int 
		set @PimCategoryAttributeId = (select top 1 PimAttributeId from ZnodePimAttribute where AttributeCode = 'CategoryCode')

		DECLARE @CategoryCode TABLE
		( 
			CategoryCode nvarchar(300), PimCategoryId int --index ind_101 (CategoryName)
		);
		INSERT INTO @CategoryCode
			   SELECT ZPCAL.CategoryValue, ZPCA.PimCategoryId
			   FROM ZnodePimCategoryAttributeValue AS ZPCA
					INNER JOIN
					ZnodePimCategoryAttributeValueLocale AS ZPCAL
					ON ZPCA.PimAttributeId = @PimCategoryAttributeId AND 
					ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId;
					
		-- start Functional Validation 
		
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.SKU NOT in 
			   (
				   SELECT SKU FROM @SKU  where SKU IS NOT NULL 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '105', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.CategoryCode NOT IN 
			   (
				   SELECT CategoryCode FROM @CategoryCode  where CategoryCode IS NOT NULL 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		  SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		  FROM @InsertCatalogCategory AS ii  
		  WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No')

		  
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ CategoryCode - ' + ISNULL(CategoryCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertCatalogCategory IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertCatalogCategory
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

	
		
			  Declare @ZnodePimCategoryProduct TABLE (PimProductId int , PimCategoryId int , Status bit , DisplayOrder int) 
			  	
			  insert into @ZnodePimCategoryProduct (PimProductId , PimCategoryId , Status , DisplayOrder )
			  SELECT SKU.PimProductId, (Select top 1 PimCategoryId from @CategoryCode where ICC.CategoryCode = CategoryCode )  PimCategoryId
				 , CASE WHEN IsActive in ('True','1','Yes') Then 1 ELSE 0 END , DisplayOrder FROM @InsertCatalogCategory AS ICC INNER JOIN	 @SKU AS SKU ON ICC.SKU = SKU.SKU 
			
			  INSERT into ZnodePimCategoryProduct ( PimProductId, PimCategoryId, Status, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate) 
			  Select TABL.PimProductId, TABL.PimCategoryId, TABL.Status, TABL.DisplayOrder,@UserId, @GetDate, @UserId, @GetDate   from @ZnodePimCategoryProduct TABL    
			  Where NOT EXISTS (Select top 1 1 from ZnodePimCategoryProduct ZPCP where ZPCP.PimProductId = TABL.PimProductId and  ZPCP.PimCategoryId = TABL.PimCategoryId)

		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertCatalogCategory
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
 
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategory @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCatalogCategory',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

DELETE A FROM
(
SELECT PimCategoryProductId, PimCategoryId, PimProductId, ROW_NUMBER() OVER (PARTITION BY PimCategoryId, PimProductId ORDER BY PimCategoryProductId) As Rn
FROM ZnodePimCategoryProduct
) A WHERE A.Rn>1


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE   PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @PimProduct_catalog TABLE (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimChildProductId,ZPAP.PimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,0 ,0 ,NULL,NULL,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )
AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimChildProductId )

INSERT INTO @PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM @PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)


	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  @PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 
SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN @PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM @PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN @PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM @PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  @PimProduct_catalog a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeManageConditionalDefaultData WHERE ConditionalCode = 'UpdatePublishCatalogIdOneTime' AND IsActive=1)
BEGIN
	UPDATE ZnodePortalCatalog
	SET OldPublishCatalogId = PublishCatalogId
	WHERE OldPublishCatalogId IS NULL;

	UPDATE ZnodePortalCatalog
	SET PublishCatalogId = (SELECT TOP 1 PimCatalogId FROM ZnodePublishCatalog r
		WHERE r.PublishCatalogId = ZnodePortalCatalog.OldPublishCatalogId)
	WHERE (SELECT TOP 1 b.PimCatalogId FROM ZnodePublishCatalog b
		WHERE b.PublishCatalogId =ZnodePortalCatalog.PublishCatalogId ) IS NOT NULL; 	

	UPDATE ZnodeCatalogIndex
	SET PublishCatalogId = (SELECT TOP 1 r.PimCatalogId FROM ZnodePublishCatalog r
		WHERE r.PublishCatalogId =ZnodeCatalogIndex.PublishCatalogId )
	WHERE (SELECT TOP 1 b.PimCatalogId FROM ZnodePublishCatalog b
		WHERE b.PublishCatalogId =ZnodeCatalogIndex.PublishCatalogId ) IS NOT NULL;

    UPDATE ZnodePromotionProduct 
	SET PublishProductId = (SELECT TOP 1 PimProductId FROM ZnodePublishProduct WHERE ZnodePublishProduct.PublishProductId = ZnodePromotionProduct.PublishProductId)
	
	UPDATE ZnodePromotionCategory 
	SET PublishCategoryId = (SELECT TOP 1 PimCategoryId FROM ZnodePublishCategory WHERE ZnodePublishCategory.PublishCategoryId = ZnodePromotionCategory.PublishCategoryId)
	
	UPDATE ZnodePromotionCategory 
	SET PublishCategoryId = (SELECT TOP 1 t.PimCategoryHierarchyId  FROM ZnodePimCategoryHierarchy t WHERE t.PimCategoryId = ZnodePromotionCategory.PublishCategoryId)

	UPDATE ZnodePromotionCatalogs 
	SET PublishCatalogId = (SELECT TOP 1 PimcatalogId FROM ZnodePublishCatalog WHERE ZnodePublishCatalog.PublishCatalogId = ZnodePromotionCatalogs.PublishCatalogId)

	UPDATE ZnodeSearchGlobalProductBoost 
	SET PublishProductId = (SELECT TOP 1 PimProductId FROM ZnodePublishProduct WHERE ZnodePublishProduct.PublishProductId = ZnodeSearchGlobalProductBoost.PublishProductId)
		,PublishCatalogId = (SELECT TOP 1 PimcatalogId FROM ZnodePublishCatalog WHERE ZnodePublishCatalog.PublishCatalogId = ZnodeSearchGlobalProductBoost.PublishCatalogId)
	
	UPDATE ZnodeSearchGlobalProductCategoryBoost 
	SET PublishProductId = (SELECT TOP 1 PimProductId FROM ZnodePublishProduct WHERE ZnodePublishProduct.PublishProductId = ZnodeSearchGlobalProductCategoryBoost.PublishProductId)
		, PublishCategoryId = (SELECT TOP 1 PimCategoryId FROM ZnodePublishCategory WHERE ZnodePublishCategory.PublishCategoryId = ZnodeSearchGlobalProductCategoryBoost.PublishCategoryId)
		,PublishCatalogId = (SELECT TOP 1 PimcatalogId FROM ZnodePublishCatalog WHERE ZnodePublishCatalog.PublishCatalogId = ZnodeSearchGlobalProductCategoryBoost.PublishCatalogId)
	
	UPDATE ZnodeSearchDocumentMapping 
	SET PublishCatalogId = (SELECT TOP 1 PimcatalogId FROM ZnodePublishCatalog WHERE ZnodePublishCatalog.PublishCatalogId = ZnodeSearchDocumentMapping.PublishCatalogId)
	
	UPDATE ZnodeSearchKeywordsRedirect 
	SET PublishCatalogId = (SELECT TOP 1 PimcatalogId FROM ZnodePublishCatalog WHERE ZnodePublishCatalog.PublishCatalogId = ZnodeSearchKeywordsRedirect.PublishCatalogId)
	
	UPDATE ZnodePortalSearchProfile 
	SET PublishCatalogId = (SELECT TOP 1 PimcatalogId FROM ZnodePublishCatalog WHERE ZnodePublishCatalog.PublishCatalogId = ZnodePortalSearchProfile.PublishCatalogId)
	
	UPDATE ZnodeSearchSynonyms 
	SET PublishCatalogId = (SELECT TOP 1 PimcatalogId FROM ZnodePublishCatalog WHERE ZnodePublishCatalog.PublishCatalogId = ZnodeSearchSynonyms.PublishCatalogId)

	DECLARE @pimAttributeId INT = 0;

	DECLARE CUR_Attribute CURSOR FOR 
	SELECT PimAttributeId  FROM ZnodePimAttribute WHERE IsShowOnGrid = 1 
	AND IScategory = 0 AND  AttributeCode IN ('ProductName', 'SKU', 'IsActive','ProductType')

	OPEN CUR_Attribute

	FETCH NEXT FROM CUR_Attribute INTO @pimAttributeId

	WHILE @@FETCH_STATUS =  0 
	BEGIN 
		EXEC Znode_UpdateShowOnGridColumn @PimAttributeId, 2,1,0 ,0

		FETCH NEXT FROM CUR_Attribute INTO @pimAttributeId
	END
	CLOSE CUR_Attribute
	DEALLOCATE CUR_Attribute
END

INSERT INTO ZnodeManageConditionalDefaultData (ConditionalCode,ConditionalName,DataSource,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'UpdatePublishCatalogIdOneTime',
	'This is only for update old PublishCatalogId from respective tables during upgrade of existing database or create fresh database & this will execute only one time.'
		,'Upgrade Database',1,2, GETDATE(),2 , GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeManageConditionalDefaultData WHERE ConditionalCode = 'UpdatePublishCatalogIdOneTime' AND IsActive=1);

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO

CREATE PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
DECLARE @pimProductId_loop TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId 
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID

WHILE EXISTS (SELECT TOP 1 1 FROM #pimProductIds ) 
BEGIN 
DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

INSERT INTO @pimProductId_loop
SELECT  PimProductId 
FROM #pimProductIds 

SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  @pimProductId_loop t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN @pimProductId_loop b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN @pimProductId_loop b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN @pimProductId_loop bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM @pimProductId_loop n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)


IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   
   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValue 
   SELECT PimProductId, PimAttributeId , AttributeValue, CustomCode ,  IsDefaultValue , m.LocaleId
   FROM #tbl_AttributeValue a 
   CROSS APPLY @LocaleIds_distinct m

   UPDATE a
   SET a.AttributeValue = aa.AttributeValue
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE a.LocaleId <> @DefaultLocaleId


   UPDATE a
   SET a.AttributeValue = aa.AttributeValue
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE a.LocaleId <> @DefaultLocaleId
 
   INSERT INTO #default_value 
   SELECT PimProductId ,PimAttributeId,  Code , m.LocaleId	, Value,DisplayOrder,IsEditable,SwatchText,Path,PimAttributeDefaultValueId,VariantSKU,VariantDisplayOrder
   FROM #default_value a 
   CROSS APPLY @LocaleIds_distinct m

   UPDATE a
   SET Value = bc.AttributeDefaultValue
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId
   



END 


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID




UPDATE ZnodePublishProductEntity
SET Attributes = 
 (

SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(a.AttributeValue,'') AttributeValues
				,ISNULL((
				   SELECT DISTINCT  Code,LocaleId,Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   WHERE nt.PimProductId = a.PimProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId = ZnodePublishProductEntity.LocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = ZnodePublishProductEntity.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =ZnodePublishProductEntity.LocaleId)
WHERE a.PimProductId = ZnodePublishProductEntity.ZnodeProductId AND a.LocaleId = ZnodePublishProductEntity.LocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
) 
WHERE PublishProductEntityId  IN (SELECT PublishProductEntityId FROM #PublishProductEntityId)


UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValue ty ON ( ty.PimProductId = a.ZnodeProductId  )
WHERE PublishProductEntityId  IN (SELECT PublishProductEntityId FROM #PublishProductEntityId)
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct t WHERE t.LocaleId = a.LocaleId AND ty.LocaleId = t.LocaleId )
AND ty.PimAttributeId IN (SELECT w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')
	
	DELETE FROM #pimProductIds WHERE PimProductId IN (SELECT PImProductId FROM @pimProductId_loop)
	DELETE FROM @pimProductId_loop
END 

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS (SELECT * FROM sys.views WHERE name='View_AdminUserDetail' and type='v')
	DROP View View_AdminUserDetail;
GO

CREATE VIEW [dbo].[View_AdminUserDetail]
AS
SELECT        a.UserId, a.AspNetUserId, azu.UserName, a.FirstName, a.MiddleName, a.LastName, a.Email, a.EmailOptIn, a.BudgetAmount, a.CreatedBy, CONVERT(DATETIME, 
                         a.CreatedDate) CreatedDate, A.ModifiedBy, CONVERT(DATETIME, a.ModifiedDate) ModifiedDate, c.Id RoleId, c.Name RoleName, c.IsActive, 
                         CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS BIT) AS IsLock, (ISNULL(a.FirstName, '') + CASE WHEN a.MiddleName IS NULL OR
                         a.MiddleName = '' THEN '' ELSE ' ' + a.MiddleName END + CASE WHEN a.LastName IS NULL OR
                         a.LastName = '' THEN '' ELSE ' ' + a.LastName END) FullName, e.Name AccountName, h.PermissionsName, h.PermissionCode, j.DepartmentName, i.DepartmentId, 
                         a.AccountId, f.AccountPermissionAccessId, a.PhoneNumber, a.ExternalId, CAST(NULL AS VARCHAR(4000)) ApprovalName, CAST(NULL AS INT) ApprovalUserId, 
                         CAST(NULL AS INT) AccountUserOrderApprovalId,a.CustomerPaymentGUID
FROM            ZnodeUser a INNER JOIN
                         AspNetUserRoles b ON (a.AspNetUserId = b.userId) INNER JOIN
                         AspNetRoles c ON (b.RoleId = c.Id) INNER JOIN
                         AspNetUsers d ON (a.AspNetUserId = d .id) LEFT JOIN
                         ZnodeAccount e ON (e.AccountId = a.AccountId) LEFT JOIN
                         ZnodeDepartmentUser i ON (i.UserId = a.UserId) LEFT JOIN
                         ZnodeDepartment j ON (j.DepartmentId = i.DepartmentId) LEFT JOIN
                         ZnodeAccountUserPermission f ON (f.UserId = a.UserId) LEFT JOIN
                         ZnodeAccountPermissionAccess g ON (g.AccountPermissionAccessId = f.AccountPermissionAccessId) LEFT JOIN
                         ZnodeAccessPermission h ON (h.AccessPermissionId = g.AccessPermissionId) LEFT JOIN
                         ZnodeUserPortal up ON (up.UserId = a.UserId) LEFT JOIN
                         AspNetZnodeUser azu ON (azu.AspNetZnodeUserId = d .UserName)
						
WHERE        c.Name NOT IN ('Customer', 'B2B') AND TypeOfRole IS NULL;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsers')
	DROP PROC Znode_AdminUsers

GO

CREATE PROCEDURE [dbo].[Znode_AdminUsers]
(	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId int = 0
)
AS
/* 
    Summary: List of users with details and shows link with ASPNet tables 
    This procedure is used for finding both users and admin users 
    here use three view "View_RoleUsers" for check  @UserName is present or not 
    "View_AdminUserDetail"  this view use for admin users 
    "View_CustomerUserDetail" Use for customer users 
    Unit Testing   
	SELECT * FROM ZnodeUser 
    DECLARE @EDE INT=0  EXEC Znode_AdminUsers '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
*/
BEGIN
    BEGIN TRY
    SET NOCOUNT ON;
			
    DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
           
	----Verifying that the @SalesRepUserId is having 'Sales Rep' role
	IF NOT EXISTS
	(
		SELECT * FROM ZnodeUser ZU
		INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
		INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
		Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
		AND ZU.UserId = @SalesRepUserId
	)   
	Begin
		SET @SalesRepUserId = 0
	End

	if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
		drop table ##CustomerUserAddDetail

	if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
		drop table ##View_CustomerUserAddDetail

	IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
		DROP TABLE #TBL_RowCount
	Create table #TBL_RowCount(RowsCount int )
	-----Split where clause XMl 
	CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
	insert into #WhereColumnList(filterName,WhereCondition)
	SELECT 
			Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
			Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
	FROM   @WhereClause.nodes('//filter') Tbl(Col) 
	----Address column in global search
	declare @AddressGlobalSearch varchar(1000) =''
	declare @GlobalSearch varchar(100) = ''
			
	select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
	from #WhereColumnList
	where filtername like '%|%'
	and filtername <> ''
	and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

			

	if isnull(@GlobalSearch,'') <> ''
	begin
		select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
	end
	else
	begin
		SET @AddressGlobalSearch = ''
	end
	----Global search where clause
	declare @WhereClauseGlobal varchar(1000)=''
	select @WhereClauseGlobal = ISNULL(WhereCondition,'')
	from #WhereColumnList
	where filtername like '%|%'
	and filtername <> ''
			
	----Where clause columns except Address columns
	declare @WhereClause1 varchar(max) = ''
	select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
	--case when @WhereClause1 <> ''  then ' And ' else '' end
	from #WhereColumnList a
	where filterName not like '%|%' and
	filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
	and filtername <> ''

	if @WhereClause1 <> ''
	begin
		set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
	end
	else
	begin
		set @WhereClause1 = ''
	end

	----Where clause columns
	declare @AddressColumnWhereClause varchar(max) 
	select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
	from #WhereColumnList a
	where filterName not like '%|%' and
	filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
	and filtername <> ''
			
	if isnull(@AddressColumnWhereClause,'') <> ''
	begin
		set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
    end
	else
	begin
		set @AddressColumnWhereClause = ''
	end

	declare @WhereClauseAll varchar(max) = ''
	select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
	from #WhereColumnList a
			

	set @WhereClauseAll=isnull(CASE WHEN @WhereClauseAll = '' THEN '' ELSE substring(@WhereClauseAll,1,len(@WhereClauseAll)-3) END ,'')
	-------------- 
			
	IF @PortalId  <> '0' 
	BEGIN 
		SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

		SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
	END 

	IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
	-- this check for admin user
    BEGIN
		SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
		INTO #Cte_AdminUserDetail
		FROM View_AdminUserDetail A
		'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
		'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
		;with Cte_AdminUserDetailRowId AS 
		(
		SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
		FROM  #Cte_AdminUserDetail a
		where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
		)
					 
		SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
		INTO #AccountDetails
		FROM Cte_AdminUserDetailRowId 
					 
		SET @Count= ISNULL((SELECT  Count(1) FROM #AccountDetails ),0)
					 
		SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
		FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
		EXEC SP_executesql
		@SQL,
		N'@Count INT OUT',
		@Count = @RowCount OUT;

				
	END;
	-- For Customer user
    ELSE   
	BEGIN
		IF @roleName = ''
		BEGIN
			if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
			drop table ##CustomerUserAddDetail

			if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
			drop table ##View_CustomerUserAddDetail
				
			if OBJECT_ID('tempdb..##UserList') is not null
			drop table ##UserList

			CREATE TABLE ##UserList(UserId int,AddressID int)

			declare @UserList varchar(1000)=''

			------To get the list of user having adress column in global search
			if (@AddressGlobalSearch <> '')
			begin
				
			set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
			--print @UserList
			insert into ##UserList(UserId, b.AddressID)
			exec (@UserList)
			
			end
			----To get the list of user having adress column in where clause 
			if (@AddressColumnWhereClause <> '')
			begin
					
			set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
			--print @UserList
			insert into ##UserList(UserId,AddressID)
			exec (@UserList)
					
			end

			If @IsGuestUser= 0 
			AND
			NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
			-- Customer List with GuestUsers
			Begin
				SET @SQL = 
					'SELECT a.userId,a.AspNetuserId,a.UserName,a.FirstName,a.MiddleName,a.LastName
					,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATETIME, a.ModifiedDate) ModifiedDate, 0 RoleId,''''  RoleName,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
						ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), ''''))  FullName
						,a.AccountId, '''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						Where a.AspNetUserId IS NOT NULL
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
					' 
				EXEC (@SQL)
			End	
			Else If @IsGuestUser= 1 
			Begin
					SET @SQL='SELECT a.userId,a.AspNetuserId,a.UserName,a.FirstName,a.MiddleName,a.LastName
					,a.PhoneNumber,
					a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
					CONVERT( DATETIME, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
					(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
					WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
					a.AccountId,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
					into ##View_CustomerUserAddDetail
					FROM ZnodeUser a
					LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
					LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
					LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
					AND a.AspNetuserId is null
					AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)'
				EXEC (@SQL)
			End
			Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
			and  @IsGuestUser= 0   
			-- Customer List for user edit single user 
			Begin
			SET @SQL='SELECT a.userId,a.AspNetuserId,a.UserName,a.FirstName,a.MiddleName,a.LastName
			,a.PhoneNumber, a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
					CONVERT( DATETIME, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
					(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
					WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
					a.AccountId, r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
					into ##View_CustomerUserAddDetail
					FROM ZnodeUser a
					LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
					LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
					LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
					LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
					AND a.AspNetuserId is not null
					and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)'
				print @SQL
						
				EXEC (@SQL)
			End	
			Else -- Account user List 
			Begin
					SELECT a.userId,a.AspNetuserId,a.UserName,a.PhoneNumber,a.FirstName,a.MiddleName,a.LastName
					,a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
					CONVERT( DATETIME, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
					(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
					WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
					a.AccountId, r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
					into ##View_CustomerUserAddDetail
					FROM ZnodeUser a
					LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
					LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
					LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
					LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
					and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
			End
					
			alter table ##View_CustomerUserAddDetail 
			add StoreName varchar(1000), CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),
			PostalCode varchar(1000), CompanyName varchar(1000), SalesRepUserName varchar(600),SalesRepFullName varchar(1000), PortalId INT 

			IF @PortalId <> '' 
			BEGIN 
				UPDATE a SET a.PortalId = b.PortalId
				FROM ##View_CustomerUserAddDetail a 
				INNER JOIN ZnodeUserPortal b ON (b.Userid = a.Userid )
			END 

			IF (@WhereClauseAll like '%StoreName%' or @Order_By like '%StoreName%' )
			BEGIN
				CREATE NONCLUSTERED INDEX ##View_CustomerUserAddDetail_UserId
				ON [dbo].[##View_CustomerUserAddDetail] ([userId])

				update  a set StoreName = CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END 
						        -- , PortalId = up.PortalId
				from ##View_CustomerUserAddDetail a
				Left join  ZnodeUserPortal up ON(up.UserId = a.UserId)  
				Left JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							
			END
					
			IF (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%')
			BEGIN
			 
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
				from ##View_CustomerUserAddDetail a
				inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
				where isnull(a.AccountId,0)<> 0-- is not null
	 
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
				from ##View_CustomerUserAddDetail a
				inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
			END

			set @Rows = @PageNo * @Rows

			SET @SQL = '			
						
				create table #AccountDetail
				(
					UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName varchar(200),MiddleName varchar(200),LastName varchar(200),
					PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
					RoleId varchar(200),RoleName varchar(200), FullName  varchar(1000),
					StoreName varchar(200),CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
					,AccountId int,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity 
				) 
				'+
				+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,FullName,
				StoreName, CountryName, CityName, StateName, PostalCode, CompanyName,AccountId)
				SELECT top '+cast(@Rows as varchar(10))+'UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,FullName,
				StoreName, CountryName, CityName, StateName, PostalCode, CompanyName,AccountId
				FROM ##View_CustomerUserAddDetail where 1=1'+
				dbo.Fn_GetWhereClause(case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then @WhereClauseGlobal+' And '+@WhereClause1 else @WhereClauseAll end, ' AND ')+
				dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
				Insert Into #TBL_RowCount 
				SELECT count(*)
				FROM ##View_CustomerUserAddDetail where 1=1'+
				dbo.Fn_GetWhereClause(case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then @WhereClauseGlobal+' And '+@WhereClause1 else @WhereClauseAll end, ' AND ')
				+'
						
				SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,FullName,
				StoreName,AccountId,
				CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName
				,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
				into ##CustomerUserAddDetail
				FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

				print @SQL
			EXEC (@SQL)

			Select @RowCount= isnull(RowsCount,0) from #TBL_RowCount

			ALTER TABLE ##CustomerUserAddDetail ADD AddressId Int

			------To get data for StoreName
			update  a 
			set StoreName = CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END 
			from ##CustomerUserAddDetail a
			Left join  ZnodeUserPortal up ON(up.UserId = a.UserId)  
			Left JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
	
			----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
			IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
			OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
			BEGIN
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
				from ##CustomerUserAddDetail a
				inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
				where isnull(a.AccountId,0)<> 0-- is not null
	 
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
				from ##CustomerUserAddDetail a
				inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
			END
	
			----Updating SalesRep for user if any 
			update CUAD
			set CUAD.SalesRepUserName = ZU.UserName, 
			CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
			+CASE
			WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
			THEN ''
			ELSE ' '
			END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
			from ##CustomerUserAddDetail CUAD
			inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
			inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId

			if ( exists(select * from ##UserList) OR @AddressColumnWhereClause <> '')
			begin
				SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,
				FullName,
				StoreName,
				CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName
				from ##CustomerUserAddDetail CUAD
				where exists(select * from ##UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
				Order by RowNumber
			end
			else
			begin
				SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,
				FullName,
				StoreName,
				CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName
				from ##CustomerUserAddDetail
				Order by RowNumber
			end
	
			if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
			drop table ##CustomerUserAddDetail

			if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
			drop table ##View_CustomerUserAddDetail
				
		END;
		ELSE
		BEGIN
			SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
			SET @RowCount = 0;
		END;
    END;			
    END TRY
    BEGIN CATCH
		--SELECT ERROR_MESSAGE()
		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsers @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_AdminUsers',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersByUserId')
	DROP PROC Znode_AdminUsersByUserId

GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersByUserId]
(	
	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId Int = 0,
	@IsSalesRepList Bit = 0
)
AS
/* 
    Summary: List of users with details and shows link with ASPNet tables 
    This procedure is used for finding both users and admin users 
    here use three view "View_RoleUsers" for check  @UserName is present or not 
    "View_AdminUserDetail"  this view use for admin users 
    "View_CustomerUserDetail" Use for customer users 
    Unit Testing   
	SELECT * FROM ZnodeUser 
    DECLARE @EDE INT=0  EXEC Znode_AdminUsersByUserId '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
*/
BEGIN
    BEGIN TRY
    SET NOCOUNT ON;
			
		DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
             
		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)   
		Begin
			SET @SalesRepUserId = 0
		End

		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
			DROP TABLE #TBL_RowCount
		Create table #TBL_RowCount(RowsCount int )
		-----Split where clause XMl 
		CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
		insert into #WhereColumnList(filterName,WhereCondition)
		SELECT 
				Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
				Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
		FROM   @WhereClause.nodes('//filter') Tbl(Col) 
		----Address column in global search
		declare @AddressGlobalSearch varchar(1000)
		declare @GlobalSearch varchar(100)
		select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
		and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

		if isnull(@GlobalSearch,'') <> ''
		begin
			select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
		end
		else
		begin
			SET @AddressGlobalSearch = ''
		end
		----Global search where clause
		declare @WhereClauseGlobal varchar(1000)=''
		select @WhereClauseGlobal = ISNULL(WhereCondition,'')
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
			
		----Where clause columns except Address columns
		declare @WhereClause1 varchar(max) 
		select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
		--case when @WhereClause1 <> ''  then ' And ' else '' end
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''

		if @WhereClause1 <> ''
		begin
			set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
		end
		else
		begin
			set @WhereClause1 = ''
		end

		----Where clause columns
		declare @AddressColumnWhereClause varchar(max) 
		select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''
			
		if isnull(@AddressColumnWhereClause,'') <> ''
		begin
			set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
		end
		else
		begin
			set @AddressColumnWhereClause = ''
		end

		declare @WhereClauseAll varchar(max)
		select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
		from #WhereColumnList a

		set @WhereClauseAll=isnull(substring(@WhereClauseAll,1,len(@WhereClauseAll)-3),'')
		-------------- 

		IF @PortalId  <> '0' 
		BEGIN 
			IF @IsSalesRepList IN (1, 'True')
			BEGIN
				SELECT @PortalId = STUFF((SELECT CONCAT(', ', ISNULL(ZUP2.PortalId,@PortalId))
					FROM dbo.ZnodeUserPortal ZUP2 WITH (NOLOCK)
					WHERE ZUP1.UserId = ZUP2.UserId
					FOR XML PATH ('')), 1, 2, '')
				FROM dbo.ZnodeUserPortal ZUP1 WITH (NOLOCK)
				WHERE ZUP1.UserId=(SELECT TOP 1 UserId FROM ZnodeUser WITH (NOLOCK) WHERE UserName=@UserName)
				GROUP BY ZUP1.UserId;
			END

			SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

			SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
		END 
		IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
		-- this check for admin user
		BEGIN
			SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			INTO #Cte_AdminUserDetail
			FROM View_AdminUserDetail A
			'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
			'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
			;with Cte_AdminUserDetailRowId AS 
			(
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
			FROM  #Cte_AdminUserDetail a
			where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
			)
					 
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
			INTO #AccountDetails
			FROM Cte_AdminUserDetailRowId 
					 
			SET @Count= ISNULL((SELECT  Count(DISTINCT UserId) FROM #AccountDetails ),0)
					 
			SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
			EXEC SP_executesql
			@SQL,
			N'@Count INT OUT',
			@Count = @RowCount OUT;
		END;
		-- For Customer user
		ELSE   
		BEGIN
			IF @roleName = ''
			BEGIN
				if OBJECT_ID('tempdb..#CustomerUserAddDetail') is not null
				drop table #CustomerUserAddDetail

				if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
				drop table #View_CustomerUserAddDetail
				
				if OBJECT_ID('tempdb..#UserList') is not null
				drop table #UserList

				CREATE TABLE #UserList(UserId int,AddressID int)

				declare @UserList varchar(1000)=''

				------To get the list of user having adress column in global search
				if (@AddressGlobalSearch <> '')
				begin
				
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
				--print @UserList
				insert into #UserList(UserId, b.AddressID)
				exec (@UserList)
			
				end
				----To get the list of user having adress column in where clause 
				if (@AddressColumnWhereClause <> '')
				begin
					
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
				--print @UserList
				insert into #UserList(UserId,AddressID)
				exec (@UserList)
					
				end

				CREATE TABLE #View_CustomerUserAddDetail (
					UserId INT,AspNetuserId NVARCHAR(256),UserName NVARCHAR(512),FirstName VARCHAR(100),MiddleName	VARCHAR(100),LastName	VARCHAR(100),
					PhoneNumber VARCHAR(50),Email VARCHAR(50),EmailOptIn BIT,CreatedBy	INT, CreatedDate DATETIME,	ModifiedBy	INT ,
					ModifiedDate	DATETIME, RoleId NVARCHAR(256),RoleName  NVARCHAR(512), 	IsActive BIT,	IsLock BIT,	FullName  NVARCHAR(MAX),
					AccountName	 NVARCHAR(512) ,AccountId INT,	ExternalId  NVARCHAR(MAX),	IsAccountCustomer	BIT ,
					BudgetAmount NUMERIC(18,6),	TypeOfRole	 NVARCHAR(512) ,IsGuestUser	BIT ,CustomerPaymentGUID  NVARCHAR(MAX),
					StoreName	 NVARCHAR(512) ,PortalId	INT ,AccountCode  NVARCHAR(200))

					CREATE TABLE #CustomerUserAddDetail(
					UserId INT,AspNetuserId NVARCHAR(256),UserName NVARCHAR(512),FirstName VARCHAR(100),MiddleName	VARCHAR(100),LastName	VARCHAR(100),
					PhoneNumber VARCHAR(50),Email VARCHAR(50),EmailOptIn BIT,CreatedBy	INT, CreatedDate DATETIME,	ModifiedBy	INT ,
					ModifiedDate	DATETIME, RoleId NVARCHAR(256),RoleName  NVARCHAR(512), 	IsActive BIT,	IsLock BIT,	FullName  NVARCHAR(MAX),
					AccountName	 NVARCHAR(512)  ,PermissionsName NVARCHAR(256),DepartmentName NVARCHAR(256) ,DepartmentId INT ,AccountId INT,
					AccountPermissionAccessId INT, ExternalId  NVARCHAR(MAX),BudgetAmount  NUMERIC(18,6),AccountUserOrderApprovalId INT ,ApprovalName NVARCHAR(256),
					ApprovalUserId INT ,PermissionCode NVARCHAR(256) ,CustomerPaymentGUID NVARCHAR(256) ,StoreName NVARCHAR(256),
					PortalId INT,CountryName NVARCHAR(256) , CityName NVARCHAR(256) , StateName NVARCHAR(256), PostalCode NVARCHAR(256),
					CompanyName NVARCHAR(256) , SalesRepUserName NVARCHAR(256) , SalesRepFullName NVARCHAR(256), AccountCode NVARCHAR(200)
					,RowNumber INT )

				If @IsGuestUser= 0 
				AND
				NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
				-- Customer List with GuestUsers
				Begin
					SET @SQL = 
						'INSERT INTO #View_CustomerUserAddDetail
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATETIME, a.ModifiedDate) ModifiedDate, 0 RoleId,
							CASE WHEN A.AccountId IS NULL THEN '''' ELSE r.name END as RoleName,
							CASE	WHEN B.LockoutEndDateUtc IS NULL
							THEN CAST(1 AS    BIT)	ELSE CAST(0 AS BIT)
							END IsActive,	CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
							ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) 
				
							FullName,
							e.Name AccountName
							,a.AccountId,a.ExternalId,	CASE	WHEN a.AccountId IS NULL THEN 0	ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,
							'''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							--,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							,ISnull(zp.StoreName , ''ALL'')StoreName,
							up.PortalId as PortalId, e.AccountCode
							
							FROM ZnodeUser a
							INNER JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							INNER JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)
							WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						' 
					EXEC (@SQL)
				End	
				Else If @IsGuestUser= 1 
				Begin
						SET @SQL='INSERT into #View_CustomerUserAddDetail
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATETIME, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND a.AspNetuserId is null
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End
				Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
				and  @IsGuestUser= 0   
				-- Customer List for user edit single user 
				Begin
				SET @SQL='INSERT INTO #View_CustomerUserAddDetail
				SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATETIME, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End	
				Else -- Account user List 
				Begin	
						INSERT into #View_CustomerUserAddDetail
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATETIME, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId, e.AccountCode
						
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
				End


				alter table #View_CustomerUserAddDetail 
				add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
				AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int
				--, PortalId int , StoreName varchar(1000)
				,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000),
				SalesRepUserName varchar(600),SalesRepFullName varchar(1000)

	
				IF ((@AddressGlobalSearch like '%CountryName%' OR @AddressGlobalSearch like '%CityName%' OR @AddressGlobalSearch like '%StateName%' OR @AddressGlobalSearch like '%PostalCode%' OR @AddressGlobalSearch like '%CompanyName%')
				and exists(select * from #UserList))
				BEGIN
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from #View_CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
					where exists(select * from #UserList UL where a.UserId = UL.UserId and UL.AddressId = ZA.AddressId )

					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from #View_CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
					and exists(select * from #UserList UL where a.UserId = UL.UserId and UL.AddressID = ZA.AddressId)
					and (a.CountryName is null OR a.CityName is null OR a.StateName is null or a.PostalCode is null or a.CompanyName is null)
		
				END

				--CREATE NONCLUSTERED INDEX IND_101
				--ON [dbo].[#View_CustomerUserAddDetail] ([userId],[AspNetuserId])

				SET @SQL = '			
						
					create table #AccountDetail
					(
						UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName nvarchar(200),MiddleName nvarchar(200),LastName nvarchar(200),
						PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
						RoleId varchar(200),RoleName varchar(200),IsActive bit,IsLock bit,FullName  varchar(1000),AccountName  varchar(200),PermissionsName  varchar(200),
						DepartmentName  varchar(200),DepartmentId int,AccountId int,AccountPermissionAccessId int, ExternalId  varchar(200),BudgetAmount numeric(10,6),
						AccountUserOrderApprovalId int,ApprovalName varchar(200),ApprovalUserId int,PermissionCode varchar(500),CustomerPaymentGUID varchar(500),
						StoreName varchar(200),PortalId int,CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
						,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity , AccountCode nvarchar(100)
					) 
					'+
					+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode)
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID 
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode
					FROM #View_CustomerUserAddDetail where 1=1'+
					dbo.Fn_GetWhereClause(@WhereClauseGlobal+case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then ' And '+@WhereClause1 else @WhereClause1 end, ' AND ')+
					dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
					Insert Into #TBL_RowCount Values(@@RowCount)
					INSERT INTO #CustomerUserAddDetail		
					SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
					
					FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

				EXEC (@SQL)
				
				Select @RowCount= isnull(RowsCount  ,0) from #TBL_RowCount

				ALTER TABLE #CustomerUserAddDetail ADD AddressId Int
				--To get data for DepartmentId
				update CUD SET DepartmentId = i.DepartmentId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

				--To get data for PermissionsName
				update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
				INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
				INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

				------To get data for DepartmentName
				update CUD SET DepartmentName = j.DepartmentName
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
				INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	
				--To get data for AccountUserOrderApprovalId
				update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	
				--To get data for ApprovalName,ApprovalUserId
				update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END,
				ApprovalUserId = ZAUOA.ApprovalUserId
				from #CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
				INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
	
				----To get data for PortalId
				--update CUD SET PortalId = CASE
				--								WHEN cud.AccountId IS NULL
				--								THEN up.PortalId
				--								ELSE ZPA.PortalId
				--							END 
				--from #CustomerUserAddDetail cud
				--   LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
				--LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
	
				----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
				IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
				OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
				BEGIN
			 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from #CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
	 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from #CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
				END

				----Updating SalesRep for user if any 
				update CUAD
				set CUAD.SalesRepUserName = azu.UserName, 
				CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
				from #CustomerUserAddDetail CUAD
				inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
				inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
				inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
				inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

				if ( exists(select * from #UserList) OR @AddressColumnWhereClause <> '')
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from #CustomerUserAddDetail CUAD
					where exists(select * from #UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
					Order by RowNumber
				end
				else
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from #CustomerUserAddDetail
					Order by RowNumber
				end

	                if OBJECT_ID('tempdb..#CustomerUserAddDetail') is not null
					drop table #CustomerUserAddDetail

					if OBJECT_ID('tempdb..#View_CustomerUserAddDetail') is not null
					drop table #View_CustomerUserAddDetail

				    if OBJECT_ID('tempdb..#UserList') is not null
					drop table #UserList 
				
			END;
			ELSE
			BEGIN
				SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
				SET @RowCount = 0;
			END;
		END;			
    END TRY
    BEGIN CATCH
		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersByUserId @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_AdminUsersByUserId',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersSalesRep')
	DROP PROC Znode_AdminUsersSalesRep

GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersSalesRep]
(	
	@RoleName		VARCHAR(200)='',
    @WhereClause	VARCHAR(MAX)  = '',
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@UserId int = 0
)
AS
begin
		set nocount on

		declare @SQL nvarchar(max)
		declare @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');

		--BEGIN TRY

			if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
				drop table ##CustomerUserAddDetail

			if OBJECT_ID('tempdb..##View_SalesRepUserAddDetail') is not null
				drop table ##View_SalesRepUserAddDetail
			
			-----Getting SalesRep users associated with Portals of @UserId (given user)
			--select a.UserId 
			--into #SalesRepUser
			--from ZnodeUserPortal a
			--inner join ZnodeSalesRepCustomerUserPortal b on a.UserPortalId = b.UserPortalId and a.UserId = b.SalesRepUserId
			--where exists(select * from ZnodeUserPortal ZUP where UserId = @UserId and a.PortalId = ZUP.PortalId)
			
			-----Getting SalesRep users associated with Portals of @UserId (given user)
			select a.UserId 
			into #SalesRepUser
			from ZnodeUserPortal a
			inner join ZnodeUser b on a.UserId = b.UserId 
			inner join AspNetUsers c on b.AspNetUserId = c.Id
			inner join AspNetUserRoles d on c.Id = d.UserId
			inner join AspNetRoles e on d.RoleId = e.Id
			where e.Name = 'Sales Rep'
			and (exists(select * from ZnodeUserPortal ZUP where ZUP.UserId = @UserId and (a.PortalId = ZUP.PortalId or ZUP.PortalId is null))
			    or a.PortalId is null)
		    

			SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
				a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATETIME, a.CreatedDate) CreatedDate,A.ModifiedBy,
				CONVERT( DATETIME, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
				CASE
					WHEN B.LockoutEndDateUtc IS NULL
					THEN CAST(1 AS    BIT)
					ELSE CAST(0 AS BIT)
				END IsActive,
				CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')
					+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = ''
						THEN ''
						ELSE ' '
					END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
				e.Name AccountName,a.AccountId,a.ExternalId,
				CASE
					WHEN a.AccountId IS NULL
					THEN 0
					ELSE 1
				END IsAccountCustomer,
				a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
				,a.CustomerPaymentGUID
		into ##View_SalesRepUserAddDetail
		FROM ZnodeUser a
		left JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
		LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
		LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
		LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                               
		LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
		and exists(select * from #SalesRepUser SRU where a.UserId = SRU.UserId)

	alter table ##View_SalesRepUserAddDetail 
	add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
	AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int, PortalId int , StoreName varchar(1000)
	,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000)

	--To get data for DepartmentId
	update CUD SET DepartmentId = i.DepartmentId
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
		
	--To get data for PermissionsName
	update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
	INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)
	
	--To get data for DepartmentName
	update CUD SET DepartmentName = j.DepartmentName
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
	INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

	--To get data for AccountPermissionAccessId
	update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

	--To get data for AccountPermissionAccessId
	update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
		
	--To get data for AccountUserOrderApprovalId
	update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
		
	--To get data for ApprovalName,ApprovalUserId
	update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
									+CASE
										WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
										THEN ''
										ELSE ' '
									END,
					ApprovalUserId = ZAUOA.ApprovalUserId
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
		
	--To get data for PortalId
	update CUD SET PortalId = CASE
									WHEN cud.AccountId IS NULL
									THEN up.PortalId
									ELSE ZPA.PortalId
								END 
	from ##View_SalesRepUserAddDetail cud
	INNER JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
	INNER JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
		
	----To get data for StoreName
	create index Ind_##View_SalesRepUserAddDetail_UserId on ##View_SalesRepUserAddDetail(UserId)
	update CUD SET StoreName = CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END 
	from ##View_SalesRepUserAddDetail cud
	LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
	LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
		
	----To get data for StoreName
	update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
	from ##View_SalesRepUserAddDetail a
	inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
	inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
	where isnull(a.AccountId,0)<> 0-- is not null

		
	----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
	update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
	from ##View_SalesRepUserAddDetail a
	inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
	inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
	where isnull(a.AccountId,0)<> 0-- is not null
	 
	update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
	from ##View_SalesRepUserAddDetail a
	inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
	inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
		
	SET @SQL = '			
			SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
			EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
			AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
			BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID ,StoreName,PortalId,
			CountryName, CityName, StateName, PostalCode, CompanyName
			INTO #Cte_CustomerUserDetail
			FROM ##View_SalesRepUserAddDetail a 				
			WHERE 1=1 '+dbo.Fn_GetWhereClause(@WhereClause, ' AND ')+' 
					
			----;With Cte_CustomerUserDetailRowId  AS 
			----(
			SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
			EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
			AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
			BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId ,StoreName,PortalId,
			CountryName, CityName, StateName, PostalCode, CompanyName
			into #AccountDetail
			FROM #Cte_CustomerUserDetail -- genrate the unique rowid 
			----)
					 			 
			--SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
			--EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
			--AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
			--BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID ,RowId,StoreName,PortalId,
			--CountryName, CityName, StateName, PostalCode, CompanyName
			--INTO #AccountDetail FROM Cte_CustomerUserDetailRowId  

			SET @Count= ISNULL((SELECT  Count(1) FROM #AccountDetail    ),0)

			SELECT DISTINCT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
			EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
			AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
			BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
			CountryName, CityName, StateName, PostalCode, CompanyName
			,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowNumber
			into ##CustomerUserAddDetail
			FROM #AccountDetail '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');
			PRINT @SQL    					
			EXEC SP_executesql @SQL,
			N'@Count INT OUT',
			@Count = @RowCount OUT;
		
		SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
				AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
				BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
				CountryName, CityName, StateName, PostalCode, CompanyName
		from ##CustomerUserAddDetail
		where UserId <> @UserId
		Order by RowNumber
	
		if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
			drop table ##CustomerUserAddDetail

		if OBJECT_ID('tempdb..##View_SalesRepUserAddDetail') is not null
			drop table ##View_SalesRepUserAddDetail

		--END TRY
  --       BEGIN CATCH
  --          DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersSalesRep @RoleName = '+@RoleName+' ,@WhereClause='+@WhereClause+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50)) ;
  --          EXEC Znode_InsertProcedureErrorLog
  --          @ProcedureName    = 'Znode_AdminUsersSalesRep',
  --          @ErrorInProcedure = @ERROR_PROCEDURE,
  --          @ErrorMessage     = @ErrorMessage,
  --          @ErrorLine        = @ErrorLine,
  --          @ErrorCall        = @ErrorCall;
  --       END CATCH;
end

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPromotions')
	DROP PROC Znode_ImportPromotions

GO

CREATE PROCEDURE [dbo].[Znode_ImportPromotions]
(
	@TableName			NVARCHAR(100),
	@Status				BIT,
	@UserId				INT,
	@ImportProcessLogId	INT,
	@NewGUId			NVARCHAR(200),
	@LocaleId			INT=1,
	@CsvColumnString	NVARCHAR(MAX),
	@PromotionTypeId	INT , 
	@IsGenerateErrorLog	BIT = 1
)
AS 
/*
	Summary :  Made a provision to import Promotions details.
	
	Unit Testing: 
		EXEC dbo.Znode_ImportPromotions @TableName='',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId='',@LocaleId=1,
			@CsvColumnString=,@PromotionTypeId=17

	SELECT @TableName='##Temp',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId=NEWID(),@LocaleId=1,
			@CsvColumnString='PromoCode,Name,Description,StartDate,EndDate,DisplayOrder,Store,Profile,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,AvailableQuantity
				,DiscountAmount,MinimumQuantity,MinimumOrderAmount,Brand',
			@PromotionTypeId=17
*/
BEGIN
	SET NOCOUNT ON;
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(MAX);

	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

	DECLARE @GetDate1 VARCHAR(100) = CONVERT(VARCHAR(30),@GetDate,121)
	DECLARE @ImportProcessLogId1 VARCHAR(100) = CAST(@ImportProcessLogId AS VARCHAR(15))
	DECLARE @UserId1 VARCHAR(15) = CAST(@UserId AS VARCHAR(15))

	IF ISNULL(@LocaleId,0)=0
	BEGIN
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
	END

	DECLARE @LocaleId1 VARCHAR(15) = CAST(@LocaleId AS VARCHAR(15))

	IF OBJECT_ID('tempdb..##Promotions') IS NOT NULL
		DROP TABLE ##Promotions;

	SET @SSQL='CREATE TABLE ##Promotions (RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT , '+
		REPLACE(TRIM(LTRIM(@CsvColumnString)), ',' ,' NVARCHAR(MAX),') + CASE WHEN @CsvColumnString = '' THEN '' ELSE ' NVARCHAR(MAX)' END+', GUID NVARCHAR(400)) 
		INSERT INTO ##Promotions (RowNumber,' + @CsvColumnString + ',GUID) 
		SELECT ROW_NUMBER() OVER (ORDER BY PromoCode) As RowNumber,' + @CsvColumnString + ','''+@NewGUId+''' As GUID FROM '+ @TableName +'
		'
		
	EXEC (@SSQL)
	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PortalId') AND @IsGenerateErrorLog = 1 
	BEGIN
		ALTER TABLE ##Promotions ADD PortalId INT

		UPDATE P
		SET P.PortalId = CASE WHEN LTRIM(TRIM(P.Store))='All Stores' THEN NULL ELSE ISNULL(ZP.PortalId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodePortal ZP ON P.Store=ZP.StoreCode
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProfileId') AND @IsGenerateErrorLog = 1 
	BEGIN
		ALTER TABLE ##Promotions ADD ProfileId INT

		UPDATE P
		SET P.ProfileId = CASE WHEN LTRIM(TRIM(P.Profile))='All Profiles' THEN NULL ELSE ISNULL(ZP.ProfileId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodeProfile ZP ON P.Profile=ZP.DefaultExternalAccountNo
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PromotionTypeId')
	BEGIN
		ALTER TABLE ##Promotions ADD PromotionTypeId INT
		UPDATE ##Promotions
		SET PromotionTypeId = @PromotionTypeId
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='IsUnique')
	BEGIN
		ALTER TABLE ##Promotions ADD IsUnique BIT
		UPDATE ##Promotions
		SET IsUnique = 0
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='InitialQuantity')
	BEGIN
		ALTER TABLE ##Promotions ADD InitialQuantity FLOAT
		UPDATE ##Promotions
		SET InitialQuantity = AvailableQuantity
	END

	UPDATE ##Promotions
	SET IsCouponRequired=0
	WHERE ISNULL(IsCouponRequired,'')='' OR ISNULL(IsCouponRequired,'')='No';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=0
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='' OR ISNULL(IsAllowedWithOtherCoupons,'')='No';

	UPDATE ##Promotions
	SET IsCouponRequired=1
	WHERE ISNULL(IsCouponRequired,'')='Yes';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=1
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='Yes';

	-- Code for not consider Discount Information for specific Promotion Type
	DECLARE @PromotionTypeName NVARCHAR(50);

	SELECT TOP 1 @PromotionTypeName = [Name] FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId;

	IF @PromotionTypeName IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price')
	BEGIN
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, PromotionMessage='';
	END
	ELSE IF @PromotionTypeName IN ('Call For Pricing')
	BEGIN
		SET @SSQL='
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, 
			PromotionMessage = '+CASE WHEN @IsGenerateErrorLog = 1 THEN ' CallForPriceMessage ' ELSE 'PromotionMessage' END;
		
		EXEC (@SSQL);
	END
	
	BEGIN TRAN Promotions;
	BEGIN TRY
		-- Start Functional Validation
		-----------------------------------------------
		IF @IsGenerateErrorLog = 1 
		BEGIN
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.PromoCode,'')=''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '82', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.PromoCode))) > 300 AND ISNULL(ii.PromoCode,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.[Name],'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.[Name]))) > 100 AND ISNULL(ii.[Name],'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Description', Description, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Description))) > 100 AND ISNULL(ii.Description,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.StartDate)=0 AND LEN(ii.StartDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '150', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)<CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),111),111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '151', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.StartDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.EndDate)=0 AND LEN(ii.EndDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '152', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.EndDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
		
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNULL(ii.DisplayOrder,0)=0 OR ISNULL(ii.DisplayOrder,'')='')
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '149', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNUMERIC(ii.DisplayOrder)=0 AND LEN(ii.DisplayOrder)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DisplayOrder)=1 AND (CAST(ii.DisplayOrder As INT))>999)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '120', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')<>''
				AND NOT EXISTS (SELECT * FROM ZnodePortal WHERE PortalId=ii.PortalId)
				AND ISNULL(ii.Store,'')<>'All Stores'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '157', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')<>''
				AND EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode AND ISNULL(PortalId,0)<>ISNULL(ii.PortalId,0))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '153', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')<>''
				AND (NOT EXISTS (SELECT * FROM ZnodePortalProfile WHERE ProfileId=ii.ProfileId AND PortalId=ii.PortalId)
					AND ISNULL(ii.Store,'')<>'All Stores')
				OR (NOT EXISTS (SELECT * FROM ZnodeProfile WHERE DefaultExternalAccountNo=ii.Profile)
					AND ISNULL(ii.Profile,'')<>'All Profiles' AND ISNULL(ii.Profile,'')<>'')

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Profile))) > 100 AND ISNULL(ii.Profile,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			IF @PromotionTypeName NOT IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price','Call For Pricing')
			BEGIN
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsCouponRequired', IsCouponRequired, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '154', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') IN ('True','1','Yes')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.PromotionMessage,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '82', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.PromotionMessage,'')<>'' AND LEN(LTRIM(RTRIM(ii.PromotionMessage)))>300)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '138', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
					AND EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code=ii.Code)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '138', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
					AND NOT EXISTS (SELECT * FROM ##Promotions L
									WHERE RowID IN (SELECT MAX(RowId) FROM ##Promotions X WHERE X.Code= L.Code GROUP BY X.Code)
										AND ii.Code= L.Code and ii.PromoCode = L.PromoCode 
									)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '139', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.Code,'')<>'' AND LEN(LTRIM(RTRIM(ii.Code)))>20)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '8', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')=''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '108', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=0)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '141', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ii.AvailableQuantity) LIKE '%.%')
					--(ISNUMERIC(ii.AvailableQuantity)=1 AND LEN(PARSENAME(ii.AvailableQuantity,1))>1)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '140', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)<0 OR ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)>9999))
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
			END
		END 

		IF @IsGenerateErrorLog = 1 
		BEGIN
			DECLARE @Query NVARCHAR(MAX);

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='DiscountAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''109'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((ISNUMERIC(ii.DiscountAmount)=0 AND LEN(ii.DiscountAmount)>0) OR CAST(ii.DiscountAmount As FLOAT)<0)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (LEN(PARSENAME(ii.DiscountAmount,1))>2 AND (ii.DiscountAmount) LIKE ''%.%'' AND CAST(ii.DiscountAmount As FLOAT)>0))
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (CAST(ii.DiscountAmount As FLOAT))>100)
					AND '''+@PromotionTypeName+''' LIKE ''%Percent%''

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''161'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND ((CAST(ii.DiscountAmount As FLOAT))>9999999 OR (CAST(ii.DiscountAmount As FLOAT))<0.01))
					AND '''+@PromotionTypeName+''' NOT LIKE ''%Percent%''

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.DiscountAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumQuantity')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''108'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=0 AND LEN(ii.MinimumQuantity)>0) OR CAST(ii.MinimumQuantity As FLOAT)<0

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''141'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (ii.MinimumQuantity) LIKE ''%.%'')

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (CAST(ii.MinimumQuantity As FLOAT))>100)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumQuantity,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumOrderAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''109'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((ISNUMERIC(ii.MinimumOrderAmount)=0 AND LEN(ii.MinimumOrderAmount)>0) OR CAST(ii.MinimumOrderAmount As FLOAT)<0)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (LEN(PARSENAME(ii.MinimumOrderAmount,1))>2 AND (ii.MinimumOrderAmount) LIKE ''%.%'' AND CAST(ii.MinimumOrderAmount As FLOAT)>0))

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (CAST(ii.MinimumOrderAmount As FLOAT))>100)
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumOrderAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END
		
			IF EXISTS (SELECT TOP 1 1 FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='CallForPriceMessage')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''CallForPriceMessage'', CallForPriceMessage, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.CallForPriceMessage))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''143'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD INNER JOIN ZnodePortalBrand PB ON BD.BrandId = PB.BrandId AND PB.PortalId = ii.PortalId WHERE BD.BrandCode=ii.Brand)
					AND ISNULL(ii.Brand,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD WHERE BD.BrandCode=ii.Brand) AND ISNULL(ii.Brand,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Brand))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''144'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCatalog PC
									INNER JOIN ZnodePimCatalog PbC ON PC.PimCatalogId=PbC.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PbC.pimCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE PC.CatalogCode = ii.Catalog)
					AND ISNULL(ii.Catalog,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCatalog PC WHERE PC.CatalogCode = ii.Catalog) AND ISNULL(ii.Catalog,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Catalog))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''145'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCategory PC
									INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PC.PimCategoryId=PCAV.PimCategoryId
									INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL ON PCAV.PimCategoryAttributeValueId=PCAVL.PimCategoryAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PC.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PCt ON PCH.PimCatalogId=PCt.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PCt.PImCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE LocaleId='+@LocaleId1+' AND PCAVL.CategoryValue=ii.Category)
					AND ISNULL(ii.Category,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCategoryAttributeValueLocale PCAVL WHERE PCAVL.CategoryValue=ii.Category) AND ISNULL(ii.Category,'''')<>'''')
				
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Category))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''148'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodeShipping SP
									INNER JOIN ZnodePortalShipping PS ON SP.ShippingId=PS.ShippingId
									WHERE SP.ShippingCode=ii.Shipping AND PS.PortalId=ii.PortalId)
					AND ISNULL(ii.Shipping,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeShipping SP WHERE SP.ShippingCode=ii.Shipping) AND ISNULL(ii.Shipping,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Shipping))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.ProductToDiscount AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.ProductToDiscount) AND ISNULL(ii.ProductToDiscount,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.ProductToDiscount))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''% %'')
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.RequiredProduct AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.RequiredProduct,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.RequiredProduct) AND ISNULL(ii.RequiredProduct,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.RequiredProduct))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''% %'')
					AND ISNULL(ii.RequiredProduct,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName --+ ' [ Promotion - ' + ISNULL(PromoCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN ##Promotions IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			--Delete Invalid Data after functional validation
			DELETE FROM ##Promotions
			WHERE RowNumber IN
			(
				SELECT DISTINCT RowNumber
				FROM ZnodeImportLog
				WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
			);

			-- Update Record count in log
			DECLARE @FailedRecordCount BIGINT;
			DECLARE @SuccessRecordCount BIGINT;

			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber)
			FROM ZnodeImportLog 
			WHERE RowNumber IS NOT NULL AND ImportProcessLogId = @ImportProcessLogId;

			SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) 
			FROM ##Promotions

			UPDATE ZnodeImportProcessLog
			SET FailedRecordcount = @FailedRecordCount ,
				SuccessRecordCount = @SuccessRecordCount ,
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END

		--To identify duplicate records
		IF OBJECT_ID('tempdb..#DuplicatePromotionsData') IS NOT NULL
			DROP TABLE #DuplicatePromotionsData;

		SELECT PromoCode,RowId,ROW_NUMBER() OVER (PARTITION BY PromoCode ORDER BY RowId DESC) As Rn
		INTO #DuplicatePromotionsData
		FROM ##Promotions;

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'DiscountAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.DiscountAmount'', ''Discount'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
			PRINT @Query
		END
		
		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumQuantity'', ''QuantityMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumOrderAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumOrderAmount'', ''OrderMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'ProductQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.ProductQuantity'', ''PromotionProductQuantity'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--For Update Promotions Data
		DECLARE @UpdateColumns NVARCHAR (MAX);

		IF @IsGenerateErrorLog = 1 
		BEGIN
			SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=CASE WHEN ISNULL(P.'+COLUMN_NAME+','''')='''' THEN ZP.'+COLUMN_NAME+' ELSE P.'+COLUMN_NAME+' END'),',')
			--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME='ZnodePromotion'
				AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
				AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsCouponRequired','IsAllowedWithOtherCoupons','IsUnique','ProfileId','PortalId')
				--AND COLUMN_NAME NOT IN ('DiscountAmount','MinimumQuantity','MinimumOrderAmount');
         END
		 ELSE
		 BEGIN 
			SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=CASE WHEN ISNULL(P.'+COLUMN_NAME+','''')='''' THEN P.'+COLUMN_NAME+' ELSE P.'+COLUMN_NAME+' END'),',')
			--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME='ZnodePromotion'
				AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
				AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsUnique','ProfileId')
				-- AND COLUMN_NAME NOT IN ('DiscountAmount','MinimumQuantity','MinimumOrderAmount');
		END

		IF OBJECT_ID('tempdb..#UpdatedPromotions') IS NOT NULL
			DROP TABLE #UpdatedPromotions;

		CREATE TABLE #UpdatedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		SET @Query='
		UPDATE ZP SET '+@UpdateColumns+'
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #UpdatedPromotions (PromotionId, PromoCode, PromotionTypeId)
		FROM ##Promotions P
		INNER JOIN ZnodePromotion ZP ON LTRIM(RTRIM(P.PromoCode)) = ZP.PromoCode
		INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
		'
		EXEC SP_EXECUTESQL @Query;

		--For Insert Promotions Data
		DECLARE @MatchesColumns NVARCHAR (MAX);

		SELECT @MatchesColumns=STRING_AGG(COLUMN_NAME,',') FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME='ZnodePromotion'
			AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
			AND COLUMN_NAME NOT IN ('ProfileId');

		IF OBJECT_ID('tempdb..#InsertedPromotions') IS NOT NULL
			DROP TABLE #InsertedPromotions;

		CREATE TABLE #InsertedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		-- Import New Promotions
		SET @MatchesColumns='
		INSERT INTO ZnodePromotion
			('+@MatchesColumns+',CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			)
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #InsertedPromotions (PromotionId, PromoCode, PromotionTypeId)
		SELECT DISTINCT P.'+@MatchesColumns+','+CAST(@UserId AS VARCHAR(15))+',GETDATE(),'+CAST(@UserId AS VARCHAR(15))+',GETDATE()
		FROM ##Promotions P
		INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode = LTRIM(RTRIM(P.PromoCode)))
		'

		EXEC SP_EXECUTESQL @MatchesColumns;

		DECLARE @checkTable TABLE (Code VARCHAR(1000) , valued NVARCHAR(max))

		DECLARE @InsertData int = 1 
		IF @IsGenerateErrorLog = 0  
		BEGIN 
		    
			SET @InsertData= CASE WHEN NOT EXISTS (SELECT TOP 1 1  FROM #UpdatedPromotions)  THEN 1 ELSE 0 END 
 
			INSERT INTO #InsertedPromotions (PromotionId,PromoCode,PromotionTypeId)
			SELECT PromotionId,PromoCode,PromotionTypeId
			FROM #UpdatedPromotions a 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM #InsertedPromotions b WHERE b.PromoCode = a.PromoCode)

			DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )

			DELETE FROM ZnodePromotionCoupon WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )

			IF @PromotionTypeName IN ('Percent Off X If Y Purchased','Amount Off X If Y Purchased')
			BEGIN
				DELETE FROM ZnodePromotionProduct
					WHERE PromotionId IN (SELECT PromotionId FROM #InsertedPromotions)
						AND (SELECT TOP 1 ProductToDiscount FROM ##Promotions) <> ''
			
				DELETE FROM ZnodePromotionBrand WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 brand FROM ##Promotions ) <> ''

				DELETE FROM ZnodePromotionCategory WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 category FROM ##Promotions ) <> ''

				DELETE FROM ZnodePromotionCatalogs WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 catalog FROM ##Promotions ) <> ''
				DELETE FROM ZnodePromotionShipping WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 Shipping FROM ##Promotions ) <> ''

				SET @InsertData = 1 
			END

			INSERT INTO @checkTable 
			SELECT 'brand' ,(SELECT TOP 1 brand FROM ##Promotions )
			UNION ALL 
			SELECT 'catalog' ,(SELECT TOP 1 catalog FROM ##Promotions )
			UNION ALL 
			SELECT 'category' ,(SELECT TOP 1 category FROM ##Promotions )
			UNION ALL 
			SELECT 'Shipping' ,(SELECT TOP 1 Shipping FROM ##Promotions )
			UNION ALL
			SELECT 'ProductToDiscount' ,(SELECT TOP 1 ProductToDiscount FROM ##Promotions )
			UNION ALL
			SELECT 'RequiredProduct' ,(SELECT TOP 1 RequiredProduct FROM ##Promotions )
		END 
		
		--SELECT 1 
		-- Insert for ZnodePromotionProfileMapper
		--SET @Query='
		--INSERT INTO ZnodePromotionProfileMapper
		--	(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--SELECT DISTINCT IPs.PromotionId, CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN IIF(p.Profile=0,NULL,p.Profile) ELSE    P.Profileid END ,'+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		--FROM #InsertedPromotions IPs 
		--INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		--WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper WHERE Promotionid = IPs.PromotionId AND ISNULL(Profileid,0)=CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN p.Profile ELSE    P.Profileid END )  
		--'
		--PRINT @Query 
		--EXEC SP_EXECUTESQL @Query;

		SET @Query='
		INSERT INTO ZnodePromotionProfileMapper
			(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
				WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0))
		'
		EXEC SP_EXECUTESQL @Query;

		IF @IsGenerateErrorLog = 1
		BEGIN 
			-- Update for ZnodePromotionProfileMapper
			SET @Query='
			DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #UpdatedPromotions) AND ProfileId IS NULL

			DELETE PPM
			FROM ZnodePromotionProfileMapper PPM
			INNER JOIN #UpdatedPromotions IPs ON PPM.Promotionid = IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode AND P.ProfileId IS NULL

			INSERT INTO ZnodePromotionProfileMapper
				(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
					WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0)) AND ISNULL(P.Profile,'''')<>''''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		-- Insert for ZnodePromotionCoupon
		SET @Query='
		INSERT INTO ZnodePromotionCoupon
			(PromotionId,Code,InitialQuantity,AvailableQuantity,IsActive,IsCustomCoupon,CustomCouponCode,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT IPs.PromotionId, P.Code, P.InitialQuantity, P.AvailableQuantity, 1, 0, '''', '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
				INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
			' ELSE '' END +'
		WHERE ISNULL(P.IsCouponRequired,'''') IN (''True'',''1'',''Yes'')
			AND NOT EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code = P.Code)
		'
		EXEC SP_EXECUTESQL @Query;
	
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand' AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Brand') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, BD.BrandId, BD.BrandCode, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON (' +CASE WHEN @IsGenerateErrorLog = 1 THEN ' P.Brand=BD.BrandCode ' ELSE ' BD.BrandId IN (  '+(SELECT TOP 1 Brand FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(BD.BrandId,0)<>0   '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END 
			
			EXEC SP_EXECUTESQL @Query; 
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand' AND @IsGenerateErrorLog = 1 )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, BD.BrandId, BD.BrandCode, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON P.Brand=BD.BrandCode
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionBrand	WHERE Promotionid = IPs.PromotionId AND BrandId=BD.BrandId)
			'
			EXEC SP_EXECUTESQL @Query; 
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Catalog') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PbC.PimCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		   '+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
			INNER JOIN ZnodePimCatalog PC     ON  (  P.Catalog=PC.CatalogCode  ) 
			' ELSE '' END +'
			INNER JOIN ZnodePimcatalog PbC  ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCatalogId=PbC.PimCatalogId ' ELSE ' PbC.PimCatalogId IN (  '+(SELECT TOP 1 Catalog FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PbC.PimCatalogId,0)<>0
			'+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END 

			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PC.PimCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCatalog PC ON (P.Catalog=PC.CatalogCode) 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionCatalogs WHERE Promotionid = IPs.PromotionId AND PublishCatalogId=PC.PimCatalogId)
			'
			EXEC SP_EXECUTESQL @Query;
		END
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Category') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT  DISTINCT IPs.PromotionId, PbC.PimCategoryHierarchyId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN +'
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL  ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId 
			' ELSE '' END +'
			INNER JOIN ZnodePimCategoryHierarchy PbC ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCategoryId=PbC.PimCategoryId ' ELSE ' PbC.PimCategoryHierarchyId IN (  '+(SELECT TOP 1 Category FROM ##Promotions )+') ' END +' )
			WHERE ISNULL(PbC.PimCategoryId,0)<>0 '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END +'
			GROUP BY IPs.PromotionId,PbC.PimCategoryHierarchyId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PbC.PimCategoryHierarchyId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL  ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId 
			INNER JOIN ZnodePimCategoryHierarchy PbC ON PC.PimCategoryId=PbC.PimCategoryId
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionCategory WHERE Promotionid = IPs.PromotionId AND PublishCategoryId=PbC.PimCategoryHierarchyId)
			GROUP BY IPs.PromotionId,PbC.PimCategoryHierarchyId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping' AND @IsGenerateErrorLog = 1 ) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Shipping') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   P.Shipping=SP.ShippingCode ' ELSE ' sp.shippingId  IN (  '+(SELECT TOP 1 Shipping FROM ##Promotions )+') ' END +' ) 
			
			WHERE ISNULL(SP.ShippingId,0)<>0 
			'+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON P.Shipping=SP.ShippingCode 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionShipping WHERE Promotionid = IPs.PromotionId AND ShippingId=SP.ShippingId)
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount' AND @IsGenerateErrorLog = 1  )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'ProductToDiscount')  <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PP.PimProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.ProductToDiscount))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END + '
			INNER JOIN ZnodePimProduct PP  ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PimProductId  IN (  '+(SELECT TOP 1 ProductToDiscount FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PP.PimProductId,0)<>0 '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END +'
			GROUP BY IPs.PromotionId,PP.PimProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PP.PimProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.ProductToDiscount))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			INNER JOIN ZnodePimProduct PP  ON PAV.PimProductId=PP.PimProductId 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProduct WHERE Promotionid = IPs.PromotionId AND PublishProductId=PP.PimProductId)
			GROUP BY IPs.PromotionId,PP.PimProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct'  AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'RequiredProduct')<> '' )
		BEGIN
			SET @Query='
			UPDATE ZP
			SET ZP.PromotionProductQuantity=P.PromotionProductQuantity, ZP.ReferralPublishProductId=PP.PimProductId, ModifiedDate='''+@GetDate1+'''
			FROM ZnodePromotion ZP
			INNER JOIN #InsertedPromotions IPs ON ZP.PromotionId=IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.RequiredProduct))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END +'
			INNER JOIN ZnodePimProduct PP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PimProductId  IN (  '+(SELECT TOP 1 RequiredProduct FROM ##Promotions )+') ' END +' )  
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DROP TABLE IF EXISTS ##Promotions;

		COMMIT TRAN Promotions;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Promotions

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPromotions
					@TableName = '+CAST(@TableName AS VARCHAR(MAX)) +',
					@Status='+ CAST(@Status AS VARCHAR(10))+',
					@UserId = '+CAST(@UserId AS VARCHAR(50))+',
					@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',
					@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',
					@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
					@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(MAX))+',
					@PromotionTypeId='+CAST(@PromotionTypeId AS VARCHAR(20))+',
					@IsGenerateErrorLog='+CAST(@IsGenerateErrorLog AS VARCHAR(10));

		IF @IsGenerateErrorLog = 1
		BEGIN
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
			UPDATE ZnodeImportProcessLog 
			SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , 
				SuccessRecordCount = 0,
				TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPromotions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

INSERT INTO ZnodeMessage (MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 161,'Text','Discount Amount must be within a range of 0.01 - 9999999.',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeMessage WHERE MessageCode = 161)

GO

IF EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodePublishProductEntity_ZnodeCatalogId_SKU_LocaleId_C055E' AND object_id = OBJECT_ID('ZnodePublishProductEntity'))
BEGIN
	DROP INDEX IX_ZnodePublishProductEntity_ZnodeCatalogId_SKU_LocaleId_C055E ON ZnodePublishProductEntity
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'SKU')
BEGIN
    ALTER TABLE ZnodePublishProductEntity ALTER COLUMN SKU NVARCHAR (300) NOT NULL;
END

GO

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_ZnodePublishProductEntity_ZnodeCatalogId_SKU_LocaleId_C055E' AND object_id = OBJECT_ID('ZnodePublishProductEntity'))
BEGIN
	CREATE NONCLUSTERED INDEX [IX_ZnodePublishProductEntity_ZnodeCatalogId_SKU_LocaleId_C055E]
		ON [dbo].[ZnodePublishProductEntity]([ZnodeCatalogId] ASC, [SKU] ASC, [LocaleId] ASC);
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishProductEntity' AND COLUMN_NAME = 'Name')
BEGIN
    ALTER TABLE ZnodePublishProductEntity ALTER COLUMN Name NVARCHAR (600) NOT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE   PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, b.IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 
SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT TOP 1000 STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)

SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU


SELECT  q.VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,q.LocaleId,a.ProductName Name ,Max(a.PimCategoryId) ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       ,isnull((SELECT TOP 1 CategoryName FROM #Temp_categoryDetails r WHERE  r.PimCategoryHierarchyId = Max(a.PimCategoryId)),'') CategoryName, @CatalogName CatalogName, 0 DisplayOrder, q.RevisionState RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex, ISNULL(toe.SalesPrice,0) SalesPrice,ISNULL(toe.RetailPrice,0) RetailPrice,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode,ISNULL(p.SeoDescription,'') SeoDescription,ISNULL(p.SeoKeywords,'')SeoKeywords
	   ,ISNULL(p.SeoTitle,'')SeoTitle,ISNULL(p.SeoUrl,'')SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, ISNULL(PublishProductEntityId,0)PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #PimProduct_distinct a
LEFT JOIN #Distinct_seo p ON (p.SKU = a.SKU AND @IsAllowIndexing = 1 )
LEFT JOIN #price_data toe ON (toe.SKU = a.SKU AND @IsAllowIndexing = 1 )
CROSS APPLY @Versions_working q 
LEFT JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = q.VersionId AND ty.ZnodeProductId  = a.PimProductId AND ty.ZnodeCatalogId =@PimCatalogId ) 
WHERE a.IsActive = 'true' 
GROUP BY q.VersionId, a.PimProductId,a.sku,q.LocaleId,a.ProductName,a.IsActive,q.RevisionState,p.SeoDescription,p.SeoKeywords,p.SeoTitle,p.SeoUrl ,PublishProductEntityId,a.PublishStateId,toe.SalesPrice, toe.RetailPrice



UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 

UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId


INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
OUTPUT inserted.ZnodeProductId INTO @inserted_pimIds
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 
 

DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT PimProductId
FROM @inserted_pimIds

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

UPDATE ZnodeApplicationSetting
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsQuoteId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OmsQuoteId</name><headertext>Pending Order ID</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Account/UpdateAccountQuote</islinkactionurl><islinkparamfield>omsQuoteId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>Customer Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>AccountCode</name><headertext>Account Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>AccountName</name><headertext>Account Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>StoreName</name><headertext>Store Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>OrderStatus</name><headertext>Pending Order Status</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>QuoteOrderTotal</name><headertext>Pending Order Amount</headertext><width>0</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>CreatedDate</name><headertext>Created Date</headertext><width>0</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>CreatedByName</name><headertext>Created By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>ModifiedByName</name><headertext>Modified By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>PublishState</name><headertext>Publish Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>View|orders</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Convert to Order</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Account/UpdateAccountQuote|/Quote/ConvertToOrder</manageactionurl><manageparamfield>omsQuoteId,orderStatus|omsQuoteId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>14</id><name>AccountId</name><headertext>Account Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>15</id><name>IsConvertedToOrder</name><headertext></headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Is Converted To Order</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>IsConvertedToOrder</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeOmsQuote'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAddonAssociation')
	DROP PROC Znode_ImportAddonAssociation

GO

CREATE PROCEDURE [dbo].[Znode_ImportAddonAssociation](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

		IF OBJECT_ID('TEMPDB..#InsertProductAddonAssociation') IS NOT NULL
			DROP TABLE #InsertProductAddonAssociation

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertZnodePimAddOnProduct') IS NOT NULL
			DROP TABLE #InsertZnodePimAddOnProduct

		CREATE TABLE #InsertZnodePimAddOnProduct ( PimAddOnProductId int,PimAddonGroupId int,PimProductId int)

		CREATE TABLE #InsertProductAddonAssociation
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300),AddonGroupName varchar(300),AddOnSKU varchar(300),DisplayOrder int, IsDefault varchar(10), GUID nvarchar(400)
		
		);

		CREATE TABLE #SKU 
		( 
			SKU nvarchar(300), PimProductId int
		);

		----Get All SKU Data From DB
		INSERT INTO #SKU (SKU, PimProductId)
		SELECT ZPAVL.AttributeValue, ZPAV.PimProductId
		FROM ZnodePimAttributeValue AS ZPAV
		INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		WHERE ZPA.AttributeCode = 'SKU';

		SET @SSQL = 'Select RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID FROM '+@TableName;
		INSERT INTO #InsertProductAddonAssociation( RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID )
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE #InsertProductAddonAssociation  
		SET IsDefault=CASE ISNULL(IsDefault,0) WHEN 'YES' THEN 1 WHEN 'NO' THEN 0 END

		SELECT SKU,AddonGroupName,AddOnSKU 
		INTO #DuplicateProductAddonAssociation 
		FROM #InsertProductAddonAssociation 
		Group BY SKU,AddonGroupName,AddOnSKU  having count(*) > 1

		----Checking AddonGroupName present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '99', 'AddonGroupName', AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS ( SELECT * FROM ZnodePimAddonGroupLocale i where i.AddonGroupName = ii.AddonGroupName );

		----Checking SKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.SKU = SKU.SKU)

		----Checking AddOnSKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'AddOnSKU', AddOnSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.AddOnSKU = SKU.SKU)
		
		----Duplicate Record (SKU \ AddOnSKU \ AddonGroupName)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '53', 'SKU \ AddOnSKU \ AddonGroupName ', SKU+' \ '+AddOnSKU+' \ '+AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE EXISTS ( select * FROM #DuplicateProductAddonAssociation i WHERE i.SKU = ii.SKU and i.AddOnSKU = ii.AddOnSKU and i.AddonGroupName = ii.AddonGroupName );

		----Checking is default value data validation
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertProductAddonAssociation AS ii  
		WHERE ISNULL(ii.IsDefault,0) not in ('True','1','Yes','FALSE','0','No','')
		
		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--	FROM #InsertProductAddonAssociation AS ii
		--	WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAddonAssociation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertProductAddonAssociation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProductAddonAssociation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))  
		WHERE ImportProcessLogId = @ImportProcessLogId;    
		
		UPDATE PAPD
		SET PAPD.ModifiedBy =@UserId,PAPD.ModifiedDate = GETDATE(),
		PAPD.IsDefault = CASE WHEN ISNULL(IPAA.IsDefault,'') <>'' THEN IPAA.IsDefault ELSE PAPD.IsDefault END,
		PAPD.DisplayOrder = CASE WHEN ISNULL(IPAA.DisplayOrder,'') <>'' THEN IPAA.DisplayOrder ELSE PAPD.DisplayOrder END 
		FROM #InsertProductAddonAssociation IPAA   
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU   
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.AddOnSKU   
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName   
		INNER JOIN ZnodePimAddOnProduct PAP ON (PAP.PimProductId = SKU.PimProductId AND PAP.PimAddonGroupId = ZPAGL.PimAddonGroupId)
		INNER JOIN ZnodePimAddOnProductDetail PAPD ON (PAPD.PimAddOnProductId =PAP.PimAddOnProductId AND SKU1.PimProductId = PAPD.PimChildProductId )
		
		-----Inserting records in ZnodePimAddOnProduct
		INSERT INTO ZnodePimAddOnProduct(PimAddonGroupId,PimProductId,DisplayOrder,RequiredType,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT inserted.PimAddOnProductId, inserted.PimAddonGroupId,inserted.PimProductId into #InsertZnodePimAddOnProduct (PimAddOnProductId,PimAddonGroupId,PimProductId)
		SELECT DISTINCT ZPAGL.PimAddonGroupId,SKU.PimProductId, 999 as DisplayOrder,
		'Required' RequiredType,@UserId as CreatedBy,@GetDate,@UserId as ModifiedBy,@GetDate
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProduct ZPAP where ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId and ZPAP.PimProductId = SKU.PimProductId )

		-----Inserting records in ZnodePimAddOnProductDetail
		INSERT INTO ZnodePimAddOnProductDetail(PimAddOnProductId,PimChildProductId,IsDefault,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT ZPAP.PimAddOnProductId, SKU.PimProductId as PimChildProductId, CASE WHEN isnull(IPAA.IsDefault,0) IN ('True','1','Yes') THEN 1 ELSE 0 END, ISNULL(IPAA.DisplayOrder,999),@UserId ,@GetDate,@UserId,@GetDate 
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.SKU
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on IPAA.AddonGroupName = ZPAGL.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct ZPAP on SKU1.PimProductId = ZPAP.PimProductId and ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProductDetail ZPAPD WHERE ZPAPD.PimAddOnProductId = ZPAP.PimAddOnProductId and ZPAPD.PimChildProductId = SKU.PimProductId )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;

	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAddonAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAddonAssociation',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue

GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE @InsertPimAtrribute  
		SET IsDefault=CASE ISNULL(IsDefault,0) WHEN 'YES' THEN 1 WHEN 'NO' THEN 0 END

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '117', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%' OR ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %'

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--	FROM @InsertPimAtrribute AS ii
		--	WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '16', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,
		                 ZPADV.DisplayOrder = CASE WHEN ISNULL(IPA.DisplayOrder,'') <> '' then  IPA.DisplayOrder ELSE ZPADV.DisplayOrder END ,
		                 ZPADV.IsDefault = CASE WHEN ISNULL(IPA.IsDefault,'')<>'' THEN IPA.IsDefault ELSE ZPADV.IsDefault END,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportHighlight')
	DROP PROC Znode_ImportHighlight

GO

CREATE PROCEDURE [dbo].[Znode_ImportHighlight](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			RowNumber int, HighlightCode varchar(300), HighlightName varchar(1000),DisplayPopup varchar(300),Hyperlink varchar(1000),HighlightType varchar(300),IsActive varchar(100),DisplayOrder int,HighlightImage varchar(500),HighlightImagePath varchar(500), Description varchar(max), ShortDescription varchar(max), ImageAltTag varchar(400), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE @InsertPimAtrribute  
		SET IsActive=CASE ISNULL(IsActive,0) WHEN 'YES' THEN 1 WHEN 'NO' THEN 0 END


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @HighlightAttributeDefaultCode TABLE
		( 
		   AttributeDefaultCode nvarchar(300)
		);
		INSERT INTO @HighlightAttributeDefaultCode
			   SELECT AttributeDefaultValueCode
			   FROM ZnodePimAttributeDefaultValue ZPADV
			   inner join ZnodePimAttribute ZPA on ZPADV.PimAttributeId = ZPA.PimAttributeId
			   where ZPA.AttributeCode = 'Highlights' 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '118', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode not in 
			   (
				   SELECT AttributeDefaultCode FROM @HighlightAttributeDefaultCode 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'DisplayPopup', DisplayPopup, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.DisplayPopup not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'HighlightType', HighlightType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightType NOT in 
			   (
				   SELECT HT.Name  FROM ZnodeHighlightType  HT
			   );

		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--	FROM @InsertPimAtrribute AS ii
		--	WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '79', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.HighlightCode,''))) like '% %' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode in 
			   (
				   select HighlightCode  FROM @InsertPimAtrribute  Group BY HighlightCode  having count(*) > 1 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Highlight - ' + ISNULL(HighlightCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName and IPA.HighlightImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName)

		DECLARE @InsertedZnodeHighlight TABLE(HighlightId INT,HighlightCode VARCHAR(600)) 

			UPDATE ZH SET ZH.DisplayPopup = IPA.DisplayPopup, ZH.Hyperlink = IPA.Hyperlink, ZH.IsActive = CASE WHEN ISNULL(IPA.IsActive,'')<>''THEN IPA.IsActive ELSE ZH.IsActive END,
			       ZH.DisplayOrder = CASE WHEN ISNULL(IPA.DisplayOrder,'')<>'' THEN IPA.DisplayOrder ELSE ZH.DisplayOrder END,ZH.ModifiedBy = @UserId, ZH.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA  
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId

			

			UPDATE ZHL SET ZHL.Name = IPA.HighlightName, ZHL.Description = IPA.Description, ZHL.ShortDescription = IPA.ShortDescription, ZHL.ImageAltTag = IPA.ImageAltTag
			       , ZHL.ModifiedBy = @UserId, ZHL.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA   
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId
			INNER JOIN ZnodeHighlightLocale ZHL  ON ZH.HighlightId = ZHL.HighlightId 

			INSERT INTO ZnodeHighlight (MediaId,HighlightCode,DisplayPopup,Hyperlink,HighlightTypeId,IsActive,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			OUTPUT Inserted.HighlightId,Inserted.HighlightCode INTO @InsertedZnodeHighlight
			SELECT DISTINCT @MediaId,IPA.HighlightCode, IPA.DisplayPopup , IPA.Hyperlink, ZHT.HighlightTypeId,
				   case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end, Case when Isnull(IPA.DisplayOrder,0) = 0 then  999 else IPA.DisplayOrder end  , @UserId , @GetDate ,@UserId , @GetDate 
			FROM @InsertPimAtrribute IPA   
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			WHERE NOT EXISTS(select * from ZnodeHighlight ZH where ZH.HighlightCode = IPA.HighlightCode and ZH.HighlightTypeId = ZHT.HighlightTypeId)

			INSERT INTO ZnodeHighlightLocale(LocaleId,HighlightId,ImageAltTag,Name,Description,ShortDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT @LocaleId, IZH.HighlightId, IPA.ImageAltTag, IPA.HighlightName, IPA.Description, IPA.ShortDescription, @UserId , @GetDate ,@UserId , @GetDate
			FROM @InsertPimAtrribute IPA 
			INNER JOIN @InsertedZnodeHighlight IZH on IPA.HighlightCode = IZH.HighlightCode 


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportHighlight @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportHighlight',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

INSERT  INTO ZnodeActions(AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Import','DownloadPDF',1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeActions WHERE ControllerName = 'Import' and ActionName = 'DownloadPDF')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Import' AND ControllerName = 'Import')
,(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Import' and ActionName= 'DownloadPDF') ,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
(SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Import' AND ControllerName = 'Import') and ActionId =
(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Import' and ActionName= 'DownloadPDF'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Import' AND ControllerName = 'Import')
,(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Import' and ActionName= 'DownloadPDF')
,1,2,GETDATE(),2,GETDATE() WHERE not exists
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId FROM ZnodeMenu WHERE MenuName = 'Import' AND ControllerName = 'Import') and ActionId =
(SELECT TOP 1 ActionId FROM ZnodeActions WHERE ControllerName = 'Import' and ActionName= 'DownloadPDF'))

GO

DECLARE @TimeZoneDetailsDesc NVARCHAR(500);
IF EXISTS (SELECT TOP 1 1 FROM ZnodeTimeZone WHERE LEFT(TimeZoneDetailsDesc,4)='(GMT')
BEGIN
	SET @TimeZoneDetailsDesc='
	DISABLE TRIGGER dbo.Trg_ZnodeTimeZone_GlobalSetting ON dbo.ZnodeTimeZone;

	UPDATE ZnodeTimeZone
	SET TimeZoneDetailsDesc=REPLACE(TimeZoneDetailsDesc,''(GMT'',''(UTC'')
	WHERE LEFT(TimeZoneDetailsDesc,4)=''(GMT'';

	ENABLE TRIGGER dbo.Trg_ZnodeTimeZone_GlobalSetting ON dbo.ZnodeTimeZone;
	'
EXEC (@TimeZoneDetailsDesc)
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE   PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )



SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 
SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)



SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 


DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


 DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = q.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
  CROSS APPLY @Versions_working q 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )



SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId ),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,1) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 

 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity .VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,0 IsRequired,'' RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO



CREATE    PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
--DECLARE #pimProductIds  TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT, VersionId INT  )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId ,VersionId
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
--AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

CREATE INDEX IDX_#pimProductIds ON #pimProductIds(PimProductId)

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID


DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

--INSERT INTO #pimProductIds 
--SELECT  PimProductId 
--FROM #pimProductIds 

SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  #pimProductIds  t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN #pimProductIds  bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT DISTINCT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #pimProductIds  n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct w WHERE w.VersionId = a.VersionId)

CREATE TABLE #tbl_AttributeValueLocale (PimProductId INT ,   AttributeValue NVARCHAR(max), PimAttributeId INT  , LocaleId INT)
CREATE TABLE #default_valuelocale (PimAttributeDefaultValueId INT , AttributeDefaultValue NVARCHAR(max), LocaleId int  )

IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct WHERE LocaleId <> @DefaultLocaleId )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   WHERE m.LocaleId <> @DefaultLocaleId

   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

   --INSERT INTO #tbl_AttributeValue 
   --SELECT PimProductId, PimAttributeId , AttributeValue, CustomCode ,  IsDefaultValue , m.LocaleId
   --FROM #tbl_AttributeValue a 
   --CROSS APPLY @LocaleIds_distinct m
   --WHERE m.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
    FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE aa.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId AND aa.LocaleId =a.localeId )
   WHERE aa.LocaleId <> @DefaultLocaleId
 
   --INSERT INTO #default_value 
   --SELECT PimProductId ,PimAttributeId,  Code , m.LocaleId	, Value,DisplayOrder,IsEditable,SwatchText,Path,PimAttributeDefaultValueId,VariantSKU,VariantDisplayOrder
   --FROM #default_value a 
   --CROSS APPLY @LocaleIds_distinct m
   --WHERE m.LocaleId <> @DefaultLocaleId

   INSERT INTO #default_valuelocale
   SELECT  bc.PimAttributeDefaultValueId, bc.AttributeDefaultValue, bc.LocaleId 
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE bc.LocaleId <> @DefaultLocaleId
   



END 
    DROP TABLE IF EXISTS #tbl_ProductValueid

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID
	
	DECLARE @t transferId 

	WHILE EXISTS (SELECT TOP 1 1 FROM #PublishProductEntityId)
	BEGIN 
	
	INSERT INTO @t
	SELECT TOP 50000 PublishProductEntityId
	FROM #PublishProductEntityId

UPDATE m
SET m.Attributes = (SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(IIF(ut.AttributeValue IS NULL , a.AttributeValue,ut.AttributeValue),'') AttributeValues
				,ISNULL((
				   SELECT   Code,m.LocaleId,IIF(AttributeDefaultValue IS NULL ,Value, AttributeDefaultValue) Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   LEFT JOIN #default_valuelocale op ON (op.PimAttributeDefaultValueId = nt.PimAttributeDefaultValueId AND op.LocaleId = m.LocaleId )
				   WHERE nt.PimProductId = m.ZnodeProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId =@DefaultLocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = m.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =m.LocaleId)
WHERE a.PimProductId = m.ZnodeProductId AND a.LocaleId = @DefaultLocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
    )

FROM ZnodePublishProductEntity m
WHERE EXISTS (SELECT TOP 1 1  FROM @t p WHERE p.id = m.PublishProductEntityId)
OPTION (RECOMPILE)

UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValueLocale ty ON ( ty.PimProductId = a.ZnodeProductId  )
WHERE PublishProductEntityId  IN (SELECT Id FROM @t)
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct t WHERE t.LocaleId = a.LocaleId AND ty.LocaleId = t.LocaleId AND t.LocaleId <> @DefaultLocaleId )
AND ty.PimAttributeId IN (SELECT w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')
AND a.LocaleId <> @DefaultLocaleId
	
	DELETE FROM #PublishProductEntityId WHERE EXISTS (SELECT TOP 1 1 FROM @t WHERE id = PublishProductEntityId)
	DELETE FROM @t
	IF IS_SRVROLEMEMBER('sysadmin', SUSER_NAME())=1
	DBCC DROPCLEANBUFFERS
END 

DROP TABLE IF EXISTS #pimProductIds

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPromotions')
	DROP PROC Znode_ImportPromotions

GO

CREATE PROCEDURE [dbo].[Znode_ImportPromotions]
(
	@TableName			NVARCHAR(100),
	@Status				BIT,
	@UserId				INT,
	@ImportProcessLogId	INT,
	@NewGUId			NVARCHAR(200),
	@LocaleId			INT=1,
	@CsvColumnString	NVARCHAR(MAX),
	@PromotionTypeId	INT , 
	@IsGenerateErrorLog	BIT = 1
)
AS 
/*
	Summary :  Made a provision to import Promotions details.
	
	Unit Testing: 
		EXEC dbo.Znode_ImportPromotions @TableName='',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId='',@LocaleId=1,
			@CsvColumnString=,@PromotionTypeId=17

	SELECT @TableName='##Temp',@Status=0,@UserId=2,@ImportProcessLogId=1,@NewGUId=NEWID(),@LocaleId=1,
			@CsvColumnString='PromoCode,Name,Description,StartDate,EndDate,DisplayOrder,Store,Profile,IsCouponRequired,IsAllowedWithOtherCoupons,PromotionMessage,Code,AvailableQuantity
				,DiscountAmount,MinimumQuantity,MinimumOrderAmount,Brand',
			@PromotionTypeId=17
*/
BEGIN
	SET NOCOUNT ON;
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(MAX);

	DECLARE @GetDate DATETIME = dbo.Fn_GetDate();

	DECLARE @GetDate1 VARCHAR(100) = CONVERT(VARCHAR(30),@GetDate,121)
	DECLARE @ImportProcessLogId1 VARCHAR(100) = CAST(@ImportProcessLogId AS VARCHAR(15))
	DECLARE @UserId1 VARCHAR(15) = CAST(@UserId AS VARCHAR(15))

	IF ISNULL(@LocaleId,0)=0
	BEGIN
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
	END

	DECLARE @LocaleId1 VARCHAR(15) = CAST(@LocaleId AS VARCHAR(15))

	IF OBJECT_ID('tempdb..##Promotions') IS NOT NULL
		DROP TABLE ##Promotions;

	SET @SSQL='CREATE TABLE ##Promotions (RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT , '+
		REPLACE(TRIM(LTRIM(@CsvColumnString)), ',' ,' NVARCHAR(MAX),') + CASE WHEN @CsvColumnString = '' THEN '' ELSE ' NVARCHAR(MAX)' END+', GUID NVARCHAR(400)) 
		INSERT INTO ##Promotions (RowNumber,' + @CsvColumnString + ',GUID) 
		SELECT ROW_NUMBER() OVER (ORDER BY PromoCode) As RowNumber,' + @CsvColumnString + ','''+@NewGUId+''' As GUID FROM '+ @TableName +'
		'
		
	EXEC (@SSQL)
	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PortalId') AND @IsGenerateErrorLog = 1 
	BEGIN
		ALTER TABLE ##Promotions ADD PortalId INT

		UPDATE P
		SET P.PortalId = CASE WHEN LTRIM(TRIM(P.Store))='All Stores' THEN NULL ELSE ISNULL(ZP.PortalId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodePortal ZP ON P.Store=ZP.StoreCode
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProfileId') AND @IsGenerateErrorLog = 1 
	BEGIN
		ALTER TABLE ##Promotions ADD ProfileId INT

		UPDATE P
		SET P.ProfileId = CASE WHEN LTRIM(TRIM(P.Profile))='All Profiles' THEN NULL ELSE ISNULL(ZP.ProfileId,0) END
		FROM ##Promotions P
		LEFT JOIN ZnodeProfile ZP ON P.Profile=ZP.DefaultExternalAccountNo
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='PromotionTypeId')
	BEGIN
		ALTER TABLE ##Promotions ADD PromotionTypeId INT
		UPDATE ##Promotions
		SET PromotionTypeId = @PromotionTypeId
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='IsUnique')
	BEGIN
		ALTER TABLE ##Promotions ADD IsUnique BIT
		UPDATE ##Promotions
		SET IsUnique = 0
	END

	IF NOT EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='InitialQuantity')
	BEGIN
		ALTER TABLE ##Promotions ADD InitialQuantity FLOAT
		UPDATE ##Promotions
		SET InitialQuantity = AvailableQuantity
	END

	UPDATE ##Promotions
	SET IsCouponRequired=0
	WHERE ISNULL(IsCouponRequired,'')='' OR ISNULL(IsCouponRequired,'')='No';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=0
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='' OR ISNULL(IsAllowedWithOtherCoupons,'')='No';

	UPDATE ##Promotions
	SET IsCouponRequired=1
	WHERE ISNULL(IsCouponRequired,'')='Yes';

	UPDATE ##Promotions
	SET IsAllowedWithOtherCoupons=1
	WHERE ISNULL(IsAllowedWithOtherCoupons,'')='Yes';

	-- Code for not consider Discount Information for specific Promotion Type
	DECLARE @PromotionTypeName NVARCHAR(50);

	SELECT TOP 1 @PromotionTypeName = [Name] FROM ZnodePromotionType WHERE PromotionTypeId = @PromotionTypeId;

	IF @PromotionTypeName IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price')
	BEGIN
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, PromotionMessage='';
	END
	ELSE IF @PromotionTypeName IN ('Call For Pricing')
	BEGIN
		SET @SSQL='
		UPDATE ##Promotions
		SET IsAllowedWithOtherCoupons=0, IsCouponRequired=0, 
			PromotionMessage = '+CASE WHEN @IsGenerateErrorLog = 1 THEN ' CallForPriceMessage ' ELSE 'PromotionMessage' END;
		
		EXEC (@SSQL);
	END
	
	BEGIN TRAN Promotions;
	BEGIN TRY
		-- Start Functional Validation
		-----------------------------------------------
		IF @IsGenerateErrorLog = 1 
		BEGIN
			INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.PromoCode,'')=''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '82', 'PromoCode', PromoCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.PromoCode))) > 300 AND ISNULL(ii.PromoCode,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.[Name],'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Name', [Name], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.[Name]))) > 100 AND ISNULL(ii.[Name],'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Description', Description, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Description))) > 100 AND ISNULL(ii.Description,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.StartDate)=0 AND LEN(ii.StartDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '150', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)<CONVERT(DATETIME,CONVERT(VARCHAR(10),GETDATE(),111),111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '151', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.StartDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '5', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISDATE(ii.EndDate)=0 AND LEN(ii.EndDate)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '152', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISDATE(ii.StartDate)=1 AND ISDATE(ii.EndDate)=1 AND CONVERT(DATETIME,ii.StartDate,111)>CONVERT(DATETIME,ii.EndDate,111))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'EndDate', EndDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.EndDate,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
		
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNULL(ii.DisplayOrder,0)=0 OR ISNULL(ii.DisplayOrder,'')='')
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '149', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNUMERIC(ii.DisplayOrder)=0 AND LEN(ii.DisplayOrder)>0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '115', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE (ISNUMERIC(ii.DisplayOrder)=1 AND (CAST(ii.DisplayOrder As INT))>999)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '120', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')<>''
				AND NOT EXISTS (SELECT * FROM ZnodePortal WHERE PortalId=ii.PortalId)
				AND ISNULL(ii.Store,'')<>'All Stores'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '157', 'Store', Store, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Store,'')<>''
				AND EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode AND ISNULL(PortalId,0)<>ISNULL(ii.PortalId,0))

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '153', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')<>''
				AND (NOT EXISTS (SELECT * FROM ZnodePortalProfile WHERE ProfileId=ii.ProfileId AND PortalId=ii.PortalId)
					AND ISNULL(ii.Store,'')<>'All Stores' AND ISNULL(ii.Profile,'')<>'All Profiles')
				OR (NOT EXISTS (SELECT * FROM ZnodeProfile WHERE DefaultExternalAccountNo=ii.Profile)
					AND ISNULL(ii.Profile,'')<>'All Profiles' AND ISNULL(ii.Profile,'')<>'')

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '78', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE LEN(LTRIM(RTRIM(ii.Profile))) > 100 AND ISNULL(ii.Profile,'')<>''

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
			SELECT '8', 'Profile', [Profile], @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM ##Promotions AS ii
			WHERE ISNULL(ii.Profile,'')=''
				AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

			IF @PromotionTypeName NOT IN ('Amount Off Displayed Product Price','Percent Off Displayed Product Price','Call For Pricing')
			BEGIN
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsCouponRequired', IsCouponRequired, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') NOT IN ('True','1','Yes','FALSE','0','No')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '154', 'IsAllowedWithOtherCoupons', IsAllowedWithOtherCoupons, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.IsAllowedWithOtherCoupons,'') IN ('True','1','Yes')
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '142', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.PromotionMessage,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') NOT IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '82', 'PromotionMessage', PromotionMessage, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.PromotionMessage,'')<>'' AND LEN(LTRIM(RTRIM(ii.PromotionMessage)))>300)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '138', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
					AND EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code=ii.Code)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '138', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')<>''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
					AND NOT EXISTS (SELECT * FROM ##Promotions L
									WHERE RowID IN (SELECT MAX(RowId) FROM ##Promotions X WHERE X.Code= L.Code GROUP BY X.Code)
										AND ii.Code= L.Code and ii.PromoCode = L.PromoCode 
									)

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '139', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNULL(ii.Code,'')<>'' AND LEN(LTRIM(RTRIM(ii.Code)))>20)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '8', 'Code', Code, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.Code,'')=''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '108', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=0)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '141', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ii.AvailableQuantity) LIKE '%.%')
					--(ISNUMERIC(ii.AvailableQuantity)=1 AND LEN(PARSENAME(ii.AvailableQuantity,1))>1)
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT '140', 'AvailableQuantity', AvailableQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.AvailableQuantity)=1 AND (ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)<0 OR ISNULL(CAST(ii.AvailableQuantity AS FLOAT),0)>9999))
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
					AND ISNULL(ii.IsCouponRequired,'') IN ('True','1','Yes')
			END
		END 

		IF @IsGenerateErrorLog = 1 
		BEGIN
			DECLARE @Query NVARCHAR(MAX);

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='DiscountAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''109'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((ISNUMERIC(ii.DiscountAmount)=0 AND LEN(ii.DiscountAmount)>0) OR CAST(ii.DiscountAmount As FLOAT)<0)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (LEN(PARSENAME(ii.DiscountAmount,1))>2 AND (ii.DiscountAmount) LIKE ''%.%'' AND CAST(ii.DiscountAmount As FLOAT)>0))
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND (CAST(ii.DiscountAmount As FLOAT))>100)
					AND '''+@PromotionTypeName+''' LIKE ''%Percent%''

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''161'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.DiscountAmount)=1 AND ((CAST(ii.DiscountAmount As FLOAT))>9999999 OR (CAST(ii.DiscountAmount As FLOAT))<0.01))
					AND '''+@PromotionTypeName+''' NOT LIKE ''%Percent%''

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''DiscountAmount'', DiscountAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.DiscountAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumQuantity')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''108'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=0 AND LEN(ii.MinimumQuantity)>0) OR CAST(ii.MinimumQuantity As FLOAT)<0

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''141'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (ii.MinimumQuantity) LIKE ''%.%'')

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumQuantity)=1 AND (CAST(ii.MinimumQuantity As FLOAT))>100)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumQuantity'', MinimumQuantity, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumQuantity,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='MinimumOrderAmount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''109'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((ISNUMERIC(ii.MinimumOrderAmount)=0 AND LEN(ii.MinimumOrderAmount)>0) OR CAST(ii.MinimumOrderAmount As FLOAT)<0)

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''137'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (LEN(PARSENAME(ii.MinimumOrderAmount,1))>2 AND (ii.MinimumOrderAmount) LIKE ''%.%'' AND CAST(ii.MinimumOrderAmount As FLOAT)>0))

				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''136'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE (ISNUMERIC(ii.MinimumOrderAmount)=1 AND (CAST(ii.MinimumOrderAmount As FLOAT))>100)
		
				INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''8'', ''MinimumOrderAmount'', MinimumOrderAmount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ISNULL(ii.MinimumOrderAmount,'''')=''''
					AND NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode=ii.PromoCode)
				'
				EXEC SP_EXECUTESQL @Query;
			END
		
			IF EXISTS (SELECT TOP 1 1 FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='CallForPriceMessage')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''CallForPriceMessage'', CallForPriceMessage, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.CallForPriceMessage))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''143'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD INNER JOIN ZnodePortalBrand PB ON BD.BrandId = PB.BrandId AND PB.PortalId = ii.PortalId WHERE BD.BrandCode=ii.Brand)
					AND ISNULL(ii.Brand,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeBrandDetails BD WHERE BD.BrandCode=ii.Brand) AND ISNULL(ii.Brand,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Brand'', Brand, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Brand))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''144'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCatalog PC
									INNER JOIN ZnodePimCatalog PbC ON PC.PimCatalogId=PbC.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PbC.pimCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE PC.CatalogCode = ii.Catalog)
					AND ISNULL(ii.Catalog,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCatalog PC WHERE PC.CatalogCode = ii.Catalog) AND ISNULL(ii.Catalog,'''')<>'''')

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Catalog'', Catalog, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Catalog))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''145'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimCategory PC
									INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PC.PimCategoryId=PCAV.PimCategoryId
									INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL ON PCAV.PimCategoryAttributeValueId=PCAVL.PimCategoryAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PC.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PCt ON PCH.PimCatalogId=PCt.PimCatalogId
									INNER JOIN ZnodePortalCatalog PtC ON PCt.PImCatalogId=Ptc.PublishCatalogId AND PtC.PortalId = ii.PortalId
									WHERE LocaleId='+@LocaleId1+' AND PCAVL.CategoryValue=ii.Category)
					AND ISNULL(ii.Category,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimCategoryAttributeValueLocale PCAVL WHERE PCAVL.CategoryValue=ii.Category) AND ISNULL(ii.Category,'''')<>'''')
				
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Category'', Category, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Category))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''148'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodeShipping SP
									INNER JOIN ZnodePortalShipping PS ON SP.ShippingId=PS.ShippingId
									WHERE SP.ShippingCode=ii.Shipping AND PS.PortalId=ii.PortalId)
					AND ISNULL(ii.Shipping,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodeShipping SP WHERE SP.ShippingCode=ii.Shipping) AND ISNULL(ii.Shipping,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''Shipping'', Shipping, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.Shipping))) > 100
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.ProductToDiscount AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.ProductToDiscount) AND ISNULL(ii.ProductToDiscount,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.ProductToDiscount))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''ProductToDiscount'', ProductToDiscount, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.ProductToDiscount))) LIKE ''% %'')
					AND ISNULL(ii.ProductToDiscount,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct')
			BEGIN
				SET @Query='
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''156'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE NOT EXISTS (	SELECT * FROM ZnodePimAttributeValueLocale PAVL
									INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
									INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
									INNER JOIN ZnodePimCategoryProduct PCP ON PAV.PimProductId=PCP.PimProductId
									INNER JOIN ZnodePimCategoryHierarchy PCH ON PCP.PimCategoryId=PCH.PimCategoryId
									INNER JOIN ZnodePimCatalog PC ON PCH.PimCatalogId=PC.PimCatalogId
									WHERE LocaleId='+@LocaleId1+' AND PAVL.AttributeValue=ii.RequiredProduct AND PC.PortalId=ii.PortalId)
					AND ISNULL(ii.RequiredProduct,'''')<>''''
					AND ISNULL(ii.Store,'''')<>''All Stores''
					OR (NOT EXISTS (SELECT * FROM ZnodePimAttributeValueLocale PAVL WHERE PAVL.AttributeValue=ii.RequiredProduct) AND ISNULL(ii.RequiredProduct,'''')<>'''')
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''78'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE LEN(LTRIM(RTRIM(ii.RequiredProduct))) > 100
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId)
				SELECT ''147'', ''RequiredProduct'', RequiredProduct, '''+@NewGUId+''', RowNumber, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+''', '+@ImportProcessLogId1+'
				FROM ##Promotions AS ii
				WHERE ((LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''%,%'' OR (LTRIM(RTRIM(ii.RequiredProduct))) LIKE ''% %'')
					AND ISNULL(ii.RequiredProduct,'''')<>''''
				'
				EXEC SP_EXECUTESQL @Query;
			END

			UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName --+ ' [ Promotion - ' + ISNULL(PromoCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN ##Promotions IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			--Delete Invalid Data after functional validation
			DELETE FROM ##Promotions
			WHERE RowNumber IN
			(
				SELECT DISTINCT RowNumber
				FROM ZnodeImportLog
				WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
			);

			-- Update Record count in log
			DECLARE @FailedRecordCount BIGINT;
			DECLARE @SuccessRecordCount BIGINT;

			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber)
			FROM ZnodeImportLog 
			WHERE RowNumber IS NOT NULL AND ImportProcessLogId = @ImportProcessLogId;

			SELECT @SuccessRecordCount = COUNT(DISTINCT RowNumber) 
			FROM ##Promotions

			UPDATE ZnodeImportProcessLog
			SET FailedRecordcount = @FailedRecordCount ,
				SuccessRecordCount = @SuccessRecordCount ,
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END

		--To identify duplicate records
		IF OBJECT_ID('tempdb..#DuplicatePromotionsData') IS NOT NULL
			DROP TABLE #DuplicatePromotionsData;

		SELECT PromoCode,RowId,ROW_NUMBER() OVER (PARTITION BY PromoCode ORDER BY RowId DESC) As Rn
		INTO #DuplicatePromotionsData
		FROM ##Promotions;

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'DiscountAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.DiscountAmount'', ''Discount'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
			PRINT @Query
		END
		
		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumQuantity'', ''QuantityMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'MinimumOrderAmount' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.MinimumOrderAmount'', ''OrderMinimum'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS(SELECT * FROM tempdb.sys.columns WHERE [name] = N'ProductQuantity' AND [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
		BEGIN
			SET @Query='
			EXEC tempdb.sys.sp_rename ''tempdb.dbo.##Promotions.ProductQuantity'', ''PromotionProductQuantity'' , ''COLUMN''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--For Update Promotions Data
		DECLARE @UpdateColumns NVARCHAR (MAX);

		IF @IsGenerateErrorLog = 1 
		BEGIN
			SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=CASE WHEN ISNULL(P.'+COLUMN_NAME+','''')='''' THEN ZP.'+COLUMN_NAME+' ELSE P.'+COLUMN_NAME+' END'),',')
			--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME='ZnodePromotion'
				AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
				AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsCouponRequired','IsAllowedWithOtherCoupons','IsUnique','ProfileId','PortalId')
				--AND COLUMN_NAME NOT IN ('DiscountAmount','MinimumQuantity','MinimumOrderAmount');
         END
		 ELSE
		 BEGIN 
			SELECT @UpdateColumns=STRING_AGG(('ZP.'+COLUMN_NAME+'=CASE WHEN ISNULL(P.'+COLUMN_NAME+','''')='''' THEN P.'+COLUMN_NAME+' ELSE P.'+COLUMN_NAME+' END'),',')
			--'ZP.'+COLUMN_NAME+'=P.'+COLUMN_NAME
			FROM INFORMATION_SCHEMA.COLUMNS
			WHERE TABLE_NAME='ZnodePromotion'
				AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
				AND COLUMN_NAME NOT IN ('PromoCode','PromotionTypeId','IsUnique','ProfileId')
				-- AND COLUMN_NAME NOT IN ('DiscountAmount','MinimumQuantity','MinimumOrderAmount');
		END

		IF OBJECT_ID('tempdb..#UpdatedPromotions') IS NOT NULL
			DROP TABLE #UpdatedPromotions;

		CREATE TABLE #UpdatedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		SET @Query='
		UPDATE ZP SET '+@UpdateColumns+'
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #UpdatedPromotions (PromotionId, PromoCode, PromotionTypeId)
		FROM ##Promotions P
		INNER JOIN ZnodePromotion ZP ON LTRIM(RTRIM(P.PromoCode)) = ZP.PromoCode
		INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
		'
		EXEC SP_EXECUTESQL @Query;

		--For Insert Promotions Data
		DECLARE @MatchesColumns NVARCHAR (MAX);

		SELECT @MatchesColumns=STRING_AGG(COLUMN_NAME,',') FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME='ZnodePromotion'
			AND COLUMN_NAME IN (SELECT name FROM tempdb.sys.columns WHERE [object_id] = OBJECT_ID(N'tempdb.dbo.##Promotions'))
			AND COLUMN_NAME NOT IN ('ProfileId');

		IF OBJECT_ID('tempdb..#InsertedPromotions') IS NOT NULL
			DROP TABLE #InsertedPromotions;

		CREATE TABLE #InsertedPromotions (PromotionId INT,PromoCode VARCHAR(300),PromotionTypeId INT);

		-- Import New Promotions
		SET @MatchesColumns='
		INSERT INTO ZnodePromotion
			('+@MatchesColumns+',CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			)
		OUTPUT INSERTED.PromotionId, INSERTED.PromoCode, INSERTED.PromotionTypeId
		INTO #InsertedPromotions (PromotionId, PromoCode, PromotionTypeId)
		SELECT DISTINCT P.'+@MatchesColumns+','+CAST(@UserId AS VARCHAR(15))+',GETDATE(),'+CAST(@UserId AS VARCHAR(15))+',GETDATE()
		FROM ##Promotions P
		INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotion WHERE PromoCode = LTRIM(RTRIM(P.PromoCode)))
		'

		EXEC SP_EXECUTESQL @MatchesColumns;

		DECLARE @checkTable TABLE (Code VARCHAR(1000) , valued NVARCHAR(max))

		DECLARE @InsertData int = 1 
		IF @IsGenerateErrorLog = 0  
		BEGIN 
		    
			SET @InsertData= CASE WHEN NOT EXISTS (SELECT TOP 1 1  FROM #UpdatedPromotions)  THEN 1 ELSE 0 END 
 
			INSERT INTO #InsertedPromotions (PromotionId,PromoCode,PromotionTypeId)
			SELECT PromotionId,PromoCode,PromotionTypeId
			FROM #UpdatedPromotions a 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM #InsertedPromotions b WHERE b.PromoCode = a.PromoCode)

			DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )

			DELETE FROM ZnodePromotionCoupon WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions )

			IF @PromotionTypeName IN ('Percent Off X If Y Purchased','Amount Off X If Y Purchased')
			BEGIN
				DELETE FROM ZnodePromotionProduct
					WHERE PromotionId IN (SELECT PromotionId FROM #InsertedPromotions)
						AND (SELECT TOP 1 ProductToDiscount FROM ##Promotions) <> ''
			
				DELETE FROM ZnodePromotionBrand WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 brand FROM ##Promotions ) <> ''

				DELETE FROM ZnodePromotionCategory WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 category FROM ##Promotions ) <> ''

				DELETE FROM ZnodePromotionCatalogs WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 catalog FROM ##Promotions ) <> ''
				DELETE FROM ZnodePromotionShipping WHERE  PromotionId IN (SELECT PromotionId FROM #InsertedPromotions ) 
				AND (SELECT TOP 1 Shipping FROM ##Promotions ) <> ''

				SET @InsertData = 1 
			END

			INSERT INTO @checkTable 
			SELECT 'brand' ,(SELECT TOP 1 brand FROM ##Promotions )
			UNION ALL 
			SELECT 'catalog' ,(SELECT TOP 1 catalog FROM ##Promotions )
			UNION ALL 
			SELECT 'category' ,(SELECT TOP 1 category FROM ##Promotions )
			UNION ALL 
			SELECT 'Shipping' ,(SELECT TOP 1 Shipping FROM ##Promotions )
			UNION ALL
			SELECT 'ProductToDiscount' ,(SELECT TOP 1 ProductToDiscount FROM ##Promotions )
			UNION ALL
			SELECT 'RequiredProduct' ,(SELECT TOP 1 RequiredProduct FROM ##Promotions )
		END 
		
		--SELECT 1 
		-- Insert for ZnodePromotionProfileMapper
		--SET @Query='
		--INSERT INTO ZnodePromotionProfileMapper
		--	(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--SELECT DISTINCT IPs.PromotionId, CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN IIF(p.Profile=0,NULL,p.Profile) ELSE    P.Profileid END ,'+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		--FROM #InsertedPromotions IPs 
		--INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		--WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper WHERE Promotionid = IPs.PromotionId AND ISNULL(Profileid,0)=CASE WHEN ISNULL(p.Profile,'''') <> '''' THEN p.Profile ELSE    P.Profileid END )  
		--'
		--PRINT @Query 
		--EXEC SP_EXECUTESQL @Query;

		SET @Query='
		INSERT INTO ZnodePromotionProfileMapper
			(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
				WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0))
		'
		EXEC SP_EXECUTESQL @Query;

		IF @IsGenerateErrorLog = 1
		BEGIN 
			-- Update for ZnodePromotionProfileMapper
			SET @Query='
			DELETE FROM ZnodePromotionProfileMapper WHERE PromotionId IN (SELECT PromotionId FROM #UpdatedPromotions) AND ProfileId IS NULL

			DELETE PPM
			FROM ZnodePromotionProfileMapper PPM
			INNER JOIN #UpdatedPromotions IPs ON PPM.Promotionid = IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode AND P.ProfileId IS NULL

			INSERT INTO ZnodePromotionProfileMapper
				(PromotionId,ProfileId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, P.ProfileId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProfileMapper
					WHERE Promotionid = IPs.PromotionId AND ISNULL(ProfileId,0)=ISNULL(P.ProfileId,0)) AND ISNULL(P.Profile,'''')<>''''
			'
			EXEC SP_EXECUTESQL @Query;
		END

		-- Insert for ZnodePromotionCoupon
		SET @Query='
		INSERT INTO ZnodePromotionCoupon
			(PromotionId,Code,InitialQuantity,AvailableQuantity,IsActive,IsCustomCoupon,CustomCouponCode,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT IPs.PromotionId, P.Code, P.InitialQuantity, P.AvailableQuantity, 1, 0, '''', '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
		FROM #InsertedPromotions IPs 
		INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
				INNER JOIN #DuplicatePromotionsData DP ON LTRIM(RTRIM(P.PromoCode)) = DP.PromoCode AND DP.Rn=1 AND P.RowId=DP.RowId
			' ELSE '' END +'
		WHERE ISNULL(P.IsCouponRequired,'''') IN (''True'',''1'',''Yes'')
			AND NOT EXISTS (SELECT * FROM ZnodePromotionCoupon WHERE Code = P.Code)
		'
		EXEC SP_EXECUTESQL @Query;
	
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand' AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Brand') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, BD.BrandId, BD.BrandCode, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON (' +CASE WHEN @IsGenerateErrorLog = 1 THEN ' P.Brand=BD.BrandCode ' ELSE ' BD.BrandId IN (  '+(SELECT TOP 1 Brand FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(BD.BrandId,0)<>0   '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END 
			
			EXEC SP_EXECUTESQL @Query; 
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Brand' AND @IsGenerateErrorLog = 1 )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionBrand (PromotionId,BrandId,BrandCode,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, BD.BrandId, BD.BrandCode, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeBrandDetails BD ON P.Brand=BD.BrandCode
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionBrand	WHERE Promotionid = IPs.PromotionId AND BrandId=BD.BrandId)
			'
			EXEC SP_EXECUTESQL @Query; 
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'Catalog') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PbC.PimCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
		   '+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
			INNER JOIN ZnodePimCatalog PC     ON  (  P.Catalog=PC.CatalogCode  ) 
			' ELSE '' END +'
			INNER JOIN ZnodePimcatalog PbC  ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCatalogId=PbC.PimCatalogId ' ELSE ' PbC.PimCatalogId IN (  '+(SELECT TOP 1 Catalog FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PbC.PimCatalogId,0)<>0
			'+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END 

			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Catalog' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCatalogs (PromotionId,PublishCatalogId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PC.PimCatalogId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCatalog PC ON (P.Catalog=PC.CatalogCode) 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionCatalogs WHERE Promotionid = IPs.PromotionId AND PublishCatalogId=PC.PimCatalogId)
			'
			EXEC SP_EXECUTESQL @Query;
		END
		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category' AND @IsGenerateErrorLog = 1) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Category') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT  DISTINCT IPs.PromotionId, PbC.PimCategoryHierarchyId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN +'
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL  ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId 
			' ELSE '' END +'
			INNER JOIN ZnodePimCategoryHierarchy PbC ON  (' + CASE WHEN @IsGenerateErrorLog = 1 THEN ' PC.PimCategoryId=PbC.PimCategoryId ' ELSE ' PbC.PimCategoryHierarchyId IN (  '+(SELECT TOP 1 Category FROM ##Promotions )+') ' END +' )
			WHERE ISNULL(PbC.PimCategoryId,0)<>0 '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END +'
			GROUP BY IPs.PromotionId,PbC.PimCategoryHierarchyId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Category' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionCategory (PromotionId,PublishCategoryId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PbC.PimCategoryHierarchyId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimCategoryAttributeValueLocale PCAVL  ON P.Category=PCAVL.CategoryValue
			INNER JOIN ZnodePimCategoryAttributeValue PCAV ON PCAVL.PimCategoryAttributeValueId=PCAV.PimCategoryAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PCAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''CategoryCode''
			INNER JOIN ZnodePimCategory PC ON PCAV.PimCategoryId=PC.PimCategoryId 
			INNER JOIN ZnodePimCategoryHierarchy PbC ON PC.PimCategoryId=PbC.PimCategoryId
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionCategory WHERE Promotionid = IPs.PromotionId AND PublishCategoryId=PbC.PimCategoryHierarchyId)
			GROUP BY IPs.PromotionId,PbC.PimCategoryHierarchyId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping' AND @IsGenerateErrorLog = 1 ) OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1 valued FROM @checkTable WHERE code = 'Shipping') <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   P.Shipping=SP.ShippingCode ' ELSE ' sp.shippingId  IN (  '+(SELECT TOP 1 Shipping FROM ##Promotions )+') ' END +' ) 
			
			WHERE ISNULL(SP.ShippingId,0)<>0 
			'+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='Shipping' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionShipping (PromotionId,ShippingId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, SP.ShippingId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodeShipping SP ON P.Shipping=SP.ShippingCode 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionShipping WHERE Promotionid = IPs.PromotionId AND ShippingId=SP.ShippingId)
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount' AND @IsGenerateErrorLog = 1  )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'ProductToDiscount')  <> '' )
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PP.PimProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #InsertedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1 THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.ProductToDiscount))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END + '
			INNER JOIN ZnodePimProduct PP  ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PimProductId  IN (  '+(SELECT TOP 1 ProductToDiscount FROM ##Promotions )+') ' END +' )  
			WHERE ISNULL(PP.PimProductId,0)<>0 '+CASE WHEN @IsGenerateErrorLog = 0 AND @InsertData = 0 THEN ' AND 1=0 ' ELSE '' END +'
			GROUP BY IPs.PromotionId,PP.PimProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='ProductToDiscount' AND @IsGenerateErrorLog = 1)
		BEGIN
			SET @Query='
			INSERT INTO ZnodePromotionProduct (PromotionId,PublishProductId,CreatedBy,CreatedDate,ModifedBy,ModifiedDate)
			SELECT DISTINCT IPs.PromotionId, PP.PimProductId, '+@UserId1+', '''+@GetDate1+''', '+@UserId1+', '''+@GetDate1+'''
			FROM #UpdatedPromotions IPs 
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.ProductToDiscount))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			INNER JOIN ZnodePimProduct PP  ON PAV.PimProductId=PP.PimProductId 
			WHERE NOT EXISTS (SELECT * FROM ZnodePromotionProduct WHERE Promotionid = IPs.PromotionId AND PublishProductId=PP.PimProductId)
			GROUP BY IPs.PromotionId,PP.PimProductId
			'
			EXEC SP_EXECUTESQL @Query;
		END

		IF EXISTS (SELECT * FROM Tempdb.Sys.Columns WHERE OBJECT_ID = OBJECT_ID('tempdb..##Promotions') AND name='RequiredProduct'  AND @IsGenerateErrorLog = 1 )  OR (@IsGenerateErrorLog = 0 AND (SELECT TOP 1  valued FROM @checkTable WHERE code = 'RequiredProduct')<> '' )
		BEGIN
			SET @Query='
			UPDATE ZP
			SET ZP.PromotionProductQuantity=P.PromotionProductQuantity, ZP.ReferralPublishProductId=PP.PimProductId, ModifiedDate='''+@GetDate1+'''
			FROM ZnodePromotion ZP
			INNER JOIN #InsertedPromotions IPs ON ZP.PromotionId=IPs.PromotionId
			INNER JOIN ##Promotions P ON IPs.PromoCode=P.PromoCode
			'+ CASE WHEN @IsGenerateErrorLog = 1  THEN '
			INNER JOIN ZnodePimAttributeValueLocale PAVL ON LTRIM(RTRIM(P.RequiredProduct))=PAVL.AttributeValue
			INNER JOIN ZnodePimAttributeValue PAV ON PAVL.PimAttributeValueId=PAV.PimAttributeValueId
			INNER JOIN ZnodePimAttribute PA ON PAV.PimAttributeId=PA.PimAttributeId AND PA.AttributeCode=''SKU''
			' ELSE '' END +'
			INNER JOIN ZnodePimProduct PP ON   (' + CASE WHEN @IsGenerateErrorLog = 1 THEN '   PAV.PimProductId=PP.PimProductId ' ELSE ' PP.PimProductId  IN (  '+(SELECT TOP 1 RequiredProduct FROM ##Promotions )+') ' END +' )  
			'
			EXEC SP_EXECUTESQL @Query;
		END

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DROP TABLE IF EXISTS ##Promotions;

		COMMIT TRAN Promotions;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Promotions

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPromotions
					@TableName = '+CAST(@TableName AS VARCHAR(MAX)) +',
					@Status='+ CAST(@Status AS VARCHAR(10))+',
					@UserId = '+CAST(@UserId AS VARCHAR(50))+',
					@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',
					@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',
					@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
					@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(MAX))+',
					@PromotionTypeId='+CAST(@PromotionTypeId AS VARCHAR(20))+',
					@IsGenerateErrorLog='+CAST(@IsGenerateErrorLog AS VARCHAR(10));

		IF @IsGenerateErrorLog = 1
		BEGIN
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
			UPDATE ZnodeImportProcessLog 
			SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , 
				SuccessRecordCount = 0,
				TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
			WHERE ImportProcessLogId = @ImportProcessLogId;
		END

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPromotions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchTriggerItemRuleForEdit')
	DROP PROC Znode_GetSearchTriggerItemRuleForEdit

GO

CREATE PROCEDURE [dbo].[Znode_GetSearchTriggerItemRuleForEdit]
(
	@SearchCatalogRuleId  Int
)
AS
/*
	exec [Znode_GetSearchTriggerItemRuleForEdit] @SearchCatalogRuleId = 6
*/
BEGIN
	
	SET NOCOUNT ON;

	BEGIN TRY
		----Getting Search Catalog Rule Data
		SELECT ZSCR.SearchCatalogRuleId, ZSCR.PublishCatalogId,PC.CatalogName,	ZSCR.RuleName,	ZSCR.StartDate,	ZSCR.EndDate, ZSCR.IsTriggerForAll, ZSCR.IsItemForAll,	ZSCR.IsGlobalRule, ZSCR.IsPause
		FROM ZnodeSearchCatalogRule ZSCR
		INNER JOIN ZnodePimCatalog PC on ZSCR.PublishCatalogId = PC.PimCatalogId 
		WHERE SearchCatalogRuleId = @SearchCatalogRuleId 

		----Getting Search Trigger Rule Data
		SELECT ZSTR.SearchTriggerRuleId, ZSTR.SearchCatalogRuleId, ZSTR.SearchTriggerKeyword, ZSTR.SearchTriggerCondition, ZSTR.SearchTriggerValue 
		FROM ZnodeSearchTriggerRule ZSTR 
		WHERE ZSTR.SearchCatalogRuleId = @SearchCatalogRuleId 

		----Getting Search Item Rule Data
		SELECT ZSIR.SearchItemRuleId, ZSIR.SearchCatalogRuleId, ZSIR.SearchItemKeyword, ZSIR.SearchItemCondition, ZSIR.SearchItemValue, ZSIR.SearchItemBoostValue
		FROM ZnodeSearchItemRule ZSIR
		WHERE ZSIR.SearchCatalogRuleId = @SearchCatalogRuleId 

	 END TRY
         BEGIN CATCH
              DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
			         @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
					 @ErrorLine VARCHAR(100)= ERROR_LINE(), 
					 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCategoryHierarchy @SearchCatalogRuleId = '+CAST(@SearchCatalogRuleId AS VARCHAR(50));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		   
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetCategoryHierarchy',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportBrands')
	DROP PROC Znode_ImportBrands

GO

CREATE PROCEDURE [dbo].[Znode_ImportBrands](
	  @TableName			NVARCHAR(100), 
	  @Status				BIT OUT, 
	  @UserId				INT, 
	  @ImportProcessLogId	INT, 
	  @NewGUId				NVARCHAR(200),
	  @LocaleId	            INT= 1,
	  @CsvColumnString		NVARCHAR(max)
	  )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Made a provision to import Brand details.
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Brands;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		IF isnull(@LocaleId,0)=0
		BEGIN
			SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		END
		-- Retrive RoundOff Value from global setting 

		Create TABLE #InsertBrandData 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, BrandCode varchar(max),IsActive varchar(max), BrandDescription varchar(max) default null,
			SEOKeyword varchar(max) default null,SEODescription varchar(max) default null, BrandLogo varchar(max) default null,SEOTitle varchar(max) default null,
			SEOFriendlyPageName varchar(max) default null,URLKey varchar(max) default null, Custom1 varchar(max) default null,Custom2 varchar(max) default null,
			Custom3 varchar(max) default null,Custom4 varchar(max) default null,Custom5 varchar(max) default null, GUID nvarchar(400)
		);	
			
		SET @SSQL = 'INSERT INTO #InsertBrandData( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;		
		EXEC sys.sp_sqlexec @SSQL;

		UPDATE #InsertBrandData SET IsActive=CASE IsActive WHEN 'Yes' THEN 1 
										WHEN 'No' THEN 0 END;
		
		SELECT BrandCode 
		INTO #DuplicateBrandData 
		FROM #InsertBrandData 
		Group BY BrandCode  having count(*) > 1
		
		-- Start Functional Validation 
		-----------------------------------------------
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE exists(SELECT * FROM #DuplicateBrandData bd where bd.BrandCode=ii.BrandCode)
			   And not exists(select * from  ZnodeBrandDetails zbd 
							  INNER JOIN #DuplicateBrandData bd on bd.BrandCode=zbd.BrandCode) 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE isnull(BrandCode,'')=''			   
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '121', 'BrandCode', BrandCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE  not exists 
				   (
						select * from ZnodePimAttributeDefaultValue zpadv
						inner join ZnodePimAttribute zpa on zpa.PimAttributeId=zpadv.PimAttributeId
						where AttributeCode='Brand' and AttributeDefaultValueCode=ii.BrandCode
				   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '8', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'')=''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE isnull(ii.IsActive,'') not in ('True','1','Yes','FALSE','0','No')
			
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEOKeyword', SEOKeyword, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			  WHERE len(ltrim(rtrim(ii.SEOKeyword))) > 300 and isnull(ii.SEOKeyword,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '82', 'SEODescription', SEODescription, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEODescription))) > 300 and isnull(ii.SEODescription,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii			 
			   WHERE isnull(BrandLogo,'')<>'' AND reverse(left(reverse(ii.BrandLogo),charindex('.',reverse(ii.BrandLogo)))) 
			   not in (select ValidationName from View_FamilyExtensions where FamilyCode='Image')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '45', 'BrandLogo', BrandLogo, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii			 
			   WHERE isnull(BrandLogo,'')<>'' and not exists (select * from ZnodeMedia where FileName=ii.BrandLogo)

  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '81', 'SEOTitle', SEOTitle, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertBrandData AS ii
			   WHERE len(ltrim(rtrim(ii.SEOTitle))) > 200 and isnull(ii.SEOTitle,'')<>''		
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '102', 'SEOFriendlyPageName', SEOFriendlyPageName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE (isnull(ii.SEOFriendlyPageName,'') LIKE '%[^a-zA-Z0-9]%' and  isnull(ii.SEOFriendlyPageName,'') NOT LIKE '%[_-]%' )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '81', 'URLKey', URLKey, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertBrandData AS ii  
			WHERE len(ltrim(rtrim(ii.URLKey))) > 200 and isnull(ii.URLKey,'')<>''			


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Brand - ' + ISNULL(BrandCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertBrandData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertBrandData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertBrandData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--<Begin Data Updation>
		CREATE TABLE #InsertedBrands (BrandId INT,BrandCode nvarchar(100),CMSSEODetailId int ) 
		
		UPDATE zbd set WebsiteLink=isnull(ibd.URLKey,WebsiteLink),IsActive=isnull(ibd.IsActive,zbd.IsActive),ModifiedBy=@UserId,
					   ModifiedDate=Getdate(),Custom1=isnull(ibd.Custom1,zbd.custom1),Custom2=isnull(ibd.Custom2,zbd.custom2),Custom3=isnull(ibd.Custom3,zbd.custom3),Custom4=isnull(ibd.Custom4,zbd.custom4),
					   Custom5=ISNULL(ibd.Custom5, zbd.Custom5)      
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode)
		from ZnodeBrandDetails zbd
		inner join #InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		where ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zbd.BrandCode)

		UPDATE zbdl set zbdl.BrandId=zbd.BrandId,zbdl.Description=isnull(ibd.BrandDescription,zbdl.Description),SEOFriendlyPageName=isnull(IBD.SEOFriendlyPageName,zbdl.SEOFriendlyPageName),
		LocaleId=@LocaleId,ModifiedBy=@UserId,ModifiedDate=getdate(),BrandName=isnull(ibd.BrandCode,zbdl.BrandName)
		FROM ZnodeBrandDetailLocale zbdl
		inner join ZnodeBrandDetails zbd on zbd.BrandId=zbdl.BrandId
		inner join #InsertBrandData IBD on ibd.BrandCode=zbd.BrandCode
		inner join #InsertedBrands ib on ib.BrandId=zbdl.BrandId
		where ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zbd.BrandCode)

		UPDATE ZCD set SEOId=ib.BrandId,SEOUrl=isnull(ibd.SEOFriendlyPageName,zcd.SEOUrl),ModifiedBy=@UserId,ModifiedDate=getdate(),
					   SEOCode=isnull(ibd.BrandCode,zcd.SEOCode)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId) 
		FROM ZnodeCMSSEODetail ZCD		
		inner join #InsertedBrands ib on ib.BrandId=ZCD.SEOId
		inner join #InsertBrandData IBD on ibd.BrandCode=zcd.SEOCode
		where exists (select null from ZnodeBrandDetailLocale zbdl where zbdl.BrandId=ZCD.SEOId)
		and ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a where a.BrandCode=zcd.SEOCode)
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>
		
		UPDATE zcdl set CMSSEODetailId =isnull(ib.CMSSEODetailId,zcdl.CMSSEODetailId),LocaleId=@LocaleId,SEOTitle=isnull(ibd.SEOTitle,zcdl.SEOTitle),
						SEODescription=isnull(ibd.SEODescription,zcdl.SEODescription),SEOKeywords=isnull(ibd.SEOKeyword,zcdl.SEOKeywords),ModifiedBy=@UserId,ModifiedDate=getdate()
		FROM ZnodeCMSSEODetailLocale zcdl
		inner join #InsertedBrands ib on ib.CMSSEODetailId=zcdl.CMSSEODetailId
		inner join #InsertBrandData IBD on ibd.BrandCode=ib.BrandCode
		and ibd.RowNumber=(select max(RowNumber) from #InsertBrandData a 
		inner join ZnodeBrandDetails zcd on  a.BrandCode=zcd.BrandCode)

		--</End Data Updation>

		--<Begin Data Insert>
		insert into ZnodeBrandDetails(BrandCode,MediaId,WebsiteLink,DisplayOrder,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Custom1,Custom2,Custom3,
										Custom4,Custom5)
		OUTPUT INSERTED.BrandId ,INSERTED.BrandCode INTO  #InsertedBrands (BrandId, BrandCode) 		
		Select ibd.BrandCode,(select top 1 MediaId from ZnodeMedia where FileName=ibd.BrandLogo order by CreatedDate desc),ibd.URLKey,0,ibd.IsActive,@UserId,GETDATE(),@UserId,Getdate(),ibd.Custom1,ibd.Custom2,ibd.Custom3,ibd.Custom4,ibd.Custom5
		from #InsertBrandData IBD	
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetails ZBD WHERE ZBD.BrandCode = IBD.BrandCode )		

		insert into ZnodeBrandDetailLocale (BrandId,Description,SEOFriendlyPageName,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,BrandName)
		select ac.BrandId,ibdl.BrandDescription,ibdl.SEOFriendlyPageName,@LocaleId,@UserId,getdate(),@UserId,GETDATE(),ibdl.BrandCode 
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeBrandDetailLocale a 
							INNER JOIN ZnodeBrandDetails b on  b.BrandCode=ibdl.BrandCode AND a.BrandId=b.BrandId )	

		insert into ZnodeCMSSEODetail (CMSSEOTypeId,SEOId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SEOCode,PublishStateId)
		OUTPUT INSERTED.SEOId ,INSERTED.SEOCode, INSERTED.CMSSEODetailId INTO  #InsertedBrands (BrandId, BrandCode,CMSSEODetailId)
		select (select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand'),ac.BrandId,ibdl.SEOFriendlyPageName,@UserId,getdate(),@UserId,getdate(),ibdl.BrandCode,'2'
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetail a 
							INNER JOIN ZnodeBrandDetails b on b.BrandCode=ibdl.BrandCode 
							where a.SEOCode=ibdl.BrandCode
							AND a.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )
		
		--<Delete Records Having Null Value>
		Delete from #InsertedBrands where isnull(CMSSEODetailId,0)=0
		--</Delete Records Having Null Value>

		insert into ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		select ac.CMSSEODetailId ,@LocaleId,ibdl.SEOTitle,ibdl.SEODescription,ibdl.SEOKeyword,@UserId,GETDATE(),@UserId,Getdate()
		from #InsertBrandData IBDL
		INNER JOIN #InsertedBrands ac on ac.BrandCode=ibdl.BrandCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeCMSSEODetailLocale a 
							INNER JOIN ZnodeCMSSEODetail b on a.CMSSEODetailId=b.CMSSEODetailId and b.SEOCode=ibdl.BrandCode
							INNER JOIN ZnodeBrandDetails c on c.BrandCode=ibdl.BrandCode 
							AND b.CMSSEOTypeId=(select CMSSEOTypeId  from ZnodeCMSSEOType where Name = 'Brand')  )		
        --<End Data Insert>

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Brands;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Brands

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportBrands @TableName = '+CAST(@TableName AS VARCHAR(max)) +',
		 @Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(200))+',
		 @CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportBrands',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF NOT EXISTS(SELECT * FROM SYS.TABLES WHERE NAME = 'ZnodePublishProductEntityLog')
BEGIN
	CREATE TABLE [dbo].[ZnodePublishProductEntityLog] (
    [PublishProductEntityId]        INT            NOT NULL,
    [VersionId]                     INT            NOT NULL,
    [IndexId]                       NVARCHAR (300) NOT NULL,
    [ZnodeProductId]                INT            NOT NULL,
    [ZnodeCatalogId]                INT            NOT NULL,
    [SKU]                           NVARCHAR (300) NOT NULL,
    [LocaleId]                      INT            NOT NULL,
    [Name]                          NVARCHAR (600) NOT NULL,
    [ZnodeCategoryIds]              INT            NOT NULL,
    [IsActive]                      BIT            NOT NULL,
    [Attributes]                    NVARCHAR (MAX) NOT NULL,
    [Brands]                        NVARCHAR (MAX) NOT NULL,
    [CategoryName]                  VARCHAR (300)  NOT NULL,
    [CatalogName]                   VARCHAR (300)  NOT NULL,
    [DisplayOrder]                  INT            NOT NULL,
    [RevisionType]                  VARCHAR (50)   NOT NULL,
    [AssociatedProductDisplayOrder] INT            NOT NULL,
    [ProductIndex]                  INT            NOT NULL,
    [SalesPrice]                    VARCHAR (50)   NULL,
    [RetailPrice]                   VARCHAR (50)   NULL,
    [CultureCode]                   VARCHAR (50)   NULL,
    [CurrencySuffix]                VARCHAR (50)   NULL,
    [CurrencyCode]                  VARCHAR (50)   NULL,
    [SeoDescription]                VARCHAR (1000) NULL,
    [SeoKeywords]                   VARCHAR (1000) NULL,
    [SeoTitle]                      VARCHAR (1000) NULL,
    [SeoUrl]                        VARCHAR (1000) NULL,
    [ImageSmallPath]                VARCHAR (500)  NOT NULL,
    [SKULower]                      NVARCHAR (300) NULL,
    [ElasticSearchEvent]            INT            NULL,
    [ZnodeParentCategoryIds]        VARCHAR (1000) NULL,
    [ModifiedDate]                  DATETIME       NULL,
    [IsSingleProductPublish]        BIT            NULL,
    [IsCacheClear]                  BIT            NULL
);

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeletePublishCatalogEntity')
	DROP PROC Znode_DeletePublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_DeletePublishCatalogEntity]
(
    @PublishCatalogId  INT = 0 
   ,@UserId int = 0
   ,@IsRevertPublish bit = 0 
   ,@NewGUID nvarchar(500) 

)
AS
/*
	To Remove all publish catalog details from related entities
	Unit Testing : 
	Declare @Status bit 
	Exec [dbo].[ZnodePublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 
*/
BEGIN
SET NOCOUNT ON
BEGIN TRY 
		DECLARE @Status BIT = 0 

		IF @IsRevertPublish = 0 AND @PublishCatalogId > 0 
		BEGIN 
		 

		 DELETE FROM ZnodePublishProductEntity WHERE ElasticSearchEvent = 2 AND ZnodeCatalogId = @PublishCatalogId
		  
		 UPDATE ZnodePublishProductEntity 
		 SET ElasticSearchEvent = 0 
		 WHERE ZnodeCatalogId = @PublishCatalogId
		 		
		 UPDATE  a
		 SET IsCatalogPublished = 1, IsCategoryPublished = 1 , IsProductPublished = 1
			, PublishStateId = b.PublishStateId, a.ModifiedDate = GETDATE()
		 FROM ZnodePublishCatalogLog a 
		 INNER JOIN ZnodePublishState b ON (b.PublishStateCode = a.Token )
		 WHERE a.PublishStateId = 6 AND a.PublishType = 'Catalog'
		 AND a.PimCatalogId =@PublishCatalogId
			
		UPDATE ZnodePublishProgressNotifierEntity SET 
            ProgressMark =100, 
            IsCompleted  = 1,
            IsFailed =0
        WHERE  JobId = @NewGUID
		END 
		ELSE 
		BEGIN 

		UPDATE a
		SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
		, CategoryName = b.CategoryName, a.ElasticSearchEvent = 0 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower,a.Attributes = b.Attributes
		FROM ZnodePublishProductEntity a 
		INNER JOIN ZnodePublishProductEntityLog b ON (b.PublishProductEntityId = a.PublishProductEntityId)

			   
		 UPDATE  a
		 SET IsCatalogPublished = 0, IsCategoryPublished = 0 , IsProductPublished = 0
			, PublishStateId = b.PublishStateId, a.ModifiedDate = GETDATE()
		 FROM ZnodePublishCatalogLog a 
		 INNER JOIN ZnodePublishState b ON (b.PublishStateCode = 'PUBLISH_FAILED' )
		 WHERE a.PublishStateId = 6 AND a.PublishType = 'Catalog'
		-- AND a.PimCatalogId =@PublishCatalogId

		INSERT INTO ZnodeProceduresErrorLog (ProcedureName,ErrorInProcedure,ErrorMessage,ErrorLine,ErrorCall,CreatedBy,CreatedDate)
		SELECT 'Publish Catalog','Elastic Fail', ' Publish Failed due to Elastic data update failure or connection issue'
			   ,0, 'Publish', 2, GETDATE()

		UPDATE ZnodePublishProgressNotifierEntity SET 
            ProgressMark =80, 
            IsCompleted  = 0,
            IsFailed =1 
        WHERE  JobId = @NewGUID

		-- TRUNCATE TABLE ZnodePublishProductEntityLog
		END 
		SET @Status = 1 

		DELETE FROM ZnodePublishProgressNotifierEntity WHERE ProgressMark = 100 OR IsCompleted = 1 OR IsFailed = 1 
		SELECT @PublishCatalogId AS id,@Status AS Status;   
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeletePublishCatalogEntity 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@IsRevertPublish='+CAST(@IsRevertPublish AS VARCHAR(10))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_DeletePublishCatalogEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO



CREATE   PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity,RequiredType
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


-- SELECT * FROM ZnodePimAddOnProduct
INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 



SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 


DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId  AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)



SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 

TRUNCATE TABLE ZnodePublishProductEntityLog

DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


 DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

INSERT INTO ZnodePublishProductEntityLog
SELECT *
FROM ZnodePublishProductEntity ty with(nolock) 
WHERE EXISTS (SELECT TOP 1 1 FROM #insertedPublishEntity tu WHERE tu.PublishProductEntityId = ty.PublishProductEntityId AND tu.PublishProductEntityId <> 0 )  

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,a.LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = a.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
INNER JOIN @Versions_working h ON (h.LocaleId = a.LocaleId) 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues
, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n 
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId AND n.LocaleId = q.LocaleId),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,0) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 
 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity.VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,IIF(RequiredType='requierd',1,0) IsRequired, RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END 


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleCategoryEntity')
	DROP PROC Znode_PublishSingleCategoryEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleCategoryEntity]
(
    @PimCategoryId  int 
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAssociate int  = 0 OUT
   ,@PimCatalogId int = 0
)
AS
/*
	To publish single category 
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@DefaultLocaleId int = dbo.fn_getdefaultLocaleId()
	SET @Status = 1 
	Declare @IsPreviewEnable int 
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionType = 'Production' OR  @RevisionType = 'None'

		
    SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId ) 
WHERE  a.IsCategory =1



SELECT DISTINCT yu.VersionId,yu.LocaleId, yu.CatalogName, yu.ZnodeCatalogId, a.PimCategoryId ,RT.ParentPimCategoryHierarchyId, rt.DisplayOrder, rt.PimCategoryHierarchyId
, c.AttributeCode,b.CategoryValue AttributeValues,rt.ActivationDate, rt.ExpirationDate
		,RT.IsActive, a.PimCategoryAttributeValueId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  ZnodePimCategoryHierarchy  rt with(nolock) ON ( rt.PimCategoryId = a.PimCategoryId  )
INNER JOIN  ZnodePublishCatalogEntity yu with(nolock) ON (yu.ZnodeCatalogId = rt.PimCatalogId)
WHERE rt.PimCategoryId =@PimCategoryId
AND yu.RevisionType IN (SELECT t.RevisionState FROM @Tbl_versions t)


IF EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    UPDATE a 
	SET AttributeValues = b.CategoryValue
	FROM #Temp_Categoryvalue a 
	INNER JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = a.LocaleId)
	WHERE a.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY ZnodePublishCatalogEntity t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 




SELECT DISTINCT PimCategoryHierarchyId,LocaleId,ZnodeCatalogId, CatalogName,PimCategoryId,ParentPimCategoryHierarchyId,DisplayOrder,VersionId, CategoryName, CategoryCode ,ActivationDate, ExpirationDate,IsActive
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 
PIVOT 
(
Max(AttributeValues) FOR AttributeCode IN (CategoryName, CategoryCode )
) Piv

-- SELECT * FROM #Temp_categoryDetails

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId = r.LocaleId AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId = t.PimCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.VersionId = a.VersionId)

INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT a.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId  = a.PimCategoryId  )+']' 
	,a.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = a.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )

DELETE t FROM ZnodePublishSeoEntity t WHERE EXISTS (SELECT TOP 1 1 FROM #Temp_categoryDetails yu WHERE yu.CategoryCode  = t.SEOCode 
AND t.CMSSEOTypeId = 2 
)

INSERT INTO ZnodePublishSeoEntity(VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,ElasticSearchEvent) 

SELECT VersionId,GETDATE(),a.SEOCode,a.CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,'Category' SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,1 ElasticSearchEvent
FROM ZnodeCMSSEODetail a 
INNER JOIN ZnodeCMSSEODetailLocale b ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN #Temp_categoryDetails c ON (c.CategoryCode = a.SEOCode )
WHERE a.CMSSEOTypeId =2 

     
	SELECT PimCategoryHierarchyId PublishCategoryId ,
			ZnodeCatalogId  PublishCatalogId  ,
           ''   CategoryXml       ,
              LocaleId          ,
			  VersionId		     FROM  #Temp_categoryDetails y 

	SELECT PortalId, y.ZnodeCatalogId PublishCatalogId, y.PimCategoryHierarchyId PublishCategoryId, y.CategoryCode, yu.SEOUrl,y. VersionId,y.LocaleId FROM ZnodePublishSeoEntity yu 
	INNER JOIN #Temp_categoryDetails y ON ( y.VersionId = yu.VersionId
	AND y.CategoryCode = yu.SEOCode)  
	
	SELECT 0 AS id,@Status AS Status;   


	UPDATE ZnodePimCategory 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PimCategoryId =@PimCategoryId

END TRY 
BEGIN CATCH 
	SET @Status =0  
	
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	-- Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleCategoryEntity
		@PimCategoryId = '+CAST(@PimCategoryId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleCategoryErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleCategoryEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleCategoryEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE   PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity,RequiredType
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


-- SELECT * FROM ZnodePimAddOnProduct
INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 



SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 


UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId  AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)



SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 

TRUNCATE TABLE ZnodePublishProductEntityLog

DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


 DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

INSERT INTO ZnodePublishProductEntityLog
SELECT *
FROM ZnodePublishProductEntity ty with(nolock) 
WHERE PublishProductEntityId <> 0  

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,a.LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = a.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
INNER JOIN @Versions_working h ON (h.LocaleId = a.LocaleId) 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues
, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n 
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId AND n.LocaleId = q.LocaleId),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId)
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault,q.LocaleId

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
		
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,0) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 
 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity.VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,IIF(RequiredType='requierd',1,0) IsRequired, RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	
	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleCategoryEntity')
	DROP PROC Znode_PublishSingleCategoryEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleCategoryEntity]
(
    @PimCategoryId  int 
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAssociate int  = 0 OUT
   ,@PimCatalogId int = 0
)
AS
/*
	To publish single category 
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@DefaultLocaleId int = dbo.fn_getdefaultLocaleId()
	SET @Status = 1 
	Declare @IsPreviewEnable int 
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionType = 'Production' OR  @RevisionType = 'None'

		
    SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId ) 
WHERE  a.IsCategory =1



SELECT DISTINCT yu.VersionId,yu.LocaleId, yu.CatalogName, yu.ZnodeCatalogId, a.PimCategoryId ,RT.ParentPimCategoryHierarchyId, rt.DisplayOrder, rt.PimCategoryHierarchyId
, c.AttributeCode,b.CategoryValue AttributeValues,rt.ActivationDate, rt.ExpirationDate
		,RT.IsActive, a.PimCategoryAttributeValueId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  ZnodePimCategoryHierarchy  rt with(nolock) ON ( rt.PimCategoryId = a.PimCategoryId  )
INNER JOIN  ZnodePublishCatalogEntity yu with(nolock) ON (yu.ZnodeCatalogId = rt.PimCatalogId)

WHERE rt.PimCategoryId =@PimCategoryId
AND yu.RevisionType IN (SELECT t.RevisionState FROM @Tbl_versions t)

UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )

IF EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    UPDATE a 
	SET AttributeValues = b.CategoryValue
	FROM #Temp_Categoryvalue a 
	INNER JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = a.LocaleId)
	WHERE a.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY ZnodePublishCatalogEntity t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 




SELECT DISTINCT PimCategoryHierarchyId,LocaleId,ZnodeCatalogId, CatalogName,PimCategoryId
,ParentPimCategoryHierarchyId,DisplayOrder,VersionId,CAST('' AS NVARCHAr(300)) CategoryName,CAST('' AS NVARCHAr(100)) CategoryCode ,ActivationDate, ExpirationDate,IsActive
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


UPDATE #Temp_categoryDetails
SET CategoryName = (SELECT TOP 1 ty.AttributeValues FROM #Temp_Categoryvalue ty 
WHERE ty.PimCategoryHierarchyId =#Temp_categoryDetails.PimCategoryHierarchyId AND ty.LocaleId = #Temp_categoryDetails.LocaleId
AND ty.AttributeCode ='CategoryName')
,CategoryCode = (SELECT TOP 1 ty.AttributeValues FROM #Temp_Categoryvalue ty 
WHERE ty.PimCategoryHierarchyId =#Temp_categoryDetails.PimCategoryHierarchyId AND ty.LocaleId = #Temp_categoryDetails.LocaleId
AND ty.AttributeCode ='CategoryCode')

-- SELECT * FROM #Temp_categoryDetails

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId = r.LocaleId AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId = t.PimCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.VersionId = a.VersionId)

INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT a.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId  = a.PimCategoryId  )+']' 
	,a.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = a.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )

DELETE t FROM ZnodePublishSeoEntity t WHERE EXISTS (SELECT TOP 1 1 FROM #Temp_categoryDetails yu WHERE yu.CategoryCode  = t.SEOCode 
AND t.CMSSEOTypeId = 2 
)

INSERT INTO ZnodePublishSeoEntity(VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,ElasticSearchEvent) 

SELECT VersionId,GETDATE(),a.SEOCode,a.CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,'Category' SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,1 ElasticSearchEvent
FROM ZnodeCMSSEODetail a 
INNER JOIN ZnodeCMSSEODetailLocale b ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN #Temp_categoryDetails c ON (c.CategoryCode = a.SEOCode )
WHERE a.CMSSEOTypeId =2 


     
	SELECT PimCategoryHierarchyId PublishCategoryId ,
			ZnodeCatalogId  PublishCatalogId  ,
           ''   CategoryXml       ,
              LocaleId          ,
			  VersionId		     
    FROM  #Temp_categoryDetails y 

	SELECT PortalId, y.ZnodeCatalogId PublishCatalogId, y.PimCategoryHierarchyId PublishCategoryId, y.CategoryCode, yu.SEOUrl,y. VersionId,y.LocaleId FROM ZnodePublishSeoEntity yu 
	INNER JOIN #Temp_categoryDetails y ON ( y.VersionId = yu.VersionId
	AND y.CategoryCode = yu.SEOCode)  
	
	SELECT 0 AS id,@Status AS Status;   


	UPDATE ZnodePimCategory 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PimCategoryId =@PimCategoryId

END TRY 
BEGIN CATCH 
	SET @Status =0  
	
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	-- Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleCategoryEntity
		@PimCategoryId = '+CAST(@PimCategoryId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleCategoryErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleCategoryEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleCategoryEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventoryPostOrder')
	DROP PROC Znode_UpdateInventoryPostOrder

GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventoryPostOrder]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@OmsOrderId INT,
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
		SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
		, Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
		FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
		AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0;

		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 

		---Updating order line item
		UPDATE TBL SET OrderLineItemId = ZOOLI.OmsOrderLineItemsId, TBL.OrderLineItemRelationshipTypeId = ZOOLI.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		INNER JOIN @TBL_XmlReturnToTable TBL ON ZOOLI.Sku = TBL.SKU
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) WHERE ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId AND ZOOD.OmsOrderId = @OmsOrderId)
		AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL

		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
		SELECT WarehouseId, PortalId, PortalWarehouseId, Precedence
		INTO #PortalWarehouse
		FROM [ZnodePortalWarehouse] WITH (NOLOCK)
		WHERE PortalId = @PortalId
		UNION 
		SELECT WarehouseId, @PortalId AS PortalId, PortalWarehouseId, Precedence
		FROM [dbo].[ZnodePortalAlternateWarehouse] AS zpaw WITH (NOLOCK)
		WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId)  
		
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
		SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
		FROM dbo.ZnodeInventory AS zi WITH (NOLOCK)
		LEFT JOIN #PortalWarehouse AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
		WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
		AND ZPW.WarehouseId IS NOT NULL
		ORDER BY ZPW.Precedence DESC

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and bundle
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI WHERE TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) not in (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name IN ('Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		--Update LineItemId for Group Product
		UPDATE TBXML
		SET TBXML.OrderLineItemId=ZOOLI.ParentOmsOrderLineItemsId
		FROM @TBL_XmlReturnToTable TBXML
		INNER JOIN ZnodeOmsOrderLineItems ZOOLI ON TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
		WHERE TBXML.OrderLineItemRelationshipTypeId IN (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name IN ('Group'));

		---Getting data for group products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId in (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			SELECT WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			FROM @TBL_CalculateQuntity A
			GROUP BY WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		UPDATE b set  b.OrderQuantity = a.OrderQuantity
		FROM cte a
		INNER JOIN @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 

			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		BEGIN 
			UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND ISNULL(UpdatedQuantity,0) < 0
		END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	
		SET @Status = 0;
		SELECT SKU, Quantity, InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishWidgetSliderBannerEntity')
	DROP PROC Znode_SetPublishWidgetSliderBannerEntity

GO

CREATE  PROCEDURE [dbo].[Znode_SetPublishWidgetSliderBannerEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@PreviewVersionId INT = 0 
  ,@IsPreviewEnable int = 0 
  ,@ProductionVersionId INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@CMSContentPagesId int = 0
  ,@CMSSliderId INT = 0 
  ,@UserId int = 0 
  ,@Status int = 0 OUTPUT 
)
AS
/*
    This Procedure is used to publish the slider banner widgets,
	This sp get call for catalog publish , store , and slider 
	  
	EXEC ZnodeSetPublishWidgetSliderBannerEntity 1 2,3
	A. 
		1. Preview - Preview
		2. None    - Production   --- 
		3. Production - Preview/Production
	B.
		select * from ZnodePublishStateApplicationTypeMapping
		select * from ZnodePublishState where PublishStateId in (3,4) 
		select * from ZnodePublishPortalLog 
	C.
		Select * from ZnodePublishState where IsDefaultContentState = 1  and IsContentState = 1  --Production 
    
	Unit testing 
	

Exec [ZnodeSetPublishWidgetSliderBannerEntity]
@PortalId  = 1
,@LocaleId  = 0 
,@PreviewVersionId = 0 
,@ProductionVersionId = 0 
,@RevisionState = 'Preview@Production' 
,@CMSContentPagesId = 88
,@CMSSliderId = 0
,@UserId = 0 
	*/
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
   
   ---Following code is manditory because this sp get call from multiple places
   If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
	Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
		SET @IsPreviewEnable = 1 
	else 
		SET @IsPreviewEnable = 0 

   DECLARE @Tbl_PreviewVersionId    TABLE    (PreviewVersionId int , PortalId int , LocaleId int)
   DECLARE @Tbl_ProductionVersionId TABLE    (ProductionVersionId int  , PortalId int , LocaleId int)

   If @PreviewVersionId = 0 
		Begin
   			Insert into @Tbl_PreviewVersionId 
			SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PREVIEW'
		end
	Else 
			Insert into @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
			where VersionId = @PreviewVersionId
	
	If @ProductionVersionId = 0 
   		Begin
			Insert into @Tbl_ProductionVersionId 
			SELECT distinct VersionId , PortalId , LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PRODUCTION'
		End 
	Else 
		Insert into @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
			where VersionId = @ProductionVersionId
 
   If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
   Begin
		If not exists (Select TOP 1 1 from @Tbl_PreviewVersionId) 
			Begin
				SET @Status =0 ;
				If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
					SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
					Return 0
			End
   End
   If  (@RevisionState like '%Production%' OR @RevisionState = 'None')
   Begin
		If not exists (Select TOP 1 1 from @Tbl_ProductionVersionId) 
		Begin
			SET @Status =0 ;
			If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
				SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
			Return 0 
		End
   End


   Begin 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
	
		--CMSContentPage associated with portal 
		DECLARE @TBL_CMSContentPagesPortalWise TABLE(CMSContentPagesId INT, PortalId int );
		 
		 If @CMSSliderId	 = 0 AND @CMSContentPagesId  > 0 and @PortalId > 0 -- content page  
			INSERT INTO @TBL_CMSContentPagesPortalWise(CMSContentPagesId, PortalId)	SELECT CMSContentPagesId , PortalId FROM ZnodeCMSContentPages
			WHERE PortalId = @PortalId	AND IsActive = 1 AND (CMSContentPagesId = @CMSContentPagesId )
		 Else  If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
			INSERT INTO @TBL_CMSContentPagesPortalWise(CMSContentPagesId , PortalId)	SELECT ZCCP.CMSContentPagesId , ZCCP.PortalId FROM ZnodeCMSContentPages ZCCP
			WHERE ZCCP.IsActive = 1 AND 
			(Exists   (Select TOP 1 1 from @Tbl_ProductionVersionId TPC where TPC.PortalId = ZCCP.PortalId) 
			OR Exists (Select TOP 1 1 from @Tbl_PreviewVersionId TPC where TPC.PortalId = ZCCP.PortalId) )
		 Else If @CMSSliderId	= 0  AND @CMSContentPagesId  = 0 and @PortalId > 0 -- portal publish
			INSERT INTO @TBL_CMSContentPagesPortalWise(CMSContentPagesId,  PortalId )	SELECT CMSContentPagesId ,  PortalId FROM ZnodeCMSContentPages
			WHERE PortalId = @PortalId	AND IsActive = 1 
		

		Declare @CMSWidgetDataFinal TABLE 
		(
			WidgetSliderBannerId	int,MappingId	int,PortalId	int,LocaleId	int,Type	varchar(100),Navigation	varchar(100),
			AutoPlay	bit,AutoplayTimeOut	int,AutoplayHoverPause	bit,TransactionStyle	varchar(100),WidgetsKey	varchar(300),
			TypeOFMapping	varchar(100),SliderId	int,SliderBanners	nvarchar(max)
		)

		    DECLARE @Tlb_ZnodeCMSWidgetSliderBanner TABLE
                     (CMSWidgetSliderBannerId INT,
                      CMSMappingId            INT,
                      PortalId                INT,
                      Type                    NVARCHAR(100) NULL,
                      Navigation              NVARCHAR(100) NULL,
                      AutoPlay                BIT,
                      AutoplayTimeOut         INT,
                      AutoplayHoverPause      BIT,
                      TransactionStyle        NVARCHAR(100) NULL,
                      WidgetsKey              NVARCHAR(256),
                      TypeOFMapping           NVARCHAR(100),
                      CMSSliderId             INT
                     );

                     DECLARE @TBL_ZnodeCMSSliderDetail TABLE
                     (CMSSliderId        INT,
                      CMSSliderBannerId  INT,
                      MediaPath          VARCHAR(300),
                      Title              NVARCHAR(1000),
					  ButtonLabelName    NVARCHAR(1200),
                      ButtonLink         NVARCHAR(600),
                      TextAlignment      NVARCHAR(200),
                      BannerSequence     INT,
                      ActivationDate     DATETIME,
                      ExpirationDate     DATETIME,
                      ImageAlternateText NVARCHAR(1000),
                      DEscription        NVARCHAR(MAX)
                     );

                     DECLARE @TBL_ZnodeCMSSliderDetail_Locale TABLE
                     (CMSSliderId        INT,
                      CMSSliderBannerId  INT,
                      MediaPath          VARCHAR(300),
                      Title              NVARCHAR(1000),
                      ButtonLabelName    NVARCHAR(1200),
                      ButtonLink         NVARCHAR(600),
                      TextAlignment      NVARCHAR(200),
                      BannerSequence     INT,
                      ActivationDate     DATETIME,
                      ExpirationDate     DATETIME,
                      ImageAlternateText NVARCHAR(1000),
                      DEscription        NVARCHAR(MAX),
                      LocaleId           INT
                     );

		If @CMSSliderId	 = 0 AND @CMSContentPagesId  > 0 and @PortalId > 0 -- content page  
		   
			INSERT INTO @Tlb_ZnodeCMSWidgetSliderBanner(CMSWidgetSliderBannerId,CMSMappingId,PortalId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping,CMSSliderId)
			SELECT ACWSB.CMSWidgetSliderBannerId,ACWSB.CMSMappingId,
			@PortalId PortalId,
			ACWSB.Type,ACWSB.Navigation,ACWSB.AutoPlay,ACWSB.AutoplayTimeOut
			,ACWSB.AutoplayHoverPause,ACWSB.TransactionStyle,ACWSB.WidgetsKey,ACWSB.TypeOfMapping
			OFMapping,ACWSB.CMSSliderId FROM ZnodeCMSWidgetSliderBanner AS ACWSB WHERE
			((TypeOfMapping = 'ContentPageMapping' AND CMSMappingId IN
			(SELECT CMSContentPagesId	FROM @TBL_CMSContentPagesPortalWise	) ))
         Else  If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
			INSERT INTO @Tlb_ZnodeCMSWidgetSliderBanner(CMSWidgetSliderBannerId,CMSMappingId,PortalId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping,CMSSliderId)
			SELECT ACWSB.CMSWidgetSliderBannerId,ACWSB.CMSMappingId,
			CASE when TypeOfMapping = 'PortalMapping'  THEN ACWSB.CMSMappingId ELSE 
			(SELECT TOP 1 PortalId	FROM @TBL_CMSContentPagesPortalWise  where ACWSB.CMSMappingId =CMSMappingId )
			END 	AS PortalId,
			ACWSB.Type,ACWSB.Navigation,ACWSB.AutoPlay,ACWSB.AutoplayTimeOut
			,ACWSB.AutoplayHoverPause,ACWSB.TransactionStyle,ACWSB.WidgetsKey,ACWSB.TypeOfMapping
			OFMapping,ACWSB.CMSSliderId FROM ZnodeCMSWidgetSliderBanner AS ACWSB 
			WHERE
			((TypeOfMapping = 'PortalMapping'	AND ( Exists (Select TOP 1 1 from @Tbl_ProductionVersionId TPC where TPC.PortalId = CMSMappingId) 
			OR Exists (Select TOP 1 1 from @Tbl_PreviewVersionId TPC where TPC.PortalId = CMSMappingId) )	OR 
			 (TypeOfMapping = 'ContentPageMapping' AND CMSMappingId IN  (SELECT CMSContentPagesId	FROM @TBL_CMSContentPagesPortalWise)))
			AND (ACWSB.CMSSliderId = @CMSSliderId OR @CMSSliderId = 0 ))
			

		Else If @CMSSliderId	= 0  AND @CMSContentPagesId  = 0 and @PortalId > 0 -- portal publish
			INSERT INTO @Tlb_ZnodeCMSWidgetSliderBanner(CMSWidgetSliderBannerId,CMSMappingId,PortalId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping,CMSSliderId)
			SELECT ACWSB.CMSWidgetSliderBannerId,ACWSB.CMSMappingId,
			CASE when TypeOfMapping = 'PortalMapping'  THEN ACWSB.CMSMappingId ELSE @PortalId END 	AS PortalId,
			ACWSB.Type,ACWSB.Navigation,ACWSB.AutoPlay,ACWSB.AutoplayTimeOut
			,ACWSB.AutoplayHoverPause,ACWSB.TransactionStyle,ACWSB.WidgetsKey,ACWSB.TypeOfMapping
			OFMapping,ACWSB.CMSSliderId FROM ZnodeCMSWidgetSliderBanner AS ACWSB WHERE
			((TypeOfMapping = 'PortalMapping'	AND CMSMappingId = @PortalId OR @PortalId = 0 )	OR 
				(TypeOfMapping = 'ContentPageMapping' AND CMSMappingId IN (SELECT CMSContentPagesId	FROM @TBL_CMSContentPagesPortalWise	) ))
							
		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )

		
		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
	
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			;With Cte_GetCMSSEODetails AS 
			(
					SELECT ZCSB.CMSSliderId,ZCSB.CMSSliderBannerId,ZM.Path MediaPath ,ZCSBL.Title,ZCSBL.ButtonLabelName,ZCSBL.ButtonLink,ZCSB.TextAlignment,ZCSB.BannerSequence,ZCSB.ActivationDate,ZCSB.ExpirationDate,ZCSBL.ImageAlternateText,ZCSBL.DEscription,ISNULL(ZCSBL.LocaleId, @DefaultLocaleId) AS LocaleId
					FROM ZnodeCMSSliderBanner AS ZCSB LEFT JOIN ZnodeCMSSliderBannerLocale AS ZCSBL ON(ZCSB.CMSSliderBannerId = ZCSBL.CMSSliderBannerId
					AND	(ZCSBL.LocaleId  = @SetLocaleId OR ZCSBL.LocaleId  = @DefaultLocaleId))  
					LEFT OUTER JOIN ZnodeMEdia  AS ZM ON ZCSBL.MediaId = ZM.MediaId
					WHERE EXISTS
					(
						SELECT TOP 1 1
						FROM @Tlb_ZnodeCMSWidgetSliderBanner AS ACWSB
						WHERE ACWSB.CMSSliderId = ZCSB.CMSSliderId
					)

			)
			, Cte_GetFirstCMSSEODetails  AS
			(
				SELECT 
					CMSSliderId,CMSSliderBannerId,MediaPath,Title,ButtonLabelName,ButtonLink,TextAlignment,BannerSequence,ActivationDate,ExpirationDate,ImageAlternateText,DEscription
				FROM Cte_GetCMSSEODetails 
				WHERE LocaleId = @SetLocaleId
			)
			, Cte_GetDefaultFilterData AS
			(
				SELECT 
					CMSSliderId,CMSSliderBannerId,MediaPath,Title,ButtonLabelName,ButtonLink,TextAlignment,BannerSequence,ActivationDate,ExpirationDate,ImageAlternateText,DEscription
					 FROM  Cte_GetFirstCMSSEODetails 
				UNION ALL 
				SELECT 
					CMSSliderId,CMSSliderBannerId,MediaPath,Title,ButtonLabelName,ButtonLink,TextAlignment,BannerSequence,ActivationDate,ExpirationDate,ImageAlternateText,DEscription
				FROM Cte_GetCMSSEODetails CTEC 
				WHERE LocaleId = @DefaultLocaleId 
				AND NOT EXISTS (SELECT TOP 1 1 FROM Cte_GetFirstCMSSEODetails CTEFD WHERE   CTEC.CMSSliderBannerId = CTEFD.CMSSliderBannerId
                                      AND CTEC.CMSSliderId = CTEFD.CMSSliderId)
			)
	
			INSERT INTO @CMSWidgetDataFinal 
			(
				WidgetSliderBannerId,MappingId,PortalId,LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners
			)
		   SELECT DISTINCT
		   CMSWidgetSliderBannerId AS WidgetSliderBannerId,CMSMappingId AS MappingId,PortalId,
		   @SetLocaleId AS LocaleId,Type,Navigation,AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey,TypeOFMapping
		   ,CMSSliderId AS SliderId,
			(  
				SELECT ISNULL(CMSSliderId,'') AS SliderId,ISNULL(CMSSliderBannerId,'') AS SliderBannerId,ISNULL(MediaPath,'')MediaPath
				,ISNULL(Title,'')Title,ISNULL(ButtonLabelName,'')ButtonLabelName,ISNULL(ButtonLink,'')ButtonLink
				,ISNULL(TextAlignment,'')TextAlignment,ISNULL(BannerSequence,'')BannerSequence,ActivationDate
				,ExpirationDate,ISNULL(ImageAlternateText,'')ImageAlternateText,ISNULL(Description,'')Description
				FROM Cte_GetDefaultFilterData AS wd
				WHERE wd.CMSSliderId = a.CMSSliderId 
				FOR JSON PATH  
			)SliderBanners
			FROM @Tlb_ZnodeCMSWidgetSliderBanner AS a

			SET @IncrementalId = @IncrementalId +1 
		END 
	End
		
	If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
	Begin
	    --Data inserted into flat table ZnodePublishWidgetSliderBannerEntity (Replica of MongoDB Collection )  

		Delete from ZnodePublishWidgetSliderBannerEntity where VersionId in (Select PreviewVersionId from @Tbl_PreviewVersionId )
	 		 AND (SliderId = @CMSSliderId OR @CMSSliderId = 0   )
			 AND (MappingId in (Select CMSContentPagesId from @TBL_CMSContentPagesPortalWise) OR @CMSContentPagesId  = 0);

		Insert Into ZnodePublishWidgetSliderBannerEntity 
		(VersionId,PublishStartTime,WidgetSliderBannerId,MappingId,PortalId,LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners	)

		SELECT B.PreviewVersionId , Getdate(),WidgetSliderBannerId,MappingId,A.PortalId,A.LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners
	    FROM @CMSWidgetDataFinal A INNER JOIN @Tbl_PreviewVersionId B
		On A.LocaleId = B.LocaleId AND A.PortalId = B.PortalId 
	
	End
	-------------------------- End Preview 
	If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	Begin
			-- Only production version id will process 
		Delete from ZnodePublishWidgetSliderBannerEntity where VersionId in (Select ProductionVersionId from @Tbl_ProductionVersionId )
	 		 AND (SliderId = @CMSSliderId OR @CMSSliderId = 0   )
			 AND (MappingId in (Select CMSContentPagesId from @TBL_CMSContentPagesPortalWise) OR @CMSContentPagesId  = 0);

		Insert Into ZnodePublishWidgetSliderBannerEntity 
		(
			VersionId,PublishStartTime,WidgetSliderBannerId,MappingId,PortalId,LocaleId,Type,Navigation,
			AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
			TypeOFMapping,SliderId,SliderBanners
		)
		
		SELECT B.ProductionVersionId, Getdate(),WidgetSliderBannerId,MappingId,A.PortalId,A.LocaleId,Type,Navigation	,
				AutoPlay,AutoplayTimeOut,AutoplayHoverPause,TransactionStyle,WidgetsKey	,
				TypeOFMapping,SliderId,SliderBanners
	    FROM @CMSWidgetDataFinal A INNER JOIN @Tbl_ProductionVersionId B
		On A.LocaleId = B.LocaleId AND A.PortalId = B.PortalId
		
	End

	If @RevisionState ='PREVIEW'
	Begin
			update A SET A.IsPublished = 1 , A.PublishStateId = [dbo].[Fn_GetPublishStateIdForPreview]() 
			from ZnodeCMSSlider A INNER JOIN @CMSWidgetDataFinal B on A.CMSSliderId = B.SliderId 
	End
	Else 
			update A SET A.IsPublished = 1 , A.PublishStateId = [dbo].[Fn_GetPublishStateIdForPublish]() 
			from ZnodeCMSSlider A INNER JOIN @CMSWidgetDataFinal B on A.CMSSliderId = B.SliderId 
		

	SET @Status =1 ;
	
	If Not Exists (select TOP 1 1 from @CMSWidgetDataFinal ) 
	Begin
		If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
		Begin
			SET @Status =0 ;
			SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
		End
	End
	Else 
		If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
		SELECT 1 AS ID,cast(@Status as BIT) AS Status;

END TRY 
BEGIN CATCH 
	SET @Status =0 ;
	If @CMSSliderId	> 0  AND @CMSContentPagesId  = 0 and @PortalId = 0  -- Slider Publish 
		SELECT 1 AS ID,cast(@Status as BIT) AS Status;  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	 @ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeSetPublishWidgetSliderBannerEntity 
			@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
			+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
			+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
			+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
			+''',@CMSContentPagesId= ' + CAST(@CMSContentPagesId  AS varchar(20))
			+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'ZnodeSetPublishWidgetSliderBannerEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

END CATCH
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishCategoryEntity' AND COLUMN_NAME = 'Name')
BEGIN
    ALTER TABLE ZnodePublishCategoryEntity ALTER COLUMN Name NVARCHAR (300)  NOT NULL;
END

GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'ZnodePublishCategoryEntity' AND COLUMN_NAME = 'Attributes')
BEGIN
    ALTER TABLE ZnodePublishCategoryEntity ALTER COLUMN Attributes NVARCHAR (MAX)  NOT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE   PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int , IsAssocitedProduct bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
	,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
FROM ZnodePimCategoryProduct a with(nolock)
INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
WHERE b.PimCatalogId = @PimCatalogId
AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) 

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0,0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity,RequiredType
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


-- SELECT * FROM ZnodePimAddOnProduct
INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 ,0
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity, 1
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 



SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 


UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId  AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)



SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 

TRUNCATE TABLE ZnodePublishProductEntityLog

DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


 DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

INSERT INTO ZnodePublishProductEntityLog
SELECT *
FROM ZnodePublishProductEntity ty with(nolock) 
WHERE EXISTS (SELECT TOP 1 1 FROM  #insertedPublishEntity tu WHERE tu.PublishProductEntityId = ty.PublishProductEntityId AND tu.PublishProductEntityId <> 0 )

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,a.LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = a.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
INNER JOIN @Versions_working h ON (h.LocaleId = a.LocaleId) 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues
, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n 
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId AND n.LocaleId = q.LocaleId),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId AND b.IsAssocitedProduct =1 )
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault,q.LocaleId

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,0) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 
 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity.VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,IIF(RequiredType='requierd',1,0) IsRequired, RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	AND @PimProductId = 0 

	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleProductEntity')
	DROP PROC Znode_PublishSingleProductEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleProductEntity]
(
    @PimProductId TransferId READONLY
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAutoPublish bit = 0 
   ,@ImportGUID Varchar(500) = '' 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	DECLARE @PimProductIdIn INT , @PimCatalogId INT 

	SET @ImportGUID = CASE WHEN @ImportGUID = '' THEN CAST( NEWID() AS VARCHAR(200)) ELSE @ImportGUID END 

	DECLARE @PimCatalogProduct TABLE (PimProductId INT , IsDeleted BIT,  ZnodecatalogId INT  , VersionId INT )
	IF EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	)
	BEGIN 



	DECLARE Cur_CatalogProduct CURSOR FOR 
	SELECT DISTINCT PimProductId, b.PimCatalogId
	FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	OPEN Cur_CatalogProduct 

	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId

	WHILE @@FETCH_STATUS=0 
	BEGIN 

	

	INSERT INTO @PimCatalogProduct 
	EXEC Znode_PublishCatalogEntity @PimCatalogId= @PimCatalogId
									,@RevisionState =@RevisionType
									,@UserId =@UserId
									,@NewGUID = @ImportGUID
									,@IsDraftProductsOnly = 0 
									,@PimProductId =@PimProductIdIn
									,@PimCategoryHierarchyId = 0 



	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId
	END 
	CLOSE Cur_CatalogProduct
	DEALLOCATE Cur_CatalogProduct 

	   	  
	SET @Status =1 

	END 
	ELSE 
	BEGIN 


	SET @Status = 0 
	END 


	SELECT * 
	FROM ZnodePublishProductEntity a with (nolock)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimCatalogProduct r WHERE r.VersionId = a.VersionId AND r.PimProductId = a.ZnodeProductId AND r.IsDeleted = 0)

	SELECT PimProductId ZnodeProductId , IsDeleted ,  ZnodecatalogId   , VersionId 
	FROM @PimCatalogProduct 
	WHERE IsDeleted =1 

		UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  @PimCatalogProduct ) 



	UPDATE ZnodePublishCatalogLog 
	SET PublishStateId = CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	, IsCatalogPublished = 1 
	WHERE PublishType= 'Product'
	
	UPDATE ZnodePublishProgressNotifierEntity 
	SET IsCompleted = 1 ,ProgressMark = 100 
	WHERE JobId = @ImportGUID

	SELECT 0 AS id,@Status AS Status;   

	DELETE FROM ZnodePublishProgressNotifierEntity  	WHERE JobId = @ImportGUID

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleProductEntity
		@PimProductIds = '',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleProductErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleProductEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleProductEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO



CREATE    PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
--DECLARE #pimProductIds  TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT, VersionId INT  )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId ,VersionId
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
--AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

CREATE INDEX IDX_#pimProductIds ON #pimProductIds(PimProductId)

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID


DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

--INSERT INTO #pimProductIds 
--SELECT  PimProductId 
--FROM #pimProductIds 

SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  #pimProductIds  t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN #pimProductIds  bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT DISTINCT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #pimProductIds  n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct w WHERE w.VersionId = a.VersionId)

CREATE TABLE #tbl_AttributeValueLocale (PimProductId INT ,   AttributeValue NVARCHAR(max), PimAttributeId INT  , LocaleId INT)
CREATE TABLE #default_valuelocale (PimAttributeDefaultValueId INT , AttributeDefaultValue NVARCHAR(max), LocaleId int  )





IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct WHERE LocaleId <> @DefaultLocaleId )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   WHERE m.LocaleId <> @DefaultLocaleId

   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

    --SELECT * FROM #tbl_AttributeValue

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   LEFT JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   LEFT JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId
 


   INSERT INTO #default_valuelocale
   SELECT  bc.PimAttributeDefaultValueId, bc.AttributeDefaultValue, bc.LocaleId 
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE bc.LocaleId <> @DefaultLocaleId
   



END 
--LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
   --SELECT * FROM #tbl_AttributeValueLocale

    DROP TABLE IF EXISTS #tbl_ProductValueid

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID
	
	DECLARE @t transferId 

	WHILE EXISTS (SELECT TOP 1 1 FROM #PublishProductEntityId)
	BEGIN 
	
	INSERT INTO @t
	SELECT TOP 50000 PublishProductEntityId
	FROM #PublishProductEntityId

UPDATE m
SET m.Attributes = (SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(IIF(ut.AttributeValue IS NULL , a.AttributeValue,ut.AttributeValue),'') AttributeValues
				,ISNULL((
				   SELECT   Code,m.LocaleId,IIF(AttributeDefaultValue IS NULL ,Value, AttributeDefaultValue) Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   LEFT JOIN #default_valuelocale op ON (op.PimAttributeDefaultValueId = nt.PimAttributeDefaultValueId AND op.LocaleId = m.LocaleId )
				   WHERE nt.PimProductId = m.ZnodeProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId =@DefaultLocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = m.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =m.LocaleId)
WHERE a.PimProductId = m.ZnodeProductId AND a.LocaleId = @DefaultLocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
    )

FROM ZnodePublishProductEntity m
WHERE EXISTS (SELECT TOP 1 1  FROM @t p WHERE p.id = m.PublishProductEntityId)
OPTION (RECOMPILE)

UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValueLocale ty ON ( ty.PimProductId = a.ZnodeProductId AND ty.LocaleId = a.LocaleId 
	AND ty.PimAttributeId = (SELECT TOP 1 w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')  )
WHERE PublishProductEntityId  IN (SELECT Id FROM @t)
AND a.LocaleId <> @DefaultLocaleId
	
	DELETE FROM #PublishProductEntityId WHERE EXISTS (SELECT TOP 1 1 FROM @t WHERE id = PublishProductEntityId)
	DELETE FROM @t
	IF IS_SRVROLEMEMBER('sysadmin', SUSER_NAME())=1
	DBCC DROPCLEANBUFFERS
END 

DROP TABLE IF EXISTS #pimProductIds

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingByUserDetails')
	DROP PROC Znode_GetPaymentSettingByUserDetails

GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingByUserDetails]
(
	@PortalId	INT,
	@UserId		INT,
	@RowsCount  INT OUT
)
AS
/*
	Summary: This Procedure is used to get payment details according to associated profile or portal.

	Unit Testing:

	EXEC [Znode_GetPaymentSettingByUserDetails] @PortalId=1, @UserId=1, @RowsCount=0
*/	
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @GuestProfileId INT;

		SELECT TOP 1 @GuestProfileId=ProfileId FROM ZnodeProfile WHERE ProfileName = 'Anonymous' AND @UserId = -1;

		IF OBJECT_ID('tempdb..#ZnodePortalPaymentApprovers') IS NOT NULL
			DROP TABLE #ZnodePortalPaymentApprovers
		--Getting the payment portal approver details
		SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
		INTO #ZnodePortalPaymentApprovers
		FROM ZnodePortalPaymentApprovers ZPPA 
		INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)
		INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
		WHERE ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1;

		--When any User Profile is associated with the user account
		--OR When User is associated with single Profile.
		--OR When two or more User Profiles are associated with the user account
		IF (EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP 
					INNER JOIN ZnodePortalProfile ZPP ON ZUP.ProfileId=ZPP.ProfileId
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZUP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZUP.UserId=@UserId AND ZPP.PortalId=@PortalId AND ZPS1.IsUsedForWebStorePayment=1)

			OR (@UserId=-1 AND EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile ZPP
					INNER JOIN ZnodeProfilePaymentSetting ZPS ON ZPP.ProfileId=ZPS.ProfileId
					INNER JOIN ZnodePortalPaymentSetting ZPS1 ON ZPP.PortalId=ZPS1.PortalId AND ZPS.PaymentSettingId=ZPS1.PaymentSettingId
					WHERE ZPP.ProfileId=@GuestProfileId AND ZPP.PortalId=@PortalId AND ZPS1.IsUsedForWebStorePayment=1))
			)
		BEGIN
			IF EXISTS (	SELECT TOP 1 1 
						FROM ZnodePaymentSetting ZPS
						INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
						LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
						INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
						INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
						INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
						INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
						WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
							(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId AND ZPPS.IsUsedForWebStorePayment=1)
							OR (@UserId = -1 AND ZP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1)))
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				INNER JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				INNER JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND YOPU.ProfileId = ZUP.ProfileId AND ZPPS.IsUsedForWebStorePayment=1)
					OR (@UserId = -1 AND ZP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1));

				SET @RowsCount=@@ROWCOUNT;
			END
			ELSE
			BEGIN
				SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
					ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
					ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
					NULL IsAssociated ,NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
						CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
							THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
					NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
					ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
					YU.PortalPaymentGroupId,'' AS PublishState
				FROM ZnodePaymentSetting ZPS
				INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
				INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
				LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
				INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
				LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
					(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPPS.IsUsedForWebStorePayment=1)
					OR (@UserId = -1 AND ZP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1));

				SET @RowsCount=@@ROWCOUNT;
			END
		END
		--When User is associated with Profile but this Profile is not associated with any portal.
		ELSE IF EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ZUP.UserId = @UserId AND ZUP.ProfileId IS NOT NULL
				AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZUP.ProfileId AND PortalId=@PortalId))
			OR EXISTS (SELECT TOP 1 1 FROM ZnodeProfile ZP WHERE @UserId = -1 AND ZP.ProfileId = @GuestProfileId
				AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalProfile WHERE ProfileId=ZP.ProfileId AND PortalId=@PortalId))
				
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated, NULL As ProfileId,NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND
				(EXISTS(SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE UserId = @UserId AND ZPPS.IsUsedForWebStorePayment=1)
				OR (@UserId = -1 AND ZP.ProfileId = @GuestProfileId AND ZPPS.IsUsedForWebStorePayment=1));

			SET @RowsCount=@@ROWCOUNT;
		END
		--When User is not associated with any Profile.
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUserProfile ZUP WHERE ZUP.UserId = @UserId)
			OR NOT EXISTS (SELECT TOP 1 1 FROM ZnodeProfile ZP WHERE @UserId = -1 AND ZP.ProfileId = @GuestProfileId)
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,
				ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, 
				NULL IsAssociated ,NULL ProfileId, NULL As ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
					CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
						THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId )
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			LEFT JOIN ZnodeProfile ZP ON ZP.ProfileId = YOPU.ProfileId
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND ZPPS.IsUsedForWebStorePayment=1
			SET @RowsCount=@@ROWCOUNT;
		END
		ELSE
		BEGIN
			SELECT DISTINCT ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,
				ZPS.IsActive,ZPS.DisplayOrder AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,
				ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate,ZPPS.PortalId,ZP1.StoreName, NULL IsAssociated ,NULL AS ProfileId,
				NULL AS ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName,
				CASE WHEN @PortalId > 0 AND ZPPS.PaymentDisplayName IS NOT NULL
					THEN ZPPS.PaymentDisplayName ELSE ZPS.PaymentDisplayName END PaymentDisplayName, 
				NULL PaymentExternalId, CAST(CASE WHEN YU.PaymentSettingId IS NOT NULL THEN 1 ELSE 0 END As BIT) AS IsApprovalRequired,
				ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,
				YU.PortalPaymentGroupId,'' AS PublishState
			FROM ZnodePaymentSetting ZPS
			INNER JOIN ZnodePaymentType ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
			LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
			INNER JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId = ZPPS.PaymentSettingId )
			INNER JOIN ZnodePortal ZP1 ON ZP1.PortalId = ZPPS.PortalId
			LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
			WHERE ZPPS.PortalId = @PortalId AND ZPS.IsActive=1 AND ZPPS.IsUsedForWebStorePayment=1;

			SET @RowsCount=@@ROWCOUNT;
		END
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingByUserDetails @PortalId='+CAST(@PortalId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50));

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPaymentSettingByUserDetails',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer

GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY

	    DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
			@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
			,@ProfileId INT, @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT @RoleId = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId

		DECLARE @AttributeCode Nvarchar(max) = ''
		SELECT @AttributeCode=STRING_AGG(c.AttributeCode , ',')   
		FROM ZnodeGlobalFamilyGroupMapper a
		INNER JOIN ZnodeGlobalAttributeGroupMapper f ON (f.GlobalAttributeGroupId = a.GlobalAttributeGroupId)
		INNER JOIN ZnodeGlobalAttribute c ON (c.GlobalAttributeId = f.GlobalAttributeId)
		WHERE GlobalAttributeFamilyId = (SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily where FamilyCode='User')
			AND NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='ZnodeUser' AND COLUMN_NAME=c.AttributeCode)
			AND EXISTS (SELECT TOP 1 1 FROM tempdb.sys.columns WHERE Object_id = Object_id(@TableName) AND name = c.AttributeCode )
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = ' ALTER TABLE #InsertCustomer ADD '+REPLACE(TRIM(LTRIM(@AttributeCode)), ',',' NVARCHAR(max),' ) + CASE WHEN @AttributeCode = '' THEN '' ELSE ' NVARCHAR(max)' END 
		EXEC (@SSQL)

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
						SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;

		EXEC sys.sp_sqlexec @SSQL;

		--If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''

		IF @CsvColumnString NOT LIKE '%AccountCode%'
		BEGIN
			--If Acount Code Exists then it will update as it is and if not exists then it will show error.
			UPDATE IC set AccountCode = ZA.AccountCode
			FROM ZnodeUser a
			INNER JOIN ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
			INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
			WHERE ISNULL(IC.AccountCode,'') = '' 
		END
		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		
		IF (ISNULL(@ProfileId ,0) = 0 ) 
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
			WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
			SELECT @SuccessRecordCount = 0

			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
			WHERE ImportProcessLogId = @ImportProcessLogId;

			DELETE FROM #InsertCustomer 
			SET @Status = 0;

			COMMIT TRAN A;
			RETURN 0 
		END
		
		IF @IsAllowGlobalLevelUserCreation = 'true'
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertCustomer AS ii  
			WHERE ltrim(rtrim(ii.UserName)) IN (SELECT UserName FROM AspNetZnodeUser);  
		END

        INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
			AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
				WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
			AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' AND ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') NOT IN 
			(
				SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
			);

        INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' AND ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') AND  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
			AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
				WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = LTRIM(RTRIM(za.AccountCode))
				AND ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = LTRIM(RTRIM(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');
	
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL;

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		IF OBJECT_ID('tempdb..#GlobalAttributeData1') IS NOT NULL 
			DROP TABLE #GlobalAttributeData1;

		CREATE TABLE #GlobalAttributeData1 (RowNumber INT,Username NVARCHAR(500),FirstName NVARCHAR(100),LastName NVARCHAR(100),AttributeCode Nvarchar(300),AttributeValue Nvarchar(Max),Userid Int)

		SET @SSQL =' Select RowNumber,Username,FirstName,LastName,AttributeCode,AttributeValue
                    FROM #InsertCustomer 
					UNPIVOT
					( AttributeValue For AttributeCode IN ('+@AttributeCode+')
					) UNPIVOT8'
                
		INSERT INTO #GlobalAttributeData1(RowNumber,Username,FirstName,LastName,AttributeCode,AttributeValue)   
        EXEC sys.sp_sqlexec @SSQL;  

		ALTER TABLE #GlobalAttributeData1 ADD AttributetypeName VARCHAR(200) , ValidationName VARCHAR(600) , ValidationValue VARCHAR(600);
		
		UPDATE A
		SET A.AttributetypeName=C.AttributeTypeName, ValidationName = d.name  , ValidationValue =  e.Name
		FROM #GlobalAttributeData1 A
		INNER JOIN ZnodeGlobalAttribute B ON (B.AttributeCode=A.AttributeCode)
		INNER JOIN ZnodeAttributeType C ON (C.AttributeTypeId=B.AttributeTypeId)
		INNER JOIN ZnodeAttributeInputValidation d ON (d.AttributeTypeId = c.AttributeTypeId AND c.AttributeTypeName=d.ControlName)
		INNER JOIN ZnodeGlobalAttributeValidation e ON (e.InputValidationId = d.InputValidationId AND b.GlobalAttributeId = e.GlobalAttributeId);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT dbo.Fn_ValidateDataErrorCode(ii.AttributetypeName,ii.ValidationName ), ii.AttributeCode, ii.AttributeValue , @NewGUId, RowNumber, @UserId, @GetDate, 
			@UserId, @GetDate, @ImportProcessLogId  
		FROM #GlobalAttributeData1 AS ii
		WHERE dbo.Fn_ValidateData (ii.AttributetypeName,ii.AttributeValue,ii.ValidationName, ii.ValidationValue)=0
			AND ii.AttributeValue<>'';
		
		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
			--AND GUID = @NewGUID
		);

		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
		WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
		DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
		DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
		DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

		UPDATE ANU 
		SET ANU.PhoneNumber	= IC.PhoneNumber, 
			ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
		FROM AspNetZnodeUser ANZU 
		INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
		WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
		----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

		UPDATE ZU SET 
		ZU.FirstName	= IC.FirstName,
		ZU.LastName		= IC.LastName,
		--ZU.MiddleName	= IC.MiddleName,
		ZU.BudgetAmount = IC.BudgetAmount,
		ZU.Email		= IC.Email,
		ZU.PhoneNumber	= IC.PhoneNumber,
		ZU.EmailOptIn	= (CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
		ZU.IsActive		= (CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
		ZU.Custom1 = IC.Custom1,
		ZU.Custom2 = IC.Custom2,
		ZU.Custom3 = IC.Custom3,
		ZU.Custom4 = IC.Custom4,
		ZU.Custom5 = IC.Custom5,
		ZU.SMSOptIn	= (CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN '' THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
		--ZU.ExternalId = ExternalId
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
		WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
		--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

		INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
		OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
		SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
			WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
				AND ANZ.UserName = IC.UserName)

		INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
		LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
		OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
		SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
			0,@GetDate,AspNetZnodeUserId 
		FROM #InsertCustomer A 
		INNER JOIN @InsertedAspNetZnodeUser B ON A.UserName = B.UserName
			
		INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
			IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
		OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
		SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email,IC.PhoneNumber,
			(CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
			(CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
			IC.ExternalId, @UserId,
			CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
			@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
				(CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
		FROM #InsertCustomer IC 
		INNER JOIN @InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName
		INNER JOIN @InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
		INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
		INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
		SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
		FROM @InsertZnodeUser IZU

		INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
		FROM @InsertZnodeUser IZU
		
		UPDATE a 
		SET a.Userid = b.UserId
		FROM #GlobalAttributeData1 a 
		INNER JOIN ZnodeUser b ON (b.username = a.Username)  
				
		UPDATE D
		SET D.AttributeValue=A.AttributeValue
		FROM #GlobalAttributeData1 A 
		INNER JOIN ZnodeGlobalAttribute C ON A.AttributeCode=C.AttributeCode
		INNER JOIN ZnodeUser ZU ON LTRIM(RTRIM(a.Username))=LTRIM(RTRIM(ZU.UserName)) 
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=ZU.UserId and ZUP.PortalId=@PortalId
		INNER JOIN ZnodeUserGlobalAttributeValue b ON c.GlobalAttributeId=b.GlobalAttributeId AND ZU.UserId=b.UserId
		INNER JOIN ZnodeUserGlobalAttributeValueLocale d on b.UserGlobalAttributeValueId=d.UserGlobalAttributeValueId

		INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,ModifiedBy,	ModifiedDate)
		SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
		FROM #GlobalAttributeData1 g 
		INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.AttributeCode
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=g.UserId and ZUP.PortalId=@PortalId
		WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

		INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
		SELECT UserGlobalAttributeValueId, @LocaleId,g.AttributeValue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
		FROM ZnodeUserGlobalAttributeValue ZUGAV 
		INNER JOIN #GlobalAttributeData1 g on ZUGAV.userid =g.userid
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=g.UserId and ZUP.PortalId=@PortalId
		INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.AttributeCode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
		WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

		---------------------------------------------------------------------------------

		DECLARE @Profile table (ProfileId INT)

		INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
		OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
		SELECT Distinct ProfileName, 0, null,0, REPLACE(LTRIM(RTRIM(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
		FROM #InsertCustomer IC
		WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
			AND ISNULL(ic.ProfileName,'') <> ''

		INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
		SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
		FROM @Profile

		UPDATE ZnodeUserProfile 
		SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
		LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
		--WHERE IC.ProfileName <> ''
				
		INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
			AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

		--Updating RoleName if customer has changed the account and RoleName left blank then by default User role assigned to the customer
		UPDATE u 
		set u.RoleId = @RoleId
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		WHERE ISNULL(IC.AccountCode,'') <> '' AND ISNULL(IC.RoleName,'') = ''
			AND EXISTS(SELECT * FROM ZnodeAccount ZA WHERE ISNULL(a.AccountId,0) = ZA.AccountId AND ZA.AccountCode <> IC.AccountCode)

		---to update accountid agaist user
		UPDATE ZU 
		SET ZU.AccountId = ZA.AccountId 
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
		INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
		--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
		WHERE ISNULL(ANZU.PortalId,0) = ISNULL(@PortalId ,0) AND ISNULL(IC.AccountCode,'') <> '' 
		--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )
				
		UPDATE ZDU 
		set ZDU.DepartmentId = ZD.DepartmentId, 
			ModifiedBy = @UserId, 
			ModifiedDate = @Getdate
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
		INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
		WHERE ISNULL(IC.DepartmentName,'') <> ''

		INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
			AND ISNULL(IC.DepartmentName,'') <> ''
		
		UPDATE u 
		SET u.RoleId = ZD.Id
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		WHERE isnull(IC.RoleName,'') <> '' 
		
		--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
		--after the update process is complete.
		DELETE UR 
		FROM AspNetUserRoles UR 
		INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))

		UPDATE ZnodeUser SET AccountId = NULL 
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		
		
		INSERT INTO AspNetUserRoles(UserId,RoleId)
		SELECT b.Id as ASPNetUserId, CASE WHEN ZD.Id IS NULL THEN @RoleId ELSE ZD.Id END as RoleId
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
			AND ISNULL(IC.AccountCode,'') <> ''
			
		--If no value was available previously then no value should be saved after the update process is complete.
		--If a value was available previously, then it should be removed after the update process is complete.
		DELETE DU 
		FROM ZnodeDepartmentUser DU
		INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
		INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN A;
		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount WITH (NOLOCK) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
			TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount WITH (NOLOCK) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportCustomer',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer

GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Customer Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY

	    DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
			@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
			,@ProfileId INT, @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';

		SELECT @RoleId = Id FROM AspNetRoles WHERE   NAME = 'User'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 
		Delete from ZnodeImportLog where ErrorDescription = '42' and ColumnName like '%AccountCode%' and  ImportProcessLogId= @ImportProcessLogId

		DECLARE @AttributeCode Nvarchar(max) = ''
		SELECT @AttributeCode=STRING_AGG(c.AttributeCode , ',')   
		FROM ZnodeGlobalFamilyGroupMapper a
		INNER JOIN ZnodeGlobalAttributeGroupMapper f ON (f.GlobalAttributeGroupId = a.GlobalAttributeGroupId)
		INNER JOIN ZnodeGlobalAttribute c ON (c.GlobalAttributeId = f.GlobalAttributeId)
		WHERE GlobalAttributeFamilyId = (SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily where FamilyCode='User')
			AND NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='ZnodeUser' AND COLUMN_NAME=c.AttributeCode)
			AND EXISTS (SELECT TOP 1 1 FROM tempdb.sys.columns WHERE Object_id = Object_id(@TableName) AND name = c.AttributeCode )
		
		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	varchar(100)	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max), SMSOptIn varchar(100)
		);

		SET @SSQL = ' ALTER TABLE #InsertCustomer ADD '+REPLACE(TRIM(LTRIM(@AttributeCode)), ',',' NVARCHAR(max),' ) + CASE WHEN @AttributeCode = '' THEN '' ELSE ' NVARCHAR(max)' END 
		EXEC (@SSQL)

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
						SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;

		EXEC sys.sp_sqlexec @SSQL;

		--If Account Code Exists then it will update as it is and if not exists then it will show error.
		UPDATE IC set AccountCode = ZA.AccountCode 
		FROM ZnodeUser a
		inner join ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
		INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
		WHERE ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> ''

		IF @CsvColumnString NOT LIKE '%AccountCode%'
		BEGIN
			--If Acount Code Exists then it will update as it is and if not exists then it will show error.
			UPDATE IC set AccountCode = ZA.AccountCode
			FROM ZnodeUser a
			INNER JOIN ZnodeAccount ZA on (ZA.AccountId = a.AccountId)
			INNER JOIN #InsertCustomer IC on (IC.UserName = a.UserName)
			WHERE ISNULL(IC.AccountCode,'') = '' 
		END
		
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		
		IF (ISNULL(@ProfileId ,0) = 0 ) 
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
			WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
			SELECT @SuccessRecordCount = 0

			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
			WHERE ImportProcessLogId = @ImportProcessLogId;

			DELETE FROM #InsertCustomer 
			SET @Status = 0;

			COMMIT TRAN A;
			RETURN 0 
		END
		
		IF @IsAllowGlobalLevelUserCreation = 'true'
		BEGIN
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM #InsertCustomer AS ii  
			WHERE ltrim(rtrim(ii.UserName)) IN (SELECT UserName FROM AspNetZnodeUser);  
		END

        INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
			AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
				WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
			AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' AND ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') NOT IN 
			(
				SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
			);

        INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' AND ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') AND  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
			AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
				WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = LTRIM(RTRIM(za.AccountCode))
				AND ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = LTRIM(RTRIM(ZD.DepartmentName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'EmailOptIn',  EmailOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.EmailOptIn NOT IN ('True','1','Yes','FALSE','0','No','');

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'SMSOptIn',  SMSOptIn , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.SMSOptIn NOT IN ('True','1','Yes','FALSE','0','No','');
	
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL;

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		IF OBJECT_ID('tempdb..#GlobalAttributeData1') IS NOT NULL 
			DROP TABLE #GlobalAttributeData1;

		CREATE TABLE #GlobalAttributeData1 (RowNumber INT,Username NVARCHAR(500),FirstName NVARCHAR(100),LastName NVARCHAR(100),AttributeCode Nvarchar(300),AttributeValue Nvarchar(Max),Userid Int)

		SET @SSQL =' Select RowNumber,Username,FirstName,LastName,AttributeCode,AttributeValue
                    FROM #InsertCustomer 
					UNPIVOT
					( AttributeValue For AttributeCode IN ('+@AttributeCode+')
					) UNPIVOT8'
                
		INSERT INTO #GlobalAttributeData1(RowNumber,Username,FirstName,LastName,AttributeCode,AttributeValue)   
        EXEC sys.sp_sqlexec @SSQL;  

		ALTER TABLE #GlobalAttributeData1 ADD AttributetypeName VARCHAR(200) , ValidationName VARCHAR(600) , ValidationValue VARCHAR(600);
		
		UPDATE A
		SET A.AttributetypeName=C.AttributeTypeName, ValidationName = d.name  , ValidationValue =  e.Name
		FROM #GlobalAttributeData1 A
		INNER JOIN ZnodeGlobalAttribute B ON (B.AttributeCode=A.AttributeCode)
		INNER JOIN ZnodeAttributeType C ON (C.AttributeTypeId=B.AttributeTypeId)
		INNER JOIN ZnodeAttributeInputValidation d ON (d.AttributeTypeId = c.AttributeTypeId AND c.AttributeTypeName=d.ControlName)
		INNER JOIN ZnodeGlobalAttributeValidation e ON (e.InputValidationId = d.InputValidationId AND b.GlobalAttributeId = e.GlobalAttributeId);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT dbo.Fn_ValidateDataErrorCode(ii.AttributetypeName,ii.ValidationName ), ii.AttributeCode, ii.AttributeValue , @NewGUId, RowNumber, @UserId, @GetDate, 
			@UserId, @GetDate, @ImportProcessLogId  
		FROM #GlobalAttributeData1 AS ii
		WHERE dbo.Fn_ValidateData (ii.AttributetypeName,ii.AttributeValue,ii.ValidationName, ii.ValidationValue)=0
			AND ii.AttributeValue<>'';
		
		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND RowNumber IS NOT NULL
			--AND GUID = @NewGUID
		);

		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
		WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
		DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
		DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
		DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

		UPDATE ANU 
		SET ANU.PhoneNumber	= IC.PhoneNumber, 
			ANU.LockoutEndDateUtc = case when IC.IsActive IN('0','No','False') then @GetDate when IC.IsActive IN('1','Yes','True') then null else ANU.LockoutEndDateUtc END
		FROM AspNetZnodeUser ANZU 
		INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
		WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
		----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

		UPDATE ZU SET 
		ZU.FirstName	= IC.FirstName,
		ZU.LastName		= IC.LastName,
		--ZU.MiddleName	= IC.MiddleName,
		ZU.BudgetAmount = IC.BudgetAmount,
		ZU.Email		= IC.Email,
		ZU.PhoneNumber	= IC.PhoneNumber,
		ZU.EmailOptIn	= (CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
		ZU.IsActive		= (CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
		ZU.Custom1 = IC.Custom1,
		ZU.Custom2 = IC.Custom2,
		ZU.Custom3 = IC.Custom3,
		ZU.Custom4 = IC.Custom4,
		ZU.Custom5 = IC.Custom5,
		ZU.SMSOptIn	= (CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 WHEN '' THEN ZU.SMSOptIn ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
		--ZU.ExternalId = ExternalId
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
		WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
		--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

		INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
		OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
		SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
			WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
				AND ANZ.UserName = IC.UserName)

		INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
		LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
		OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
		SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive IN ('0','False','No') then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
			0,@GetDate,AspNetZnodeUserId 
		FROM #InsertCustomer A 
		INNER JOIN @InsertedAspNetZnodeUser B ON A.UserName = B.UserName
			
		INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
			IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5,SMSOptIn)
		OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
		SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email,IC.PhoneNumber,
			(CASE ISNULL(IC.EmailOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.EmailOptIn,0) As BIT) END),
			(CASE ISNULL(IC.IsActive,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.IsActive,0) As BIT) END),
			IC.ExternalId, @UserId,
			CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
			@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5,
				(CASE ISNULL(IC.SMSOptIn,0) WHEN 'Yes' THEN 1 WHEN 'No' THEN 0 ELSE CAST(ISNULL(IC.SMSOptIn,0) As BIT) END)
		FROM #InsertCustomer IC 
		INNER JOIN @InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName
		INNER JOIN @InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
	  	     
		INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
		INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
		SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
		FROM @InsertZnodeUser IZU

		INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
		FROM @InsertZnodeUser IZU
		
		UPDATE a 
		SET a.Userid = b.UserId
		FROM #GlobalAttributeData1 a 
		INNER JOIN ZnodeUser b ON (b.username = a.Username)  
				
		UPDATE D
		SET D.AttributeValue=A.AttributeValue
		FROM #GlobalAttributeData1 A 
		INNER JOIN ZnodeGlobalAttribute C ON A.AttributeCode=C.AttributeCode
		INNER JOIN ZnodeUser ZU ON LTRIM(RTRIM(a.Username))=LTRIM(RTRIM(ZU.UserName)) 
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=ZU.UserId and ZUP.PortalId=@PortalId
		INNER JOIN ZnodeUserGlobalAttributeValue b ON c.GlobalAttributeId=b.GlobalAttributeId AND ZU.UserId=b.UserId
		INNER JOIN ZnodeUserGlobalAttributeValueLocale d on b.UserGlobalAttributeValueId=d.UserGlobalAttributeValueId

		INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,ModifiedBy,	ModifiedDate)
		SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
		FROM #GlobalAttributeData1 g 
		INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.AttributeCode
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=g.UserId and ZUP.PortalId=@PortalId
		WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

		INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
		SELECT UserGlobalAttributeValueId, @LocaleId,g.AttributeValue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
		FROM ZnodeUserGlobalAttributeValue ZUGAV 
		INNER JOIN #GlobalAttributeData1 g on ZUGAV.userid =g.userid
		INNER JOIN ZnodeUserPortal ZUP on ZUP.UserId=g.UserId and ZUP.PortalId=@PortalId
		INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.AttributeCode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
		WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

		---------------------------------------------------------------------------------

		DECLARE @Profile table (ProfileId INT)

		INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
		OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
		SELECT Distinct ProfileName, 0, null,0, REPLACE(LTRIM(RTRIM(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
		FROM #InsertCustomer IC
		WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
			AND ISNULL(ic.ProfileName,'') <> ''

		INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
		SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
		FROM @Profile

		UPDATE ZnodeUserProfile 
		SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
		LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
		--WHERE IC.ProfileName <> ''
				
		INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
			AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

		--Updating RoleName if customer has changed the account and RoleName left blank then by default User role assigned to the customer
		UPDATE u 
		set u.RoleId = @RoleId
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		WHERE ISNULL(IC.AccountCode,'') <> '' AND ISNULL(IC.RoleName,'') = ''
			AND EXISTS(SELECT * FROM ZnodeAccount ZA WHERE ISNULL(a.AccountId,0) = ZA.AccountId AND ZA.AccountCode <> IC.AccountCode)

		---to update accountid agaist user
		UPDATE ZU 
		SET ZU.AccountId = ZA.AccountId 
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
		INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
		--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
		WHERE ISNULL(ANZU.PortalId,0) = ISNULL(@PortalId ,0) AND ISNULL(IC.AccountCode,'') <> '' 
		--EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.AccountCode = ZA.AccountCode AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') <> '' )
				
		UPDATE ZDU 
		set ZDU.DepartmentId = ZD.DepartmentId, 
			ModifiedBy = @UserId, 
			ModifiedDate = @Getdate
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
		INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
		WHERE ISNULL(IC.DepartmentName,'') <> ''

		INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
			AND ISNULL(IC.DepartmentName,'') <> ''
		
		UPDATE u 
		SET u.RoleId = ZD.Id
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
		INNER JOIN AspNetUserRoles u on u.UserId = b.Id
		WHERE isnull(IC.RoleName,'') <> '' 
		
		--when RoleName and AccountCode is null in update file then If a value was available previously, then it should be removed (along with Department and Role Name) 
		--after the update process is complete.
		DELETE UR 
		FROM AspNetUserRoles UR 
		INNER JOIN ZnodeUser ZC	ON  ZC.AspNetUserId = UR.UserId
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZC.UserName AND (ISNULL(IC.RoleName,'') = '' AND ISNULL(IC.AccountCode,'') = ''))

		UPDATE ZnodeUser SET AccountId = NULL 
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZnodeUser.UserName AND ISNULL(IC.AccountCode,'') = '' AND ISNULL(IC.RoleName,'') = '' )		
		
		INSERT INTO AspNetUserRoles(UserId,RoleId)
		SELECT b.Id as ASPNetUserId, CASE WHEN ZD.Id IS NULL THEN @RoleId ELSE ZD.Id END as RoleId
		FROM ZnodeUser a
		INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
		INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
		INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
		LEFT JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
		WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
			AND ISNULL(IC.AccountCode,'') <> ''
			
		--If no value was available previously then no value should be saved after the update process is complete.
		--If a value was available previously, then it should be removed after the update process is complete.
		DELETE DU 
		FROM ZnodeDepartmentUser DU
		INNER JOIN ZnodeUser ZU ON DU.UserId = ZU.UserId
		INNER JOIN ZnodeDepartment ZC ON  ZC.DepartmentId = DU.DepartmentId
		WHERE EXISTS (SELECT * FROM #InsertCustomer IC WHERE IC.UserName = ZU.UserName AND (ISNULL(IC.DepartmentName,'') = '' OR ISNULL(IC.ACCOUNTCODE,'') = ''))

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN A;
		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount WITH (NOLOCK) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
			TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount WITH (NOLOCK) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportCustomer',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO

CREATE PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
--DECLARE #pimProductIds  TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT, VersionId INT  )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId ,VersionId
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
--AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

CREATE INDEX IDX_#pimProductIds ON #pimProductIds(PimProductId)

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID


DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

--INSERT INTO #pimProductIds 
--SELECT  PimProductId 
--FROM #pimProductIds 

SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  #pimProductIds  t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN #pimProductIds  bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT DISTINCT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #pimProductIds  n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct w WHERE w.VersionId = a.VersionId)

CREATE TABLE #tbl_AttributeValueLocale (PimProductId INT ,   AttributeValue NVARCHAR(max), PimAttributeId INT  , LocaleId INT)
CREATE TABLE #default_valuelocale (PimAttributeDefaultValueId INT , AttributeDefaultValue NVARCHAR(max), LocaleId int  )





IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct WHERE LocaleId <> @DefaultLocaleId )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   WHERE m.LocaleId <> @DefaultLocaleId

   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

    --SELECT * FROM #tbl_AttributeValue

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   LEFT JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   LEFT JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId
 


   INSERT INTO #default_valuelocale
   SELECT  bc.PimAttributeDefaultValueId, bc.AttributeDefaultValue, bc.LocaleId 
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE bc.LocaleId <> @DefaultLocaleId
   



END 
--LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
   --SELECT * FROM #tbl_AttributeValueLocale

    DROP TABLE IF EXISTS #tbl_ProductValueid

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID
	
	DECLARE @t transferId 

	WHILE EXISTS (SELECT TOP 1 1 FROM #PublishProductEntityId)
	BEGIN 
	
	INSERT INTO @t
	SELECT TOP 50000 PublishProductEntityId
	FROM #PublishProductEntityId

UPDATE m
SET m.Attributes = (SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', ISNULL(f.CustomKey,a.CustomCode), b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(IIF(ut.AttributeValue IS NULL , a.AttributeValue,ut.AttributeValue),'') AttributeValues
				,ISNULL((
				   SELECT   Code,m.LocaleId,IIF(AttributeDefaultValue IS NULL ,Value, AttributeDefaultValue) Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   LEFT JOIN #default_valuelocale op ON (op.PimAttributeDefaultValueId = nt.PimAttributeDefaultValueId AND op.LocaleId = m.LocaleId )
				   WHERE nt.PimProductId = m.ZnodeProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId =@DefaultLocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = m.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =m.LocaleId)
WHERE a.PimProductId = m.ZnodeProductId AND a.LocaleId = @DefaultLocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
    )

FROM ZnodePublishProductEntity m
WHERE EXISTS (SELECT TOP 1 1  FROM @t p WHERE p.id = m.PublishProductEntityId)
OPTION (RECOMPILE)

UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValueLocale ty ON ( ty.PimProductId = a.ZnodeProductId AND ty.LocaleId = a.LocaleId 
	AND ty.PimAttributeId = (SELECT TOP 1 w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')  )
WHERE PublishProductEntityId  IN (SELECT Id FROM @t)
AND a.LocaleId <> @DefaultLocaleId
	
	DELETE FROM #PublishProductEntityId WHERE EXISTS (SELECT TOP 1 1 FROM @t WHERE id = PublishProductEntityId)
	DELETE FROM @t
	IF IS_SRVROLEMEMBER('sysadmin', SUSER_NAME())=1
	DBCC DROPCLEANBUFFERS
END 

DROP TABLE IF EXISTS #pimProductIds

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteSavedCartItem')
	DROP PROC Znode_DeleteSavedCartItem

GO

CREATE PROCEDURE [dbo].[Znode_DeleteSavedCartItem]  
(  
	@OmsCookieMappingId INT = 0,  
	@UserId INT = 0,
	@PortalId INT,
	@Status Bit OUT  
)  
/*  
 EXEC Znode_DeleteSavedCartItem  
 
*/  
 
AS  
BEGIN  
--BEGIN TRAN  
SET NOCOUNT ON;
BEGIN TRY  
	IF(@OmsCookieMappingId < 1 AND @UserId > 0)
	BEGIN
		SET @OmsCookieMappingId =(SELECT TOP 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping WITH (NOLOCK) WHERE UserId = @UserId AND ISNULL(PortalId,0) = @PortalId )
	END

    DECLARE @OmsSavedCartId INT =  ( SELECT TOP 1 OmsSavedCartId FROM ZnodeOmsSavedCart WITH (NOLOCK) WHERE OmsCookieMappingId = @OmsCookieMappingId )  
     
	 ----Adding dummy CookieMappingId if not present
	IF NOT EXISTS(SELECT * FROM ZnodeOmsCookieMapping WITH (NOLOCK) where OmsCookieMappingId = 1)
	BEGIN
		SET IDENTITY_INSERT ZnodeOmsCookieMapping ON
		INSERT INTO ZnodeOmsCookieMapping(OmsCookieMappingId,UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT 1,null,(select top 1 PortalId from ZnodePortal order by 1 ASC),2,getdate(),2,getdate()
		SET IDENTITY_INSERT ZnodeOmsCookieMapping OFF
	END

	----geting dummy OmsSavedCartId on basis of OmsCookieMappingId = 1 if not present then add
	Declare @OmsSavedCartIdDummy int = 0
	SET @OmsSavedCartIdDummy = (Select Top 1 OmsSavedCartId  from ZnodeOmsSavedCart With(NoLock) where OmsCookieMappingId = 1)
	IF Isnull(@OmsSavedCartIdDummy ,0) = 0 
	BEGIN 
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT  1,null,null,2,Getdate(),2,Getdate()
		SET @OmsSavedCartIdDummy  = @@IDENTITY
	END

	--DELETE FROM ZnodeOmsPersonalizeCartItem WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem  
	--WHERE ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId =  ZnodeOmsSavedCartLineItem.OmsSavedCartLineItemId  
	--AND ZnodeOmsSavedCartLineItem.OmsSavedCartId = @OmsSavedCartId )  
   
	UPDATE ZnodeOmsSavedCartLineItem SET OmsSavedCartId = @OmsSavedCartIdDummy
	WHERE ZnodeOmsSavedCartLineItem.OmsSavedCartId = @OmsSavedCartId  
 
  SET @Status = 1  
 
  SELECT @OmsCookieMappingId Id , CAST(1 AS BIT ) Status  
 
--COMMIT TRAN  
 
END TRY  
BEGIN CATCH  
	--ROLLBACK TRAN
    SET @Status = 1  
  
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteSavedCartItem @OmsCookieMappingId = '+CAST(@OmsCookieMappingId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
	SELECT @OmsCookieMappingId Id , CAST(0 AS BIT ) Status                  
		  
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_DeleteSavedCartItem',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall; 
    
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
				CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU , CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			BEGIN
				 SET @parenTofAddon = (SELECT TOP 1 MAX(ParentOmsSavedCartLineItemId) 
				 FROM #OldBundleSavecartLineitemDetails a
				 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
					)
			END
			ELSE
			BEGIN
				SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId
				 FROM #OldBundleSavecartLineitemDetails a
				 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
					)
			END
			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate, 
		 ab.CustomUnitPrice = ty.CustomUnitPrice  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description , CustomUnitPrice 
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WITH (NOLOCK) WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId)  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate, ab.CustomUnitPrice = b.CustomUnitPrice   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY
	,@Userid INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 

	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1), RowId	INT, OmsSavedCartLineItemId	INT, ParentOmsSavedCartLineItemId INT,OmsSavedCartId INT
		,SKU NVARCHAR(MAX) ,Quantity	NUMERIC(28,6), OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX), Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5, GroupId ,ProductName,MIN(Description) Description, 0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,
		CustomUnitPrice
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> '' THEN ConfigurableProductIds
			WHEN GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType a 
	WHERE AddOnValueIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 
	SELECT * 
	INTO #ZnodeOmsSavedCartLineItem_NT
	FROM ZnodeOmsSavedCartLineItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

	CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU NVARCHAr(2000),OrderLineItemRelationshipTypeID INT )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails
	SELECT a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,''))
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-') )
		AND b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails

	DELETE a 
	FROM #OldConfigSavecartLineitemDetails a 
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN		
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
		FROM #ZnodeOmsSavedCartLineItem_NT b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT DISTINCT SKU, STUFF(
									( SELECT ', ' + SKU FROM
										( SELECT DISTINCT SKU FROM #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a
		WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.ConfigurableProductIds SKU, STUFF(
										( SELECT ', ' + x.AddOnValueIds FROM
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldConfigSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END
	ELSE 
	BEGIN
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		 BEGIN 
			 DECLARE @parenTofAddon TABLE( ParentOmsSavedCartLineItemId INT)
			 INSERT INTO @parenTofAddon 
			 SELECT ParentOmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails a 
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				AND (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon)

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)
				AND ParentOmsSavedCartLineItemId IS NOT NULL 
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL 
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
			-- SELECT 3
			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )

			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			DELETE 
			FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 
			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
		 ELSE IF EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') = '' )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			 SELECT OmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
				 OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			 DELETE n
			 FROM #OldConfigSavecartLineitemDetails n 
			 WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem )
	
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
		END 
	END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			 		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		 
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		FROM CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate ,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewConfigSavecartLineitemDetails N
	LEFT JOIN #OldConfigSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			 ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon 
			 ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description ,ParentSKU,CustomUnitPrice 
		INTO #InsertNewConfigSavecartLineitem 
		FROM #NewConfigSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId)
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails ,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice 
		ORDER BY RowId, Id 
 	 
		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewConfigSavecartLineitem 
		WHERE Quantity <=0 
 
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS 
		( 
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU 
			FROM #InsertNewConfigSavecartLineitem m 
			INNER JOIN #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU 
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
		) 
		UPDATE m1 
		SET m1.RowId = TYU.RowId 
		FROM #InsertNewConfigSavecartLineitem m1 
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId) 
 
		;WITH VTRET AS 
		( 
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM #InsertNewConfigSavecartLineitem 
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			Having SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		) 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET) 
 
	 --Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice ) 
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId) sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description ,CustomUnitPrice 
		FROM #InsertNewConfigSavecartLineitem TH 

		SELECT MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			 
	
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND a.ParentOmsSavedCartLineItemId IS nULL 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			
		
		
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData1 r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND a.sequence in (SELECT MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WITH (NOLOCK) where a.OmsSavedCartId = ab.OmsSavedCartId AND 
			a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId ,b.SKU ,b.ParentSKU ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1 )) 
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0 )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
 
		 ;WITH table_update AS 
		 (
			 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND a.ParentOmsSavedCartLineItemId IS NULL 
			 AND EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		 )
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) 
		FROM table_update a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND b.id =1 ) 
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) IS nOT NULL 

		;WITH Cte_Th AS 
		( 
			 SELECT RowId 
			 FROM #InsertNewConfigSavecartLineitem a 
			 GROUP BY RowId 
			 HAVING COUNT(NewRowId) <= 1 
		) 
		UPDATE a 
		SET a.Quantity = NULL,a.ModifiedDate = @GetDate 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0) 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_Th TY WHERE TY.RowId = b.RowId ) 
			AND a.OrderLineItemRelationshipTypeId IS NULL 
 
		UPDATE ZnodeOmsSavedCartLineItem 
		SET GROUPID = NULL 
		WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		AND OrderLineItemRelationshipTypeId IS NOT NULL 
 
		;WITH Cte_UpdateSequence AS 
		( 
			 SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence 
			 FROM ZnodeOmsSavedCartLineItem 
			 WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		) 
		UPDATE Cte_UpdateSequence 
		SET Sequence = RowId 

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.ConfigurableProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE 
		FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			 ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			 WHEN NOT MATCHED THEN 
				INSERT ( OmsSavedCartLineItemId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES ( SOURCE.OmsSavedCartLineItemId, @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END
	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
)
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,CustomUnitPrice  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
		,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.GroupProductIds SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldGroupSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldGroupSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS  NULL  

			IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 
			-- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		END
		ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END 
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END  
	END

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (
				SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues)) 
				OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
				(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN
			DELETE n 
			FROM #OldGroupSavecartLineitemDetails n 
			WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.GroupProductIds
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.GroupProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
				--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE ISNULL(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
			a.Custom1 = ty.Custom1,
			a.Custom2 = ty.Custom2,
			a.Custom3 = ty.Custom3,
			a.Custom4 = ty.Custom4,
			a.Custom5 = ty.Custom5,
			a.ModifiedDate = @GetDate ,
			a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		UPDATE a
		SET a.Quantity = a.Quantity+s.AddOnQuantity,
			a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewGroupSavecartLineitemDetails N
	LEFT JOIN #OldGroupSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		INTO #InsertNewGroupSavecartLineitem   
		FROM #NewGroupSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId) OR ParentSKU IS NULL
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU, CustomUnitPrice
		ORDER BY RowId, Id

		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewGroupSavecartLineitem
		WHERE Quantity <=0
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS
		(
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU
			FROM #InsertNewGroupSavecartLineitem m
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		)
		UPDATE m1   
		SET m1.RowId = TYU.RowId
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE 
		FROM #InsertNewGroupSavecartLineitem 
		WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
		OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description, CustomUnitPrice
		FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS nULL   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
		-----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WITH (NOLOCK) where a.OmsSavedCartId = ab.OmsSavedCartId and 
				a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		----------------------------------------------------------------------------------------------------------------------------

		SELECT DISTINCT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

		---- Added to get distinct records.
		--SELECT *,ROW_NUMBER()OVER(ORDER BY OmsSavedCartLineItemId) RowIdNo 
		--INTO #Cte_newAddon 
		--FROM #Cte_newAddon1

		SELECT DISTINCT OmsSavedCartLineItemId,RowId,SKU,ParentSKU,MIN(RowIdNo) As RowIdNo
		INTO #Cte_newAddon1
		FROM #Cte_newAddon
		GROUP BY OmsSavedCartLineItemId,RowId,SKU,ParentSKU;

		DELETE FROM #Cte_newAddon;

		INSERT INTO #Cte_newAddon
		SELECT OmsSavedCartLineItemId,RowId,SKU,ParentSKU,ROW_NUMBER() OVER (ORDER BY RowId,RowIdNo) As RowIdNo
		FROM #Cte_newAddon1;

		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
				AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
				AND a.ParentOmsSavedCartLineItemId IS NULL  
				AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
				AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		)
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewGroupSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		 )
		UPDATE a 
		SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
			AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  

		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END 

	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderLineItems_ParentOmsOrderLineItemsId_Sku' AND object_id = OBJECT_ID('ZnodeOmsOrderLineItems'))
BEGIN
	 CREATE INDEX IX_ZnodeOmsOrderLineItems_ParentOmsOrderLineItemsId_Sku
		ON dbo.ZnodeOmsOrderLineItems (ParentOmsOrderLineItemsId, Sku) INCLUDE (OrderLineItemRelationshipTypeId, OmsOrderDetailsId)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsTaxRule_OmsOrderId_DestinationCountryCode_DestinationStateCode' AND object_id = OBJECT_ID('ZnodeOmsTaxRule'))
BEGIN
	CREATE INDEX IX_ZnodeOmsTaxRule_OmsOrderId_DestinationCountryCode_DestinationStateCode
		ON dbo.ZnodeOmsTaxRule (OmsOrderId,DestinationCountryCode, DestinationStateCode)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeAccountUserPermisasion_UserId' AND object_id = OBJECT_ID('ZnodeAccountUserPermission'))
BEGIN
	CREATE INDEX IX_ZnodeAccountUserPermisasion_UserId ON dbo.ZnodeAccountUserPermission (UserId)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsTaxRule_OmsOrderId' AND object_id = OBJECT_ID('ZnodeOmsTaxRule'))
BEGIN
	CREATE INDEX IX_ZnodeOmsTaxRule_OmsOrderId ON dbo.ZnodeOmsTaxRule (OmsOrderId)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeAccountUserPermission_UserId' AND object_id = OBJECT_ID('ZnodeAccountUserPermission'))
BEGIN
	CREATE INDEX IX_ZnodeAccountUserPermission_UserId ON dbo.ZnodeAccountUserPermission (UserId) INCLUDE (AccountPermissionAccessId)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeState_StateName' AND object_id = OBJECT_ID('ZnodeState'))
BEGIN
	CREATE INDEX IX_ZnodeState_StateName ON dbo.ZnodeState (StateName)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderLineItems_ParentOmsOrderLineItemsId' AND object_id = OBJECT_ID('ZnodeOmsOrderLineItems'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderLineItems_ParentOmsOrderLineItemsId ON dbo.ZnodeOmsOrderLineItems
		(ParentOmsOrderLineItemsId) INCLUDE (OrderLineItemRelationshipTypeId, OmsOrderDetailsId, Sku)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDiscount_OmsOrderDetailsId' AND object_id = OBJECT_ID('ZnodeOmsOrderDiscount'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderDiscount_OmsOrderDetailsId ON dbo.ZnodeOmsOrderDiscount (OmsOrderDetailsId)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderLineItems_OmsOrderDetailsId_ParentOmsOrderLineItemsId' AND object_id = OBJECT_ID('ZnodeOmsOrderLineItems'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderLineItems_OmsOrderDetailsId_ParentOmsOrderLineItemsId 
		ON dbo.ZnodeOmsOrderLineItems (OmsOrderDetailsId,ParentOmsOrderLineItemsId) 
			INCLUDE (ProductName)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderLineItems_OmsOrderDetailsId_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderLineItems'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderLineItems_OmsOrderDetailsId_IsActive 
		ON dbo.ZnodeOmsOrderLineItems (OmsOrderDetailsId, IsActive) 
			INCLUDE (OrderLineItemStateId)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderLineItems_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderLineItems'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderLineItems_IsActive ON dbo.ZnodeOmsOrderLineItems (IsActive) INCLUDE (OmsOrderDetailsId, OrderLineItemStateId)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeState_StateCode' AND object_id = OBJECT_ID('ZnodeState'))
BEGIN
	CREATE INDEX IX_ZnodeState_StateCode ON dbo.ZnodeState (StateCode)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_IsActive_SKULower' AND object_id = OBJECT_ID('ZnodePublishProductEntity'))
BEGIN
	CREATE INDEX IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_IsActive_SKULower 
		ON dbo.ZnodePublishProductEntity (VersionId, ZnodeCatalogId, LocaleId, IsActive, SKULower)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_SKULower' AND object_id = OBJECT_ID('ZnodePublishProductEntity'))
BEGIN
	CREATE INDEX IX_ZnodePublishProductEntity_VersionId_ZnodeCatalogId_LocaleId_SKULower ON dbo.ZnodePublishProductEntity (VersionId, ZnodeCatalogId, LocaleId, SKULower)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeUser_Email' AND object_id = OBJECT_ID('ZnodeUser'))
BEGIN
	CREATE INDEX IX_ZnodeUser_Email ON dbo.ZnodeUser (Email)
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderLineItems_OmsOrderDetailsId_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderLineItems'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderLineItems_OmsOrderDetailsId_IsActive ON dbo.ZnodeOmsOrderLineItems (OmsOrderDetailsId, IsActive)
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ExportFormSubmissions')
	DROP PROC Znode_ExportFormSubmissions

GO

CREATE PROCEDURE [dbo].[Znode_ExportFormSubmissions] 
(
    @WhereClause NVARCHAR(MAX),
	@FileType NVARCHAR(20),
	@Status	BIT = 0 OUT
)
/*
	Summary: 
		This Procedure is used to export FormSubmissions data based on input values.

	Unit Testing :
		EXEC Znode_ExportFormSubmissions @WhereClause='',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'formcode like ''%BottleSuggestionForm%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'storename like ''%QA Znode Bottles%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'username like ''%shubham.yende@yopmail.com%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'fullname like ''%Tapesh D%''',@FileType=N'CSV',@Status=1
		EXEC Znode_ExportFormSubmissions @WhereClause=N'CreatedDate between ''05/19/2022 12:00:00 am'' and ''05/19/2022 11:59:59 pm''',@FileType=N'CSV',@Status=1

*/
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		DECLARE @ExportProcessLogId INT = 0, @Count INT, @Table NVARCHAR(MAX), @GLobalAttributeCode NVARCHAR(MAX), @SSQLString NVARCHAR(MAX);
		DECLARE @Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		SET @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause);

		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'FormCode','ZFB.FormCode')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'StoreName','ZP.StoreName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'UserName','ZU.UserName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'FullName','ZU.FullName')
		SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'CreatedDate','SS.CreatedDate')
			
		INSERT INTO ZnodeExportProcessLog (ExportType,FileType,[Status],ProcessStartedDate,ProcessCompletedDate,TableName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT 'FormSubmissions',@FileType,'Started',GETDATE(),NULL,NULL,3,GETDATE(),3,GETDATE()

		SET @ExportProcessLogId = SCOPE_IDENTITY()

		SET @Table = 'ExportFormSubmissions'+'_'+ CAST(@ExportProcessLogId As VARCHAR(20));

		UPDATE ZnodeExportProcessLog
		SET TableName = @Table
		WHERE ExportProcessLogId = @ExportProcessLogId;

		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
					
		SELECT A.FormBuilderSubmitId,C.AttributeCode
			,CASE WHEN B.MediaPath IS NOT NULL THEN RIGHT(B.MediaPath,LEN(B.MediaPath)-(CHARINDEX('--',B.MediaPath,1)+1)) ELSE B.AttributeValue END As AttributeValue
			, B.GlobalAttributeDefaultValueId, B.LocaleId
		INTO #GlobalAttribute
		FROM ZnodeFormBuilderGlobalAttributeValue A WITH (NOLOCK)
		INNER JOIN ZnodeFormBuilderGlobalAttributeValueLocale B WITH (NOLOCK) ON B.FormBuilderGlobalAttributeValueId=A.FormBuilderGlobalAttributeValueId
		INNER JOIN ZnodeGlobalAttribute C WITH (NOLOCK) ON C.GlobalAttributeId=A.GlobalAttributeId;

		UPDATE aa
		SET AttributeValue=CASE WHEN aa.AttributeValue IS NULL THEN RIGHT(h.AttributeDefaultValueCode,LEN(h.AttributeDefaultValueCode)-(CHARINDEX('--',h.AttributeDefaultValueCode,1)+1)) ELSE aa.AttributeValue END
		FROM #GlobalAttribute aa
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValue h ON h.GlobalAttributeDefaultValueId = aa.GlobalAttributeDefaultValueId
		WHERE ISNULL(aa.AttributeValue,'')='';

		UPDATE h
		SET h.AttributeValue=RIGHT(g.AttributeDefaultValue,LEN(g.AttributeDefaultValue)-(CHARINDEX('--',g.AttributeDefaultValue,1)+1))
		FROM #GlobalAttribute h
		INNER JOIN dbo.ZnodeGlobalAttributeDefaultValueLocale g ON h.GlobalAttributeDefaultValueId = g.GlobalAttributeDefaultValueId
        WHERE ISNULL(h.AttributeValue,'')='' AND g.LocaleId=h.LocaleId;

		ALTER TABLE #GlobalAttribute DROP COLUMN IF EXISTS GlobalAttributeDefaultValueId;
		ALTER TABLE #GlobalAttribute DROP COLUMN IF EXISTS LocaleId;
		
		SELECT @GLobalAttributeCode = STUFF((
		SELECT DISTINCT ',' + AttributeCode
		FROM #GlobalAttribute
		FOR XML PATH('') 
		), 1, 1, '');

		SET @SSQLString ='SELECT * INTO ##GLobalAttributeData
		FROM (
		SELECT FormBuilderSubmitId,AttributeCode, AttributeValue FROM #GlobalAttribute
		)T
		PIVOT(MAX(Attributevalue) FOR AttributeCode IN ('+@GLobalAttributeCode+'))PIV'

		EXEC (@SSQLString);
		
		SET @SSQLString='SELECT ZFB.FormCode,ZP.StoreName,ZU.UserName,ZU.FullName,SS.CreatedDate,V.*
		INTO '+@Table+'
		FROM ZnodeFormBuilderSubmit ss WITH (NOLOCK) 
		INNER JOIN ZnodeFormBuilder ZFB WITH (NOLOCK) on SS.FormBuilderId=ZFB.FormBuilderId
		INNER JOIN ZnodePortal ZP WITH (NOLOCK) ON ZP.PortalId=SS.PortalId 
		LEFT JOIN View_CustomerUserDetail ZU WITH (NOLOCK) ON ZU.UserId=SS.UserId												
		LEFT JOIN ##GLobalAttributeData V ON (V.FormBuilderSubmitId=SS.FormBuilderSubmitId)
		WHERE 1=1 '+ @Fn_GetFilterWhereClause+'
		'		
		EXEC (@SSQLString);
		
		SET @Count = @@ROWCOUNT;
				
		IF OBJECT_ID('tempdb..[#GlobalAttribute]') IS NOT NULL
			DROP TABLE tempdb..[#GlobalAttribute];

		IF OBJECT_ID('tempdb..[##GLobalAttributeData]') IS NOT NULL
			DROP TABLE tempdb..[##GLobalAttributeData];
				
		UPDATE ZnodeExportProcessLog 
		SET [Status]= 'In Progress',
			ProcessCompletedDate = GETDATE()
		WHERE ExportProcessLogId =@ExportProcessLogId;

		SELECT TableName
		FROM ZnodeExportProcessLog
		WHERE ExportProcessLogId = @ExportProcessLogId;

		SELECT @Count As [Count];

		SET @Status = 1;
	END TRY
 
	BEGIN CATCH
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'Znode_ExportFormSubmissions 
					@WhereClause = '+CAST(@WhereClause AS NVARCHAR(MAX))+',
					@FileType='+CAST(@FileType AS VARCHAR(20))+',
					@Status='+CAST(@Status AS VARCHAR(10));
		
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ExportFormSubmissions',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_OmsOrderId_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_OmsOrderId_IsActive] ON [dbo].[ZnodeOmsOrderDetails] ([OmsOrderId], [IsActive])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_OmsOrderId' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderDetails_OmsOrderId ON [dbo].[ZnodeOmsOrderDetails] ([OmsOrderId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_PortalId_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_PortalId_IsActive] ON [dbo].[ZnodeOmsOrderDetails] ([PortalId], [IsActive]) INCLUDE ([OmsOrderId], [UserId], [OmsOrderStateId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_PortalId_IsActive_OrderDate' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_PortalId_IsActive_OrderDate] ON [dbo].[ZnodeOmsOrderDetails] ([PortalId], [IsActive],[OrderDate]) INCLUDE ([OmsOrderId], [OmsOrderStateId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_IsActive_PortalId_OrderDate' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_IsActive_PortalId_OrderDate] ON [dbo].[ZnodeOmsOrderDetails] ([IsActive],[PortalId], [OrderDate]) INCLUDE ([OmsOrderId], [OmsOrderStateId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_IsActive] ON [dbo].[ZnodeOmsOrderDetails] ([IsActive]) INCLUDE ([PortalId], [UserId], [CurrencyCode], [Total])
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_CatalogProductDraftForPublish')
	DROP PROC Znode_CatalogProductDraftForPublish

GO

CREATE PROCEDURE Znode_CatalogProductDraftForPublish
(
	@PublishCatalogId INT
)
AS
BEGIN
BEGIN TRY 
SET NOCOUNT ON 
	SELECT ZPCP.PimProductId
	INTO #DraftProduct
	FROM ZnodePimCategoryProduct ZPCP WITH(NOLOCK)
	INNER JOIN ZnodePimCategoryHierarchy ZPCH WITH(NOLOCK) ON ZPCP.PimCategoryId = ZPCH.PimCategoryId 
	WHERE ZPCH.PimCatalogId = @PublishCatalogId

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP 
	WHERE EXISTS(SELECT * FROM #DraftProduct DP WHERE ZPP.PimProductId = DP.PimProductId)

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimProductTypeAssociation PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimLinkProductDetail PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP WITH(NOLOCK)
	where EXISTS(SELECT * FROM ZnodePimLinkProductDetail PTA WITH(NOLOCK) WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE PTA.PimParentProductId = DP.PimProductId))

	Update ZPP SET PublishStateId = 2, IsProductPublish = 0 , ModifiedDate = GETDATE() 
	FROM ZnodePimProduct ZPP
	where EXISTS(SELECT * FROM ZnodePimAddOnProduct PTA WITH(NOLOCK)
			INNER JOIN ZnodePimAddOnProductDetail ZPA1 WITH(NOLOCK) ON PTA.PimAddOnProductId = ZPA1.PimAddOnProductId
			WHERE ZPP.PimProductId = PTA.PimProductId 
			AND EXISTS(SELECT * FROM #DraftProduct DP WHERE ZPA1.PimChildProductId = DP.PimProductId))
END TRY
BEGIN CATCH
    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(200));

    EXEC Znode_InsertProcedureErrorLog
        @ProcedureName = 'Znode_CatalogProductDraftForPublish',
        @ErrorInProcedure = @Error_procedure,
        @ErrorMessage = @ErrorMessage,
        @ErrorLine = @ErrorLine,
        @ErrorCall = @ErrorCall;
           
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable

GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY
	,@Userid INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 

	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1), RowId	INT, OmsSavedCartLineItemId	INT, ParentOmsSavedCartLineItemId INT,OmsSavedCartId INT
		,SKU NVARCHAR(MAX) ,Quantity	NUMERIC(28,6), OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX), Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5, GroupId ,ProductName,MIN(Description) Description, 0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,
		CustomUnitPrice
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> '' THEN ConfigurableProductIds
			WHEN GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType a 
	WHERE AddOnValueIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 
	SELECT * 
	INTO #ZnodeOmsSavedCartLineItem_NT
	FROM ZnodeOmsSavedCartLineItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

	CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU NVARCHAr(2000),OrderLineItemRelationshipTypeID INT )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails
	SELECT a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,''))
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-') )
		AND b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails

	DELETE a 
	FROM #OldConfigSavecartLineitemDetails a 
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN		
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
		FROM #ZnodeOmsSavedCartLineItem_NT b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT DISTINCT SKU, STUFF(
									( SELECT ', ' + SKU FROM
										( SELECT DISTINCT SKU FROM #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a
		WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.ConfigurableProductIds SKU, STUFF(
										( SELECT ', ' + x.AddOnValueIds FROM
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldConfigSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END
	ELSE 
	BEGIN
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		 BEGIN 
			 DECLARE @parenTofAddon TABLE( ParentOmsSavedCartLineItemId INT)
			 INSERT INTO @parenTofAddon 
			 SELECT ParentOmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails a 
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				AND (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon)

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)
				AND ParentOmsSavedCartLineItemId IS NOT NULL 
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL 
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
			-- SELECT 3
			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )

			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			DELETE 
			FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 
			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
		 ELSE IF EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') = '' )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			 SELECT OmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
				 OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			 DELETE n
			 FROM #OldConfigSavecartLineitemDetails n 
			 WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem )
	
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
		END 
	END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			 		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		 
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		FROM CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate ,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewConfigSavecartLineitemDetails N
	LEFT JOIN #OldConfigSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			 ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon 
			 ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description ,ParentSKU,CustomUnitPrice 
		INTO #InsertNewConfigSavecartLineitem 
		FROM #NewConfigSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId)
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails ,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice 
		ORDER BY RowId, Id 
 	 
		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewConfigSavecartLineitem 
		WHERE Quantity <=0 
 
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS 
		( 
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU 
			FROM #InsertNewConfigSavecartLineitem m 
			INNER JOIN #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU 
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
		) 
		UPDATE m1 
		SET m1.RowId = TYU.RowId 
		FROM #InsertNewConfigSavecartLineitem m1 
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId) 
 
		;WITH VTRET AS 
		( 
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM #InsertNewConfigSavecartLineitem 
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			Having SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		) 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET) 
 
	 --Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice ) 
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId) sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description ,CustomUnitPrice 
		FROM #InsertNewConfigSavecartLineitem TH 

		SELECT MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			 
	
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND a.ParentOmsSavedCartLineItemId IS nULL 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		Select * into #ZnodeOmsSavedCartLineItem_MinSequence  from ZnodeOmsSavedCartLineItem a  with (nolock)  where exists
		(Select TOP 1 1 From #InsertNewConfigSavecartLineitem X where  X.OmsSavedCartId = a.OmsSavedCartId and a.SKU = X.SKU  and X.id =1)
		
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData1 r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND a.sequence in ( SELECT MIN(ab.sequence) FROM #ZnodeOmsSavedCartLineItem_MinSequence ab with (nolock) where a.OmsSavedCartId = ab.OmsSavedCartId AND 
			a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null )

			--AND a.sequence in (SELECT MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab with (nolock) where a.OmsSavedCartId = ab.OmsSavedCartId AND 
			--a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId ,b.SKU ,b.ParentSKU ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1 )) 
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0 )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
 
		SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId ) RowIdNo
			 into #table_update
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND a.ParentOmsSavedCartLineItemId IS NULL 
			 AND EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

		 --;WITH table_update AS 
		 --(
			-- SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId ) RowIdNo
			-- FROM ZnodeOmsSavedCartLineItem a with (nolock)
			-- WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			-- AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			-- AND a.ParentOmsSavedCartLineItemId IS NULL 
			-- AND EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			-- AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		 --)
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 MAX(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND c.SKU = r.SKU AND c.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) 
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #table_update c ON a.OmsSavedCartLineItemId=c.OmsSavedCartLineItemId
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (c.OmsSavedCartId = b.OmsSavedCartId AND c.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND b.id =1 ) 
		WHERE (SELECT TOP 1 MAX(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND c.SKU = r.SKU AND c.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) IS NOT NULL 

		;WITH Cte_Th AS 
		( 
			 SELECT RowId 
			 FROM #InsertNewConfigSavecartLineitem a 
			 GROUP BY RowId 
			 HAVING COUNT(NewRowId) <= 1 
		) 
		UPDATE a 
		SET a.Quantity = NULL,a.ModifiedDate = @GetDate 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0) 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_Th TY WHERE TY.RowId = b.RowId ) 
			AND a.OrderLineItemRelationshipTypeId IS NULL 
 
		UPDATE ZnodeOmsSavedCartLineItem 
		SET GROUPID = NULL 
		WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		AND OrderLineItemRelationshipTypeId IS NOT NULL 
 
		;WITH Cte_UpdateSequence AS 
		( 
			 SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence 
			 FROM ZnodeOmsSavedCartLineItem 
			 WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		) 
		UPDATE Cte_UpdateSequence 
		SET Sequence = RowId 

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.ConfigurableProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE 
		FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			 ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			 WHEN NOT MATCHED THEN 
				INSERT ( OmsSavedCartLineItemId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES ( SOURCE.OmsSavedCartLineItemId, @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END
	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int , IsAssocitedProduct bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

---To draft all catalog products AND associated products for full catalog publish  
    IF @IsDraftProductsOnly = 0  
    BEGIN 
        EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PimCatalogId   
    END 

If @PimProductId = 0
    INSERT INTO #PimProduct_catalog 
    SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
        ,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
    FROM ZnodePimCategoryProduct a with(nolock)
    INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
    WHERE b.PimCatalogId = @PimCatalogId
    AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
    AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) and 
    Exists (Select TOP 1 1 From ZnodePimProduct X with (Nolock) Where X.PimProductId = a.PimProductId and X.PublishStateId <> 3 )
else 
    INSERT INTO #PimProduct_catalog 
    SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
        ,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
    FROM ZnodePimCategoryProduct a with(nolock)
    INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
    WHERE b.PimCatalogId = @PimCatalogId
    AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
    AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0,0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity,RequiredType
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


-- SELECT * FROM ZnodePimAddOnProduct
INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 ,0
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity, 1
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 



SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 


UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId  AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)



SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 

TRUNCATE TABLE ZnodePublishProductEntityLog

DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


 DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

INSERT INTO ZnodePublishProductEntityLog
SELECT *
FROM ZnodePublishProductEntity ty with(nolock) 
WHERE EXISTS (SELECT TOP 1 1 FROM  #insertedPublishEntity tu WHERE tu.PublishProductEntityId = ty.PublishProductEntityId AND tu.PublishProductEntityId <> 0 )

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
--WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,a.LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = a.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
INNER JOIN @Versions_working h ON (h.LocaleId = a.LocaleId) 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues
, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n 
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId AND n.LocaleId = q.LocaleId),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId AND b.IsAssocitedProduct =1 )
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault,q.LocaleId

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,0) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 
 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity.VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,IIF(RequiredType='requierd',1,0) IsRequired, RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	AND @PimProductId = 0 

	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END 

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_OmsOrderId_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_OmsOrderId_IsActive] ON [dbo].[ZnodeOmsOrderDetails] ([OmsOrderId], [IsActive])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_OmsOrderId' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX IX_ZnodeOmsOrderDetails_OmsOrderId ON [dbo].[ZnodeOmsOrderDetails] ([OmsOrderId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_PortalId_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_PortalId_IsActive] ON [dbo].[ZnodeOmsOrderDetails] ([PortalId], [IsActive]) INCLUDE ([OmsOrderId], [UserId], [OmsOrderStateId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_PortalId_IsActive_OrderDate' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_PortalId_IsActive_OrderDate] ON [dbo].[ZnodeOmsOrderDetails] ([PortalId], [IsActive],[OrderDate]) INCLUDE ([OmsOrderId], [OmsOrderStateId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_IsActive_PortalId_OrderDate' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_IsActive_PortalId_OrderDate] ON [dbo].[ZnodeOmsOrderDetails] ([IsActive],[PortalId], [OrderDate]) INCLUDE ([OmsOrderId], [OmsOrderStateId])
END

GO

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'IX_ZnodeOmsOrderDetails_IsActive' AND object_id = OBJECT_ID('ZnodeOmsOrderDetails'))
BEGIN
	CREATE INDEX [IX_ZnodeOmsOrderDetails_IsActive] ON [dbo].[ZnodeOmsOrderDetails] ([IsActive]) INCLUDE ([PortalId], [UserId], [CurrencyCode], [Total])
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO

CREATE PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
--DECLARE #pimProductIds  TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT, VersionId INT  )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId ,VersionId
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
--AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

CREATE INDEX IDX_#pimProductIds ON #pimProductIds(PimProductId)

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID


DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId

--INSERT INTO #pimProductIds 
--SELECT  PimProductId 
--FROM #pimProductIds 

SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  #pimProductIds  t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, 0 , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId and aa.PimAttributeId = a.PimAttributeId 
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN #pimProductIds  bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT DISTINCT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #pimProductIds  n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct w WHERE w.VersionId = a.VersionId)

CREATE TABLE #tbl_AttributeValueLocale (PimProductId INT ,   AttributeValue NVARCHAR(max), PimAttributeId INT  , LocaleId INT)
CREATE TABLE #default_valuelocale (PimAttributeDefaultValueId INT , AttributeDefaultValue NVARCHAR(max), LocaleId int  )





IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct WHERE LocaleId <> @DefaultLocaleId )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   WHERE m.LocaleId <> @DefaultLocaleId

   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

    --SELECT * FROM #tbl_AttributeValue

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   LEFT JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   LEFT JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId)
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId
 


   INSERT INTO #default_valuelocale
   SELECT  bc.PimAttributeDefaultValueId, bc.AttributeDefaultValue, bc.LocaleId 
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE bc.LocaleId <> @DefaultLocaleId
   



END 
--LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
   --SELECT * FROM #tbl_AttributeValueLocale

    DROP TABLE IF EXISTS #tbl_ProductValueid

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID
	
	DECLARE @t transferId 

	WHILE EXISTS (SELECT TOP 1 1 FROM #PublishProductEntityId)
	BEGIN 
	
	INSERT INTO @t
	SELECT TOP 50000 PublishProductEntityId
	FROM #PublishProductEntityId

UPDATE m
SET m.Attributes = (SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', Isnull(f.CustomKey,a.CustomCode),b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(IIF(ut.AttributeValue IS NULL , a.AttributeValue,ut.AttributeValue),'') AttributeValues
				,ISNULL((
				   SELECT   Code,m.LocaleId,IIF(AttributeDefaultValue IS NULL ,Value, AttributeDefaultValue) Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   LEFT JOIN #default_valuelocale op ON (op.PimAttributeDefaultValueId = nt.PimAttributeDefaultValueId AND op.LocaleId = m.LocaleId )
				   WHERE nt.PimProductId = m.ZnodeProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId =@DefaultLocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = m.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =m.LocaleId)
WHERE a.PimProductId = m.ZnodeProductId AND a.LocaleId = @DefaultLocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
    )

FROM ZnodePublishProductEntity m
WHERE EXISTS (SELECT TOP 1 1  FROM @t p WHERE p.id = m.PublishProductEntityId)
OPTION (RECOMPILE)

UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValueLocale ty ON ( ty.PimProductId = a.ZnodeProductId AND ty.LocaleId = a.LocaleId 
	AND ty.PimAttributeId = (SELECT TOP 1 w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')  )
WHERE PublishProductEntityId  IN (SELECT Id FROM @t)
AND a.LocaleId <> @DefaultLocaleId
	
	DELETE FROM #PublishProductEntityId WHERE EXISTS (SELECT TOP 1 1 FROM @t WHERE id = PublishProductEntityId)
	DELETE FROM @t
	IF IS_SRVROLEMEMBER('sysadmin', SUSER_NAME())=1
	DBCC DROPCLEANBUFFERS
END 

DROP TABLE IF EXISTS #pimProductIds

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int , IsAssocitedProduct bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

---To draft all catalog products AND associated products for full catalog publish  
    IF @IsDraftProductsOnly = 0  
    BEGIN 
        EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PimCatalogId   
    END 

--If @PimProductId = 0
--    INSERT INTO #PimProduct_catalog 
--    SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
--        ,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
--    FROM ZnodePimCategoryProduct a with(nolock)
--    INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
--    WHERE b.PimCatalogId = @PimCatalogId
--    AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
--    AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) and 
--    Exists (Select TOP 1 1 From ZnodePimProduct X with (Nolock) Where X.PimProductId = a.PimProductId and X.PublishStateId <> 3 )
--else 
    INSERT INTO #PimProduct_catalog 
    SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
        ,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
    FROM ZnodePimCategoryProduct a with(nolock)
    INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
    WHERE b.PimCatalogId = @PimCatalogId
    AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
    AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0,0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity,RequiredType
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


-- SELECT * FROM ZnodePimAddOnProduct
INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 ,0
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity, 1
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 



SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 


UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId  AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)



SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 

TRUNCATE TABLE ZnodePublishProductEntityLog

DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


 DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

INSERT INTO ZnodePublishProductEntityLog
SELECT *
FROM ZnodePublishProductEntity ty with(nolock) 
WHERE EXISTS (SELECT TOP 1 1 FROM  #insertedPublishEntity tu WHERE tu.PublishProductEntityId = ty.PublishProductEntityId AND tu.PublishProductEntityId <> 0 )

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
--WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,a.LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = a.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
INNER JOIN @Versions_working h ON (h.LocaleId = a.LocaleId) 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues
, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n 
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId AND n.LocaleId = q.LocaleId),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId AND b.IsAssocitedProduct =1 )
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault,q.LocaleId

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)

UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,0) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 
 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity.VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,IIF(RequiredType='requierd',1,0) IsRequired, RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	AND @PimProductId = 0 

	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int , IsAssocitedProduct bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID
	
	---To draft all catalog products AND associated products for full catalog publish  
	IF @IsDraftProductsOnly = 0  
	BEGIN 
		EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PimCatalogId   
	END 

--If @PimProductId = 0
--	INSERT INTO #PimProduct_catalog 
--	SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
--		,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
--	FROM ZnodePimCategoryProduct a with(nolock)
--	INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
--	WHERE b.PimCatalogId = @PimCatalogId
--	AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
--	AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 ) and 
--	Exists (Select TOP 1 1 From ZnodePimProduct X with (Nolock) Where X.PimProductId = a.PimProductId and X.PublishStateId <> 3 )
--else 
	INSERT INTO #PimProduct_catalog 
	SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
		,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
	FROM ZnodePimCategoryProduct a with(nolock)
	INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
	WHERE b.PimCatalogId = @PimCatalogId
	AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
	AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 )  


INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0,0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity,RequiredType
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


-- SELECT * FROM ZnodePimAddOnProduct
INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 ,0
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity, 1
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 



SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 


UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId  AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)


SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 

TRUNCATE TABLE ZnodePublishProductEntityLog

DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

INSERT INTO ZnodePublishProductEntityLog
SELECT *
FROM ZnodePublishProductEntity ty with(nolock) 
WHERE EXISTS (SELECT TOP 1 1 FROM  #insertedPublishEntity tu WHERE tu.PublishProductEntityId = ty.PublishProductEntityId AND tu.PublishProductEntityId <> 0 )

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
--WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

 --IF  EXISTS ( SELECT TOP 1 1 FROM @pimProductId_oi )
 --BEGIN 

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring

--END 

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,a.LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = a.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
INNER JOIN @Versions_working h ON (h.LocaleId = a.LocaleId) 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues
, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n 
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId AND n.LocaleId = q.LocaleId),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId AND b.IsAssocitedProduct =1 )
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault,q.LocaleId

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)


UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,0) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)


-- Remove Non Variant Bundle products
    Select  ZnodeProductId  into #DeletedBundleId  FROM ZnodePublishBundleProductEntity a Where Not exists (
    Select TOP 1 1  from ZnodePimProductTypeAssociation X where a.ZnodeProductId = X.PimParentProductId )
    
    Update A SET a.ElasticSearchEvent =2 from  ZnodePublishProductEntity A Inner Join #DeletedBundleId B on  a.ZnodeProductId  = B.ZnodeProductId
    
    DELETE a FROM ZnodePublishBundleProductEntity a Where exists (
    Select TOP 1 1  from #DeletedBundleId X where a.ZnodeProductId = X.ZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 
 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity.VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,IIF(RequiredType='requierd',1,0) IsRequired, RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	AND @PimProductId = 0 

	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO

CREATE PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
--DECLARE #pimProductIds  TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT, VersionId INT  )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId ,VersionId
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
--AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

CREATE INDEX IDX_#pimProductIds ON #pimProductIds(PimProductId)

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID


DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId



SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  #pimProductIds  t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue 
			,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, c.PimCustomFieldId , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 1 Iscustomfield
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId and aa.PimAttributeId = a.PimAttributeId 
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN #pimProductIds  bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT DISTINCT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #pimProductIds  n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct w WHERE w.VersionId = a.VersionId)

CREATE TABLE #tbl_AttributeValueLocale (PimProductId INT ,   AttributeValue NVARCHAR(max), PimAttributeId INT  , LocaleId INT)
CREATE TABLE #default_valuelocale (PimAttributeDefaultValueId INT , AttributeDefaultValue NVARCHAR(max), LocaleId int  )

IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct WHERE LocaleId <> @DefaultLocaleId )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   WHERE m.LocaleId <> @DefaultLocaleId

   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

    --SELECT * FROM #tbl_AttributeValue

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   LEFT JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId AND a.Iscustomfield = 0 )
   LEFT JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId AND a.Iscustomfield = 0 )
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId
 


   INSERT INTO #default_valuelocale
   SELECT  bc.PimAttributeDefaultValueId, bc.AttributeDefaultValue, bc.LocaleId 
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE bc.LocaleId <> @DefaultLocaleId
   



END 
--LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
   --SELECT * FROM #tbl_AttributeValueLocale

    DROP TABLE IF EXISTS #tbl_ProductValueid

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID
	
	DECLARE @t transferId 

	WHILE EXISTS (SELECT TOP 1 1 FROM #PublishProductEntityId)
	BEGIN 
	
	INSERT INTO @t
	SELECT TOP 50000 PublishProductEntityId
	FROM #PublishProductEntityId

UPDATE m
SET m.Attributes = (SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(IIF(ut.AttributeValue IS NULL , a.AttributeValue,ut.AttributeValue),'') AttributeValues
				,ISNULL((
				   SELECT   Code,m.LocaleId,IIF(AttributeDefaultValue IS NULL ,Value, AttributeDefaultValue) Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   LEFT JOIN #default_valuelocale op ON (op.PimAttributeDefaultValueId = nt.PimAttributeDefaultValueId AND op.LocaleId = m.LocaleId )
				   WHERE nt.PimProductId = m.ZnodeProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId =@DefaultLocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId 
										AND ut.LocaleId = m.LocaleId)
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = m.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =m.LocaleId AND a.Iscustomfield = 0 )
WHERE a.PimProductId = m.ZnodeProductId AND a.LocaleId = @DefaultLocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
    )

FROM ZnodePublishProductEntity m
WHERE EXISTS (SELECT TOP 1 1  FROM @t p WHERE p.id = m.PublishProductEntityId)
OPTION (RECOMPILE)

UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValueLocale ty ON ( ty.PimProductId = a.ZnodeProductId AND ty.LocaleId = a.LocaleId 
	AND ty.PimAttributeId = (SELECT TOP 1 w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')  )
WHERE PublishProductEntityId  IN (SELECT Id FROM @t)
AND a.LocaleId <> @DefaultLocaleId
	
	DELETE FROM #PublishProductEntityId WHERE EXISTS (SELECT TOP 1 1 FROM @t WHERE id = PublishProductEntityId)
	DELETE FROM @t
	IF IS_SRVROLEMEMBER('sysadmin', SUSER_NAME())=1
	DBCC DROPCLEANBUFFERS
END 

DROP TABLE IF EXISTS #pimProductIds

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSCustomerReviewInformation')
	DROP PROC Znode_GetCMSCustomerReviewInformation

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSCustomerReviewInformation]
( @WhereClause NVARCHAR(Max),
  @Rows        INT           = 100,
  @PageNo      INT           = 1,
  @Order_BY    VARCHAR(1000)  = '',
  @RowsCount   INT OUT,
  @LocaleId    INT           = 0,
  @PortalId    INT           = 0
  )
AS
/*
 Summary : Procedure is used to Get Customer Review Information.
 Unit Testing:
 exec Znode_GetCMSCustomerReviewInformation @WhereClause='',@RowsCount=null,@Rows = 100,@PageNo=1,@Order_BY = '',@PortalId = 0,@LocaleId = 1
*/
 BEGIN
   BEGIN TRY
      SET NOCOUNT ON;
		DECLARE @SQL NVARCHAR(MAX);
		IF @LocaleId = 0
		BEGIN
		SELECT @LocaleId = dbo.Fn_GetDefaultLocaleId();
		END;
		DECLARE @TBL_CustomerReview TABLE (CMSCustomerReviewId INT ,PublishProductId INT ,UserId INT,Headline NVARCHAR(400) ,Comments NVARCHAR(MAX),UserName NVARCHAR(600),StoreName NVARCHAR(600)
		,UserLocation NVARCHAR(2000),Rating INT,[Status] NVARCHAR(20),ProductName NVARCHAR(max),CreatedDate DATETIME,ModifiedDate DATETIME,CreatedBy INT,ModifiedBy INT,SEOUrl NVARCHAR(max),RowId INT,CountNo INT)
			 
		 SET @SQL = ' 
		  ;With Cte_CustomerReview AS 
		  (
		   SELECT DISTINCT CMSCustomerReviewId,a.PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,Status,ZPPD.Name ProductName,ZPPD.LocaleId,ZP.StoreName
		   ,a.CreatedDate,a.ModifiedDate,a.CreatedBy,a.ModifiedBy,ZCSD.SEOUrl,ZCSD.PortalId
			FROM ZNODECMSCUSTOMERREVIEW A 
			INNER JOIN ZnodePublishProductEntity ZPPD with(nolock) ON (A.PUBLISHPRODUCTID = ZPPD.ZnodeProductId AND ZPPD.LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+')
			LEFT OUTER JOIN ZnodeCMSSEODetail ZCSD on (ZPPD.SKU = ZCSD.SEOCode AND  ( A.PortalId = ZCSD.PortalId )
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEOType ZCST WHERE  (ZCSD.CMSSEOTypeId = ZCST.CMSSEOTypeId AND ZCST.NAME = ''Product'')
			)
			 )
			INNER  JOIN ZnodePortal ZP ON (A.PortalId = ZP.PortalId)
			WHERE ZP.PortalId = '+CAST(@PortalId AS VARCHAR(50))+' OR '+CAST(@PortalId AS VARCHAR(50))+' = 0 			
		  )
		  ,Cte_CustomerInfo AS 
		  (		  
		   SELECT CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,Status,ProductName,StoreName
		  ,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl ,'+dbo.Fn_GetPagingRowId(@Order_BY,'CMSCustomerReviewId')+',Count(*)Over() CountNo  
		   FROM Cte_CustomerReview 
		   WHERE 1=1  
		   '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
		  )
		  SELECT CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,Status,ProductName,StoreName
		  ,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl,RowId,CountNo
		  FROM Cte_CustomerInfo 
		  '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)                                                                                                                                                                                                                                                                        
          
		  INSERT INTO @TBL_CustomerReview (CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,[Status],ProductName,StoreName
					,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl,RowId,CountNo)                                                                                                                                                                                                                                        
          EXEC (@SQL)

		  SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_CustomerReview ),0)

		  SELECT CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,[Status],ProductName
					,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl,StoreName
		  FROM @TBL_CustomerReview

           
         END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCMSCustomerReviewInformation @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetCMSCustomerReviewInformation',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

DELETE A
FROM 
(
	SELECT *,ROW_NUMBER() OVER (PARTITION BY CountryCode ORDER BY CreatedDate) As Rn FROM ZnodeCountry
) a 
WHERE a.Rn>1;

GO

UPDATE ZnodeCountry
SET CountryName = 'United States'
WHERE CountryCode='US';

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSCustomerReviewInformation')
	DROP PROC Znode_GetCMSCustomerReviewInformation

GO

CREATE PROCEDURE [dbo].[Znode_GetCMSCustomerReviewInformation]
( @WhereClause NVARCHAR(Max),
  @Rows        INT           = 100,
  @PageNo      INT           = 1,
  @Order_BY    VARCHAR(1000)  = '',
  @RowsCount   INT OUT,
  @LocaleId    INT           = 0,
  @PortalId    INT           = 0
  )
AS
/*
 Summary : Procedure is used to Get Customer Review Information.
 Unit Testing:
 exec Znode_GetCMSCustomerReviewInformation @WhereClause='',@RowsCount=null,@Rows = 100,@PageNo=1,@Order_BY = '',@PortalId = 0,@LocaleId = 1
*/
 BEGIN
   BEGIN TRY
      SET NOCOUNT ON;
		DECLARE @SQL NVARCHAR(MAX);
		IF @LocaleId = 0
		BEGIN
		SELECT @LocaleId = dbo.Fn_GetDefaultLocaleId();
		END;
		DECLARE @TBL_CustomerReview TABLE (CMSCustomerReviewId INT ,PublishProductId INT ,UserId INT,Headline NVARCHAR(400) ,Comments NVARCHAR(MAX),UserName NVARCHAR(600),StoreName NVARCHAR(600)
		,UserLocation NVARCHAR(2000),Rating INT,[Status] NVARCHAR(20),ProductName NVARCHAR(max),CreatedDate DATETIME,ModifiedDate DATETIME,CreatedBy INT,ModifiedBy INT,SEOUrl NVARCHAR(max),RowId INT,CountNo INT)
			 
		 SET @SQL = ' 
		  ;With Cte_CustomerReview AS 
		  (
		   SELECT DISTINCT CMSCustomerReviewId,a.PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,Status,ZPPD.Name ProductName,ZPPD.LocaleId,ZP.StoreName
		   ,a.CreatedDate,a.ModifiedDate,a.CreatedBy,a.ModifiedBy,ZCSD.SEOUrl,ZCSD.PortalId
			FROM ZNODECMSCUSTOMERREVIEW A 
			INNER JOIN ZnodePublishProductEntity ZPPD with(nolock) ON (A.PUBLISHPRODUCTID = ZPPD.ZnodeProductId AND ZPPD.LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+')
			LEFT OUTER JOIN ZnodeCMSSEODetail ZCSD on (ZPPD.SKU = ZCSD.SEOCode AND  ( A.PortalId = ZCSD.PortalId )
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEOType ZCST WHERE  (ZCSD.CMSSEOTypeId = ZCST.CMSSEOTypeId AND ZCST.NAME = ''Product'')
			)
			 )
			INNER  JOIN ZnodePortal ZP ON (A.PortalId = ZP.PortalId)
			WHERE ZP.PortalId = '+CAST(@PortalId AS VARCHAR(50))+' OR '+CAST(@PortalId AS VARCHAR(50))+' = 0 			
		  )
		  ,Cte_CustomerInfo AS 
		  (		  
		   SELECT CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,Status,ProductName,StoreName
		  ,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl ,'+dbo.Fn_GetPagingRowId(@Order_BY,'CMSCustomerReviewId')+',Count(*)Over() CountNo  
		   FROM Cte_CustomerReview 
		   WHERE 1=1  
		   '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
		  )
		  SELECT CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,Status,ProductName,StoreName
		  ,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl,RowId,CountNo
		  FROM Cte_CustomerInfo 
		  '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)                                                                                                                                                                                                                                                                        
          
		  INSERT INTO @TBL_CustomerReview (CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,[Status],ProductName,StoreName
					,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl,RowId,CountNo)                                                                                                                                                                                                                                        
          EXEC (@SQL)

		  SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_CustomerReview ),0)

		  SELECT CMSCustomerReviewId,PublishProductId,UserId,Headline,Comments,UserName,UserLocation,Rating,[Status],ProductName
					,CreatedDate,ModifiedDate,CreatedBy,ModifiedBy,SEOUrl,StoreName
		  FROM @TBL_CustomerReview

           
         END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCMSCustomerReviewInformation @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetCMSCustomerReviewInformation',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishCatalogEntity')
	DROP PROC Znode_PublishCatalogEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishCatalogEntity]  
(  
	@PimCatalogId  INT = 0   
	,@RevisionState VARCHAR(50) = ''   
	,@UserId INT = 0  
	,@NewGUID NVARCHAR(500)   
	,@IsDraftProductsOnly BIT = 1  
	,@PimProductId  INT = 0  
	,@PimCategoryHierarchyId INT = 0 
)  
AS  
/*  
To publish all catalog product and their details  
Unit Testing :   
Exec [dbo].[Znode_PublishCatalogEntity]  
@PimCatalogId  = 5  
,@RevisionState = 'PRODUCTION'   
,@UserId = 2  
,@NewGUID = '123'  
   
EXEC Znode_DeletePublishCatalogEntity @PublishCatalogId = 3,@UserId = 2 , @IsRevertPublish = 0 ,  
@NewGUID ='123'   
  
*/  
BEGIN  
BEGIN TRY   
	SET NOCOUNT ON  

	
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))
	DECLARE @DefaultLocaleId Int = dbo.fn_getDefaultLocaleId() , @messagestring varchar(300) =''  ,@PublishType varchar(2000)= 'Catalog'
			,@Getdate DATETIME = dbo.fn_getdate(), @CultureCode varchar(200) = '', @CurrencySuffix varchar(200) = '',@CurrencyCode varchar(200) = ''
			,@CatalogName VARCHAR(600), @IsAllowIndexing bit ,@Status bit, @email nvarchar(200) = (SELECT TOP 1 Username FROM znodeUSer WHERE UserId = @UserId) 
	DECLARE @Versions_new TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	DECLARE @Versions_working TABLE (VersionId int , LocaleId int , PublishStateId int, RevisionState VARCHAR(100) )
	CREATE TABLE  #PimProduct_catalog  (PimProductId int , ParentPimProductId INT, PimCategoryId INT , PimCategoryHierarchyId INT 
			,ParentPimCategoryHierarchyId INT ,DisplayOrder INT  ,IsActive INT,ActivationDate DATETIME , ExpirationDate DATETIME  ,IsDefault bit,PimAddonGroupId INT 
			, BundleQuantity int , IsAssocitedProduct bit   )
    DECLARE @inserted_pimIds TABLE (PimProductId INT )

	SET @messagestring = CASE WHEN @PimProductId > 0  THEN ' Product-'+(SELECT TOP 1 SKU FROM ZnodePimProduct WIth (Nolock) WHERE PimProductId = @PimProductId )+' ' ELSE '' END 

	SELECT TOp 1 @CatalogName= CatalogName,  @IsAllowIndexing= ISNULL(IsAllowIndexing,0)
	FROM ZnodePimCatalog with(nolock)  WHERE PimCatalogId = @PimCatalogId   
	
	SELECT TOp 1  @CurrencyCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Currency'

	SELECT TOp 1  @CultureCode = FeatureValues
	FROM ZnodeGlobalSetting a 
	WHERE FeatureName='Culture'

	SELECT TOP 1 @CurrencySuffix = Symbol
	FROM ZnodeCulture
	WHERE CultureCode = @CultureCode

	INSERT INTO ZnodePublishProgressNotifierEntity (VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	SELECT 0 , @NewGUID, 'Catalog-'+@CatalogName+'-Publish Started ', 10 , 0 , 0 , '',@UserId ,  @email

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionState = 'Production' OR  @RevisionState = 'None'
	
    SET @PublishType = CASE WHEN @PimProductId > 0 THEN 'Product'
	  WHEN @PimCategoryHierarchyId > 0 THEN 'Category'
	ELSE 'Catalog' END 

	INSERT INTO ZnodePublishCatalogLog(PublishCatalogId,PimCatalogId,IsCatalogPublished,PublishCategoryId,  
			IsCategoryPublished,PublishProductId,  
			IsProductPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,LocaleId,PublishStateId,PublishType)  
	OUTPUT inserted.PublishCatalogLogId , inserted.LocaleId, inserted.PublishStateId, inserted.Token INTO @Versions_new
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,@PimProductId,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,a.LocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType 
	FROM ZnodePortalLocale a with(nolock) 
	INNER JOIN ZnodePortalCatalog b with(nolock)  ON (b.PortalId = a.PortalId)
	CROSS APPLY @Tbl_versions  r
	WHERE  b.PublishCatalogId = @PimCatalogId 
	AND a.LocaleId IN (SELECT LocaleId FROM ZnodeLocale p with(nolock)  WHERE p.IsActive = 1 )
	UNION ALL 
	SELECT DISTINCT @PimCatalogId,  @PimCatalogId,NULL,0,  NULL,0,  NULL,@UserId, Getdate(), @UserId, Getdate(), @UserId ,Getdate(),  r.RevisionState
				,@DefaultLocaleId ,DBO.Fn_GetPublishStateIdForProcessing() ,@PublishType
	FROM  @Tbl_versions  r
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePortalCatalog t WHERE t.PublishCatalogId = @PimCatalogId)
	

	INSERT INTO ZnodePublishCatalogEntity (VersionId,ZnodeCatalogId,CatalogName,RevisionType,LocaleId,IsAllowIndexing) 
	SELECT VersionId, @PimCatalogId, @CatalogName, RevisionState, LocaleId, @IsAllowIndexing
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		 AND y.LocaleId = p.LocaleId
	)
	INSERT INTO ZnodePublishVersionEntity (VersionId,ZnodeCatalogId,RevisionType,LocaleId,IsPublishSuccess)  
	SELECT VersionId, @PimCatalogId,  RevisionState, LocaleId, 0
	FROM @Versions_new p
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishVersionEntity y with(nolock)  WHERE y.ZnodeCatalogId = @PimCatalogId AND y.RevisionType = p.RevisionState
		AND y.LocaleId = p.LocaleId
	)

	INSERT INTO @Versions_working 
	SELECT VersionId , a.LocaleId, g.PublishStateId,UPPER( a.RevisionType)RevisionType
	FROM ZnodePublishVersionEntity a with(nolock)
	INNER JOIN ZnodePublishState g with(nolock) ON (g.PublishStateCode = a.RevisionType)
	WHERE a.ZnodeCatalogId = @PimCatalogId
	AND RevisionType IN (SELECT RevisionState FROM @Tbl_versions)
	

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Collecting Products'
		,ProgressMark = 20
	WHERE Jobid = @NewGUID

    INSERT INTO #PimProduct_catalog 
    SELECT DISTINCT PimProductId , 0  , b.PimCategoryId, b.PimCategoryHierarchyId , b.ParentPimCategoryHierarchyId
        ,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault , 0 PimAddonGroupId , 0, 0
    FROM ZnodePimCategoryProduct a with(nolock)
    INNER JOIN ZnodePimCategoryHierarchy b with(nolock) ON (b.PimCategoryId = a.PimCategoryId)
    WHERE b.PimCatalogId = @PimCatalogId
    AND ( a.PimProductId =  @PimProductId   OR @PimProductId =  0 ) 
    AND ( B.PimCategoryHierarchyId =  @PimCategoryHierarchyId   OR @PimCategoryHierarchyId =  0 )


INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , b.PimProductId , b.PimCategoryId, b.PimCategoryHierarchyId, b.ParentPimCategoryHierarchyId
,b.DisplayOrder ,b.IsActive,b.ActivationDate,b.ExpirationDate, 0 IsDefault, 0 PimAddonGroupId , 0,0
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #PimProduct_catalog b ON (b.PimProductId = a.PimParentProductId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

SELECT DISTINCT ZPAPD.PimChildProductId PimProductId,ZPAP.PimProductId ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId,0 ParentPimCategoryHierarchyId , ZPAPD.DisplayOrder ,1 IsActive
,NULL ActivationDate,NULL ExpirationDate ,IsDefault
, ZPAP.PimAddonGroupId PimAddonGroupId , 0 BundleQuantity,RequiredType
INTO #TBL_AddOnProduct
FROM ZnodePimAddOnProductDetail AS ZPAPD with(nolock)
INNER JOIN ZnodePimAddOnProduct AS ZPAP with(nolock) ON (ZPAP.PimAddOnProductId = ZPAPD.PimAddOnProductId)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = ZPAP.PimProductId )


-- SELECT * FROM ZnodePimAddOnProduct
INSERT INTO #PimProduct_catalog 
SELECT DISTINCT ZPAPD.PimProductId,ZPAPD.ParentPimProductId, 0 PimCategoryId , 0 PimCategoryHierarchyId , 0 ,DisplayOrder ,0 ,NULL,NULL,IsDefault
,PimAddonGroupId  , 0 ,0
FROM #TBL_AddOnProduct ZPAPD
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = ZPAPD.PimProductId )

INSERT INTO #PimProduct_catalog 
SELECT DISTINCT a.PimProductId , a.PimParentProductId , 0 PimCategoryId , 0 PimCategoryHierarchyId,a.DisplayOrder,0,0,NULL,NULL,IsDefault
, 0 PimAddonGroupId , BundleQuantity, 1
FROM ZnodePimProductTypeAssociation a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog ty WHERE ty.PimProductId = a.PimParentProductId )
--AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog rt WHERE rt.PimProductId = a.PimProductId )

CREATE INDEX IDX_#PimProduct_catalog ON #PimProduct_catalog(PimProductId)

    IF @IsDraftProductsOnly = 0  
    BEGIN 
      --  EXEC Znode_CatalogProductDraftForPublish @PublishCatalogId=@PimCatalogId   
	  ---To draft all catalog products AND associated products for full catalog publish  

	  UPDATE ZnodePimProduct 
	  SET PublishStateId = 2 
	  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_catalog y WHERE y.PimProductId = ZnodePimProduct.PimProductId )
    END 


DROP TABLE IF EXISTS #PimProduct_distinct

SELECT DISTINCT a.PimProductId, PimCategoryHierarchyId PimCategoryId ,sku,ProductName, CAST(b.IsActive AS VARCHAR(50)) IsActive,b.PublishStateId, b.ProductType
INTO #PimProduct_distinct
FROM #PimProduct_catalog a
INNER JOIN ZnodePimProduct b with(nolock) ON (b.PimProductId = a.PimProductId)

CREATE INDEX IDX_#PimProduct_distinct ON #PimProduct_distinct(PimProductId,IsActive)
	

UPDATE ZnodePublishProgressNotifierEntity
SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'Create backup of version'
	,ProgressMark = 25
WHERE Jobid = @NewGUID

DECLARE @Deleted_Products TABLE (PimProductId INT )

SELECT p.PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity p With(nolock)  WHERE  NOT EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND  @PimProductId = 0 AND @PimCategoryHierarchyId = 0 
UNION ALL 
SELECT p.PublishProductEntityId
FROM ZnodePublishProductEntity p  WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct ty WHERE ty.PimProductId = p.ZnodeProductId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND EXISTS (SELECT TOP 1 1 FROM ZnodePimProduct t with(nolock) WHERE t.PimProductId = p.ZnodeProductId AND t.IsActive = 'false' ) 
AND @PimCategoryHierarchyId = 0 

UPDATE ZnodePublishProductEntity 
SET ElasticSearchEvent = 2 
WHERE EXISTS (SELECT TOP 1 1  FROM #PublishProductEntityId t WHERE t.PublishProductEntityId = ZnodePublishProductEntity.PublishProductEntityId ) 



SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId )

	
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing category'
		,ProgressMark = 30
	WHERE Jobid = @NewGUID


SELECT DISTINCT  rt.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, 0 DisplayOrder , rt.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId, rt.PimCategoryId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  #PimProduct_catalog rt ON ( rt.PimCategoryId = a.PimCategoryId  )


INSERT INTO #Temp_Categoryvalue
SELECT DISTINCT  ty.PimCategoryHierarchyId, c.AttributeCode,b.CategoryValue AttributeValues, ty.DisplayOrder , ty.ParentPimCategoryHierarchyId,b.LocaleId,a.PimCategoryAttributeValueId,ty.PimCategoryId
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN ZnodePimCategoryHierarchy ty with(nolock) ON (ty.PimCategoryId = a.PimCategoryId)
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ut WHERE ut.PimCategoryHierarchyId = ty.PimCategoryHierarchyId)
AND ty.PimCatalogId =@PimCatalogId
AND @PimProductId = 0 


UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )

DELETE p 
FROM ZnodePublishCategoryEntity p 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue ty WHERE ty.PimCategoryHierarchyId = p.ZnodeCategoryId)
AND EXISTS (SELECT TOP 1 1 FROM @Versions_working n WHERE n.VersionId = p.VersionId ) 
AND @PimProductId = 0 AND @PimCategoryHierarchyId = 0 

IF EXISTS (SELECT TOP 1 1 FROM @Versions_working r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    
	INSERT INTO #Temp_Categoryvalue(PimCategoryHierarchyId, AttributeCode, AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,PimCategoryAttributeValueId,PimCategoryId)
	SELECT PimCategoryHierarchyId, AttributeCode, ISNULL(b.CategoryValue,a.AttributeValues)AttributeValues, DisplayOrder , ParentPimCategoryHierarchyId, t.LocaleId,a.PimCategoryAttributeValueId,a.PimCategoryId
	FROM #Temp_Categoryvalue a 
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY @Versions_working t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

SELECT DISTINCT PimCategoryHierarchyId, DisplayOrder ,ParentPimCategoryHierarchyId ,LocaleId,a.PimCategoryId
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 


ALTER TABLE #Temp_categoryDetails ADD  IsActive BIT , ActivationDate DATETIME ,ExpirationDate DATETIME  ,CategoryName NVARCHAr(max), CategoryCode NVARCHAr(600)

UPDATE a  
SET CategoryName = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryName')
,CategoryCode = (SELECT TOP 1 AttributeValues FROM #Temp_Categoryvalue tu WHERE tu.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND tu.LocaleId = a.LocaleId AND tu.AttributeCode = 'CategoryCode')
,DisplayOrder = ISNULL(b.DisplayOrder,a.DisplayOrder) , IsActive = ISNULL(b.IsActive,0), ActivationDate = b.ActivationDate , ExpirationDate = b.ExpirationDate
FROM #Temp_categoryDetails  a
LEFT JOIN #PimProduct_catalog b ON (b.PimCategoryHierarchyId = a.PimCategoryHierarchyId)
--WHERE @PimProductId = 0 


UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId  AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.ZnodeCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN @Versions_working q ON ( q.VersionId = a.VersionId)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.LocaleId = a.LocaleId )
WHERE a.ZnodeCatalogId = @PimCatalogId
--AND @PimProductId = 0 


INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT q.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,@CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(   CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM #PimProduct_catalog ty WHERE ty.PimCategoryHierarchyId = a.PimCategoryHierarchyId  )+']' 
	,q.LocaleId, a.IsActive,a.DisplayOrder,(SELECT r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND q.LocaleId = r.LocaleId					FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
CROSS APPLY @Versions_working q 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = q.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )
AND a.LocaleId = q.LocaleId
--AND  @PimProductId = 0  


	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Product'
		,ProgressMark = 35
	WHERE Jobid = @NewGUID


SELECT r.VersionId
,GETDATE() PublishStartTime,c.Name ItemName,a.CMSSEODetailId,b.CMSSEODetailLocaleId,c.CMSSEOTypeId,a.SEOId,c.name SEOTypeName,b.SEOTitle
,b.SEODescription,b.SEOKeywords,a.SEOUrl,a.IsRedirect,a.MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,a.PortalId,a.SEOCode,b.CanonicalURL
,b.RobotTag,1 ElasticSearchEvent, ISNULL(n.PublishSeoEntityId,0)PublishSeoEntityId
INTO #Seo_entity
FROM ZnodeCMSSEODetail a with (nolock)
INNER JOIN ZnodeCMSSEODetailLocale b with(nolock) ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN ZnodeCMSSEOType c with(nolock) ON (c.CMSSEOTypeId = a.CMSSeoTypeId )
CROSS APPLY @Versions_working r 
LEFT JOIN ZnodePublishSeoEntity n ON (n.VersionId = r.VersionId AND n.SEOCode = a.SEOCode)
WHERE c.CMSSEOTypeId IN (1,2)
AND a.PortalId IN (SELECT PortalId FROM ZnodePortalCatalog t with(nolock) WHERE t.PublishCatalogId =@PimCatalogId)


SELECT  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId , Max(a.PimCategoryId) ZnodeCategoryIds , CAST('' AS NVARCHAR(2000)) CategoryName
         ,STRING_AGG( CONVERT(VARCHAR(MAX),a.PimCategoryId),',') WITHIN GROUP (ORDER BY a.PimCategoryId) ZnodeParentCategoryIds
		 ,CAST('' AS VARCHAR(1000)) SeoDescription,CAST('' AS VARCHAR(1000))SeoKeywords
	   ,CAST('' AS VARCHAR(1000))SeoTitle,CAST('' AS VARCHAR(1000)) SeoUrl
	   , CAST('' AS VARCHAR(50)) SalesPrice,CAST('' AS VARCHAR(50)) RetailPrice
INTO #TBL_finalProducts
FROM #PimProduct_distinct a
GROUP BY  a.PimProductId,a.sku,a.ProductName,a.IsActive ,a.PublishStateId

IF  @IsAllowIndexing = 1
BEGIN 


SELECT SEoCode SKU ,MAX(SeoDescription)SeoDescription,Max(SeoKeywords) SeoKeywords,Max(SeoTitle)SeoTitle,Max(SeoUrl)SeoUrl
INTO #Distinct_seo
FROM #Seo_entity
WHERE CMSSEOTypeId = 1 
GROUP BY SEoCode


SELECT SKU , MIN(RetailPrice) RetailPrice, MIN(SalesPrice ) SalesPrice
INTO #price_data
FROM ZnodePrice a with (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct r WHERE r.SKU = a.SKU )
GROUP BY SKU

UPDATE a
SET SeoDescription = ISNULL(p.SeoDescription,'') ,SeoKeywords= ISNULL(p.SeoKeywords,'')
	   ,SeoTitle=ISNULL(p.SeoTitle,''),SeoUrl=ISNULL(p.SeoUrl,'')
FROM #TBL_finalProducts a
INNER JOIN #Distinct_seo p ON (p.SKU = a.SKU )

UPDATE a
SET SalesPrice =ISNULL(toe.SalesPrice,0) ,RetailPrice=ISNULL(toe.RetailPrice,0) 
FROM #TBL_finalProducts a
INNER JOIN #price_data toe ON (toe.SKU = a.SKU  )

END
ELSE 
BEGIN 

 UPDATE ZnodePublishProductEntity 
SET SeoUrl = '' , SeoDescription = '', SeoKeywords = '', SeoTitle = '', SalesPrice = 0 
, RetailPrice =0 
WHERE @IsAllowIndexing = 0 AND ZnodeCatalogId =@PimCatalogId

END 

--TRUNCATE TABLE ZnodePublishProductEntityLog

DECLARE @VersionId_l INT ,@LocaleId_l INT ,@RevisionState_l VARCHAR(300)

DECLARE cur_localeId CURSOR FOR 
SELECT VersionId,LocaleId,RevisionState
FROM @Versions_working

OPEN cur_localeId

FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l
WHILE @@FETCH_STATUS = 0
BEGIN 


UPDATE a SET CategoryName = uy.Name
FROM #TBL_finalProducts a 
INNER JOIN ZnodePublishCategoryEntity uy  with(nolock) ON (uy.ZnodeCategoryId = a.ZnodeCategoryIds)
WHERE uy.VersionId =@VersionId_l


DROP TABLE IF EXISTS  #insertedPublishEntity

SELECT  @VersionId_l VersionId , ROW_NUMBER()Over(ORDER BY a.PimProductId )IndexId, a.PimProductId ZnodeProductId , @PimCatalogId ZnodeCatalogId,a.sku,@LocaleId_l LocaleId,a.ProductName Name , ZnodeCategoryIds ,a.IsActive,'' Attributes,'[]' Brands
       , CategoryName, @CatalogName CatalogName, 0 DisplayOrder, @RevisionState_l  RevisionType, 0 AssociatedProductDisplayOrder, 1  ProductIndex,  SalesPrice, RetailPrice
	   ,@CultureCode CultureCode,@CurrencySuffix CurrencySuffix
	   ,@CurrencyCode CurrencyCode, SeoDescription,SeoKeywords
	   ,SeoTitle, SeoUrl,'' ImageSmallPath,LOWER(a.sku) SKULower,1 ElasticSearchEvent, ZnodeParentCategoryIds ,GETDATE() ModifiedDate,0 IsSingleProductPublish
	   ,0 IsCacheClear, 0 PublishProductEntityId,a.PublishStateId
INTO #insertedPublishEntity 
FROM #TBL_finalProducts a 
WHERE a.IsActive = 'true' 



UPDATE a
SET a.PublishProductEntityId=ty.PublishProductEntityId
FROM #insertedPublishEntity a
INNER JOIN ZnodePublishProductEntity ty with(nolock) ON ( ty.VersionId = @VersionId_l AND ty.ZnodeProductId  = a.ZnodeProductId AND ty.ZnodeCatalogId =@PimCatalogId )

--INSERT INTO ZnodePublishProductEntityLog
--SELECT *
--FROM ZnodePublishProductEntity ty with(nolock) 
--WHERE EXISTS (SELECT TOP 1 1 FROM  #insertedPublishEntity tu WHERE tu.PublishProductEntityId = ty.PublishProductEntityId AND tu.PublishProductEntityId <> 0 )

UPDATE a
SET Name = b.name , a.SalesPrice = b.SalesPrice , a.RetailPrice = b.RetailPrice, CurrencyCode = b.CurrencyCode , CultureCode= b.CultureCode, CurrencySuffix = b.CurrencySuffix
, CategoryName = b.CategoryName, a.ElasticSearchEvent = 1 , ZnodeParentCategoryIds = b.ZnodeParentCategoryIds , a.SKU = b.SKU , a.SKULower = b.SKULower
FROM ZnodePublishProductEntity a 
INNER JOIN #insertedPublishEntity b ON (b.PublishProductEntityId = a.PublishProductEntityId)
WHERE b.PublishProductEntityId <> 0 --AND b.PublishStateId = 2 



INSERT INTO ZnodePublishProductEntity(VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear)
SELECT VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU ,LocaleId,Name,ZnodeCategoryIds,IsActive,Attributes,Brands
,CategoryName,CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix
,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,ElasticSearchEvent,ZnodeParentCategoryIds,ModifiedDate,IsSingleProductPublish
,IsCacheClear
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0 


FETCH NEXT FROM cur_localeId INTO @VersionId_l,@LocaleId_l,@RevisionState_l


 END 

 CLOSE cur_localeId
 DEALLOCATE cur_localeId

 DROP TABLE IF EXISTS #TBL_finalProducts
 
DECLARE @pimProductId_oi transferId 
DECLARE @Version_str VARCHAr(2000) 

SELECT @Version_str= STRING_AGG( CONVERT(VARCHAR(200), q.VersionId) ,',')
FROM @Versions_working q

INSERT INTO @pimProductId_oi 
SELECT DISTINCT  pimProductId 
FROM #PimProduct_distinct a
WHERE a.PublishStateId IN (1,2)
UNION  
SELECT ZnodeProductId
FROM #insertedPublishEntity
WHERE PublishProductEntityId = 0  


 DROP TABLE IF EXISTS  #insertedPublishEntity

 IF  EXISTS ( SELECT TOP 1 1 FROM @pimProductId_oi )
 BEGIN 

EXEC Znode_PublishUpdateProductJson @PimProductIds=@pimProductId_oi
,@VersionId = @Version_str
,@LocaleId = 1 
,@IsSingleProductPublish = 0 ,@NewGUID=@NewGUID, @CatalogName = @CatalogName,@messagestring=@messagestring

END 

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing Catalog Attribute'
		,ProgressMark = 60
	WHERE Jobid = @NewGUID


SELECT VersionId,@PimCatalogId PimCatalogId,AttributeCode,AttributeTypeName,0 IsPromoRuleCondition
,ISNULL(IsComparable,0)IsComparable,ISNULL(IsHtmlTags,0)IsHtmlTags,ISNULL(IsFacets,0)IsFacets,ISNULL(IsUseInSearch,0)IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,a.LocaleId,DisplayOrder
	,ISNULL((
	SELECT  p.AttributeDefaultValue Value, m.DisplayOrder 
	FROM ZnodePimAttributeDefaultValue m
	INNER JOIN ZnodePimAttributeDefaultValueLocale p ON (p.PimAttributeDefaultValueId = m.PimAttributeDefaultValueId)
	WHERE m.PimAttributeId = a.PimAttributeId AND p.LocaleId = a.LocaleId
	FOR JSON PATH 
	),'[]')SelectValues
INTO #temp_updatecatalogAttribute 
FROM #temp_attributename a 
INNER JOIN @Versions_working h ON (h.LocaleId = a.LocaleId) 

UPDATE a 
SET AttributeTypeName=b.AttributeTypeName,IsPromoRuleCondition
=b.IsPromoRuleCondition,IsComparable=b.IsComparable,IsHtmlTags=b.IsHtmlTags,IsFacets=b.IsFacets
,IsUseInSearch=b.IsUseInSearch,IsPersonalizable=b.IsPersonalizable,IsConfigurable=b.IsConfigurable,AttributeName=b.AttributeName
,LocaleId=b.LocaleId,DisplayOrder=b.DisplayOrder,SelectValues=b.SelectValues
FROM ZnodePublishCatalogAttributeEntity a 
INNER JOIN #temp_updatecatalogAttribute b ON (b.VersionId = a.VersionId AND b.AttributeCode = a.AttributeCode)


INSERT INTO ZnodePublishCatalogAttributeEntity (VersionId,ZnodeCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues)
SELECT VersionId,PimCatalogId,AttributeCode,AttributeTypeName,IsPromoRuleCondition
,IsComparable,IsHtmlTags,IsFacets,IsUseInSearch,IsPersonalizable,IsConfigurable,AttributeName,LocaleId,DisplayOrder,SelectValues
FROM #temp_updatecatalogAttribute a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogAttributeEntity r WHERE r.AttributeCode = a.AttributeCode AND r.VersionId = a.VersionId)



	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Publishing SEO data'
		,ProgressMark = 65
	WHERE Jobid = @NewGUID


UPDATE a 
SET a.ItemName					=b.ItemName,a.CMSSEODetailId				=b.CMSSEODetailId		,a.CMSSEODetailLocaleId			=b.CMSSEODetailLocaleId	
,a.CMSSEOTypeId					=b.CMSSEOTypeId	,a.SEOId						=b.SEOId,a.SEOTypeName					=b.SEOTypeName			
,a.SEOTitle						=b.SEOTitle,a.SEODescription				=b.SEODescription	,a.SEOKeywords					=b.SEOKeywords			
,a.SEOUrl						=b.SEOUrl	,a.IsRedirect					=b.IsRedirect	,a.MetaInformation				=b.MetaInformation		
,a.LocaleId						=b.LocaleId	,a.OldSEOURL					=b.OldSEOURL	,a.CMSContentPagesId			=b.CMSContentPagesId	
,a.PortalId						=b.PortalId	,a.SEOCode						=b.SEOCode	,a.CanonicalURL					=b.CanonicalURL			
,a.RobotTag						=b.RobotTag	,a.ElasticSearchEvent			=b.ElasticSearchEvent	
FROM  ZnodePublishSeoEntity a 
INNER JOIN #Seo_entity b ON (b.PublishSeoEntityId = a.PublishSeoEntityId)

INSERT INTO ZnodePublishSeoEntity (VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent)
SELECT VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName
,SEOTitle,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL
,RobotTag,ElasticSearchEvent
FROM #Seo_entity a 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishSeoEntity r with(nolock) WHERE r.PublishSeoEntityId = a.PublishSeoEntityId )


SELECT q.VersionId,a.PimProductId, @PimCatalogId ZnodeCatalogId, b.PimProductId AssociatedZnodeProductId , b.DisplayOrder,'' SelectValues
, ISNULL((SELECT CONCAT('["',STRING_AGG([AttributeCode], '","'),'"]') FROM #temp_attributename n 
INNER JOIN ZnodePimConfigureProductAttribute g WITH (nolock) ON (g.PimProductId = a.PimProductId )
WHERE n.PimAttributeId = g.PimAttributeId AND n.LocaleId = q.LocaleId),'[]') ConfigurableAttributeCodes
, IsDefault,1 ElasticSearchEvent
INTO #temp_configProductids 
FROM ZnodePimConfigureProductAttribute a  WITH (nolock)
INNER JOIN #PimProduct_catalog b ON (b.ParentPimProductId = a.PimProductId AND b.IsAssocitedProduct =1 )
CROSS APPLY @Versions_working q 
GROUP BY q.VersionId,a.PimProductId, b.PimProductId  , b.DisplayOrder, IsDefault,q.LocaleId

DELETE a FROM ZnodePublishConfigurableProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_configProductids t WHERE t.PimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.AssociatedZnodeProductId <> a.AssociatedZnodeProductId
)
  
 INSERT INTO ZnodePublishConfigurableProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent)
 SELECT VersionId,PimProductId,ZnodeCatalogId,AssociatedZnodeProductId,DisplayOrder,SelectValues,ConfigurableAttributeCodes,IsDefault,ElasticSearchEvent
 FROM #temp_configProductids a
 WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishConfigurableProductEntity t WHERE t.VersionId = a.VersionId AND a.PimProductId = t.ZnodeProductId AND t.AssociatedZnodeProductId = a.AssociatedZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, a.PimProductId, a.DisplayOrder, a.BundleQuantity ,1 ElasticSearchEvent
INTO #temp_bundleProduct 
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'BundleProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishBundleProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_bundleProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId <> a.ZnodeProductId   
)


UPDATE a
SET  a.AssociatedProductBundleQuantity = t.BundleQuantity, a.AssociatedProductDisplayOrder = t.DisplayOrder
FROM ZnodePublishBundleProductEntity a
INNER JOIN  #temp_bundleProduct t ON( t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND  t.PimProductId = a.ZnodeProductId   ) 

INSERT INTO ZnodePublishBundleProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,AssociatedProductBundleQuantity,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, DisplayOrder, ISNULL(BundleQuantity,0) BundleQuantity , ElasticSearchEvent
FROM #temp_bundleProduct a
WHERE  NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishBundleProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)


-- Remove Non Variant Bundle products
    Select  ZnodeProductId  into #DeletedBundleId  FROM ZnodePublishBundleProductEntity a Where Not exists (
    Select TOP 1 1  from ZnodePimProductTypeAssociation X where a.ZnodeProductId = X.PimParentProductId )
    
    Update A SET a.ElasticSearchEvent =2 from  ZnodePublishProductEntity A Inner Join #DeletedBundleId B on  a.ZnodeProductId  = B.ZnodeProductId
    
    DELETE a FROM ZnodePublishBundleProductEntity a Where exists (
    Select TOP 1 1  from #DeletedBundleId X where a.ZnodeProductId = X.ZnodeProductId )

SELECT q.VersionId, ParentPimProductId,@PimCatalogId ZnodeCatalogId, PimProductId, a.DisplayOrder ,1 ElasticSearchEvent
INTO #temp_groupProduct
FROM #PimProduct_catalog a 
CROSS APPLY @Versions_working q 
WHERE EXISTS (SELECT TOP 1 1 FROM #PimProduct_distinct tt WHERE tt.PimProductId = a.ParentPimProductId AND tt.ProductType = 'GroupedProduct')
AND a.IsAssocitedProduct =1 

DELETE a FROM ZnodePublishGroupProductEntity a 
WHERE EXISTS (SELECT TOP 1 1 FROM #temp_groupProduct t WHERE t.ParentPimProductId = a.ZnodeProductId AND t.VersionId = a.VersionId
AND t.PimProductId <> a.ZnodeProductId
)

INSERT INTO ZnodePublishGroupProductEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder,ElasticSearchEvent)
SELECT VersionId, ParentPimProductId,ZnodeCatalogId, PimProductId, DisplayOrder ,ElasticSearchEvent
FROM #temp_groupProduct a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishGroupProductEntity t WHERE t.VersionId = a.VersionId AND t.ZnodeProductId = a.ParentPimProductId AND t.AssociatedZnodeProductId = a.PimProductId)
 
 Delete from ZnodePublishAddonEntity 
where Exists (Select TOP 1 1 FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q  
where ZnodePublishAddonEntity.VersionId = q.VersionId AND ZnodePublishAddonEntity.ZnodeProductId = a.ParentPimProductId
AND ZnodePublishAddonEntity.AssociatedZnodeProductId = a.PimProductId  AND a.PimAddonGroupId > 0  )
 
INSERT INTO ZnodePublishAddonEntity (VersionId,ZnodeProductId,ZnodeCatalogId,AssociatedZnodeProductId,AssociatedProductDisplayOrder
,LocaleId,GroupName,DisplayType,DisplayOrder,IsRequired,RequiredType,IsDefault,ElasticSearchEvent)
SELECT VersionId,ParentPimProductId,@PimCatalogId,PimProductId,DisplayOrder
,q.LocaleId,[AddonGroupName] GroupName, DisplayType,DisplayOrder,IIF(RequiredType='requierd',1,0) IsRequired, RequiredType,IsDefault,1 ElasticSearchEvent
FROM  #TBL_AddOnProduct a
CROSS APPLY @Versions_working q 
Inner join ZnodePimAddonGroup AS ZPADG with(nolock) on ( ZPADG.PimAddonGroupId = a.PimAddonGroupId ) 
Inner join ZnodePimAddonGroupLocale AS ZPADGL  with(nolock) on ( ZPADG.PimAddonGroupId = ZPADGL.PimAddonGroupId  and ZPADGL.LocaleId = @DefaultLocaleId ) 
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishAddonEntity ty WHERE ty.VersionId = q.VersionId AND ty.ZnodeProductId = a.ParentPimProductId
AND ty.AssociatedZnodeProductId = a.PimProductId  )
AND a.PimAddonGroupId > 0 

		
	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =   @messagestring+'Catalog-'+@CatalogName+'-'+'Started Elastic update'
		,ProgressMark = 80
	WHERE Jobid = @NewGUID
	
	SET @Status = 1  
  
    UPDATE a 
	SET --PublishSTateId = c.PublishStateId, IsCatalogPublished = 1 	    ,
	PublishCategoryId = (SELECT COUNT(DISTINCT PimCategoryHierarchyId )  FROM #Temp_Categoryvalue n )
		, PublishProductId = CASE WHEN @PimProductId <> 0 THEN @PimProductId ELSE  (SELECT COUNT(DISTINCT PimProductId )  FROM #PimProduct_distinct np  ) END 
	FROM ZnodePublishCatalogLog a 
	INNER JOIN @Versions_new b ON (b.VersionId = a.PublishCatalogLogId)
	INNER JOIN ZnodePublishState c with(nolock) ON (c.PublishStateCode = b.RevisionState)
    
	UPDATE ZnodePublishVersionEntity SET IsPublishSuccess = 1 WHERE ZnodeCatalogId = @PimCatalogId

	UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  #PimProduct_distinct ) 
	AND @PimProductId = 0 

	UPDATE ZnodePimCategory 
	SET PublishStateId = CASE WHEN EXISTS (SELECT TOP 1 1 FROM @Versions_working WHERE PublishStateId = 3 ) THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimCategoryId IN ( SELECT t.PimCategoryId FROM  #Temp_categoryDetails t  ) 


	IF @PimProductId = 0 
	BEGIN 
		SELECT @PimCatalogId AS id,@Status AS Status;     
    END 
	ELSE 
	BEGIN 
	
	  SELECT PimProductId , 0 IsDeleted , @PimCatalogId ZnodecatalogId , n.VersionId
	  FROM #PimProduct_distinct a 
	  CROSS APPLY @Versions_working n 
	  UNION ALL 
	  SELECT PimProductId , 1 IsDeleted , @PimCatalogId , n.VersionId
	  FROM @Deleted_Products 
	  CROSS APPLY @Versions_working n 
	END 
END TRY   
BEGIN CATCH   
	SET @Status =0    
	SELECT ERROR_MESSAGE()
	SELECT 1 AS ID,@Status AS Status;     
   
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),   
	@ErrorLine VARCHAR(100)= ERROR_LINE(),  
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishCatalogEntity   
	@PimCatalogId = '+CAST(@PimCatalogId  AS VARCHAR (max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))  
	+',@PreviewVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@ProductionVersionId = ' + CAST(0  AS VARCHAR(20))  
	+',@RevisionState = ''' + CAST(@RevisionState  AS VARCHAR(50))  
	+',@UserId = ' + CAST(@UserId AS VARCHAR(20)); SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
   
    	
	EXEC Znode_InsertProcedureErrorLog  
	@ProcedureName = 'Znode_PublishCatalogEntity',  
	@ErrorInProcedure = @Error_procedure,  
	@ErrorMessage = @ErrorMessage,  
	@ErrorLine = @ErrorLine,  
	@ErrorCall = @ErrorCall;  
END CATCH  
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO

CREATE PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
--DECLARE #pimProductIds  TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT, VersionId INT  )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId ,VersionId
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
--AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

CREATE INDEX IDX_#pimProductIds ON #pimProductIds(PimProductId)

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID


DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId



SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  #pimProductIds  t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue 
			,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, c.PimCustomFieldId , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 1 Iscustomfield
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId and aa.PimAttributeId = a.PimAttributeId 
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN #pimProductIds  bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT DISTINCT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #pimProductIds  n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct w WHERE w.VersionId = a.VersionId)

CREATE TABLE #tbl_AttributeValueLocale (PimProductId INT ,   AttributeValue NVARCHAR(max), PimAttributeId INT  , LocaleId INT)
CREATE TABLE #default_valuelocale (PimAttributeDefaultValueId INT , AttributeDefaultValue NVARCHAR(max), LocaleId int  )

IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct WHERE LocaleId <> @DefaultLocaleId )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   WHERE m.LocaleId <> @DefaultLocaleId

   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

    --SELECT * FROM #tbl_AttributeValue

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   LEFT JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId AND a.Iscustomfield = 0 )
   LEFT JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId AND a.Iscustomfield = 0 )
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId
 


   INSERT INTO #default_valuelocale
   SELECT  bc.PimAttributeDefaultValueId, bc.AttributeDefaultValue, bc.LocaleId 
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE bc.LocaleId <> @DefaultLocaleId
   



END 
--LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
   --SELECT * FROM #tbl_AttributeValueLocale

    DROP TABLE IF EXISTS #tbl_ProductValueid

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID
	
	DECLARE @t transferId 

	WHILE EXISTS (SELECT TOP 1 1 FROM #PublishProductEntityId)
	BEGIN 
	
	INSERT INTO @t
	SELECT TOP 50000 PublishProductEntityId
	FROM #PublishProductEntityId

UPDATE m
SET m.Attributes = (SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', Isnull(f.CustomKey,a.CustomCode),b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(IIF(ut.AttributeValue IS NULL , a.AttributeValue,ut.AttributeValue),'') AttributeValues
				,ISNULL((
				   SELECT   Code,m.LocaleId,IIF(AttributeDefaultValue IS NULL ,Value, AttributeDefaultValue) Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   LEFT JOIN #default_valuelocale op ON (op.PimAttributeDefaultValueId = nt.PimAttributeDefaultValueId AND op.LocaleId = m.LocaleId )
				   WHERE nt.PimProductId = m.ZnodeProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId =@DefaultLocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId 
										AND ut.LocaleId = m.LocaleId)
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = m.LocaleId )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =m.LocaleId AND a.Iscustomfield = 0 )
WHERE a.PimProductId = m.ZnodeProductId AND a.LocaleId = @DefaultLocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
    )

FROM ZnodePublishProductEntity m
WHERE EXISTS (SELECT TOP 1 1  FROM @t p WHERE p.id = m.PublishProductEntityId)
OPTION (RECOMPILE)

UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValueLocale ty ON ( ty.PimProductId = a.ZnodeProductId AND ty.LocaleId = a.LocaleId 
	AND ty.PimAttributeId = (SELECT TOP 1 w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')  )
WHERE PublishProductEntityId  IN (SELECT Id FROM @t)
AND a.LocaleId <> @DefaultLocaleId
	
	DELETE FROM #PublishProductEntityId WHERE EXISTS (SELECT TOP 1 1 FROM @t WHERE id = PublishProductEntityId)
	DELETE FROM @t
	IF IS_SRVROLEMEMBER('sysadmin', SUSER_NAME())=1
	DBCC DROPCLEANBUFFERS
END 

DROP TABLE IF EXISTS #pimProductIds

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleCategoryEntity')
	DROP PROC Znode_PublishSingleCategoryEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleCategoryEntity]
(
    @PimCategoryId  int 
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAssociate int  = 0 OUT
   ,@PimCatalogId int = 0
)
AS
/*
	To publish single category 
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@DefaultLocaleId int = dbo.fn_getdefaultLocaleId()
	SET @Status = 1 
	Declare @IsPreviewEnable int 
	DECLARE @Tbl_versions  TABLE (RevisionState VARCHAr(300))

	INSERT INTO @Tbl_versions 
	SELECT 'PREVIEW'
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePublishStateApplicationTypeMapping with(nolock) WHERE ApplicationType = 'WebstorePreview' AND IsActive =1 AND IsEnabled = 1 )
	UNION ALL 
	SELECT 'PRODUCTION'
	WHERE @RevisionType = 'Production' OR  @RevisionType = 'None'

		
    SELECT AttributeCode , AttributeName , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(d.IsFacets,0) IsFacets
, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, b.LocaleId
INTO #temp_attributename 
FROM ZnodePimAttribute a with(nolock)
INNER JOIN ZnodePimAttributeLocale b with(nolock) ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId =@DefaultLocaleId)
INNER JOIN ZnodeAttributeType c with(nolock) ON (c.AttributeTypeId = a.AttributeTypeId)
LEFT JOIN ZnodePimFrontendProperties d with(nolock) ON (d.PimAttributeId = a.PimAttributeId ) 
WHERE  a.IsCategory =1



SELECT DISTINCT yu.VersionId,yu.LocaleId, yu.CatalogName, yu.ZnodeCatalogId, a.PimCategoryId ,RT.ParentPimCategoryHierarchyId, rt.DisplayOrder, rt.PimCategoryHierarchyId
, c.AttributeCode,b.CategoryValue AttributeValues,rt.ActivationDate, rt.ExpirationDate
		,RT.IsActive, a.PimCategoryAttributeValueId
INTO #Temp_Categoryvalue
FROM ZnodePimCategoryAttributeValue a with(nolock)
INNER JOIN ZnodePimCategoryAttributeValueLocale b with(nolock) ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = @DefaultLocaleId)
INNER JOIN #temp_attributename c ON (c.PimAttributeId = a.PimAttributeId AND c.IsCategory =1 )
INNER JOIN  ZnodePimCategoryHierarchy  rt with(nolock) ON ( rt.PimCategoryId = a.PimCategoryId  )
INNER JOIN  ZnodePublishCatalogEntity yu with(nolock) ON (yu.ZnodeCatalogId = rt.PimCatalogId)
WHERE rt.PimCategoryId =@PimCategoryId
AND yu.RevisionType IN (SELECT t.RevisionState FROM @Tbl_versions t)



IF EXISTS (SELECT TOP 1 1 FROM #Temp_Categoryvalue r WHERE r.LocaleId <> @DefaultLocaleId)
BEGIN 
    UPDATE a 
	SET AttributeValues = b.CategoryValue
	FROM #Temp_Categoryvalue a 
	INNER JOIN ZnodePimCategoryAttributeValueLocale b ON (b.PimCategoryAttributeValueId = a.PimCategoryAttributeValueId AND b.LocaleId = a.LocaleId)
	WHERE a.LocaleId <> @DefaultLocaleId

	INSERT INTO #temp_attributename
	SELECT AttributeCode , IIF(b.AttributeName IS NULL, a.AttributeName ,b.AttributeName) , AttributeTypeName ,ISNULL( IsUseInSearch,0) IsUseInSearch,ISNULL(IsHtmlTags,0)IsHtmlTags
		,ISNULL(IsComparable,0)IsComparable, a.PimAttributeId ,ISNULL(a.IsFacets,0) IsFacets
		, ISNULL(a.IsConfigurable,0)IsConfigurable, ISNULL( a.IsPersonalizable, 0)IsPersonalizable
		, a.DisplayOrder,IsCategory, t.LocaleId
	FROM #temp_attributename a
	CROSS APPLY ZnodePublishCatalogEntity t 
	LEFT JOIN ZnodePimAttributeLocale b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = t.LocaleId)
	WHERE t.LocaleId <> @DefaultLocaleId

END 

UPDATE a SET a.AttributeValues = ZM.Path
FROM #Temp_Categoryvalue a
INNER  JOIN ZnodeMedia ZM ON (CAST(zm.MediaId AS VARCHAR(200)) = a.AttributeValues)
WHERE a.AttributeCode IN (SELECT n.AttributeCode FROM #temp_attributename n WHERE n.AttributeTypeName = 'Image' )


SELECT DISTINCT PimCategoryHierarchyId,LocaleId,ZnodeCatalogId, CatalogName,PimCategoryId
,ParentPimCategoryHierarchyId,DisplayOrder,VersionId,CAST('' AS NVARCHAr(300)) CategoryName,CAST('' AS NVARCHAr(100)) CategoryCode ,ActivationDate, ExpirationDate,IsActive
INTO #Temp_categoryDetails
FROM #Temp_Categoryvalue a 



UPDATE #Temp_categoryDetails
SET CategoryName = (SELECT TOP 1 ty.AttributeValues FROM #Temp_Categoryvalue ty 
WHERE ty.PimCategoryHierarchyId =#Temp_categoryDetails.PimCategoryHierarchyId AND ty.LocaleId = #Temp_categoryDetails.LocaleId
AND ty.AttributeCode ='CategoryName')
,CategoryCode = (SELECT TOP 1 ty.AttributeValues FROM #Temp_Categoryvalue ty 
WHERE ty.PimCategoryHierarchyId =#Temp_categoryDetails.PimCategoryHierarchyId AND ty.LocaleId = #Temp_categoryDetails.LocaleId
AND ty.AttributeCode ='CategoryCode')

-- SELECT * FROM #Temp_categoryDetails

UPDATE a
SET a.Name = t.CategoryName
,a.CategoryCode = t.CategoryCode
,a.Attributes = (SELECT   r.AttributeCode, AttributeValues,jk.AttributeName, jk.AttributeTypeName  ,jk.IsUseInSearch,jk.IsHtmlTags,jk.IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId = r.LocaleId AND jk.IsCategory = 1 )
					WHERE r.PimCategoryHierarchyId = t.PimCategoryHierarchyId AND r.LocaleId = t.LocaleId
					FOR JSON PATH ) 

,a.ZnodeParentCategoryIds  = '['+CAST(t.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
,a.ProductIds = '['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId = t.PimCategoryId  )+']' 
,a.DisplayOrder = t.DisplayOrder 
,a.IsActive = t.IsActive, a.ActivationDate = t.ActivationDate, a.ExpirationDate = t.ExpirationDate

FROM ZnodePublishCategoryEntity a with(nolock)
INNER JOIN #Temp_categoryDetails t ON (t.PimCategoryHierarchyId = a.ZnodeCategoryId AND t.VersionId = a.VersionId)

INSERT INTO ZnodePublishCategoryEntity (VersionId,ZnodeCategoryId,Name,CategoryCode,ZnodeCatalogId,CatalogName,ZnodeParentCategoryIds
,ProductIds,LocaleId,IsActive,DisplayOrder,Attributes,ActivationDate,ExpirationDate,CategoryIndex,ElasticSearchEvent)

SELECT a.VersionId, a.PimCategoryHierarchyId, a.CategoryName, a.CategoryCode,@PimCatalogId,CatalogName,'['+CAST(a.ParentPimCategoryHierarchyId AS VARCHAR(580))+']'
	,'['+(SELECT  STRING_AGG(  CONVERT(VARCHAR(MAX),PimProductId) ,',') FROM ZnodePimCategoryProduct ty with(nolock) WHERE ty.PimCategoryId  = a.PimCategoryId  )+']' 
	,a.LocaleId, a.IsActive,a.DisplayOrder,(SELECT  r.AttributeCode , AttributeName, AttributeValues, AttributeTypeName,IsUseInSearch,IsHtmlTags,IsComparable
					FROM #Temp_Categoryvalue r 
					INNER JOIN #temp_attributename jk ON (jk.AttributeCode = r.AttributeCode AND jk.LocaleId= r.LocaleId AND jk.IsCategory =1 )
					WHERE r.PimCategoryHierarchyId = a.PimCategoryHierarchyId AND r.LocaleId = a.LocaleId	FOR JSON PATH ) , a.ActivationDate, a.ExpirationDate,1,1
FROM #Temp_categoryDetails a
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCategoryEntity Tot with(nolock) WHERE tot.VersionId = a.VersionId AND tot.ZnodeCategoryId = a.PimCategoryHierarchyId )

DELETE t FROM ZnodePublishSeoEntity t WHERE EXISTS (SELECT TOP 1 1 FROM #Temp_categoryDetails yu WHERE yu.CategoryCode  = t.SEOCode 
AND t.CMSSEOTypeId = 2 
)

INSERT INTO ZnodePublishSeoEntity(VersionId,PublishStartTime,ItemName,CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,LocaleId,OldSEOURL,CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,ElasticSearchEvent) 

SELECT VersionId,GETDATE(),a.SEOCode,a.CMSSEODetailId,CMSSEODetailLocaleId,CMSSEOTypeId,SEOId,'Category' SEOTypeName,SEOTitle
,SEODescription,SEOKeywords,SEOUrl,IsRedirect,MetaInformation,b.LocaleId,'' OldSEOURL,0 CMSContentPagesId,PortalId,SEOCode,CanonicalURL,RobotTag,1 ElasticSearchEvent
FROM ZnodeCMSSEODetail a 
INNER JOIN ZnodeCMSSEODetailLocale b ON (b.CMSSEODetailId = a.CMSSEODetailId)
INNER JOIN #Temp_categoryDetails c ON (c.CategoryCode = a.SEOCode )
WHERE a.CMSSEOTypeId =2 

     
	SELECT PimCategoryHierarchyId PublishCategoryId ,
			ZnodeCatalogId  PublishCatalogId  ,
           ''   CategoryXml       ,
              LocaleId          ,
			  VersionId		     
    FROM  #Temp_categoryDetails y 

	SELECT PortalId, y.ZnodeCatalogId PublishCatalogId, y.PimCategoryHierarchyId PublishCategoryId, y.CategoryCode, yu.SEOUrl,y. VersionId,y.LocaleId FROM ZnodePublishSeoEntity yu 
	INNER JOIN #Temp_categoryDetails y ON ( y.VersionId = yu.VersionId
	AND y.CategoryCode = yu.SEOCode)  
	
	SELECT 0 AS id,@Status AS Status;   


	UPDATE ZnodePimCategory 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PimCategoryId =@PimCategoryId

END TRY 
BEGIN CATCH 
	SET @Status =0  
	
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	-- Rollback transaction
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleCategoryEntity
		@PimCategoryId = '+CAST(@PimCategoryId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleCategoryErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleCategoryEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleCategoryEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishSingleProductEntity')
	DROP PROC Znode_PublishSingleProductEntity

GO

CREATE PROCEDURE [dbo].[Znode_PublishSingleProductEntity]
(
    @PimProductId TransferId READONLY
   ,@RevisionType   Varchar(30) = ''
   ,@UserId int = 0
   ,@IsAutoPublish bit = 0 
   ,@ImportGUID Varchar(500) = '' 
)
AS
/*
	To publish all catalog product and their details
	Unit Testing : 
	*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Status Bit =0 
	DECLARE @PimProductIdIn INT , @PimCatalogId INT 

	SET @ImportGUID = CASE WHEN @ImportGUID = '' THEN CAST( NEWID() AS VARCHAR(200)) ELSE @ImportGUID END 

	DECLARE @PimCatalogProduct TABLE (PimProductId INT , IsDeleted BIT,  ZnodecatalogId INT  , VersionId INT )

	IF EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	INNER JOIN ZnodePublishCatalogEntity y ON (y.ZnodeCatalogId = b.PimCatalogId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	)
	-- AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodePublishCatalogLog nt WHERE nt.PublishStateId = 6 )
	-- AND NOT EXISTS (SELECT TOP  1 1 FROM ZnodePublishProgressNotifierEntity )
	BEGIN 



	DECLARE Cur_CatalogProduct CURSOR FOR 
	SELECT DISTINCT PimProductId, b.PimCatalogId
	FROM ZnodePimCategoryProduct a 
	INNER JOIN ZnodePimCategoryHierarchy b ON (b.PimCategoryId = a.PimCategoryId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId t WHERE t.Id = a.PimProductId)
	OPEN Cur_CatalogProduct 

	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId

	WHILE @@FETCH_STATUS=0 
	BEGIN 

	

	INSERT INTO @PimCatalogProduct 
	EXEC Znode_PublishCatalogEntity @PimCatalogId= @PimCatalogId
									,@RevisionState =@RevisionType
									,@UserId =@UserId
									,@NewGUID = @ImportGUID
									,@IsDraftProductsOnly = 0 
									,@PimProductId =@PimProductIdIn
									,@PimCategoryHierarchyId = 0 



	FETCH NEXT FROM Cur_CatalogProduct INTO @PimProductIdIn,@PimCatalogId
	END 
	CLOSE Cur_CatalogProduct
	DEALLOCATE Cur_CatalogProduct 

	   	  
	SET @Status =1 

	END 
	ELSE 
	BEGIN 


	SET @Status = 0 
	END 


	SELECT * 
	FROM ZnodePublishProductEntity a with (nolock)
	WHERE EXISTS (SELECT TOP 1 1 FROM @PimCatalogProduct r WHERE r.VersionId = a.VersionId AND r.PimProductId = a.ZnodeProductId AND r.IsDeleted = 0)

	SELECT PimProductId ZnodeProductId , IsDeleted ,  ZnodecatalogId   , VersionId 
	FROM @PimCatalogProduct 
	WHERE IsDeleted =1 

		UPDATE ZnodePimProduct 
	SET PublishStateId =  CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	WHERE PublishStateId IN (1,2)
	AND PimProductId IN ( SELECT PimProductId FROM  @PimCatalogProduct ) 



	UPDATE ZnodePublishCatalogLog 
	SET PublishStateId = CASE WHEN @RevisionType= 'None' OR @RevisionType= 'Production'  THEN 3 ELSE 4 END 
	, IsCatalogPublished = 1 
	WHERE PublishType= 'Product'
	
	UPDATE ZnodePublishProgressNotifierEntity 
	SET IsCompleted = 1 ,ProgressMark = 100 
	WHERE JobId = @ImportGUID

	SELECT 0 AS id,@Status AS Status;   

	DELETE FROM ZnodePublishProgressNotifierEntity  	WHERE JobId = @ImportGUID

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 SELECT ERROR_MESSAGE()
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishSingleProductEntity
		@PimProductIds = '',@UserId='+CAST(@UserId AS VARCHAR(50))+',@RevisionType='+CAST(@RevisionType AS VARCHAR(10))
			
	INSERT INTO ZnodePublishSingleProductErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'PublishSingleProductEntity', '' + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId ,''


	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishSingleProductEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishUpdateProductJson')
	DROP PROC Znode_PublishUpdateProductJson

GO

CREATE PROC [dbo].[Znode_PublishUpdateProductJson]
(
  @PimProductIds transferId readonly 
 , @VersionId varchar(200) = ''
 , @LocaleId INT = 1  
 , @IsSingleProductPublish bit = 0 
 , @NewGUID varchar(600)= ''
 , @CatalogName nvarchar(1000) = ''
 , @messagestring varchar(300) = ''
)

AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 

DECLARE @col VARCHAR(max)= '', @wherecls varchar(2000)=''
--DECLARE #pimProductIds  TABLE (PimProductId INT INDEX IDX_Temptable NONCLUSTERED )
SET @wherecls = CASE WHEN @VersionId = '' THEN '' ELSE ' VersionId IN ('+@VersionId+')' END  
DECLARE @DefaultLocaleId INT = dbo.fn_getDefaultLocaleId()
DECLARE @LocaleIds_distinct TABLE (LocaleId INT, VersionId INT  )


INSERT INTO @LocaleIds_distinct
SELECT DISTINCT LocaleId ,VersionId
FROM ZnodePublishVersionEntity a 
WHERE  EXISTS (SELECT TOP 1 1 FROM string_split(@VersionId , ',') w WHERE w.value = a.VersionId)
--AND LocaleId <> @DefaultLocaleId

SELECT id PimProductId 
INTO #pimProductIds
FROM @PimProductIds

CREATE INDEX IDX_#pimProductIds ON #pimProductIds(PimProductId)

SELECT b.PimAttributeId, b.AttributeCode, c.AttributeName,e.IsUseInSearch ,e.IsHtmlTags 
				,e.IsComparable ,e.IsFacets,b.DisplayOrder
				,d.AttributeTypeName , b.IsPersonalizable
				,IsConfigurable ,CASE WHEN b.IsSwatch = 1 THEN 'true' 
				WHEN b.IsSwatch = 0 THEN 'false' ELSE '' END IsSwatch , c.LocaleId
INTO #Attributes_Dt
FROM ZnodePimAttribute b 
LEFT JOIN ZnodePimAttributeLocale c with(nolock) ON (c.PimAttributeId = b.PimAttributeId AND c.LocaleId =@DefaultLocaleId )
LEFT JOIN ZnodeAttributeType d with(nolock) ON (d.AttributeTypeId = b.AttributeTypeId )
LEFT JOIN ZnodePimFrontendProperties e with(nolock) ON (e.PimAttributeId = b.PimAttributeId)

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-Collecting Attribute Data'
		,ProgressMark = 40
	WHERE Jobid = @NewGUID


DROP TABLE if exists  #tbl_ProductValueid
DROP TABLE if exists  #tbl_AttributeValue
DROP TABLE if exists  #tbl_Productjson
DROP TABLE IF EXISTS  #default_value
DROP TABLE IF EXISTS  #PublishProductEntityId



SELECT PimAttributeValueid , PimProductId ,  a.PimAttributeId
INTO #tbl_ProductValueid
FROM ZnodePimAttributeValue a with(nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM  #pimProductIds  t WHERE t.PimProductId = a.PimProductId)

SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
INTO #tbl_AttributeValue 
FROM ZnodePimAttributeValueLocale a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , a.AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeTextAreaValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeDefaultValue a with(nolock)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, b.PimAttributeId , STRING_AGG( CONVERT(NVARCHAR(MAX),c.Path),',') AttributeValue,'' CustomCode, 0 IsDefaultValue 
			,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimProductAttributeMedia a with(nolock)
INNER JOIN ZnodeMedia c with(nolock) ON (c.MediaId = a.MediaId)
INNER JOIN #tbl_ProductValueid b ON (b.PimAttributeValueId = a.PimAttributeValueId)
WHERE a.LocaleId = @DefaultLocaleId
GROUP BY b.PimProductId, b.PimAttributeId
UNION ALL 
SELECT b.PimProductId, c.PimCustomFieldId , a.CustomKeyValue AttributeValue,c.CustomCode, 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 1 Iscustomfield
FROM ZnodePimCustomFieldLocale a with(nolock)
INNER JOIN ZnodePimCustomField c with(nolock) ON (c.PimCustomFieldId = a.PimCustomFieldId)
INNER JOIN #tbl_ProductValueid b ON (b.PimProductId = C.PimProductId)
WHERE a.LocaleId = @DefaultLocaleId
UNION ALL 
SELECT b.PimProductId, a.PimAttributeId , '' AttributeValue ,'' CustomCode , 1 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimConfigureProductAttribute a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimProductId)
UNION ALL 
SELECT DISTINCT  a.PimParentProductId, a.PimAttributeId , (SELECT STRING_AGG(po.SKU,',') 
			FROM ZnodePimLinkProductDetail aa with(nolock)
			INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = aa.PimProductId)
			WHERE aa.PimParentProductId = a.PimParentProductId and aa.PimAttributeId = a.PimAttributeId 
			) AttributeValue ,'' CustomCode , 0 IsDefaultValue ,@DefaultLocaleId LocaleId, 0 Iscustomfield
FROM ZnodePimLinkProductDetail a with(nolock)
INNER JOIN #pimProductIds  b ON (b.PimProductId = a.PimParentProductId)

-- If want child product configurable attributes 
SELECT ty.PimProductId ,ty.PimAttributeId, ac.AttributeDefaultValueCode Code , bc.LocaleId	, bc.AttributeDefaultValue Value,ac.DisplayOrder,IsEditable,SwatchText,Path,rt.PimAttributeDefaultValueId, CAST('' AS VARCHAr(600)) VariantSKU ,0 VariantDisplayOrder
INTO #default_value
FROM ZnodePimAttributeDefaultValue ac with(nolock)
INNER JOIN ZnodePimProductAttributeDefaultValue rt with(nolock) ON (rt.PimAttributeDefaultValueId = ac.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (ac.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId)
INNER JOIN #tbl_ProductValueid ty ON (ty.PimAttributeValueId = rt.PimAttributeValueId)
LEFT JOIN ZnodeMedia ZM with(nolock) ON (zm.MediaId = ac.MediaId)
WHERE  bc.LocaleId = @DefaultLocaleId AND rt.LocaleId = bc.LocaleId

INSERT INTO #default_value 
SELECT a.PimParentProductId PimProductId ,c.PimAttributeId, b.Code , b.LocaleId	, b.Value,b.DisplayOrder,IsEditable,SwatchText,Path,b.PimAttributeDefaultValueId , po.SKU VariantSKU ,a.DisplayOrder VariantDisplayOrder
FROM ZnodePimProductTypeAssociation a with(nolock)
INNER JOIN ZnodePimConfigureProductAttribute c with(nolock) ON (c.PimProductId = a.PimParentProductId)
INNER JOIN #default_value b ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = c.PimAttributeId )
INNER JOIN #pimProductIds  bb ON (bb.PimProductId = c.PimProductId)
INNER JOIN ZnodePimProduct po with(nolock) ON (po.PimProductId = a.PimProductId)

create nonclustered index IDX_TempTable_AttributeValue on #tbl_AttributeValue (PimProductId) INCLUDE(PimAttributeId)
create nonclustered index IDX_TempTable_defaultValue on #default_value (PimProductId) INCLUDE(PimAttributeId)

SELECT DISTINCT PublishProductEntityId
INTO #PublishProductEntityId
FROM ZnodePublishProductEntity a WITH (nolock)
WHERE EXISTS (SELECT TOP 1 1 FROM #pimProductIds  n WHERE n.PimProductId =  a.ZnodeProductId ) 
AND EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct w WHERE w.VersionId = a.VersionId)

CREATE TABLE #tbl_AttributeValueLocale (PimProductId INT ,   AttributeValue NVARCHAR(max), PimAttributeId INT  , LocaleId INT)
CREATE TABLE #default_valuelocale (PimAttributeDefaultValueId INT , AttributeDefaultValue NVARCHAR(max), LocaleId int  )

IF EXISTS (SELECT TOP 1 1 FROM @LocaleIds_distinct WHERE LocaleId <> @DefaultLocaleId )
BEGIN 

   INSERT INTO #Attributes_Dt 
   SELECT PimAttributeId, AttributeCode, AttributeName,IsUseInSearch ,IsHtmlTags 
				,IsComparable ,IsFacets,DisplayOrder
				,AttributeTypeName , IsPersonalizable
				,IsConfigurable ,IsSwatch , m.LocaleId
   FROM #Attributes_Dt 
   CROSS APPLY @LocaleIds_distinct m
   WHERE m.LocaleId <> @DefaultLocaleId

   UPDATE a 
   SET a.AttributeName = b.AttributeName
   FROM #Attributes_Dt a 
   INNER JOIN ZnodePimAttributeLocale b with(nolock)  ON (a.PimAttributeId = b.PimAttributeId AND a.LocaleId = b.LocaleId)
   WHERE a.LocaleId <> @DefaultLocaleId

    --SELECT * FROM #tbl_AttributeValue

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   LEFT JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId AND a.Iscustomfield = 0 )
   LEFT JOIN  ZnodePimAttributeValueLocale aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId

   INSERT INTO #tbl_AttributeValueLocale
   SELECT b.PimProductId,   aa.AttributeValue , a.PimAttributeId , aa.LocaleId
   FROM #tbl_AttributeValue a 
   INNER JOIN #tbl_ProductValueid b  ON (b.PimProductId = a.PimProductId AND b.PimAttributeId = a.PimAttributeId AND a.Iscustomfield = 0 )
   INNER JOIN  ZnodePimProductAttributeTextAreaValue aa with(nolock) ON (b.PimAttributeValueId = aa.PimAttributeValueId  )
   WHERE aa.LocaleId <> @DefaultLocaleId
 


   INSERT INTO #default_valuelocale
   SELECT  bc.PimAttributeDefaultValueId, bc.AttributeDefaultValue, bc.LocaleId 
   FROM #default_value a 
   INNER JOIN ZnodePimAttributeDefaultValueLocale bc with(nolock) ON (a.PimAttributeDefaultValueId = bc.PimAttributeDefaultValueId AND bc.LocaleId = a.LocaleId)
   WHERE bc.LocaleId <> @DefaultLocaleId
   



END 
--LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId AND ut.LocaleId = m.LocaleId)
   --SELECT * FROM #tbl_AttributeValueLocale

    DROP TABLE IF EXISTS #tbl_ProductValueid

	UPDATE ZnodePublishProgressNotifierEntity
	SET JobName =  @messagestring+'Catalog-'+@CatalogName+'-'+'-Processing Attribute JSON'
		,ProgressMark = 50
	WHERE Jobid = @NewGUID
	
	DECLARE @t transferId 

	WHILE EXISTS (SELECT TOP 1 1 FROM #PublishProductEntityId)
	BEGIN 
	
	INSERT INTO @t
	SELECT TOP 50000 PublishProductEntityId
	FROM #PublishProductEntityId

UPDATE m
SET m.Attributes = (SELECT DISTINCT  IIF(ISNULL(b.AttributeCode,'') = '', a.CustomCode,b.AttributeCode)AttributeCode ,IIF(ISNULL(b.AttributeName,'') = '', f.CustomKey,b.AttributeName)AttributeName
,ISNULL(b.IsUseInSearch,'false')IsUseInSearch ,ISNULL(b.IsHtmlTags,'false') IsHtmlTags
				,ISNULL(b.IsComparable,'false')IsComparable ,ISNULL(b.IsFacets,'false') IsFacets,ISNULL(b.DisplayOrder,0) DisplayOrder 
				,ISNULL(b.AttributeTypeName,'') AttributeTypeName, ISNULL(b.IsPersonalizable,'false')IsPersonalizable 
				,IIF(CustomCode= '','false' , 'true' )IsCustomField,ISNULL(IsConfigurable,'false') IsConfigurable,ISNULL(b.IsSwatch,'false') IsSwatch, ISNULL(IIF(ut.AttributeValue IS NULL , a.AttributeValue,ut.AttributeValue),'') AttributeValues
				,ISNULL((
				   SELECT   Code,m.LocaleId,IIF(AttributeDefaultValue IS NULL ,Value, AttributeDefaultValue) Value,DisplayOrder,ISNULL(IsEditable,'false') IsEditable,ISNULL(SwatchText,'')SwatchText,ISNULL(Path,'')Path,VariantSKU,VariantDisplayOrder
				   FROM #default_value nt 
				   LEFT JOIN #default_valuelocale op ON (op.PimAttributeDefaultValueId = nt.PimAttributeDefaultValueId AND op.LocaleId = m.LocaleId )
				   WHERE nt.PimProductId = m.ZnodeProductId AND nt.PimAttributeId = a.PimAttributeId AND a.IsDefaultValue = 1 
				   AND nt.LocaleId =@DefaultLocaleId
				   FOR JSON PATH 
				),'[]')  SelectValues
FROM #tbl_AttributeValue a 
LEFT JOIN #tbl_AttributeValueLocale ut ON (ut.PimProductId = m.ZnodeProductId AND ut.PimAttributeId = a.PimAttributeId 
										AND ut.LocaleId = m.LocaleId AND a.Iscustomfield = 0)
LEFT JOIN #Attributes_Dt b ON (b.PimAttributeId = a.PimAttributeId AND b.LocaleId = m.LocaleId AND a.Iscustomfield = 0 )
LEFT JOIN ZnodePimCustomFieldLocale f with(nolock) ON (f.PimCustomFieldId = a.PimAttributeId AND f.LocaleId =m.LocaleId AND a.Iscustomfield = 1 )
WHERE a.PimProductId = m.ZnodeProductId AND a.LocaleId = @DefaultLocaleId
--ORDER BY b.DisplayOrder, b.PimAttributeId
FOR JSON PATH 
    )

FROM ZnodePublishProductEntity m
WHERE EXISTS (SELECT TOP 1 1  FROM @t p WHERE p.id = m.PublishProductEntityId)
OPTION (RECOMPILE)

UPDATE  a
SET name  = ty.AttributeValue 
FROM ZnodePublishProductEntity a 
INNER JOIN #tbl_AttributeValueLocale ty ON ( ty.PimProductId = a.ZnodeProductId AND ty.LocaleId = a.LocaleId 
	AND ty.PimAttributeId = (SELECT TOP 1 w.PimAttributeId FROM #Attributes_Dt W WHERE w.AttributeCode = 'ProductName')  )
WHERE PublishProductEntityId  IN (SELECT Id FROM @t)
AND a.LocaleId <> @DefaultLocaleId
	
	DELETE FROM #PublishProductEntityId WHERE EXISTS (SELECT TOP 1 1 FROM @t WHERE id = PublishProductEntityId)
	DELETE FROM @t
	IF IS_SRVROLEMEMBER('sysadmin', SUSER_NAME())=1
	DBCC DROPCLEANBUFFERS
END 

DROP TABLE IF EXISTS #pimProductIds

END TRY 
BEGIN CATCH 
    SELECT ERROR_MESSAGE()
END CATCH 
END
